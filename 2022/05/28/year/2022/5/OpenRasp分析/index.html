<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="OpenRasp分析[TOC] 写在前面​    花了点时间学习了下openrasp的核心代码，这里做下简单的分析 ​    相关项目地址： ​        https:&#x2F;&#x2F;github.com&#x2F;baidu-security&#x2F;openrasp-v8 ​        https:&#x2F;&#x2F;github.com&#x2F;baidu&#x2F;openrasp ​    这里我以目前官网最新版的1.3.7来做下分析，这里为"><meta property="og:type" content="article"><meta property="og:title" content="OpenRasp分析"><meta property="og:url" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/index.html"><meta property="og:site_name" content="Y4tacker:Hacking The World!"><meta property="og:description" content="OpenRasp分析[TOC] 写在前面​    花了点时间学习了下openrasp的核心代码，这里做下简单的分析 ​    相关项目地址： ​        https:&#x2F;&#x2F;github.com&#x2F;baidu-security&#x2F;openrasp-v8 ​        https:&#x2F;&#x2F;github.com&#x2F;baidu&#x2F;openrasp ​    这里我以目前官网最新版的1.3.7来做下分析，这里为"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/1.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/2.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/3.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/1.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/26.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/5.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/6.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/7.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/8.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/9.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/10.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/11.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/12.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/13.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/14.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/15.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/16.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/17.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/18.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/19.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/20.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/27.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/21.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/22.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/23.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/24.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/25.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/28.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/29.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/30.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/31.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/32.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/33.png"><meta property="og:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/34.png"><meta property="article:published_time" content="2022-05-28T13:29:30.000Z"><meta property="article:modified_time" content="2024-08-04T09:01:49.370Z"><meta property="article:author" content="Y4tacker"><meta property="article:tag" content="Java"><meta property="article:tag" content="Rasp"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/1.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>OpenRasp分析</title><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="Y4tacker:Hacking The World!" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" aria-label="Top" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa-solid fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" aria-label="Previous post" href="/2022/06/14/year/2022/6/%E5%AE%9E%E8%AE%AD%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95-%E4%B8%80/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" aria-label="Next post" href="/2022/05/23/year/2022/5/PbootCMS-3-1-2%E5%89%8D%E5%8F%B0%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" aria-label="Back to top" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&text=OpenRasp分析"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&title=OpenRasp分析"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&is_video=false&description=OpenRasp分析"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=OpenRasp分析&body=Check out this article: https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&title=OpenRasp分析"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&title=OpenRasp分析"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&title=OpenRasp分析"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&title=OpenRasp分析"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&name=OpenRasp分析&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&t=OpenRasp分析"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OpenRasp%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">OpenRasp分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%97%A5%E5%BF%97%E8%AF%B4%E6%98%8E"><span class="toc-number">1.2.</span> <span class="toc-text">一些日志说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">1.3.</span> <span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.1.</span> <span class="toc-text">初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%B0%86rasp-jar%E5%8A%A0%E8%BD%BD%E8%87%B3Bootstrap%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">为什么要将rasp.jar加载至Bootstrap类加载器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">配置初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ModuleLoader%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">ModuleLoader类初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8"><span class="toc-number">1.3.2.</span> <span class="toc-text">引擎启动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JS%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">JS初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Checker%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">Checker的初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CustomClassTransformer"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">CustomClassTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hook"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">Hook</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%9E%E7%AD%94%E4%B8%8A%E9%9D%A2%E9%81%97%E7%95%99%E7%9A%84ModuleClassloader%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.2.4.1.</span> <span class="toc-text">回答上面遗留的ModuleClassloader的问题</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%BB%95%E8%BF%87"><span class="toc-number">1.4.</span> <span class="toc-text">如何绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%AD%A3%E5%88%99%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">1.4.1.</span> <span class="toc-text">基于正则的绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9%E6%9F%90%E4%BA%9B%E5%B1%9E%E6%80%A7"><span class="toc-number">1.4.2.</span> <span class="toc-text">通过修改某些属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%86%E7%9B%96%E6%8F%92%E4%BB%B6"><span class="toc-number">1.4.3.</span> <span class="toc-text">覆盖插件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.5.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol></div></span></div><div class="content index py4"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle p-name" itemprop="name headline">OpenRasp分析</h1><div class="meta"><span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-name" itemprop="name">Y4tacker</span></span><div class="postdate"><time datetime="2022-05-28T13:29:30.000Z" class="dt-published" itemprop="datePublished">2022-05-28</time> (Updated: <time datetime="2024-08-04T09:01:49.370Z" class="dt-updated" itemprop="dateModified">2024-08-04</time>)</div><div class="article-category"><i class="fa-solid fa-archive"></i> <a class="category-link" href="/categories/Java/">Java</a></div><div class="article-tag"><i class="fa-solid fa-tag"></i> <a class="p-category" href="/tags/Java/" rel="tag">Java</a>, <a class="p-category" href="/tags/Rasp/" rel="tag">Rasp</a></div></div></header><div class="content e-content" itemprop="articleBody"><h1 id="OpenRasp分析"><a href="#OpenRasp分析" class="headerlink" title="OpenRasp分析"></a>OpenRasp分析</h1><p>[TOC]</p><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>​ 花了点时间学习了下openrasp的核心代码，这里做下简单的分析</p><p>​ 相关项目地址：</p><p>​ <a target="_blank" rel="noopener" href="https://github.com/baidu-security/openrasp-v8">https://github.com/baidu-security/openrasp-v8</a></p><p>​ <a target="_blank" rel="noopener" href="https://github.com/baidu/openrasp">https://github.com/baidu/openrasp</a></p><p>​ 这里我以目前官网最新版的1.3.7来做下分析，这里为了方便简单用springboot写个简单的控制器来进行调试分析即可，当然这里不会去看后端云控部分的代码，笔者只是想理清OpenRasp的逻辑</p><p>​ 另外说点p话，顺便在这个过程当中被迫了解了点c++语法真是太妙了</p><h2 id="一些日志说明"><a href="#一些日志说明" class="headerlink" title="一些日志说明"></a>一些日志说明</h2><p>OpenRasp的日志会通过文件的方式记录在对应文件夹下面，里面日志具体内容就不多解释了点开一眼就看得懂，了解下面几个关于日志目录介绍完全足够了</p><table><thead><tr><th align="left">文件名</th><th align="left">文件内容</th></tr></thead><tbody><tr><td align="left">plugin/plugin-DATE.log</td><td align="left">检测插件的日志，e.g 插件异常、插件调试输出</td></tr><tr><td align="left">rasp/rasp-DATE.log</td><td align="left">rasp agent 调试日志</td></tr><tr><td align="left">alarm/alarm-DATE.log</td><td align="left">攻击报警日志，JSON 格式，一行一个</td></tr><tr><td align="left">policy_alarm/policy_alarm-DATE.log</td><td align="left">安全基线检查报警日志，JSON 格式，一行一个</td></tr></tbody></table><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>首先既然是一个基于maven的项目，很多关键信息都肯定有定义的，类似premain-class以及Agent-class分别是启动时加载和启动后加载rasp，这里我们就以premain为例子，另一个差不多类似</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/1.png"></p><p>首先是执行<code>init</code>初始化</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/2.png"></p><p>初始化第一步<code>JarFileHelper.addJarToBootstrap(inst);</code>，可以看到这里其实就是把当前jar包也就是<code>rasp.jar</code>加载至Bootstrap类加载器，这里你可能想问为什么是最顶层的这个</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/3.png"></p><h4 id="为什么要将rasp-jar加载至Bootstrap类加载器"><a href="#为什么要将rasp-jar加载至Bootstrap类加载器" class="headerlink" title="为什么要将rasp.jar加载至Bootstrap类加载器"></a>为什么要将rasp.jar加载至Bootstrap类加载器</h4><p>通过JVM的api，把其路径追加到了启动类加载器的classpath中，这样，启动类加载器，收到类加载委派任务时，就能通过该classpath加载到rasp.jar的所有类了，根据双亲委派，意味着任何一个类加载器中的任何一个类，都能通过显式或者隐式加载，加载到rasp.jar中的类，反而网上说的啥无法hook到通过启动类加载器加载的类纯纯扯淡</p><h4 id="配置初始化"><a href="#配置初始化" class="headerlink" title="配置初始化"></a>配置初始化</h4><p>接下来的<code>readVersion()</code>方法，其实就是读取一些rasp自身的配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">readVersion</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Class clazz = Agent.class;</span><br><span class="line">    String className = clazz.getSimpleName() + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line">    String classPath = clazz.getResource(className).toString();</span><br><span class="line">    String manifestPath = classPath.substring(<span class="number">0</span>, classPath.lastIndexOf(<span class="string">&quot;!&quot;</span>) + <span class="number">1</span>) + <span class="string">&quot;/META-INF/MANIFEST.MF&quot;</span>;</span><br><span class="line">    Manifest manifest = <span class="keyword">new</span> Manifest((<span class="keyword">new</span> URL(manifestPath)).openStream());</span><br><span class="line">    Attributes attr = manifest.getMainAttributes();</span><br><span class="line">    projectVersion = attr.getValue(<span class="string">&quot;Project-Version&quot;</span>);</span><br><span class="line">    buildTime = attr.getValue(<span class="string">&quot;Build-Time&quot;</span>);</span><br><span class="line">    gitCommit = attr.getValue(<span class="string">&quot;Git-Commit&quot;</span>);</span><br><span class="line">    projectVersion = projectVersion == <span class="keyword">null</span> ? <span class="string">&quot;UNKNOWN&quot;</span> : projectVersion;</span><br><span class="line">    buildTime = buildTime == <span class="keyword">null</span> ? <span class="string">&quot;UNKNOWN&quot;</span> : buildTime;</span><br><span class="line">    gitCommit = gitCommit == <span class="keyword">null</span> ? <span class="string">&quot;UNKNOWN&quot;</span> : gitCommit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>没啥好看的，看看<code>MANIFEST.MF</code>就好</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/1.png"></p><p>接下来执行<code>ModuleLoader.load(mode, action, inst);</code>来</p><h4 id="ModuleLoader类初始化"><a href="#ModuleLoader类初始化" class="headerlink" title="ModuleLoader类初始化"></a>ModuleLoader类初始化</h4><p>首先<code>ModueLoader</code>有个静态块，来看看代码做了两件事，一个是获取rasp.jar的绝对路径，另一个是获取拓展类加载器赋值给moduleClassLoader，至于为什么需要获取拓展类加载器，这里引入三梦师傅的话，很好理解没啥难度</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">其实，很多时候，比如tomcat，它在运行中，大部分类都是由实现的应用类加载器进行加载的，那么，假如Engine是通过某个应用类加载器进行加载的，而我们的hook代码，在tomcat中应用类加载器加载的某个类，插入了某段代码，这段代码直接（com.xxx.A.a();）调用了Engine的某个类的方法，那么，按照双亲委派机制，以及隐式加载的规范，将会抛出ClassNoFoundError的错误</span><br></pre></td></tr></table></figure><p>再简单看看代码，待会儿说说这个moduleClassLoader的作用，在很后面这里先了解了解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">        Class clazz;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clazz = Class.forName(<span class="string">&quot;java.nio.file.FileSystems&quot;</span>);</span><br><span class="line">            clazz.getMethod(<span class="string">&quot;getDefault&quot;</span>).invoke((Object)<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        clazz = ModuleLoader.class;</span><br><span class="line">        String path = clazz.getResource(<span class="string">&quot;/&quot;</span> + clazz.getName().replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>) + <span class="string">&quot;.class&quot;</span>).getPath();</span><br><span class="line">        <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;file:&quot;</span>)) &#123;</span><br><span class="line">            path = path.substring(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (path.contains(<span class="string">&quot;!&quot;</span>)) &#123;</span><br><span class="line">            path = path.substring(<span class="number">0</span>, path.indexOf(<span class="string">&quot;!&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            baseDirectory = URLDecoder.decode((<span class="keyword">new</span> File(path)).getParent(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var3) &#123;</span><br><span class="line">            baseDirectory = (<span class="keyword">new</span> File(path)).getParent();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ClassLoader systemClassLoader;</span><br><span class="line">        <span class="keyword">for</span>(systemClassLoader = ClassLoader.getSystemClassLoader(); systemClassLoader.getParent() != <span class="keyword">null</span> &amp;&amp; !systemClassLoader.getClass().getName().equals(<span class="string">&quot;sun.misc.Launcher$ExtClassLoader&quot;</span>); systemClassLoader = systemClassLoader.getParent()) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        moduleClassLoader = systemClassLoader;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>接下来进入构造函数，首先实例化赋值<code>engineContainer = new ModuleContainer(&quot;rasp-engine.jar&quot;);</code></p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/26.png"></p><h3 id="引擎启动"><a href="#引擎启动" class="headerlink" title="引擎启动"></a>引擎启动</h3><h4 id="JS初始化"><a href="#JS初始化" class="headerlink" title="JS初始化"></a>JS初始化</h4><p>在<code>com.baidu.openrasp.EngineBoot#start</code>中首先通过<code>Loader.load();</code>引入动态链接库，具体引入的是干嘛的之后就知道了，之后我们暂时先忽略配置相关的东西进入主要的</p><p>首先是JS的初始化</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/5.png"></p><p>在这个过程，首先是设置日志输出相关</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/6.png"></p><p>紧接着是设置StackGetter，这其实是一个回掉函数的触发</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/7.png"></p><p>这一点可以从v8的文档得以验证，后面还会提到这里只是简单提提</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/8.png"></p><p>紧接着是下面两行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UpdatePlugin();</span><br><span class="line">InitFileWatcher();</span><br></pre></td></tr></table></figure><p>一个<code>UpdatePlugin();</code>，首先遍历plugins目录下的js文件，并添加到<code>scripts</code>变量当中</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/9.png"></p><p>紧接着执行<code>UpdatePlugin(List&lt;String[]&gt; scripts)</code>，首先是<code>CreateSnapshot</code>从名字可以看出是创建快照，我们还是来具体看看干了些啥</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/10.png"></p><p>简单对文件做了注释，因为流程确实没啥好说的</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_baidu_openrasp_v8_V8</span></span><br><span class="line"><span class="comment"> * Method:    CreateSnapshot</span></span><br><span class="line"><span class="comment"> * Signature: (Ljava/lang/String;[Ljava/lang/Object;Ljava/lang/String;)Z</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">ALIGN_FUNCTION JNIEXPORT jboolean JNICALL <span class="title">Java_com_baidu_openrasp_v8_V8_CreateSnapshot</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                                                       jclass cls,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                                                       jstring jconfig,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                                                       jobjectArray jplugins,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                                                       jstring jversion)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//global.checkPoints</span></span><br><span class="line">  <span class="keyword">auto</span> config = <span class="built_in">Jstring2String</span>(env, jconfig);</span><br><span class="line">  <span class="comment">//RASP版本信息</span></span><br><span class="line">  <span class="keyword">auto</span> version = <span class="built_in">Jstring2String</span>(env, jversion);</span><br><span class="line">  std::vector&lt;PluginFile&gt; plugin_list;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">size_t</span> plugin_len = env-&gt;<span class="built_in">GetArrayLength</span>(jplugins);</span><br><span class="line">  <span class="comment">//遍历plugin，并将插件文件名与插件内容保存到plugin_list里面</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; plugin_len; i++) &#123;</span><br><span class="line">    jobjectArray plugin = (jobjectArray)env-&gt;<span class="built_in">GetObjectArrayElement</span>(jplugins, i);</span><br><span class="line">    <span class="keyword">if</span> (plugin == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    jstring jname = (jstring)env-&gt;<span class="built_in">GetObjectArrayElement</span>(plugin, <span class="number">0</span>);</span><br><span class="line">    jstring jsource = (jstring)env-&gt;<span class="built_in">GetObjectArrayElement</span>(plugin, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (jname == <span class="literal">nullptr</span> || jsource == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> name = <span class="built_in">Jstring2String</span>(env, jname);</span><br><span class="line">    <span class="keyword">auto</span> source = <span class="built_in">Jstring2String</span>(env, jsource);</span><br><span class="line">    plugin_list.<span class="built_in">emplace_back</span>(name, source);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> duration = std::chrono::system_clock::<span class="built_in">now</span>().<span class="built_in">time_since_epoch</span>();</span><br><span class="line">  <span class="keyword">auto</span> millis = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(duration).<span class="built_in">count</span>();</span><br><span class="line">  <span class="comment">//好了注释到上面这一坨就结束了</span></span><br><span class="line">  Snapshot* blob = <span class="keyword">new</span> <span class="built_in">Snapshot</span>(config, plugin_list, version, millis, env);</span><br><span class="line">  <span class="keyword">if</span> (!blob-&gt;<span class="built_in">IsOk</span>()) &#123;</span><br><span class="line">    <span class="keyword">delete</span> blob;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(snapshot_mtx)</span></span>;</span><br><span class="line">  <span class="keyword">delete</span> snapshot;</span><br><span class="line">  snapshot = blob;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来是一个非常有意思的函数Snapshot，它的作用是创建一个构造好的js运行环境的快照，它继承了StartupData类，下面是我简单做的一些笔记</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">Snapshot::Snapshot(<span class="keyword">const</span> std::string&amp; config,</span><br><span class="line">                   <span class="keyword">const</span> std::vector&lt;PluginFile&gt;&amp; plugin_list,</span><br><span class="line">                   <span class="keyword">const</span> std::string&amp; version,</span><br><span class="line">                   uint64_t timestamp,</span><br><span class="line">                   <span class="keyword">void</span>* custom_data)</span><br><span class="line">    : v8::StartupData(&#123;nullptr, <span class="number">0</span>&#125;), timestamp(timestamp) &#123;</span><br><span class="line">  IsolateData data;</span><br><span class="line">  data.custom_data = custom_data;</span><br><span class="line">  v8::<span class="function">SnapshotCreator <span class="title">creator</span><span class="params">(external_references)</span></span>;</span><br><span class="line">  <span class="comment">//获取一个隔离的环境</span></span><br><span class="line">  Isolate* isolate = reinterpret_cast&lt;Isolate*&gt;(creator.GetIsolate());</span><br><span class="line">  <span class="comment">//void * 则不同，任何类型的指针都可以直接赋值给它，无需进行强制类型转换</span></span><br><span class="line">  <span class="comment">//上面这个custom_data从传递来看，传递过来的其实是JNIENV的指向</span></span><br><span class="line">  isolate-&gt;SetData(&amp;data);</span><br><span class="line">  &#123;</span><br><span class="line">    v8::Isolate::<span class="function">Scope <span class="title">isolate_scope</span><span class="params">(isolate)</span></span>;</span><br><span class="line">    v8::<span class="function">HandleScope <span class="title">handle_scope</span><span class="params">(isolate)</span></span>;</span><br><span class="line">    v8::Local&lt;v8::Context&gt; context = v8::Context::New(isolate);</span><br><span class="line">    v8::Context::<span class="function">Scope <span class="title">context_scope</span><span class="params">(context)</span></span>;</span><br><span class="line">    v8::<span class="function">TryCatch <span class="title">try_catch</span><span class="params">(isolate)</span></span>;</span><br><span class="line">    v8::Local&lt;v8::Object&gt; global = context-&gt;Global();</span><br><span class="line">    <span class="comment">//上下文当中设置version/global/window等信息</span></span><br><span class="line">    global-&gt;Set(context, NewV8Key(isolate, <span class="string">&quot;version&quot;</span>), NewV8String(isolate, version)).IsJust();</span><br><span class="line">    global-&gt;Set(context, NewV8Key(isolate, <span class="string">&quot;global&quot;</span>), global).IsJust();</span><br><span class="line">    global-&gt;Set(context, NewV8Key(isolate, <span class="string">&quot;window&quot;</span>), global).IsJust();</span><br><span class="line">    v8::Local&lt;v8::Object&gt; v8_stdout = v8::Object::New(isolate);</span><br><span class="line">    <span class="comment">//下面都是绑定函数，比如将write绑定到函数external_references[0]的指向(这变量是啥后面会说到)，其他类似，另外还有绑定标准输出与标准错误</span></span><br><span class="line">    v8_stdout</span><br><span class="line">        -&gt;Set(</span><br><span class="line">            context, NewV8Key(isolate, <span class="string">&quot;write&quot;</span>),</span><br><span class="line">            v8::Function::New(context, reinterpret_cast&lt;v8::FunctionCallback&gt;(external_references[<span class="number">0</span>])).ToLocalChecked())</span><br><span class="line">        .IsJust();</span><br><span class="line">    global-&gt;Set(context, NewV8Key(isolate, <span class="string">&quot;stdout&quot;</span>), v8_stdout).IsJust();</span><br><span class="line">    global-&gt;Set(context, NewV8Key(isolate, <span class="string">&quot;stderr&quot;</span>), v8_stdout).IsJust();</span><br><span class="line">    global</span><br><span class="line">        -&gt;Set(</span><br><span class="line">            context, NewV8Key(isolate, <span class="string">&quot;flex_tokenize&quot;</span>),</span><br><span class="line">            v8::Function::New(context, reinterpret_cast&lt;v8::FunctionCallback&gt;(external_references[<span class="number">1</span>])).ToLocalChecked())</span><br><span class="line">        .IsJust();</span><br><span class="line">    global</span><br><span class="line">        -&gt;Set(</span><br><span class="line">            context, NewV8Key(isolate, <span class="string">&quot;request&quot;</span>),</span><br><span class="line">            v8::Function::New(context, reinterpret_cast&lt;v8::FunctionCallback&gt;(external_references[<span class="number">2</span>])).ToLocalChecked())</span><br><span class="line">        .IsJust();</span><br><span class="line">    global</span><br><span class="line">        -&gt;Set(</span><br><span class="line">            context, NewV8Key(isolate, <span class="string">&quot;request_async&quot;</span>),</span><br><span class="line">            v8::Function::New(context, reinterpret_cast&lt;v8::FunctionCallback&gt;(external_references[<span class="number">3</span>])).ToLocalChecked())</span><br><span class="line">        .IsJust();</span><br><span class="line">    <span class="comment">//暂时不知道干嘛的，也没有这个js文件</span></span><br><span class="line">    <span class="keyword">if</span> (isolate-&gt;ExecScript(&#123;reinterpret_cast&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt;(gen_builtins), gen_builtins_len&#125;, <span class="string">&quot;builtins.js&quot;</span>).IsEmpty()) &#123;</span><br><span class="line">      <span class="function">Exception <span class="title">e</span><span class="params">(isolate, try_catch)</span></span>;</span><br><span class="line">      Platform::logger(e);</span><br><span class="line">      <span class="comment">// no need to continue</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化配置</span></span><br><span class="line">    <span class="keyword">if</span> (isolate-&gt;ExecScript(config, <span class="string">&quot;config.js&quot;</span>).IsEmpty()) &#123;</span><br><span class="line">      <span class="function">Exception <span class="title">e</span><span class="params">(isolate, try_catch)</span></span>;</span><br><span class="line">      Platform::logger(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//执行我们的插件js脚本做参数初始化以及各种检测函数的注册</span></span><br><span class="line">    <span class="keyword">for</span> (auto&amp; plugin_src : plugin_list) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isolate-&gt;ExecScript(<span class="string">&quot;(function()&#123;\n&quot;</span> + plugin_src.source + <span class="string">&quot;\n&#125;)()&quot;</span>, plugin_src.filename, -<span class="number">1</span>).IsEmpty()) &#123;</span><br><span class="line">        <span class="function">Exception <span class="title">e</span><span class="params">(isolate, try_catch)</span></span>;</span><br><span class="line">        Platform::logger(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    creator.SetDefaultContext(context);</span><br><span class="line">  &#125;</span><br><span class="line">  v8::StartupData snapshot = creator.CreateBlob(v8::SnapshotCreator::FunctionCodeHandling::kClear);</span><br><span class="line">  <span class="keyword">this</span>-&gt;data = snapshot.data;</span><br><span class="line">  <span class="keyword">this</span>-&gt;raw_size = snapshot.raw_size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外上面提到的<code>external_references</code>里面的回掉函数在native-function.cc当中有定义，这里直接放过来很好理解就不做解释了，稍微占点篇幅了</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;bundle.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;flex/flex.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;request.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> openrasp_v8 &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">log_callback</span><span class="params">(<span class="keyword">const</span> v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info)</span> </span>&#123;</span><br><span class="line">  Isolate* isolate = <span class="keyword">reinterpret_cast</span>&lt;Isolate*&gt;(info.<span class="built_in">GetIsolate</span>());</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; info.<span class="built_in">Length</span>(); i++) &#123;</span><br><span class="line">    v8::<span class="function">String::Utf8Value <span class="title">message</span><span class="params">(isolate, info[i])</span></span>;</span><br><span class="line">    Platform::<span class="built_in">logger</span>(&#123;*message, <span class="keyword">static_cast</span>&lt;<span class="keyword">size_t</span>&gt;(message.<span class="built_in">length</span>())&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">flex_callback</span><span class="params">(<span class="keyword">const</span> v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info)</span> </span>&#123;</span><br><span class="line">  Isolate* isolate = <span class="keyword">reinterpret_cast</span>&lt;Isolate*&gt;(info.<span class="built_in">GetIsolate</span>());</span><br><span class="line">  <span class="keyword">auto</span> context = isolate-&gt;<span class="built_in">GetCurrentContext</span>();</span><br><span class="line">  <span class="keyword">if</span> (info.<span class="built_in">Length</span>() &lt; <span class="number">2</span> || !info[<span class="number">0</span>]-&gt;<span class="built_in">IsString</span>() || !info[<span class="number">1</span>]-&gt;<span class="built_in">IsString</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v8::<span class="function">String::Utf8Value <span class="title">str</span><span class="params">(isolate, info[<span class="number">0</span>])</span></span>;</span><br><span class="line">  v8::<span class="function">String::Utf8Value <span class="title">lexer_mode</span><span class="params">(isolate, info[<span class="number">1</span>])</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span>* input = *str;</span><br><span class="line">  <span class="keyword">int</span> input_len = str.<span class="built_in">length</span>();</span><br><span class="line"></span><br><span class="line">  flex_token_result token_result = <span class="built_in">flex_lexing</span>(input, input_len, *lexer_mode);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> len = std::<span class="built_in">min</span>(<span class="built_in">uint32_t</span>(input_len), token_result.result_len);</span><br><span class="line">  <span class="keyword">auto</span> arr = v8::Array::<span class="built_in">New</span>(isolate, len);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    arr-&gt;<span class="built_in">Set</span>(context, i, v8::Integer::<span class="built_in">New</span>(isolate, token_result.result[i])).<span class="built_in">IsJust</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(token_result.result);</span><br><span class="line">  info.<span class="built_in">GetReturnValue</span>().<span class="built_in">Set</span>(arr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">request_callback</span><span class="params">(<span class="keyword">const</span> v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> isolate = info.<span class="built_in">GetIsolate</span>();</span><br><span class="line">  <span class="function">v8::TryCatch <span class="title">try_catch</span><span class="params">(isolate)</span></span>;</span><br><span class="line">  <span class="keyword">auto</span> context = isolate-&gt;<span class="built_in">GetCurrentContext</span>();</span><br><span class="line">  v8::Local&lt;v8::Promise::Resolver&gt; resolver;</span><br><span class="line">  <span class="keyword">if</span> (!v8::Promise::Resolver::<span class="built_in">New</span>(context).<span class="built_in">ToLocal</span>(&amp;resolver)) &#123;</span><br><span class="line">    try_catch.<span class="built_in">ReThrow</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  info.<span class="built_in">GetReturnValue</span>().<span class="built_in">Set</span>(resolver-&gt;<span class="built_in">GetPromise</span>());</span><br><span class="line">  <span class="function">HTTPRequest <span class="title">req</span><span class="params">(isolate, info[<span class="number">0</span>])</span></span>;</span><br><span class="line">  HTTPResponse res = req.<span class="built_in">GetResponse</span>();</span><br><span class="line">  <span class="keyword">auto</span> object = res.<span class="built_in">ToObject</span>(isolate);</span><br><span class="line">  <span class="keyword">if</span> (res.error) &#123;</span><br><span class="line">    resolver-&gt;<span class="built_in">Reject</span>(context, object).<span class="built_in">IsJust</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    resolver-&gt;<span class="built_in">Resolve</span>(context, object).<span class="built_in">IsJust</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">request_async_callback</span><span class="params">(<span class="keyword">const</span> v8::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> isolate = info.<span class="built_in">GetIsolate</span>();</span><br><span class="line">  AsyncRequest::<span class="built_in">GetInstance</span>().<span class="built_in">Submit</span>(std::make_shared&lt;HTTPRequest&gt;(isolate, info[<span class="number">0</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">intptr_t</span>* Snapshot::external_references = <span class="keyword">new</span> <span class="keyword">intptr_t</span>[<span class="number">5</span>]&#123;</span><br><span class="line">    <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">intptr_t</span>&gt;(log_callback),</span><br><span class="line">    <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">intptr_t</span>&gt;(flex_callback),</span><br><span class="line">    <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">intptr_t</span>&gt;(request_callback),</span><br><span class="line">    <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">intptr_t</span>&gt;(request_async_callback),</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br><span class="line">&#125;  <span class="comment">// namespace openrasp_v8</span></span><br></pre></td></tr></table></figure><p>理解了这一段以后接下来再次回到Java端</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/11.png"></p><p>这里获得<code>RASP.algorithmConfig</code>并保存到<code>ConfigItem.ALGORITHM_CONFIG</code></p><p>到这里插件更新部分就结束了</p><p>之后调用了<code>InitFileWatcher</code>,它的作用是创建以目录为单位的文件监听，如果文件进行增删改，就执行插件更新</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/12.png"></p><h4 id="Checker的初始化"><a href="#Checker的初始化" class="headerlink" title="Checker的初始化"></a>Checker的初始化</h4><p>接下来就是Checker的初始化</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/13.png"></p><p>这里会遍历</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/14.png"></p><p>遍历Type这个枚举类型将检测类型以及对应的检测函数添加到<code>checkers</code>这个<code>EnumMap</code>当中</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/15.png"></p><h4 id="CustomClassTransformer"><a href="#CustomClassTransformer" class="headerlink" title="CustomClassTransformer"></a>CustomClassTransformer</h4><p>继续回来接下来调用<code>this.initTransformer(inst);</code>，这里实例化<code>CustomClassTransformer</code>这个 Class 文件的转换器，<img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/16.png"></p><p>可以看到将自身作为类转换器进行添加</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CustomClassTransformer</span><span class="params">(Instrumentation inst)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.inst = inst;</span><br><span class="line">  inst.addTransformer(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">  <span class="keyword">this</span>.addAnnotationHook();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并调用<code>retransform</code>，这里逻辑很简单就不多说，看不懂的可以自行学习<code>JavaAgent</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retransform</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> LinkedList();</span><br><span class="line">        Class[] loadedClasses = <span class="keyword">this</span>.inst.getAllLoadedClasses();</span><br><span class="line">        Class[] arr$ = loadedClasses;</span><br><span class="line">        <span class="keyword">int</span> len$ = loadedClasses.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i$ = <span class="number">0</span>; i$ &lt; len$; ++i$) &#123;</span><br><span class="line">            Class clazz = arr$[i$];</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.isClassMatched(clazz.getName().replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>)) &amp;&amp; <span class="keyword">this</span>.inst.isModifiableClass(clazz) &amp;&amp; !clazz.getName().startsWith(<span class="string">&quot;java.lang.invoke.LambdaForm&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.inst.retransformClasses(<span class="keyword">new</span> Class[]&#123;clazz&#125;);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var8) &#123;</span><br><span class="line">                    LogTool.error(ErrorType.HOOK_ERROR, <span class="string">&quot;failed to retransform class &quot;</span> + clazz.getName() + <span class="string">&quot;: &quot;</span> + var8.getMessage(), var8);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>因此之后当类加载的时候，会进入我们自己的 <code>Transformer</code> 中，执行 <code>transform</code>函数进行拦截</p><h4 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h4><p>因此接下来我们着重看<code>com.baidu.openrasp.transformer.CustomClassTransformer#transform</code>方法，它会遍历<code>hooks</code>，如果条件符合(isClassMatched返回true)则会在制定的类方法当中进行hook</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/17.png"></p><p>而这些类来源于哪里呢？就是<code>open.baidu.openrasp.hook</code>文件夹下的类</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/18.png"></p><p>这里呢我们就随便挑一个来进行解读，那就来一个<code>com.baidu.openrasp.hook.system.ProcessBuilderHook</code>命令执行的类的吧，可以看到isClassMatched的规则</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isClassMatched</span><span class="params">(String className)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ModuleLoader.isModularityJdk()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;java/lang/ProcessImpl&quot;</span>.equals(className);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!OSUtil.isLinux() &amp;&amp; !OSUtil.isMacOS()) &#123;</span><br><span class="line">        <span class="keyword">return</span> OSUtil.isWindows() ? <span class="string">&quot;java/lang/ProcessImpl&quot;</span>.equals(className) : <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;java/lang/UNIXProcess&quot;</span>.equals(className);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看看调用到底是如何调用的，我们回到<code>com.baidu.openrasp.transformer.CustomClassTransformer#transform</code>，可以看到最终返回的字节码是受<code>hook.transformClass</code>处理的，在这里还有个小细节是如果<code>loader</code>为<code>null</code>，则会调用<code>setLoadedByBootstrapLoader</code>设置其中属性为<code>true</code>，我们也知道什么情况下获取不到类加载器也就是由BootStrap启动器类加载器加载的一些类如<code>File</code>、<code>Runtime</code>等等，在设置为<code>true</code>以后在后面hook的时候生成代码有部分区别，之后会提到</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/19.png"></p><p>我们可以看到<code>com.baidu.openrasp.hook.AbstractClassHook#transformClass</code>，它会调用具体实现类的<code>hookMethod</code>方法</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/20.png"></p><p>这里也就是对应<code>com.baidu.openrasp.hook.system.ProcessBuilderHook#hookMethod</code>，可以看到这里的处理也是很全面的挺好</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookMethod</span><span class="params">(CtClass ctClass)</span> <span class="keyword">throws</span> IOException, CannotCompileException, NotFoundException </span>&#123;</span><br><span class="line">    String src;</span><br><span class="line">    <span class="keyword">if</span> (ctClass.getName().contains(<span class="string">&quot;ProcessImpl&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (OSUtil.isWindows()) &#123;</span><br><span class="line">            src = <span class="keyword">this</span>.getInvokeStaticSrc(ProcessBuilderHook.class, <span class="string">&quot;checkCommand&quot;</span>, <span class="string">&quot;$1,$2&quot;</span>, <span class="keyword">new</span> Class[]&#123;String[].class, String.class&#125;);</span><br><span class="line">            <span class="keyword">this</span>.insertBefore(ctClass, <span class="string">&quot;&lt;init&gt;&quot;</span>, (String)<span class="keyword">null</span>, src);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ModuleLoader.isModularityJdk()) &#123;</span><br><span class="line">            src = <span class="keyword">this</span>.getInvokeStaticSrc(ProcessBuilderHook.class, <span class="string">&quot;checkCommand&quot;</span>, <span class="string">&quot;$1,$2,$4&quot;</span>, <span class="keyword">new</span> Class[]&#123;<span class="keyword">byte</span>[].class, <span class="keyword">byte</span>[].class, <span class="keyword">byte</span>[].class&#125;);</span><br><span class="line">            <span class="keyword">this</span>.insertBefore(ctClass, <span class="string">&quot;&lt;init&gt;&quot;</span>, (String)<span class="keyword">null</span>, src);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctClass.getName().contains(<span class="string">&quot;UNIXProcess&quot;</span>)) &#123;</span><br><span class="line">        src = <span class="keyword">this</span>.getInvokeStaticSrc(ProcessBuilderHook.class, <span class="string">&quot;checkCommand&quot;</span>, <span class="string">&quot;$1,$2,$4&quot;</span>, <span class="keyword">new</span> Class[]&#123;<span class="keyword">byte</span>[].class, <span class="keyword">byte</span>[].class, <span class="keyword">byte</span>[].class&#125;);</span><br><span class="line">        <span class="keyword">this</span>.insertBefore(ctClass, <span class="string">&quot;&lt;init&gt;&quot;</span>, (String)<span class="keyword">null</span>, src);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在具体要hook的类方法前面加上<code>checkCommand</code>这个函数</p><h5 id="回答上面遗留的ModuleClassloader的问题"><a href="#回答上面遗留的ModuleClassloader的问题" class="headerlink" title="回答上面遗留的ModuleClassloader的问题"></a>回答上面遗留的ModuleClassloader的问题</h5><p>在这里通过<code>getInvokeStaticSrc</code>这个方法生成具体插入的类，在这个方法当中可以看到，对于被BootStrap加载的类，它会通过<code>com.baidu.openrasp.ModuleLoader.moduleClassLoader</code>.<code>loadClass</code>去调用检查命令的<code>checkCommand</code>函数，这样就避免了由于双亲委派机制导致的<code>ClassNotFoundException</code></p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/27.png"></p><p>由于重载思想差不多就随便挑一个看看</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkCommand</span><span class="params">(<span class="keyword">byte</span>[] command, <span class="keyword">byte</span>[] args, <span class="keyword">byte</span>[] envBlock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((Boolean)HookHandler.enableCmdHook.get()) &#123;</span><br><span class="line">            LinkedList&lt;String&gt; commands = <span class="keyword">new</span> LinkedList();</span><br><span class="line">          	<span class="comment">//执行的命令</span></span><br><span class="line">            <span class="keyword">if</span> (command != <span class="keyword">null</span> &amp;&amp; command.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                commands.add(<span class="keyword">new</span> String(command, <span class="number">0</span>, command.length - <span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">						</span><br><span class="line">          	<span class="comment">//执行的命令的参数</span></span><br><span class="line">            <span class="keyword">int</span> index;</span><br><span class="line">            <span class="keyword">if</span> (args != <span class="keyword">null</span> &amp;&amp; args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(index = <span class="number">0</span>; index &lt; args.length; ++index) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (args[index] == <span class="number">0</span>) &#123;</span><br><span class="line">                        commands.add(<span class="keyword">new</span> String(Arrays.copyOfRange(args, position, index)));</span><br><span class="line">                        position = index + <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">						<span class="comment">//来自envp参数，通常为空，通常是自己设置的环境变量</span></span><br><span class="line">            LinkedList&lt;String&gt; envList = <span class="keyword">new</span> LinkedList();</span><br><span class="line">            <span class="keyword">if</span> (envBlock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                index = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; envBlock.length; ++i) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (envBlock[i] == <span class="number">0</span>) &#123;</span><br><span class="line">                        String envItem = <span class="keyword">new</span> String(envBlock, index + <span class="number">1</span>, i - index - <span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">if</span> (envItem.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            envList.add(envItem);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        index = i;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            checkCommand((List)commands, (List)envList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>之后在讲命令和环境变量放到<code>commands</code>与<code>envList</code>当中并执行<code>checkCommand((List)commands, (List)envList);</code>，这里会把执行的命令、环境变量、以及当前调用栈存放到params这个变量当中</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/21.png"></p><p>之后带着这些参数执行<code>HookHandler.doCheckWithoutRequest</code>,这里省略一些废话</p><p>之后在<code>com.baidu.openrasp.HookHandler#doRealCheckWithoutRequest</code></p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/22.png"></p><p>会选择合适的checker去检查我们执行的东西</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">check</span><span class="params">(Type type, CheckParameter parameter)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ((Checker)checkers.get(type)).check(parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续省略一堆废话，最终会调用到<code>V8.check</code></p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/23.png"></p><p>我们来看看对应的c源码，这里忽略前面部分，后面这里有个比较骚的v8的函数<code>SetLazyDataProperty</code></p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/24.png"></p><p>函数对应的Getter是GetStack，可以看到这个函数里面比较核心的操作就是通过JNIENV去调用Java的<code>com.baidu.openrasp.v8.V8#GetStack</code>函数很骚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetStack</span><span class="params">(v8::Local&lt;v8::Name&gt; name, <span class="keyword">const</span> v8::PropertyCallbackInfo&lt;v8::Value&gt;&amp; info)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> isolate = <span class="keyword">reinterpret_cast</span>&lt;openrasp_v8::Isolate*&gt;(info.<span class="built_in">GetIsolate</span>());</span><br><span class="line">  <span class="keyword">auto</span> env = <span class="built_in">GetJNIEnv</span>(isolate);</span><br><span class="line">  jbyteArray jbuf = <span class="keyword">reinterpret_cast</span>&lt;jbyteArray&gt;(env-&gt;<span class="built_in">CallStaticObjectMethod</span>(v8_class.cls, v8_class.GetStack));</span><br><span class="line">  <span class="keyword">if</span> (jbuf == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> info.<span class="built_in">GetReturnValue</span>().<span class="built_in">Set</span>(v8::Array::<span class="built_in">New</span>(isolate));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> maybe_string = v8::String::<span class="built_in">NewExternalOneByte</span>(isolate, <span class="keyword">new</span> <span class="built_in">ExternalOneByteStringResource</span>(env, jbuf));</span><br><span class="line">  <span class="keyword">if</span> (maybe_string.<span class="built_in">IsEmpty</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> info.<span class="built_in">GetReturnValue</span>().<span class="built_in">Set</span>(v8::Array::<span class="built_in">New</span>(isolate));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> maybe_value = v8::JSON::<span class="built_in">Parse</span>(isolate-&gt;<span class="built_in">GetCurrentContext</span>(), maybe_string.<span class="built_in">ToLocalChecked</span>());</span><br><span class="line">  <span class="keyword">if</span> (maybe_value.<span class="built_in">IsEmpty</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> info.<span class="built_in">GetReturnValue</span>().<span class="built_in">Set</span>(v8::Array::<span class="built_in">New</span>(isolate));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> value = maybe_value.<span class="built_in">ToLocalChecked</span>();</span><br><span class="line">  info.<span class="built_in">GetReturnValue</span>().<span class="built_in">Set</span>(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续往下看check函数，由于我们这里分析的是command，所以if部分暂时不用看，之后调用<code>isolate-&gt;Check</code>去执行检测(不截图了，简单来说就是找到对应的注册的检测函数去调用)</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/25.png"></p><h2 id="如何绕过"><a href="#如何绕过" class="headerlink" title="如何绕过"></a>如何绕过</h2><p>绕过的方式其实真的有很多，这里简单谈几个</p><h3 id="基于正则的绕过"><a href="#基于正则的绕过" class="headerlink" title="基于正则的绕过"></a>基于正则的绕过</h3><p>首先对于规则的检测既然是基于正则表达式，那么很显然如果在规则不够完善的情况之下，那也是可以造成一部分的绕过，比如我们可以看到在官方的插件当中，我们就拿这第一个查看文件的命令来说只是任意匹配1-5位，虽然不能通过多个空格之类的绕过</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">command_common: &#123;</span><br><span class="line">  <span class="attr">name</span>:    <span class="string">&#x27;算法3 - 识别常用渗透命令（探针）&#x27;</span>,</span><br><span class="line">    <span class="attr">action</span>:  <span class="string">&#x27;log&#x27;</span>,</span><br><span class="line">      <span class="attr">pattern</span>: <span class="string">&#x27;cat.&#123;1,5&#125;/etc/passwd|nc.&#123;1,30&#125;-e.&#123;1,100&#125;/bin/(?:ba)?sh|bash\\s-.&#123;0,4&#125;i.&#123;1,20&#125;/dev/tcp/|subprocess.call\\(.&#123;0,6&#125;/bin/(?:ba)?sh|fsockopen\\(.&#123;1,50&#125;/bin/(?:ba)?sh|perl.&#123;1,80&#125;socket.&#123;1,120&#125;open.&#123;1,80&#125;exec\\(.&#123;1,5&#125;/bin/(?:ba)?sh&#x27;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>我们的cat函数支持同时读多个文件<code>cat /abc/def /etc/passwd</code>，这样也是可以轻轻松松得以进行绕过</p><h3 id="通过修改某些属性"><a href="#通过修改某些属性" class="headerlink" title="通过修改某些属性"></a>通过修改某些属性</h3><p>通常如果存在反序列化漏洞，我们通常可以通过<code>TemplatesImpl</code>去加载任意字节码，在这里如果对于在RASP执行检测过程当中如果存在某些关键配置我们可以操控，那么就可以导致绕过，而OpenRasp里面就有，比如在执行检测前中间的调用流程有个<code>com.baidu.openrasp.HookHandler#doCheckWithoutRequest</code>，这里面提到了如果服务器的cpu使用率超过<code>90%</code>，<code>禁用全部hook点</code><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/28.png"></p><p>又或者满足当云控注册成功之前，不进入任何hook点，反正这些我们不都是可以通过反射去设置的么，这里我就随便来一个，就以第一个为例子吧，我们可以通过反射获取这个已经实例化的实例，在这个基础上修改<code>disableHooks</code>这个属性即可</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/29.png"></p><p>代码示例如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  Class&lt;?&gt; clz = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;com.baidu.openrasp.config.Config&quot;</span>);</span><br><span class="line">  java.lang.reflect.Method getConfig = clz.getDeclaredMethod(<span class="string">&quot;getConfig&quot;</span>);</span><br><span class="line">  java.lang.reflect.Field disableHooks = clz.getDeclaredField(<span class="string">&quot;disableHooks&quot;</span>);</span><br><span class="line">  disableHooks.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">  Object ins = getConfig.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">  disableHooks.set(ins,<span class="keyword">true</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br></pre></td></tr></table></figure><p>为了得到直观的效果我把插件当中的log改为block来演示下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 命令注入 - 常见命令</span></span><br><span class="line"><span class="attr">command_common</span>: &#123;</span><br><span class="line">  <span class="attr">name</span>:    <span class="string">&#x27;算法3 - 识别常用渗透命令（探针）&#x27;</span>,</span><br><span class="line">    <span class="attr">action</span>:  <span class="string">&#x27;block&#x27;</span>,</span><br><span class="line">      <span class="attr">pattern</span>: <span class="string">&#x27;cat.&#123;1,5&#125;/etc/passwd|nc.&#123;1,30&#125;-e.&#123;1,100&#125;/bin/(?:ba)?sh|bash\\s-.&#123;0,4&#125;i.&#123;1,20&#125;/dev/tcp/|subprocess.call\\(.&#123;0,6&#125;/bin/(?:ba)?sh|fsockopen\\(.&#123;1,50&#125;/bin/(?:ba)?sh|perl.&#123;1,80&#125;socket.&#123;1,120&#125;open.&#123;1,80&#125;exec\\(.&#123;1,5&#125;/bin/(?:ba)?sh|\\&#123;echo,.&#123;10,400&#125;&#123;base64,-d&#125;&#x27;</span>&#125;</span><br></pre></td></tr></table></figure><p>并简单写了个控制器模拟反序列化过程（一个字懒）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/off&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">off</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Class&lt;?&gt; clz = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;com.baidu.openrasp.config.Config&quot;</span>);</span><br><span class="line">    java.lang.reflect.Method getConfig = clz.getDeclaredMethod(<span class="string">&quot;getConfig&quot;</span>);</span><br><span class="line">    java.lang.reflect.Field disableHooks = clz.getDeclaredField(<span class="string">&quot;disableHooks&quot;</span>);</span><br><span class="line">    disableHooks.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Object ins = getConfig.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    disableHooks.set(ins,<span class="keyword">true</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先执行命令返回可爱小恐龙</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/30.png"></p><p>当我访问<code>off</code>路由成功关闭rasp的hook功能</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/31.png"></p><p>当然你可能会说还有其他的关闭的hook点，比如刚刚上面提到的<code>doCheckWithoutRequest</code>实际上最终是通过<code>doRealCheckWithoutRequest</code>去进行下一步操作，但毕竟也是类似的意思就不多考虑这些更改属性的了点到为止，毕竟只要破坏中间任一环节即可</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/32.png"></p><h3 id="覆盖插件"><a href="#覆盖插件" class="headerlink" title="覆盖插件"></a>覆盖插件</h3><p>我们知道OpenRASP通过<code>InitFileWatcher</code>,一旦其中的js文件被<code>创建</code>、<code>改变</code>、<code>删除</code>都会触发插件的</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/33.png"></p><p>并且我们可以看到插件配置当中对于文件上传<code>js</code>默认是关闭逻辑检测的开关</p><p><img src="/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/34.png"></p><p>因此我们如果存在任意文件上传并且可以跨目录再并且知道插件路径的情况下，虽然不是很通用但好歹也是一个手段</p><p>至于有没有其他方式这里暂时我就不探究了，顺便吐槽学校的实训太累了，心理上的累</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://rasp.baidu.com/doc/">官方文档</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26822029/article/details/81022227">C++中构造函数的两种写法</a></p><p><a target="_blank" rel="noopener" href="https://www.freesion.com/article/94341002625/">JNIENV介绍</a></p><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8148">以OpenRASP为基础-展开来港港RASP的类加载</a></p></div></article><div class="blog-post-comments"><div id="utterances_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OpenRasp%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">OpenRasp分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%97%A5%E5%BF%97%E8%AF%B4%E6%98%8E"><span class="toc-number">1.2.</span> <span class="toc-text">一些日志说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">1.3.</span> <span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.1.</span> <span class="toc-text">初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%B0%86rasp-jar%E5%8A%A0%E8%BD%BD%E8%87%B3Bootstrap%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">为什么要将rasp.jar加载至Bootstrap类加载器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">配置初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ModuleLoader%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">ModuleLoader类初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8"><span class="toc-number">1.3.2.</span> <span class="toc-text">引擎启动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JS%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">JS初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Checker%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">Checker的初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CustomClassTransformer"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">CustomClassTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hook"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">Hook</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%9E%E7%AD%94%E4%B8%8A%E9%9D%A2%E9%81%97%E7%95%99%E7%9A%84ModuleClassloader%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.2.4.1.</span> <span class="toc-text">回答上面遗留的ModuleClassloader的问题</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%BB%95%E8%BF%87"><span class="toc-number">1.4.</span> <span class="toc-text">如何绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%AD%A3%E5%88%99%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">1.4.1.</span> <span class="toc-text">基于正则的绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9%E6%9F%90%E4%BA%9B%E5%B1%9E%E6%80%A7"><span class="toc-number">1.4.2.</span> <span class="toc-text">通过修改某些属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%86%E7%9B%96%E6%8F%92%E4%BB%B6"><span class="toc-number">1.4.3.</span> <span class="toc-text">覆盖插件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.5.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&text=OpenRasp分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&title=OpenRasp分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&is_video=false&description=OpenRasp分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=OpenRasp分析&body=Check out this article: https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&title=OpenRasp分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&title=OpenRasp分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&title=OpenRasp分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&title=OpenRasp分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&name=OpenRasp分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2022/05/28/year/2022/5/OpenRasp%E5%88%86%E6%9E%90/&t=OpenRasp分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2016-2025 Y4tacker</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul><ul><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次 </span><span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></ul></nav></div></footer></div><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload='this.onload=null,this.rel="stylesheet"'><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script><script type="text/javascript">$(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })</script><script src="/js/main.js"></script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e6d8a6d6d91254d9108e469862e88709";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">var utterances_repo="Y4tacker/y4tacker.github.io",utterances_issue_term="pathname",utterances_label="Comment",utterances_theme="github-dark";!function(){var t=document.createElement("script");t.src="https://utteranc.es/client.js",t.setAttribute("repo",utterances_repo),t.setAttribute("issue-term","pathname"),t.setAttribute("label",utterances_label),t.setAttribute("theme",utterances_theme),t.setAttribute("crossorigin","anonymous"),t.async=!0,document.getElementById("utterances_thread").appendChild(t)}()</script></body></html>