<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="探寻Tomcat文件上传流量层面绕waf新姿势写在前面​    无意中看到ch1ng师傅的文章觉得很有趣，不得不感叹师傅太厉害了，但我一看那长篇的函数总觉得会有更骚的东西，所幸还真的有，借此机会就发出来一探究竟，同时也不得不感慨下RFC文档的妙处，当然本文针对的技术也仅仅只是在流量层面上waf的绕过 Pre很神奇对吧，当然这不是终点,接下来我们就来一探究竟  前置这里简单说一下师傅的思路 部署与处"><meta property="og:type" content="article"><meta property="og:title" content="探寻Tomcat文件上传流量层面绕waf新姿势"><meta property="og:url" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/index.html"><meta property="og:site_name" content="Y4tacker:Hacking The World!"><meta property="og:description" content="探寻Tomcat文件上传流量层面绕waf新姿势写在前面​    无意中看到ch1ng师傅的文章觉得很有趣，不得不感叹师傅太厉害了，但我一看那长篇的函数总觉得会有更骚的东西，所幸还真的有，借此机会就发出来一探究竟，同时也不得不感慨下RFC文档的妙处，当然本文针对的技术也仅仅只是在流量层面上waf的绕过 Pre很神奇对吧，当然这不是终点,接下来我们就来一探究竟  前置这里简单说一下师傅的思路 部署与处"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/res.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/1.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/2.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/3.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/4.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/5.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/6.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/7.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/8.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/9.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/21.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/22.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/10.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/14.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/15.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/16.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/17.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/18.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/19.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/11.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/12.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/13.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/20.png"><meta property="article:published_time" content="2022-06-19T05:50:24.000Z"><meta property="article:modified_time" content="2024-08-04T09:01:49.648Z"><meta property="article:author" content="Y4tacker"><meta property="article:tag" content="Java"><meta property="article:tag" content="Waf"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/res.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>探寻Tomcat文件上传流量层面绕waf新姿势</title><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="Y4tacker:Hacking The World!" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" aria-label="Top" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa-solid fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" aria-label="Previous post" href="/2022/06/21/year/2022/6/%E6%8E%A2%E5%AF%BBJava%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2waf%E7%BB%95%E8%BF%87%E5%A7%BF%E5%8A%BF%E7%B3%BB%E5%88%97%E4%BA%8C/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" aria-label="Next post" href="/2022/06/19/year/2022/6/%E5%85%B3%E4%BA%8Epearcmd%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" aria-label="Back to top" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&text=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&title=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&is_video=false&description=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=探寻Tomcat文件上传流量层面绕waf新姿势&body=Check out this article: https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&title=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&title=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&title=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&title=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&name=探寻Tomcat文件上传流量层面绕waf新姿势&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&t=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF"><span class="toc-number">1.</span> <span class="toc-text">探寻Tomcat文件上传流量层面绕waf新姿势</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pre"><span class="toc-number">1.2.</span> <span class="toc-text">Pre</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">前置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5"><span class="toc-number">1.4.</span> <span class="toc-text">深入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E5%BD%A2-%E6%9B%B4%E6%96%B02022-06-20"><span class="toc-number">1.5.</span> <span class="toc-text">变形 更新2022-06-20</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%A4%A7%E5%88%A9%E7%94%A8%E9%9D%A2"><span class="toc-number">1.6.</span> <span class="toc-text">扩大利用面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0Spring-2022-06-20"><span class="toc-number">1.7.</span> <span class="toc-text">更新Spring 2022-06-20</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring4"><span class="toc-number">1.7.1.</span> <span class="toc-text">Spring4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring5"><span class="toc-number">1.7.2.</span> <span class="toc-text">Spring5</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.8.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol></div></span></div><div class="content index py4"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle p-name" itemprop="name headline">探寻Tomcat文件上传流量层面绕waf新姿势</h1><div class="meta"><span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-name" itemprop="name">Y4tacker</span></span><div class="postdate"><time datetime="2022-06-19T05:50:24.000Z" class="dt-published" itemprop="datePublished">2022-06-19</time> (Updated: <time datetime="2024-08-04T09:01:49.648Z" class="dt-updated" itemprop="dateModified">2024-08-04</time>)</div><div class="article-category"><i class="fa-solid fa-archive"></i> <a class="category-link" href="/categories/Java/">Java</a></div><div class="article-tag"><i class="fa-solid fa-tag"></i> <a class="p-category" href="/tags/Java/" rel="tag">Java</a>, <a class="p-category" href="/tags/Waf/" rel="tag">Waf</a></div></div></header><div class="content e-content" itemprop="articleBody"><h1 id="探寻Tomcat文件上传流量层面绕waf新姿势"><a href="#探寻Tomcat文件上传流量层面绕waf新姿势" class="headerlink" title="探寻Tomcat文件上传流量层面绕waf新姿势"></a>探寻Tomcat文件上传流量层面绕waf新姿势</h1><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>​ 无意中看到ch1ng师傅的文章觉得很有趣，不得不感叹师傅太厉害了，但我一看那长篇的函数总觉得会有更骚的东西，所幸还真的有，借此机会就发出来一探究竟，同时也不得不感慨下RFC文档的妙处，当然本文针对的技术也仅仅只是在流量层面上waf的绕过</p><h2 id="Pre"><a href="#Pre" class="headerlink" title="Pre"></a>Pre</h2><p>很神奇对吧，当然这不是终点,接下来我们就来一探究竟</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/res.png"></p><h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><p>这里简单说一下师傅的思路</p><p>部署与处理上传war的servlet是<code>org.apache.catalina.manager.HTMLManagerServlet</code></p><p>在文件上传时最终会通过处理<code>org.apache.catalina.manager.HTMLManagerServlet#upload</code></p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/1.png"></p><p>调用的是其子类实现类<code>org.apache.catalina.core.ApplicationPart#getSubmittedFileName</code></p><p>这里获取filename的时候的处理很有趣</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/2.png"></p><p>看到这段注释，发现在RFC 6266文档当中也提出这点</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Avoid including the &quot;\&quot; character in the quoted-string form of the filename parameter, as escaping is not implemented by some user agents, and &quot;\&quot; can be considered an illegal path character.</span><br></pre></td></tr></table></figure><p>那么我们的tomcat是如何处理的嘞？这里它通过函数<code>HttpParser.unquote</code>去进行处理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">unquote</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span> || input.length() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> input;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> start;</span><br><span class="line">        <span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Skip surrounding quotes if there are any</span></span><br><span class="line">        <span class="keyword">if</span> (input.charAt(<span class="number">0</span>) == <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">            start = <span class="number">1</span>;</span><br><span class="line">            end = input.length() - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            start = <span class="number">0</span>;</span><br><span class="line">            end = input.length();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = start ; i &lt; end; i++) &#123;</span><br><span class="line">            <span class="keyword">char</span> c = input.charAt(i);</span><br><span class="line">            <span class="keyword">if</span> (input.charAt(i) == <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                result.append(input.charAt(i));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result.append(c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>简单做个总结如果首位是<code>&quot;</code>(前提条件是里面有<code>\</code>字符)，那么就会去掉跳过从第二个字符开始，并且末尾也会往前移动一位，同时会忽略字符<code>\</code>，师傅只提到了类似<code>test.\war</code>这样的例子</p><p>但其实根据这个我们还可以进一步构造一些看着比较恶心的比如<code>filename=&quot;&quot;y\4.\w\arK&quot;</code></p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/3.png"></p><h2 id="深入"><a href="#深入" class="headerlink" title="深入"></a>深入</h2><p>还是在<code>org.apache.catalina.core.ApplicationPart#getSubmittedFileName</code>当中，一看到这个将字符串转换成map的操作总觉得里面会有更骚的东西(这里先是解析传入的参数再获取，如果解析过程有利用点那么也会影响到后面参数获取)，不扯远继续回到正题</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/4.png"></p><p>首先它会获取header参数<code>Content-Disposition</code>当中的值，如果以<code>form-data</code>或者<code>attachment</code>开头就会进行我们的解析操作，跟进去一看果不其然，看到<code>RFC2231Utility</code>瞬间不困了</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/5.png"></p><p>后面这一坨就不必多说了，相信大家已经很熟悉啦支持QP编码，忘了的可以考古看看我之前写的文章<a href="https://y4tacker.github.io/2022/02/25/year/2022/2/Java%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%A4%A7%E6%9D%80%E5%99%A8-%E7%BB%95waf(%E9%92%88%E5%AF%B9commons-fileupload%E7%BB%84%E4%BB%B6)/">Java文件上传大杀器-绕waf(针对commons-fileupload组件)</a>，这里就不再重复这个啦，我们重点看三元运算符前面的这段</p><p>既然如此，我们先来看看这个hasEncodedValue判断标准是什么，字符串末尾是否带<code>*</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasEncodedValue</span><span class="params">(<span class="keyword">final</span> String paramName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (paramName != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> paramName.lastIndexOf(<span class="string">&#x27;*&#x27;</span>) == (paramName.length() - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在看解密函数之前我们可以先看看<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2231#section-4">RFC 2231</a>文档当中对此的描述，英文倒是很简单不懂的可以在线翻一下，这里就不贴中文了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Asterisks (&quot;*&quot;) are reused to provide the indicator that language and character set information is present and encoding is being used. A single quote (&quot;&#x27;&quot;) is used to delimit the character set and language information at the beginning of the parameter value. Percent signs (&quot;%&quot;) are used as the encoding flag, which agrees with RFC 2047.</span><br><span class="line">Specifically, an asterisk at the end of a parameter name acts as an indicator that character set and language information may appear at  the beginning of the parameter value. A single quote is used to separate the character set, language, and actual value information in the parameter value string, and an percent sign is used to flag octets encoded in hexadecimal.  For example:</span><br><span class="line">Content-Type: application/x-stuff;</span><br><span class="line">         title*=us-ascii&#x27;en-us&#x27;This%20is%20%2A%2A%2Afun%2A%2A%2A</span><br></pre></td></tr></table></figure><p>接下来回到正题，我们继续看看这个解码做了些什么</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decodeText</span><span class="params">(<span class="keyword">final</span> String encodedText)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> langDelimitStart = encodedText.indexOf(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (langDelimitStart == -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// missing charset</span></span><br><span class="line">    <span class="keyword">return</span> encodedText;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> String mimeCharset = encodedText.substring(<span class="number">0</span>, langDelimitStart);</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> langDelimitEnd = encodedText.indexOf(<span class="string">&#x27;\&#x27;&#x27;</span>, langDelimitStart + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (langDelimitEnd == -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// missing language</span></span><br><span class="line">    <span class="keyword">return</span> encodedText;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] bytes = fromHex(encodedText.substring(langDelimitEnd + <span class="number">1</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> String(bytes, getJavaCharset(mimeCharset));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结合注释可以看到标准格式<code>@param encodedText - Text to be decoded has a format of &#123;@code &lt;charset&gt;&#39;&lt;language&gt;&#39;&lt;encoded_value&gt;&#125;</code>,分别是编码，语言和待解码的字符串，同时这里还适配了对url编码的解码，也就是<code>fromHex</code>函数,具体代码如下，其实就是url解码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] fromHex(<span class="keyword">final</span> String text) &#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> shift = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">final</span> ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream(text.length());</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; text.length();) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">char</span> c = text.charAt(i++);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="string">&#x27;%&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (i &gt; text.length() - <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>; <span class="comment">// unterminated sequence</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span> b1 = HEX_DECODE[text.charAt(i++) &amp; MASK];</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span> b2 = HEX_DECODE[text.charAt(i++) &amp; MASK];</span><br><span class="line">      out.write((b1 &lt;&lt; shift) | b2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      out.write((<span class="keyword">byte</span>) c);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此我们将值当中值得注意的点梳理一下</p><ol><li>支持编码的解码</li><li>值当中可以进行url编码</li><li>@code&lt;charset&gt;&#39;&lt;language&gt;&#39;&lt;encoded_value&gt; 中间这位language可以随便写，代码里没有用到这个的处理</li></ol><p>既然如此那么我们首先就可以排出掉utf-8，毕竟这个解码后就直接是明文，从Java标准库当中的charsets.jar可以看出，支持的编码有很多</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/6.png"></p><p>同时通过简单的代码也可以输出</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Locale locale = Locale.getDefault();</span><br><span class="line">Map&lt;String, Charset&gt; maps = Charset.availableCharsets();</span><br><span class="line">StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">sb.append(<span class="string">&quot;&#123;&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, Charset&gt; entry : maps.entrySet()) &#123;</span><br><span class="line">  String key = entry.getKey();</span><br><span class="line">  Charset value = entry.getValue();</span><br><span class="line">  sb.append(<span class="string">&quot;\&quot;&quot;</span> + key + <span class="string">&quot;\&quot;,&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">sb.deleteCharAt(sb.length() - <span class="number">1</span>);</span><br><span class="line">sb.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">System.out.println(sb.toString());</span><br></pre></td></tr></table></figure><p>运行输出</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//res</span></span><br><span class="line">&#123;<span class="string">&quot;Big5&quot;</span>,<span class="string">&quot;Big5-HKSCS&quot;</span>,<span class="string">&quot;CESU-8&quot;</span>,<span class="string">&quot;EUC-JP&quot;</span>,<span class="string">&quot;EUC-KR&quot;</span>,<span class="string">&quot;GB18030&quot;</span>,<span class="string">&quot;GB2312&quot;</span>,<span class="string">&quot;GBK&quot;</span>,<span class="string">&quot;IBM-Thai&quot;</span>,<span class="string">&quot;IBM00858&quot;</span>,<span class="string">&quot;IBM01140&quot;</span>,<span class="string">&quot;IBM01141&quot;</span>,<span class="string">&quot;IBM01142&quot;</span>,<span class="string">&quot;IBM01143&quot;</span>,<span class="string">&quot;IBM01144&quot;</span>,<span class="string">&quot;IBM01145&quot;</span>,<span class="string">&quot;IBM01146&quot;</span>,<span class="string">&quot;IBM01147&quot;</span>,<span class="string">&quot;IBM01148&quot;</span>,<span class="string">&quot;IBM01149&quot;</span>,<span class="string">&quot;IBM037&quot;</span>,<span class="string">&quot;IBM1026&quot;</span>,<span class="string">&quot;IBM1047&quot;</span>,<span class="string">&quot;IBM273&quot;</span>,<span class="string">&quot;IBM277&quot;</span>,<span class="string">&quot;IBM278&quot;</span>,<span class="string">&quot;IBM280&quot;</span>,<span class="string">&quot;IBM284&quot;</span>,<span class="string">&quot;IBM285&quot;</span>,<span class="string">&quot;IBM290&quot;</span>,<span class="string">&quot;IBM297&quot;</span>,<span class="string">&quot;IBM420&quot;</span>,<span class="string">&quot;IBM424&quot;</span>,<span class="string">&quot;IBM437&quot;</span>,<span class="string">&quot;IBM500&quot;</span>,<span class="string">&quot;IBM775&quot;</span>,<span class="string">&quot;IBM850&quot;</span>,<span class="string">&quot;IBM852&quot;</span>,<span class="string">&quot;IBM855&quot;</span>,<span class="string">&quot;IBM857&quot;</span>,<span class="string">&quot;IBM860&quot;</span>,<span class="string">&quot;IBM861&quot;</span>,<span class="string">&quot;IBM862&quot;</span>,<span class="string">&quot;IBM863&quot;</span>,<span class="string">&quot;IBM864&quot;</span>,<span class="string">&quot;IBM865&quot;</span>,<span class="string">&quot;IBM866&quot;</span>,<span class="string">&quot;IBM868&quot;</span>,<span class="string">&quot;IBM869&quot;</span>,<span class="string">&quot;IBM870&quot;</span>,<span class="string">&quot;IBM871&quot;</span>,<span class="string">&quot;IBM918&quot;</span>,<span class="string">&quot;ISO-2022-CN&quot;</span>,<span class="string">&quot;ISO-2022-JP&quot;</span>,<span class="string">&quot;ISO-2022-JP-2&quot;</span>,<span class="string">&quot;ISO-2022-KR&quot;</span>,<span class="string">&quot;ISO-8859-1&quot;</span>,<span class="string">&quot;ISO-8859-13&quot;</span>,<span class="string">&quot;ISO-8859-15&quot;</span>,<span class="string">&quot;ISO-8859-2&quot;</span>,<span class="string">&quot;ISO-8859-3&quot;</span>,<span class="string">&quot;ISO-8859-4&quot;</span>,<span class="string">&quot;ISO-8859-5&quot;</span>,<span class="string">&quot;ISO-8859-6&quot;</span>,<span class="string">&quot;ISO-8859-7&quot;</span>,<span class="string">&quot;ISO-8859-8&quot;</span>,<span class="string">&quot;ISO-8859-9&quot;</span>,<span class="string">&quot;JIS_X0201&quot;</span>,<span class="string">&quot;JIS_X0212-1990&quot;</span>,<span class="string">&quot;KOI8-R&quot;</span>,<span class="string">&quot;KOI8-U&quot;</span>,<span class="string">&quot;Shift_JIS&quot;</span>,<span class="string">&quot;TIS-620&quot;</span>,<span class="string">&quot;US-ASCII&quot;</span>,<span class="string">&quot;UTF-16&quot;</span>,<span class="string">&quot;UTF-16BE&quot;</span>,<span class="string">&quot;UTF-16LE&quot;</span>,<span class="string">&quot;UTF-32&quot;</span>,<span class="string">&quot;UTF-32BE&quot;</span>,<span class="string">&quot;UTF-32LE&quot;</span>,<span class="string">&quot;UTF-8&quot;</span>,<span class="string">&quot;windows-1250&quot;</span>,<span class="string">&quot;windows-1251&quot;</span>,<span class="string">&quot;windows-1252&quot;</span>,<span class="string">&quot;windows-1253&quot;</span>,<span class="string">&quot;windows-1254&quot;</span>,<span class="string">&quot;windows-1255&quot;</span>,<span class="string">&quot;windows-1256&quot;</span>,<span class="string">&quot;windows-1257&quot;</span>,<span class="string">&quot;windows-1258&quot;</span>,<span class="string">&quot;windows-31j&quot;</span>,<span class="string">&quot;x-Big5-HKSCS-2001&quot;</span>,<span class="string">&quot;x-Big5-Solaris&quot;</span>,<span class="string">&quot;x-COMPOUND_TEXT&quot;</span>,<span class="string">&quot;x-euc-jp-linux&quot;</span>,<span class="string">&quot;x-EUC-TW&quot;</span>,<span class="string">&quot;x-eucJP-Open&quot;</span>,<span class="string">&quot;x-IBM1006&quot;</span>,<span class="string">&quot;x-IBM1025&quot;</span>,<span class="string">&quot;x-IBM1046&quot;</span>,<span class="string">&quot;x-IBM1097&quot;</span>,<span class="string">&quot;x-IBM1098&quot;</span>,<span class="string">&quot;x-IBM1112&quot;</span>,<span class="string">&quot;x-IBM1122&quot;</span>,<span class="string">&quot;x-IBM1123&quot;</span>,<span class="string">&quot;x-IBM1124&quot;</span>,<span class="string">&quot;x-IBM1166&quot;</span>,<span class="string">&quot;x-IBM1364&quot;</span>,<span class="string">&quot;x-IBM1381&quot;</span>,<span class="string">&quot;x-IBM1383&quot;</span>,<span class="string">&quot;x-IBM300&quot;</span>,<span class="string">&quot;x-IBM33722&quot;</span>,<span class="string">&quot;x-IBM737&quot;</span>,<span class="string">&quot;x-IBM833&quot;</span>,<span class="string">&quot;x-IBM834&quot;</span>,<span class="string">&quot;x-IBM856&quot;</span>,<span class="string">&quot;x-IBM874&quot;</span>,<span class="string">&quot;x-IBM875&quot;</span>,<span class="string">&quot;x-IBM921&quot;</span>,<span class="string">&quot;x-IBM922&quot;</span>,<span class="string">&quot;x-IBM930&quot;</span>,<span class="string">&quot;x-IBM933&quot;</span>,<span class="string">&quot;x-IBM935&quot;</span>,<span class="string">&quot;x-IBM937&quot;</span>,<span class="string">&quot;x-IBM939&quot;</span>,<span class="string">&quot;x-IBM942&quot;</span>,<span class="string">&quot;x-IBM942C&quot;</span>,<span class="string">&quot;x-IBM943&quot;</span>,<span class="string">&quot;x-IBM943C&quot;</span>,<span class="string">&quot;x-IBM948&quot;</span>,<span class="string">&quot;x-IBM949&quot;</span>,<span class="string">&quot;x-IBM949C&quot;</span>,<span class="string">&quot;x-IBM950&quot;</span>,<span class="string">&quot;x-IBM964&quot;</span>,<span class="string">&quot;x-IBM970&quot;</span>,<span class="string">&quot;x-ISCII91&quot;</span>,<span class="string">&quot;x-ISO-2022-CN-CNS&quot;</span>,<span class="string">&quot;x-ISO-2022-CN-GB&quot;</span>,<span class="string">&quot;x-iso-8859-11&quot;</span>,<span class="string">&quot;x-JIS0208&quot;</span>,<span class="string">&quot;x-JISAutoDetect&quot;</span>,<span class="string">&quot;x-Johab&quot;</span>,<span class="string">&quot;x-MacArabic&quot;</span>,<span class="string">&quot;x-MacCentralEurope&quot;</span>,<span class="string">&quot;x-MacCroatian&quot;</span>,<span class="string">&quot;x-MacCyrillic&quot;</span>,<span class="string">&quot;x-MacDingbat&quot;</span>,<span class="string">&quot;x-MacGreek&quot;</span>,<span class="string">&quot;x-MacHebrew&quot;</span>,<span class="string">&quot;x-MacIceland&quot;</span>,<span class="string">&quot;x-MacRoman&quot;</span>,<span class="string">&quot;x-MacRomania&quot;</span>,<span class="string">&quot;x-MacSymbol&quot;</span>,<span class="string">&quot;x-MacThai&quot;</span>,<span class="string">&quot;x-MacTurkish&quot;</span>,<span class="string">&quot;x-MacUkraine&quot;</span>,<span class="string">&quot;x-MS932_0213&quot;</span>,<span class="string">&quot;x-MS950-HKSCS&quot;</span>,<span class="string">&quot;x-MS950-HKSCS-XP&quot;</span>,<span class="string">&quot;x-mswin-936&quot;</span>,<span class="string">&quot;x-PCK&quot;</span>,<span class="string">&quot;x-SJIS_0213&quot;</span>,<span class="string">&quot;x-UTF-16LE-BOM&quot;</span>,<span class="string">&quot;X-UTF-32BE-BOM&quot;</span>,<span class="string">&quot;X-UTF-32LE-BOM&quot;</span>,<span class="string">&quot;x-windows-50220&quot;</span>,<span class="string">&quot;x-windows-50221&quot;</span>,<span class="string">&quot;x-windows-874&quot;</span>,<span class="string">&quot;x-windows-949&quot;</span>,<span class="string">&quot;x-windows-950&quot;</span>,<span class="string">&quot;x-windows-iso2022jp&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>这里作为演示我就随便选一个了<code>UTF-16BE</code></p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/7.png"></p><p>同样的我们也可以进行套娃结合上面的<code>filename=&quot;&quot;y\4.\w\arK&quot;</code>改成<code>filename=&quot;UTF-16BE&#39;Y4tacker&#39;%00%22%00y%00%5C%004%00.%00%5C%00w%00%5C%00a%00r%00K&quot;</code></p><p>接下来处理点小加强，可以看到在这里分隔符无限加，而且加了🌟号的字符之后也会去除一个🌟号</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/8.png"></p><p>因此我们最终可以得到如下payload，此时仅仅基于正则的waf规则就很有可能会失效</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundaryQKTY1MomsixvN8vX</span><br><span class="line">Content-Disposition: form-data*;;;;;;;;;;name*=<span class="string">&quot;UTF-16BE&#x27;Y4tacker&#x27;%00d%00e%00p%00l%00o%00y%00W%00a%00r&quot;</span>;;;;;;;;filename*=<span class="string">&quot;UTF-16BE&#x27;Y4tacker&#x27;%00%22%00y%00%5C%004%00.%00%5C%00w%00%5C%00a%00r%00K&quot;</span></span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line"><span class="number">123</span></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryQKTY1MomsixvN8vX--</span><br></pre></td></tr></table></figure><p>可以看见成功上传</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/9.png"></p><h2 id="变形-更新2022-06-20"><a href="#变形-更新2022-06-20" class="headerlink" title="变形 更新2022-06-20"></a>变形 更新2022-06-20</h2><p>这里测试版本是Tomcat8.5.72，这里也不想再测其他版本差异了只是提供一种思路</p><p>在此基础上我发现还可以做一些新的东西，其实就是对<code>org.apache.tomcat.util.http.fileupload.ParameterParser#parse(char[], int, int, char)</code>函数进行深入分析</p><p>在获取值的时候<code>paramValue = parseQuotedToken(new char[] &#123;separator &#125;);</code>，其实是按照分隔符<code>;</code>分割，因此我们不难想到前面的东西其实可以不用<code>&quot;</code>进行包裹，在parseQuotedToken最后返回调用的是<code>return getToken(true);</code>，这个函数也很简单就不必多解释</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getToken</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> quoted)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Trim leading white spaces</span></span><br><span class="line">        <span class="keyword">while</span> ((i1 &lt; i2) &amp;&amp; (Character.isWhitespace(chars[i1]))) &#123;</span><br><span class="line">            i1++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Trim trailing white spaces</span></span><br><span class="line">        <span class="keyword">while</span> ((i2 &gt; i1) &amp;&amp; (Character.isWhitespace(chars[i2 - <span class="number">1</span>]))) &#123;</span><br><span class="line">            i2--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Strip away quotation marks if necessary</span></span><br><span class="line">        <span class="keyword">if</span> (quoted</span><br><span class="line">            &amp;&amp; ((i2 - i1) &gt;= <span class="number">2</span>)</span><br><span class="line">            &amp;&amp; (chars[i1] == <span class="string">&#x27;&quot;&#x27;</span>)</span><br><span class="line">            &amp;&amp; (chars[i2 - <span class="number">1</span>] == <span class="string">&#x27;&quot;&#x27;</span>)) &#123;</span><br><span class="line">            i1++;</span><br><span class="line">            i2--;</span><br><span class="line">        &#125;</span><br><span class="line">        String result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (i2 &gt; i1) &#123;</span><br><span class="line">            result = <span class="keyword">new</span> String(chars, i1, i2 - i1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>可以看到这里也是成功识别的</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/21.png"></p><p>既然调用<code>parse</code>解析参数时可以不被包裹，结合getToken函数我们可以知道在最后一个参数其实就不必要加<code>;</code>了，并且解析完通过<code>params.get(&quot;filename&quot;)</code>获取到参数后还会调用到<code>org.apache.tomcat.util.http.parser.HttpParser#unquote</code>那也可以基于此再次变形</p><p>为了直观这里就直接明文了，是不是也很神奇</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/22.png"></p><h2 id="扩大利用面"><a href="#扩大利用面" class="headerlink" title="扩大利用面"></a>扩大利用面</h2><p>现在只是war包的场景，多多少少影响性被降低，但我们这串代码其实抽象出来就一个关键</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Part warPart = request.getPart(<span class="string">&quot;deployWar&quot;</span>);</span><br><span class="line">String filename = warPart.getSubmittedFileName();</span><br></pre></td></tr></table></figure><p>通过查询<a target="_blank" rel="noopener" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/Part.html#getSubmittedFileName--">官方文档</a>，可以发现从Servlet3.1开始，tomcat新增了对此的支持，也就意味着简单通过<code>javax.servlet.http.HttpServletRequest#getParts</code>即可，简化了我们文件上传的代码负担(如果我是开发人员，我肯定首选也会使用，谁不想当懒狗呢)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">getSubmittedFileName</span></span><br><span class="line"><span class="function">String <span class="title">getSubmittedFileName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">Gets the file name specified by the client</span></span><br><span class="line"><span class="function">Returns:</span></span><br><span class="line"><span class="function">the submitted file name</span></span><br><span class="line"><span class="function">Since:</span></span><br><span class="line"><span class="function">Servlet 3.1</span></span><br></pre></td></tr></table></figure><h2 id="更新Spring-2022-06-20"><a href="#更新Spring-2022-06-20" class="headerlink" title="更新Spring 2022-06-20"></a>更新Spring 2022-06-20</h2><p>早上起床想着昨晚和陈师的碰撞，起床后又看了下陈师的星球，看到这个不妨再试试Spring是否也按照了RFC的实现呢（毕竟Spring内置了Tomcat，可能会有类似的呢）</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/10.png"></p><p>Spring为我们提供了处理文件上传MultipartFile的接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultipartFile</span> <span class="keyword">extends</span> <span class="title">InputStreamSource</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>; <span class="comment">//获取参数名</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">String <span class="title">getOriginalFilename</span><span class="params">()</span></span>;<span class="comment">//原始的文件名</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">String <span class="title">getContentType</span><span class="params">()</span></span>;<span class="comment">//内容类型</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getSize</span><span class="params">()</span></span>; <span class="comment">//大小</span></span><br><span class="line">    <span class="keyword">byte</span>[] getBytes() <span class="keyword">throws</span> IOException;<span class="comment">// 获取字节数组</span></span><br><span class="line">    <span class="function">InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;<span class="comment">//以流方式进行读取</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> Resource <span class="title">getResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MultipartFileResource(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将上传的文件写入文件系统</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">transferTo</span><span class="params">(File var1)</span> <span class="keyword">throws</span> IOException, IllegalStateException</span>;</span><br><span class="line">	<span class="comment">// 写入指定path</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">transferTo</span><span class="params">(Path dest)</span> <span class="keyword">throws</span> IOException, IllegalStateException </span>&#123;</span><br><span class="line">        FileCopyUtils.copy(<span class="keyword">this</span>.getInputStream(), Files.newOutputStream(dest));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而spring处理文件上传逻辑的具体关键逻辑在<code>org.springframework.web.multipart.support.StandardMultipartHttpServletRequest#parseRequest</code>，抄个文件上传demo来进行测试分析</p><h3 id="Spring4"><a href="#Spring4" class="headerlink" title="Spring4"></a>Spring4</h3><p>这里我测试了<code>springboot1.5.20.RELEASE</code>内置<code>Spring4.3.23</code>，具体小版本之间是否有差异这里就不再探究</p><p>其中关于<code>org.springframework.web.multipart.support.StandardMultipartHttpServletRequest#parseRequest</code>的调用也有些不同</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRequest</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Collection&lt;Part&gt; parts = request.getParts();</span><br><span class="line">        <span class="keyword">this</span>.multipartParameterNames = <span class="keyword">new</span> LinkedHashSet(parts.size());</span><br><span class="line">        MultiValueMap&lt;String, MultipartFile&gt; files = <span class="keyword">new</span> LinkedMultiValueMap(parts.size());</span><br><span class="line">        Iterator var4 = parts.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">            Part part = (Part)var4.next();</span><br><span class="line">            String disposition = part.getHeader(<span class="string">&quot;content-disposition&quot;</span>);</span><br><span class="line">            String filename = <span class="keyword">this</span>.extractFilename(disposition);</span><br><span class="line">            <span class="keyword">if</span> (filename == <span class="keyword">null</span>) &#123;</span><br><span class="line">                filename = <span class="keyword">this</span>.extractFilenameWithCharset(disposition);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (filename != <span class="keyword">null</span>) &#123;</span><br><span class="line">                files.add(part.getName(), <span class="keyword">new</span> StandardMultipartHttpServletRequest.StandardMultipartFile(part, filename));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.multipartParameterNames.add(part.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.setMultipartFiles(files);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var8) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MultipartException(<span class="string">&quot;Could not parse multipart servlet request&quot;</span>, var8);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单看了下和tomcat之前的分析很像，这里Spring4当中同时也是支持<code>filename*</code>格式的</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/14.png"></p><p>看看具体逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">extractFilename</span><span class="params">(String contentDisposition, String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (contentDisposition == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> startIndex = contentDisposition.indexOf(key);</span><br><span class="line">            <span class="keyword">if</span> (startIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              	<span class="comment">//截取filename=后面的内容</span></span><br><span class="line">                String filename = contentDisposition.substring(startIndex + key.length());</span><br><span class="line">                <span class="keyword">int</span> endIndex;</span><br><span class="line">              	<span class="comment">//如果后面开头是“则截取”“之间的内容</span></span><br><span class="line">                <span class="keyword">if</span> (filename.startsWith(<span class="string">&quot;\&quot;&quot;</span>)) &#123;</span><br><span class="line">                    endIndex = filename.indexOf(<span class="string">&quot;\&quot;&quot;</span>, <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">if</span> (endIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> filename.substring(<span class="number">1</span>, endIndex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">//可以看到如果没有“”包裹其实也可以，这和当时陈师分享的其中一个trick是符合的</span></span><br><span class="line">                    endIndex = filename.indexOf(<span class="string">&quot;;&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (endIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> filename.substring(<span class="number">0</span>, endIndex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> filename;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>简单测试一波，与心中结果一致</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/15.png"></p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/16.png">同时由于indexof默认取第一位，因此我们还可以加一些干扰字符尝试突破waf逻辑</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/17.png"></p><p>如果filename*开头但是spring4当中没有关于url解码的部分</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/18.png"></p><p>没有这部分会出现什么呢？我们只能自己发包前解码，这样的话如果出现00字节就会报错，报错后</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/19.png"></p><p>看起来是spring框架解析header的原因，但是这里报错信息也很有趣将项目地址的绝对路径抛出了，感觉不失为信息收集的一种方式</p><h3 id="Spring5"><a href="#Spring5" class="headerlink" title="Spring5"></a>Spring5</h3><p>也是随便来个新的springboot2.6.4的，来看看spring5的，小版本间差异不测了，经过测试发现spring5和spring4之间也是有版本差异处理也有些不同，同样是在<code>parseRequest</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRequest</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Collection&lt;Part&gt; parts = request.getParts();</span><br><span class="line">            <span class="keyword">this</span>.multipartParameterNames = <span class="keyword">new</span> LinkedHashSet(parts.size());</span><br><span class="line">            MultiValueMap&lt;String, MultipartFile&gt; files = <span class="keyword">new</span> LinkedMultiValueMap(parts.size());</span><br><span class="line">            Iterator var4 = parts.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">                Part part = (Part)var4.next();</span><br><span class="line">                String headerValue = part.getHeader(<span class="string">&quot;Content-Disposition&quot;</span>);</span><br><span class="line">                ContentDisposition disposition = ContentDisposition.parse(headerValue);</span><br><span class="line">                String filename = disposition.getFilename();</span><br><span class="line">                <span class="keyword">if</span> (filename != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (filename.startsWith(<span class="string">&quot;=?&quot;</span>) &amp;&amp; filename.endsWith(<span class="string">&quot;?=&quot;</span>)) &#123;</span><br><span class="line">                        filename = StandardMultipartHttpServletRequest.MimeDelegate.decode(filename);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    files.add(part.getName(), <span class="keyword">new</span> StandardMultipartHttpServletRequest.StandardMultipartFile(part, filename));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.multipartParameterNames.add(part.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.setMultipartFiles(files);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</span><br><span class="line">            <span class="keyword">this</span>.handleParseFailure(var9);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>很明显可以看到这一行<code>filename.startsWith(&quot;=?&quot;) &amp;&amp; filename.endsWith(&quot;?=&quot;)</code>，可以看出Spring对文件名也是支持QP编码</p><p>在上面能看到还调用了一个解析的方法<code>org.springframework.http.ContentDisposition#parse</code></p><p>，多半就是这里了,那么继续深入下</p><p>可以看到一方面是QP编码，另一方面也是支持<code>filename*</code>,同样获取值是截取<code>&quot;</code>之间的或者没找到就直接截取<code>=</code>后面的部分</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/11.png"></p><p>如果是<code>filename*</code>后面的处理逻辑就是else分之，可以看出和我们上面分析spring4还是有点区别就是这里只支持<code>UTF-8/ISO-8859-1/US_ASCII</code>，编码受限制</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> idx1 = value.indexOf(<span class="number">39</span>);</span><br><span class="line"><span class="keyword">int</span> idx2 = value.indexOf(<span class="number">39</span>, idx1 + <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (idx1 != -<span class="number">1</span> &amp;&amp; idx2 != -<span class="number">1</span>) &#123;</span><br><span class="line">  charset = Charset.forName(value.substring(<span class="number">0</span>, idx1).trim());</span><br><span class="line">  Assert.isTrue(StandardCharsets.UTF_8.equals(charset) || StandardCharsets.ISO_8859_1.equals(charset), <span class="string">&quot;Charset should be UTF-8 or ISO-8859-1&quot;</span>);</span><br><span class="line">  filename = decodeFilename(value.substring(idx2 + <span class="number">1</span>), charset);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  filename = decodeFilename(value, StandardCharsets.US_ASCII);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但其实仔细想这个结果是符合RFC文档要求的</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/12.png"></p><p>接着我们继续后面会继续执行<code>decodeFilename</code></p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/13.png"></p><p>代码逻辑很清晰字符串的解码,如果字符串是否在<code>RFC 5987</code>文档规定的Header字符就直接调用baos.write写入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">attr-char     = ALPHA / DIGIT</span><br><span class="line">                  / &quot;!&quot; / &quot;#&quot; / &quot;$&quot; / &quot;&amp;&quot; / &quot;+&quot; / &quot;-&quot; / &quot;.&quot;</span><br><span class="line">                  / &quot;^&quot; / &quot;_&quot; / &quot;`&quot; / &quot;|&quot; / &quot;~&quot;</span><br><span class="line">                  ; token except ( &quot;*&quot; / &quot;&#x27;&quot; / &quot;%&quot; )</span><br></pre></td></tr></table></figure><p>如果不在要求这一位必须是<code>%</code>然后16进制解码后两位，其实就是url解码，简单测试即可</p><p><img src="/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/20.png"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://www.ch1ng.com/blog/264.html">https://www.ch1ng.com/blog/264.html</a></p><p><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6266#section-4.3">https://datatracker.ietf.org/doc/html/rfc6266#section-4.3</a></p><p><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2231">https://datatracker.ietf.org/doc/html/rfc2231</a></p><p><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc5987#section-3.2.1">https://datatracker.ietf.org/doc/html/rfc5987#section-3.2.1</a></p><p><a href="https://y4tacker.github.io/2022/02/25/year/2022/2/Java%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%A4%A7%E6%9D%80%E5%99%A8-%E7%BB%95waf(%E9%92%88%E5%AF%B9commons-fileupload%E7%BB%84%E4%BB%B6)/">https://y4tacker.github.io/2022/02/25/year/2022/2/Java%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%A4%A7%E6%9D%80%E5%99%A8-%E7%BB%95waf(%E9%92%88%E5%AF%B9commons-fileupload%E7%BB%84%E4%BB%B6)/</a></p><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/Part.html#getSubmittedFileName--">https://docs.oracle.com/javaee/7/api/javax/servlet/http/Part.html#getSubmittedFileName--</a></p><p><a target="_blank" rel="noopener" href="http://t.zoukankan.com/summerday152-p-13969452.html#%E4%BA%8C%E3%80%81%E5%A4%84%E7%90%86%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6multipartfile%E6%8E%A5%E5%8F%A3">http://t.zoukankan.com/summerday152-p-13969452.html#%E4%BA%8C%E3%80%81%E5%A4%84%E7%90%86%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6multipartfile%E6%8E%A5%E5%8F%A3</a></p></div></article><div class="blog-post-comments"><div id="utterances_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF"><span class="toc-number">1.</span> <span class="toc-text">探寻Tomcat文件上传流量层面绕waf新姿势</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pre"><span class="toc-number">1.2.</span> <span class="toc-text">Pre</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">前置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5"><span class="toc-number">1.4.</span> <span class="toc-text">深入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E5%BD%A2-%E6%9B%B4%E6%96%B02022-06-20"><span class="toc-number">1.5.</span> <span class="toc-text">变形 更新2022-06-20</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%A4%A7%E5%88%A9%E7%94%A8%E9%9D%A2"><span class="toc-number">1.6.</span> <span class="toc-text">扩大利用面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0Spring-2022-06-20"><span class="toc-number">1.7.</span> <span class="toc-text">更新Spring 2022-06-20</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring4"><span class="toc-number">1.7.1.</span> <span class="toc-text">Spring4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring5"><span class="toc-number">1.7.2.</span> <span class="toc-text">Spring5</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.8.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&text=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&title=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&is_video=false&description=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=探寻Tomcat文件上传流量层面绕waf新姿势&body=Check out this article: https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&title=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&title=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&title=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&title=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&name=探寻Tomcat文件上传流量层面绕waf新姿势&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2022/06/19/year/2022/6/%E6%8E%A2%E5%AF%BBTomcat%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E9%87%8F%E5%B1%82%E9%9D%A2%E7%BB%95waf%E6%96%B0%E5%A7%BF%E5%8A%BF/&t=探寻Tomcat文件上传流量层面绕waf新姿势"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2016-2025 Y4tacker</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul><ul><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次 </span><span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></ul></nav></div></footer></div><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload='this.onload=null,this.rel="stylesheet"'><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script><script type="text/javascript">$(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })</script><script src="/js/main.js"></script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e6d8a6d6d91254d9108e469862e88709";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">var utterances_repo="Y4tacker/y4tacker.github.io",utterances_issue_term="pathname",utterances_label="Comment",utterances_theme="github-dark";!function(){var t=document.createElement("script");t.src="https://utteranc.es/client.js",t.setAttribute("repo",utterances_repo),t.setAttribute("issue-term","pathname"),t.setAttribute("label",utterances_label),t.setAttribute("theme",utterances_theme),t.setAttribute("crossorigin","anonymous"),t.async=!0,document.getElementById("utterances_thread").appendChild(t)}()</script></body></html>